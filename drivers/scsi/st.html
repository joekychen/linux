<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › st.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>st.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   SCSI Tape Driver for Linux version 1.1 and newer. See the accompanying</span>
<span class="cm">   file Documentation/scsi/st.txt for more information.</span>

<span class="cm">   History:</span>
<span class="cm">   Rewritten from Dwayne Forsyth&#39;s SCSI tape driver by Kai Makisara.</span>
<span class="cm">   Contribution and ideas from several people including (in alphabetical</span>
<span class="cm">   order) Klaus Ehrenfried, Eugene Exarevsky, Eric Lee Green, Wolfgang Denk,</span>
<span class="cm">   Steve Hirsch, Andreas Koppenh&quot;ofer, Michael Leodolter, Eyal Lebedinsky,</span>
<span class="cm">   Michael Schaefer, J&quot;org Weule, and Eric Youngdale.</span>

<span class="cm">   Copyright 1992 - 2010 Kai Makisara</span>
<span class="cm">   email Kai.Makisara@kolumbus.fi</span>

<span class="cm">   Some small formal changes - aeb, 950809</span>

<span class="cm">   Last modified: 18-JAN-1998 Richard Gooch &lt;rgooch@atnf.csiro.au&gt; Devfs support</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">verstr</span> <span class="o">=</span> <span class="s">&quot;20101219&quot;</span><span class="p">;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/mtio.h&gt;</span>
<span class="cp">#include &lt;linux/cdrom.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/cdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_driver.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_ioctl.h&gt;</span>
<span class="cp">#include &lt;scsi/sg.h&gt;</span>


<span class="cm">/* The driver prints some debugging information on the console if DEBUG</span>
<span class="cm">   is defined and non-zero. */</span>
<span class="cp">#define DEBUG 0</span>

<span class="cp">#if DEBUG</span>
<span class="cm">/* The message level for the debug messages is currently set to KERN_NOTICE</span>
<span class="cm">   so that people can easily see the messages. Later when the debugging messages</span>
<span class="cm">   in the drivers are more widely classified, this may be changed to KERN_DEBUG. */</span>
<span class="cp">#define ST_DEB_MSG  KERN_NOTICE</span>
<span class="cp">#define DEB(a) a</span>
<span class="cp">#define DEBC(a) if (debugging) { a ; }</span>
<span class="cp">#else</span>
<span class="cp">#define DEB(a)</span>
<span class="cp">#define DEBC(a)</span>
<span class="cp">#endif</span>

<span class="cp">#define ST_KILOBYTE 1024</span>

<span class="cp">#include &quot;st_options.h&quot;</span>
<span class="cp">#include &quot;st.h&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">st_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">buffer_kbs</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_sg_segs</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">try_direct_io</span> <span class="o">=</span> <span class="n">TRY_DIRECT_IO</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">try_rdio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">try_wdio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">st_dev_max</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">st_nr_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">st_sysfs_class</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kai Makisara&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SCSI tape (st) driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_CHARDEV_MAJOR</span><span class="p">(</span><span class="n">SCSI_TAPE_MAJOR</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_SCSI_DEVICE</span><span class="p">(</span><span class="n">TYPE_TAPE</span><span class="p">);</span>

<span class="cm">/* Set &#39;perm&#39; (4th argument) to 0 to disable module_param&#39;s definition</span>
<span class="cm"> * of sysfs parameters (which module_param doesn&#39;t yet support).</span>
<span class="cm"> * Sysfs parameters defined explicitly later.</span>
<span class="cm"> */</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">buffer_kbs</span><span class="p">,</span> <span class="n">buffer_kbs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">buffer_kbs</span><span class="p">,</span> <span class="s">&quot;Default driver buffer size for fixed block mode (KB; 32)&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">max_sg_segs</span><span class="p">,</span> <span class="n">max_sg_segs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_sg_segs</span><span class="p">,</span> <span class="s">&quot;Maximum number of scatter/gather segments to use (256)&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">try_direct_io</span><span class="p">,</span> <span class="n">try_direct_io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">try_direct_io</span><span class="p">,</span> <span class="s">&quot;Try direct I/O between user buffer and tape drive (1)&quot;</span><span class="p">);</span>

<span class="cm">/* Extra parameters for testing */</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">try_rdio</span><span class="p">,</span> <span class="n">try_rdio</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">try_rdio</span><span class="p">,</span> <span class="s">&quot;Try direct read i/o when possible&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">try_wdio</span><span class="p">,</span> <span class="n">try_wdio</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">try_wdio</span><span class="p">,</span> <span class="s">&quot;Try direct write i/o when possible&quot;</span><span class="p">);</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">write_threshold_kbs</span><span class="p">;</span>  <span class="cm">/* retained for compatibility */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">st_dev_parm</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span> <span class="n">parms</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="s">&quot;buffer_kbs&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer_kbs</span>
	<span class="p">},</span>
	<span class="p">{</span>       <span class="cm">/* Retained for compatibility with 2.4 */</span>
		<span class="s">&quot;write_threshold_kbs&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">write_threshold_kbs</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="s">&quot;max_sg_segs&quot;</span><span class="p">,</span> <span class="nb">NULL</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="s">&quot;try_direct_io&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">try_direct_io</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* Restrict the number of modes so that names for all are assigned */</span>
<span class="cp">#if ST_NBR_MODES &gt; 16</span>
<span class="cp">#error &quot;Maximum number of modes is 16&quot;</span>
<span class="cp">#endif</span>
<span class="cm">/* Bit reversed order to get same names for same minors with all</span>
<span class="cm">   mode counts */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">st_formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>  <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="s">&quot;k&quot;</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;l&quot;</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">,</span> <span class="s">&quot;o&quot;</span><span class="p">,</span> <span class="s">&quot;u&quot;</span><span class="p">,</span>
	<span class="s">&quot;m&quot;</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">,</span> <span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;q&quot;</span><span class="p">,</span> <span class="s">&quot;z&quot;</span><span class="p">};</span> 

<span class="cm">/* The default definitions have been moved to st_options.h */</span>

<span class="cp">#define ST_FIXED_BUFFER_SIZE (ST_FIXED_BUFFER_BLOCKS * ST_KILOBYTE)</span>

<span class="cm">/* The buffer size should fit into the 24 bits for length in the</span>
<span class="cm">   6-byte SCSI read and write commands. */</span>
<span class="cp">#if ST_FIXED_BUFFER_SIZE &gt;= (2 &lt;&lt; 24 - 1)</span>
<span class="cp">#error &quot;Buffer size should not exceed (2 &lt;&lt; 24 - 1) bytes!&quot;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debugging</span> <span class="o">=</span> <span class="n">DEBUG</span><span class="p">;</span>

<span class="cp">#define MAX_RETRIES 0</span>
<span class="cp">#define MAX_WRITE_RETRIES 0</span>
<span class="cp">#define MAX_READY_RETRIES 0</span>
<span class="cp">#define NO_TAPE  NOT_READY</span>

<span class="cp">#define ST_TIMEOUT (900 * HZ)</span>
<span class="cp">#define ST_LONG_TIMEOUT (14000 * HZ)</span>

<span class="cm">/* Remove mode bits and auto-rewind bit (7) */</span>
<span class="cp">#define TAPE_NR(x) ( ((iminor(x) &amp; ~255) &gt;&gt; (ST_NBR_MODE_BITS + 1)) | \</span>
<span class="cp">    (iminor(x) &amp; ~(-1 &lt;&lt; ST_MODE_SHIFT)) )</span>
<span class="cp">#define TAPE_MODE(x) ((iminor(x) &amp; ST_MODE_MASK) &gt;&gt; ST_MODE_SHIFT)</span>

<span class="cm">/* Construct the minor number from the device (d), mode (m), and non-rewind (n) data */</span>
<span class="cp">#define TAPE_MINOR(d, m, n) (((d &amp; ~(255 &gt;&gt; (ST_NBR_MODE_BITS + 1))) &lt;&lt; (ST_NBR_MODE_BITS + 1)) | \</span>
<span class="cp">  (d &amp; (255 &gt;&gt; (ST_NBR_MODE_BITS + 1))) | (m &lt;&lt; ST_MODE_SHIFT) | ((n != 0) &lt;&lt; 7) )</span>

<span class="cm">/* Internal ioctl to set both density (uppermost 8 bits) and blocksize (lower</span>
<span class="cm">   24 bits) */</span>
<span class="cp">#define SET_DENS_AND_BLK 0x10001</span>

<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">st_fixed_buffer_size</span> <span class="o">=</span> <span class="n">ST_FIXED_BUFFER_SIZE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">st_max_sg_segs</span> <span class="o">=</span> <span class="n">ST_MAX_SG</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">**</span><span class="n">scsi_tapes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modes_defined</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">enlarge_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">clear_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">normalize_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">append_to_buffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">from_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">move_buffer_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sgl_map_user_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sgl_unmap_user_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">st_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">st_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">do_create_sysfs_files</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">do_remove_sysfs_files</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_create_class_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_driver</span> <span class="n">st_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gendrv</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;st&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">st_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">st_remove</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">st_compression</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">find_partition</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">switch_partition</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">st_int_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">scsi_tape_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#define to_scsi_tape(obj) container_of(obj, struct scsi_tape, kref)</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">st_ref_mutex</span><span class="p">);</span>


<span class="cp">#include &quot;osst_detect.h&quot;</span>
<span class="cp">#ifndef SIGS_FROM_OSST</span>
<span class="cp">#define SIGS_FROM_OSST \</span>
<span class="cp">	{&quot;OnStream&quot;, &quot;SC-&quot;, &quot;&quot;, &quot;osst&quot;}, \</span>
<span class="cp">	{&quot;OnStream&quot;, &quot;DI-&quot;, &quot;&quot;, &quot;osst&quot;}, \</span>
<span class="cp">	{&quot;OnStream&quot;, &quot;DP-&quot;, &quot;&quot;, &quot;osst&quot;}, \</span>
<span class="cp">	{&quot;OnStream&quot;, &quot;USB&quot;, &quot;&quot;, &quot;osst&quot;}, \</span>
<span class="cp">	{&quot;OnStream&quot;, &quot;FW-&quot;, &quot;&quot;, &quot;osst&quot;}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="nf">scsi_tape_get</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ref_mutex</span><span class="p">);</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="n">st_dev_max</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_tapes</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">STp</span> <span class="o">=</span> <span class="n">scsi_tapes</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="p">)</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_device_get</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out_put:</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">scsi_tape_release</span><span class="p">);</span>
	<span class="n">STp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ref_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">STp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scsi_tape_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ref_mutex</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">scsi_tape_release</span><span class="p">);</span>
	<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ref_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">st_reject_data</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">driver_hint</span><span class="p">;</span> <span class="cm">/* Name of the correct driver, NULL if unknown */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">st_reject_data</span> <span class="n">reject_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* {&quot;XXX&quot;, &quot;Yy-&quot;, &quot;&quot;, NULL},  example */</span>
	<span class="n">SIGS_FROM_OSST</span><span class="p">,</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">}};</span>

<span class="cm">/* If the device signature is on the list of incompatible drives, the</span>
<span class="cm">   function returns a pointer to the name of the correct driver (if known) */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">st_incompatible</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span><span class="o">*</span> <span class="n">SDp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_reject_data</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rp</span><span class="o">=&amp;</span><span class="p">(</span><span class="n">reject_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">rp</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">SDp</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">SDp</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">,</span> <span class="n">SDp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">driver_hint</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">driver_hint</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tape_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">tape</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tape</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">st_analyze_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">st_cmdstatus</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ucp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sense</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">have_sense</span> <span class="o">=</span> <span class="n">scsi_normalize_sense</span><span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span>
				<span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">have_sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">remainder_valid</span> <span class="o">=</span>
			<span class="n">scsi_get_sense_info_fld</span><span class="p">(</span><span class="n">sense</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">uremainder64</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x71</span>:
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x70</span>:
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">fixed_format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x73</span>:
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x72</span>:
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">fixed_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ucp</span> <span class="o">=</span> <span class="n">scsi_sense_desc_find</span><span class="p">(</span><span class="n">sense</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ucp</span> <span class="o">?</span> <span class="p">(</span><span class="n">ucp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Convert the result to success code */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_chk_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span> <span class="n">SRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scode</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stp</span><span class="p">;)</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">st_cmdstatus</span> <span class="o">*</span><span class="n">cmdstatp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmdstatp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">;</span>
	<span class="n">st_analyze_sense</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">cmdstatp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span><span class="p">)</span>
		<span class="n">scode</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">.</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">DEB</span><span class="p">(</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Error: %x, cmd: %x %x %x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span>
		       <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		       <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span><span class="p">)</span>
			 <span class="n">__scsi_print_sense</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	<span class="p">}</span> <span class="p">)</span> <span class="cm">/* end DEB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Abnormal conditions for tape */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;%s: Error %x (driver bt 0x%x, host bt 0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">driver_byte</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
			       <span class="n">host_byte</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span> <span class="o">&amp;&amp;</span>
			 <span class="n">scode</span> <span class="o">!=</span> <span class="n">NO_SENSE</span> <span class="o">&amp;&amp;</span>
			 <span class="n">scode</span> <span class="o">!=</span> <span class="n">RECOVERED_ERROR</span> <span class="o">&amp;&amp;</span>
			 <span class="cm">/* scode != UNIT_ATTENTION &amp;&amp; */</span>
			 <span class="n">scode</span> <span class="o">!=</span> <span class="n">BLANK_CHECK</span> <span class="o">&amp;&amp;</span>
			 <span class="n">scode</span> <span class="o">!=</span> <span class="n">VOLUME_OVERFLOW</span> <span class="o">&amp;&amp;</span>
			 <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MODE_SENSE</span> <span class="o">&amp;&amp;</span>
			 <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TEST_UNIT_READY</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">__scsi_print_sense</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">fixed_format</span> <span class="o">&amp;&amp;</span>
	    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cln_mode</span> <span class="o">&gt;=</span> <span class="n">EXTENDED_SENSE_START</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Only fixed format sense */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">cln_sense_value</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">cleaning_req</span> <span class="o">|=</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">cln_mode</span><span class="p">]</span> <span class="o">&amp;</span>
					       <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cln_sense_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cln_sense_value</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">cleaning_req</span> <span class="o">|=</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">cln_mode</span><span class="p">]</span> <span class="o">&amp;</span>
					       <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cln_sense_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">asc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x17</span><span class="p">)</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">cleaning_req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* ASC and ASCQ =&gt; cleaning requested */</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span> <span class="o">|=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">was_reset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span> <span class="o">&amp;&amp;</span>
	    <span class="n">scode</span> <span class="o">==</span> <span class="n">RECOVERED_ERROR</span>
<span class="cp">#if ST_RECOVERED_WRITE_FATAL</span>
	    <span class="o">&amp;&amp;</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">WRITE_6</span>
	    <span class="o">&amp;&amp;</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">WRITE_FILEMARKS</span>
<span class="cp">#endif</span>
	    <span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_reg</span><span class="o">++</span><span class="p">;</span>

                <span class="n">DEB</span><span class="p">(</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_6</span><span class="p">)</span>
				<span class="n">stp</span> <span class="o">=</span> <span class="s">&quot;read&quot;</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_6</span><span class="p">)</span>
				<span class="n">stp</span> <span class="o">=</span> <span class="s">&quot;write&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">stp</span> <span class="o">=</span> <span class="s">&quot;ioctl&quot;</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Recovered %s error (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">stp</span><span class="p">,</span>
			       <span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_count</span><span class="p">);</span>
		<span class="p">}</span> <span class="p">)</span> <span class="cm">/* end DEB */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="nf">st_allocate_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">stp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">streq</span><span class="p">;</span>

	<span class="n">streq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">streq</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">streq</span><span class="p">)</span>
		<span class="n">streq</span><span class="o">-&gt;</span><span class="n">stp</span> <span class="o">=</span> <span class="n">stp</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t get SCSI request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">tape_name</span><span class="p">(</span><span class="n">stp</span><span class="p">)););</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="n">stp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">stp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">streq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">st_release_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">streq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">streq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">st_scsi_execute_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">uptodate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">end_io_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">.</span><span class="n">midlevel_result</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">resid_len</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">waiting</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">waiting</span><span class="p">);</span>

	<span class="n">blk_rq_unmap_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">__blk_put_request</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_scsi_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">data_direction</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bufflen</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rq_map_data</span> <span class="o">*</span><span class="n">mdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">map_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DRIVER_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_QUIET</span><span class="p">;</span>

	<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">null_mapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bufflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">blk_rq_map_user</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">mdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bufflen</span><span class="p">,</span>
				      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blk_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">DRIVER_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">COMMAND_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BLK_MAX_CDB</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="n">retries</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">end_io_data</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

	<span class="n">blk_execute_rq_nowait</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">st_scsi_execute_end</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Do the scsi command. Waits until command performed if do_wait is true.</span>
<span class="cm">   Otherwise write_behind_check() is used to check that the command</span>
<span class="cm">   has finished. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span>
<span class="nf">st_do_scsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span> <span class="n">SRpnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	   <span class="kt">int</span> <span class="n">bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">waiting</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rq_map_data</span> <span class="o">*</span><span class="n">mdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">map_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* if async, make sure there&#39;s no command outstanding */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_wait</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Async command already active.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINTR</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_allocate_request</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If async IO, set last_SRpnt. This ptr tells write_behind_check</span>
<span class="cm">	   which IO is outstanding. It&#39;s nulled out when the IO completes. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_wait</span><span class="p">)</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

	<span class="n">waiting</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="n">waiting</span><span class="p">);</span>
	<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="n">waiting</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">do_dio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">page_order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">nr_entries</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">;</span>
		<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">mapped_pages</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">page_order</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">reserved_page_order</span><span class="p">;</span>
		<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">nr_entries</span> <span class="o">=</span>
			<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">mdata</span><span class="o">-&gt;</span><span class="n">page_order</span><span class="p">);</span>
		<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">reserved_pages</span><span class="p">;</span>
		<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">.</span><span class="n">have_sense</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">st_scsi_execute</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span>
			      <span class="n">retries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* could not allocate the buffer or request was too large */</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">do_wait</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="n">waiting</span><span class="p">);</span>
		<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="n">st_chk_result</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">SRpnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SRpnt</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Handle the write-behind checking (waits for completion). Returns -ENOSPC if</span>
<span class="cm">   write has been correct but EOM early warning reached, -EIO if write ended in</span>
<span class="cm">   error or zero if write successful. Asynchronous writes are used only in</span>
<span class="cm">   variable block mode. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_behind_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="n">STbuffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_cmdstatus</span> <span class="o">*</span><span class="n">cmdstatp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">;</span>

	<span class="n">STbuffer</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">writing</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">DEB</span><span class="p">(</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_pending</span><span class="p">)</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_waits</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_finished</span><span class="o">++</span><span class="p">;</span>
        <span class="p">)</span> <span class="cm">/* end DEB */</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">));</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span><span class="p">;</span>
	<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="n">st_chk_result</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">SRpnt</span><span class="p">);</span>
	<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>

	<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">-=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">writing</span><span class="p">;</span>
	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmdstatp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENSE_EOM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">NO_SENSE</span> <span class="o">||</span>
		     <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">RECOVERED_ERROR</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* EOM at write-behind, has all data been written? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">remainder_valid</span> <span class="o">||</span>
			    <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">uremainder64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">debugging</span> <span class="o">&amp;&amp;</span> <span class="n">retval</span><span class="p">)</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Async write error %x, return value %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">),</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">.</span><span class="n">midlevel_result</span><span class="p">,</span> <span class="n">retval</span><span class="p">);)</span> <span class="cm">/* end DEB */</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Step over EOF if it has been inadvertently crossed (ioctl not used because</span>
<span class="cm">   it messes up the block number). */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cross_eof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">forward</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>

	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>		<span class="cm">/* Space FileMarks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">forward</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>	<span class="cm">/* -1 filemarks */</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Stepping over filemark %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">),</span> <span class="n">forward</span> <span class="o">?</span> <span class="s">&quot;forward&quot;</span> <span class="o">:</span> <span class="s">&quot;backward&quot;</span><span class="p">));</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span>
			   <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">,</span>
			   <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>

	<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">.</span><span class="n">midlevel_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Stepping over filemark %s failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">),</span> <span class="n">forward</span> <span class="o">?</span> <span class="s">&quot;forward&quot;</span> <span class="o">:</span> <span class="s">&quot;backward&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Flush the write buffer (never need to write if variable blocksize). */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_flush_write_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">transfer</span><span class="p">,</span> <span class="n">blks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">write_behind_check</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">transfer</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Flushing %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                               <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">),</span> <span class="n">transfer</span><span class="p">));</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_6</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">blks</span> <span class="o">=</span> <span class="n">transfer</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">blks</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">blks</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">blks</span><span class="p">;</span>

		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">transfer</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span>
				   <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">,</span>
				   <span class="n">MAX_WRITE_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>

		<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">st_cmdstatus</span> <span class="o">*</span><span class="n">cmdstatp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENSE_EOM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">NO_SENSE</span> <span class="o">||</span>
			     <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">RECOVERED_ERROR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">remainder_valid</span> <span class="o">||</span>
			     <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">uremainder64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* All written at EOM early warning */</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="n">blks</span><span class="p">;</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error on flush.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                       <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">));</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="n">blks</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
		<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Flush the tape buffer. The tape will be positioned correctly unless</span>
<span class="cm">   seek_next is true. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seek_next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">backspace</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="n">STbuffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>

	<span class="n">STbuffer</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there was a bus reset, block further access</span>
<span class="cm">	 * to this device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span><span class="p">)</span>	<span class="cm">/* Writing */</span>
		<span class="k">return</span> <span class="n">st_flush_write_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">backspace</span> <span class="o">=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">+</span>
		     <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">read_pointer</span><span class="p">)</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">-</span>
	    <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">+</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span>
	    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seek_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">cross_eof</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Back over the EOF hit */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">backspace</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">MTBSR</span><span class="p">,</span> <span class="n">backspace</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Set the mode parameters */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_mode_densblk</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span> <span class="n">STm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">set_it</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">density_changed</span> <span class="o">&amp;&amp;</span>
	    <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span><span class="p">;</span>
		<span class="n">set_it</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span><span class="p">;</span>
	<span class="n">arg</span> <span class="o">&lt;&lt;=</span> <span class="n">MT_ST_DENSITY_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">blksize_changed</span> <span class="o">&amp;&amp;</span>
	    <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arg</span> <span class="o">|=</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span><span class="p">;</span>
		<span class="n">set_it</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">arg</span> <span class="o">|=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_it</span> <span class="o">&amp;&amp;</span>
	    <span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">SET_DENS_AND_BLK</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;%s: Can&#39;t set default block size to %d bytes and density %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">modes_defined</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Lock or unlock the drive door. Don&#39;t use when st_request allocated. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_door_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);)</span>


	<span class="n">cmd</span> <span class="o">=</span> <span class="n">do_lock</span> <span class="o">?</span> <span class="n">SCSI_IOCTL_DOORLOCK</span> <span class="o">:</span> <span class="n">SCSI_IOCTL_DOORUNLOCK</span><span class="p">;</span>
	<span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: %socking drive door.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
		    <span class="n">do_lock</span> <span class="o">?</span> <span class="s">&quot;L&quot;</span> <span class="o">:</span> <span class="s">&quot;Unl&quot;</span><span class="p">));</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">scsi_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">=</span> <span class="n">do_lock</span> <span class="o">?</span> <span class="n">ST_LOCKED_EXPLICIT</span> <span class="o">:</span> <span class="n">ST_UNLOCKED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">=</span> <span class="n">ST_LOCK_FAILS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Set the internal state after reset */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="n">find_partition</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Test if the drive is ready. Returns either one of the codes below or a negative system</span>
<span class="cm">   error code. */</span>
<span class="cp">#define CHKRES_READY       0</span>
<span class="cp">#define CHKRES_NEW_SESSION 1</span>
<span class="cp">#define CHKRES_NOT_READY   2</span>
<span class="cp">#define CHKRES_NO_TAPE     3</span>

<span class="cp">#define MAX_ATTENTIONS    10</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">attentions</span><span class="p">,</span> <span class="n">waits</span><span class="p">,</span> <span class="n">max_wait</span><span class="p">,</span> <span class="n">scode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">CHKRES_READY</span><span class="p">,</span> <span class="n">new_session</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_cmdstatus</span> <span class="o">*</span><span class="n">cmdstatp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">;</span>

	<span class="n">max_wait</span> <span class="o">=</span> <span class="n">do_wait</span> <span class="o">?</span> <span class="n">ST_BLOCK_SECONDS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">attentions</span><span class="o">=</span><span class="n">waits</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEST_UNIT_READY</span><span class="p">;</span>
		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span>
				   <span class="n">STp</span><span class="o">-&gt;</span><span class="n">long_timeout</span><span class="p">,</span> <span class="n">MAX_READY_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">scode</span> <span class="o">=</span> <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scode</span> <span class="o">==</span> <span class="n">UNIT_ATTENTION</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* New media? */</span>
				<span class="n">new_session</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">attentions</span> <span class="o">&lt;</span> <span class="n">MAX_ATTENTIONS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">attentions</span><span class="o">++</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scode</span> <span class="o">==</span> <span class="n">NOT_READY</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">waits</span> <span class="o">&lt;</span> <span class="n">max_wait</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINTR</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">waits</span><span class="o">++</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&gt;=</span> <span class="n">SCSI_2</span> <span class="o">&amp;&amp;</span>
					    <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x3a</span><span class="p">)</span>	<span class="cm">/* Check ASC */</span>
						<span class="n">retval</span> <span class="o">=</span> <span class="n">CHKRES_NO_TAPE</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">retval</span> <span class="o">=</span> <span class="n">CHKRES_NOT_READY</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">new_session</span> <span class="o">?</span> <span class="n">CHKRES_NEW_SESSION</span> <span class="o">:</span> <span class="n">CHKRES_READY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* See if the drive is ready and gather information about the tape. Return values:</span>
<span class="cm">   &lt; 0   negative error code from errno.h</span>
<span class="cm">   0     drive ready</span>
<span class="cm">   1     drive not ready (possibly no tape)</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_tape</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">new_session</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">do_wait</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">],</span> <span class="n">saved_cleaning</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">st_flags</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">TAPE_MODE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="n">ST_READY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Mode change from %d to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">));</span>
		<span class="n">new_session</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>

	<span class="n">saved_cleaning</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cleaning_req</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">cleaning_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">do_wait</span> <span class="o">=</span> <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">test_ready</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">do_wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">CHKRES_NEW_SESSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* This guess will be updated later</span>
<span class="cm">                                                    if necessary */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">new_session</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">cleaning_req</span> <span class="o">|=</span> <span class="n">saved_cleaning</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">CHKRES_NOT_READY</span> <span class="o">||</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">CHKRES_NO_TAPE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">CHKRES_NO_TAPE</span><span class="p">)</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="n">ST_NO_TAPE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="n">ST_NOT_READY</span><span class="p">;</span>

			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Clear the erroneous &quot;residue&quot; */</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_prot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">=</span> <span class="n">ST_UNLOCKED</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">CHKRES_NOT_READY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">omit_blklims</span><span class="p">)</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">min_block</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">max_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">READ_BLOCK_LIMITS</span><span class="p">;</span>

		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span>
				   <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">,</span>
				   <span class="n">MAX_READY_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">.</span><span class="n">have_sense</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">max_block</span> <span class="o">=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">min_block</span> <span class="o">=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">DEB</span><span class="p">(</span> <span class="n">debugging</span> <span class="o">||</span> <span class="p">)</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">inited</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
                                       <span class="s">&quot;%s: Block limits %d - %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                       <span class="n">STp</span><span class="o">-&gt;</span><span class="n">min_block</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">max_block</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">min_block</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">max_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Can&#39;t read block limits.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                       <span class="n">name</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SENSE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span>
			   <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">,</span>
			   <span class="n">MAX_READY_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: No Mode Sense.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">ST_DEFAULT_BLOCK</span><span class="p">;</span>	<span class="cm">/* Educated guess (?) */</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Prevent error propagation */</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_write_prot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                            <span class="s">&quot;%s: Mode sense. Length %d, medium %x, WBS %x, BLL %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_buffer</span> <span class="o">=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="mi">65536</span> <span class="o">+</span>
			    <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
                        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                                    <span class="s">&quot;%s: Density %x, tape length: %x, drv buffer: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                    <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span><span class="p">,</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="mi">65536</span> <span class="o">+</span>
                                    <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                                    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_buffer</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_write_prot</span> <span class="o">=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_buffer</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate_filemark</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			    <span class="s">&quot;%s: non-buffered tape: disabling writing immediate filemarks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">name</span><span class="p">);</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate_filemark</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">STp</span><span class="o">-&gt;</span><span class="n">inited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span> <span class="o">=</span>
                        <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                       <span class="s">&quot;%s: Block size: %d, buffer size: %d (%d blocks).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
		       <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">,</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_write_prot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_prot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Write protected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_wait</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">st_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">O_WRONLY</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">st_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">O_RDWR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EROFS</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This code is reached when the device is opened for the first time</span>
<span class="cm">		   after the driver has been initialized with tape in the drive and the</span>
<span class="cm">		   partition support has been enabled. */</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                            <span class="s">&quot;%s: Updating partition number in status.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="n">find_partition</span><span class="p">(</span><span class="n">STp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* This guess will be updated when necessary */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_session</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Change the drive parameters for the new mode */</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">density_changed</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">blksize_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">compression_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">defaults_for_writes</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">retval</span> <span class="o">=</span> <span class="n">set_mode_densblk</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">STm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		    <span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">default_drvbuffer</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">MTSETDRVBUFFER</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">default_drvbuffer</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
                                       <span class="s">&quot;%s: Can&#39;t set default drive buffering to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">default_drvbuffer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">CHKRES_READY</span><span class="p">;</span>

 <span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Open the device. Needs to take the BKL only because of incrementing the SCSI host</span>
<span class="cm">   module count. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">resumed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">TAPE_NR</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_mutex</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We really want to do nonseekable_open(inode, filp); here, but some</span>
<span class="cm">	 * versions of tar incorrectly call lseek on tapes and bail out if that</span>
<span class="cm">	 * fails.  So we disallow pread() and pwrite(), but permit lseeks.</span>
<span class="cm">	 */</span>
	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMODE_PREAD</span> <span class="o">|</span> <span class="n">FMODE_PWRITE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">STp</span> <span class="o">=</span> <span class="n">scsi_tape_get</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">STp</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
		<span class="n">scsi_tape_put</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_mutex</span><span class="p">);</span>
		<span class="n">DEB</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Device already in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span> <span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">rew_at_close</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">autorew_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_autopm_get_device</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">resumed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_block_when_processing_errors</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* See that we have at least a one page buffer available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enlarge_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">restr_dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Can&#39;t allocate one page tape buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cleared</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_prot</span> <span class="o">=</span> <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">O_RDONLY</span><span class="p">);</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">try_dio_now</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">try_dio</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_waits</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_finished</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_requests</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_dio</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">)</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">check_tape</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">retval</span> <span class="o">!=</span> <span class="n">CHKRES_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">NO_TAPE</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_out:</span>
	<span class="n">normalize_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scsi_tape_put</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resumed</span><span class="p">)</span>
		<span class="n">scsi_autopm_put_device</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/* Flush the tape buffer before close */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">fl_owner_t</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">result2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file_count</span><span class="p">(</span><span class="n">filp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">st_flush_write_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">result2</span> <span class="o">=</span> <span class="n">switch_partition</span><span class="p">(</span><span class="n">STp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                               <span class="s">&quot;%s: switch_partition at close failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">result2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBC</span><span class="p">(</span> <span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_requests</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Number of r/w requests %d, dio used in %d, pages %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_requests</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_dio</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_pages</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">st_cmdstatus</span> <span class="o">*</span><span class="n">cmdstatp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">;</span>

                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Async write waits %d, finished %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_waits</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_finished</span><span class="p">);</span>
		<span class="p">)</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_FILEMARKS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate_filemark</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">two_fm</span><span class="p">;</span>

		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span>
				   <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">,</span>
				   <span class="n">MAX_WRITE_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENSE_EOM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">NO_SENSE</span> <span class="o">||</span>
		      <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">RECOVERED_ERROR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="o">!</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">remainder_valid</span> <span class="o">||</span> <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">uremainder64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* Write successful at EOM */</span>
			<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
			<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">two_fm</span><span class="p">)</span>
				<span class="n">cross_eof</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_FM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span> <span class="cm">/* Write error */</span>
			<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
			<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error on write filemark.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>

                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Buffer flushed, %d EOF(s) written</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">rew_at_close</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">sysv</span> <span class="o">||</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">!=</span> <span class="n">ST_READING</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_bsr</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">flush_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">cross_eof</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_FM</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_NOEOF</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">result</span> <span class="o">=</span> <span class="n">cross_eof</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">||</span>
			   <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_FM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

      <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">rew_at_close</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result2</span> <span class="o">=</span> <span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">MTREW</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">result2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Close the device and release it. BKL is not needed: this is the only thread</span>
<span class="cm">   accessing this tape. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">==</span> <span class="n">ST_LOCKED_AUTO</span><span class="p">)</span>
		<span class="n">do_door_lock</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">normalize_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
	<span class="n">scsi_autopm_put_device</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">scsi_tape_put</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The checks common to both reading and writing */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rw_checks</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are in the middle of error recovery, don&#39;t let anyone</span>
<span class="cm">	 * else try and use this device.  Also, if error recovery fails, it</span>
<span class="cm">	 * may try and take the device offline, in which case all further</span>
<span class="cm">	 * access to the device is prohibited.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_block_when_processing_errors</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_NO_TAPE</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">].</span><span class="n">defined</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * If there was a bus reset, block further access</span>
<span class="cm">	 * to this device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

        <span class="n">DEB</span><span class="p">(</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Incorrect device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="p">)</span> <span class="cm">/* end DEB */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">retval</span> <span class="o">=</span> <span class="n">switch_partition</span><span class="p">(</span><span class="n">STp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">max_block</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">min_block</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">max_block</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">do_auto_lock</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">==</span> <span class="n">ST_UNLOCKED</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">do_door_lock</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">=</span> <span class="n">ST_LOCKED_AUTO</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_buffering</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="n">STbp</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_read</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">try_dio_now</span> <span class="o">&amp;&amp;</span> <span class="n">try_rdio</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">try_dio_now</span> <span class="o">&amp;&amp;</span> <span class="n">try_wdio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="n">queue_dma_alignment</span><span class="p">(</span>
					<span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">sgl_map_user_pages</span><span class="p">(</span><span class="n">STbp</span><span class="p">,</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">use_sg</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span>
				       <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">is_read</span> <span class="o">?</span> <span class="n">READ</span> <span class="o">:</span> <span class="n">WRITE</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="cm">/* can be used as transfer counter */</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* fall back to buffering with any error */</span>
		<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">=</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span><span class="p">;</span>
		<span class="n">DEB</span><span class="p">(</span>
		     <span class="k">if</span> <span class="p">(</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_dio</span><span class="o">++</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_pages</span> <span class="o">+=</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span><span class="p">;</span>
		     <span class="p">}</span>
		<span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_requests</span><span class="o">++</span><span class="p">;</span> <span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span>
			<span class="n">bufsize</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">&gt;</span> <span class="n">st_fixed_buffer_size</span> <span class="o">?</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">:</span> <span class="n">st_fixed_buffer_size</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">bufsize</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="cm">/* Make sure that data from previous user is not leaked even if</span>
<span class="cm">			   HBA does not return correct residual */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_read</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">sili</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">cleared</span><span class="p">)</span>
				<span class="n">clear_buffer</span><span class="p">(</span><span class="n">STbp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bufsize</span> <span class="o">&gt;</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">enlarge_buffer</span><span class="p">(</span><span class="n">STbp</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">restr_dma</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Can&#39;t allocate %d byte tape buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">),</span> <span class="n">bufsize</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span>
			<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span> <span class="o">=</span> <span class="n">bufsize</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Can be called more than once after each setup_buffer() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_buffering</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="n">STbp</span><span class="p">;</span>

	<span class="n">STbp</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sgl_unmap_user_pages</span><span class="p">(</span><span class="n">STbp</span><span class="p">,</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span><span class="p">,</span> <span class="n">is_read</span><span class="p">);</span>
		<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Write command */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">st_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">total</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">do_count</span><span class="p">,</span> <span class="n">blks</span><span class="p">,</span> <span class="n">transfer</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">undone</span><span class="p">,</span> <span class="n">retry_eot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">async_write</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">b_point</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="n">STbp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rw_checks</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">||</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Write must be integral number of blocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Write not multiple of tape block size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>
	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_prot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_READING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">flush_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_WRITING</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">!=</span> <span class="n">ST_WRITING</span> <span class="o">&amp;&amp;</span>
		   <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">set_mode_densblk</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">STm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_compression</span> <span class="o">!=</span> <span class="n">ST_DONT_TOUCH</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">compression_changed</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">st_compression</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_compression</span> <span class="o">==</span> <span class="n">ST_YES</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Can&#39;t set default compression.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">modes_defined</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">STbp</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">write_behind_check</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_OK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOM_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD_1</span><span class="p">;</span>  <span class="cm">/* allow next write */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOM_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check the buffer readability in cases where copy_user might catch</span>
<span class="cm">	   the problems after some tape movement. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	     <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">setup_buffering</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_6</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_WRITING</span><span class="p">;</span>

	<span class="n">b_point</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">retry_eot</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">do_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">do_count</span> <span class="o">=</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span> <span class="o">*</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">-</span>
					<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">do_count</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
					<span class="n">do_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">i</span> <span class="o">=</span> <span class="n">append_to_buffer</span><span class="p">(</span><span class="n">b_point</span><span class="p">,</span> <span class="n">STbp</span><span class="p">,</span> <span class="n">do_count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">do_count</span><span class="p">;</span>
		<span class="n">b_point</span> <span class="o">+=</span> <span class="n">do_count</span><span class="p">;</span>

		<span class="n">async_write</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span> <span class="o">&amp;&amp;</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span> <span class="o">&amp;&amp;</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">&lt;</span> <span class="n">ST_EOM_OK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">try_dio_now</span> <span class="o">&amp;&amp;</span> <span class="n">try_wdio</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">&lt;</span> <span class="n">ST_EOM_OK</span> <span class="o">&amp;&amp;</span>
		    <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">&lt;</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* Don&#39;t write a buffer that is not full enough. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">async_write</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="nl">retry_write:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">blks</span> <span class="o">=</span> <span class="n">transfer</span> <span class="o">=</span> <span class="n">do_count</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span><span class="p">)</span>
				<span class="n">blks</span> <span class="o">=</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">blks</span> <span class="o">=</span> <span class="n">do_count</span><span class="p">;</span>
			<span class="n">blks</span> <span class="o">/=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
			<span class="n">transfer</span> <span class="o">=</span> <span class="n">blks</span> <span class="o">*</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">blks</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">blks</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">blks</span><span class="p">;</span>

		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">transfer</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span>
				   <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">,</span>
				   <span class="n">MAX_WRITE_RETRIES</span><span class="p">,</span> <span class="o">!</span><span class="n">async_write</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">async_write</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">=</span> <span class="n">transfer</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">==</span>
				       <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">);</span>
			<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="cm">/* Prevent releasing this request! */</span>
			<span class="n">DEB</span><span class="p">(</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">st_cmdstatus</span> <span class="o">*</span><span class="n">cmdstatp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">;</span>

                        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Error on write:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENSE_EOM</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">scode</span> <span class="o">=</span> <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">remainder_valid</span><span class="p">)</span>
					<span class="n">undone</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">uremainder64</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					 <span class="n">scode</span> <span class="o">==</span> <span class="n">VOLUME_OVERFLOW</span><span class="p">)</span>
					<span class="n">undone</span> <span class="o">=</span> <span class="n">transfer</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">undone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">undone</span> <span class="o">*=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">undone</span> <span class="o">&lt;=</span> <span class="n">do_count</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Only data from this write is not written */</span>
					<span class="n">count</span> <span class="o">+=</span> <span class="n">undone</span><span class="p">;</span>
					<span class="n">b_point</span> <span class="o">-=</span> <span class="n">undone</span><span class="p">;</span>
					<span class="n">do_count</span> <span class="o">-=</span> <span class="n">undone</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span>
						<span class="n">blks</span> <span class="o">=</span> <span class="p">(</span><span class="n">transfer</span> <span class="o">-</span> <span class="n">undone</span><span class="p">)</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_OK</span><span class="p">;</span>
					<span class="cm">/* Continue in fixed block mode if all written</span>
<span class="cm">					   in this request but still something left to write</span>
<span class="cm">					   (retval left to zero)</span>
<span class="cm">					*/</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
					    <span class="n">undone</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span> <span class="cm">/* EOM within current request */</span>
                                        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                                                       <span class="s">&quot;%s: EOM with %d bytes unwritten.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">count</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* EOT within data buffered earlier (possible only</span>
<span class="cm">					   in fixed block mode without direct i/o) */</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry_eot</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">&amp;&amp;</span>
					    <span class="p">(</span><span class="n">scode</span> <span class="o">==</span> <span class="n">NO_SENSE</span> <span class="o">||</span> <span class="n">scode</span> <span class="o">==</span> <span class="n">RECOVERED_ERROR</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">move_buffer_data</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">transfer</span> <span class="o">-</span> <span class="n">undone</span><span class="p">);</span>
						<span class="n">retry_eot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="p">(</span><span class="n">transfer</span> <span class="o">-</span> <span class="n">undone</span><span class="p">)</span> <span class="o">/</span>
								<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_OK</span><span class="p">;</span>
						<span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
							    <span class="s">&quot;%s: Retry write of %d bytes at EOM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							    <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">));</span>
						<span class="k">goto</span> <span class="n">retry_write</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* Either error within data buffered by driver or</span>
<span class="cm">						   failed retry */</span>
						<span class="n">count</span> <span class="o">-=</span> <span class="n">do_count</span><span class="p">;</span>
						<span class="n">blks</span> <span class="o">=</span> <span class="n">do_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_ERROR</span><span class="p">;</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Too cautious? */</span>
						<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>	<span class="cm">/* EOM for old data */</span>
						<span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
							    <span class="s">&quot;%s: EOM with lost data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							    <span class="n">name</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">count</span> <span class="o">+=</span> <span class="n">do_count</span><span class="p">;</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>		<span class="cm">/* Too cautious? */</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="p">(</span><span class="n">do_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="n">blks</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">||</span> <span class="n">retry_eot</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">total</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">total</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOD_1</span><span class="p">)</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_OK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">!=</span> <span class="n">ST_EOM_OK</span><span class="p">)</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">total</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
	<span class="n">release_buffering</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read data from the tape. Returns zero in the normal case, one if the</span>
<span class="cm">   eof status has changed, and the negative error code in case of a</span>
<span class="cm">   fatal error. Otherwise updates the buffer and the eof state.</span>

<span class="cm">   Does release user buffer mapping if it is set.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">read_tape</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">st_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">transfer</span><span class="p">,</span> <span class="n">blks</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="n">STbp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>
	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">STbp</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">blks</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">try_dio_now</span> <span class="o">&amp;&amp;</span> <span class="n">try_rdio</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_read_ahead</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blks</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">blks</span> <span class="o">*</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span> <span class="o">&amp;&amp;</span> <span class="n">bytes</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
			<span class="n">blks</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">blks</span> <span class="o">*</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">READ_6</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">sili</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">blks</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">blks</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">blks</span><span class="p">;</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="o">*</span><span class="n">aSRpnt</span><span class="p">;</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span>
			   <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">,</span>
			   <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">release_buffering</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>

	<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Something to check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">st_cmdstatus</span> <span class="o">*</span><span class="n">cmdstatp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Sense: %2x %2x %2x %2x %2x %2x %2x %2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span>
                            <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                            <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                            <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">BLANK_CHECK</span><span class="p">)</span>
				<span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="mh">0xcf</span><span class="p">;</span>	<span class="cm">/* No need for EOM in this case */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* EOF, EOM, or ILI */</span>
				<span class="cm">/* Compute the residual count */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">remainder_valid</span><span class="p">)</span>
					<span class="n">transfer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">uremainder64</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">transfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">MEDIUM_ERROR</span><span class="p">)</span>
					<span class="n">transfer</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENSE_ILI</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* ILI */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">transfer</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">transfer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
								<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
								       <span class="s">&quot;%s: Failed to read %d byte block with %d byte transfer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								       <span class="n">name</span><span class="p">,</span> <span class="n">bytes</span> <span class="o">-</span> <span class="n">transfer</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
								<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">-</span> <span class="n">transfer</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
						<span class="n">SRpnt</span> <span class="o">=</span> <span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">transfer</span> <span class="o">==</span> <span class="n">blks</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* We did not get anything, error */</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Incorrect block size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
								<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="n">blks</span> <span class="o">-</span> <span class="n">transfer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">MTBSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
							<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="cm">/* We have some data, deliver it */</span>
						<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">blks</span> <span class="o">-</span> <span class="n">transfer</span><span class="p">)</span> <span class="o">*</span>
						    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
                                                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                                                            <span class="s">&quot;%s: ILI but enough data received %ld %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                                            <span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">));</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
							<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">MTBSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
							<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENSE_FMK</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* FM overrides EOM */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">!=</span> <span class="n">ST_FM_HIT</span><span class="p">)</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_FM_HIT</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD_2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span>
						    <span class="n">bytes</span> <span class="o">-</span> <span class="n">transfer</span> <span class="o">*</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
                                        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                                                    <span class="s">&quot;%s: EOF detected (%d bytes read).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                                    <span class="n">name</span><span class="p">,</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENSE_EOM</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM</span><span class="p">)</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD_1</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_OK</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">-</span> <span class="n">transfer</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span>
						    <span class="n">bytes</span> <span class="o">-</span> <span class="n">transfer</span> <span class="o">*</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>

                                        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: EOM detected (%d bytes read).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                                    <span class="n">name</span><span class="p">,</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* end of EOF, EOM, ILI test */</span> 
			<span class="k">else</span> <span class="p">{</span>	<span class="cm">/* nonzero sense key */</span>
                                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                                            <span class="s">&quot;%s: Tape error while reading.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM</span> <span class="o">&amp;&amp;</span>
				    <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">BLANK_CHECK</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                                                    <span class="s">&quot;%s: Zero returned for first BLANK CHECK after EOF.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                                    <span class="n">name</span><span class="p">));</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD_2</span><span class="p">;</span>	<span class="cm">/* First BLANK_CHECK after FM */</span>
				<span class="p">}</span> <span class="k">else</span>	<span class="cm">/* Some other extended sense code */</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="cm">/* Caused by bogus sense data */</span>
				<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* End of extended sense test */</span> 
		<span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Non-extended sense */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="cm">/* End of error handling */</span> 
	<span class="k">else</span> <span class="p">{</span>			<span class="cm">/* Read successful */</span>
		<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">sili</span><span class="p">)</span> <span class="cm">/* In fixed block mode residual is always zero here */</span>
			<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">-=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">.</span><span class="n">residual</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Read command */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">st_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">total</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">transfer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">special</span><span class="p">,</span> <span class="n">do_dio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="n">STbp</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span> <span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rw_checks</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">||</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_read_ahead</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>	<span class="cm">/* Read must be integral number of blocks */</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">try_dio_now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Direct i/o can&#39;t handle split blocks */</span>
	<span class="p">}</span>

	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">flush_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_READING</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="n">DEB</span><span class="p">(</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span> <span class="o">&amp;&amp;</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">!=</span> <span class="n">ST_NOEOF</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: EOF/EOM flag up (%d). Bytes %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
		       <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">,</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">);</span>
        <span class="p">)</span> <span class="cm">/* end DEB */</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">setup_buffering</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">do_dio</span> <span class="o">=</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">do_dio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">&gt;=</span> <span class="n">ST_EOD_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">&lt;</span> <span class="n">ST_EOD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>	<span class="cm">/* EOM or Blank Check */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_dio</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check the buffer writability before any tape movement. Don&#39;t alter</span>
<span class="cm">		   buffer data. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_READING</span><span class="p">;</span>


	<span class="cm">/* Loop until enough data in buffer or a special condition found */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">special</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">special</span><span class="p">;)</span> <span class="p">{</span>

		<span class="cm">/* Get new data if the buffer is empty */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">special</span> <span class="o">=</span> <span class="n">read_tape</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">total</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">special</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* No need to continue read */</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">special</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Move the data from driver buffer to user buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">DEB</span><span class="p">(</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span> <span class="o">&amp;&amp;</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">!=</span> <span class="n">ST_NOEOF</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                                       <span class="s">&quot;%s: EOF up (%d). Left %d, needed %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				       <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">,</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">,</span>
                                       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">count</span> <span class="o">-</span> <span class="n">total</span><span class="p">));</span>
                        <span class="p">)</span> <span class="cm">/* end DEB */</span>
			<span class="n">transfer</span> <span class="o">=</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">-</span> <span class="n">total</span> <span class="o">?</span>
			    <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">:</span> <span class="n">count</span> <span class="o">-</span> <span class="n">total</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_dio</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">from_buffer</span><span class="p">(</span><span class="n">STbp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">transfer</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">transfer</span><span class="p">;</span>
			<span class="n">total</span> <span class="o">+=</span> <span class="n">transfer</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Read only one variable length block */</span>

	<span class="p">}</span>			<span class="cm">/* for (total = 0, special = 0;</span>
<span class="cm">                                   total &lt; count &amp;&amp; !special; ) */</span>

	<span class="cm">/* Change the eof state if no data from tape or buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_FM</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOD_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD_2</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOD_2</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM</span><span class="p">)</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
		<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_dio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_buffering</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>



<span class="n">DEB</span><span class="p">(</span>
<span class="cm">/* Set the driver options */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">st_log_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span> <span class="n">STm</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;%s: Mode %d options: buffer writes: %d, async writes: %d, read ahead: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span><span class="p">,</span>
		       <span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_read_ahead</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;%s:    can bsr: %d, two FMs: %d, fast mteom: %d, auto lock: %d,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_bsr</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">two_fm</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_mteom</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">do_auto_lock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;%s:    defs for wr: %d, no block limits: %d, partitions: %d, s2 log: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">defaults_for_writes</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">omit_blklims</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span><span class="p">,</span>
		       <span class="n">STp</span><span class="o">-&gt;</span><span class="n">scsi2_logical</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;%s:    sysv: %d nowait: %d sili: %d nowait_filemark: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">sysv</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">sili</span><span class="p">,</span>
		       <span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate_filemark</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:    debugging: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">debugging</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
	<span class="p">)</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">st_set_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">long</span> <span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">code</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cdev</span> <span class="o">*</span><span class="n">cd0</span><span class="p">,</span> <span class="o">*</span><span class="n">cd1</span><span class="p">;</span>

	<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">defined</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cd0</span> <span class="o">=</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">cdevs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">cd1</span> <span class="o">=</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">cdevs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">STm</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_modedef</span><span class="p">));</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">cdevs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd0</span><span class="p">;</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">cdevs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd1</span><span class="p">;</span>
		<span class="n">modes_defined</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                            <span class="s">&quot;%s: Initialized mode %d definition from mode 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">code</span> <span class="o">=</span> <span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_OPTIONS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_BOOLEANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_BUFFER_WRITES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_ASYNC_WRITES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">defaults_for_writes</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_DEF_WRITES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_read_ahead</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_READ_AHEAD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">two_fm</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_TWO_FM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_mteom</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_FAST_MTEOM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">do_auto_lock</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_AUTO_LOCK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_bsr</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_CAN_BSR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">omit_blklims</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_NO_BLKLIMS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&gt;=</span> <span class="n">SCSI_2</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_CAN_PARTITIONS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">scsi2_logical</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_SCSI2LOGICAL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_NOWAIT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate_filemark</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_NOWAIT_EOF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">sysv</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_SYSV</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">sili</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_SILI</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DEB</span><span class="p">(</span> <span class="n">debugging</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_DEBUGGING</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">st_log_options</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">STm</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span> <span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_SETBOOLEANS</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_CLEARBOOLEANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_SETBOOLEANS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_BUFFER_WRITES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_ASYNC_WRITES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_DEF_WRITES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">defaults_for_writes</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_READ_AHEAD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_read_ahead</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_TWO_FM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">two_fm</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_FAST_MTEOM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_mteom</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_AUTO_LOCK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">do_auto_lock</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_CAN_BSR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_bsr</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_NO_BLKLIMS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">omit_blklims</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&gt;=</span> <span class="n">SCSI_2</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_CAN_PARTITIONS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_SCSI2LOGICAL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">scsi2_logical</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_NOWAIT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_NOWAIT_EOF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate_filemark</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_SYSV</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">sysv</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_SILI</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">sili</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
                <span class="n">DEB</span><span class="p">(</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_DEBUGGING</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">debugging</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">st_log_options</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">STm</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span> <span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_WRITE_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Retained for compatibility */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_DEF_BLKSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MT_ST_OPTIONS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="o">~</span><span class="n">MT_ST_OPTIONS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">DEBC</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Default block size disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">DEBC</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Default block size set to %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">name</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_READY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">blksize_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">set_mode_densblk</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">STm</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_TIMEOUTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MT_ST_OPTIONS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">MT_ST_SET_LONG_TIMEOUT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">long_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MT_ST_SET_LONG_TIMEOUT</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
			<span class="n">DEBC</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Long timeout set to %d seconds.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MT_ST_SET_LONG_TIMEOUT</span><span class="p">)));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">blk_queue_rq_timeout</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span>
					     <span class="n">value</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="n">DEBC</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Normal timeout set to %d seconds.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_SET_CLN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MT_ST_OPTIONS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">EXTENDED_SENSE_START</span> <span class="o">||</span>
				<span class="n">value</span> <span class="o">&gt;=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">cln_mode</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">cln_sense_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">cln_sense_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;%s: Cleaning request mode %d, mask %02x, value %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cln_sense_mask</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cln_sense_value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_DEF_OPTIONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MT_ST_CLEAR_DEFAULT</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_CLEAR_DEFAULT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_DEF_DENSITY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">MT_ST_CLEAR_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">DEBC</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Density default disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                       <span class="n">name</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">DEBC</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Density default set to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">name</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_READY</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">STp</span><span class="o">-&gt;</span><span class="n">density_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">set_mode_densblk</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">STm</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_DEF_DRVBUFFER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">MT_ST_CLEAR_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">default_drvbuffer</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">DEBC</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
                                       <span class="s">&quot;%s: Drive buffer default disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">default_drvbuffer</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">DEBC</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
                                       <span class="s">&quot;%s: Drive buffer default set to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">default_drvbuffer</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_READY</span><span class="p">)</span>
					<span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">MTSETDRVBUFFER</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">default_drvbuffer</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_DEF_COMPRESSION</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">MT_ST_CLEAR_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_compression</span> <span class="o">=</span> <span class="n">ST_DONT_TOUCH</span><span class="p">;</span>
				<span class="n">DEBC</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
                                       <span class="s">&quot;%s: Compression default disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">STp</span><span class="o">-&gt;</span><span class="n">c_algo</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
					<span class="n">DEBC</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Compression algorithm set to 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">c_algo</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_compression</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">ST_YES</span> <span class="o">:</span> <span class="n">ST_NO</span><span class="p">);</span>
					<span class="n">DEBC</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Compression default set to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_READY</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">STp</span><span class="o">-&gt;</span><span class="n">compression_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">st_compression</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_compression</span> <span class="o">==</span> <span class="n">ST_YES</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MODE_HEADER_LENGTH  4</span>

<span class="cm">/* Mode header and page byte offsets */</span>
<span class="cp">#define MH_OFF_DATA_LENGTH     0</span>
<span class="cp">#define MH_OFF_MEDIUM_TYPE     1</span>
<span class="cp">#define MH_OFF_DEV_SPECIFIC    2</span>
<span class="cp">#define MH_OFF_BDESCS_LENGTH   3</span>
<span class="cp">#define MP_OFF_PAGE_NBR        0</span>
<span class="cp">#define MP_OFF_PAGE_LENGTH     1</span>

<span class="cm">/* Mode header and page bit masks */</span>
<span class="cp">#define MH_BIT_WP              0x80</span>
<span class="cp">#define MP_MSK_PAGE_NBR        0x3f</span>

<span class="cm">/* Don&#39;t return block descriptors */</span>
<span class="cp">#define MODE_SENSE_OMIT_BDESCS 0x08</span>

<span class="cp">#define MODE_SELECT_PAGE_FORMAT 0x10</span>

<span class="cm">/* Read a mode page into the tape buffer. The block descriptors are included</span>
<span class="cm">   if incl_block_descs is true. The page control is ored to the page number</span>
<span class="cm">   parameter, if necessary. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">read_mode_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">omit_block_descs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SENSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">omit_block_descs</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SENSE_OMIT_BDESCS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span>
			   <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>

	<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Send the mode page in the tape buffer to the drive. Assumes that the mode data</span>
<span class="cm">   in the buffer is correctly formatted. The long timeout is used if slow is non-zero. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">write_mode_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pgo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SELECT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SELECT_PAGE_FORMAT</span><span class="p">;</span>
	<span class="n">pgo</span> <span class="o">=</span> <span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MH_OFF_BDESCS_LENGTH</span><span class="p">];</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgo</span> <span class="o">+</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">MP_OFF_PAGE_LENGTH</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Clear reserved fields */</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MH_OFF_DATA_LENGTH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MH_OFF_MEDIUM_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MH_OFF_DEV_SPECIFIC</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MH_BIT_WP</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">MP_OFF_PAGE_NBR</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">MP_MSK_PAGE_NBR</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">slow</span> <span class="o">?</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">long_timeout</span> <span class="o">:</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">;</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span>
			   <span class="n">timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>

	<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define COMPRESSION_PAGE        0x0f</span>
<span class="cp">#define COMPRESSION_PAGE_LENGTH 16</span>

<span class="cp">#define CP_OFF_DCE_DCC          2</span>
<span class="cp">#define CP_OFF_C_ALGO           7</span>

<span class="cp">#define DCE_MASK  0x80</span>
<span class="cp">#define DCC_MASK  0x40</span>
<span class="cp">#define RED_MASK  0x60</span>


<span class="cm">/* Control the compression with mode page 15. Algorithm not changed if zero.</span>

<span class="cm">   The block descriptors are read and written because Sony SDT-7000 does not</span>
<span class="cm">   work without this (suggestion from Michael Schaefer &lt;Michael.Schaefer@dlr.de&gt;).</span>
<span class="cm">   Including block descriptors should not cause any harm to other drives. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">st_compression</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mpoffs</span><span class="p">;</span>  <span class="cm">/* Offset to mode page start */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span> <span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="cm">/* Read the current page contents */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">read_mode_page</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">COMPRESSION_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Compression mode page not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mpoffs</span> <span class="o">=</span> <span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="n">b_data</span><span class="p">[</span><span class="n">MH_OFF_BDESCS_LENGTH</span><span class="p">];</span>
        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Compression state is %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">b_data</span><span class="p">[</span><span class="n">mpoffs</span> <span class="o">+</span> <span class="n">CP_OFF_DCE_DCC</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DCE_MASK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)));</span>

	<span class="cm">/* Check if compression can be changed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">b_data</span><span class="p">[</span><span class="n">mpoffs</span> <span class="o">+</span> <span class="n">CP_OFF_DCE_DCC</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DCC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Compression not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Do the change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b_data</span><span class="p">[</span><span class="n">mpoffs</span> <span class="o">+</span> <span class="n">CP_OFF_DCE_DCC</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DCE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">c_algo</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">b_data</span><span class="p">[</span><span class="n">mpoffs</span> <span class="o">+</span> <span class="n">CP_OFF_C_ALGO</span><span class="p">]</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">c_algo</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">b_data</span><span class="p">[</span><span class="n">mpoffs</span> <span class="o">+</span> <span class="n">CP_OFF_DCE_DCC</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DCE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">c_algo</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">b_data</span><span class="p">[</span><span class="n">mpoffs</span> <span class="o">+</span> <span class="n">CP_OFF_C_ALGO</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no compression */</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">write_mode_page</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">COMPRESSION_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Compression change failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Compression state changed to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">compression_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Process the load and unload commands (does unload if the load code is zero) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_load_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">load_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">),</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span> <span class="p">)</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">load_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_NO_TAPE</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">START_STOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">load_code</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If arg &gt;= 1 &amp;&amp; arg &lt;= 6 Enhanced load/unload in HP C1553A</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">load_code</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">MT_ST_HPLOADER_OFFSET</span>
	    <span class="o">&amp;&amp;</span> <span class="n">load_code</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">MT_ST_HPLOADER_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Enhanced %sload slot %2d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">,</span>
			    <span class="n">load_code</span> <span class="o">-</span> <span class="n">MT_ST_HPLOADER_OFFSET</span><span class="p">));</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_code</span> <span class="o">-</span> <span class="n">MT_ST_HPLOADER_OFFSET</span><span class="p">;</span> <span class="cm">/* MediaID field of C1553A */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Don&#39;t wait for completion */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">long_timeout</span><span class="p">;</span>

	<span class="n">DEBC</span><span class="p">(</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">load_code</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Unloading tape.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Loading tape.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="p">);</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span>
			   <span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
	<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* SCSI command successful */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">load_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">rew_at_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="n">ST_NO_TAPE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">rew_at_close</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">autorew_dev</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">check_tape</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if DEBUG</span>
<span class="cp">#define ST_DEB_FORWARD  0</span>
<span class="cp">#define ST_DEB_BACKWARD 1</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">deb_space_print</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">units</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">sc</span><span class="p">;</span>

	<span class="n">sc</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span> <span class="o">?</span> <span class="mh">0xff000000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span><span class="p">)</span>
		<span class="n">sc</span> <span class="o">=</span> <span class="o">-</span><span class="n">sc</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Spacing tape %s over %d %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
	       <span class="n">direction</span> <span class="o">?</span> <span class="s">&quot;backward&quot;</span> <span class="o">:</span> <span class="s">&quot;forward&quot;</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">units</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/* Internal ioctl function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">st_int_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ltmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioctl_result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chg_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fileno</span><span class="p">,</span> <span class="n">blkno</span><span class="p">,</span> <span class="n">at_sm</span><span class="p">,</span> <span class="n">undone</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">datalen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_NONE</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">do_dio</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_NO_TAPE</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">long_timeout</span><span class="p">;</span>
	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="n">fileno</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">;</span>
	<span class="n">blkno</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span><span class="p">;</span>
	<span class="n">at_sm</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_in</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MTFSFM</span>:
		<span class="n">chg_eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Changed from the FSF after this */</span>
	<span class="k">case</span> <span class="n">MTFSF</span>:
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* Space FileMarks */</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">deb_space_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ST_DEB_FORWARD</span><span class="p">,</span> <span class="s">&quot;filemarks&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fileno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fileno</span> <span class="o">+=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">blkno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">at_sm</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTBSFM</span>:
		<span class="n">chg_eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Changed from the FSF after this */</span>
	<span class="k">case</span> <span class="n">MTBSF</span>:
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* Space FileMarks */</span>
		<span class="n">ltmp</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ltmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ltmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ltmp</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">deb_space_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ST_DEB_BACKWARD</span><span class="p">,</span> <span class="s">&quot;filemarks&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fileno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fileno</span> <span class="o">-=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">blkno</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* We can&#39;t know the block number */</span>
		<span class="n">at_sm</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTFSR</span>:
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* Space Blocks */</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">deb_space_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ST_DEB_FORWARD</span><span class="p">,</span> <span class="s">&quot;blocks&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blkno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">blkno</span> <span class="o">+=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">at_sm</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTBSR</span>:
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* Space Blocks */</span>
		<span class="n">ltmp</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ltmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ltmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ltmp</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">deb_space_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ST_DEB_BACKWARD</span><span class="p">,</span> <span class="s">&quot;blocks&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blkno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">blkno</span> <span class="o">-=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">at_sm</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTFSS</span>:
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* Space Setmarks */</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">deb_space_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ST_DEB_FORWARD</span><span class="p">,</span> <span class="s">&quot;setmarks&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blkno</span> <span class="o">=</span> <span class="n">fileno</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">at_sm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTBSS</span>:
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* Space Setmarks */</span>
		<span class="n">ltmp</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ltmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ltmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ltmp</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">deb_space_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ST_DEB_BACKWARD</span><span class="p">,</span> <span class="s">&quot;setmarks&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blkno</span> <span class="o">=</span> <span class="n">fileno</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">at_sm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTWEOF</span>:
	<span class="k">case</span> <span class="n">MTWEOFI</span>:
	<span class="k">case</span> <span class="n">MTWSM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_prot</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_FILEMARKS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTWSM</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTWEOFI</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTWEOF</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate_filemark</span><span class="p">))</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span>
		     <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">!=</span> <span class="n">MTWSM</span><span class="p">)</span>
                               <span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Writing %d filemarks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				 <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">65536</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
                     <span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Writing %d setmarks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				 <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">65536</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fileno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fileno</span> <span class="o">+=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">blkno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">at_sm</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTWSM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTREW</span>:
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REZERO_UNIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Don&#39;t wait for completion */</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">;</span>
		<span class="p">}</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Rewinding tape.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
		<span class="n">fileno</span> <span class="o">=</span> <span class="n">blkno</span> <span class="o">=</span> <span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTNOP</span>:
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: No op on tape.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Should do something ? */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTRETEN</span>:
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">START_STOP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Don&#39;t wait for completion */</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Retensioning tape.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
		<span class="n">fileno</span> <span class="o">=</span> <span class="n">blkno</span> <span class="o">=</span> <span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTEOM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_mteom</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* space to the end of tape */</span>
			<span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">MTFSF</span><span class="p">,</span> <span class="mh">0x7fffff</span><span class="p">);</span>
			<span class="n">fileno</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">&gt;=</span> <span class="n">ST_EOD_1</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* The next lines would hide the number of spaced FileMarks</span>
<span class="cm">			   That&#39;s why I inserted the previous lines. I had no luck</span>
<span class="cm">			   with detecting EOM with FSF, so we go now to EOM.</span>
<span class="cm">			   Joerg Weule */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">fileno</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Spacing to end of recorded medium.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">));</span>
		<span class="n">blkno</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTERASE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_prot</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ERASE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Long erase with non-zero argument */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Don&#39;t wait for completion */</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">long_timeout</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Erasing tape.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
		<span class="n">fileno</span> <span class="o">=</span> <span class="n">blkno</span> <span class="o">=</span> <span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTSETBLK</span>:		<span class="cm">/* Set block length */</span>
	<span class="k">case</span> <span class="n">MTSETDENSITY</span>:	<span class="cm">/* Set tape density */</span>
	<span class="k">case</span> <span class="n">MTSETDRVBUFFER</span>:	<span class="cm">/* Set drive buffering */</span>
	<span class="k">case</span> <span class="n">SET_DENS_AND_BLK</span>:	<span class="cm">/* Set density and block size */</span>
		<span class="n">chg_eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">||</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>	<span class="cm">/* Not allowed if data in buffer */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETBLK</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">SET_DENS_AND_BLK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">max_block</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">min_block</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">max_block</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Illegal block size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SELECT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">use_pf</span> <span class="o">&amp;</span> <span class="n">USE_PF</span><span class="p">))</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SELECT_PAGE_FORMAT</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">datalen</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETDRVBUFFER</span><span class="p">)</span>
			<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_buffer</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* block descriptor length */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETDENSITY</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">density_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* At least we tried ;-) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">SET_DENS_AND_BLK</span><span class="p">)</span>
			<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETBLK</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">SET_DENS_AND_BLK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ltmp</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETBLK</span><span class="p">)</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">blksize_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* At least we tried ;-) */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ltmp</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ltmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ltmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">ltmp</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETBLK</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">SET_DENS_AND_BLK</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                                       <span class="s">&quot;%s: Setting block size to %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="mi">65536</span> <span class="o">+</span>
				       <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span>
				       <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETDENSITY</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">SET_DENS_AND_BLK</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                                       <span class="s">&quot;%s: Setting density code to %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETDRVBUFFER</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                                       <span class="s">&quot;%s: Setting drive buffer code to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				    <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSYS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span>
			   <span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>

	<span class="n">ioctl_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioctl_result</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* SCSI command successful */</span>
		<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
		<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">blkno</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">fileno</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="n">at_sm</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTBSFM</span><span class="p">)</span>
			<span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">MTFSF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTFSFM</span><span class="p">)</span>
			<span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">MTBSF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETBLK</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">SET_DENS_AND_BLK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">SET_DENS_AND_BLK</span><span class="p">)</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="n">MT_ST_DENSITY_SHIFT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETDRVBUFFER</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETDENSITY</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTEOM</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTFSF</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_FM</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chg_eof</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTWEOF</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTWEOFI</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>  <span class="cm">/* prevent automatic WEOF at close */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* SCSI command was not completely successful. Don&#39;t return</span>
<span class="cm">                    from this block without releasing the SCSI command block! */</span>
		<span class="k">struct</span> <span class="n">st_cmdstatus</span> <span class="o">*</span><span class="n">cmdstatp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENSE_EOM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">!=</span> <span class="n">MTBSF</span> <span class="o">&amp;&amp;</span> <span class="n">cmd_in</span> <span class="o">!=</span> <span class="n">MTBSFM</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cmd_in</span> <span class="o">!=</span> <span class="n">MTBSR</span> <span class="o">&amp;&amp;</span> <span class="n">cmd_in</span> <span class="o">!=</span> <span class="n">MTBSS</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_OK</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">remainder_valid</span><span class="p">)</span>
			<span class="n">undone</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">uremainder64</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">undone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTWEOF</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTWEOFI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENSE_EOM</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">NO_SENSE</span> <span class="o">||</span>
			    <span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">RECOVERED_ERROR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ioctl_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* EOF(s) written successfully at EOM */</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* Writing EOF(s) failed */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fileno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">fileno</span> <span class="o">-=</span> <span class="n">undone</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">undone</span> <span class="o">&lt;</span> <span class="n">arg</span><span class="p">)</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">fileno</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTFSF</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTFSFM</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fileno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">fileno</span> <span class="o">-</span> <span class="n">undone</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">fileno</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTBSF</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTBSFM</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">undone</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="cm">/* Some drives get this wrong */</span>
				<span class="n">undone</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">undone</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">fileno</span> <span class="o">+</span> <span class="n">undone</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTFSR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENSE_FMK</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Hit filemark */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_FM</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">blkno</span> <span class="o">&gt;=</span> <span class="n">undone</span><span class="p">)</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">blkno</span> <span class="o">-</span> <span class="n">undone</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTBSR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SENSE_FMK</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Hit filemark */</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">--</span><span class="p">;</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">undone</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="cm">/* Some drives get this wrong */</span>
					<span class="n">undone</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">undone</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">blkno</span> <span class="o">+</span> <span class="n">undone</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTEOM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETBLK</span> <span class="o">||</span>
			   <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETDENSITY</span> <span class="o">||</span>
			   <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETDRVBUFFER</span> <span class="o">||</span>
			   <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">SET_DENS_AND_BLK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">ILLEGAL_REQUEST</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">use_pf</span> <span class="o">&amp;</span> <span class="n">PF_TESTED</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Try the other possible state of Page Format if not</span>
<span class="cm">				   already tried */</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">use_pf</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">use_pf</span> <span class="o">^</span> <span class="n">USE_PF</span><span class="p">)</span> <span class="o">|</span> <span class="n">PF_TESTED</span><span class="p">;</span>
				<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
				<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chg_eof</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">BLANK_CHECK</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD</span><span class="p">;</span>

		<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
		<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ioctl_result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Get the tape position. If bt == 2, arg points into a kernel space mt_loc</span>
<span class="cm">   structure. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">get_location</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">partition</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">logical</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span> <span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&lt;</span> <span class="n">SCSI_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QFA_REQUEST_BLOCK</span><span class="p">;</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">READ_POSITION</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">logical</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">scsi2_logical</span><span class="p">)</span>
			<span class="n">scmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">scmd</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span>
			   <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">,</span>
			   <span class="n">MAX_READY_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&gt;=</span> <span class="n">SCSI_2</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="o">*</span><span class="n">partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Can&#39;t read tape position.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&lt;</span> <span class="n">SCSI_2</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
			    <span class="o">+</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			    <span class="o">+</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="o">*</span><span class="n">partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
			    <span class="o">+</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
			    <span class="o">+</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			    <span class="o">+</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
			<span class="o">*</span><span class="n">partition</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* BOP of partition 0 */</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">drv_file</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Got tape pos. blk %d part %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="o">*</span><span class="n">partition</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Set the tape block and partition. Negative partition means that only the</span>
<span class="cm">   block should be set in vendor specific way. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_location</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block</span><span class="p">,</span> <span class="kt">int</span> <span class="n">partition</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">logical</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">st_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span> <span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">long_timeout</span><span class="p">;</span>
	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>

        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Setting block to %d and partition to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">partition</span><span class="p">));</span>
	<span class="n">DEB</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">partition</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span> <span class="p">)</span>

	<span class="cm">/* Update the location at the partition we are leaving */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">&amp;&amp;</span> <span class="n">partition</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">partition</span> <span class="o">&gt;=</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">partition</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_location</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_visited</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>
                        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                                    <span class="s">&quot;%s: Visited block %d for partition %d saved.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                    <span class="n">name</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&lt;</span> <span class="n">SCSI_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QFA_SEEK_BLOCK</span><span class="p">;</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SEEK_10</span><span class="p">;</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">logical</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">scsi2_logical</span><span class="p">)</span>
			<span class="n">scmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">!=</span> <span class="n">partition</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">scmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">partition</span><span class="p">;</span>
                        <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                                    <span class="s">&quot;%s: Trying to change partition from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                    <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">,</span> <span class="n">partition</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Don&#39;t wait for completion */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">st_do_scsi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">scmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span>
			   <span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_READY_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>

	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&gt;=</span> <span class="n">SCSI_2</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">find_partition</span><span class="p">(</span><span class="n">STp</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="n">partition</span><span class="p">;</span>
			<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">partition</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_valid</span> <span class="o">||</span>
			    <span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_visited</span> <span class="o">!=</span> <span class="n">block</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">st_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Find the current partition number for the drive status. Called from open and</span>
<span class="cm">   returns either partition number of negative error code. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">find_partition</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">partition</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_location</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">partition</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">partition</span> <span class="o">&gt;=</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">partition</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Change the partition if necessary */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">switch_partition</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">==</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_valid</span><span class="p">)</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_visited</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">set_location</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_visited</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Functions for reading and writing the medium partition mode page. */</span>

<span class="cp">#define PART_PAGE   0x11</span>
<span class="cp">#define PART_PAGE_FIXED_LENGTH 8</span>

<span class="cp">#define PP_OFF_MAX_ADD_PARTS   2</span>
<span class="cp">#define PP_OFF_NBR_ADD_PARTS   3</span>
<span class="cp">#define PP_OFF_FLAGS           4</span>
<span class="cp">#define PP_OFF_PART_UNITS      6</span>
<span class="cp">#define PP_OFF_RESERVED        7</span>

<span class="cp">#define PP_BIT_IDP             0x20</span>
<span class="cp">#define PP_MSK_PSUM_MB         0x10</span>

<span class="cm">/* Get the number of partitions on the tape. As a side effect reads the</span>
<span class="cm">   mode page into the tape buffer. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nbr_partitions</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span> <span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_mode_page</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">PART_PAGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Can&#39;t read medium partition page.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">));</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span>
					      <span class="n">PP_OFF_NBR_ADD_PARTS</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Number of partitions %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Partition the tape into two partitions if size &gt; 0 or one partition if</span>
<span class="cm">   size == 0.</span>

<span class="cm">   The block descriptors are read and written because Sony SDT-7000 does not</span>
<span class="cm">   work without this (suggestion from Michael Schaefer &lt;Michael.Schaefer@dlr.de&gt;).</span>

<span class="cm">   My HP C1533A drive returns only one partition size field. This is used to</span>
<span class="cm">   set the size of partition 1. There is no size field for the default partition.</span>
<span class="cm">   Michael Schaefer&#39;s Sony SDT-7000 returns two descriptors and the second is</span>
<span class="cm">   used to set the size of partition 1 (this is what the SCSI-3 standard specifies).</span>
<span class="cm">   The following algorithm is used to accommodate both drives: if the number of</span>
<span class="cm">   partition size fields is greater than the maximum number of additional partitions</span>
<span class="cm">   in the mode page, the second field is used. Otherwise the first field is used.</span>

<span class="cm">   For Seagate DDS drives the page length must be 8 when no partitions is defined</span>
<span class="cm">   and 10 when 1 partition is defined (information from Eric Lee Green). This is</span>
<span class="cm">   is acceptable also to some other old drives and enforced if the first partition</span>
<span class="cm">   size field is used for the first additional partition size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">partition_tape</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pgo</span><span class="p">,</span> <span class="n">psd_cnt</span><span class="p">,</span> <span class="n">psdo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_mode_page</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">PART_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Can&#39;t read partition mode page.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* The mode page is in the buffer. Let&#39;s modify it and write it. */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="n">pgo</span> <span class="o">=</span> <span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="n">bp</span><span class="p">[</span><span class="n">MH_OFF_BDESCS_LENGTH</span><span class="p">];</span>
	<span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Partition page length is %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">name</span><span class="p">,</span> <span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">MP_OFF_PAGE_LENGTH</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">psd_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">MP_OFF_PAGE_LENGTH</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">PART_PAGE_FIXED_LENGTH</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">psdo</span> <span class="o">=</span> <span class="n">pgo</span> <span class="o">+</span> <span class="n">PART_PAGE_FIXED_LENGTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psd_cnt</span> <span class="o">&gt;</span> <span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">PP_OFF_MAX_ADD_PARTS</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">bp</span><span class="p">[</span><span class="n">psdo</span><span class="p">]</span> <span class="o">=</span> <span class="n">bp</span><span class="p">[</span><span class="n">psdo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>  <span class="cm">/* Rest of the tape */</span>
		<span class="n">psdo</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">bp</span> <span class="o">+</span> <span class="n">psdo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">PP_OFF_NBR_ADD_PARTS</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: psd_cnt %d, max.parts %d, nbr_parts %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
		    <span class="n">psd_cnt</span><span class="p">,</span> <span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">PP_OFF_MAX_ADD_PARTS</span><span class="p">],</span>
		    <span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">PP_OFF_NBR_ADD_PARTS</span><span class="p">]));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">PP_OFF_NBR_ADD_PARTS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psd_cnt</span> <span class="o">&lt;=</span> <span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">PP_OFF_MAX_ADD_PARTS</span><span class="p">])</span>
		    <span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">MP_OFF_PAGE_LENGTH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Formatting tape with one partition.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bp</span><span class="p">[</span><span class="n">psdo</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">bp</span><span class="p">[</span><span class="n">psdo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">MP_OFF_PAGE_LENGTH</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		    <span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">MP_OFF_PAGE_LENGTH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
                <span class="n">DEBC</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span>
                            <span class="s">&quot;%s: Formatting tape with two partitions (1 = %d MB).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">PP_OFF_PART_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">PP_OFF_RESERVED</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="p">[</span><span class="n">pgo</span> <span class="o">+</span> <span class="n">PP_OFF_FLAGS</span><span class="p">]</span> <span class="o">=</span> <span class="n">PP_BIT_IDP</span> <span class="o">|</span> <span class="n">PP_MSK_PSUM_MB</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">write_mode_page</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">PART_PAGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Partitioning of tape failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* The ioctl command */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">st_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cmd_nr</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">,</span> <span class="n">bt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

        <span class="n">DEB</span><span class="p">(</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ST_DEB_MSG</span> <span class="s">&quot;%s: Incorrect device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="p">)</span> <span class="cm">/* end DEB */</span>

	<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>
	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are in the middle of error recovery, don&#39;t let anyone</span>
<span class="cm">	 * else try and use this device.  Also, if error recovery fails, it</span>
<span class="cm">	 * may try and take the device offline, in which case all further</span>
<span class="cm">	 * access to the device is prohibited.</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">scsi_nonblockable_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
					<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NDELAY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_block_when_processing_errors</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">||</span> <span class="n">retval</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd_type</span> <span class="o">=</span> <span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd_in</span><span class="p">);</span>
	<span class="n">cmd_nr</span> <span class="o">=</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd_in</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">MTIOCTOP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmd_nr</span> <span class="o">==</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">MTIOCTOP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mtop</span> <span class="n">mtc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd_in</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mtc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtop</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTSETDRVBUFFER</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
                               <span class="s">&quot;%s: MTSETDRVBUFFER only allowed for root.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EPERM</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">defined</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTSETDRVBUFFER</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">&amp;</span> <span class="n">MT_ST_OPTIONS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTFSF</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTFSFM</span> <span class="o">||</span>
                                    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTEOM</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSF</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSFM</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTSEEK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Old position must be restored if partition will be</span>
<span class="cm">                                   changed */</span>
				<span class="n">i</span> <span class="o">=</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTREW</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTOFFL</span> <span class="o">||</span>
				    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTRETEN</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTEOM</span> <span class="o">||</span>
				    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTLOCK</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTLOAD</span> <span class="o">||</span>
				    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTFSF</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTFSFM</span> <span class="o">||</span>
				    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSF</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSFM</span> <span class="o">||</span>
				    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTCOMPRESSION</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">flush_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTREW</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTOFFL</span> <span class="o">||</span>
			     <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTSEEK</span> <span class="o">||</span>
			     <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSF</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSFM</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">MTWEOF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSF</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSFM</span><span class="p">)</span>
					<span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span><span class="o">++</span><span class="p">;</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
			     <span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If there was a bus reset, block further access</span>
<span class="cm">			 * to this device.  If the user wants to rewind the tape,</span>
<span class="cm">			 * then reset the flag and allow access again.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTREW</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTOFFL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTRETEN</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTERASE</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTSEEK</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTEOM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">reset_state</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
			<span class="cm">/* remove this when the midlevel properly clears was_reset */</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">was_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTNOP</span> <span class="o">&amp;&amp;</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTSETBLK</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTSETDENSITY</span> <span class="o">&amp;&amp;</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTWSM</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTSETDRVBUFFER</span> <span class="o">&amp;&amp;</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTSETPART</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>	<span class="cm">/* Prevent automatic WEOF and fsf */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTOFFL</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">!=</span> <span class="n">ST_UNLOCKED</span><span class="p">)</span>
			<span class="n">do_door_lock</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Ignore result! */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTSETDRVBUFFER</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">&amp;</span> <span class="n">MT_ST_OPTIONS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">st_set_options</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTSETPART</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">||</span>
			    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">&gt;=</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span> <span class="o">=</span> <span class="n">nbr_partitions</span><span class="p">(</span><span class="n">STp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTMKPART</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">MTREW</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">partition_tape</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_block_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Bad guess ?-) */</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTSEEK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">set_location</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span><span class="p">)</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTUNLOAD</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTOFFL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">do_load_unload</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTLOAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">do_load_unload</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTLOCK</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTUNLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">do_door_lock</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTLOCK</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_READY</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">switch_partition</span><span class="p">(</span><span class="n">STp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTCOMPRESSION</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">st_compression</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">st_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span><span class="p">,</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">defined</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">flush_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">switch_partition</span><span class="p">(</span><span class="n">STp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">MTIOCGET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmd_nr</span> <span class="o">==</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">MTIOCGET</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mtget</span> <span class="n">mt_status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd_in</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtget</span><span class="p">))</span> <span class="p">{</span>
			 <span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
			 <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_type</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">tape_type</span><span class="p">;</span>
		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_dsreg</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">&lt;&lt;</span> <span class="n">MT_ST_BLKSIZE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">&lt;&lt;</span> <span class="n">MT_ST_DENSITY_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MT_ST_DENSITY_MASK</span><span class="p">);</span>
		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_blkno</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span><span class="p">;</span>
		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_fileno</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span><span class="p">)</span>
				<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_blkno</span> <span class="o">+=</span>
				    <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_READING</span><span class="p">)</span>
				<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_blkno</span> <span class="o">-=</span>
                                        <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">+</span>
                                         <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_write_prot</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_WR_PROT</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mt_status</span><span class="p">.</span><span class="n">mt_blkno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mt_status</span><span class="p">.</span><span class="n">mt_fileno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_BOT</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_EOF</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_erreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_reg</span> <span class="o">&lt;&lt;</span> <span class="n">MT_ST_SOFTERR_SHIFT</span><span class="p">);</span>
		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_resid</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOM_OK</span> <span class="o">||</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOM_ERROR</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_EOT</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">&gt;=</span> <span class="n">ST_EOM_OK</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_EOD</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_D_800</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_D_1600</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_D_6250</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_READY</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_ONLINE</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_NO_TAPE</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_DR_OPEN</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_SM</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_buffer</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_IM_REP_EN</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">cleaning_req</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_CLN</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt_status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtget</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Clear after read */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>			<span class="cm">/* End of MTIOCGET */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">MTIOCPOS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmd_nr</span> <span class="o">==</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">MTIOCPOS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mtpos</span> <span class="n">mt_pos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd_in</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtpos</span><span class="p">))</span> <span class="p">{</span>
			 <span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
			 <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_location</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bt</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mt_pos</span><span class="p">.</span><span class="n">mt_blkno</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt_pos</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtpos</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SCSI_IOCTL_GET_IDLUN</span>:
		<span class="k">case</span> <span class="n">SCSI_IOCTL_GET_BUS_NUMBER</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">SG_IO</span> <span class="o">||</span>
			     <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">SCSI_IOCTL_SEND_COMMAND</span> <span class="o">||</span>
			     <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">CDROM_SEND_PACKET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
				<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">scsi_cmd_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span>
						   <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="p">,</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">scsi_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span> <span class="o">&amp;&amp;</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">SCSI_IOCTL_STOP_UNIT</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* unload */</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">rew_at_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="n">ST_NO_TAPE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">st_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">compat_ioctl</span><span class="p">)</span> <span class="p">{</span> 

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">compat_ioctl</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>



<span class="cm">/* Try to allocate a new tape buffer. Calling function must not hold</span>
<span class="cm">   dev_arr_lock. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="n">new_tape_buffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">need_dma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_sg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>

	<span class="n">tb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;st: Can&#39;t allocate new tape buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">frp_segs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">use_sg</span> <span class="o">=</span> <span class="n">max_sg</span><span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">need_dma</span><span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">reserved_pages</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">max_sg</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">),</span>
				     <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">reserved_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tb</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Try to allocate enough space in the tape buffer */</span>
<span class="cp">#define ST_MAX_ORDER 6</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">enlarge_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span> <span class="n">STbuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">need_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">segs</span><span class="p">,</span> <span class="n">nbr</span><span class="p">,</span> <span class="n">max_segs</span><span class="p">,</span> <span class="n">b_size</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">got</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">priority</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">&lt;=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">&lt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">normalize_buffer</span><span class="p">(</span><span class="n">STbuffer</span><span class="p">);</span>  <span class="cm">/* Avoid extra segment */</span>

	<span class="n">max_segs</span> <span class="o">=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">use_sg</span><span class="p">;</span>
	<span class="n">nbr</span> <span class="o">=</span> <span class="n">max_segs</span> <span class="o">-</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">frp_segs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nbr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priority</span> <span class="o">=</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_dma</span><span class="p">)</span>
		<span class="n">priority</span> <span class="o">|=</span> <span class="n">GFP_DMA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">cleared</span><span class="p">)</span>
		<span class="n">priority</span> <span class="o">|=</span> <span class="n">__GFP_ZERO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">frp_segs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">order</span> <span class="o">=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">reserved_page_order</span><span class="p">;</span>
		<span class="n">b_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">b_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">order</span> <span class="o">&lt;</span> <span class="n">ST_MAX_ORDER</span> <span class="o">&amp;&amp;</span>
			     <span class="n">max_segs</span> <span class="o">*</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">new_size</span><span class="p">;</span>
		     <span class="n">order</span><span class="o">++</span><span class="p">,</span> <span class="n">b_size</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="p">;</span>  <span class="cm">/* empty */</span>
		<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">reserved_page_order</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_segs</span> <span class="o">*</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">new_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="n">ST_MAX_ORDER</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">normalize_buffer</span><span class="p">(</span><span class="n">STbuffer</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">enlarge_buffer</span><span class="p">(</span><span class="n">STbuffer</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">need_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">segs</span> <span class="o">=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">frp_segs</span><span class="p">,</span> <span class="n">got</span> <span class="o">=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
	     <span class="n">segs</span> <span class="o">&lt;</span> <span class="n">max_segs</span> <span class="o">&amp;&amp;</span> <span class="n">got</span> <span class="o">&lt;</span> <span class="n">new_size</span><span class="p">;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

		<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEB</span><span class="p">(</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">got</span><span class="p">);</span>
			<span class="n">normalize_buffer</span><span class="p">(</span><span class="n">STbuffer</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">frp_segs</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">got</span> <span class="o">+=</span> <span class="n">b_size</span><span class="p">;</span>
		<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">got</span><span class="p">;</span>
		<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">reserved_pages</span><span class="p">[</span><span class="n">segs</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="n">segs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">reserved_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Make sure that no data from previous user is in the internal buffer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">clear_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span> <span class="n">st_bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">frp_segs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">reserved_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">reserved_page_order</span><span class="p">);</span>
	<span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">cleared</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Release the extra buffer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">normalize_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span> <span class="n">STbuffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">reserved_page_order</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">frp_segs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__free_pages</span><span class="p">(</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">reserved_pages</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">order</span><span class="p">);</span>
		<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-=</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">frp_segs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">reserved_page_order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">map_data</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Move data from the user buffer to the tape buffer. Returns zero (success) or</span>
<span class="cm">   negative error code. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">append_to_buffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span> <span class="n">st_bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">reserved_page_order</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">frp_segs</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">frp_segs</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Should never happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;st: append_to_buffer offset overflow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">frp_segs</span> <span class="o">&amp;&amp;</span> <span class="n">do_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">reserved_pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">do_count</span> <span class="o">?</span> <span class="n">length</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">:</span> <span class="n">do_count</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ubp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="n">do_count</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">ubp</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_count</span><span class="p">)</span> <span class="cm">/* Should never happen */</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Move data from the tape buffer to the user buffer. Returns zero (success) or</span>
<span class="cm">   negative error code. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">from_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span> <span class="n">st_bp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">reserved_page_order</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">read_pointer</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">frp_segs</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">frp_segs</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Should never happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;st: from_buffer offset overflow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">frp_segs</span> <span class="o">&amp;&amp;</span> <span class="n">do_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">reserved_pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">do_count</span> <span class="o">?</span> <span class="n">length</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">:</span> <span class="n">do_count</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">ubp</span><span class="p">,</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="n">do_count</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">ubp</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_count</span><span class="p">)</span> <span class="cm">/* Should never happen */</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Move data towards start of buffer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">move_buffer_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span> <span class="n">st_bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">src_seg</span><span class="p">,</span> <span class="n">dst_seg</span><span class="p">,</span> <span class="n">src_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dst_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">total</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">reserved_page_order</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">total</span><span class="o">=</span><span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">src_seg</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">src_seg</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">frp_segs</span><span class="p">;</span> <span class="n">src_seg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">src_offset</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">dst_seg</span><span class="o">=</span><span class="n">dst_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">dpage</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">reserved_pages</span><span class="p">[</span><span class="n">dst_seg</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">spage</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">reserved_pages</span><span class="p">[</span><span class="n">src_seg</span><span class="p">];</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">dst_offset</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="n">src_offset</span><span class="p">);</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">dpage</span><span class="p">)</span> <span class="o">+</span> <span class="n">dst_offset</span><span class="p">,</span>
			<span class="n">page_address</span><span class="p">(</span><span class="n">spage</span><span class="p">)</span> <span class="o">+</span> <span class="n">src_offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">src_offset</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">src_offset</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">src_seg</span><span class="o">++</span><span class="p">;</span>
			<span class="n">src_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dst_offset</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst_offset</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst_seg</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dst_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">total</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Validate the options from command line or module parameters */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">validate_options</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_kbs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">st_fixed_buffer_size</span> <span class="o">=</span> <span class="n">buffer_kbs</span> <span class="o">*</span> <span class="n">ST_KILOBYTE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_sg_segs</span> <span class="o">&gt;=</span> <span class="n">ST_FIRST_SG</span><span class="p">)</span>
		<span class="n">st_max_sg_segs</span> <span class="o">=</span> <span class="n">max_sg_segs</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="cm">/* Set the boot options. Syntax is defined in Documenation/scsi/st.txt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">st_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ints</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>

	<span class="n">stp</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">parms</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">)</span>
				<span class="o">*</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">stp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">parms</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">stp</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="p">(</span><span class="n">stp</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">)</span>
						<span class="o">*</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span>
							<span class="n">simple_strtoul</span><span class="p">(</span><span class="n">stp</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;st: Obsolete parameter %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">parms</span><span class="p">))</span>
				 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;st: invalid parameter in &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">stp</span><span class="p">);</span>
			<span class="n">stp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="p">)</span>
				<span class="n">stp</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">validate_options</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;st=&quot;</span><span class="p">,</span> <span class="n">st_setup</span><span class="p">);</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">st_fops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">st_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">st_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">st_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">st_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">st_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush</span> <span class="o">=</span>	<span class="n">st_flush</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">st_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDp</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdev</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">tpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TYPE_TAPE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stp</span> <span class="o">=</span> <span class="n">st_incompatible</span><span class="p">(</span><span class="n">SDp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SDp</span><span class="p">,</span> <span class="s">&quot;Found incompatible tape</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;st: The suggested driver is %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">queue_max_segments</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st_max_sg_segs</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">st_max_sg_segs</span><span class="p">;</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">new_tape_buffer</span><span class="p">((</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;st: Can&#39;t allocate new tape buffer. Device not attached.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">disk</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;st: out of memory. Device not attached.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_buffer_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st_nr_dev</span> <span class="o">&gt;=</span> <span class="n">st_dev_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">**</span><span class="n">tmp_da</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tmp_dev_max</span><span class="p">;</span>

		<span class="n">tmp_dev_max</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">st_nr_dev</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_dev_max</span> <span class="o">&gt;</span> <span class="n">ST_MAX_TAPES</span><span class="p">)</span>
			<span class="n">tmp_dev_max</span> <span class="o">=</span> <span class="n">ST_MAX_TAPES</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_dev_max</span> <span class="o">&lt;=</span> <span class="n">st_nr_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;st: Too many tape devices (max. %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ST_MAX_TAPES</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_put_disk</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tmp_da</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">tmp_dev_max</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_da</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;st: Can&#39;t extend device array.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_put_disk</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_tapes</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_da</span><span class="p">,</span> <span class="n">scsi_tapes</span><span class="p">,</span>
			       <span class="n">st_dev_max</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">scsi_tapes</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">scsi_tapes</span> <span class="o">=</span> <span class="n">tmp_da</span><span class="p">;</span>

		<span class="n">st_dev_max</span> <span class="o">=</span> <span class="n">tmp_dev_max</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_dev_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_tapes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">st_dev_max</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;scsi_devices corrupt (st)&quot;</span><span class="p">);</span>

	<span class="n">tpnt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpnt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;st: Can&#39;t allocate device descriptor.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_put_disk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;st%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">SDp</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st_template</span><span class="p">;</span>
	<span class="n">scsi_tapes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpnt</span><span class="p">;</span>
	<span class="n">dev_num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">SDp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">tape_type</span> <span class="o">=</span> <span class="n">MT_ISSCSI1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">tape_type</span> <span class="o">=</span> <span class="n">MT_ISSCSI2</span><span class="p">;</span>

	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">inited</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">drv_buffer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Try buffering if no mode sense */</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">restr_dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">use_pf</span> <span class="o">=</span> <span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&gt;=</span> <span class="n">SCSI_2</span><span class="p">);</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">do_auto_lock</span> <span class="o">=</span> <span class="n">ST_AUTO_LOCK</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">can_bsr</span> <span class="o">=</span> <span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">ST_IN_FILE_POS</span><span class="p">);</span> <span class="cm">/* BSR mandatory in SCSI3 */</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">two_fm</span> <span class="o">=</span> <span class="n">ST_TWO_FM</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">fast_mteom</span> <span class="o">=</span> <span class="n">ST_FAST_MTEOM</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">scsi2_logical</span> <span class="o">=</span> <span class="n">ST_SCSI2LOGICAL</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">sili</span> <span class="o">=</span> <span class="n">ST_SILI</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">immediate</span> <span class="o">=</span> <span class="n">ST_NOWAIT</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">immediate_filemark</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">default_drvbuffer</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>		<span class="cm">/* No forced buffering */</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">blk_queue_rq_timeout</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="n">ST_TIMEOUT</span><span class="p">);</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">long_timeout</span> <span class="o">=</span> <span class="n">ST_LONG_TIMEOUT</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">try_dio</span> <span class="o">=</span> <span class="n">try_direct_io</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_MODES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">defined</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">sysv</span> <span class="o">=</span> <span class="n">ST_SYSV</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">defaults_for_writes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span> <span class="o">=</span> <span class="n">ST_ASYNC_WRITES</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span> <span class="o">=</span> <span class="n">ST_BUFFER_WRITES</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_read_ahead</span> <span class="o">=</span> <span class="n">ST_READ_AHEAD</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_compression</span> <span class="o">=</span> <span class="n">ST_DONT_TOUCH</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* No forced size */</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* No forced density */</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">current_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">defined</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">density_changed</span> <span class="o">=</span> <span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">compression_changed</span> <span class="o">=</span>
	    <span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">blksize_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">st_nr_dev</span><span class="o">++</span><span class="p">;</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mode</span> <span class="o">&lt;</span> <span class="n">ST_NBR_MODES</span><span class="p">;</span> <span class="o">++</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cdev</span> <span class="o">=</span> <span class="n">cdev_alloc</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;st%d: out of memory. Device not attached.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev_num</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_free_tape</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st_fops</span><span class="p">;</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">cdev_add</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span>
					 <span class="n">MKDEV</span><span class="p">(</span><span class="n">SCSI_TAPE_MAJOR</span><span class="p">,</span> <span class="n">TAPE_MINOR</span><span class="p">(</span><span class="n">dev_num</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">j</span><span class="p">)),</span>
					 <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;st%d: Can&#39;t add %s-rewind mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev_num</span><span class="p">,</span> <span class="n">j</span> <span class="o">?</span> <span class="s">&quot;non&quot;</span> <span class="o">:</span> <span class="s">&quot;auto&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;st%d: Device not attached.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_free_tape</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">cdevs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">do_create_class_files</span><span class="p">(</span><span class="n">tpnt</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_tape</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scsi_autopm_put_device</span><span class="p">(</span><span class="n">SDp</span><span class="p">);</span>

	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="n">SDp</span><span class="p">,</span>
		    <span class="s">&quot;Attached scsi tape %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">tpnt</span><span class="p">));</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SDp</span><span class="p">,</span> <span class="s">&quot;%s: try direct i/o: %s (alignment %d B)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">tape_name</span><span class="p">(</span><span class="n">tpnt</span><span class="p">),</span> <span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">try_dio</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span>
		    <span class="n">queue_dma_alignment</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_tape:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">mode</span> <span class="o">&lt;</span> <span class="n">ST_NBR_MODES</span><span class="p">;</span> <span class="n">mode</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">]);</span>
		<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_gendev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				  <span class="s">&quot;tape&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">cdevs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span> <span class="o">==</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">cdevs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
					<span class="n">cdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">device_destroy</span><span class="p">(</span><span class="n">st_sysfs_class</span><span class="p">,</span>
						       <span class="n">MKDEV</span><span class="p">(</span><span class="n">SCSI_TAPE_MAJOR</span><span class="p">,</span>
							     <span class="n">TAPE_MINOR</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">j</span><span class="p">)));</span>
				<span class="n">cdev_del</span><span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">cdevs</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="p">)</span>
		<span class="n">cdev_del</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
	<span class="n">scsi_tapes</span><span class="p">[</span><span class="n">dev_num</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">st_nr_dev</span><span class="o">--</span><span class="p">;</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
<span class="nl">out_put_disk:</span>
	<span class="n">put_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tpnt</span><span class="p">);</span>
<span class="nl">out_buffer_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">st_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDp</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">tpnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">scsi_autopm_get_device</span><span class="p">(</span><span class="n">SDp</span><span class="p">);</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_dev_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpnt</span> <span class="o">=</span> <span class="n">scsi_tapes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpnt</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">SDp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsi_tapes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">st_nr_dev</span><span class="o">--</span><span class="p">;</span>
			<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
			<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_gendev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
					  <span class="s">&quot;tape&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mode</span> <span class="o">&lt;</span> <span class="n">ST_NBR_MODES</span><span class="p">;</span> <span class="o">++</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">device_destroy</span><span class="p">(</span><span class="n">st_sysfs_class</span><span class="p">,</span>
						       <span class="n">MKDEV</span><span class="p">(</span><span class="n">SCSI_TAPE_MAJOR</span><span class="p">,</span>
							     <span class="n">TAPE_MINOR</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">j</span><span class="p">)));</span>
					<span class="n">cdev_del</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">].</span><span class="n">cdevs</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
					<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">].</span><span class="n">cdevs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ref_mutex</span><span class="p">);</span>
			<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">scsi_tape_release</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ref_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_dev_arr_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *      scsi_tape_release - Called to free the Scsi_Tape structure</span>
<span class="cm"> *      @kref: pointer to embedded kref</span>
<span class="cm"> *</span>
<span class="cm"> *      st_ref_mutex must be held entering this routine.  Because it is</span>
<span class="cm"> *      called on last put, you should always use the scsi_tape_get()</span>
<span class="cm"> *      scsi_tape_put() helpers which manipulate the semaphore directly</span>
<span class="cm"> *      and never do a direct kref_put().</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scsi_tape_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">tpnt</span> <span class="o">=</span> <span class="n">to_scsi_tape</span><span class="p">(</span><span class="n">kref</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">;</span>

	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">normalize_buffer</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">reserved_pages</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">put_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tpnt</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_st</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">validate_options</span><span class="p">();</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;st: Version %s, fixed bufsize %d, s/g segs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">verstr</span><span class="p">,</span> <span class="n">st_fixed_buffer_size</span><span class="p">,</span> <span class="n">st_max_sg_segs</span><span class="p">);</span>

	<span class="n">st_sysfs_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;scsi_tape&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">st_sysfs_class</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable create sysfs class for SCSI tapes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">st_sysfs_class</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_chrdev_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">SCSI_TAPE_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				     <span class="n">ST_MAX_TAPE_ENTRIES</span><span class="p">,</span> <span class="s">&quot;st&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to get major %d for SCSI tapes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">SCSI_TAPE_MAJOR</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_class</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">scsi_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_template</span><span class="p">.</span><span class="n">gendrv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_chrdev</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">do_create_sysfs_files</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_scsidrv</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_scsidrv:</span>
	<span class="n">scsi_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_template</span><span class="p">.</span><span class="n">gendrv</span><span class="p">);</span>
<span class="nl">err_chrdev:</span>
	<span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">SCSI_TAPE_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				 <span class="n">ST_MAX_TAPE_ENTRIES</span><span class="p">);</span>
<span class="nl">err_class:</span>
	<span class="n">class_destroy</span><span class="p">(</span><span class="n">st_sysfs_class</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_st</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_remove_sysfs_files</span><span class="p">();</span>
	<span class="n">scsi_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_template</span><span class="p">.</span><span class="n">gendrv</span><span class="p">);</span>
	<span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">SCSI_TAPE_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				 <span class="n">ST_MAX_TAPE_ENTRIES</span><span class="p">);</span>
	<span class="n">class_destroy</span><span class="p">(</span><span class="n">st_sysfs_class</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">scsi_tapes</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;st: Unloaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_st</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_st</span><span class="p">);</span>


<span class="cm">/* The sysfs driver interface. Read-only at the moment */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">st_try_direct_io_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">try_direct_io</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">try_direct_io</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">st_try_direct_io_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">st_fixed_buffer_size_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">st_fixed_buffer_size</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">fixed_buffer_size</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">st_fixed_buffer_size_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">st_max_sg_segs_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">st_max_sg_segs</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">max_sg_segs</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">st_max_sg_segs_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">st_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">verstr</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">st_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_create_sysfs_files</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">sysfs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st_template</span><span class="p">.</span><span class="n">gendrv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_try_direct_io</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_fixed_buffer_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_try_direct_io</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_max_sg_segs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_attr_fixed_buf</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_attr_max_sg</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_attr_max_sg:</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_max_sg_segs</span><span class="p">);</span>
<span class="nl">err_attr_fixed_buf:</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_fixed_buffer_size</span><span class="p">);</span>
<span class="nl">err_try_direct_io:</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_try_direct_io</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_remove_sysfs_files</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">sysfs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st_template</span><span class="p">.</span><span class="n">gendrv</span><span class="p">;</span>

	<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_version</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_max_sg_segs</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_fixed_buffer_size</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_try_direct_io</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* The sysfs simple class interface */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">st_defined_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">defined</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">defined</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">st_defined_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">st_defblk_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">default_blksize</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">st_defblk_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">st_defdensity_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;0x%02x</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">default_density</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">st_defdensity_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">st_defcompression_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_compression</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">default_compression</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">st_defcompression_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">st_options_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">options</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_dev_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ST_NBR_MODES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">scsi_tapes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">STm</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">ST_NBR_MODES</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">st_dev_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* should never happen */</span>

	<span class="n">STp</span> <span class="o">=</span> <span class="n">scsi_tapes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">options</span> <span class="o">=</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span> <span class="o">?</span> <span class="n">MT_ST_BUFFER_WRITES</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span> <span class="o">?</span> <span class="n">MT_ST_ASYNC_WRITES</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_read_ahead</span> <span class="o">?</span> <span class="n">MT_ST_READ_AHEAD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DEB</span><span class="p">(</span> <span class="n">options</span> <span class="o">|=</span> <span class="n">debugging</span> <span class="o">?</span> <span class="n">MT_ST_DEBUGGING</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">);</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">two_fm</span> <span class="o">?</span> <span class="n">MT_ST_TWO_FM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_mteom</span> <span class="o">?</span> <span class="n">MT_ST_FAST_MTEOM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">defaults_for_writes</span> <span class="o">?</span> <span class="n">MT_ST_DEF_WRITES</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_bsr</span> <span class="o">?</span> <span class="n">MT_ST_CAN_BSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">omit_blklims</span> <span class="o">?</span> <span class="n">MT_ST_NO_BLKLIMS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">?</span> <span class="n">MT_ST_CAN_PARTITIONS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">scsi2_logical</span> <span class="o">?</span> <span class="n">MT_ST_SCSI2LOGICAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">sysv</span> <span class="o">?</span> <span class="n">MT_ST_SYSV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate</span> <span class="o">?</span> <span class="n">MT_ST_NOWAIT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">immediate_filemark</span> <span class="o">?</span> <span class="n">MT_ST_NOWAIT_EOF</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">options</span> <span class="o">|=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">sili</span> <span class="o">?</span> <span class="n">MT_ST_SILI</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">st_options_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_create_class_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rew</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">st_class_member</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rew</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">rew</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">rew</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure that the minor numbers corresponding to the four</span>
<span class="cm">		   first modes always get the same names */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">ST_NBR_MODE_BITS</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&quot;%s%s%s&quot;</span><span class="p">,</span> <span class="n">rew</span> <span class="o">?</span> <span class="s">&quot;n&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			 <span class="n">STp</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">st_formats</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">st_class_member</span> <span class="o">=</span>
			<span class="n">device_create</span><span class="p">(</span><span class="n">st_sysfs_class</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_gendev</span><span class="p">,</span>
				      <span class="n">MKDEV</span><span class="p">(</span><span class="n">SCSI_TAPE_MAJOR</span><span class="p">,</span>
					    <span class="n">TAPE_MINOR</span><span class="p">(</span><span class="n">dev_num</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">rew</span><span class="p">)),</span>
				      <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">st_class_member</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;st%d: device_create failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev_num</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">st_class_member</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">st_class_member</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_attr_defined</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">st_class_member</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_attr_default_blksize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">st_class_member</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_attr_default_density</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">st_class_member</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_attr_default_compression</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">st_class_member</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_attr_options</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rew</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_gendev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">st_class_member</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
						  <span class="s">&quot;tape&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;st%d: Can&#39;t create sysfs link from SCSI device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev_num</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The following functions may be useful for a larger audience. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sgl_map_user_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="n">STbp</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_pages</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uaddr</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">uaddr</span> <span class="o">+</span> <span class="n">count</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">uaddr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">nr_pages</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rq_map_data</span> <span class="o">*</span><span class="n">mdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">map_data</span><span class="p">;</span>

	<span class="cm">/* User attempted Overflow! */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">uaddr</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">uaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Too big */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nr_pages</span> <span class="o">&gt;</span> <span class="n">max_pages</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Hmm? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pages</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">max_pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pages</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

        <span class="cm">/* Try to fault in all of the necessary pages */</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
        <span class="cm">/* rw==READ means read from drive, write into memory area */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">get_user_pages</span><span class="p">(</span>
		<span class="n">current</span><span class="p">,</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span>
		<span class="n">uaddr</span><span class="p">,</span>
		<span class="n">nr_pages</span><span class="p">,</span>
		<span class="n">rw</span> <span class="o">==</span> <span class="n">READ</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="cm">/* don&#39;t force */</span>
		<span class="n">pages</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>

	<span class="cm">/* Errors and no page mapped should return here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* FIXME: flush superflous for rw==READ,</span>
<span class="cm">                 * probably wrong function for rw==WRITE</span>
<span class="cm">                 */</span>
		<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>

	<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">uaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">mapped_pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nr_pages</span><span class="p">;</span>
 <span class="nl">out_unmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">res</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">page_cache_release</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pages</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* And unmap them... */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sgl_unmap_user_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_buffer</span> <span class="o">*</span><span class="n">STbp</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dirtied</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">STbp</span><span class="o">-&gt;</span><span class="n">mapped_pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dirtied</span><span class="p">)</span>
			<span class="n">SetPageDirty</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="cm">/* FIXME: cache flush missing for rw==READ</span>
<span class="cm">		 * FIXME: call the correct reference counting function</span>
<span class="cm">		 */</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">STbp</span><span class="o">-&gt;</span><span class="n">mapped_pages</span><span class="p">);</span>
	<span class="n">STbp</span><span class="o">-&gt;</span><span class="n">mapped_pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
