<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › bfa › bfa_fcpim.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bfa_fcpim.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2010 Brocade Communications Systems, Inc.</span>
<span class="cm"> * All rights reserved</span>
<span class="cm"> * www.brocade.com</span>
<span class="cm"> *</span>
<span class="cm"> * Linux driver for Brocade Fibre Channel Host Bus Adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License (GPL) Version 2 as</span>
<span class="cm"> * published by the Free Software Foundation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;bfad_drv.h&quot;</span>
<span class="cp">#include &quot;bfa_modules.h&quot;</span>

<span class="n">BFA_TRC_FILE</span><span class="p">(</span><span class="n">HAL</span><span class="p">,</span> <span class="n">FCPIM</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  BFA ITNIM Related definitions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_itnim_update_del_itn_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioim_lm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">);</span>

<span class="cp">#define BFA_ITNIM_FROM_TAG(_fcpim, _tag)                                \</span>
<span class="cp">	(((_fcpim)-&gt;itnim_arr + ((_tag) &amp; ((_fcpim)-&gt;num_itnims - 1))))</span>

<span class="cp">#define bfa_fcpim_additn(__itnim)					\</span>
<span class="cp">	list_add_tail(&amp;(__itnim)-&gt;qe, &amp;(__itnim)-&gt;fcpim-&gt;itnim_q)</span>
<span class="cp">#define bfa_fcpim_delitn(__itnim)	do {				\</span>
<span class="cp">	WARN_ON(!bfa_q_is_on_q(&amp;(__itnim)-&gt;fcpim-&gt;itnim_q, __itnim));   \</span>
<span class="cp">	bfa_itnim_update_del_itn_stats(__itnim);      \</span>
<span class="cp">	list_del(&amp;(__itnim)-&gt;qe);      \</span>
<span class="cp">	WARN_ON(!list_empty(&amp;(__itnim)-&gt;io_q));				\</span>
<span class="cp">	WARN_ON(!list_empty(&amp;(__itnim)-&gt;io_cleanup_q));			\</span>
<span class="cp">	WARN_ON(!list_empty(&amp;(__itnim)-&gt;pending_q));			\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bfa_itnim_online_cb(__itnim) do {				\</span>
<span class="cp">	if ((__itnim)-&gt;bfa-&gt;fcs)					\</span>
<span class="cp">		bfa_cb_itnim_online((__itnim)-&gt;ditn);      \</span>
<span class="cp">	else {								\</span>
<span class="cp">		bfa_cb_queue((__itnim)-&gt;bfa, &amp;(__itnim)-&gt;hcb_qe,	\</span>
<span class="cp">		__bfa_cb_itnim_online, (__itnim));      \</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bfa_itnim_offline_cb(__itnim) do {				\</span>
<span class="cp">	if ((__itnim)-&gt;bfa-&gt;fcs)					\</span>
<span class="cp">		bfa_cb_itnim_offline((__itnim)-&gt;ditn);      \</span>
<span class="cp">	else {								\</span>
<span class="cp">		bfa_cb_queue((__itnim)-&gt;bfa, &amp;(__itnim)-&gt;hcb_qe,	\</span>
<span class="cp">		__bfa_cb_itnim_offline, (__itnim));      \</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bfa_itnim_sler_cb(__itnim) do {					\</span>
<span class="cp">	if ((__itnim)-&gt;bfa-&gt;fcs)					\</span>
<span class="cp">		bfa_cb_itnim_sler((__itnim)-&gt;ditn);      \</span>
<span class="cp">	else {								\</span>
<span class="cp">		bfa_cb_queue((__itnim)-&gt;bfa, &amp;(__itnim)-&gt;hcb_qe,	\</span>
<span class="cp">		__bfa_cb_itnim_sler, (__itnim));      \</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="k">enum</span> <span class="n">bfa_ioim_lm_ua_status</span> <span class="p">{</span>
	<span class="n">BFA_IOIM_LM_UA_RESET</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">BFA_IOIM_LM_UA_SET</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  itnim state machine event</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="p">{</span>
	<span class="n">BFA_ITNIM_SM_CREATE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/*  itnim is created */</span>
	<span class="n">BFA_ITNIM_SM_ONLINE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/*  itnim is online */</span>
	<span class="n">BFA_ITNIM_SM_OFFLINE</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="cm">/*  itnim is offline */</span>
	<span class="n">BFA_ITNIM_SM_FWRSP</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>		<span class="cm">/*  firmware response */</span>
	<span class="n">BFA_ITNIM_SM_DELETE</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/*  deleting an existing itnim */</span>
	<span class="n">BFA_ITNIM_SM_CLEANUP</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	<span class="cm">/*  IO cleanup completion */</span>
	<span class="n">BFA_ITNIM_SM_SLER</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>		<span class="cm">/*  second level error recovery */</span>
	<span class="n">BFA_ITNIM_SM_HWFAIL</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/*  IOC h/w failure event */</span>
	<span class="n">BFA_ITNIM_SM_QRESUME</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>	<span class="cm">/*  queue space available */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  BFA IOIM related definitions</span>
<span class="cm"> */</span>
<span class="cp">#define bfa_ioim_move_to_comp_q(__ioim) do {				\</span>
<span class="cp">	list_del(&amp;(__ioim)-&gt;qe);					\</span>
<span class="cp">	list_add_tail(&amp;(__ioim)-&gt;qe, &amp;(__ioim)-&gt;fcpim-&gt;ioim_comp_q);	\</span>
<span class="cp">} while (0)</span>


<span class="cp">#define bfa_ioim_cb_profile_comp(__fcpim, __ioim) do {			\</span>
<span class="cp">	if ((__fcpim)-&gt;profile_comp)					\</span>
<span class="cp">		(__fcpim)-&gt;profile_comp(__ioim);			\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bfa_ioim_cb_profile_start(__fcpim, __ioim) do {			\</span>
<span class="cp">	if ((__fcpim)-&gt;profile_start)					\</span>
<span class="cp">		(__fcpim)-&gt;profile_start(__ioim);			\</span>
<span class="cp">} while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * IO state machine events</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="p">{</span>
	<span class="n">BFA_IOIM_SM_START</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/*  io start request from host */</span>
	<span class="n">BFA_IOIM_SM_COMP_GOOD</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/*  io good comp, resource free */</span>
	<span class="n">BFA_IOIM_SM_COMP</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="cm">/*  io comp, resource is free */</span>
	<span class="n">BFA_IOIM_SM_COMP_UTAG</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/*  io comp, resource is free */</span>
	<span class="n">BFA_IOIM_SM_DONE</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/*  io comp, resource not free */</span>
	<span class="n">BFA_IOIM_SM_FREE</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	<span class="cm">/*  io resource is freed */</span>
	<span class="n">BFA_IOIM_SM_ABORT</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>	<span class="cm">/*  abort request from scsi stack */</span>
	<span class="n">BFA_IOIM_SM_ABORT_COMP</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/*  abort from f/w */</span>
	<span class="n">BFA_IOIM_SM_ABORT_DONE</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>	<span class="cm">/*  abort completion from f/w */</span>
	<span class="n">BFA_IOIM_SM_QRESUME</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>	<span class="cm">/*  CQ space available to queue IO */</span>
	<span class="n">BFA_IOIM_SM_SGALLOCED</span>	<span class="o">=</span> <span class="mi">11</span><span class="p">,</span>	<span class="cm">/*  SG page allocation successful */</span>
	<span class="n">BFA_IOIM_SM_SQRETRY</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>	<span class="cm">/*  sequence recovery retry */</span>
	<span class="n">BFA_IOIM_SM_HCB</span>		<span class="o">=</span> <span class="mi">13</span><span class="p">,</span>	<span class="cm">/*  bfa callback complete */</span>
	<span class="n">BFA_IOIM_SM_CLEANUP</span>	<span class="o">=</span> <span class="mi">14</span><span class="p">,</span>	<span class="cm">/*  IO cleanup from itnim */</span>
	<span class="n">BFA_IOIM_SM_TMSTART</span>	<span class="o">=</span> <span class="mi">15</span><span class="p">,</span>	<span class="cm">/*  IO cleanup from tskim */</span>
	<span class="n">BFA_IOIM_SM_TMDONE</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>	<span class="cm">/*  IO cleanup from tskim */</span>
	<span class="n">BFA_IOIM_SM_HWFAIL</span>	<span class="o">=</span> <span class="mi">17</span><span class="p">,</span>	<span class="cm">/*  IOC h/w failure event */</span>
	<span class="n">BFA_IOIM_SM_IOTOV</span>	<span class="o">=</span> <span class="mi">18</span><span class="p">,</span>	<span class="cm">/*  ITN offline TOV */</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> *  BFA TSKIM related definitions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * task management completion handling</span>
<span class="cm"> */</span>
<span class="cp">#define bfa_tskim_qcomp(__tskim, __cbfn) do {				\</span>
<span class="cp">	bfa_cb_queue((__tskim)-&gt;bfa, &amp;(__tskim)-&gt;hcb_qe, __cbfn, (__tskim));\</span>
<span class="cp">	bfa_tskim_notify_comp(__tskim);      \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bfa_tskim_notify_comp(__tskim) do {				\</span>
<span class="cp">	if ((__tskim)-&gt;notify)						\</span>
<span class="cp">		bfa_itnim_tskdone((__tskim)-&gt;itnim);      \</span>
<span class="cp">} while (0)</span>


<span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="p">{</span>
	<span class="n">BFA_TSKIM_SM_START</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/*  TM command start		*/</span>
	<span class="n">BFA_TSKIM_SM_DONE</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/*  TM completion		*/</span>
	<span class="n">BFA_TSKIM_SM_QRESUME</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="cm">/*  resume after qfull		*/</span>
	<span class="n">BFA_TSKIM_SM_HWFAIL</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/*  IOC h/w failure event	*/</span>
	<span class="n">BFA_TSKIM_SM_HCB</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	<span class="cm">/*  BFA callback completion	*/</span>
	<span class="n">BFA_TSKIM_SM_IOS_DONE</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>	<span class="cm">/*  IO and sub TM completions	*/</span>
	<span class="n">BFA_TSKIM_SM_CLEANUP</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/*  TM cleanup on ITN offline	*/</span>
	<span class="n">BFA_TSKIM_SM_CLEANUP_DONE</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>	<span class="cm">/*  TM abort completion	*/</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * forward declaration for BFA ITNIM functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_iocdisable_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span> <span class="n">bfa_itnim_send_fwcreate</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span> <span class="n">bfa_itnim_send_fwdelete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_cleanp_comp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">itnim_cbarg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">__bfa_cb_itnim_online</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">__bfa_cb_itnim_offline</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">__bfa_cb_itnim_sler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_iotov_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_iotov_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_iotov</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">itnim_arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_iotov_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_iotov_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_iotov_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * forward declaration of ITNIM state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_created</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_fwcreate</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_delete_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_sler</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_cleanup_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_cleanup_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_fwdelete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_deleting</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_fwcreate_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_fwdelete_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_itnim_sm_deleting_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * forward declaration for BFA IOIM functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span>	<span class="n">bfa_ioim_send_ioreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span>	<span class="n">bfa_ioim_sgpg_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span>	<span class="n">bfa_ioim_send_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">bfa_ioim_notify_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__bfa_cb_ioim_good_comp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__bfa_cb_ioim_comp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__bfa_cb_ioim_abort</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__bfa_cb_ioim_pathtov</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span>    <span class="n">bfa_ioim_is_abortable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * forward declaration of BFA IO state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_ioim_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_ioim_sm_sgalloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_ioim_sm_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_ioim_sm_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_ioim_sm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_ioim_sm_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_ioim_sm_abort_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_ioim_sm_cleanup_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_ioim_sm_hcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_ioim_sm_hcb_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_ioim_sm_resfree</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_ioim_sm_cmnd_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * forward declaration for BFA TSKIM functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">__bfa_cb_tskim_done</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">__bfa_cb_tskim_failed</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span> <span class="n">bfa_tskim_match_scope</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">scsi_lun</span> <span class="n">lun</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_tskim_gather_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_tskim_cleanp_comp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">tskim_cbarg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_tskim_cleanup_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span> <span class="n">bfa_tskim_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span> <span class="n">bfa_tskim_send_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_tskim_iocdisable_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * forward declaration of BFA TSKIM state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_tskim_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_tskim_sm_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_tskim_sm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_tskim_sm_iocleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_tskim_sm_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_tskim_sm_cleanup_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_tskim_sm_hcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> *  BFA FCP Initiator Mode module</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Compute and return memory needed by FCP(im) module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcpim_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">km_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_itnim_meminfo</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">km_len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * IO memory</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">km_len</span> <span class="o">+=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">*</span>
	  <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_sp_s</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * task management command memory</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_tskim_reqs</span> <span class="o">&lt;</span> <span class="n">BFA_TSKIM_MIN</span><span class="p">)</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_tskim_reqs</span> <span class="o">=</span> <span class="n">BFA_TSKIM_MIN</span><span class="p">;</span>
	<span class="o">*</span><span class="n">km_len</span> <span class="o">+=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_tskim_reqs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcpim_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span> <span class="o">*</span><span class="n">fcp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">fcp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">path_tov</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_rports</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_tskim_reqs</span><span class="p">);</span>

	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span>		<span class="o">=</span> <span class="n">fcp</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">bfa</span>		<span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">num_itnims</span>	<span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_rports</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">num_tskim_reqs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_tskim_reqs</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">path_tov</span>		<span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">path_tov</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">delay_comp</span>	<span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">delay_comp</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">profile_comp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">profile_start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_itnim_attach</span><span class="p">(</span><span class="n">fcpim</span><span class="p">);</span>
	<span class="n">bfa_tskim_attach</span><span class="p">(</span><span class="n">fcpim</span><span class="p">);</span>
	<span class="n">bfa_ioim_attach</span><span class="p">(</span><span class="n">fcpim</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcpim_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span> <span class="o">*</span><span class="n">fcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="cm">/* Enqueue unused ioim resources to free_q */</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">tskim_unused_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">tskim_free_q</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">itnim_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">itnim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_itnim_iocdisable</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcpim_path_tov_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u16</span> <span class="n">path_tov</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">path_tov</span> <span class="o">=</span> <span class="n">path_tov</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">path_tov</span> <span class="o">&gt;</span> <span class="n">BFA_FCPIM_PATHTOV_MAX</span><span class="p">)</span>
		<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">path_tov</span> <span class="o">=</span> <span class="n">BFA_FCPIM_PATHTOV_MAX</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span>
<span class="nf">bfa_fcpim_path_tov_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">path_tov</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define bfa_fcpim_add_iostats(__l, __r, __stats)	\</span>
<span class="cp">	(__l-&gt;__stats += __r-&gt;__stats)</span>

<span class="kt">void</span>
<span class="nf">bfa_fcpim_add_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_iostats_s</span> <span class="o">*</span><span class="n">lstats</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_itnim_iostats_s</span> <span class="o">*</span><span class="n">rstats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">total_ios</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">qresumes</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">no_iotags</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">io_aborts</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">no_tskims</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">iocomp_ok</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">iocomp_underrun</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">iocomp_overrun</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">iocomp_aborted</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">iocomp_timedout</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">iocom_nexus_abort</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">iocom_proto_err</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">iocom_dif_err</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">iocom_sqer_needed</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">iocom_res_free</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">iocom_hostabrts</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">iocom_utags</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">io_cleanups</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">io_tmaborts</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">onlines</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">offlines</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">creates</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">deletes</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">create_comps</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">delete_comps</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">sler_events</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">fw_create</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">fw_delete</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">ioc_disabled</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">cleanup_comps</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">tm_cmnds</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">tm_fw_rsps</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">tm_success</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">tm_failures</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">tm_io_comps</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">tm_qresumes</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">tm_iocdowns</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">tm_cleanups</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">tm_cleanup_comps</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">io_comps</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">input_reqs</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">output_reqs</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">rd_throughput</span><span class="p">);</span>
	<span class="n">bfa_fcpim_add_iostats</span><span class="p">(</span><span class="n">lstats</span><span class="p">,</span> <span class="n">rstats</span><span class="p">,</span> <span class="n">wr_throughput</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcpim_port_iostats</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_itnim_iostats_s</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lp_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">;</span>

	<span class="cm">/* accumulate IO stats from itnim */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_iostats_s</span><span class="p">));</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">itnim_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">itnim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">lp_tag</span> <span class="o">!=</span> <span class="n">lp_tag</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">bfa_fcpim_add_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_ioim_profile_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_latency_s</span> <span class="o">*</span><span class="n">io_lat</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ioprofile</span><span class="p">.</span><span class="n">io_latency</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">);</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">bfa_ioim_get_index</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">((</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">dio</span><span class="p">));</span>
	<span class="n">bfa_itnim_ioprofile_update</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="n">io_lat</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">io_lat</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_lat</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">val</span><span class="p">)</span> <span class="o">?</span> <span class="n">io_lat</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">:</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">io_lat</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_lat</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">val</span><span class="p">)</span> <span class="o">?</span> <span class="n">io_lat</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">:</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">io_lat</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_ioim_profile_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcpim_profile_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u32</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="cm">/* accumulate IO stats from itnim */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">itnim_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">itnim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_itnim_clear_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">io_profile</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">io_profile_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">profile_comp</span> <span class="o">=</span> <span class="n">bfa_ioim_profile_comp</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">profile_start</span> <span class="o">=</span> <span class="n">bfa_ioim_profile_start</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcpim_profile_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">io_profile</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">io_profile_start_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">profile_comp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">profile_start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span>
<span class="nf">bfa_fcpim_qdepth_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">q_depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  BFA ITNIM module state machine functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Beginning/unallocated state - no events expected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_CREATE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_created</span><span class="p">);</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">is_online</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="n">bfa_fcpim_additn</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Beginning state, only online event expected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_created</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_ONLINE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_itnim_send_fwcreate</span><span class="p">(</span><span class="n">itnim</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwcreate</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwcreate_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcpim_delitn</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_iocdisable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Waiting for itnim create response from firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_fwcreate</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_FWRSP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_online</span><span class="p">);</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">is_online</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
		<span class="n">bfa_itnim_iotov_online</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="n">bfa_itnim_online_cb</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_delete_pending</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_OFFLINE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_itnim_send_fwdelete</span><span class="p">(</span><span class="n">itnim</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwdelete</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwdelete_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_iocdisable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_fwcreate_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwcreate</span><span class="p">);</span>
		<span class="n">bfa_itnim_send_fwcreate</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_fcpim_delitn</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_itnim_offline_cb</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_iocdisable</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Waiting for itnim create response from firmware, a delete is pending.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_delete_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_FWRSP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_itnim_send_fwdelete</span><span class="p">(</span><span class="n">itnim</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_deleting</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_deleting_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcpim_delitn</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Online state - normal parking state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_cleanup_offline</span><span class="p">);</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">is_online</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="n">bfa_itnim_iotov_start</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="n">bfa_itnim_cleanup</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_cleanup_delete</span><span class="p">);</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">is_online</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="n">bfa_itnim_cleanup</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_SLER</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_sler</span><span class="p">);</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">is_online</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="n">bfa_itnim_iotov_start</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="n">bfa_itnim_sler_cb</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_iocdisable</span><span class="p">);</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">is_online</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="n">bfa_itnim_iotov_start</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="n">bfa_itnim_iocdisable_cleanup</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Second level error recovery need.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_sler</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_cleanup_offline</span><span class="p">);</span>
		<span class="n">bfa_itnim_cleanup</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_cleanup_delete</span><span class="p">);</span>
		<span class="n">bfa_itnim_cleanup</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="n">bfa_itnim_iotov_delete</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_iocdisable</span><span class="p">);</span>
		<span class="n">bfa_itnim_iocdisable_cleanup</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Going offline. Waiting for active IO cleanup.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_cleanup_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_CLEANUP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_itnim_send_fwdelete</span><span class="p">(</span><span class="n">itnim</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwdelete</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwdelete_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_cleanup_delete</span><span class="p">);</span>
		<span class="n">bfa_itnim_iotov_delete</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_iocdisable</span><span class="p">);</span>
		<span class="n">bfa_itnim_iocdisable_cleanup</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="n">bfa_itnim_offline_cb</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_SLER</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Deleting itnim. Waiting for active IO cleanup.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_cleanup_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_CLEANUP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_itnim_send_fwdelete</span><span class="p">(</span><span class="n">itnim</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_deleting</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_deleting_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_iocdisable</span><span class="p">);</span>
		<span class="n">bfa_itnim_iocdisable_cleanup</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Rport offline. Fimrware itnim is being deleted - awaiting f/w response.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_fwdelete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_FWRSP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_itnim_offline_cb</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_deleting</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_iocdisable</span><span class="p">);</span>
		<span class="n">bfa_itnim_offline_cb</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_fwdelete_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwdelete</span><span class="p">);</span>
		<span class="n">bfa_itnim_send_fwdelete</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_deleting_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_iocdisable</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_itnim_offline_cb</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Offline state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_itnim_iotov_delete</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="n">bfa_fcpim_delitn</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_ONLINE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_itnim_send_fwcreate</span><span class="p">(</span><span class="n">itnim</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwcreate</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwcreate_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_iocdisable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_itnim_iotov_delete</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="n">bfa_fcpim_delitn</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_OFFLINE</span>:
		<span class="n">bfa_itnim_offline_cb</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_ONLINE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_itnim_send_fwcreate</span><span class="p">(</span><span class="n">itnim</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwcreate</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwcreate_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Itnim is deleted, waiting for firmware response to delete.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_deleting</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_FWRSP</span>:
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcpim_delitn</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_sm_deleting_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">bfa_itnim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_deleting</span><span class="p">);</span>
		<span class="n">bfa_itnim_send_fwdelete</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_fcpim_delitn</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initiate cleanup of all IOs on an IOC failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_iocdisable_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">tsk_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tskim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_tskim_iocdisable</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">io_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_ioim_iocdisable</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For IO request in pending queue, we pretend an early timeout.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_ioim_tov</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">io_cleanup_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_ioim_iocdisable</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO cleanup completion</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_cleanp_comp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">itnim_cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">itnim_cbarg</span><span class="p">;</span>

	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">cleanup_comps</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">BFA_ITNIM_SM_CLEANUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initiate cleanup of all IOs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span>  <span class="o">*</span><span class="n">ioim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="n">bfa_wc_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">,</span> <span class="n">bfa_itnim_cleanp_comp</span><span class="p">,</span> <span class="n">itnim</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">io_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Move IO to a cleanup queue from active queue so that a later</span>
<span class="cm">		 * TM will not pickup this IO.</span>
<span class="cm">		 */</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">io_cleanup_q</span><span class="p">);</span>

		<span class="n">bfa_wc_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">);</span>
		<span class="n">bfa_ioim_cleanup</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">tsk_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tskim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_wc_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">);</span>
		<span class="n">bfa_tskim_cleanup</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_wc_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_itnim_online</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">bfa_cb_itnim_online</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ditn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_itnim_offline</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">bfa_cb_itnim_offline</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ditn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_itnim_sler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">bfa_cb_itnim_sler</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ditn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call to resume any I/O requests waiting for room in request queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_qresume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">BFA_ITNIM_SM_QRESUME</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  bfa_itnim_public</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">bfa_itnim_iodone</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_wc_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_itnim_tskdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_wc_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_itnim_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">km_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * ITN memory</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">km_len</span> <span class="o">+=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_rports</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_itnim_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>	<span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span>	<span class="o">*</span><span class="n">fcp</span> <span class="o">=</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">itnim_q</span><span class="p">);</span>

	<span class="n">itnim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">fcp</span><span class="p">);</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">itnim_arr</span> <span class="o">=</span> <span class="n">itnim</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">num_itnims</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">itnim</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span><span class="p">));</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">fcpim</span><span class="p">;</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span> <span class="o">=</span> <span class="n">BFA_REQQ_QOS_LO</span><span class="p">;</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">=</span> <span class="n">BFA_RPORT_FROM_TAG</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">iotov_active</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="n">bfa_reqq_winit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">,</span> <span class="n">bfa_itnim_qresume</span><span class="p">,</span> <span class="n">itnim</span><span class="p">);</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">io_q</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">io_cleanup_q</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">tsk_q</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">delay_comp_q</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BFA_IOBUCKET_MAX</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ioprofile</span><span class="p">.</span><span class="n">io_latency</span><span class="p">.</span><span class="n">min</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_uninit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">fcp</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">itnim</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_itnim_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">ioc_disabled</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">BFA_ITNIM_SM_HWFAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bfa_boolean_t</span>
<span class="nf">bfa_itnim_send_fwcreate</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_itn_create_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">msg_no</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for room in queue to send request now</span>
<span class="cm">	 */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_ITN</span><span class="p">,</span> <span class="n">BFI_ITN_H2I_CREATE_REQ</span><span class="p">,</span>
			<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">fw_handle</span> <span class="o">=</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">FC_CLASS_3</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">seq_rec</span> <span class="o">=</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">seq_rec</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg_no</span> <span class="o">=</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">msg_no</span><span class="p">;</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">fw_create</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue I/O message to firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bfa_boolean_t</span>
<span class="nf">bfa_itnim_send_fwdelete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_itn_delete_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for room in queue to send request now</span>
<span class="cm">	 */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_ITN</span><span class="p">,</span> <span class="n">BFI_ITN_H2I_DELETE_REQ</span><span class="p">,</span>
			<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">fw_handle</span> <span class="o">=</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">fw_delete</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue I/O message to firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cleanup all pending failed inflight requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_delayed_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">iotov</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">delay_comp_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="p">)</span><span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_ioim_delayed_comp</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">iotov</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start all pending IO requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_iotov_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">;</span>

	<span class="n">bfa_itnim_iotov_stop</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Abort all inflight IO requests in the queue</span>
<span class="cm">	 */</span>
	<span class="n">bfa_itnim_delayed_comp</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start all pending IO requests.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">io_q</span><span class="p">);</span>
		<span class="n">bfa_ioim_start</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fail all pending IO requests</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_iotov_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fail all inflight IO requests in the queue</span>
<span class="cm">	 */</span>
	<span class="n">bfa_itnim_delayed_comp</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">BFA_TRUE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fail any pending IO requests.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">ioim_comp_q</span><span class="p">);</span>
		<span class="n">bfa_ioim_tov</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO TOV timer callback. Fail any pending IO requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_iotov</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">itnim_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">itnim_arg</span><span class="p">;</span>

	<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">iotov_active</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="n">bfa_cb_itnim_tov_begin</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ditn</span><span class="p">);</span>
	<span class="n">bfa_itnim_iotov_cleanup</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
	<span class="n">bfa_cb_itnim_tov</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ditn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start IO TOV timer for failing back pending IO requests in offline state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_iotov_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">path_tov</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">iotov_active</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bfa_itnim_hold_io</span><span class="p">(</span><span class="n">itnim</span><span class="p">));</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
			<span class="n">bfa_itnim_iotov</span><span class="p">,</span> <span class="n">itnim</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">path_tov</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop IO TOV timer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_iotov_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">iotov_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">iotov_active</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop IO TOV timer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_iotov_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_boolean_t</span> <span class="n">pathtov_active</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">iotov_active</span><span class="p">)</span>
		<span class="n">pathtov_active</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>

	<span class="n">bfa_itnim_iotov_stop</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pathtov_active</span><span class="p">)</span>
		<span class="n">bfa_cb_itnim_tov_begin</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ditn</span><span class="p">);</span>
	<span class="n">bfa_itnim_iotov_cleanup</span><span class="p">(</span><span class="n">itnim</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pathtov_active</span><span class="p">)</span>
		<span class="n">bfa_cb_itnim_tov</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ditn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_itnim_update_del_itn_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">del_itn_stats</span><span class="p">.</span><span class="n">del_itn_iocomp_aborted</span> <span class="o">+=</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">iocomp_aborted</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">del_itn_stats</span><span class="p">.</span><span class="n">del_itn_iocomp_timedout</span> <span class="o">+=</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">iocomp_timedout</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">del_itn_stats</span><span class="p">.</span><span class="n">del_itn_iocom_sqer_needed</span> <span class="o">+=</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">iocom_sqer_needed</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">del_itn_stats</span><span class="p">.</span><span class="n">del_itn_iocom_res_free</span> <span class="o">+=</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">iocom_res_free</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">del_itn_stats</span><span class="p">.</span><span class="n">del_itn_iocom_hostabrts</span> <span class="o">+=</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">iocom_hostabrts</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">del_itn_stats</span><span class="p">.</span><span class="n">del_itn_total_ios</span> <span class="o">+=</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">total_ios</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">del_itn_stats</span><span class="p">.</span><span class="n">del_io_iocdowns</span> <span class="o">+=</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">io_iocdowns</span><span class="p">;</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">del_itn_stats</span><span class="p">.</span><span class="n">del_tm_iocdowns</span> <span class="o">+=</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tm_iocdowns</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bfa_itnim_public</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Itnim interrupt processing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_itnim_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">bfi_itn_i2h_msg_u</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFI_ITN_I2H_CREATE_RSP</span>:
		<span class="n">itnim</span> <span class="o">=</span> <span class="n">BFA_ITNIM_FROM_TAG</span><span class="p">(</span><span class="n">fcpim</span><span class="p">,</span>
						<span class="n">msg</span><span class="p">.</span><span class="n">create_rsp</span><span class="o">-&gt;</span><span class="n">bfa_handle</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">create_rsp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">);</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">create_comps</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">BFA_ITNIM_SM_FWRSP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ITN_I2H_DELETE_RSP</span>:
		<span class="n">itnim</span> <span class="o">=</span> <span class="n">BFA_ITNIM_FROM_TAG</span><span class="p">(</span><span class="n">fcpim</span><span class="p">,</span>
						<span class="n">msg</span><span class="p">.</span><span class="n">delete_rsp</span><span class="o">-&gt;</span><span class="n">bfa_handle</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">delete_rsp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">);</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">delete_comps</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">BFA_ITNIM_SM_FWRSP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ITN_I2H_SLER_EVENT</span>:
		<span class="n">itnim</span> <span class="o">=</span> <span class="n">BFA_ITNIM_FROM_TAG</span><span class="p">(</span><span class="n">fcpim</span><span class="p">,</span>
						<span class="n">msg</span><span class="p">.</span><span class="n">sler_event</span><span class="o">-&gt;</span><span class="n">bfa_handle</span><span class="p">);</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">sler_events</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">BFA_ITNIM_SM_SLER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bfa_itnim_api</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span>
<span class="nf">bfa_itnim_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ditn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">;</span>

	<span class="n">bfa_itn_create</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span> <span class="n">bfa_itnim_isr</span><span class="p">);</span>

	<span class="n">itnim</span> <span class="o">=</span> <span class="n">BFA_ITNIM_FROM_TAG</span><span class="p">(</span><span class="n">fcpim</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">!=</span> <span class="n">rport</span><span class="p">);</span>

	<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ditn</span> <span class="o">=</span> <span class="n">ditn</span><span class="p">;</span>

	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">creates</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">BFA_ITNIM_SM_CREATE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">itnim</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_itnim_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">deletes</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">BFA_ITNIM_SM_DELETE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_itnim_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">seq_rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">seq_rec</span> <span class="o">=</span> <span class="n">seq_rec</span><span class="p">;</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">onlines</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">BFA_ITNIM_SM_ONLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_itnim_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">offlines</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">BFA_ITNIM_SM_OFFLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return true if itnim is considered offline for holding off IO request.</span>
<span class="cm"> * IO is not held if itnim is being deleted.</span>
<span class="cm"> */</span>
<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_itnim_hold_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">path_tov</span> <span class="o">&amp;&amp;</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">iotov_active</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwcreate</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_sler</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_cleanup_offline</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_fwdelete</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_offline</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">bfa_itnim_sm_iocdisable</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define bfa_io_lat_clock_res_div	HZ</span>
<span class="cp">#define bfa_io_lat_clock_res_mul	1000</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_itnim_get_ioprofile</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bfa_itnim_ioprofile_s</span> <span class="o">*</span><span class="n">ioprofile</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">io_profile</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_IOPROFILE_OFF</span><span class="p">;</span>

	<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ioprofile</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">BFA_IOBUCKET_MAX</span><span class="p">;</span>
	<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ioprofile</span><span class="p">.</span><span class="n">io_profile_start_time</span> <span class="o">=</span>
				<span class="n">bfa_io_profile_start_time</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ioprofile</span><span class="p">.</span><span class="n">clock_res_mul</span> <span class="o">=</span> <span class="n">bfa_io_lat_clock_res_mul</span><span class="p">;</span>
	<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ioprofile</span><span class="p">.</span><span class="n">clock_res_div</span> <span class="o">=</span> <span class="n">bfa_io_lat_clock_res_div</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ioprofile</span> <span class="o">=</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ioprofile</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_itnim_clear_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ioprofile</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ioprofile</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BFA_IOBUCKET_MAX</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">itnim</span><span class="o">-&gt;</span><span class="n">ioprofile</span><span class="p">.</span><span class="n">io_latency</span><span class="p">.</span><span class="n">min</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  BFA IO module state machine functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * IO is not started (unallocated).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_START</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_itnim_is_online</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_itnim_hold_io</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">ioim_comp_q</span><span class="p">);</span>
				<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span>
						<span class="n">__bfa_cb_ioim_pathtov</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsges</span> <span class="o">&gt;</span> <span class="n">BFI_SGE_INLINE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_ioim_sgpg_alloc</span><span class="p">(</span><span class="n">ioim</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_sgalloc</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_ioim_send_ioreq</span><span class="p">(</span><span class="n">ioim</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_qfull</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_active</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_IOTOV</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span>
				<span class="n">__bfa_cb_ioim_pathtov</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_ABORT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * IO in pending queue can get abort requests. Complete abort</span>
<span class="cm">		 * requests immediately.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bfa_q_is_on_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">,</span> <span class="n">ioim</span><span class="p">));</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span>
			<span class="n">__bfa_cb_ioim_abort</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO is waiting for SG pages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sm_sgalloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_SGALLOCED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_ioim_send_ioreq</span><span class="p">(</span><span class="n">ioim</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_qfull</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_active</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_CLEANUP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_sgpg_wcancel</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">sgpg_wqe</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_ioim_notify_cleanup</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_ABORT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_sgpg_wcancel</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">sgpg_wqe</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_abort</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_sgpg_wcancel</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">sgpg_wqe</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO is active.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sm_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_COMP_GOOD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span>
			      <span class="n">__bfa_cb_ioim_good_comp</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_comp</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_DONE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb_free</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_comp</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_ABORT</span>:
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">abort_explicit</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span> <span class="o">=</span> <span class="n">__bfa_cb_ioim_abort</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioim_send_abort</span><span class="p">(</span><span class="n">ioim</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_abort</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_abort_qfull</span><span class="p">);</span>
			<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">qwait</span><span class="p">);</span>
			<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_CLEANUP</span>:
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">abort_explicit</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span> <span class="o">=</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioim_send_abort</span><span class="p">(</span><span class="n">ioim</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_cleanup</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_cleanup_qfull</span><span class="p">);</span>
			<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">qwait</span><span class="p">);</span>
			<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_SQRETRY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioim_maxretry_reached</span><span class="p">(</span><span class="n">ioim</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* max retry reached, free IO */</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb_free</span><span class="p">);</span>
			<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
			<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span>
					<span class="n">__bfa_cb_ioim_failed</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* waiting for IO tag resource free */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_cmnd_retry</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO is retried with new tag.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sm_cmnd_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_FREE</span>:
		<span class="cm">/* abts and rrq done. Now retry the IO with new tag */</span>
		<span class="n">bfa_ioim_update_iotag</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_ioim_send_ioreq</span><span class="p">(</span><span class="n">ioim</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_qfull</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_active</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_CLEANUP</span>:
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">abort_explicit</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span> <span class="o">=</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioim_send_abort</span><span class="p">(</span><span class="n">ioim</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_cleanup</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_cleanup_qfull</span><span class="p">);</span>
			<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">qwait</span><span class="p">);</span>
			<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span>
			 <span class="n">__bfa_cb_ioim_failed</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_ABORT</span>:
		<span class="cm">/* in this state IO abort is done.</span>
<span class="cm">		 * Waiting for IO tag resource free.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb_free</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_abort</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO is being aborted, waiting for completion from firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sm_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_COMP_GOOD</span>:
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_COMP</span>:
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_DONE</span>:
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_FREE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_ABORT_DONE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb_free</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_abort</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_ABORT_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_abort</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_COMP_UTAG</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_abort</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_CLEANUP</span>:
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">abort_explicit</span> <span class="o">!=</span> <span class="n">BFA_TRUE</span><span class="p">);</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">abort_explicit</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioim_send_abort</span><span class="p">(</span><span class="n">ioim</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_cleanup</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_cleanup_qfull</span><span class="p">);</span>
			<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">qwait</span><span class="p">);</span>
			<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO is being cleaned up (implicit abort), waiting for completion from</span>
<span class="cm"> * firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_COMP_GOOD</span>:
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_COMP</span>:
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_DONE</span>:
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_FREE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_ABORT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * IO is already being aborted implicitly</span>
<span class="cm">		 */</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span> <span class="o">=</span> <span class="n">__bfa_cb_ioim_abort</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_ABORT_DONE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb_free</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_ioim_notify_cleanup</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_ABORT_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_ioim_notify_cleanup</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_COMP_UTAG</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_ioim_notify_cleanup</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_CLEANUP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * IO can be in cleanup state already due to TM command.</span>
<span class="cm">		 * 2nd cleanup request comes from ITN offline event.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO is waiting for room in request CQ</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sm_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_active</span><span class="p">);</span>
		<span class="n">bfa_ioim_send_ioreq</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_ABORT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_abort</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_CLEANUP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_ioim_notify_cleanup</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Active IO is being aborted, waiting for room in request CQ.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sm_abort_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_abort</span><span class="p">);</span>
		<span class="n">bfa_ioim_send_abort</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_CLEANUP</span>:
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">abort_explicit</span> <span class="o">!=</span> <span class="n">BFA_TRUE</span><span class="p">);</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">abort_explicit</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_cleanup_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_COMP_GOOD</span>:
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_abort</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_DONE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb_free</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_abort</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Active IO is being cleaned up, waiting for room in request CQ.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sm_cleanup_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_cleanup</span><span class="p">);</span>
		<span class="n">bfa_ioim_send_abort</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_ABORT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * IO is already being cleaned up implicitly</span>
<span class="cm">		 */</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span> <span class="o">=</span> <span class="n">__bfa_cb_ioim_abort</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_COMP_GOOD</span>:
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_ioim_notify_cleanup</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_DONE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb_free</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_ioim_notify_cleanup</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_ioim_move_to_comp_q</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">,</span>
			      <span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO bfa callback is pending.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sm_hcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HCB</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_ioim_free</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_CLEANUP</span>:
		<span class="n">bfa_ioim_notify_cleanup</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HWFAIL</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO bfa callback is pending. IO resource cannot be freed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sm_hcb_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HCB</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_resfree</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">ioim_resfree_q</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_FREE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_CLEANUP</span>:
		<span class="n">bfa_ioim_notify_cleanup</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO is completed, waiting resource free from firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sm_resfree</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOIM_SM_FREE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_ioim_free</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_CLEANUP</span>:
		<span class="n">bfa_ioim_notify_cleanup</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_IOIM_SM_HWFAIL</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called from bfa_fcpim_start after the bfa_init() with flash read</span>
<span class="cm"> * is complete by driver. now invalidate the stale content of lun mask</span>
<span class="cm"> * like unit attention, rp tag and lp tag.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_lm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lun_mask_s</span> <span class="o">*</span><span class="n">lunm_list</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_LUNMASK_MINCFG</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">lunm_list</span> <span class="o">=</span> <span class="n">bfa_get_lun_mask_list</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LUN_MASK_CFG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ua</span> <span class="o">=</span> <span class="n">BFA_IOIM_LM_UA_RESET</span><span class="p">;</span>
		<span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lp_tag</span> <span class="o">=</span> <span class="n">BFA_LP_TAG_INVALID</span><span class="p">;</span>
		<span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rp_tag</span> <span class="o">=</span> <span class="n">BFA_RPORT_TAG_INVALID</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_ioim_good_comp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_HCB</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_cb_ioim_good_comp</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">dio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_ioim_comp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span>	<span class="o">*</span><span class="n">ioim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_ioim_rsp_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">snsinfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">sns_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span>	<span class="n">residue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_HCB</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_ioim_rsp_s</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">comp_rspmsg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">io_status</span> <span class="o">==</span> <span class="n">BFI_IOIM_STS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * setup sense information, if present</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">scsi_status</span> <span class="o">==</span> <span class="n">SCSI_STATUS_CHECK_CONDITION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">m</span><span class="o">-&gt;</span><span class="n">sns_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sns_len</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">sns_len</span><span class="p">;</span>
			<span class="n">snsinfo</span> <span class="o">=</span> <span class="n">BFA_SNSINFO_FROM_TAG</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="p">,</span>
						<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * setup residue value correctly for normal completions</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">resid_flags</span> <span class="o">==</span> <span class="n">FCP_RESID_UNDER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">residue</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">residue</span><span class="p">);</span>
			<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">iocomp_underrun</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">resid_flags</span> <span class="o">==</span> <span class="n">FCP_RESID_OVER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">residue</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">residue</span><span class="p">);</span>
			<span class="n">residue</span> <span class="o">=</span> <span class="o">-</span><span class="n">residue</span><span class="p">;</span>
			<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">iocomp_overrun</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bfa_cb_ioim_done</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">dio</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">io_status</span><span class="p">,</span>
			  <span class="n">m</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">,</span> <span class="n">sns_len</span><span class="p">,</span> <span class="n">snsinfo</span><span class="p">,</span> <span class="n">residue</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcpim_lunmask_rp_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">lp_wwn</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">rp_wwn</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">rp_tag</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lp_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lun_mask_s</span> <span class="o">*</span><span class="n">lun_list</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_LUNMASK_MINCFG</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">lun_list</span> <span class="o">=</span> <span class="n">bfa_get_lun_mask_list</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LUN_MASK_CFG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lun_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">BFA_IOIM_LUN_MASK_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">lun_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lp_wwn</span> <span class="o">==</span> <span class="n">lp_wwn</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">lun_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rp_wwn</span> <span class="o">==</span> <span class="n">rp_wwn</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">lun_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rp_tag</span> <span class="o">=</span> <span class="n">rp_tag</span><span class="p">;</span>
				<span class="n">lun_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lp_tag</span> <span class="o">=</span> <span class="n">lp_tag</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set UA for all active luns in LM DB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_lm_set_ua</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lun_mask_s</span>	<span class="o">*</span><span class="n">lunm_list</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">lunm_list</span> <span class="o">=</span> <span class="n">bfa_get_lun_mask_list</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LUN_MASK_CFG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BFA_IOIM_LUN_MASK_ACTIVE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ua</span> <span class="o">=</span> <span class="n">BFA_IOIM_LM_UA_SET</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcpim_lunmask_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u32</span> <span class="n">update</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lunmask_cfg_s</span>	<span class="o">*</span><span class="n">lun_mask</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_LUNMASK_MINCFG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">)</span> <span class="o">==</span> <span class="n">update</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_NO_CHANGE</span><span class="p">;</span>

	<span class="n">lun_mask</span> <span class="o">=</span> <span class="n">bfa_get_lun_mask</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">lun_mask</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">update</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_LUNMASK_ENABLED</span><span class="p">)</span>
		<span class="n">bfa_ioim_lm_set_ua</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span>  <span class="n">bfa_dconf_update</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcpim_lunmask_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_lun_mask_s</span>	<span class="o">*</span><span class="n">lunm_list</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_LUNMASK_MINCFG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_FAILED</span><span class="p">;</span>

	<span class="n">lunm_list</span> <span class="o">=</span> <span class="n">bfa_get_lun_mask_list</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LUN_MASK_CFG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">BFA_IOIM_LUN_MASK_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rp_tag</span> <span class="o">!=</span> <span class="n">BFA_RPORT_TAG_INVALID</span><span class="p">)</span>
				<span class="n">bfa_rport_unset_lunmask</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span>
				  <span class="n">BFA_RPORT_FROM_TAG</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rp_tag</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">lunm_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lun_mask_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_LUN_MASK_CFG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bfa_dconf_update</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcpim_lunmask_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lunmask_cfg_s</span> <span class="o">*</span><span class="n">lun_mask</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_LUNMASK_MINCFG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_FAILED</span><span class="p">;</span>

	<span class="n">lun_mask</span> <span class="o">=</span> <span class="n">bfa_get_lun_mask</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">lun_mask</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lunmask_cfg_s</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcpim_lunmask_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vf_id</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="o">*</span><span class="n">pwwn</span><span class="p">,</span>
		      <span class="n">wwn_t</span> <span class="n">rpwwn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_lun</span> <span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lun_mask_s</span> <span class="o">*</span><span class="n">lunm_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">free_index</span> <span class="o">=</span> <span class="n">MAX_LUN_MASK_CFG</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rp_fcs</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_LUNMASK_MINCFG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_FAILED</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">bfa_fcs_lookup_port</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bfa_fcs</span><span class="p">,</span>
				   <span class="n">vf_id</span><span class="p">,</span> <span class="o">*</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pwwn</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">;</span>
		<span class="n">rp_fcs</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_rport_by_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rpwwn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rp_fcs</span><span class="p">)</span>
			<span class="n">rp</span> <span class="o">=</span> <span class="n">rp_fcs</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lunm_list</span> <span class="o">=</span> <span class="n">bfa_get_lun_mask_list</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="cm">/* if entry exists */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LUN_MASK_CFG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BFA_IOIM_LUN_MASK_ACTIVE</span><span class="p">)</span>
			<span class="n">free_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lp_wwn</span> <span class="o">==</span> <span class="o">*</span><span class="n">pwwn</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rp_wwn</span> <span class="o">==</span> <span class="n">rpwwn</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">scsilun_to_int</span><span class="p">((</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lun</span><span class="p">)</span> <span class="o">==</span>
		     <span class="n">scsilun_to_int</span><span class="p">((</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lun</span><span class="p">)))</span>
			<span class="k">return</span>  <span class="n">BFA_STATUS_ENTRY_EXISTS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free_index</span> <span class="o">&gt;</span> <span class="n">MAX_LUN_MASK_CFG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_MAX_ENTRY_REACHED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lunm_list</span><span class="p">[</span><span class="n">free_index</span><span class="p">].</span><span class="n">lp_tag</span> <span class="o">=</span> <span class="n">bfa_lps_get_tag_from_pid</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span>
						   <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">local_pid</span><span class="p">);</span>
		<span class="n">lunm_list</span><span class="p">[</span><span class="n">free_index</span><span class="p">].</span><span class="n">rp_tag</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lunm_list</span><span class="p">[</span><span class="n">free_index</span><span class="p">].</span><span class="n">lp_tag</span> <span class="o">=</span> <span class="n">BFA_LP_TAG_INVALID</span><span class="p">;</span>
		<span class="n">lunm_list</span><span class="p">[</span><span class="n">free_index</span><span class="p">].</span><span class="n">rp_tag</span> <span class="o">=</span> <span class="n">BFA_RPORT_TAG_INVALID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lunm_list</span><span class="p">[</span><span class="n">free_index</span><span class="p">].</span><span class="n">lp_wwn</span> <span class="o">=</span> <span class="o">*</span><span class="n">pwwn</span><span class="p">;</span>
	<span class="n">lunm_list</span><span class="p">[</span><span class="n">free_index</span><span class="p">].</span><span class="n">rp_wwn</span> <span class="o">=</span> <span class="n">rpwwn</span><span class="p">;</span>
	<span class="n">lunm_list</span><span class="p">[</span><span class="n">free_index</span><span class="p">].</span><span class="n">lun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
	<span class="n">lunm_list</span><span class="p">[</span><span class="n">free_index</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BFA_IOIM_LUN_MASK_ACTIVE</span><span class="p">;</span>

	<span class="cm">/* set for all luns in this rp */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LUN_MASK_CFG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lp_wwn</span> <span class="o">==</span> <span class="o">*</span><span class="n">pwwn</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rp_wwn</span> <span class="o">==</span> <span class="n">rpwwn</span><span class="p">))</span>
			<span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ua</span> <span class="o">=</span> <span class="n">BFA_IOIM_LM_UA_SET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bfa_dconf_update</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcpim_lunmask_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vf_id</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="o">*</span><span class="n">pwwn</span><span class="p">,</span>
			 <span class="n">wwn_t</span> <span class="n">rpwwn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_lun</span> <span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lun_mask_s</span>	<span class="o">*</span><span class="n">lunm_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span>	<span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rp_fcs</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="cm">/* in min cfg lunm_list could be NULL but  no commands should run. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_LUNMASK_MINCFG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_FAILED</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_get_lun_mask_status</span><span class="p">(</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="o">*</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rpwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">scsilun_to_int</span><span class="p">((</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lun</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pwwn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">bfa_fcs_lookup_port</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bfa_fcs</span><span class="p">,</span>
				<span class="n">vf_id</span><span class="p">,</span> <span class="o">*</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">pwwn</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">;</span>
			<span class="n">rp_fcs</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_rport_by_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rpwwn</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rp_fcs</span><span class="p">)</span>
				<span class="n">rp</span> <span class="o">=</span> <span class="n">rp_fcs</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">lunm_list</span> <span class="o">=</span> <span class="n">bfa_get_lun_mask_list</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LUN_MASK_CFG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lp_wwn</span> <span class="o">==</span> <span class="o">*</span><span class="n">pwwn</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rp_wwn</span> <span class="o">==</span> <span class="n">rpwwn</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">scsilun_to_int</span><span class="p">((</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lun</span><span class="p">)</span> <span class="o">==</span>
		     <span class="n">scsilun_to_int</span><span class="p">((</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lun</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lp_wwn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rp_wwn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">int_to_scsilun</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lun</span><span class="p">);</span>
			<span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BFA_IOIM_LUN_MASK_INACTIVE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rp_tag</span> <span class="o">!=</span> <span class="n">BFA_RPORT_TAG_INVALID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rp_tag</span> <span class="o">=</span> <span class="n">BFA_RPORT_TAG_INVALID</span><span class="p">;</span>
				<span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lp_tag</span> <span class="o">=</span> <span class="n">BFA_LP_TAG_INVALID</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">bfa_dconf_update</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set for all luns in this rp */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LUN_MASK_CFG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lp_wwn</span> <span class="o">==</span> <span class="o">*</span><span class="n">pwwn</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rp_wwn</span> <span class="o">==</span> <span class="n">rpwwn</span><span class="p">))</span>
			<span class="n">lunm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ua</span> <span class="o">=</span> <span class="n">BFA_IOIM_LM_UA_SET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_ENTRY_NOT_EXISTS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_ioim_failed</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_HCB</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_cb_ioim_done</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">dio</span><span class="p">,</span> <span class="n">BFI_IOIM_STS_ABORTED</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_ioim_pathtov</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">path_tov_expired</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_HCB</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_cb_ioim_done</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">dio</span><span class="p">,</span> <span class="n">BFI_IOIM_STS_PATHTOV</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_ioim_abort</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_HCB</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_cb_ioim_abort</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">dio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_sgpg_alloced</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsgpgs</span> <span class="o">=</span> <span class="n">BFA_SGPG_NPAGE</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsges</span><span class="p">);</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">sgpg_wqe</span><span class="p">.</span><span class="n">sgpg_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">);</span>
	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">sgpg</span> <span class="o">=</span> <span class="n">bfa_q_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_SGALLOCED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send I/O request to firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span>	<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_ioim_send_ioreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_ioim_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">fcp_cmnd_s</span> <span class="n">cmnd_z0</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">}</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">bfi_sge_s</span> <span class="o">*</span><span class="n">sge</span><span class="p">,</span> <span class="o">*</span><span class="n">sgpge</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">pgdlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">fcp_dl</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_sgpg_s</span> <span class="o">*</span><span class="n">sgpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmnd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">dio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">sge_id</span><span class="p">,</span> <span class="n">pgcumsz</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dmadir</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for room in queue to send request now</span>
<span class="cm">	 */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">qwait</span><span class="p">);</span>
		<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * build i/o request message next</span>
<span class="cm">	 */</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">io_tag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">rport_hdl</span> <span class="o">=</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">io_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sges</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">sgpg</span> <span class="o">=</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">sgpg</span><span class="p">;</span>
	<span class="n">sge_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sgpge</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pgcumsz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsges</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* build inline IO SG element */</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">bfa_sgaddr_le</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
			<span class="n">sge</span><span class="o">-&gt;</span><span class="n">sga</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">union</span> <span class="n">bfi_addr_u</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">pgdlen</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">sge</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">pgdlen</span><span class="p">;</span>
			<span class="n">sge</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsges</span> <span class="o">&gt;</span> <span class="n">BFI_SGE_INLINE</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">BFI_SGE_DATA_CPL</span> <span class="o">:</span> <span class="n">BFI_SGE_DATA_LAST</span><span class="p">;</span>
			<span class="n">bfa_sge_to_be</span><span class="p">(</span><span class="n">sge</span><span class="p">);</span>
			<span class="n">sge</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sge_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">sgpge</span> <span class="o">=</span> <span class="n">sgpg</span><span class="o">-&gt;</span><span class="n">sgpg</span><span class="o">-&gt;</span><span class="n">sges</span><span class="p">;</span>

			<span class="n">addr</span> <span class="o">=</span> <span class="n">bfa_sgaddr_le</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
			<span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">sga</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">union</span> <span class="n">bfi_addr_u</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">pgcumsz</span> <span class="o">+=</span> <span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>

			<span class="cm">/* set flags */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsges</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">sge_id</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">BFI_SGPG_DATA_SGES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
				<span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">BFI_SGE_DATA</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsges</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
				<span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">BFI_SGE_DATA_CPL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">BFI_SGE_DATA_LAST</span><span class="p">;</span>

			<span class="n">bfa_sge_to_le</span><span class="p">(</span><span class="n">sgpge</span><span class="p">);</span>

			<span class="n">sgpge</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsges</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">BFI_SGE_PGDLEN</span><span class="p">;</span>
				<span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">sga</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">addr_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">sga</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">addr_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">pgcumsz</span><span class="p">;</span>
				<span class="n">bfa_sge_to_le</span><span class="p">(</span><span class="n">sgpge</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">sge_id</span> <span class="o">==</span> <span class="n">BFI_SGPG_DATA_SGES</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sgpg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_sgpg_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_q_next</span><span class="p">(</span><span class="n">sgpg</span><span class="p">);</span>
				<span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">BFI_SGE_LINK</span><span class="p">;</span>
				<span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">sga</span> <span class="o">=</span> <span class="n">sgpg</span><span class="o">-&gt;</span><span class="n">sgpg_pa</span><span class="p">;</span>
				<span class="n">sgpge</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">pgcumsz</span><span class="p">;</span>
				<span class="n">bfa_sge_to_le</span><span class="p">(</span><span class="n">sgpge</span><span class="p">);</span>
				<span class="n">sge_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pgcumsz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsges</span> <span class="o">&gt;</span> <span class="n">BFI_SGE_INLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sge</span><span class="o">-&gt;</span><span class="n">sga</span> <span class="o">=</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">sgpg</span><span class="o">-&gt;</span><span class="n">sgpg_pa</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sge</span><span class="o">-&gt;</span><span class="n">sga</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">addr_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sge</span><span class="o">-&gt;</span><span class="n">sga</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">addr_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sge</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">pgdlen</span><span class="p">;</span>
	<span class="n">sge</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">BFI_SGE_PGDLEN</span><span class="p">;</span>
	<span class="n">bfa_sge_to_be</span><span class="p">(</span><span class="n">sge</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set up I/O command parameters</span>
<span class="cm">	 */</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">cmnd_z0</span><span class="p">;</span>
	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">.</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">dmadir</span> <span class="o">=</span> <span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmadir</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">.</span><span class="n">iodir</span> <span class="o">=</span> <span class="n">FCP_IODIR_WRITE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmadir</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">.</span><span class="n">iodir</span> <span class="o">=</span> <span class="n">FCP_IODIR_READ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">.</span><span class="n">iodir</span> <span class="o">=</span> <span class="n">FCP_IODIR_NONE</span><span class="p">;</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">.</span><span class="n">cdb</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cdb_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="n">fcp_dl</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmnd</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">.</span><span class="n">fcp_dl</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">fcp_dl</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set up I/O message header</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">.</span><span class="n">iodir</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FCP_IODIR_READ</span>:
		<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_IOIM_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">input_reqs</span><span class="p">);</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rd_throughput</span> <span class="o">+=</span> <span class="n">fcp_dl</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FCP_IODIR_WRITE</span>:
		<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_IOIM_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">output_reqs</span><span class="p">);</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">wr_throughput</span> <span class="o">+=</span> <span class="n">fcp_dl</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FCP_IODIR_RW</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">input_reqs</span><span class="p">);</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">output_reqs</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_IOIM_IO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">seq_rec</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmnd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_IOIM_IO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue I/O message to firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup any additional SG pages needed.Inline SG element is setup</span>
<span class="cm"> * at queuing time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span>
<span class="nf">bfa_ioim_sgpg_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">nsgpgs</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsges</span> <span class="o">&lt;=</span> <span class="n">BFI_SGE_INLINE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate SG pages needed</span>
<span class="cm">	 */</span>
	<span class="n">nsgpgs</span> <span class="o">=</span> <span class="n">BFA_SGPG_NPAGE</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsges</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nsgpgs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_sgpg_malloc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">,</span> <span class="n">nsgpgs</span><span class="p">)</span>
	    <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_sgpg_wait</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">sgpg_wqe</span><span class="p">,</span> <span class="n">nsgpgs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsgpgs</span> <span class="o">=</span> <span class="n">nsgpgs</span><span class="p">;</span>
	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">sgpg</span> <span class="o">=</span> <span class="n">bfa_q_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send I/O abort request to firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span>	<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_ioim_send_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_ioim_abort_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">bfi_ioim_h2i</span>	<span class="n">msgop</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for room in queue to send request now</span>
<span class="cm">	 */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * build i/o request message next</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">abort_explicit</span><span class="p">)</span>
		<span class="n">msgop</span> <span class="o">=</span> <span class="n">BFI_IOIM_H2I_IOABORT_REQ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">msgop</span> <span class="o">=</span> <span class="n">BFI_IOIM_H2I_IOCLEANUP_REQ</span><span class="p">;</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_IOIM</span><span class="p">,</span> <span class="n">msgop</span><span class="p">,</span> <span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">io_tag</span>    <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">abort_tag</span> <span class="o">=</span> <span class="o">++</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">abort_tag</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue I/O message to firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call to resume any I/O requests waiting for room in request queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_qresume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">qresumes</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_QRESUME</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioim_notify_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Move IO from itnim queue to fcpim global queue since itnim will be</span>
<span class="cm">	 * freed.</span>
<span class="cm">	 */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">ioim_comp_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">tskim</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">delay_comp</span> <span class="o">&amp;&amp;</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">iotov_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_cb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">delay_comp_q</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bfa_itnim_iodone</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">bfa_wc_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bfa_boolean_t</span>
<span class="nf">bfa_ioim_is_abortable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_uninit</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">bfa_q_is_on_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">,</span> <span class="n">ioim</span><span class="p">)))</span>	<span class="o">||</span>
	    <span class="p">(</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_abort</span><span class="p">))</span>		<span class="o">||</span>
	    <span class="p">(</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_abort_qfull</span><span class="p">))</span>	<span class="o">||</span>
	    <span class="p">(</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb</span><span class="p">))</span>		<span class="o">||</span>
	    <span class="p">(</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_hcb_free</span><span class="p">))</span>	<span class="o">||</span>
	    <span class="p">(</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_resfree</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_ioim_delayed_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">iotov</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If path tov timer expired, failback with PATHTOV status - these</span>
<span class="cm">	 * IO requests are not normally retried by IO stack.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Otherwise device cameback online and fail it with normal failed</span>
<span class="cm">	 * status so that IO stack retries these failed IO requests.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iotov</span><span class="p">)</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span> <span class="o">=</span> <span class="n">__bfa_cb_ioim_pathtov</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span> <span class="o">=</span> <span class="n">__bfa_cb_ioim_failed</span><span class="p">;</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">iocom_nexus_abort</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">io_cbfn</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Move IO to fcpim global queue since itnim will be</span>
<span class="cm">	 * freed.</span>
<span class="cm">	 */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">ioim_comp_q</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Memory allocation and initialization.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_ioim_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span>		<span class="o">*</span><span class="n">ioim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span>	<span class="o">*</span><span class="n">fcp</span> <span class="o">=</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_sp_s</span>	<span class="o">*</span><span class="n">iosp</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * claim memory first</span>
<span class="cm">	 */</span>
	<span class="n">ioim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">fcp</span><span class="p">);</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">ioim_arr</span> <span class="o">=</span> <span class="n">ioim</span><span class="p">;</span>
	<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">fcp</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ioim</span> <span class="o">+</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span><span class="p">);</span>

	<span class="n">iosp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_sp_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">fcp</span><span class="p">);</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">ioim_sp_arr</span> <span class="o">=</span> <span class="n">iosp</span><span class="p">;</span>
	<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">fcp</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">iosp</span> <span class="o">+</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize ioim free queues</span>
<span class="cm">	 */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">ioim_resfree_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">ioim_comp_q</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ioim</span><span class="o">++</span><span class="p">,</span> <span class="n">iosp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * initialize IOIM</span>
<span class="cm">		 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span><span class="p">));</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span>   <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span>     <span class="o">=</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">;</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">fcpim</span>   <span class="o">=</span> <span class="n">fcpim</span><span class="p">;</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span>    <span class="o">=</span> <span class="n">iosp</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">);</span>
		<span class="n">bfa_reqq_winit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">,</span>
				   <span class="n">bfa_ioim_qresume</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_sgpg_winit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">sgpg_wqe</span><span class="p">,</span>
				   <span class="n">bfa_ioim_sgpg_alloced</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_uninit</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_ioim_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfi_ioim_rsp_s</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_ioim_rsp_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">iotag</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">bfa_ioim_event</span> <span class="n">evt</span> <span class="o">=</span> <span class="n">BFA_IOIM_SM_COMP</span><span class="p">;</span>

	<span class="n">iotag</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">io_tag</span><span class="p">);</span>

	<span class="n">ioim</span> <span class="o">=</span> <span class="n">BFA_IOIM_FROM_TAG</span><span class="p">(</span><span class="n">fcpim</span><span class="p">,</span> <span class="n">iotag</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span> <span class="o">!=</span> <span class="n">iotag</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">io_status</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">reuse_io_tag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">bfa_ioim_sm_active</span><span class="p">))</span>
		<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">comp_rspmsg</span> <span class="o">=</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">io_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFI_IOIM_STS_OK</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">iocomp_ok</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">reuse_io_tag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">evt</span> <span class="o">=</span> <span class="n">BFA_IOIM_SM_DONE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">evt</span> <span class="o">=</span> <span class="n">BFA_IOIM_SM_COMP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_IOIM_STS_TIMEDOUT</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">iocomp_timedout</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BFI_IOIM_STS_ABORTED</span>:
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">io_status</span> <span class="o">=</span> <span class="n">BFI_IOIM_STS_ABORTED</span><span class="p">;</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">iocomp_aborted</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">reuse_io_tag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">evt</span> <span class="o">=</span> <span class="n">BFA_IOIM_SM_DONE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">evt</span> <span class="o">=</span> <span class="n">BFA_IOIM_SM_COMP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_IOIM_STS_PROTO_ERR</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">iocom_proto_err</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">reuse_io_tag</span><span class="p">);</span>
		<span class="n">evt</span> <span class="o">=</span> <span class="n">BFA_IOIM_SM_COMP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_IOIM_STS_SQER_NEEDED</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">iocom_sqer_needed</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">reuse_io_tag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">evt</span> <span class="o">=</span> <span class="n">BFA_IOIM_SM_SQRETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_IOIM_STS_RES_FREE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">iocom_res_free</span><span class="p">);</span>
		<span class="n">evt</span> <span class="o">=</span> <span class="n">BFA_IOIM_SM_FREE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_IOIM_STS_HOST_ABORTED</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">iocom_hostabrts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">abort_tag</span> <span class="o">!=</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">abort_tag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">abort_tag</span><span class="p">);</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">abort_tag</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">reuse_io_tag</span><span class="p">)</span>
			<span class="n">evt</span> <span class="o">=</span> <span class="n">BFA_IOIM_SM_ABORT_COMP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">evt</span> <span class="o">=</span> <span class="n">BFA_IOIM_SM_ABORT_DONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_IOIM_STS_UTAG</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">iocom_utags</span><span class="p">);</span>
		<span class="n">evt</span> <span class="o">=</span> <span class="n">BFA_IOIM_SM_COMP_UTAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">evt</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_ioim_good_comp_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfi_ioim_rsp_s</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_ioim_rsp_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">iotag</span><span class="p">;</span>

	<span class="n">iotag</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">io_tag</span><span class="p">);</span>

	<span class="n">ioim</span> <span class="o">=</span> <span class="n">BFA_IOIM_FROM_TAG</span><span class="p">(</span><span class="n">fcpim</span><span class="p">,</span> <span class="n">iotag</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">BFA_IOIM_TAG_2_ID</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">)</span> <span class="o">!=</span> <span class="n">iotag</span><span class="p">);</span>

	<span class="n">bfa_ioim_cb_profile_comp</span><span class="p">(</span><span class="n">fcpim</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_COMP_GOOD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by itnim to clean up IO while going offline.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_ioim_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">io_cleanups</span><span class="p">);</span>

	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">tskim</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_CLEANUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_ioim_cleanup_tm</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">io_tmaborts</span><span class="p">);</span>

	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iosp</span><span class="o">-&gt;</span><span class="n">tskim</span> <span class="o">=</span> <span class="n">tskim</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_CLEANUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IOC failure handling.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_ioim_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">io_iocdowns</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_HWFAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO offline TOV popped. Fail the pending IO.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_ioim_tov</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_IOTOV</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Allocate IOIM resource for initiator mode I/O request.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span>
<span class="nf">bfa_ioim_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfad_ioim_s</span> <span class="o">*</span><span class="n">dio</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span> <span class="n">u16</span> <span class="n">nsges</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_iotag_s</span> <span class="o">*</span><span class="n">iotag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * alocate IOIM resource</span>
<span class="cm">	 */</span>
	<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">iotag_ioim_free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iotag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iotag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">no_iotags</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioim</span> <span class="o">=</span> <span class="n">BFA_IOIM_FROM_TAG</span><span class="p">(</span><span class="n">fcpim</span><span class="p">,</span> <span class="n">iotag</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">dio</span> <span class="o">=</span> <span class="n">dio</span><span class="p">;</span>
	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">itnim</span><span class="p">;</span>
	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsges</span> <span class="o">=</span> <span class="n">nsges</span><span class="p">;</span>
	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsgpgs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">total_ios</span><span class="p">);</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">ios_active</span><span class="o">++</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">io_q</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ioim</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_ioim_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_iotag_s</span> <span class="o">*</span><span class="n">iotag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsgpgs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bfa_sgpg_mfree</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">nsgpgs</span><span class="p">);</span>

	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">io_comps</span><span class="p">);</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">ios_active</span><span class="o">--</span><span class="p">;</span>

	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span> <span class="o">&amp;=</span> <span class="n">BFA_IOIM_IOTAG_MASK</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span> <span class="o">&lt;</span>
		<span class="p">(</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span> <span class="o">+</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_fwtio_reqs</span><span class="p">)));</span>
	<span class="n">iotag</span> <span class="o">=</span> <span class="n">BFA_IOTAG_FROM_TAG</span><span class="p">(</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span> <span class="o">&lt;</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iotag</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">iotag_ioim_free_q</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iotag</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">iotag_tio_free_q</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_ioim_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioim_cb_profile_start</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="p">,</span> <span class="n">ioim</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Obtain the queue over which this request has to be issued</span>
<span class="cm">	 */</span>
	<span class="n">ioim</span><span class="o">-&gt;</span><span class="n">reqq</span> <span class="o">=</span> <span class="n">bfa_fcpim_ioredirect_enabled</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">BFA_FALSE</span> <span class="o">:</span> <span class="n">bfa_itnim_get_reqq</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_START</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Driver I/O abort request.</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_ioim_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">iotag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_ioim_is_abortable</span><span class="p">(</span><span class="n">ioim</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_FAILED</span><span class="p">;</span>

	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">io_aborts</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">BFA_IOIM_SM_ABORT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  BFA TSKIM state machine functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Task management command beginning state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_tskim_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_START</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_active</span><span class="p">);</span>
		<span class="n">bfa_tskim_gather_ios</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If device is offline, do not send TM on wire. Just cleanup</span>
<span class="cm">		 * any pending IO requests and complete TM request.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_itnim_is_online</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_iocleanup</span><span class="p">);</span>
			<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">tsk_status</span> <span class="o">=</span> <span class="n">BFI_TSKIM_STS_OK</span><span class="p">;</span>
			<span class="n">bfa_tskim_cleanup_ios</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_tskim_send</span><span class="p">(</span><span class="n">tskim</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_qfull</span><span class="p">);</span>
			<span class="n">bfa_stats</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">tm_qwait</span><span class="p">);</span>
			<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TM command is active, awaiting completion from firmware to</span>
<span class="cm"> * cleanup IO requests in TM scope.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_tskim_sm_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_DONE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_iocleanup</span><span class="p">);</span>
		<span class="n">bfa_tskim_cleanup_ios</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_CLEANUP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_cleanup</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_tskim_send_abort</span><span class="p">(</span><span class="n">tskim</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_cleanup_qfull</span><span class="p">);</span>
			<span class="n">bfa_stats</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">tm_qwait</span><span class="p">);</span>
			<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_tskim_iocdisable_ios</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
		<span class="n">bfa_tskim_qcomp</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">__bfa_cb_tskim_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * An active TM is being cleaned up since ITN is offline. Awaiting cleanup</span>
<span class="cm"> * completion event from firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_tskim_sm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_DONE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Ignore and wait for ABORT completion from firmware.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_CLEANUP_DONE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_iocleanup</span><span class="p">);</span>
		<span class="n">bfa_tskim_cleanup_ios</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_tskim_iocdisable_ios</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
		<span class="n">bfa_tskim_qcomp</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">__bfa_cb_tskim_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_tskim_sm_iocleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_IOS_DONE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_tskim_qcomp</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">__bfa_cb_tskim_done</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_CLEANUP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Ignore, TM command completed on wire.</span>
<span class="cm">		 * Notify TM conmpletion on IO cleanup completion.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_tskim_iocdisable_ios</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
		<span class="n">bfa_tskim_qcomp</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">__bfa_cb_tskim_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Task management command is waiting for room in request CQ</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_tskim_sm_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_active</span><span class="p">);</span>
		<span class="n">bfa_tskim_send</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_CLEANUP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * No need to send TM on wire since ITN is offline.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_iocleanup</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_tskim_cleanup_ios</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_tskim_iocdisable_ios</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
		<span class="n">bfa_tskim_qcomp</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">__bfa_cb_tskim_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Task management command is active, awaiting for room in request CQ</span>
<span class="cm"> * to send clean up request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_tskim_sm_cleanup_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_DONE</span>:
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Fall through !!!</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_cleanup</span><span class="p">);</span>
		<span class="n">bfa_tskim_send_abort</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_hcb</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_tskim_iocdisable_ios</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
		<span class="n">bfa_tskim_qcomp</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">__bfa_cb_tskim_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * BFA callback is pending</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_tskim_sm_hcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_tskim_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_HCB</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_tskim_free</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_CLEANUP</span>:
		<span class="n">bfa_tskim_notify_comp</span><span class="p">(</span><span class="n">tskim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_TSKIM_SM_HWFAIL</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_tskim_done</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">BFA_TSKIM_SM_HCB</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">tm_success</span><span class="p">);</span>
	<span class="n">bfa_cb_tskim_done</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">tskim</span><span class="o">-&gt;</span><span class="n">dtsk</span><span class="p">,</span> <span class="n">tskim</span><span class="o">-&gt;</span><span class="n">tsk_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_tskim_failed</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">BFA_TSKIM_SM_HCB</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">tm_failures</span><span class="p">);</span>
	<span class="n">bfa_cb_tskim_done</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">tskim</span><span class="o">-&gt;</span><span class="n">dtsk</span><span class="p">,</span>
				<span class="n">BFI_TSKIM_STS_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bfa_boolean_t</span>
<span class="nf">bfa_tskim_match_scope</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_lun</span> <span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">tm_cmnd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FCP_TM_TARGET_RESET</span>:
		<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FCP_TM_ABORT_TASK_SET</span>:
	<span class="k">case</span> <span class="n">FCP_TM_CLEAR_TASK_SET</span>:
	<span class="k">case</span> <span class="n">FCP_TM_LUN_RESET</span>:
	<span class="k">case</span> <span class="n">FCP_TM_CLEAR_ACA</span>:
		<span class="k">return</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lun</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lun</span><span class="p">));</span>

	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Gather affected IO requests and task management commands.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_tskim_gather_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_lun</span> <span class="n">scsilun</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">io_q</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Gather any active IO requests first.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">io_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">cmnd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">dio</span><span class="p">;</span>
		<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scsilun</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_tskim_match_scope</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">scsilun</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">io_q</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Failback any pending IO requests immediately.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">cmnd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioim</span><span class="o">-&gt;</span><span class="n">dio</span><span class="p">;</span>
		<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scsilun</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_tskim_match_scope</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">scsilun</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">ioim_comp_q</span><span class="p">);</span>
			<span class="n">bfa_ioim_tov</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IO cleanup completion</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_tskim_cleanp_comp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">tskim_cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span> <span class="o">=</span> <span class="n">tskim_cbarg</span><span class="p">;</span>

	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">tm_io_comps</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">BFA_TSKIM_SM_IOS_DONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Gather affected IO requests and task management commands.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_tskim_cleanup_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="n">bfa_wc_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">,</span> <span class="n">bfa_tskim_cleanp_comp</span><span class="p">,</span> <span class="n">tskim</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">io_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_wc_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">);</span>
		<span class="n">bfa_ioim_cleanup_tm</span><span class="p">(</span><span class="n">ioim</span><span class="p">,</span> <span class="n">tskim</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_wc_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send task management request to firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span>
<span class="nf">bfa_tskim_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_tskim_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for room in queue to send request now</span>
<span class="cm">	 */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * build i/o request message next</span>
<span class="cm">	 */</span>
	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_TSKIM</span><span class="p">,</span> <span class="n">BFI_TSKIM_H2I_TM_REQ</span><span class="p">,</span>
			<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tsk_tag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">tsk_tag</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">itn_fhdl</span> <span class="o">=</span> <span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">t_secs</span> <span class="o">=</span> <span class="n">tskim</span><span class="o">-&gt;</span><span class="n">tsecs</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">tskim</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tm_flags</span> <span class="o">=</span> <span class="n">tskim</span><span class="o">-&gt;</span><span class="n">tm_cmnd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue I/O message to firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send abort request to cleanup an active TM to firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span>
<span class="nf">bfa_tskim_send_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_itnim_s</span>	<span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_tskim_abortreq_s</span>	<span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for room in queue to send request now</span>
<span class="cm">	 */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * build i/o request message next</span>
<span class="cm">	 */</span>
	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_TSKIM</span><span class="p">,</span> <span class="n">BFI_TSKIM_H2I_ABORT_REQ</span><span class="p">,</span>
			<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tsk_tag</span>  <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">tsk_tag</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue I/O message to firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call to resume task management cmnd waiting for room in request queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_tskim_qresume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">tm_qresumes</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">BFA_TSKIM_SM_QRESUME</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cleanup IOs associated with a task mangement command on IOC failures.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_tskim_iocdisable_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="n">ioim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">io_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_ioim_iocdisable</span><span class="p">(</span><span class="n">ioim</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Notification on completions from related ioim.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_tskim_iodone</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_wc_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle IOC h/w failure notification from itnim.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_tskim_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">notify</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">tm_iocdowns</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">BFA_TSKIM_SM_HWFAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cleanup TM command and associated IOs as part of ITNIM offline.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_tskim_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">notify</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">tm_cleanups</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">BFA_TSKIM_SM_CLEANUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Memory allocation and initialization.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_tskim_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span>	<span class="o">*</span><span class="n">fcp</span> <span class="o">=</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">fcp</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">tskim_free_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">tskim_unused_q</span><span class="p">);</span>

	<span class="n">tskim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">fcp</span><span class="p">);</span>
	<span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">tskim_arr</span> <span class="o">=</span> <span class="n">tskim</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">num_tskim_reqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">tskim</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * initialize TSKIM</span>
<span class="cm">		 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span><span class="p">));</span>
		<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">tsk_tag</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">bfa</span>	<span class="o">=</span> <span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">;</span>
		<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">fcpim</span>	<span class="o">=</span> <span class="n">fcpim</span><span class="p">;</span>
		<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">notify</span>  <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="n">bfa_reqq_winit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">,</span> <span class="n">bfa_tskim_qresume</span><span class="p">,</span>
					<span class="n">tskim</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">bfa_tskim_sm_uninit</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">tskim_free_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">fcp</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tskim</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_tskim_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfi_tskim_rsp_s</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_tskim_rsp_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">tsk_tag</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">tsk_tag</span><span class="p">);</span>

	<span class="n">tskim</span> <span class="o">=</span> <span class="n">BFA_TSKIM_FROM_TAG</span><span class="p">(</span><span class="n">fcpim</span><span class="p">,</span> <span class="n">tsk_tag</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">tsk_tag</span> <span class="o">!=</span> <span class="n">tsk_tag</span><span class="p">);</span>

	<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">tsk_status</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">tsk_status</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Firmware sends BFI_TSKIM_STS_ABORTED status for abort</span>
<span class="cm">	 * requests. All other statuses are for normal completions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">tsk_status</span> <span class="o">==</span> <span class="n">BFI_TSKIM_STS_ABORTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">tm_cleanup_comps</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">BFA_TSKIM_SM_CLEANUP_DONE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">tm_fw_rsps</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">BFA_TSKIM_SM_DONE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span>
<span class="nf">bfa_tskim_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfad_tskim_s</span> <span class="o">*</span><span class="n">dtsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span> <span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">;</span>

	<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">tskim_free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tskim</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tskim</span><span class="p">)</span>
		<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">dtsk</span> <span class="o">=</span> <span class="n">dtsk</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tskim</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_tskim_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bfa_q_is_on_q_func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">tsk_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">));</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">tskim_free_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start a task management command.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	tskim	BFA task management command instance</span>
<span class="cm"> * @param[in]	itnim	i-t nexus for the task management command</span>
<span class="cm"> * @param[in]	lun	lun, if applicable</span>
<span class="cm"> * @param[in]	tm_cmnd	Task management command code.</span>
<span class="cm"> * @param[in]	t_secs	Timeout in seconds</span>
<span class="cm"> *</span>
<span class="cm"> * @return None.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_tskim_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_tskim_s</span> <span class="o">*</span><span class="n">tskim</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_itnim_s</span> <span class="o">*</span><span class="n">itnim</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">scsi_lun</span> <span class="n">lun</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">fcp_tm_cmnd</span> <span class="n">tm_cmnd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tsecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">itnim</span>	<span class="o">=</span> <span class="n">itnim</span><span class="p">;</span>
	<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">lun</span>	<span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
	<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">tm_cmnd</span> <span class="o">=</span> <span class="n">tm_cmnd</span><span class="p">;</span>
	<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">tsecs</span>	<span class="o">=</span> <span class="n">tsecs</span><span class="p">;</span>
	<span class="n">tskim</span><span class="o">-&gt;</span><span class="n">notify</span>  <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">itnim</span><span class="p">,</span> <span class="n">tm_cmnds</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tskim</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">tsk_q</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">tskim</span><span class="p">,</span> <span class="n">BFA_TSKIM_SM_START</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_tskim_res_recfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u16</span> <span class="n">num_tskim_fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcpim_s</span>	<span class="o">*</span><span class="n">fcpim</span> <span class="o">=</span> <span class="n">BFA_FCPIM</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">num_tskim_reqs</span> <span class="o">-</span> <span class="n">num_tskim_fw</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_q_deq_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">tskim_free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcpim</span><span class="o">-&gt;</span><span class="n">tskim_unused_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* BFA FCP module - parent module for fcpim */</span>

<span class="n">BFA_MODULE</span><span class="p">(</span><span class="n">fcp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcp_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_meminfo_s</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span> <span class="o">*</span><span class="n">fcp</span> <span class="o">=</span> <span class="n">BFA_FCP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_kva_s</span> <span class="o">*</span><span class="n">fcp_kva</span> <span class="o">=</span> <span class="n">BFA_MEM_FCP_KVA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">seg_ptr</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">nsegs</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">per_seg_ios</span><span class="p">,</span> <span class="n">num_io_req</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">km_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ZERO for num_ioim_reqs and num_fwtio_reqs is allowed config value.</span>
<span class="cm">	 * So if the values are non zero, adjust them appropriately.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">&lt;</span> <span class="n">BFA_IOIM_MIN</span><span class="p">)</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">=</span> <span class="n">BFA_IOIM_MIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">&gt;</span> <span class="n">BFA_IOIM_MAX</span><span class="p">)</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">=</span> <span class="n">BFA_IOIM_MAX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span> <span class="o">&gt;</span> <span class="n">BFA_FWTIO_MAX</span><span class="p">)</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span> <span class="o">=</span> <span class="n">BFA_FWTIO_MAX</span><span class="p">;</span>

	<span class="n">num_io_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_io_req</span> <span class="o">&gt;</span> <span class="n">BFA_IO_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">&amp;&amp;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">=</span> <span class="n">BFA_IO_MAX</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span> <span class="o">=</span> <span class="n">BFA_IO_MAX</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span><span class="p">)</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span> <span class="o">=</span> <span class="n">BFA_FWTIO_MAX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">=</span> <span class="n">BFA_IOIM_MAX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_fcpim_meminfo</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">km_len</span><span class="p">);</span>

	<span class="n">num_io_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span><span class="p">);</span>
	<span class="n">km_len</span> <span class="o">+=</span> <span class="n">num_io_req</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iotag_s</span><span class="p">);</span>
	<span class="n">km_len</span> <span class="o">+=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_rports</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itn_s</span><span class="p">);</span>

	<span class="cm">/* dma memory */</span>
	<span class="n">nsegs</span> <span class="o">=</span> <span class="n">BFI_MEM_DMA_NSEGS</span><span class="p">(</span><span class="n">num_io_req</span><span class="p">,</span> <span class="n">BFI_IOIM_SNSLEN</span><span class="p">);</span>
	<span class="n">per_seg_ios</span> <span class="o">=</span> <span class="n">BFI_MEM_NREQS_SEG</span><span class="p">(</span><span class="n">BFI_IOIM_SNSLEN</span><span class="p">);</span>

	<span class="n">bfa_mem_dma_seg_iter</span><span class="p">(</span><span class="n">fcp</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span> <span class="n">nsegs</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_io_req</span> <span class="o">&gt;=</span> <span class="n">per_seg_ios</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">num_io_req</span> <span class="o">-=</span> <span class="n">per_seg_ios</span><span class="p">;</span>
			<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span>
				<span class="n">per_seg_ios</span> <span class="o">*</span> <span class="n">BFI_IOIM_SNSLEN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span>
				<span class="n">num_io_req</span> <span class="o">*</span> <span class="n">BFI_IOIM_SNSLEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* kva memory */</span>
	<span class="n">bfa_mem_kva_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">fcp_kva</span><span class="p">,</span> <span class="n">km_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcp_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span> <span class="o">*</span><span class="n">fcp</span> <span class="o">=</span> <span class="n">BFA_FCP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">seg_ptr</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">idx</span><span class="p">,</span> <span class="n">nsegs</span><span class="p">,</span> <span class="n">num_io_req</span><span class="p">;</span>

	<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span><span class="p">;</span>
	<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_fwtio_reqs</span>  <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span><span class="p">;</span>
	<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_itns</span>   <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_rports</span><span class="p">;</span>
	<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup the pool of snsbase addr&#39;s, that is passed to fw as</span>
<span class="cm">	 * part of bfi_iocfc_cfg_s.</span>
<span class="cm">	 */</span>
	<span class="n">num_io_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span><span class="p">);</span>
	<span class="n">nsegs</span> <span class="o">=</span> <span class="n">BFI_MEM_DMA_NSEGS</span><span class="p">(</span><span class="n">num_io_req</span><span class="p">,</span> <span class="n">BFI_IOIM_SNSLEN</span><span class="p">);</span>

	<span class="n">bfa_mem_dma_seg_iter</span><span class="p">(</span><span class="n">fcp</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span> <span class="n">nsegs</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_mem_dma_virt</span><span class="p">(</span><span class="n">seg_ptr</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">snsbase</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">pa</span> <span class="o">=</span> <span class="n">bfa_mem_dma_phys</span><span class="p">(</span><span class="n">seg_ptr</span><span class="p">);</span>
		<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">snsbase</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">kva</span> <span class="o">=</span> <span class="n">bfa_mem_dma_virt</span><span class="p">(</span><span class="n">seg_ptr</span><span class="p">);</span>
		<span class="n">bfa_iocfc_set_snsbase</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fcp</span><span class="o">-&gt;</span><span class="n">snsbase</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">pa</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_fcpim_attach</span><span class="p">(</span><span class="n">fcp</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">pcidev</span><span class="p">);</span>

	<span class="n">bfa_iotag_attach</span><span class="p">(</span><span class="n">fcp</span><span class="p">);</span>

	<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">itn_arr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itn_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">fcp</span><span class="p">);</span>
	<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">fcp</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">itn_arr</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_itns</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itn_s</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">itn_arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_itns</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_itn_s</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcp_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcp_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span> <span class="o">*</span><span class="n">fcp</span> <span class="o">=</span> <span class="n">BFA_FCP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * bfa_init() with flash read is complete. now invalidate the stale</span>
<span class="cm">	 * content of lun mask like unit attention, rp tag and lp tag.</span>
<span class="cm">	 */</span>
	<span class="n">bfa_ioim_lm_init</span><span class="p">(</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcp_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcp_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span> <span class="o">*</span><span class="n">fcp</span> <span class="o">=</span> <span class="n">BFA_FCP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="cm">/* Enqueue unused ioim resources to free_q */</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">iotag_unused_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">iotag_ioim_free_q</span><span class="p">);</span>

	<span class="n">bfa_fcpim_iocdisable</span><span class="p">(</span><span class="n">fcp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcp_res_recfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u16</span> <span class="n">num_ioim_fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_FCP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span> <span class="o">-</span> <span class="n">num_ioim_fw</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_q_deq_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">iotag_ioim_free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">iotag_unused_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_itn_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">isr</span><span class="p">)(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">m</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span> <span class="o">*</span><span class="n">fcp</span> <span class="o">=</span> <span class="n">BFA_FCP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_itn_s</span> <span class="o">*</span><span class="n">itn</span><span class="p">;</span>

	<span class="n">itn</span> <span class="o">=</span>  <span class="n">BFA_ITN_FROM_TAG</span><span class="p">(</span><span class="n">fcp</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">itn</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">=</span> <span class="n">isr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Itn interrupt processing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_itn_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span> <span class="o">*</span><span class="n">fcp</span> <span class="o">=</span> <span class="n">BFA_FCP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">bfi_itn_i2h_msg_u</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_itn_s</span> <span class="o">*</span><span class="n">itn</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">itn</span> <span class="o">=</span>  <span class="n">BFA_ITN_FROM_TAG</span><span class="p">(</span><span class="n">fcp</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">create_rsp</span><span class="o">-&gt;</span><span class="n">bfa_handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itn</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">)</span>
		<span class="n">itn</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_iotag_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcp_mod_s</span> <span class="o">*</span><span class="n">fcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_iotag_s</span> <span class="o">*</span><span class="n">iotag</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">num_io_req</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">iotag</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iotag_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">fcp</span><span class="p">);</span>
	<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">iotag_arr</span> <span class="o">=</span> <span class="n">iotag</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">iotag_ioim_free_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">iotag_tio_free_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">iotag_unused_q</span><span class="p">);</span>

	<span class="n">num_io_req</span> <span class="o">=</span> <span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span> <span class="o">+</span> <span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_fwtio_reqs</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_io_req</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">iotag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">iotag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iotag_s</span><span class="p">));</span>
		<span class="n">iotag</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">fcp</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span><span class="p">)</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iotag</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">iotag_ioim_free_q</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iotag</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcp</span><span class="o">-&gt;</span><span class="n">iotag_tio_free_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">fcp</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">iotag</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
