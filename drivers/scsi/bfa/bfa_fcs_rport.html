<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › bfa › bfa_fcs_rport.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bfa_fcs_rport.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2010 Brocade Communications Systems, Inc.</span>
<span class="cm"> * All rights reserved</span>
<span class="cm"> * www.brocade.com</span>
<span class="cm"> *</span>
<span class="cm"> * Linux driver for Brocade Fibre Channel Host Bus Adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License (GPL) Version 2 as</span>
<span class="cm"> * published by the Free Software Foundation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  rport.c Remote port implementation.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;bfad_drv.h&quot;</span>
<span class="cp">#include &quot;bfad_im.h&quot;</span>
<span class="cp">#include &quot;bfa_fcs.h&quot;</span>
<span class="cp">#include &quot;bfa_fcbuild.h&quot;</span>

<span class="n">BFA_TRC_FILE</span><span class="p">(</span><span class="n">FCS</span><span class="p">,</span> <span class="n">RPORT</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="n">bfa_fcs_rport_del_timeout</span> <span class="o">=</span> <span class="n">BFA_FCS_RPORT_DEF_DEL_TIMEOUT</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	 <span class="cm">/* In millisecs */</span>
<span class="cm">/*</span>
<span class="cm"> * forward declarations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">bfa_fcs_rport_alloc</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">pwwn</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rpid</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_hal_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_online_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fc_logi_s</span> <span class="o">*</span><span class="n">plogi</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_send_plogi</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_send_plogiacc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_plogi_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
				<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_send_adisc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_adisc_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
				<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_gidpn_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
				<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_gpnid_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
				<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_send_logo</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_send_logo_acc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_process_prli</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_send_ls_rjt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason_code</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="n">reason_code_expl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_process_adisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_fcs_rport_send_prlo_acc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_plogi_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_plogiacc_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						  <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_plogi_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_plogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_hal_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_nsquery_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						 <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_nsquery</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_adisc_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_adisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_fc4_logorcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_fc4_logosend</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_fc4_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_hcb_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_hcb_logorcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_hcb_logosend</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_logo_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_nsdisc_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_nsdisc_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rport_sm_nsdisc_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_sm_table_s</span> <span class="n">rport_sm_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">),</span> <span class="n">BFA_RPORT_UNINIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_plogi_sending</span><span class="p">),</span> <span class="n">BFA_RPORT_PLOGI</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_plogiacc_sending</span><span class="p">),</span> <span class="n">BFA_RPORT_ONLINE</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_plogi_retry</span><span class="p">),</span> <span class="n">BFA_RPORT_PLOGI_RETRY</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_plogi</span><span class="p">),</span> <span class="n">BFA_RPORT_PLOGI</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_hal_online</span><span class="p">),</span> <span class="n">BFA_RPORT_ONLINE</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_online</span><span class="p">),</span> <span class="n">BFA_RPORT_ONLINE</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_nsquery_sending</span><span class="p">),</span> <span class="n">BFA_RPORT_NSQUERY</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_nsquery</span><span class="p">),</span> <span class="n">BFA_RPORT_NSQUERY</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_adisc_sending</span><span class="p">),</span> <span class="n">BFA_RPORT_ADISC</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_adisc</span><span class="p">),</span> <span class="n">BFA_RPORT_ADISC</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_fc4_logorcv</span><span class="p">),</span> <span class="n">BFA_RPORT_LOGORCV</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_fc4_logosend</span><span class="p">),</span> <span class="n">BFA_RPORT_LOGO</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_fc4_offline</span><span class="p">),</span> <span class="n">BFA_RPORT_OFFLINE</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_hcb_offline</span><span class="p">),</span> <span class="n">BFA_RPORT_OFFLINE</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_hcb_logorcv</span><span class="p">),</span> <span class="n">BFA_RPORT_LOGORCV</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_hcb_logosend</span><span class="p">),</span> <span class="n">BFA_RPORT_LOGO</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_logo_sending</span><span class="p">),</span> <span class="n">BFA_RPORT_LOGO</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_offline</span><span class="p">),</span> <span class="n">BFA_RPORT_OFFLINE</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">),</span> <span class="n">BFA_RPORT_NSDISC</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_nsdisc_retry</span><span class="p">),</span> <span class="n">BFA_RPORT_NSDISC</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_rport_sm_nsdisc_sent</span><span class="p">),</span> <span class="n">BFA_RPORT_NSDISC</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		Beginning state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_SEND</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogi_sending</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">plogi_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_rport_send_plogi</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogiacc_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_plogiacc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hal_online</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_hal_online</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_DISC</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		PLOGI is being sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_plogi_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
	 <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_FCXP_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogiacc_sending</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_plogiacc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
		<span class="cm">/* query the NS */</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_del_timeout</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		PLOGI is being sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_plogiacc_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
	 <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_FCXP_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hal_online</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_hal_online</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Ignore, SCN is possibly online notification.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_del_timeout</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_HCB_OFFLINE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Ignore BFA callback, on a PLOGI receive we call bfa offline.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		PLOGI is sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_plogi_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_TIMEOUT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogi_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_plogi</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogiacc_sending</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_plogiacc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_del_timeout</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hal_online</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_hal_online</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		PLOGI is sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_plogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_ACCEPTED</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hal_online</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">plogi_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_rport_hal_online</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
		<span class="n">bfa_fcs_rport_send_logo_acc</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * !! fall through !!</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">prlo</span> <span class="o">==</span> <span class="n">BFA_TRUE</span><span class="p">)</span>
			<span class="n">bfa_fcs_rport_send_prlo_acc</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>

		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * !! fall through !!</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_FAILED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">plogi_retries</span> <span class="o">&lt;</span> <span class="n">BFA_FCS_RPORT_MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">plogi_retries</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogi_retry</span><span class="p">);</span>
			<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
					<span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">rport_del_max_plogi_retry</span><span class="p">);</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_offline</span><span class="p">);</span>
			<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_del_timeout</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span>	<span class="n">RPSM_EVENT_PLOGI_RETRY</span>:
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">plogi_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogi_retry</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
				<span class="p">(</span><span class="n">FC_RA_TOV</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_del_timeout</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogiacc_sending</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_plogiacc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hal_online</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_hal_online</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		PLOGI is complete. Awaiting BFA rport online callback. FC-4s</span>
<span class="cm"> *		are offline.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_hal_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_HCB_ONLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_online</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_online_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hcb_logorcv</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_OFFLINE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hcb_offline</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_OFFLINE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">plogi_pending</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hcb_offline</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_OFFLINE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hcb_logosend</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_OFFLINE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * @todo</span>
<span class="cm">		 * Ignore SCN - PLOGI just completed, FC-4 login should detect</span>
<span class="cm">		 * device failures.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		Rport is ONLINE. FC-4s active.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_fabric_is_switched</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span>
					 <span class="n">bfa_fcs_rport_sm_nsquery_sending</span><span class="p">);</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_adisc_sending</span><span class="p">);</span>
			<span class="n">bfa_fcs_rport_send_adisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_offline</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_logosend</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_logorcv</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		An SCN event is received in ONLINE state. NS query is being sent</span>
<span class="cm"> *		prior to ADISC authentication with rport. FC-4s are paused.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_nsquery_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
	 <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_FCXP_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_nsquery</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_logosend</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * ignore SCN, wait for response to query itself</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_logorcv</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_del_timeout</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	An SCN event is received in ONLINE state. NS query is sent to rport.</span>
<span class="cm"> *	FC-4s are paused.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_nsquery</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_ACCEPTED</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_adisc_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_adisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_FAILED</span>:
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">&lt;</span> <span class="n">BFA_FCS_RPORT_MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span>
					 <span class="n">bfa_fcs_rport_sm_nsquery_sending</span><span class="p">);</span>
			<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_offline</span><span class="p">);</span>
			<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_logosend</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_logorcv</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	An SCN event is received in ONLINE state. ADISC is being sent for</span>
<span class="cm"> *	authenticating with rport. FC-4s are paused.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_adisc_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
	 <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_FCXP_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_adisc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_logosend</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_logorcv</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		An SCN event is received in ONLINE state. ADISC is to rport.</span>
<span class="cm"> *		FC-4s are paused.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_adisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_ACCEPTED</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_online</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Too complex to cleanup FC-4 &amp; rport and then acc to PLOGI.</span>
<span class="cm">		 * At least go offline when a PLOGI is received.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * !!! fall through !!!</span>
<span class="cm">		 */</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_FAILED</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_offline</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_logosend</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * already processing RSCN</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_logorcv</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		Rport has sent LOGO. Awaiting FC-4 offline completion callback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_fc4_logorcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_FC4_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hcb_logorcv</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_OFFLINE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_logosend</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		LOGO needs to be sent to rport. Awaiting FC-4 offline completion</span>
<span class="cm"> *		callback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_fc4_logosend</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
	 <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_FC4_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hcb_logosend</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_OFFLINE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Rport is going offline. Awaiting FC-4 offline completion callback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_fc4_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_FC4_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hcb_offline</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_OFFLINE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * rport is already going offline.</span>
<span class="cm">		 * SCN - ignore and wait till transitioning to offline state</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_fc4_logosend</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		Rport is offline. FC-4s are offline. Awaiting BFA rport offline</span>
<span class="cm"> *		callback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_hcb_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_HCB_OFFLINE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_lport_is_online</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">plogi_pending</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">plogi_pending</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_sm_plogiacc_sending</span><span class="p">);</span>
			<span class="n">bfa_fcs_rport_send_plogiacc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * !! fall through !!</span>
<span class="cm">		 */</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_lport_is_online</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_fabric_is_switched</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">);</span>
				<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_sm_plogi_sending</span><span class="p">);</span>
				<span class="n">rport</span><span class="o">-&gt;</span><span class="n">plogi_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">bfa_fcs_rport_send_plogi</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_offline</span><span class="p">);</span>
			<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_del_timeout</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Ignore, already offline.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		Rport is offline. FC-4s are offline. Awaiting BFA rport offline</span>
<span class="cm"> *		callback to send LOGO accept.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_hcb_logorcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_HCB_OFFLINE</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">prlo</span> <span class="o">==</span> <span class="n">BFA_TRUE</span><span class="p">))</span>
			<span class="n">bfa_fcs_rport_send_prlo_acc</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">prlo</span> <span class="o">==</span> <span class="n">BFA_FALSE</span><span class="p">))</span>
			<span class="n">bfa_fcs_rport_send_logo_acc</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the lport is online and if the rport is not a well</span>
<span class="cm">		 * known address port,</span>
<span class="cm">		 * we try to re-discover the r-port.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_lport_is_online</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">!</span><span class="n">BFA_FCS_PID_IS_WKA</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_fabric_is_switched</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">);</span>
				<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* For N2N  Direct Attach, try to re-login */</span>
				<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_sm_plogi_sending</span><span class="p">);</span>
				<span class="n">rport</span><span class="o">-&gt;</span><span class="n">plogi_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">bfa_fcs_rport_send_plogi</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * if it is not a well known address, reset the</span>
<span class="cm">			 * pid to 0.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BFA_FCS_PID_IS_WKA</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">))</span>
				<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_offline</span><span class="p">);</span>
			<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_del_timeout</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hcb_logosend</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hcb_offline</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Ignore - already processing a LOGO.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		Rport is being deleted. FC-4s are offline.</span>
<span class="cm"> *  Awaiting BFA rport offline</span>
<span class="cm"> *		callback to send LOGO.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_hcb_logosend</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
		 <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_HCB_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_logo_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_logo</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		Rport is being deleted. FC-4s are offline. LOGO is being sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_logo_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
	 <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_FCXP_SENT</span>:
		<span class="cm">/* Once LOGO is sent, we donot wait for the response */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		Rport is offline. FC-4s are offline. BFA rport is offline.</span>
<span class="cm"> *		Timer active to delete stale rport.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_TIMEOUT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogiacc_sending</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_plogiacc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hal_online</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_hal_online</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_SEND</span>:
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogi_sending</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">plogi_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_rport_send_plogi</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Rport address has changed. Nameserver discovery request is being sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
	 <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_FCXP_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_nsdisc_sent</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogiacc_sending</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_plogiacc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_SEND</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* reset the retry count */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_del_timeout</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hal_online</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_hal_online</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		Nameserver discovery failed. Waiting for timeout to retry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_nsdisc_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
	 <span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_TIMEOUT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogiacc_sending</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_plogiacc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_del_timeout</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
		<span class="n">bfa_fcs_rport_send_logo_acc</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
		<span class="n">bfa_fcs_rport_send_prlo_acc</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hal_online</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_hal_online</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		Rport address has changed. Nameserver discovery request is sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_sm_nsdisc_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_ACCEPTED</span>:
	<span class="k">case</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogi_sending</span><span class="p">);</span>
			<span class="n">bfa_fcs_rport_send_plogi</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span>
				 <span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">);</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_FAILED</span>:
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">ns_retries</span> <span class="o">&lt;</span> <span class="n">BFA_FCS_RPORT_MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span>
				 <span class="n">bfa_fcs_rport_sm_nsdisc_sending</span><span class="p">);</span>
			<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_offline</span><span class="p">);</span>
			<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_del_timeout</span><span class="p">);</span>
		<span class="p">};</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_free</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_plogiacc_sending</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_plogiacc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_IMP</span>:
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_timeout</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span>
				<span class="n">bfa_fcs_rport_del_timeout</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="k">case</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span>:
		<span class="n">bfa_fcs_rport_send_prlo_acc</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPSM_EVENT_SCN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * ignore, wait for NS query response</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Not logged-in yet. Accept LOGO.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_fcs_rport_send_logo_acc</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_hal_online</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_hal_online</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  fcs_rport_private FCS RPORT provate functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_send_plogi</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rport_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_send_plogi</span><span class="p">,</span> <span class="n">rport</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_plogi_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				<span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">nwwn</span><span class="p">,</span>
				<span class="n">bfa_fcport_get_maxfrsize</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">),</span>
				<span class="n">bfa_fcport_get_rx_bbcredit</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			<span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcs_rport_plogi_response</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rport</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_ELS_TOV</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogis</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FCXP_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_plogi_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
				<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_logi_s</span>	<span class="o">*</span><span class="n">plogi_rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_ls_rjt_s</span>	<span class="o">*</span><span class="n">ls_rjt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">twin</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_failed</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FAILED</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">plogi_rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_logi_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for failure first.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plogi_rsp</span><span class="o">-&gt;</span><span class="n">els_cmd</span><span class="p">.</span><span class="n">els_code</span> <span class="o">!=</span> <span class="n">FC_ELS_ACC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ls_rjt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_ls_rjt_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>

		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code_expl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code</span> <span class="o">==</span> <span class="n">FC_LS_RJT_RSN_UNABLE_TO_PERF_CMD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code_expl</span> <span class="o">==</span> <span class="n">FC_LS_RJT_EXP_INSUFF_RES</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rjt_insuff_res</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_PLOGI_RETRY</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_rejects</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FAILED</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * PLOGI is complete. Make sure this device is not one of the known</span>
<span class="cm">	 * device with a new FC port address.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">twin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twin</span> <span class="o">==</span> <span class="n">rport</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plogi_rsp</span><span class="o">-&gt;</span><span class="n">port_name</span> <span class="o">==</span> <span class="n">twin</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">twin</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

			<span class="cm">/* Update plogi stats in twin */</span>
			<span class="n">twin</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogis</span>  <span class="o">+=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogis</span><span class="p">;</span>
			<span class="n">twin</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_rejects</span>  <span class="o">+=</span>
				 <span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_rejects</span><span class="p">;</span>
			<span class="n">twin</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_timeouts</span>  <span class="o">+=</span>
				 <span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_timeouts</span><span class="p">;</span>
			<span class="n">twin</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_failed</span> <span class="o">+=</span>
				 <span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_failed</span><span class="p">;</span>
			<span class="n">twin</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_rcvd</span>	  <span class="o">+=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_rcvd</span><span class="p">;</span>
			<span class="n">twin</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_accs</span><span class="o">++</span><span class="p">;</span>

			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_DELETE</span><span class="p">);</span>

			<span class="n">bfa_fcs_rport_update</span><span class="p">(</span><span class="n">twin</span><span class="p">,</span> <span class="n">plogi_rsp</span><span class="p">);</span>
			<span class="n">twin</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">rsp_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">;</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">twin</span><span class="p">,</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Normal login path -- no evil twins.</span>
<span class="cm">	 */</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_accs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_fcs_rport_update</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">plogi_rsp</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_ACCEPTED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_send_plogiacc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rport_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>		<span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">reply_oxid</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_send_plogiacc</span><span class="p">,</span> <span class="n">rport</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_plogi_acc_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
				 <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				 <span class="n">rport</span><span class="o">-&gt;</span><span class="n">reply_oxid</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">,</span>
				 <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">nwwn</span><span class="p">,</span>
				 <span class="n">bfa_fcport_get_maxfrsize</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">),</span>
				 <span class="n">bfa_fcport_get_rx_bbcredit</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			<span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FCXP_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_send_adisc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rport_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>		<span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_send_adisc</span><span class="p">,</span> <span class="n">rport</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_adisc_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				<span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">nwwn</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			<span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcs_rport_adisc_response</span><span class="p">,</span>
			<span class="n">rport</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_ELS_TOV</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">adisc_sent</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FCXP_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_adisc_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
				<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">pld</span> <span class="o">=</span> <span class="n">bfa_fcxp_get_rspbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_ls_rjt_s</span>	<span class="o">*</span><span class="n">ls_rjt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">adisc_failed</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FAILED</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fc_adisc_rsp_parse</span><span class="p">((</span><span class="k">struct</span> <span class="n">fc_adisc_s</span> <span class="o">*</span><span class="p">)</span><span class="n">pld</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">,</span>
				<span class="n">rport</span><span class="o">-&gt;</span><span class="n">nwwn</span><span class="p">)</span>  <span class="o">==</span> <span class="n">FC_PARSE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">adisc_accs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_ACCEPTED</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">adisc_rejects</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ls_rjt</span> <span class="o">=</span> <span class="n">pld</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">els_cmd</span><span class="p">.</span><span class="n">els_code</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code_expl</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_send_nsdisc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rport_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>
	<span class="n">bfa_cb_fcxp_send_t</span> <span class="n">cbfn</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_send_nsdisc</span><span class="p">,</span> <span class="n">rport</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">fc_gidpn_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
				<span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="n">cbfn</span> <span class="o">=</span> <span class="n">bfa_fcs_rport_gidpn_response</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">fc_gpnid_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
				<span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="n">cbfn</span> <span class="o">=</span> <span class="n">bfa_fcs_rport_gpnid_response</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			<span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">cbfn</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rport</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_FCCT_TOV</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FCXP_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_gidpn_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
				<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span>	<span class="o">*</span><span class="n">cthdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcgs_gidpn_resp_s</span>	<span class="o">*</span><span class="n">gidpn_rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span>	<span class="o">*</span><span class="n">twin</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">cthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">==</span> <span class="n">CT_RSP_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if the pid is the same as before. */</span>
		<span class="n">gidpn_rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcgs_gidpn_resp_s</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cthdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gidpn_rsp</span><span class="o">-&gt;</span><span class="n">dap</span> <span class="o">==</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Device is online  */</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_ACCEPTED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Device&#39;s PID has changed. We need to cleanup</span>
<span class="cm">			 * and re-login. If there is another device with</span>
<span class="cm">			 * the the newly discovered pid, send an scn notice</span>
<span class="cm">			 * so that its new pid can be discovered.</span>
<span class="cm">			 */</span>
			<span class="n">list_for_each</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">twin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">twin</span> <span class="o">==</span> <span class="n">rport</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gidpn_rsp</span><span class="o">-&gt;</span><span class="n">dap</span> <span class="o">==</span> <span class="n">twin</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">twin</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
					<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

					<span class="n">twin</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">twin</span><span class="p">,</span>
					 <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">gidpn_rsp</span><span class="o">-&gt;</span><span class="n">dap</span><span class="p">;</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_ADDRESS_CHANGE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reject Response</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CT_RSN_LOGICAL_BUSY</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Need to retry</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_TIMEOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_RSN_UNABLE_TO_PERF</span>:
		<span class="cm">/*</span>
<span class="cm">		 * device doesn&#39;t exist : Start timer to cleanup this later.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FAILED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FAILED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_gpnid_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
				<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span>	<span class="o">*</span><span class="n">cthdr</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">cthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">==</span> <span class="n">CT_RSP_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_ACCEPTED</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reject Response</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CT_RSN_LOGICAL_BUSY</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Need to retry</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_TIMEOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_RSN_UNABLE_TO_PERF</span>:
		<span class="cm">/*</span>
<span class="cm">		 * device doesn&#39;t exist : Start timer to cleanup this later.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FAILED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FAILED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Called to send a logout to the rport.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_send_logo</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rport_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">len</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_rport_send_logo</span><span class="p">,</span> <span class="n">rport</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_logo_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				<span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			<span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">rport</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_ELS_TOV</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">logos</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_FCXP_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Send ACC for a LOGO received.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_send_logo_acc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rport_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">len</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">logo_rcvd</span><span class="o">++</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_logo_acc_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
				<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				<span class="n">rport</span><span class="o">-&gt;</span><span class="n">reply_oxid</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			<span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	brief</span>
<span class="cm"> *	This routine will be called by bfa_timer on timer timeouts.</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in]	rport			- pointer to bfa_fcs_lport_ns_t.</span>
<span class="cm"> *	param[out]	rport_status	- pointer to return vport status in</span>
<span class="cm"> *</span>
<span class="cm"> *	return</span>
<span class="cm"> *		void</span>
<span class="cm"> *</span>
<span class="cm"> *	Special Considerations:</span>
<span class="cm"> *</span>
<span class="cm"> *	note</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_timeouts</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">rport_plogi_timeouts</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_process_prli</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_prli_s</span>	<span class="o">*</span><span class="n">prli</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">prli_rcvd</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are in Initiator Mode</span>
<span class="cm">	 */</span>
	<span class="n">prli</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_prli_s</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">rx_fchs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prli</span><span class="o">-&gt;</span><span class="n">parampage</span><span class="p">.</span><span class="n">servparams</span><span class="p">.</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * PRLI from a target ?</span>
<span class="cm">		 * Send the Acc.</span>
<span class="cm">		 * PRLI sent by us will be used to transition the IT nexus,</span>
<span class="cm">		 * once the response is received from the target.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">scsi_function</span> <span class="o">=</span> <span class="n">BFA_RPORT_TARGET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">prli</span><span class="o">-&gt;</span><span class="n">parampage</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">scsi_function</span> <span class="o">=</span> <span class="n">BFA_RPORT_INITIATOR</span><span class="p">;</span>
		<span class="n">bfa_fcs_itnim_is_initiator</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_prli_acc_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
				<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">roles</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			<span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_process_rpsc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rpsc_speed_info_s</span> <span class="n">speeds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_port_attr_s</span> <span class="n">pport_attr</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rpsc_rcvd</span><span class="o">++</span><span class="p">;</span>
	<span class="n">speeds</span><span class="p">.</span><span class="n">port_speed_cap</span> <span class="o">=</span>
		<span class="n">RPSC_SPEED_CAP_1G</span> <span class="o">|</span> <span class="n">RPSC_SPEED_CAP_2G</span> <span class="o">|</span> <span class="n">RPSC_SPEED_CAP_4G</span> <span class="o">|</span>
		<span class="n">RPSC_SPEED_CAP_8G</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * get curent speed from pport attributes from BFA</span>
<span class="cm">	 */</span>
	<span class="n">bfa_fcport_get_attr</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pport_attr</span><span class="p">);</span>

	<span class="n">speeds</span><span class="p">.</span><span class="n">port_op_speed</span> <span class="o">=</span> <span class="n">fc_bfa_speed_to_rpsc_operspeed</span><span class="p">(</span><span class="n">pport_attr</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_rpsc_acc_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
				<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speeds</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			<span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_process_adisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_adisc_s</span>	<span class="o">*</span><span class="n">adisc</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">adisc_rcvd</span><span class="o">++</span><span class="p">;</span>

	<span class="n">adisc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_adisc_s</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">rx_fchs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Accept if the itnim for this rport is online.</span>
<span class="cm">	 * Else reject the ADISC.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_itnim_get_online_state</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">fc_adisc_acc_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
			 <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
			 <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">,</span>
			 <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">nwwn</span><span class="p">);</span>

		<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span>
				<span class="n">BFA_FALSE</span><span class="p">,</span> <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">adisc_rejected</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_fcs_rport_send_ls_rjt</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="p">,</span>
					  <span class="n">FC_LS_RJT_RSN_UNABLE_TO_PERF_CMD</span><span class="p">,</span>
					  <span class="n">FC_LS_RJT_EXP_LOGIN_REQUIRED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_hal_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_rport_info_s</span> <span class="n">rport_info</span><span class="p">;</span>

	<span class="n">rport_info</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">rport_info</span><span class="p">.</span><span class="n">local_pid</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">rport_info</span><span class="p">.</span><span class="n">lp_tag</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">;</span>
	<span class="n">rport_info</span><span class="p">.</span><span class="n">vf_id</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">;</span>
	<span class="n">rport_info</span><span class="p">.</span><span class="n">vf_en</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">is_vf</span><span class="p">;</span>
	<span class="n">rport_info</span><span class="p">.</span><span class="n">fc_class</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">fc_cos</span><span class="p">;</span>
	<span class="n">rport_info</span><span class="p">.</span><span class="n">cisc</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">cisc</span><span class="p">;</span>
	<span class="n">rport_info</span><span class="p">.</span><span class="n">max_frmsz</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">maxfrsize</span><span class="p">;</span>
	<span class="n">bfa_rport_online</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span>
<span class="nf">bfa_fcs_rport_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">pwwn</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rpid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_s</span>	<span class="o">*</span><span class="n">fcs</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_rport_s</span>	<span class="o">*</span><span class="n">rport_drv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate rport</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcb_rport_alloc</span><span class="p">(</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport_drv</span><span class="p">)</span>
		<span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rpid</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize r-port</span>
<span class="cm">	 */</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">=</span> <span class="n">fcs</span><span class="p">;</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">rp_drv</span> <span class="o">=</span> <span class="n">rport_drv</span><span class="p">;</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">rpid</span><span class="p">;</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">=</span> <span class="n">pwwn</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate BFA rport</span>
<span class="cm">	 */</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span> <span class="o">=</span> <span class="n">bfa_rport_create</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rpid</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rport_drv</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate FC-4s</span>
<span class="cm">	 */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bfa_fcs_lport_is_initiator</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_lport_is_initiator</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">bfa_fcs_itnim_create</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rpid</span><span class="p">);</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span>
						<span class="n">BFA_RPORT_SM_DELETE</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">rport_drv</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bfa_fcs_lport_add_rport</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rport</span><span class="p">);</span>

	<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">bfa_fcs_rport_sm_uninit</span><span class="p">);</span>

	<span class="cm">/* Initialize the Rport Features(RPF) Sub Module  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BFA_FCS_PID_IS_WKA</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">))</span>
		<span class="n">bfa_fcs_rpf_init</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rport</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * - delete FC-4s</span>
<span class="cm">	 * - delete BFA rport</span>
<span class="cm">	 * - remove from queue of rports</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_lport_is_initiator</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_fcs_itnim_delete</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BFA_FCS_PID_IS_WKA</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">))</span>
			<span class="n">bfa_fcs_rpf_rport_offline</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_DELETE</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_del_rport</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rport</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rp_drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_aen_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_rport_aen_event</span> <span class="n">event</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bfa_rport_aen_data_s</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_aen_entry_s</span>  <span class="o">*</span><span class="n">aen_entry</span><span class="p">;</span>

	<span class="n">bfad_get_aen_entry</span><span class="p">(</span><span class="n">bfad</span><span class="p">,</span> <span class="n">aen_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aen_entry</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">BFA_RPORT_AEN_QOS_PRIO</span><span class="p">)</span>
		<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">rport</span><span class="p">.</span><span class="n">priv</span><span class="p">.</span><span class="n">qos</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">qos</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">BFA_RPORT_AEN_QOS_FLOWID</span><span class="p">)</span>
		<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">rport</span><span class="p">.</span><span class="n">priv</span><span class="p">.</span><span class="n">qos</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">qos</span><span class="p">;</span>

	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">rport</span><span class="p">.</span><span class="n">vf_id</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">;</span>
	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">rport</span><span class="p">.</span><span class="n">ppwwn</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span>
					<span class="n">bfa_fcs_get_base_port</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">));</span>
	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">rport</span><span class="p">.</span><span class="n">lpwwn</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">rport</span><span class="p">.</span><span class="n">rpwwn</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>

	<span class="cm">/* Send the AEN notification */</span>
	<span class="n">bfad_im_post_vendor_event</span><span class="p">(</span><span class="n">aen_entry</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="o">++</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">fcs_aen_seq</span><span class="p">,</span>
				  <span class="n">BFA_AEN_CAT_RPORT</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_online_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">lpwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>
	<span class="kt">char</span>	<span class="n">rpwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">onlines</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_lport_is_initiator</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_fcs_itnim_rport_online</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BFA_FCS_PID_IS_WKA</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">))</span>
			<span class="n">bfa_fcs_rpf_rport_online</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
	<span class="p">};</span>

	<span class="n">wwn2str</span><span class="p">(</span><span class="n">lpwwn_buf</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">wwn2str</span><span class="p">(</span><span class="n">rpwwn_buf</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BFA_FCS_PID_IS_WKA</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
		<span class="s">&quot;Remote port (WWN = %s) online for logical port (WWN = %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rpwwn_buf</span><span class="p">,</span> <span class="n">lpwwn_buf</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_aen_post</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">BFA_RPORT_AEN_ONLINE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_offline_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">lpwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>
	<span class="kt">char</span>	<span class="n">rpwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">offlines</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">plogi_pending</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="n">wwn2str</span><span class="p">(</span><span class="n">lpwwn_buf</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">wwn2str</span><span class="p">(</span><span class="n">rpwwn_buf</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BFA_FCS_PID_IS_WKA</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_lport_is_online</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_TRUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
				<span class="s">&quot;Remote port (WWN = %s) connectivity lost for &quot;</span>
				<span class="s">&quot;logical port (WWN = %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rpwwn_buf</span><span class="p">,</span> <span class="n">lpwwn_buf</span><span class="p">);</span>
			<span class="n">bfa_fcs_rport_aen_post</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span>
				<span class="n">BFA_RPORT_AEN_DISCONNECT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
				<span class="s">&quot;Remote port (WWN = %s) offlined by &quot;</span>
				<span class="s">&quot;logical port (WWN = %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rpwwn_buf</span><span class="p">,</span> <span class="n">lpwwn_buf</span><span class="p">);</span>
			<span class="n">bfa_fcs_rport_aen_post</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span>
				<span class="n">BFA_RPORT_AEN_OFFLINE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_lport_is_initiator</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_fcs_itnim_rport_offline</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BFA_FCS_PID_IS_WKA</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">))</span>
			<span class="n">bfa_fcs_rpf_rport_offline</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update rport parameters from PLOGI or PLOGI accept.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_logi_s</span> <span class="o">*</span><span class="n">plogi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fcs_lport_t</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * - port name</span>
<span class="cm">	 * - node name</span>
<span class="cm">	 */</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">=</span> <span class="n">plogi</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">;</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">nwwn</span> <span class="o">=</span> <span class="n">plogi</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * - class of service</span>
<span class="cm">	 */</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">fc_cos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">class3</span><span class="p">.</span><span class="n">class_valid</span><span class="p">)</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">fc_cos</span> <span class="o">=</span> <span class="n">FC_CLASS_3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">class2</span><span class="p">.</span><span class="n">class_valid</span><span class="p">)</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">fc_cos</span> <span class="o">|=</span> <span class="n">FC_CLASS_2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * - CISC</span>
<span class="cm">	 * - MAX receive frame size</span>
<span class="cm">	 */</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">cisc</span> <span class="o">=</span> <span class="n">plogi</span><span class="o">-&gt;</span><span class="n">csp</span><span class="p">.</span><span class="n">cisc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">class3</span><span class="p">.</span><span class="n">rxsz</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">csp</span><span class="p">.</span><span class="n">rxsz</span><span class="p">))</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">maxfrsize</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">class3</span><span class="p">.</span><span class="n">rxsz</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">maxfrsize</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">csp</span><span class="p">.</span><span class="n">rxsz</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">csp</span><span class="p">.</span><span class="n">bbcred</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">bb_credit</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Direct Attach P2P mode :</span>
<span class="cm">	 * This is to handle a bug (233476) in IBM targets in Direct Attach</span>
<span class="cm">	 *  Mode. Basically, in FLOGI Accept the target would have</span>
<span class="cm">	 * erroneously set the BB Credit to the value used in the FLOGI</span>
<span class="cm">	 * sent by the HBA. It uses the correct value (its own BB credit)</span>
<span class="cm">	 * in PLOGI.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">bfa_fcs_fabric_is_switched</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">))</span>	 <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">csp</span><span class="p">.</span><span class="n">bbcred</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">bb_credit</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">csp</span><span class="p">.</span><span class="n">bbcred</span><span class="p">));</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">bb_credit</span><span class="p">);</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">bb_credit</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">csp</span><span class="p">.</span><span class="n">bbcred</span><span class="p">);</span>
		<span class="n">bfa_fcport_set_tx_bbcredit</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span>
					  <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">bb_credit</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Called to handle LOGO received from an existing remote port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_process_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">reply_oxid</span> <span class="o">=</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">reply_oxid</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">prlo</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">logo_rcvd</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_LOGO_RCVD</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  fcs_rport_public FCS rport public interfaces</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *	Called by bport/vport to create a remote port instance for a discovered</span>
<span class="cm"> *	remote device.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] port	- base port or vport</span>
<span class="cm"> * @param[in] rpid	- remote port ID</span>
<span class="cm"> *</span>
<span class="cm"> * @return None</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span>
<span class="nf">bfa_fcs_rport_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rpid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rpid</span><span class="p">);</span>
	<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_rport_alloc</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">WWN_NULL</span><span class="p">,</span> <span class="n">rpid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_PLOGI_SEND</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rport</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called to create a rport for which only the wwn is known.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] port	- base port</span>
<span class="cm"> * @param[in] rpwwn	- remote port wwn</span>
<span class="cm"> *</span>
<span class="cm"> * @return None</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span>
<span class="nf">bfa_fcs_rport_create_by_wwn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">rpwwn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rpwwn</span><span class="p">);</span>
	<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_rport_alloc</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rpwwn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_ADDRESS_DISC</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rport</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Called by bport in private loop topology to indicate that a</span>
<span class="cm"> * rport has been discovered and plogi has been completed.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] port	- base port or vport</span>
<span class="cm"> * @param[in] rpid	- remote port ID</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_rport_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">fchs</span><span class="p">,</span>
	 <span class="k">struct</span> <span class="n">fc_logi_s</span> <span class="o">*</span><span class="n">plogi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_rport_alloc</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">WWN_NULL</span><span class="p">,</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bfa_fcs_rport_update</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">plogi</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_PLOGI_COMP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Called by bport/vport to handle PLOGI received from a new remote port.</span>
<span class="cm"> *	If an existing rport does a plogi, it will be handled separately.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_rport_plogi_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">fchs</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fc_logi_s</span> <span class="o">*</span><span class="n">plogi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_rport_alloc</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">plogi</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bfa_fcs_rport_update</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">plogi</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">reply_oxid</span> <span class="o">=</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">reply_oxid</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_rcvd</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Called by bport/vport to handle PLOGI received from an existing</span>
<span class="cm"> *	 remote port.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_rport_plogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fc_logi_s</span> <span class="o">*</span><span class="n">plogi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * @todo Handle P2P and initiator-initiator.</span>
<span class="cm">	 */</span>

	<span class="n">bfa_fcs_rport_update</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">plogi</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">reply_oxid</span> <span class="o">=</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">reply_oxid</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plogi_rcvd</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_PLOGI_RCVD</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Called by bport/vport to notify SCN for the remote port</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_rport_scn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rscns</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_SCN</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	brief</span>
<span class="cm"> *	This routine BFA callback for bfa_rport_online() call.</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in]	cb_arg	-  rport struct.</span>
<span class="cm"> *</span>
<span class="cm"> *	return</span>
<span class="cm"> *		void</span>
<span class="cm"> *</span>
<span class="cm"> *	Special Considerations:</span>
<span class="cm"> *</span>
<span class="cm"> *	note</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_cb_rport_online</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_HCB_ONLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	brief</span>
<span class="cm"> *	This routine BFA callback for bfa_rport_offline() call.</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in]	rport	-</span>
<span class="cm"> *</span>
<span class="cm"> *	return</span>
<span class="cm"> *		void</span>
<span class="cm"> *</span>
<span class="cm"> *	Special Considerations:</span>
<span class="cm"> *</span>
<span class="cm"> *	note</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_cb_rport_offline</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_HCB_OFFLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	brief</span>
<span class="cm"> *	This routine is a static BFA callback when there is a QoS flow_id</span>
<span class="cm"> *	change notification</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in]	rport	-</span>
<span class="cm"> *</span>
<span class="cm"> *	return</span>
<span class="cm"> *		void</span>
<span class="cm"> *</span>
<span class="cm"> *	Special Considerations:</span>
<span class="cm"> *</span>
<span class="cm"> *	note</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_cb_rport_qos_scn_flowid</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_rport_qos_attr_s</span> <span class="n">old_qos_attr</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_rport_qos_attr_s</span> <span class="n">new_qos_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_rport_aen_data_s</span> <span class="n">aen_data</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">aen_data</span><span class="p">.</span><span class="n">priv</span><span class="p">.</span><span class="n">qos</span> <span class="o">=</span> <span class="n">new_qos_attr</span><span class="p">;</span>
	<span class="n">bfa_fcs_rport_aen_post</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">BFA_RPORT_AEN_QOS_FLOWID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aen_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	brief</span>
<span class="cm"> *	This routine is a static BFA callback when there is a QoS priority</span>
<span class="cm"> *	change notification</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in]	rport	-</span>
<span class="cm"> *</span>
<span class="cm"> *	return</span>
<span class="cm"> *		void</span>
<span class="cm"> *</span>
<span class="cm"> *	Special Considerations:</span>
<span class="cm"> *</span>
<span class="cm"> *	note</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_cb_rport_qos_scn_prio</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_rport_qos_attr_s</span> <span class="n">old_qos_attr</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_rport_qos_attr_s</span> <span class="n">new_qos_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_rport_aen_data_s</span> <span class="n">aen_data</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">aen_data</span><span class="p">.</span><span class="n">priv</span><span class="p">.</span><span class="n">qos</span> <span class="o">=</span> <span class="n">new_qos_attr</span><span class="p">;</span>
	<span class="n">bfa_fcs_rport_aen_post</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">BFA_RPORT_AEN_QOS_PRIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aen_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		Called to process any unsolicted frames from this remote port</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_rport_uf_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">fchs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_cmd_s</span>	<span class="o">*</span><span class="n">els_cmd</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fchs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FC_TYPE_ELS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">els_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_cmd_s</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">fchs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FC_ELS_LOGO</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">plogi_rcvd</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_process_logo</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_ELS_ADISC</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">adisc_rcvd</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_process_adisc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_ELS_PRLO</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">prlo_rcvd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_lport_is_initiator</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
			<span class="n">bfa_fcs_fcpim_uf_recv</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">,</span> <span class="n">fchs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_ELS_PRLI</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">prli_rcvd</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_process_prli</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_ELS_RPSC</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rpsc_rcvd</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_process_rpsc</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">un_handled_els_rcvd</span><span class="p">);</span>
		<span class="n">bfa_fcs_rport_send_ls_rjt</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">,</span>
					  <span class="n">FC_LS_RJT_RSN_CMD_NOT_SUPP</span><span class="p">,</span>
					  <span class="n">FC_LS_RJT_EXP_NO_ADDL_INFO</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* send best case  acc to prlo */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_send_prlo_acc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_prlo_acc_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">reply_oxid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span> <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a LS reject</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rport_send_ls_rjt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">reason_code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason_code_expl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_ls_rjt_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
				<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">,</span> <span class="n">reason_code_expl</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span>
			<span class="n">BFA_FALSE</span><span class="p">,</span> <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return state of rport.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">bfa_fcs_rport_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bfa_sm_to_state</span><span class="p">(</span><span class="n">rport_sm_table</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	brief</span>
<span class="cm"> *		 Called by the Driver to set rport delete/ageout timeout</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in]		rport timeout value in seconds.</span>
<span class="cm"> *</span>
<span class="cm"> *	return None</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_rport_set_del_timeout</span><span class="p">(</span><span class="n">u8</span> <span class="n">rport_tmo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* convert to Millisecs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport_tmo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bfa_fcs_rport_del_timeout</span> <span class="o">=</span> <span class="n">rport_tmo</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_rport_prlo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">ox_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">prlo</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">reply_oxid</span> <span class="o">=</span> <span class="n">ox_id</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_PRLO_RCVD</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_rport_get_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_rport_attr_s</span> <span class="o">*</span><span class="n">rport_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_rport_qos_attr_s</span> <span class="n">qos_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">bfa_port_speed_t</span> <span class="n">rport_speed</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">rpf</span><span class="p">.</span><span class="n">rpsc_speed</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rport_attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_attr_s</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qos_attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_qos_attr_s</span><span class="p">));</span>

	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>
	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">nwwn</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">nwwn</span><span class="p">;</span>
	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">cos_supported</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">fc_cos</span><span class="p">;</span>
	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">df_sz</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">maxfrsize</span><span class="p">;</span>
	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">bfa_fcs_rport_get_state</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">fc_cos</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">fc_cos</span><span class="p">;</span>
	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">cisc</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">cisc</span><span class="p">;</span>
	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">scsi_function</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">scsi_function</span><span class="p">;</span>
	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">curr_speed</span>  <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">rpf</span><span class="p">.</span><span class="n">rpsc_speed</span><span class="p">;</span>
	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">assigned_speed</span>  <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">rpf</span><span class="p">.</span><span class="n">assigned_speed</span><span class="p">;</span>

	<span class="n">qos_attr</span><span class="p">.</span><span class="n">qos_priority</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="o">-&gt;</span><span class="n">qos_attr</span><span class="p">.</span><span class="n">qos_priority</span><span class="p">;</span>
	<span class="n">qos_attr</span><span class="p">.</span><span class="n">qos_flow_id</span> <span class="o">=</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="o">-&gt;</span><span class="n">qos_attr</span><span class="p">.</span><span class="n">qos_flow_id</span><span class="p">);</span>
	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">qos_attr</span> <span class="o">=</span> <span class="n">qos_attr</span><span class="p">;</span>

	<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">trl_enforced</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_is_ratelim</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">scsi_function</span> <span class="o">==</span> <span class="n">BFA_RPORT_TARGET</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rport_speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_UNKNOWN</span><span class="p">)</span>
			<span class="n">rport_speed</span> <span class="o">=</span>
				<span class="n">bfa_fcport_get_ratelim_speed</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rport_speed</span> <span class="o">&lt;</span> <span class="n">bfa_fcs_lport_get_rport_max_speed</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
			<span class="n">rport_attr</span><span class="o">-&gt;</span><span class="n">trl_enforced</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remote port implementation.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  fcs_rport_api FCS rport API.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span>
<span class="nf">bfa_fcs_rport_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">rpwwn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_rport_by_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rpwwn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TBD Error handling</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rport</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span>
<span class="nf">bfa_fcs_rport_lookup_by_nwwn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">rnwwn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_rport_by_nwwn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rnwwn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TBD Error handling</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rport</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remote port features (RPF) implementation.</span>
<span class="cm"> */</span>

<span class="cp">#define BFA_FCS_RPF_RETRIES	(3)</span>
<span class="cp">#define BFA_FCS_RPF_RETRY_TIMEOUT  (1000) </span><span class="cm">/* 1 sec (In millisecs) */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_rpf_send_rpsc2</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rport_cbarg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_rpf_rpsc2_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
			<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_rpf_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  fcs_rport_ftrs_sm FCS rport state machine events</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">rpf_event</span> <span class="p">{</span>
	<span class="n">RPFSM_EVENT_RPORT_OFFLINE</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* Rport offline		*/</span>
	<span class="n">RPFSM_EVENT_RPORT_ONLINE</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/* Rport online			*/</span>
	<span class="n">RPFSM_EVENT_FCXP_SENT</span>      <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="cm">/* Frame from has been sent	*/</span>
	<span class="n">RPFSM_EVENT_TIMEOUT</span>	   <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="cm">/* Rport SM timeout event	*/</span>
	<span class="n">RPFSM_EVENT_RPSC_COMP</span>      <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">RPFSM_EVENT_RPSC_FAIL</span>      <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">RPFSM_EVENT_RPSC_ERROR</span>     <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rpf_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">rpf_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_rpf_sm_rpsc_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">rpf_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_rpf_sm_rpsc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">rpf_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_rpf_sm_rpsc_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">rpf_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_rpf_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">rpf_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_rpf_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">rpf_event</span> <span class="n">event</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rpf_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_fabric_s</span> <span class="o">*</span><span class="n">fabric</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPFSM_EVENT_RPORT_ONLINE</span>:
		<span class="cm">/* Send RPSC2 to a Brocade fabric only. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">BFA_FCS_PID_IS_WKA</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">brcd_switch</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">bfa_fcs_fabric_get_switch_oui</span><span class="p">(</span><span class="n">fabric</span><span class="p">)</span> <span class="o">==</span>
						<span class="n">BFA_FCS_BRCD_SWITCH_OUI</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_rpsc_sending</span><span class="p">);</span>
			<span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rpsc_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bfa_fcs_rpf_send_rpsc2</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPFSM_EVENT_RPORT_OFFLINE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rpf_sm_rpsc_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPFSM_EVENT_FCXP_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_rpsc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPFSM_EVENT_RPORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rpf</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rpsc_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rpf_sm_rpsc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPFSM_EVENT_RPSC_COMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_online</span><span class="p">);</span>
		<span class="cm">/* Update speed info in f/w via BFA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rpsc_speed</span> <span class="o">!=</span> <span class="n">BFA_PORT_SPEED_UNKNOWN</span><span class="p">)</span>
			<span class="n">bfa_rport_speed</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span> <span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rpsc_speed</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rpf</span><span class="o">-&gt;</span><span class="n">assigned_speed</span> <span class="o">!=</span> <span class="n">BFA_PORT_SPEED_UNKNOWN</span><span class="p">)</span>
			<span class="n">bfa_rport_speed</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">,</span> <span class="n">rpf</span><span class="o">-&gt;</span><span class="n">assigned_speed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPFSM_EVENT_RPSC_FAIL</span>:
		<span class="cm">/* RPSC not supported by rport */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_online</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPFSM_EVENT_RPSC_ERROR</span>:
		<span class="cm">/* need to retry...delayed a bit. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rpsc_retries</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">BFA_FCS_RPF_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rpf</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				    <span class="n">bfa_fcs_rpf_timeout</span><span class="p">,</span> <span class="n">rpf</span><span class="p">,</span>
				    <span class="n">BFA_FCS_RPF_RETRY_TIMEOUT</span><span class="p">);</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_rpsc_retry</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_online</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPFSM_EVENT_RPORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">rpf</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rpsc_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rpf_sm_rpsc_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPFSM_EVENT_TIMEOUT</span>:
		<span class="cm">/* re-send the RPSC */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_rpsc_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_rpf_send_rpsc2</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPFSM_EVENT_RPORT_OFFLINE</span>:
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpf</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_offline</span><span class="p">);</span>
		<span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rpsc_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rpf_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPFSM_EVENT_RPORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_offline</span><span class="p">);</span>
		<span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rpsc_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rpf_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPFSM_EVENT_RPORT_ONLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_rpsc_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_rpf_send_rpsc2</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPFSM_EVENT_RPORT_OFFLINE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Called when Rport is created.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_rpf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rpf</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rport</span><span class="p">;</span>

	<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_sm_uninit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called when Rport becomes online</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_rpf_rport_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__fcs_min_cfg</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_fabric_is_switched</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">))</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rpf</span><span class="p">,</span> <span class="n">RPFSM_EVENT_RPORT_ONLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called when Rport becomes offline</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_rpf_rport_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__fcs_min_cfg</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">rpf</span><span class="p">.</span><span class="n">rpsc_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rpf</span><span class="p">,</span> <span class="n">RPFSM_EVENT_RPORT_OFFLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rpf_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">RPFSM_EVENT_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rpf_send_rpsc2</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rpf_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="p">)</span><span class="n">rpf_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rpf</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_rpf_send_rpsc2</span><span class="p">,</span> <span class="n">rpf</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rpf</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_rpsc2_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
			    <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcs_rpf_rpsc2_response</span><span class="p">,</span>
			  <span class="n">rpf</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_ELS_TOV</span><span class="p">);</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rpsc_sent</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">RPFSM_EVENT_FCXP_SENT</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_rpf_rpsc2_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
			    <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="n">rpf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rpf_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_ls_rjt_s</span> <span class="o">*</span><span class="n">ls_rjt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rpsc2_acc_s</span> <span class="o">*</span><span class="n">rpsc2_acc</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">num_ents</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">==</span> <span class="n">BFA_STATUS_ETIMER</span><span class="p">)</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rpsc_failed</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">RPFSM_EVENT_RPSC_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rpsc2_acc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_rpsc2_acc_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpsc2_acc</span><span class="o">-&gt;</span><span class="n">els_cmd</span> <span class="o">==</span> <span class="n">FC_ELS_ACC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rpsc_accs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">num_ents</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rpsc2_acc</span><span class="o">-&gt;</span><span class="n">num_pids</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">num_ents</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_ents</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rpsc2_acc</span><span class="o">-&gt;</span><span class="n">port_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pid</span> <span class="o">==</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span>
				<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rpsc2_acc</span><span class="o">-&gt;</span><span class="n">port_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pid</span><span class="p">));</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span>
				<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rpsc2_acc</span><span class="o">-&gt;</span><span class="n">port_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">speed</span><span class="p">));</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span>
				<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rpsc2_acc</span><span class="o">-&gt;</span><span class="n">port_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index</span><span class="p">));</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span>
				<span class="n">rpsc2_acc</span><span class="o">-&gt;</span><span class="n">port_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rpsc2_acc</span><span class="o">-&gt;</span><span class="n">port_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">RPFSM_EVENT_RPSC_ERROR</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rpf</span><span class="o">-&gt;</span><span class="n">rpsc_speed</span> <span class="o">=</span> <span class="n">fc_rpsc_operspeed_to_bfa_speed</span><span class="p">(</span>
				<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rpsc2_acc</span><span class="o">-&gt;</span><span class="n">port_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">speed</span><span class="p">));</span>

			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">RPFSM_EVENT_RPSC_COMP</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ls_rjt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_ls_rjt_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code_expl</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rpsc_rejects</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code</span> <span class="o">==</span> <span class="n">FC_LS_RJT_RSN_CMD_NOT_SUPP</span><span class="p">)</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">RPFSM_EVENT_RPSC_FAIL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rpf</span><span class="p">,</span> <span class="n">RPFSM_EVENT_RPSC_ERROR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
