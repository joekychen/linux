<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › bfa › bfad_attr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bfad_attr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2010 Brocade Communications Systems, Inc.</span>
<span class="cm"> * All rights reserved</span>
<span class="cm"> * www.brocade.com</span>
<span class="cm"> *</span>
<span class="cm"> * Linux driver for Brocade Fibre Channel Host Bus Adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License (GPL) Version 2 as</span>
<span class="cm"> * published by the Free Software Foundation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  bfa_attr.c Linux driver configuration interface module.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;bfad_drv.h&quot;</span>
<span class="cp">#include &quot;bfad_im.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, get SCSI target port ID.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfad_im_get_starget_port_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span>         <span class="o">*</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_itnim_s</span>   <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span>        <span class="n">fc_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">im_port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">itnim</span> <span class="o">=</span> <span class="n">bfad_get_itnim</span><span class="p">(</span><span class="n">im_port</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itnim</span><span class="p">)</span>
		<span class="n">fc_id</span> <span class="o">=</span> <span class="n">bfa_fcs_itnim_get_fcid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">fcs_itnim</span><span class="p">);</span>

	<span class="n">fc_starget_port_id</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">fc_id</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, get SCSI target nwwn.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfad_im_get_starget_node_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span>         <span class="o">*</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_itnim_s</span>   <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span>             <span class="n">node_name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">im_port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">itnim</span> <span class="o">=</span> <span class="n">bfad_get_itnim</span><span class="p">(</span><span class="n">im_port</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itnim</span><span class="p">)</span>
		<span class="n">node_name</span> <span class="o">=</span> <span class="n">bfa_fcs_itnim_get_nwwn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">fcs_itnim</span><span class="p">);</span>

	<span class="n">fc_starget_node_name</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">node_name</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, get SCSI target pwwn.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfad_im_get_starget_port_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span>         <span class="o">*</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_itnim_s</span>   <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span>             <span class="n">port_name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">im_port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">itnim</span> <span class="o">=</span> <span class="n">bfad_get_itnim</span><span class="p">(</span><span class="n">im_port</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itnim</span><span class="p">)</span>
		<span class="n">port_name</span> <span class="o">=</span> <span class="n">bfa_fcs_itnim_get_pwwn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itnim</span><span class="o">-&gt;</span><span class="n">fcs_itnim</span><span class="p">);</span>

	<span class="n">fc_starget_port_name</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">port_name</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, get SCSI host port ID.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfad_im_get_host_port_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_port_s</span>    <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">fc_host_port_id</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span>
			<span class="n">bfa_hton3b</span><span class="p">(</span><span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs_port</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, get SCSI host port type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfad_im_get_host_port_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span>         <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_lport_attr_s</span> <span class="n">port_attr</span><span class="p">;</span>

	<span class="n">bfa_fcs_lport_get_attr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa_fcs</span><span class="p">.</span><span class="n">fabric</span><span class="p">.</span><span class="n">bport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_attr</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">port_attr</span><span class="p">.</span><span class="n">port_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_PORT_TYPE_NPORT</span>:
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NPORT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFA_PORT_TYPE_NLPORT</span>:
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NLPORT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFA_PORT_TYPE_P2P</span>:
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_PTP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFA_PORT_TYPE_LPORT</span>:
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_LPORT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, get SCSI host port state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfad_im_get_host_port_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span>         <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_port_attr_s</span> <span class="n">attr</span><span class="p">;</span>

	<span class="n">bfa_fcport_get_attr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">port_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_PORT_ST_LINKDOWN</span>:
		<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_LINKDOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFA_PORT_ST_LINKUP</span>:
		<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_ONLINE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFA_PORT_ST_DISABLED</span>:
	<span class="k">case</span> <span class="n">BFA_PORT_ST_STOPPED</span>:
	<span class="k">case</span> <span class="n">BFA_PORT_ST_IOCDOWN</span>:
	<span class="k">case</span> <span class="n">BFA_PORT_ST_IOCDIS</span>:
		<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_OFFLINE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFA_PORT_ST_UNINIT</span>:
	<span class="k">case</span> <span class="n">BFA_PORT_ST_ENABLING_QWAIT</span>:
	<span class="k">case</span> <span class="n">BFA_PORT_ST_ENABLING</span>:
	<span class="k">case</span> <span class="n">BFA_PORT_ST_DISABLING_QWAIT</span>:
	<span class="k">case</span> <span class="n">BFA_PORT_ST_DISABLING</span>:
	<span class="nl">default:</span>
		<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, get SCSI host active fc4s.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfad_im_get_host_active_fc4s</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_port_s</span>    <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fc_host_active_fc4s</span><span class="p">(</span><span class="n">shost</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">fc_host_active_fc4s</span><span class="p">(</span><span class="n">shost</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">supported_fc4s</span> <span class="o">&amp;</span> <span class="n">BFA_LPORT_ROLE_FCP_IM</span><span class="p">)</span>
		<span class="n">fc_host_active_fc4s</span><span class="p">(</span><span class="n">shost</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">fc_host_active_fc4s</span><span class="p">(</span><span class="n">shost</span><span class="p">)[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, get SCSI host link speed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfad_im_get_host_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span>         <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_port_attr_s</span> <span class="n">attr</span><span class="p">;</span>

	<span class="n">bfa_fcport_get_attr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_10GBPS</span>:
		<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_16GBPS</span>:
		<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_16GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_8GBPS</span>:
		<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_8GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_4GBPS</span>:
		<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_4GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_2GBPS</span>:
		<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_2GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_1GBPS</span>:
		<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_1GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, get SCSI host port type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfad_im_get_host_fabric_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_port_s</span>    <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">wwn_t</span>           <span class="n">fabric_nwwn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fabric_nwwn</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_fabric_name</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs_port</span><span class="p">);</span>

	<span class="n">fc_host_fabric_name</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">fabric_nwwn</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, get BFAD statistics.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_host_statistics</span> <span class="o">*</span>
<span class="nf">bfad_im_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span>         <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_hal_comp</span> <span class="n">fcomp</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">bfa_port_stats_u</span> <span class="o">*</span><span class="n">fcstats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_host_statistics</span> <span class="o">*</span><span class="n">hstats</span><span class="p">;</span>
	<span class="n">bfa_status_t</span>    <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>

	<span class="n">fcstats</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">bfa_port_stats_u</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcstats</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">link_stats</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hstats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_host_statistics</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bfa_port_get_stats</span><span class="p">(</span><span class="n">BFA_FCPORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">),</span>
				<span class="n">fcstats</span><span class="p">,</span> <span class="n">bfad_hcb_comp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcomp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>

	<span class="cm">/* Fill the fc_host_statistics structure */</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">seconds_since_last_reset</span> <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">secs_reset</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">tx_frames</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">tx_words</span>  <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">tx_words</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">rx_frames</span> <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">rx_frames</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">rx_words</span>  <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">rx_words</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">lip_count</span> <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">lip_count</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">nos_count</span> <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">nos_count</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">error_frames</span> <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">error_frames</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">dumped_frames</span> <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">dropped_frames</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">link_failure_count</span> <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">link_failures</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">loss_of_sync_count</span> <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">loss_of_syncs</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">loss_of_signal_count</span> <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">loss_of_signals</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">prim_seq_protocol_err_count</span> <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">primseq_errs</span><span class="p">;</span>
	<span class="n">hstats</span><span class="o">-&gt;</span><span class="n">invalid_crc_count</span> <span class="o">=</span> <span class="n">fcstats</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">invalid_crcs</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">fcstats</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hstats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, reset BFAD statistics.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfad_im_reset_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span>         <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_hal_comp</span> <span class="n">fcomp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="n">bfa_status_t</span>    <span class="n">rc</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bfa_port_clear_stats</span><span class="p">(</span><span class="n">BFA_FCPORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">),</span> <span class="n">bfad_hcb_comp</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">fcomp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, get rport loss timeout.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfad_im_get_rport_loss_tmo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_itnim_data_s</span> <span class="o">*</span><span class="n">itnim_data</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_itnim_s</span>   <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">itnim_data</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span>         <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="n">bfa_fcpim_path_tov_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC transport template entry, set rport loss timeout.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfad_im_set_rport_loss_tmo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_itnim_data_s</span> <span class="o">*</span><span class="n">itnim_data</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_itnim_s</span>   <span class="o">*</span><span class="n">itnim</span> <span class="o">=</span> <span class="n">itnim_data</span><span class="o">-&gt;</span><span class="n">itnim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span>         <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">itnim</span><span class="o">-&gt;</span><span class="n">im</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">bfa_fcpim_path_tov_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="n">bfa_fcpim_path_tov_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bfad_im_vport_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">bool</span> <span class="n">disable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vname</span> <span class="o">=</span> <span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">symbolic_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_lport_cfg_s</span> <span class="n">port_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_vport_s</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">port_cfg</span><span class="p">));</span>
	<span class="n">u64_to_wwn</span><span class="p">(</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">nwwn</span><span class="p">);</span>
	<span class="n">u64_to_wwn</span><span class="p">(</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">sym_name</span><span class="p">,</span> <span class="n">vname</span><span class="p">);</span>
	<span class="n">port_cfg</span><span class="p">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">BFA_LPORT_ROLE_FCP_IM</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">pbc_vport_list</span><span class="p">,</span> <span class="n">list_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span> <span class="o">==</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">fcs_vport</span><span class="p">.</span><span class="n">lport</span><span class="p">.</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port_cfg</span><span class="p">.</span><span class="n">preboot_vp</span> <span class="o">=</span>
				<span class="n">vp</span><span class="o">-&gt;</span><span class="n">fcs_vport</span><span class="p">.</span><span class="n">lport</span><span class="p">.</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">preboot_vp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bfad_vport_create</span><span class="p">(</span><span class="n">bfad</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bfad_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">fcs_vport</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">vshost</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">fcs_vport</span> <span class="o">=</span> <span class="n">bfa_fcs_vport_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa_fcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcs_vport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">VPCERR_BAD_WWN</span><span class="p">;</span>

		<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_ACTIVE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">bfa_fcs_vport_stop</span><span class="p">(</span><span class="n">fcs_vport</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_DISABLED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">vport</span> <span class="o">=</span> <span class="n">fcs_vport</span><span class="o">-&gt;</span><span class="n">vport_drv</span><span class="p">;</span>
		<span class="n">vshost</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">drv_port</span><span class="p">.</span><span class="n">im_port</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
		<span class="n">fc_host_node_name</span><span class="p">(</span><span class="n">vshost</span><span class="p">)</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">nwwn</span><span class="p">);</span>
		<span class="n">fc_host_port_name</span><span class="p">(</span><span class="n">vshost</span><span class="p">)</span> <span class="o">=</span> <span class="n">wwn_to_u64</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="n">fc_host_supported_classes</span><span class="p">(</span><span class="n">vshost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">fc_host_supported_fc4s</span><span class="p">(</span><span class="n">vshost</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">fc_host_supported_fc4s</span><span class="p">(</span><span class="n">vshost</span><span class="p">)));</span>

		<span class="cm">/* For FCP type 0x08 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">supported_fc4s</span> <span class="o">&amp;</span> <span class="n">BFA_LPORT_ROLE_FCP_IM</span><span class="p">)</span>
			<span class="n">fc_host_supported_fc4s</span><span class="p">(</span><span class="n">vshost</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* For fibre channel services type 0x20 */</span>
		<span class="n">fc_host_supported_fc4s</span><span class="p">(</span><span class="n">vshost</span><span class="p">)[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">fc_host_supported_speeds</span><span class="p">(</span><span class="n">vshost</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">bfad_im_supported_speeds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="n">fc_host_maxframe_size</span><span class="p">(</span><span class="n">vshost</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">bfa_fcport_get_maxfrsize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>

		<span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="n">vport</span><span class="p">;</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">drv_port</span><span class="p">.</span><span class="n">im_port</span><span class="o">-&gt;</span><span class="n">fc_vport</span> <span class="o">=</span> <span class="n">fc_vport</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">BFA_STATUS_INVALID_WWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VPCERR_BAD_WWN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">BFA_STATUS_VPORT_EXISTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VPCERR_BAD_WWN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">BFA_STATUS_VPORT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VPCERR_NO_FABRIC_SUPP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">BFA_STATUS_VPORT_WWN_BP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VPCERR_BAD_WWN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">FC_VPORT_FAILED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">bfad_im_issue_fc_host_lip</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_hal_comp</span> <span class="n">fcomp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">bfa_port_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">.</span><span class="n">modules</span><span class="p">.</span><span class="n">port</span><span class="p">,</span>
					<span class="n">bfad_hcb_comp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcomp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcomp</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">bfa_port_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">.</span><span class="n">modules</span><span class="p">.</span><span class="n">port</span><span class="p">,</span>
					<span class="n">bfad_hcb_comp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcomp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcomp</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bfad_im_vport_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_vport_s</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_vport_s</span> <span class="o">*</span><span class="p">)</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">drv_port</span><span class="p">.</span><span class="n">im_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_port_s</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">fcs_vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">vshost</span><span class="p">;</span>
	<span class="n">wwn_t</span>   <span class="n">pwwn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">fcomp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">im_port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BFAD_PORT_DELETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfad_scsi_host_free</span><span class="p">(</span><span class="n">bfad</span><span class="p">,</span> <span class="n">im_port</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">list_entry</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">vshost</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">drv_port</span><span class="p">.</span><span class="n">im_port</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
	<span class="n">u64_to_wwn</span><span class="p">(</span><span class="n">fc_host_port_name</span><span class="p">(</span><span class="n">vshost</span><span class="p">),</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fcs_vport</span> <span class="o">=</span> <span class="n">bfa_fcs_vport_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa_fcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pwwn</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcs_vport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VPCERR_BAD_WWN</span><span class="p">;</span>

	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">drv_port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BFAD_PORT_DELETE</span><span class="p">;</span>

	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">comp_del</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcomp</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">comp_del</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bfa_fcs_vport_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fcs_vport</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">BFA_STATUS_PBC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">drv_port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BFAD_PORT_DELETE</span><span class="p">;</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">comp_del</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">comp_del</span><span class="p">);</span>

	<span class="n">bfad_scsi_host_free</span><span class="p">(</span><span class="n">bfad</span><span class="p">,</span> <span class="n">im_port</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">list_entry</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bfad_im_vport_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">bool</span> <span class="n">disable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">fcs_vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">vshost</span><span class="p">;</span>
	<span class="n">wwn_t</span>   <span class="n">pwwn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_vport_s</span> <span class="o">*</span><span class="p">)</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">bfad</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">drv_port</span><span class="p">.</span><span class="n">bfad</span><span class="p">;</span>
	<span class="n">vshost</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">drv_port</span><span class="p">.</span><span class="n">im_port</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
	<span class="n">u64_to_wwn</span><span class="p">(</span><span class="n">fc_host_port_name</span><span class="p">(</span><span class="n">vshost</span><span class="p">),</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fcs_vport</span> <span class="o">=</span> <span class="n">bfa_fcs_vport_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa_fcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pwwn</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcs_vport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VPCERR_BAD_WWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_vport_stop</span><span class="p">(</span><span class="n">fcs_vport</span><span class="p">);</span>
		<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_DISABLED</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bfa_fcs_vport_start</span><span class="p">(</span><span class="n">fcs_vport</span><span class="p">);</span>
		<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">FC_VPORT_ACTIVE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fc_function_template</span> <span class="n">bfad_im_fc_function_template</span> <span class="o">=</span> <span class="p">{</span>

	<span class="cm">/* Target dynamic attributes */</span>
	<span class="p">.</span><span class="n">get_starget_port_id</span> <span class="o">=</span> <span class="n">bfad_im_get_starget_port_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_starget_node_name</span> <span class="o">=</span> <span class="n">bfad_im_get_starget_node_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_starget_port_name</span> <span class="o">=</span> <span class="n">bfad_im_get_starget_port_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* Host dynamic attribute */</span>
	<span class="p">.</span><span class="n">get_host_port_id</span> <span class="o">=</span> <span class="n">bfad_im_get_host_port_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* Host fixed attributes */</span>
	<span class="p">.</span><span class="n">show_host_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_fc4s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_speeds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_maxframe_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* More host dynamic attributes */</span>
	<span class="p">.</span><span class="n">show_host_port_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_port_type</span> <span class="o">=</span> <span class="n">bfad_im_get_host_port_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_port_state</span> <span class="o">=</span> <span class="n">bfad_im_get_host_port_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_active_fc4s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_active_fc4s</span> <span class="o">=</span> <span class="n">bfad_im_get_host_active_fc4s</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_speed</span> <span class="o">=</span> <span class="n">bfad_im_get_host_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_fabric_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_fabric_name</span> <span class="o">=</span> <span class="n">bfad_im_get_host_fabric_name</span><span class="p">,</span>

	<span class="p">.</span><span class="n">show_host_symbolic_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* Statistics */</span>
	<span class="p">.</span><span class="n">get_fc_host_stats</span> <span class="o">=</span> <span class="n">bfad_im_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_fc_host_stats</span> <span class="o">=</span> <span class="n">bfad_im_reset_stats</span><span class="p">,</span>

	<span class="cm">/* Allocation length for host specific data */</span>
	<span class="p">.</span><span class="n">dd_fcrport_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfad_itnim_data_s</span> <span class="o">*</span><span class="p">),</span>

	<span class="cm">/* Remote port fixed attributes */</span>
	<span class="p">.</span><span class="n">show_rport_maxframe_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="n">bfad_im_get_rport_loss_tmo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="n">bfad_im_set_rport_loss_tmo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">issue_fc_host_lip</span> <span class="o">=</span> <span class="n">bfad_im_issue_fc_host_lip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vport_create</span> <span class="o">=</span> <span class="n">bfad_im_vport_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vport_delete</span> <span class="o">=</span> <span class="n">bfad_im_vport_delete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vport_disable</span> <span class="o">=</span> <span class="n">bfad_im_vport_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bsg_request</span> <span class="o">=</span> <span class="n">bfad_im_bsg_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bsg_timeout</span> <span class="o">=</span> <span class="n">bfad_im_bsg_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fc_function_template</span> <span class="n">bfad_im_vport_fc_function_template</span> <span class="o">=</span> <span class="p">{</span>

	<span class="cm">/* Target dynamic attributes */</span>
	<span class="p">.</span><span class="n">get_starget_port_id</span> <span class="o">=</span> <span class="n">bfad_im_get_starget_port_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_starget_node_name</span> <span class="o">=</span> <span class="n">bfad_im_get_starget_node_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_starget_port_name</span> <span class="o">=</span> <span class="n">bfad_im_get_starget_port_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* Host dynamic attribute */</span>
	<span class="p">.</span><span class="n">get_host_port_id</span> <span class="o">=</span> <span class="n">bfad_im_get_host_port_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* Host fixed attributes */</span>
	<span class="p">.</span><span class="n">show_host_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_fc4s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_speeds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_maxframe_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* More host dynamic attributes */</span>
	<span class="p">.</span><span class="n">show_host_port_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_port_type</span> <span class="o">=</span> <span class="n">bfad_im_get_host_port_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_port_state</span> <span class="o">=</span> <span class="n">bfad_im_get_host_port_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_active_fc4s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_active_fc4s</span> <span class="o">=</span> <span class="n">bfad_im_get_host_active_fc4s</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_speed</span> <span class="o">=</span> <span class="n">bfad_im_get_host_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_fabric_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_fabric_name</span> <span class="o">=</span> <span class="n">bfad_im_get_host_fabric_name</span><span class="p">,</span>

	<span class="p">.</span><span class="n">show_host_symbolic_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* Statistics */</span>
	<span class="p">.</span><span class="n">get_fc_host_stats</span> <span class="o">=</span> <span class="n">bfad_im_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_fc_host_stats</span> <span class="o">=</span> <span class="n">bfad_im_reset_stats</span><span class="p">,</span>

	<span class="cm">/* Allocation length for host specific data */</span>
	<span class="p">.</span><span class="n">dd_fcrport_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfad_itnim_data_s</span> <span class="o">*</span><span class="p">),</span>

	<span class="cm">/* Remote port fixed attributes */</span>
	<span class="p">.</span><span class="n">show_rport_maxframe_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="n">bfad_im_get_rport_loss_tmo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="n">bfad_im_set_rport_loss_tmo</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Scsi_Host_attrs SCSI host attributes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bfad_im_serial_num_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">serial_num</span><span class="p">[</span><span class="n">BFA_ADAPTER_SERIAL_NUM_LEN</span><span class="p">];</span>

	<span class="n">bfa_get_adapter_serial_num</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">serial_num</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">serial_num</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bfad_im_model_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">model</span><span class="p">[</span><span class="n">BFA_ADAPTER_MODEL_NAME_LEN</span><span class="p">];</span>

	<span class="n">bfa_get_adapter_model</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bfad_im_model_desc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">model</span><span class="p">[</span><span class="n">BFA_ADAPTER_MODEL_NAME_LEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">model_descr</span><span class="p">[</span><span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">nports</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bfa_get_adapter_model</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>
	<span class="n">nports</span> <span class="o">=</span> <span class="n">bfa_get_nports</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-425&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 4Gbps PCIe dual port FC HBA&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-825&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 8Gbps PCIe dual port FC HBA&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-42B&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 4Gbps PCIe dual port FC HBA for HP&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-82B&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 8Gbps PCIe dual port FC HBA for HP&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-1010&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 10Gbps single port CNA&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-1020&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 10Gbps dual port CNA&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-1007&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 10Gbps CNA for IBM Blade Center&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-415&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 4Gbps PCIe single port FC HBA&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-815&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 8Gbps PCIe single port FC HBA&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-41B&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 4Gbps PCIe single port FC HBA for HP&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-81B&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 8Gbps PCIe single port FC HBA for HP&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-804&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 8Gbps FC HBA for HP Bladesystem C-class&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-1741&quot;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Brocade 10Gbps CNA for Dell M-Series Blade Servers&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Brocade-1860&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nports</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">bfa_ioc_is_cna</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">.</span><span class="n">ioc</span><span class="p">))</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
				<span class="s">&quot;Brocade 10Gbps single port CNA&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nports</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bfa_ioc_is_cna</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">.</span><span class="n">ioc</span><span class="p">))</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
				<span class="s">&quot;Brocade 16Gbps PCIe single port FC HBA&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nports</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">bfa_ioc_is_cna</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">.</span><span class="n">ioc</span><span class="p">))</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
				<span class="s">&quot;Brocade 10Gbps dual port CNA&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nports</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bfa_ioc_is_cna</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">.</span><span class="n">ioc</span><span class="p">))</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
				<span class="s">&quot;Brocade 16Gbps PCIe dual port FC HBA&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">model_descr</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_DESCR_LEN</span><span class="p">,</span>
			<span class="s">&quot;Invalid Model&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">model_descr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bfad_im_node_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_port_s</span>    <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u64</span>        <span class="n">nwwn</span><span class="p">;</span>

	<span class="n">nwwn</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_nwwn</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs_port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">nwwn</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bfad_im_symbolic_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_lport_attr_s</span> <span class="n">port_attr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">symname</span><span class="p">[</span><span class="n">BFA_SYMNAME_MAXLEN</span><span class="p">];</span>

	<span class="n">bfa_fcs_lport_get_attr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa_fcs</span><span class="p">.</span><span class="n">fabric</span><span class="p">.</span><span class="n">bport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_attr</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">symname</span><span class="p">,</span> <span class="n">port_attr</span><span class="p">.</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">sym_name</span><span class="p">.</span><span class="n">symname</span><span class="p">,</span>
			<span class="n">BFA_SYMNAME_MAXLEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">symname</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bfad_im_hw_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">hw_ver</span><span class="p">[</span><span class="n">BFA_VERSION_LEN</span><span class="p">];</span>

	<span class="n">bfa_get_pci_chip_rev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">hw_ver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_ver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bfad_im_drv_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BFAD_DRIVER_VERSION</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bfad_im_optionrom_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">optrom_ver</span><span class="p">[</span><span class="n">BFA_VERSION_LEN</span><span class="p">];</span>

	<span class="n">bfa_get_adapter_optrom_ver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">optrom_ver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">optrom_ver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bfad_im_fw_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">fw_ver</span><span class="p">[</span><span class="n">BFA_VERSION_LEN</span><span class="p">];</span>

	<span class="n">bfa_get_adapter_fw_ver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fw_ver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_ver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bfad_im_num_of_ports_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bfa_get_nports</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bfad_im_drv_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BFAD_DRIVER_NAME</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bfad_im_num_of_discovered_ports_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="n">im_port</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_im_port_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_port_s</span>    <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span>         <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">im_port</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">int</span>        <span class="n">nrports</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="n">wwn_t</span>          <span class="o">*</span><span class="n">rports</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>

	<span class="n">rports</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">wwn_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">nrports</span> <span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rports</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_get_rports</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs_port</span><span class="p">,</span> <span class="n">rports</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nrports</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rports</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nrports</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>          <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">serial_number</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">bfad_im_serial_num_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span>          <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bfad_im_model_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span>          <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">model_description</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">bfad_im_model_desc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span>          <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bfad_im_node_name_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span>          <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">symbolic_name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">bfad_im_symbolic_name_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span>          <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">hardware_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">bfad_im_hw_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span>          <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">driver_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">bfad_im_drv_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span>          <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">option_rom_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">bfad_im_optionrom_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span>          <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">firmware_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">bfad_im_fw_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span>          <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">number_of_ports</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">bfad_im_num_of_ports_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span>          <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">driver_name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bfad_im_drv_name_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span>          <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">number_of_discovered_ports</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">bfad_im_num_of_discovered_ports_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">bfad_im_host_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_serial_number</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_model</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_model_description</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_node_name</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_symbolic_name</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hardware_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_driver_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_option_rom_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_firmware_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_number_of_ports</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_driver_name</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_number_of_discovered_ports</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">bfad_im_vport_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_serial_number</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_model</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_model_description</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_node_name</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_symbolic_name</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hardware_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_driver_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_option_rom_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_firmware_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_number_of_ports</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_driver_name</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_number_of_discovered_ports</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
