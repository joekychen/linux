<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › bfa › bfa_svc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bfa_svc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2010 Brocade Communications Systems, Inc.</span>
<span class="cm"> * All rights reserved</span>
<span class="cm"> * www.brocade.com</span>
<span class="cm"> *</span>
<span class="cm"> * Linux driver for Brocade Fibre Channel Host Bus Adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License (GPL) Version 2 as</span>
<span class="cm"> * published by the Free Software Foundation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;bfad_drv.h&quot;</span>
<span class="cp">#include &quot;bfad_im.h&quot;</span>
<span class="cp">#include &quot;bfa_plog.h&quot;</span>
<span class="cp">#include &quot;bfa_cs.h&quot;</span>
<span class="cp">#include &quot;bfa_modules.h&quot;</span>

<span class="n">BFA_TRC_FILE</span><span class="p">(</span><span class="n">HAL</span><span class="p">,</span> <span class="n">FCXP</span><span class="p">);</span>
<span class="n">BFA_MODULE</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">);</span>
<span class="n">BFA_MODULE</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
<span class="n">BFA_MODULE</span><span class="p">(</span><span class="n">sgpg</span><span class="p">);</span>
<span class="n">BFA_MODULE</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
<span class="n">BFA_MODULE</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
<span class="n">BFA_MODULE</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
<span class="n">BFA_MODULE</span><span class="p">(</span><span class="n">uf</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * LPS related definitions</span>
<span class="cm"> */</span>
<span class="cp">#define BFA_LPS_MIN_LPORTS      (1)</span>
<span class="cp">#define BFA_LPS_MAX_LPORTS      (256)</span>

<span class="cm">/*</span>
<span class="cm"> * Maximum Vports supported per physical port or vf.</span>
<span class="cm"> */</span>
<span class="cp">#define BFA_LPS_MAX_VPORTS_SUPP_CB  255</span>
<span class="cp">#define BFA_LPS_MAX_VPORTS_SUPP_CT  190</span>


<span class="cm">/*</span>
<span class="cm"> * FC PORT related definitions</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * The port is considered disabled if corresponding physical port or IOC are</span>
<span class="cm"> * disabled explicitly</span>
<span class="cm"> */</span>
<span class="cp">#define BFA_PORT_IS_DISABLED(bfa) \</span>
<span class="cp">	((bfa_fcport_is_disabled(bfa) == BFA_TRUE) || \</span>
<span class="cp">	(bfa_ioc_is_disabled(&amp;bfa-&gt;ioc) == BFA_TRUE))</span>

<span class="cm">/*</span>
<span class="cm"> * BFA port state machine events</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="p">{</span>
	<span class="n">BFA_FCPORT_SM_START</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/*  start port state machine	*/</span>
	<span class="n">BFA_FCPORT_SM_STOP</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/*  stop port state machine	*/</span>
	<span class="n">BFA_FCPORT_SM_ENABLE</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="cm">/*  enable port		*/</span>
	<span class="n">BFA_FCPORT_SM_DISABLE</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/*  disable port state machine */</span>
	<span class="n">BFA_FCPORT_SM_FWRSP</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/*  firmware enable/disable rsp */</span>
	<span class="n">BFA_FCPORT_SM_LINKUP</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	<span class="cm">/*  firmware linkup event	*/</span>
	<span class="n">BFA_FCPORT_SM_LINKDOWN</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>	<span class="cm">/*  firmware linkup down	*/</span>
	<span class="n">BFA_FCPORT_SM_QRESUME</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/*  CQ space available	*/</span>
	<span class="n">BFA_FCPORT_SM_HWFAIL</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>	<span class="cm">/*  IOC h/w failure		*/</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * BFA port link notification state machine events</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="p">{</span>
	<span class="n">BFA_FCPORT_LN_SM_LINKUP</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/*  linkup event	*/</span>
	<span class="n">BFA_FCPORT_LN_SM_LINKDOWN</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/*  linkdown event	*/</span>
	<span class="n">BFA_FCPORT_LN_SM_NOTIFICATION</span>	<span class="o">=</span> <span class="mi">3</span>	<span class="cm">/*  done notification	*/</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * RPORT related definitions</span>
<span class="cm"> */</span>
<span class="cp">#define bfa_rport_offline_cb(__rp) do {					\</span>
<span class="cp">	if ((__rp)-&gt;bfa-&gt;fcs)						\</span>
<span class="cp">		bfa_cb_rport_offline((__rp)-&gt;rport_drv);      \</span>
<span class="cp">	else {								\</span>
<span class="cp">		bfa_cb_queue((__rp)-&gt;bfa, &amp;(__rp)-&gt;hcb_qe,		\</span>
<span class="cp">				__bfa_cb_rport_offline, (__rp));      \</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bfa_rport_online_cb(__rp) do {					\</span>
<span class="cp">	if ((__rp)-&gt;bfa-&gt;fcs)						\</span>
<span class="cp">		bfa_cb_rport_online((__rp)-&gt;rport_drv);      \</span>
<span class="cp">	else {								\</span>
<span class="cp">		bfa_cb_queue((__rp)-&gt;bfa, &amp;(__rp)-&gt;hcb_qe,		\</span>
<span class="cp">				  __bfa_cb_rport_online, (__rp));      \</span>
<span class="cp">		}							\</span>
<span class="cp">} while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * forward declarations FCXP related functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">__bfa_fcxp_send_cbfn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">hal_fcxp_rx_plog</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfi_fcxp_send_rsp_s</span> <span class="o">*</span><span class="n">fcxp_rsp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">hal_fcxp_tx_plog</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reqlen</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcxp_qresume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcxp_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfi_fcxp_send_req_s</span> <span class="o">*</span><span class="n">send_req</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * forward declarations for LPS functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_meminfo_s</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_login_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfi_lps_login_rsp_s</span> <span class="o">*</span><span class="n">rsp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_no_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">first_lps</span><span class="p">,</span> <span class="n">u8</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_logout_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfi_lps_logout_rsp_s</span> <span class="o">*</span><span class="n">rsp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_reqq_resume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lps_arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_send_login</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_send_logout</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_send_set_n2n_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_login_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_logout_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_cvl_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * forward declaration for LPS state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_sm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_sm_login</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_sm_loginwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span>
					<span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_sm_online_n2n_pid_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_lps_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_sm_logout</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_lps_sm_logowait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span>
					<span class="n">event</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * forward declaration for FC Port functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span> <span class="n">bfa_fcport_send_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span> <span class="n">bfa_fcport_send_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_fcport_update_linkinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_fcport_reset_linkinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_fcport_set_wwns</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__bfa_cb_fcport_event</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_fcport_scn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_port_linkstate</span> <span class="n">event</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">trunk</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_fcport_queue_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bfa_port_linkstate</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__bfa_cb_fcport_stats_clr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_fcport_stats_get_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_fcport_stats_clr_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_trunk_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * forward declaration for FC PORT state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_sm_enabling_qwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_sm_enabling</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_sm_linkdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_sm_linkup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_sm_disabling</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_sm_disabling_qwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_sm_toggling_qwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_sm_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_sm_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_sm_iocdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_sm_iocfail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_ln_sm_dn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_ln_sm_dn_nf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_ln_sm_dn_up_nf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_ln_sm_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_ln_sm_up_nf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_ln_sm_up_dn_nf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcport_ln_sm_up_dn_up_nf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_sm_table_s</span> <span class="n">hal_port_sm_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcport_sm_uninit</span><span class="p">),</span> <span class="n">BFA_PORT_ST_UNINIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcport_sm_enabling_qwait</span><span class="p">),</span> <span class="n">BFA_PORT_ST_ENABLING_QWAIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcport_sm_enabling</span><span class="p">),</span> <span class="n">BFA_PORT_ST_ENABLING</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcport_sm_linkdown</span><span class="p">),</span> <span class="n">BFA_PORT_ST_LINKDOWN</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcport_sm_linkup</span><span class="p">),</span> <span class="n">BFA_PORT_ST_LINKUP</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcport_sm_disabling_qwait</span><span class="p">),</span> <span class="n">BFA_PORT_ST_DISABLING_QWAIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcport_sm_toggling_qwait</span><span class="p">),</span> <span class="n">BFA_PORT_ST_TOGGLING_QWAIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcport_sm_disabling</span><span class="p">),</span> <span class="n">BFA_PORT_ST_DISABLING</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcport_sm_disabled</span><span class="p">),</span> <span class="n">BFA_PORT_ST_DISABLED</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcport_sm_stopped</span><span class="p">),</span> <span class="n">BFA_PORT_ST_STOPPED</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcport_sm_iocdown</span><span class="p">),</span> <span class="n">BFA_PORT_ST_IOCDOWN</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcport_sm_iocfail</span><span class="p">),</span> <span class="n">BFA_PORT_ST_IOCDOWN</span><span class="p">},</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * forward declaration for RPORT related functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">bfa_rport_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_mod_s</span> <span class="o">*</span><span class="n">rp_mod</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">bfa_rport_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span>	<span class="n">bfa_rport_send_fwcreate</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span>	<span class="n">bfa_rport_send_fwdelete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span>	<span class="n">bfa_rport_send_fwspeed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">__bfa_cb_rport_online</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
						<span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">__bfa_cb_rport_offline</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
						<span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * forward declaration for RPORT state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_created</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_fwcreate</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_fwdelete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_deleting</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_offline_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_delete_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_fwcreate_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_fwdelete_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_rport_sm_deleting_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * PLOG related definitions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">plkd_validate_logrec</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_rec_s</span> <span class="o">*</span><span class="n">pl_rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pl_rec</span><span class="o">-&gt;</span><span class="n">log_type</span> <span class="o">!=</span> <span class="n">BFA_PL_LOG_TYPE_INT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">pl_rec</span><span class="o">-&gt;</span><span class="n">log_type</span> <span class="o">!=</span> <span class="n">BFA_PL_LOG_TYPE_STRING</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pl_rec</span><span class="o">-&gt;</span><span class="n">log_type</span> <span class="o">!=</span> <span class="n">BFA_PL_LOG_TYPE_INT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">pl_rec</span><span class="o">-&gt;</span><span class="n">log_num_ints</span> <span class="o">&gt;</span> <span class="n">BFA_PL_INT_LOG_SZ</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span>
<span class="nf">bfa_get_log_time</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">system_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>

	<span class="cm">/* We are interested in seconds only. */</span>
	<span class="n">system_time</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">system_time</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_plog_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_s</span> <span class="o">*</span><span class="n">plog</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_plog_rec_s</span> <span class="o">*</span><span class="n">pl_rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_plog_rec_s</span> <span class="o">*</span><span class="n">pl_recp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plog</span><span class="o">-&gt;</span><span class="n">plog_enabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plkd_validate_logrec</span><span class="p">(</span><span class="n">pl_rec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tail</span> <span class="o">=</span> <span class="n">plog</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>

	<span class="n">pl_recp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">plog</span><span class="o">-&gt;</span><span class="n">plog_recs</span><span class="p">[</span><span class="n">tail</span><span class="p">]);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pl_recp</span><span class="p">,</span> <span class="n">pl_rec</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_rec_s</span><span class="p">));</span>

	<span class="n">pl_recp</span><span class="o">-&gt;</span><span class="n">tv</span> <span class="o">=</span> <span class="n">bfa_get_log_time</span><span class="p">();</span>
	<span class="n">BFA_PL_LOG_REC_INCR</span><span class="p">(</span><span class="n">plog</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plog</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">plog</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span>
		<span class="n">BFA_PL_LOG_REC_INCR</span><span class="p">(</span><span class="n">plog</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_plog_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_s</span> <span class="o">*</span><span class="n">plog</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">plog</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_s</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">plog</span><span class="o">-&gt;</span><span class="n">plog_sig</span><span class="p">,</span> <span class="n">BFA_PL_SIG_STR</span><span class="p">,</span> <span class="n">BFA_PL_SIG_LEN</span><span class="p">);</span>
	<span class="n">plog</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">plog</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plog</span><span class="o">-&gt;</span><span class="n">plog_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_plog_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_s</span> <span class="o">*</span><span class="n">plog</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_plog_mid</span> <span class="n">mid</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">bfa_plog_eid</span> <span class="n">event</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">misc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">log_str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_plog_rec_s</span>  <span class="n">lp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plog</span><span class="o">-&gt;</span><span class="n">plog_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_rec_s</span><span class="p">));</span>
		<span class="n">lp</span><span class="p">.</span><span class="n">mid</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
		<span class="n">lp</span><span class="p">.</span><span class="n">eid</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
		<span class="n">lp</span><span class="p">.</span><span class="n">log_type</span> <span class="o">=</span> <span class="n">BFA_PL_LOG_TYPE_STRING</span><span class="p">;</span>
		<span class="n">lp</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span> <span class="n">misc</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">lp</span><span class="p">.</span><span class="n">log_entry</span><span class="p">.</span><span class="n">string_log</span><span class="p">,</span> <span class="n">log_str</span><span class="p">,</span>
			<span class="n">BFA_PL_STRING_LOG_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">lp</span><span class="p">.</span><span class="n">log_entry</span><span class="p">.</span><span class="n">string_log</span><span class="p">[</span><span class="n">BFA_PL_STRING_LOG_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">bfa_plog_add</span><span class="p">(</span><span class="n">plog</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_plog_intarr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_s</span> <span class="o">*</span><span class="n">plog</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_plog_mid</span> <span class="n">mid</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">bfa_plog_eid</span> <span class="n">event</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">misc</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">intarr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num_ints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_plog_rec_s</span>  <span class="n">lp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_ints</span> <span class="o">&gt;</span> <span class="n">BFA_PL_INT_LOG_SZ</span><span class="p">)</span>
		<span class="n">num_ints</span> <span class="o">=</span> <span class="n">BFA_PL_INT_LOG_SZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plog</span><span class="o">-&gt;</span><span class="n">plog_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_rec_s</span><span class="p">));</span>
		<span class="n">lp</span><span class="p">.</span><span class="n">mid</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
		<span class="n">lp</span><span class="p">.</span><span class="n">eid</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
		<span class="n">lp</span><span class="p">.</span><span class="n">log_type</span> <span class="o">=</span> <span class="n">BFA_PL_LOG_TYPE_INT</span><span class="p">;</span>
		<span class="n">lp</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span> <span class="n">misc</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_ints</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">lp</span><span class="p">.</span><span class="n">log_entry</span><span class="p">.</span><span class="n">int_log</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">intarr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">lp</span><span class="p">.</span><span class="n">log_num_ints</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">num_ints</span><span class="p">;</span>

		<span class="n">bfa_plog_add</span><span class="p">(</span><span class="n">plog</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_plog_fchdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_s</span> <span class="o">*</span><span class="n">plog</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_plog_mid</span> <span class="n">mid</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_plog_eid</span> <span class="n">event</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">misc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">fchdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_plog_rec_s</span>  <span class="n">lp</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="o">*</span><span class="n">tmp_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">fchdr</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">ints</span><span class="p">[</span><span class="n">BFA_PL_INT_LOG_SZ</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plog</span><span class="o">-&gt;</span><span class="n">plog_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_rec_s</span><span class="p">));</span>

		<span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_int</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_int</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_int</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

		<span class="n">bfa_plog_intarr</span><span class="p">(</span><span class="n">plog</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">misc</span><span class="p">,</span> <span class="n">ints</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_plog_fchdr_and_pl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_s</span> <span class="o">*</span><span class="n">plog</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_plog_mid</span> <span class="n">mid</span><span class="p">,</span>
		      <span class="k">enum</span> <span class="n">bfa_plog_eid</span> <span class="n">event</span><span class="p">,</span> <span class="n">u16</span> <span class="n">misc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">fchdr</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">pld_w0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_plog_rec_s</span>  <span class="n">lp</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="o">*</span><span class="n">tmp_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">fchdr</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">ints</span><span class="p">[</span><span class="n">BFA_PL_INT_LOG_SZ</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plog</span><span class="o">-&gt;</span><span class="n">plog_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_plog_rec_s</span><span class="p">));</span>

		<span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_int</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_int</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_int</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pld_w0</span><span class="p">;</span>

		<span class="n">bfa_plog_intarr</span><span class="p">(</span><span class="n">plog</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">misc</span><span class="p">,</span> <span class="n">ints</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  fcxp_pvt BFA FCXP private functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claim_fcxps_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_fcxps</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_free_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_active_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_unused_q</span><span class="p">);</span>

	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_list</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_fcxps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_mod</span> <span class="o">=</span> <span class="n">mod</span><span class="p">;</span>
		<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_free_q</span><span class="p">);</span>
		<span class="n">bfa_reqq_winit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">reqq_wqe</span><span class="p">,</span> <span class="n">bfa_fcxp_qresume</span><span class="p">,</span> <span class="n">fcxp</span><span class="p">);</span>
		<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">reqq_waiting</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

		<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fcxp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcxp_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_meminfo_s</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">fcxp_mod</span> <span class="o">=</span> <span class="n">BFA_FCXP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_kva_s</span> <span class="o">*</span><span class="n">fcxp_kva</span> <span class="o">=</span> <span class="n">BFA_MEM_FCXP_KVA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">seg_ptr</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">nsegs</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">per_seg_fcxp</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">num_fcxps</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fcxp_reqs</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">per_fcxp_sz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_fcxps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">min_cfg</span><span class="p">)</span>
		<span class="n">per_fcxp_sz</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">BFA_FCXP_MAX_IBUF_SZ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">per_fcxp_sz</span> <span class="o">=</span> <span class="n">BFA_FCXP_MAX_IBUF_SZ</span> <span class="o">+</span> <span class="n">BFA_FCXP_MAX_LBUF_SZ</span><span class="p">;</span>

	<span class="cm">/* dma memory */</span>
	<span class="n">nsegs</span> <span class="o">=</span> <span class="n">BFI_MEM_DMA_NSEGS</span><span class="p">(</span><span class="n">num_fcxps</span><span class="p">,</span> <span class="n">per_fcxp_sz</span><span class="p">);</span>
	<span class="n">per_seg_fcxp</span> <span class="o">=</span> <span class="n">BFI_MEM_NREQS_SEG</span><span class="p">(</span><span class="n">per_fcxp_sz</span><span class="p">);</span>

	<span class="n">bfa_mem_dma_seg_iter</span><span class="p">(</span><span class="n">fcxp_mod</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span> <span class="n">nsegs</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_fcxps</span> <span class="o">&gt;=</span> <span class="n">per_seg_fcxp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">num_fcxps</span> <span class="o">-=</span> <span class="n">per_seg_fcxp</span><span class="p">;</span>
			<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span>
				<span class="n">per_seg_fcxp</span> <span class="o">*</span> <span class="n">per_fcxp_sz</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span>
				<span class="n">num_fcxps</span> <span class="o">*</span> <span class="n">per_fcxp_sz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* kva memory */</span>
	<span class="n">bfa_mem_kva_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">fcxp_kva</span><span class="p">,</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fcxp_reqs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcxp_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_FCXP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>
	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_fcxps</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fcxp_reqs</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize FCXP request and response payload sizes.</span>
<span class="cm">	 */</span>
	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">req_pld_sz</span> <span class="o">=</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">rsp_pld_sz</span> <span class="o">=</span> <span class="n">BFA_FCXP_MAX_IBUF_SZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">min_cfg</span><span class="p">)</span>
		<span class="n">mod</span><span class="o">-&gt;</span><span class="n">rsp_pld_sz</span> <span class="o">=</span> <span class="n">BFA_FCXP_MAX_LBUF_SZ</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>

	<span class="n">claim_fcxps_mem</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcxp_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcxp_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcxp_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcxp_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_FCXP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	      <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="cm">/* Enqueue unused fcxp resources to free_q */</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_unused_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_free_q</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_active_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcxp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">caller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">send_cbfn</span><span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">,</span> <span class="n">fcxp</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">send_cbarg</span><span class="p">,</span>
					<span class="n">BFA_STATUS_IOC_FAILURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">bfa_fcxp_free</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_IOC_FAILURE</span><span class="p">;</span>
			<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span>
				     <span class="n">__bfa_fcxp_send_cbfn</span><span class="p">,</span> <span class="n">fcxp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span>
<span class="nf">bfa_fcxp_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">fm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fm</span><span class="o">-&gt;</span><span class="n">fcxp_free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcxp</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fm</span><span class="o">-&gt;</span><span class="n">fcxp_active_q</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fcxp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcxp_init_reqrsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span>
	       <span class="n">u8</span> <span class="o">*</span><span class="n">use_ibuf</span><span class="p">,</span>
	       <span class="n">u32</span> <span class="o">*</span><span class="n">nr_sgles</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sgaddr_t</span> <span class="o">*</span><span class="n">r_sga_cbfn</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sglen_t</span> <span class="o">*</span><span class="n">r_sglen_cbfn</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">r_sgpg_q</span><span class="p">,</span>
	       <span class="kt">int</span> <span class="n">n_sgles</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sgaddr_t</span> <span class="n">sga_cbfn</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sglen_t</span> <span class="n">sglen_cbfn</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">bfa</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_sgles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">use_ibuf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">*</span><span class="n">sga_cbfn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">*</span><span class="n">sglen_cbfn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="o">*</span><span class="n">use_ibuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">r_sga_cbfn</span> <span class="o">=</span> <span class="n">sga_cbfn</span><span class="p">;</span>
		<span class="o">*</span><span class="n">r_sglen_cbfn</span> <span class="o">=</span> <span class="n">sglen_cbfn</span><span class="p">;</span>

		<span class="o">*</span><span class="n">nr_sgles</span> <span class="o">=</span> <span class="n">n_sgles</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * alloc required sgpgs</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n_sgles</span> <span class="o">&gt;</span> <span class="n">BFI_SGE_INLINE</span><span class="p">)</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcxp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
	       <span class="kt">void</span> <span class="o">*</span><span class="n">caller</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nreq_sgles</span><span class="p">,</span>
	       <span class="kt">int</span> <span class="n">nrsp_sgles</span><span class="p">,</span> <span class="n">bfa_fcxp_get_sgaddr_t</span> <span class="n">req_sga_cbfn</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sglen_t</span> <span class="n">req_sglen_cbfn</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sgaddr_t</span> <span class="n">rsp_sga_cbfn</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sglen_t</span> <span class="n">rsp_sglen_cbfn</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">bfa</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span><span class="p">);</span>

	<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">caller</span> <span class="o">=</span> <span class="n">caller</span><span class="p">;</span>

	<span class="n">bfa_fcxp_init_reqrsp</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="n">bfa</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">use_ireqbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">nreq_sgles</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">req_sga_cbfn</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">req_sglen_cbfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">req_sgpg_q</span><span class="p">,</span>
		<span class="n">nreq_sgles</span><span class="p">,</span> <span class="n">req_sga_cbfn</span><span class="p">,</span> <span class="n">req_sglen_cbfn</span><span class="p">);</span>

	<span class="n">bfa_fcxp_init_reqrsp</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="n">bfa</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">use_irspbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">nrsp_sgles</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_sga_cbfn</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_sglen_cbfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_sgpg_q</span><span class="p">,</span>
		<span class="n">nrsp_sgles</span><span class="p">,</span> <span class="n">rsp_sga_cbfn</span><span class="p">,</span> <span class="n">rsp_sglen_cbfn</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcxp_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_mod</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_wqe_s</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>

	<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wqe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wqe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span><span class="p">);</span>

		<span class="n">bfa_fcxp_init</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">,</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nreq_sgles</span><span class="p">,</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nrsp_sgles</span><span class="p">,</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">req_sga_cbfn</span><span class="p">,</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">req_sglen_cbfn</span><span class="p">,</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">rsp_sga_cbfn</span><span class="p">,</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">rsp_sglen_cbfn</span><span class="p">);</span>

		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">alloc_cbfn</span><span class="p">(</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">alloc_cbarg</span><span class="p">,</span> <span class="n">fcxp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bfa_q_is_on_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_active_q</span><span class="p">,</span> <span class="n">fcxp</span><span class="p">));</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_free_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcxp_null_comp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfad_fcxp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
		   <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* discarded fcxp completion */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_fcxp_send_cbfn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">send_cbfn</span><span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">,</span> <span class="n">fcxp</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">send_cbarg</span><span class="p">,</span>
				<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_status</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_len</span><span class="p">,</span>
				<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">residue_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_fchs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bfa_fcxp_free</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hal_fcxp_send_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_fcxp_send_rsp_s</span> <span class="o">*</span><span class="n">fcxp_rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_FCXP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span>	<span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">fcxp_tag</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcxp_tag</span><span class="p">);</span>

	<span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">rsp_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">rsp_len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * @todo f/w should not set residue to non-0 when everything</span>
<span class="cm">	 *	 is received.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">req_status</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
		<span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">residue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">residue_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">residue_len</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">BFA_FCXP_FROM_TAG</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">fcxp_tag</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">send_cbfn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">hal_fcxp_rx_plog</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcxp</span><span class="p">,</span> <span class="n">fcxp_rsp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">send_cbfn</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">caller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">send_cbfn</span><span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">,</span> <span class="n">fcxp</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">send_cbarg</span><span class="p">,</span>
					<span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="p">,</span> <span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">rsp_len</span><span class="p">,</span>
					<span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">residue_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">fchs</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * fcxp automatically freed on return from the callback</span>
<span class="cm">			 */</span>
			<span class="n">bfa_fcxp_free</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_status</span> <span class="o">=</span> <span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="p">;</span>
			<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_len</span> <span class="o">=</span> <span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">rsp_len</span><span class="p">;</span>
			<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">residue_len</span> <span class="o">=</span> <span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">residue_len</span><span class="p">;</span>
			<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_fchs</span> <span class="o">=</span> <span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">fchs</span><span class="p">;</span>

			<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span>
					<span class="n">__bfa_fcxp_send_cbfn</span><span class="p">,</span> <span class="n">fcxp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">send_cbfn</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hal_fcxp_tx_plog</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reqlen</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * TODO: TX ox_id</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reqlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">use_ireqbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">pld_w0</span> <span class="o">=</span>
				<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_REQ_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">));</span>

			<span class="n">bfa_plog_fchdr_and_pl</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL_FCXP</span><span class="p">,</span>
					<span class="n">BFA_PL_EID_TX</span><span class="p">,</span>
					<span class="n">reqlen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fchs_s</span><span class="p">),</span> <span class="n">fchs</span><span class="p">,</span>
					<span class="n">pld_w0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_plog_fchdr</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL_FCXP</span><span class="p">,</span>
					<span class="n">BFA_PL_EID_TX</span><span class="p">,</span>
					<span class="n">reqlen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fchs_s</span><span class="p">),</span>
					<span class="n">fchs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bfa_plog_fchdr</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL_FCXP</span><span class="p">,</span> <span class="n">BFA_PL_EID_TX</span><span class="p">,</span>
			       <span class="n">reqlen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fchs_s</span><span class="p">),</span> <span class="n">fchs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hal_fcxp_rx_plog</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">bfi_fcxp_send_rsp_s</span> <span class="o">*</span><span class="n">fcxp_rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">rsp_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">use_irspbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">pld_w0</span> <span class="o">=</span>
				<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">));</span>

			<span class="n">bfa_plog_fchdr_and_pl</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL_FCXP</span><span class="p">,</span>
					      <span class="n">BFA_PL_EID_RX</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">rsp_len</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">pld_w0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_plog_fchdr</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL_FCXP</span><span class="p">,</span>
				       <span class="n">BFA_PL_EID_RX</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">rsp_len</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">fchs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bfa_plog_fchdr</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL_FCXP</span><span class="p">,</span> <span class="n">BFA_PL_EID_RX</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">rsp_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp_rsp</span><span class="o">-&gt;</span><span class="n">fchs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handler to resume sending fcxp when space in available in cpe queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcxp_qresume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span>		<span class="o">*</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>			<span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_mod</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_fcxp_send_req_s</span>	<span class="o">*</span><span class="n">send_req</span><span class="p">;</span>

	<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">reqq_waiting</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">send_req</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_FCXP</span><span class="p">);</span>
	<span class="n">bfa_fcxp_queue</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="n">send_req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Queue fcxp send request to foimrware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcxp_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_fcxp_send_req_s</span> <span class="o">*</span><span class="n">send_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>			<span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_mod</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_req_info_s</span>	<span class="o">*</span><span class="n">reqi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">req_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_rsp_info_s</span>	<span class="o">*</span><span class="n">rspi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span>		<span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">reqi</span><span class="o">-&gt;</span><span class="n">bfa_rport</span><span class="p">;</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">send_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_FCXP</span><span class="p">,</span> <span class="n">BFI_FCXP_H2I_SEND_REQ</span><span class="p">,</span>
		    <span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">bfa</span><span class="p">));</span>

	<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">rport_fw_hndl</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
		<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">max_frmsz</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">max_frmsz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">send_req</span><span class="o">-&gt;</span><span class="n">max_frmsz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">max_frmsz</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FC_MAX_PDUSZ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">rport_fw_hndl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">max_frmsz</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FC_MAX_PDUSZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">vf_id</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">reqi</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">);</span>
	<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">lp_fwtag</span> <span class="o">=</span> <span class="n">bfa_lps_get_fwtag</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">reqi</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">);</span>
	<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">reqi</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">;</span>
	<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">rsp_timeout</span> <span class="o">=</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">rsp_timeout</span><span class="p">;</span>
	<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">reqi</span><span class="o">-&gt;</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">fchs</span> <span class="o">=</span> <span class="n">reqi</span><span class="o">-&gt;</span><span class="n">fchs</span><span class="p">;</span>

	<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">req_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">reqi</span><span class="o">-&gt;</span><span class="n">req_tot_len</span><span class="p">);</span>
	<span class="n">send_req</span><span class="o">-&gt;</span><span class="n">rsp_maxlen</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">rsp_maxlen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * setup req sgles</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">use_ireqbuf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_alen_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_req</span><span class="o">-&gt;</span><span class="n">req_alen</span><span class="p">,</span> <span class="n">reqi</span><span class="o">-&gt;</span><span class="n">req_tot_len</span><span class="p">,</span>
					<span class="n">BFA_FCXP_REQ_PLD_PA</span><span class="p">(</span><span class="n">fcxp</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">nreq_sgles</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">nreq_sgles</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">bfa_alen_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_req</span><span class="o">-&gt;</span><span class="n">req_alen</span><span class="p">,</span> <span class="n">reqi</span><span class="o">-&gt;</span><span class="n">req_tot_len</span><span class="p">,</span>
				<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">req_sga_cbfn</span><span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">reqi</span><span class="o">-&gt;</span><span class="n">req_tot_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">bfa_alen_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_req</span><span class="o">-&gt;</span><span class="n">rsp_alen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * setup rsp sgles</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">use_irspbuf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">rsp_maxlen</span> <span class="o">&gt;</span> <span class="n">BFA_FCXP_MAX_LBUF_SZ</span><span class="p">);</span>

		<span class="n">bfa_alen_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_req</span><span class="o">-&gt;</span><span class="n">rsp_alen</span><span class="p">,</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">rsp_maxlen</span><span class="p">,</span>
					<span class="n">BFA_FCXP_RSP_PLD_PA</span><span class="p">(</span><span class="n">fcxp</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">nrsp_sgles</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">nrsp_sgles</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">bfa_alen_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_req</span><span class="o">-&gt;</span><span class="n">rsp_alen</span><span class="p">,</span> <span class="n">rspi</span><span class="o">-&gt;</span><span class="n">rsp_maxlen</span><span class="p">,</span>
				<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_sga_cbfn</span><span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rspi</span><span class="o">-&gt;</span><span class="n">rsp_maxlen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">bfa_alen_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_req</span><span class="o">-&gt;</span><span class="n">rsp_alen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hal_fcxp_tx_plog</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">reqi</span><span class="o">-&gt;</span><span class="n">req_tot_len</span><span class="p">,</span> <span class="n">fcxp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reqi</span><span class="o">-&gt;</span><span class="n">fchs</span><span class="p">);</span>

	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_FCXP</span><span class="p">,</span> <span class="n">send_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_reqq_pi</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_FCXP</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_reqq_ci</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_FCXP</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate an FCXP instance to send a response or to send a request</span>
<span class="cm"> * that has a response. Request/response buffers are allocated by caller.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	bfa		BFA bfa instance</span>
<span class="cm"> * @param[in]	nreq_sgles	Number of SG elements required for request</span>
<span class="cm"> *				buffer. 0, if fcxp internal buffers are	used.</span>
<span class="cm"> *				Use bfa_fcxp_get_reqbuf() to get the</span>
<span class="cm"> *				internal req buffer.</span>
<span class="cm"> * @param[in]	req_sgles	SG elements describing request buffer. Will be</span>
<span class="cm"> *				copied in by BFA and hence can be freed on</span>
<span class="cm"> *				return from this function.</span>
<span class="cm"> * @param[in]	get_req_sga	function ptr to be called to get a request SG</span>
<span class="cm"> *				Address (given the sge index).</span>
<span class="cm"> * @param[in]	get_req_sglen	function ptr to be called to get a request SG</span>
<span class="cm"> *				len (given the sge index).</span>
<span class="cm"> * @param[in]	get_rsp_sga	function ptr to be called to get a response SG</span>
<span class="cm"> *				Address (given the sge index).</span>
<span class="cm"> * @param[in]	get_rsp_sglen	function ptr to be called to get a response SG</span>
<span class="cm"> *				len (given the sge index).</span>
<span class="cm"> *</span>
<span class="cm"> * @return FCXP instance. NULL on failure.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span>
<span class="nf">bfa_fcxp_alloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">caller</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nreq_sgles</span><span class="p">,</span>
	       <span class="kt">int</span> <span class="n">nrsp_sgles</span><span class="p">,</span> <span class="n">bfa_fcxp_get_sgaddr_t</span> <span class="n">req_sga_cbfn</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sglen_t</span> <span class="n">req_sglen_cbfn</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sgaddr_t</span> <span class="n">rsp_sga_cbfn</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sglen_t</span> <span class="n">rsp_sglen_cbfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">bfa</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcxp_get</span><span class="p">(</span><span class="n">BFA_FCXP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcxp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span><span class="p">);</span>

	<span class="n">bfa_fcxp_init</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="n">caller</span><span class="p">,</span> <span class="n">bfa</span><span class="p">,</span> <span class="n">nreq_sgles</span><span class="p">,</span> <span class="n">nrsp_sgles</span><span class="p">,</span> <span class="n">req_sga_cbfn</span><span class="p">,</span>
			<span class="n">req_sglen_cbfn</span><span class="p">,</span> <span class="n">rsp_sga_cbfn</span><span class="p">,</span> <span class="n">rsp_sglen_cbfn</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fcxp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the internal request buffer pointer</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	fcxp	BFA fcxp pointer</span>
<span class="cm"> *</span>
<span class="cm"> * @return		pointer to the internal request buffer</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_mod</span><span class="p">;</span>
	<span class="kt">void</span>	<span class="o">*</span><span class="n">reqbuf</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">use_ireqbuf</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">reqbuf</span> <span class="o">=</span> <span class="n">bfa_mem_get_dmabuf_kva</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span><span class="p">,</span>
				<span class="n">mod</span><span class="o">-&gt;</span><span class="n">req_pld_sz</span> <span class="o">+</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">rsp_pld_sz</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">reqbuf</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span>
<span class="nf">bfa_fcxp_get_reqbufsz</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_mod</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">req_pld_sz</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the internal response buffer pointer</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	fcxp	BFA fcxp pointer</span>
<span class="cm"> *</span>
<span class="cm"> * @return		pointer to the internal request buffer</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">bfa_fcxp_get_rspbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_mod</span><span class="p">;</span>
	<span class="kt">void</span>	<span class="o">*</span><span class="n">fcxp_buf</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">use_irspbuf</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">fcxp_buf</span> <span class="o">=</span> <span class="n">bfa_mem_get_dmabuf_kva</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span><span class="p">,</span>
				<span class="n">mod</span><span class="o">-&gt;</span><span class="n">req_pld_sz</span> <span class="o">+</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">rsp_pld_sz</span><span class="p">);</span>

	<span class="cm">/* fcxp_buf = req_buf + rsp_buf :- add req_buf_sz to get to rsp_buf */</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">fcxp_buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">req_pld_sz</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free the BFA FCXP</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	fcxp			BFA fcxp pointer</span>
<span class="cm"> *</span>
<span class="cm"> * @return		void</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcxp_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_mod</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fcxp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span><span class="p">);</span>
	<span class="n">bfa_fcxp_put</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a FCXP request</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	fcxp	BFA fcxp pointer</span>
<span class="cm"> * @param[in]	rport	BFA rport pointer. Could be left NULL for WKA rports</span>
<span class="cm"> * @param[in]	vf_id	virtual Fabric ID</span>
<span class="cm"> * @param[in]	lp_tag	lport tag</span>
<span class="cm"> * @param[in]	cts	use Continuous sequence</span>
<span class="cm"> * @param[in]	cos	fc Class of Service</span>
<span class="cm"> * @param[in]	reqlen	request length, does not include FCHS length</span>
<span class="cm"> * @param[in]	fchs	fc Header Pointer. The header content will be copied</span>
<span class="cm"> *			in by BFA.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	cbfn	call back function to be called on receiving</span>
<span class="cm"> *								the response</span>
<span class="cm"> * @param[in]	cbarg	arg for cbfn</span>
<span class="cm"> * @param[in]	rsp_timeout</span>
<span class="cm"> *			response timeout</span>
<span class="cm"> *</span>
<span class="cm"> * @return		bfa_status_t</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcxp_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span>
	      <span class="n">u16</span> <span class="n">vf_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lp_tag</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">cts</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_cos</span> <span class="n">cos</span><span class="p">,</span>
	      <span class="n">u32</span> <span class="n">reqlen</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_cb_fcxp_send_t</span> <span class="n">cbfn</span><span class="p">,</span>
	      <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_maxlen</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rsp_timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>			<span class="o">*</span><span class="n">bfa</span>  <span class="o">=</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_mod</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_req_info_s</span>	<span class="o">*</span><span class="n">reqi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">req_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_rsp_info_s</span>	<span class="o">*</span><span class="n">rspi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">rsp_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_fcxp_send_req_s</span>	<span class="o">*</span><span class="n">send_req</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * setup request/response info</span>
<span class="cm">	 */</span>
	<span class="n">reqi</span><span class="o">-&gt;</span><span class="n">bfa_rport</span> <span class="o">=</span> <span class="n">rport</span><span class="p">;</span>
	<span class="n">reqi</span><span class="o">-&gt;</span><span class="n">vf_id</span> <span class="o">=</span> <span class="n">vf_id</span><span class="p">;</span>
	<span class="n">reqi</span><span class="o">-&gt;</span><span class="n">lp_tag</span> <span class="o">=</span> <span class="n">lp_tag</span><span class="p">;</span>
	<span class="n">reqi</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">cos</span><span class="p">;</span>
	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">rsp_timeout</span> <span class="o">=</span> <span class="n">rsp_timeout</span><span class="p">;</span>
	<span class="n">reqi</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">cts</span><span class="p">;</span>
	<span class="n">reqi</span><span class="o">-&gt;</span><span class="n">fchs</span> <span class="o">=</span> <span class="o">*</span><span class="n">fchs</span><span class="p">;</span>
	<span class="n">reqi</span><span class="o">-&gt;</span><span class="n">req_tot_len</span> <span class="o">=</span> <span class="n">reqlen</span><span class="p">;</span>
	<span class="n">rspi</span><span class="o">-&gt;</span><span class="n">rsp_maxlen</span> <span class="o">=</span> <span class="n">rsp_maxlen</span><span class="p">;</span>
	<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">send_cbfn</span> <span class="o">=</span> <span class="n">cbfn</span> <span class="o">?</span> <span class="n">cbfn</span> <span class="o">:</span> <span class="n">bfa_fcxp_null_comp</span><span class="p">;</span>
	<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">send_cbarg</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no room in CPE queue, wait for space in request queue</span>
<span class="cm">	 */</span>
	<span class="n">send_req</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_FCXP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">send_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span><span class="p">);</span>
		<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">reqq_waiting</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
		<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_FCXP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">reqq_wqe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_fcxp_queue</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="n">send_req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Abort a BFA FCXP</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	fcxp	BFA fcxp pointer</span>
<span class="cm"> *</span>
<span class="cm"> * @return		void</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcxp_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_mod</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">fcxp_tag</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcxp_alloc_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_wqe_s</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_alloc_cbfn_t</span> <span class="n">alloc_cbfn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">alloc_cbarg</span><span class="p">,</span>
	       <span class="kt">void</span> <span class="o">*</span><span class="n">caller</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nreq_sgles</span><span class="p">,</span>
	       <span class="kt">int</span> <span class="n">nrsp_sgles</span><span class="p">,</span> <span class="n">bfa_fcxp_get_sgaddr_t</span> <span class="n">req_sga_cbfn</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sglen_t</span> <span class="n">req_sglen_cbfn</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sgaddr_t</span> <span class="n">rsp_sga_cbfn</span><span class="p">,</span>
	       <span class="n">bfa_fcxp_get_sglen_t</span> <span class="n">rsp_sglen_cbfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_FCXP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_free_q</span><span class="p">));</span>

	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">alloc_cbfn</span> <span class="o">=</span> <span class="n">alloc_cbfn</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">alloc_cbarg</span> <span class="o">=</span> <span class="n">alloc_cbarg</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">caller</span> <span class="o">=</span> <span class="n">caller</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nreq_sgles</span> <span class="o">=</span> <span class="n">nreq_sgles</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nrsp_sgles</span> <span class="o">=</span> <span class="n">nrsp_sgles</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">req_sga_cbfn</span> <span class="o">=</span> <span class="n">req_sga_cbfn</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">req_sglen_cbfn</span> <span class="o">=</span> <span class="n">req_sglen_cbfn</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">rsp_sga_cbfn</span> <span class="o">=</span> <span class="n">rsp_sga_cbfn</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">rsp_sglen_cbfn</span> <span class="o">=</span> <span class="n">rsp_sglen_cbfn</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_wqe_s</span> <span class="o">*</span><span class="n">wqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_FCXP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bfa_q_is_on_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span> <span class="n">wqe</span><span class="p">));</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcxp_discard</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If waiting for room in request queue, cancel reqq wait</span>
<span class="cm">	 * and free fcxp.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">reqq_waiting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">reqq_waiting</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">reqq_wqe</span><span class="p">);</span>
		<span class="n">bfa_fcxp_free</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcxp</span><span class="o">-&gt;</span><span class="n">send_cbfn</span> <span class="o">=</span> <span class="n">bfa_fcxp_null_comp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcxp_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFI_FCXP_I2H_SEND_RSP</span>:
		<span class="n">hal_fcxp_send_comp</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_fcxp_send_rsp_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u32</span>
<span class="nf">bfa_fcxp_get_maxrsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_FCXP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">rsp_pld_sz</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcxp_res_recfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u16</span> <span class="n">num_fcxp_fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_FCXP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_fcxps</span> <span class="o">-</span> <span class="n">num_fcxp_fw</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_q_deq_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">fcxp_unused_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  BFA LPS state machine functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Init state -- no login</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_sm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_LPS_SM_LOGIN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_reqq_full</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_loginwait</span><span class="p">);</span>
			<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">wqe</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_login</span><span class="p">);</span>
			<span class="n">bfa_lps_send_login</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">fdisc</span><span class="p">)</span>
			<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_LPS</span><span class="p">,</span>
				<span class="n">BFA_PL_EID_LOGIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;FDISC Request&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_LPS</span><span class="p">,</span>
				<span class="n">BFA_PL_EID_LOGIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;FLOGI Request&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_LOGOUT</span>:
		<span class="n">bfa_lps_logout_comp</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_DELETE</span>:
		<span class="n">bfa_lps_free</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_RX_CVL</span>:
	<span class="k">case</span> <span class="n">BFA_LPS_SM_OFFLINE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_FWRSP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Could happen when fabric detects loopback and discards</span>
<span class="cm">		 * the lps request. Fw will eventually sent out the timeout</span>
<span class="cm">		 * Just ignore</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * login is in progress -- awaiting response from firmware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_sm_login</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_LPS_SM_FWRSP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_online</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">fdisc</span><span class="p">)</span>
				<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_LPS</span><span class="p">,</span>
					<span class="n">BFA_PL_EID_LOGIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;FDISC Accept&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_LPS</span><span class="p">,</span>
					<span class="n">BFA_PL_EID_LOGIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;FLOGI Accept&quot;</span><span class="p">);</span>
			<span class="cm">/* If N2N, send the assigned PID to FW */</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">fport</span><span class="p">);</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">lp_pid</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">fport</span> <span class="o">&amp;&amp;</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">lp_pid</span><span class="p">)</span>
				<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_SET_N2N_PID</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_init</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">fdisc</span><span class="p">)</span>
				<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_LPS</span><span class="p">,</span>
					<span class="n">BFA_PL_EID_LOGIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;FDISC Fail (RJT or timeout)&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_LPS</span><span class="p">,</span>
					<span class="n">BFA_PL_EID_LOGIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;FLOGI Fail (RJT or timeout)&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bfa_lps_login_comp</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_OFFLINE</span>:
	<span class="k">case</span> <span class="n">BFA_LPS_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_init</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_SET_N2N_PID</span>:
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">fport</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">lp_pid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * login pending - awaiting space in request queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_sm_loginwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_LPS_SM_RESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_login</span><span class="p">);</span>
		<span class="n">bfa_lps_send_login</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_OFFLINE</span>:
	<span class="k">case</span> <span class="n">BFA_LPS_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_init</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_RX_CVL</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Login was not even sent out; so when getting out</span>
<span class="cm">		 * of this state, it will appear like a login retry</span>
<span class="cm">		 * after Clear virtual link</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * login complete</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_LPS_SM_LOGOUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_reqq_full</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_logowait</span><span class="p">);</span>
			<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">wqe</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_logout</span><span class="p">);</span>
			<span class="n">bfa_lps_send_logout</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_LPS</span><span class="p">,</span>
			<span class="n">BFA_PL_EID_LOGO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Logout&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_RX_CVL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_init</span><span class="p">);</span>

		<span class="cm">/* Let the vport module know about this event */</span>
		<span class="n">bfa_lps_cvl_event</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_LPS</span><span class="p">,</span>
			<span class="n">BFA_PL_EID_FIP_FCF_CVL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;FCF Clear Virt. Link Rx&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_SET_N2N_PID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_reqq_full</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_online_n2n_pid_wait</span><span class="p">);</span>
			<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">wqe</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bfa_lps_send_set_n2n_pid</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_OFFLINE</span>:
	<span class="k">case</span> <span class="n">BFA_LPS_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_init</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * login complete</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_sm_online_n2n_pid_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_LPS_SM_RESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_online</span><span class="p">);</span>
		<span class="n">bfa_lps_send_set_n2n_pid</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_LOGOUT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_logowait</span><span class="p">);</span>
		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_LPS</span><span class="p">,</span>
			<span class="n">BFA_PL_EID_LOGO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Logout&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_RX_CVL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_init</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">wqe</span><span class="p">);</span>

		<span class="cm">/* Let the vport module know about this event */</span>
		<span class="n">bfa_lps_cvl_event</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_LPS</span><span class="p">,</span>
			<span class="n">BFA_PL_EID_FIP_FCF_CVL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;FCF Clear Virt. Link Rx&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_OFFLINE</span>:
	<span class="k">case</span> <span class="n">BFA_LPS_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_init</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * logout in progress - awaiting firmware response</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_sm_logout</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_LPS_SM_FWRSP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_init</span><span class="p">);</span>
		<span class="n">bfa_lps_logout_comp</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_OFFLINE</span>:
	<span class="k">case</span> <span class="n">BFA_LPS_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_init</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * logout pending -- awaiting space in request queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_sm_logowait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_lps_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_LPS_SM_RESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_logout</span><span class="p">);</span>
		<span class="n">bfa_lps_send_logout</span><span class="p">(</span><span class="n">lps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_LPS_SM_OFFLINE</span>:
	<span class="k">case</span> <span class="n">BFA_LPS_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_init</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  lps_pvt BFA LPS private functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * return memory requirement</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_meminfo_s</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_mem_kva_s</span> <span class="o">*</span><span class="n">lps_kva</span> <span class="o">=</span> <span class="n">BFA_MEM_LPS_KVA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">min_cfg</span><span class="p">)</span>
		<span class="n">bfa_mem_kva_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">lps_kva</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">BFA_LPS_MIN_LPORTS</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bfa_mem_kva_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">lps_kva</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">BFA_LPS_MAX_LPORTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bfa module attach at initialization time</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_lps_s</span>	<span class="o">*</span><span class="n">lps</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>

	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_lps</span> <span class="o">=</span> <span class="n">BFA_LPS_MAX_LPORTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">min_cfg</span><span class="p">)</span>
		<span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_lps</span> <span class="o">=</span> <span class="n">BFA_LPS_MIN_LPORTS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_lps</span> <span class="o">=</span> <span class="n">BFA_LPS_MAX_LPORTS</span><span class="p">;</span>
	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_arr</span> <span class="o">=</span> <span class="n">lps</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>

	<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span> <span class="o">+=</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_lps</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_free_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_active_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_login_q</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_lps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">lps</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span>	<span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span>	<span class="o">=</span> <span class="n">BFA_REQQ_LPS</span><span class="p">;</span>
		<span class="n">bfa_reqq_winit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">wqe</span><span class="p">,</span> <span class="n">bfa_lps_reqq_resume</span><span class="p">,</span> <span class="n">lps</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_free_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IOC in disabled state -- consider all lps offline</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_lps_s</span>	<span class="o">*</span><span class="n">lps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_active_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lps</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_OFFLINE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_login_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lps</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_OFFLINE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_login_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_active_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Firmware login response</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_login_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_lps_login_rsp_s</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_lps_s</span>	<span class="o">*</span><span class="n">lps</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bfa_tag</span> <span class="o">&gt;=</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_lps</span><span class="p">);</span>
	<span class="n">lps</span> <span class="o">=</span> <span class="n">BFA_LPS_FROM_TAG</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">);</span>

	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_STATUS_OK</span>:
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">fw_tag</span>	<span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">fw_tag</span><span class="p">;</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">fport</span>	<span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">f_port</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">fport</span><span class="p">)</span>
			<span class="n">lps</span><span class="o">-&gt;</span><span class="n">lp_pid</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">lp_pid</span><span class="p">;</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">npiv_en</span>	<span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">npiv_en</span><span class="p">;</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">pr_bbcred</span>	<span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bb_credit</span><span class="p">);</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">pr_pwwn</span>	<span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">;</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">pr_nwwn</span>	<span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">;</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">auth_req</span>	<span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">auth_req</span><span class="p">;</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">lp_mac</span>	<span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">lp_mac</span><span class="p">;</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">brcd_switch</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">brcd_switch</span><span class="p">;</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">fcf_mac</span>	<span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">;</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">pr_bbscn</span>	<span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bb_scn</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_STATUS_FABRIC_RJT</span>:
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">lsrjt_rsn</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">lsrjt_rsn</span><span class="p">;</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">lsrjt_expl</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">lsrjt_expl</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_STATUS_EPROTOCOL</span>:
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">ext_status</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ext_status</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_STATUS_VPORT_MAX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ext_status</span><span class="p">)</span>
			<span class="n">bfa_lps_no_res</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ext_status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Nothing to do with other status */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_active_q</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_FWRSP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_no_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">first_lps</span><span class="p">,</span> <span class="n">u8</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>		<span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">first_lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qe_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_lps_s</span>	<span class="o">*</span><span class="n">lps</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">qe</span> <span class="o">=</span> <span class="n">bfa_q_next</span><span class="p">(</span><span class="n">first_lps</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">qe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_next</span> <span class="o">=</span> <span class="n">bfa_q_next</span><span class="p">(</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">lps</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="p">)</span><span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">);</span>
		<span class="n">lps</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">first_lps</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_active_q</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_FWRSP</span><span class="p">);</span>
		<span class="n">qe</span> <span class="o">=</span> <span class="n">qe_next</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Firmware logout response</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_logout_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_lps_logout_rsp_s</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_lps_s</span>	<span class="o">*</span><span class="n">lps</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bfa_tag</span> <span class="o">&gt;=</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_lps</span><span class="p">);</span>
	<span class="n">lps</span> <span class="o">=</span> <span class="n">BFA_LPS_FROM_TAG</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_FWRSP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Firmware received a Clear virtual link request (for FCoE)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_rx_cvl_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_lps_cvl_event_s</span> <span class="o">*</span><span class="n">cvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_lps_s</span>	<span class="o">*</span><span class="n">lps</span><span class="p">;</span>

	<span class="n">lps</span> <span class="o">=</span> <span class="n">BFA_LPS_FROM_TAG</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">cvl</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_RX_CVL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Space is available in request queue, resume queueing request to firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_reqq_resume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lps_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_s</span>	<span class="o">*</span><span class="n">lps</span> <span class="o">=</span> <span class="n">lps_arg</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_RESUME</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lps is freed -- triggered by vport delete</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">lp_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_free_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send login request to firmware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_send_login</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfi_lps_login_req_s</span>	<span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">);</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_LPS</span><span class="p">,</span> <span class="n">BFI_LPS_H2I_LOGIN_REQ</span><span class="p">,</span>
		<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">bfa_tag</span>	<span class="o">=</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">alpa</span>		<span class="o">=</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">alpa</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pdu_size</span>	<span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">pdusz</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pwwn</span>		<span class="o">=</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">nwwn</span>		<span class="o">=</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">nwwn</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">fdisc</span>	<span class="o">=</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">fdisc</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">auth_en</span>	<span class="o">=</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">auth_en</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">bb_scn</span>	<span class="o">=</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">bb_scn</span><span class="p">;</span>

	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_login_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send logout request to firmware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_send_logout</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_lps_logout_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">);</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_LPS</span><span class="p">,</span> <span class="n">BFI_LPS_H2I_LOGOUT_REQ</span><span class="p">,</span>
		<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">fw_tag</span> <span class="o">=</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">fw_tag</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send n2n pid set request to firmware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_send_set_n2n_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_lps_n2n_pid_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">);</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_LPS</span><span class="p">,</span> <span class="n">BFI_LPS_H2I_N2N_PID_REQ</span><span class="p">,</span>
		<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">fw_tag</span> <span class="o">=</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">fw_tag</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">lp_pid</span> <span class="o">=</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">lp_pid</span><span class="p">;</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">reqq</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Indirect login completion handler for non-fcs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_login_comp_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span>	<span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">complete</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">fdisc</span><span class="p">)</span>
		<span class="n">bfa_cb_lps_fdisc_comp</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">uarg</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bfa_cb_lps_flogi_comp</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">uarg</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Login completion handler -- direct call for fcs, queue for others</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_login_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">bfa_lps_login_comp_cb</span><span class="p">,</span>
			<span class="n">lps</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">fdisc</span><span class="p">)</span>
		<span class="n">bfa_cb_lps_fdisc_comp</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">uarg</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bfa_cb_lps_flogi_comp</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">uarg</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Indirect logout completion handler for non-fcs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_logout_comp_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span>	<span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">complete</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">fdisc</span><span class="p">)</span>
		<span class="n">bfa_cb_lps_fdisclogo_comp</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">uarg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Logout completion handler -- direct call for fcs, queue for others</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_logout_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">bfa_lps_logout_comp_cb</span><span class="p">,</span>
			<span class="n">lps</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">fdisc</span><span class="p">)</span>
		<span class="n">bfa_cb_lps_fdisclogo_comp</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">uarg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clear virtual link completion handler for non-fcs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_cvl_event_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span>	<span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">complete</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Clear virtual link to base port will result in link down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">fdisc</span><span class="p">)</span>
		<span class="n">bfa_cb_lps_cvl_event</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">uarg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Received Clear virtual link event --direct call for fcs,</span>
<span class="cm"> * queue for others</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_lps_cvl_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">bfa_lps_cvl_event_cb</span><span class="p">,</span>
			<span class="n">lps</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear virtual link to base port will result in link down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">fdisc</span><span class="p">)</span>
		<span class="n">bfa_cb_lps_cvl_event</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">uarg</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  lps_public BFA LPS public functions</span>
<span class="cm"> */</span>

<span class="n">u32</span>
<span class="nf">bfa_lps_get_max_vport</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_devid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_PCI_DEVICE_ID_CT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_LPS_MAX_VPORTS_SUPP_CT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">BFA_LPS_MAX_VPORTS_SUPP_CB</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a lport srvice tag.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bfa_lps_s</span>  <span class="o">*</span>
<span class="nf">bfa_lps_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_lps_s</span>	<span class="o">*</span><span class="n">lps</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lps</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lps</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_active_q</span><span class="p">);</span>

	<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">bfa_lps_sm_init</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lps</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free lport service tag. This can be called anytime after an alloc.</span>
<span class="cm"> * No need to wait for any pending login/logout completions.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_lps_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_DELETE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initiate a lport login.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_lps_flogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">uarg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">alpa</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pdusz</span><span class="p">,</span>
	<span class="n">wwn_t</span> <span class="n">pwwn</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">nwwn</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">auth_en</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">bb_scn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">uarg</span>	<span class="o">=</span> <span class="n">uarg</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">alpa</span>	<span class="o">=</span> <span class="n">alpa</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">pdusz</span>	<span class="o">=</span> <span class="n">pdusz</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">pwwn</span>	<span class="o">=</span> <span class="n">pwwn</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">nwwn</span>	<span class="o">=</span> <span class="n">nwwn</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">fdisc</span>	<span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">auth_en</span>	<span class="o">=</span> <span class="n">auth_en</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">bb_scn</span>	<span class="o">=</span> <span class="n">bb_scn</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_LOGIN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initiate a lport fdisc login.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_lps_fdisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">uarg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pdusz</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">pwwn</span><span class="p">,</span>
	<span class="n">wwn_t</span> <span class="n">nwwn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">uarg</span>	<span class="o">=</span> <span class="n">uarg</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">alpa</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">pdusz</span>	<span class="o">=</span> <span class="n">pdusz</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">pwwn</span>	<span class="o">=</span> <span class="n">pwwn</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">nwwn</span>	<span class="o">=</span> <span class="n">nwwn</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">fdisc</span>	<span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">auth_en</span>	<span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_LOGIN</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Initiate a lport FDSIC logout.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_lps_fdisclogo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_LOGOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u8</span>
<span class="nf">bfa_lps_get_fwtag</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lp_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>    <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_LPS_FROM_TAG</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">lp_tag</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fw_tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return lport services tag given the pid</span>
<span class="cm"> */</span>
<span class="n">u8</span>
<span class="nf">bfa_lps_get_tag_from_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_lps_s</span>	<span class="o">*</span><span class="n">lps</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lps</span> <span class="o">=</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">lps_arr</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_lps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">lps</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">lp_pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Return base port tag anyway */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * return port id assigned to the base lport</span>
<span class="cm"> */</span>
<span class="n">u32</span>
<span class="nf">bfa_lps_get_base_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_LPS_FROM_TAG</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lp_pid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set PID in case of n2n (which is assigned during PLOGI)</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_lps_set_n2n_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lps_s</span> <span class="o">*</span><span class="n">lps</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">n2n_pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">n2n_pid</span><span class="p">);</span>

	<span class="n">lps</span><span class="o">-&gt;</span><span class="n">lp_pid</span> <span class="o">=</span> <span class="n">n2n_pid</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_SET_N2N_PID</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LPS firmware message class handler.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_lps_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">bfi_lps_i2h_msg_u</span>	<span class="n">msg</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFI_LPS_I2H_LOGIN_RSP</span>:
		<span class="n">bfa_lps_login_rsp</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">login_rsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_LPS_I2H_LOGOUT_RSP</span>:
		<span class="n">bfa_lps_logout_rsp</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">logout_rsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_LPS_I2H_CVL_EVENT</span>:
		<span class="n">bfa_lps_rx_cvl_event</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">cvl_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_aen_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_port_aen_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_aen_entry_s</span>  <span class="o">*</span><span class="n">aen_entry</span><span class="p">;</span>

	<span class="n">bfad_get_aen_entry</span><span class="p">(</span><span class="n">bfad</span><span class="p">,</span> <span class="n">aen_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aen_entry</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">ioc_type</span> <span class="o">=</span> <span class="n">bfa_get_type</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">pwwn</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>

	<span class="cm">/* Send the AEN notification */</span>
	<span class="n">bfad_im_post_vendor_event</span><span class="p">(</span><span class="n">aen_entry</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="o">++</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfa_aen_seq</span><span class="p">,</span>
				  <span class="n">BFA_AEN_CAT_PORT</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC PORT state machine functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_START</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Start event after IOC is configured and BFA is started.</span>
<span class="cm">		 */</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">use_flash_cfg</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_send_enable</span><span class="p">(</span><span class="n">fcport</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_TRUE</span><span class="p">);</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_enabling</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">);</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span>
					<span class="n">bfa_fcport_sm_enabling_qwait</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_ENABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Port is persistently configured to be in enabled state. Do</span>
<span class="cm">		 * not change state. Port enabling is done when START event is</span>
<span class="cm">		 * received.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_DISABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If a port is persistently configured to be disabled, the</span>
<span class="cm">		 * first event will a port disable request.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_disabled</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_iocdown</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_sm_enabling_qwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">pwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_enabling</span><span class="p">);</span>
		<span class="n">bfa_fcport_send_enable</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_STOP</span>:
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_ENABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Already enable is in progress.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_DISABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Just send disable request to firmware when room becomes</span>
<span class="cm">		 * available in request queue.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_disabled</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
				<span class="n">BFA_PL_EID_PORT_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Port Disable&quot;</span><span class="p">);</span>
		<span class="n">wwn2str</span><span class="p">(</span><span class="n">pwwn_buf</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
			<span class="s">&quot;Base port disabled: WWN = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
		<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_DISABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKUP</span>:
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKDOWN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Possible to get link events when doing back-to-back</span>
<span class="cm">		 * enable/disables.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_HWFAIL</span>:
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_iocdown</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_sm_enabling</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">pwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_FWRSP</span>:
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKDOWN</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_linkdown</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKUP</span>:
		<span class="n">bfa_fcport_update_linkinfo</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_linkup</span><span class="p">);</span>

		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">event_cbfn</span><span class="p">);</span>
		<span class="n">bfa_fcport_scn</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_LINKUP</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_ENABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Already being enabled.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_DISABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_send_disable</span><span class="p">(</span><span class="n">fcport</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_disabling</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span>
					 <span class="n">bfa_fcport_sm_disabling_qwait</span><span class="p">);</span>

		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
				<span class="n">BFA_PL_EID_PORT_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Port Disable&quot;</span><span class="p">);</span>
		<span class="n">wwn2str</span><span class="p">(</span><span class="n">pwwn_buf</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
			<span class="s">&quot;Base port disabled: WWN = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
		<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_DISABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_STOP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_iocdown</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_sm_linkdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_fcport_event_s</span> <span class="o">*</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">event_arg</span><span class="p">.</span><span class="n">i2hmsg</span><span class="p">.</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">pwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKUP</span>:
		<span class="n">bfa_fcport_update_linkinfo</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_linkup</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">event_cbfn</span><span class="p">);</span>
		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
				<span class="n">BFA_PL_EID_PORT_ST_CHANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Port Linkup&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_ioc_get_fcmode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span>
				<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">vc_fcf</span><span class="p">.</span><span class="n">fcf</span><span class="p">.</span><span class="n">fipenabled</span><span class="p">);</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span>
				<span class="n">pevent</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">vc_fcf</span><span class="p">.</span><span class="n">fcf</span><span class="p">.</span><span class="n">fipfailed</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">vc_fcf</span><span class="p">.</span><span class="n">fcf</span><span class="p">.</span><span class="n">fipfailed</span><span class="p">)</span>
				<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
					<span class="n">BFA_PL_EID_FIP_FCF_DISC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;FIP FCF Discovery Failed&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
					<span class="n">BFA_PL_EID_FIP_FCF_DISC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;FIP FCF Discovered&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bfa_fcport_scn</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_LINKUP</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">);</span>
		<span class="n">wwn2str</span><span class="p">(</span><span class="n">pwwn_buf</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
			<span class="s">&quot;Base port online: WWN = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
		<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_ONLINE</span><span class="p">);</span>

		<span class="cm">/* If QoS is enabled and it is not online, send AEN */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">qos_enabled</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">qos_attr</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BFA_QOS_ONLINE</span><span class="p">)</span>
			<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_QOS_NEG</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKDOWN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Possible to get link down event.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_ENABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Already enabled.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_DISABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_send_disable</span><span class="p">(</span><span class="n">fcport</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_disabling</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span>
					 <span class="n">bfa_fcport_sm_disabling_qwait</span><span class="p">);</span>

		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
				<span class="n">BFA_PL_EID_PORT_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Port Disable&quot;</span><span class="p">);</span>
		<span class="n">wwn2str</span><span class="p">(</span><span class="n">pwwn_buf</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
			<span class="s">&quot;Base port disabled: WWN = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
		<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_DISABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_STOP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_iocdown</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_sm_linkup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">pwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_ENABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Already enabled.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_DISABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_send_disable</span><span class="p">(</span><span class="n">fcport</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_disabling</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span>
					 <span class="n">bfa_fcport_sm_disabling_qwait</span><span class="p">);</span>

		<span class="n">bfa_fcport_reset_linkinfo</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="n">bfa_fcport_scn</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_LINKDOWN</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">);</span>
		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
				<span class="n">BFA_PL_EID_PORT_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Port Disable&quot;</span><span class="p">);</span>
		<span class="n">wwn2str</span><span class="p">(</span><span class="n">pwwn_buf</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
			<span class="s">&quot;Base port offline: WWN = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
		<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_OFFLINE</span><span class="p">);</span>
		<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
			<span class="s">&quot;Base port disabled: WWN = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
		<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_DISABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKDOWN</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_linkdown</span><span class="p">);</span>
		<span class="n">bfa_fcport_reset_linkinfo</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="n">bfa_fcport_scn</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_LINKDOWN</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">);</span>
		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
				<span class="n">BFA_PL_EID_PORT_ST_CHANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Port Linkdown&quot;</span><span class="p">);</span>
		<span class="n">wwn2str</span><span class="p">(</span><span class="n">pwwn_buf</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BFA_PORT_IS_DISABLED</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
				<span class="s">&quot;Base port offline: WWN = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
			<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_OFFLINE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
				<span class="s">&quot;Base port (WWN = %s) &quot;</span>
				<span class="s">&quot;lost fabric connectivity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
			<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_DISCONNECT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_STOP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_stopped</span><span class="p">);</span>
		<span class="n">bfa_fcport_reset_linkinfo</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="n">wwn2str</span><span class="p">(</span><span class="n">pwwn_buf</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BFA_PORT_IS_DISABLED</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
				<span class="s">&quot;Base port offline: WWN = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
			<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_OFFLINE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
				<span class="s">&quot;Base port (WWN = %s) &quot;</span>
				<span class="s">&quot;lost fabric connectivity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
			<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_DISCONNECT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_iocdown</span><span class="p">);</span>
		<span class="n">bfa_fcport_reset_linkinfo</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="n">bfa_fcport_scn</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_LINKDOWN</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">);</span>
		<span class="n">wwn2str</span><span class="p">(</span><span class="n">pwwn_buf</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BFA_PORT_IS_DISABLED</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
				<span class="s">&quot;Base port offline: WWN = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
			<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_OFFLINE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
				<span class="s">&quot;Base port (WWN = %s) &quot;</span>
				<span class="s">&quot;lost fabric connectivity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
			<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_DISCONNECT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_sm_disabling_qwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_disabling</span><span class="p">);</span>
		<span class="n">bfa_fcport_send_disable</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_STOP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_stopped</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_ENABLE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_toggling_qwait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_DISABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Already being disabled.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKUP</span>:
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKDOWN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Possible to get link events when doing back-to-back</span>
<span class="cm">		 * enable/disables.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_iocfail</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_sm_toggling_qwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_disabling</span><span class="p">);</span>
		<span class="n">bfa_fcport_send_disable</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_send_enable</span><span class="p">(</span><span class="n">fcport</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_enabling</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span>
					 <span class="n">bfa_fcport_sm_enabling_qwait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_STOP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_stopped</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_ENABLE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_DISABLE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_disabling_qwait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKUP</span>:
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKDOWN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Possible to get link events when doing back-to-back</span>
<span class="cm">		 * enable/disables.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_iocfail</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_sm_disabling</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">pwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_FWRSP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_disabled</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_DISABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Already being disabled.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_ENABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_send_enable</span><span class="p">(</span><span class="n">fcport</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_enabling</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span>
					 <span class="n">bfa_fcport_sm_enabling_qwait</span><span class="p">);</span>

		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
				<span class="n">BFA_PL_EID_PORT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Port Enable&quot;</span><span class="p">);</span>
		<span class="n">wwn2str</span><span class="p">(</span><span class="n">pwwn_buf</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
			<span class="s">&quot;Base port enabled: WWN = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
		<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_STOP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKUP</span>:
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_LINKDOWN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Possible to get link events when doing back-to-back</span>
<span class="cm">		 * enable/disables.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_iocfail</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_sm_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">pwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_START</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Ignore start event for a port that is disabled.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_STOP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_ENABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_send_enable</span><span class="p">(</span><span class="n">fcport</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_enabling</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span>
					 <span class="n">bfa_fcport_sm_enabling_qwait</span><span class="p">);</span>

		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
				<span class="n">BFA_PL_EID_PORT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Port Enable&quot;</span><span class="p">);</span>
		<span class="n">wwn2str</span><span class="p">(</span><span class="n">pwwn_buf</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
			<span class="s">&quot;Base port enabled: WWN = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwwn_buf</span><span class="p">);</span>
		<span class="n">bfa_fcport_aen_post</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_AEN_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_DISABLE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Already disabled.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_HWFAIL</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_iocfail</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_sm_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_START</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_send_enable</span><span class="p">(</span><span class="n">fcport</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_enabling</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span>
					 <span class="n">bfa_fcport_sm_enabling_qwait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ignore all other events.</span>
<span class="cm">		 */</span>
		<span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Port is enabled. IOC is down/failed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_sm_iocdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_START</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_send_enable</span><span class="p">(</span><span class="n">fcport</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_enabling</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span>
					 <span class="n">bfa_fcport_sm_enabling_qwait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ignore all events.</span>
<span class="cm">		 */</span>
		<span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Port is disabled. IOC is down/failed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_sm_iocfail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">bfa_fcport_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_START</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_disabled</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_SM_ENABLE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_iocdown</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ignore all events.</span>
<span class="cm">		 */</span>
		<span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Link state is down</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_ln_sm_dn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_LN_SM_LINKUP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_up_nf</span><span class="p">);</span>
		<span class="n">bfa_fcport_queue_cb</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">BFA_PORT_LINKUP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Link state is waiting for down notification</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_ln_sm_dn_nf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_LN_SM_LINKUP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_dn_up_nf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_LN_SM_NOTIFICATION</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_dn</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Link state is waiting for down notification and there is a pending up</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_ln_sm_dn_up_nf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_LN_SM_LINKDOWN</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_dn_nf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_LN_SM_NOTIFICATION</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_up_nf</span><span class="p">);</span>
		<span class="n">bfa_fcport_queue_cb</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">BFA_PORT_LINKUP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Link state is up</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_ln_sm_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_LN_SM_LINKDOWN</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_dn_nf</span><span class="p">);</span>
		<span class="n">bfa_fcport_queue_cb</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">BFA_PORT_LINKDOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Link state is waiting for up notification</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_ln_sm_up_nf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_LN_SM_LINKDOWN</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_up_dn_nf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_LN_SM_NOTIFICATION</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Link state is waiting for up notification and there is a pending down</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_ln_sm_up_dn_nf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_LN_SM_LINKUP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_up_dn_up_nf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_LN_SM_NOTIFICATION</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_dn_nf</span><span class="p">);</span>
		<span class="n">bfa_fcport_queue_cb</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">BFA_PORT_LINKDOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Link state is waiting for up notification and there are pending down and up</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_ln_sm_up_dn_up_nf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_fcport_ln_sm_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCPORT_LN_SM_LINKDOWN</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_up_dn_nf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCPORT_LN_SM_NOTIFICATION</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_dn_up_nf</span><span class="p">);</span>
		<span class="n">bfa_fcport_queue_cb</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">BFA_PORT_LINKDOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_fcport_event</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">event_cbfn</span><span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">event_cbarg</span><span class="p">,</span> <span class="n">ln</span><span class="o">-&gt;</span><span class="n">ln_event</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">BFA_FCPORT_LN_SM_NOTIFICATION</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send SCN notification to upper layers.</span>
<span class="cm"> * trunk - false if caller is fcport to ignore fcport event in trunked mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_scn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_port_linkstate</span> <span class="n">event</span><span class="p">,</span>
	<span class="n">bfa_boolean_t</span> <span class="n">trunk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trunked</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">trunk</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_PORT_LINKUP</span>:
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">ln</span><span class="p">,</span> <span class="n">BFA_FCPORT_LN_SM_LINKUP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFA_PORT_LINKDOWN</span>:
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">ln</span><span class="p">,</span> <span class="n">BFA_FCPORT_LN_SM_LINKDOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_queue_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_port_linkstate</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">event_cbfn</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">event_cbarg</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">BFA_FCPORT_LN_SM_NOTIFICATION</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ln</span><span class="o">-&gt;</span><span class="n">ln_event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">ln_qe</span><span class="p">,</span>
			<span class="n">__bfa_cb_fcport_event</span><span class="p">,</span> <span class="n">ln</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define FCPORT_STATS_DMA_SZ (BFA_ROUNDUP(sizeof(union bfa_fcport_stats_u), \</span>
<span class="cp">							BFA_CACHELINE_SZ))</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_meminfo_s</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">fcport_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_FCPORT_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">fcport_dma</span><span class="p">,</span> <span class="n">FCPORT_STATS_DMA_SZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_qresume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_FCPORT_SM_QRESUME</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_mem_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">fcport_dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fcport_dma</span><span class="p">;</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_kva</span> <span class="o">=</span> <span class="n">bfa_mem_dma_virt</span><span class="p">(</span><span class="n">fcport_dma</span><span class="p">);</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_pa</span>  <span class="o">=</span> <span class="n">bfa_mem_dma_phys</span><span class="p">(</span><span class="n">fcport_dma</span><span class="p">);</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">bfa_fcport_stats_u</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">bfa_mem_dma_virt</span><span class="p">(</span><span class="n">fcport_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Memory initialization.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_port_cfg_s</span> <span class="o">*</span><span class="n">port_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_ln_s</span> <span class="o">*</span><span class="n">ln</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">ln</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>
	<span class="n">ln</span><span class="o">-&gt;</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">fcport</span><span class="p">;</span>

	<span class="n">bfa_fcport_mem_claim</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>

	<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_uninit</span><span class="p">);</span>
	<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">bfa_fcport_ln_sm_dn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize time stamp for stats reset</span>
<span class="cm">	 */</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_reset_time</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize and set default configuration</span>
<span class="cm">	 */</span>
	<span class="n">port_cfg</span><span class="o">-&gt;</span><span class="n">topology</span> <span class="o">=</span> <span class="n">BFA_PORT_TOPOLOGY_P2P</span><span class="p">;</span>
	<span class="n">port_cfg</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">BFA_PORT_SPEED_AUTO</span><span class="p">;</span>
	<span class="n">port_cfg</span><span class="o">-&gt;</span><span class="n">trunked</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">port_cfg</span><span class="o">-&gt;</span><span class="n">maxfrsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">port_cfg</span><span class="o">-&gt;</span><span class="n">trl_def_speed</span> <span class="o">=</span> <span class="n">BFA_PORT_SPEED_1GBPS</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_pending_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">statsclr_pending_q</span><span class="p">);</span>

	<span class="n">bfa_reqq_winit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">,</span> <span class="n">bfa_fcport_qresume</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called when IOC is ready.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">),</span> <span class="n">BFA_FCPORT_SM_START</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called before IOC is stopped.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">),</span> <span class="n">BFA_FCPORT_SM_STOP</span><span class="p">);</span>
	<span class="n">bfa_trunk_iocdisable</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called when IOC failure is detected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_FCPORT_SM_HWFAIL</span><span class="p">);</span>
	<span class="n">bfa_trunk_iocdisable</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_update_linkinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_fcport_event_s</span> <span class="o">*</span><span class="n">pevent</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">event_arg</span><span class="p">.</span><span class="n">i2hmsg</span><span class="p">.</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_trunk_s</span> <span class="o">*</span><span class="n">trunk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">;</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">topology</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">topology</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">topology</span> <span class="o">==</span> <span class="n">BFA_PORT_TOPOLOGY_LOOP</span><span class="p">)</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">myalpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* QoS Details */</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">qos_attr</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">qos_attr</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">qos_vc_attr</span> <span class="o">=</span> <span class="n">pevent</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">vc_fcf</span><span class="p">.</span><span class="n">qos_vc_attr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * update trunk state if applicable</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trunked</span><span class="p">)</span>
		<span class="n">trunk</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">BFA_TRUNK_DISABLED</span><span class="p">;</span>

	<span class="cm">/* update FCoE specific */</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fcoe_vlan</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">pevent</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">vc_fcf</span><span class="p">.</span><span class="n">fcf</span><span class="p">.</span><span class="n">vlan</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">topology</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_reset_linkinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">BFA_PORT_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">topology</span> <span class="o">=</span> <span class="n">BFA_PORT_TOPOLOGY_NONE</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bbsc_op_state</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send port enable message to firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bfa_boolean_t</span>
<span class="nf">bfa_fcport_send_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_fcport_enable_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Increment message tag before queue check, so that responses to old</span>
<span class="cm">	 * requests are discarded.</span>
<span class="cm">	 */</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">msgtag</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for room in queue to send request now</span>
<span class="cm">	 */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_PORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_PORT</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_FCPORT</span><span class="p">,</span> <span class="n">BFI_FCPORT_H2I_ENABLE_REQ</span><span class="p">,</span>
			<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">nwwn</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">nwwn</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">port_cfg</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msgtag</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">msgtag</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">maxfrsize</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">maxfrsize</span><span class="p">);</span>
	 <span class="n">m</span><span class="o">-&gt;</span><span class="n">use_flash_cfg</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">use_flash_cfg</span><span class="p">;</span>
	<span class="n">bfa_dma_be_addr_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">stats_dma_addr</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_pa</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">stats_dma_addr</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">addr_lo</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">stats_dma_addr</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">addr_hi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue I/O message to firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_PORT</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send port disable message to firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span>	<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_fcport_send_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_fcport_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Increment message tag before queue check, so that responses to old</span>
<span class="cm">	 * requests are discarded.</span>
<span class="cm">	 */</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">msgtag</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for room in queue to send request now</span>
<span class="cm">	 */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_PORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_PORT</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_FCPORT</span><span class="p">,</span> <span class="n">BFI_FCPORT_H2I_DISABLE_REQ</span><span class="p">,</span>
			<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msgtag</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">msgtag</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue I/O message to firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_PORT</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_set_wwns</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">nwwn</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nwwn</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">nwwn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_qos_stats_swap</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_qos_stats_s</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bfa_qos_stats_s</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="o">*</span><span class="n">dip</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">__be32</span>	<span class="o">*</span><span class="n">sip</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Now swap the 32 bit fields */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_qos_stats_s</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sip</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_fcoe_stats_swap</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcoe_stats_s</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bfa_fcoe_stats_s</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="o">*</span><span class="n">dip</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">__be32</span>	<span class="o">*</span><span class="n">sip</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcoe_stats_s</span><span class="p">))</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	     <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
		<span class="n">dip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sip</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">dip</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sip</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
<span class="cp">#else</span>
		<span class="n">dip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sip</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">dip</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sip</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_fcport_stats_get</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="p">)</span><span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_cb_pending_q_s</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">bfa_fcport_stats_u</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
			<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>

		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_pending_q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_pending_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qe</span><span class="p">);</span>
			<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_cb_pending_q_s</span> <span class="o">*</span><span class="p">)</span><span class="n">qe</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">bfa_fcport_stats_u</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
				<span class="cm">/* Swap FC QoS or FCoE stats */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_get_fcmode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">))</span>
					<span class="n">bfa_fcport_qos_stats_swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">fcqos</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">fcqos</span><span class="p">);</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">bfa_fcport_fcoe_stats_swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">);</span>
					<span class="n">ret</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">.</span><span class="n">secs_reset</span> <span class="o">=</span>
					<span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_reset_time</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">bfa_cb_queue_status</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span>
					<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_pending_q</span><span class="p">);</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_stats_get_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_qfull</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_qfull</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_reqq_wait</span><span class="p">);</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_qfull</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_ETIMER</span><span class="p">;</span>
	<span class="n">__bfa_cb_fcport_stats_get</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_TRUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_send_stats_get</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_fcport_req_s</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_PORT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_qfull</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
		<span class="n">bfa_reqq_winit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_reqq_wait</span><span class="p">,</span>
				<span class="n">bfa_fcport_send_stats_get</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
		<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_PORT</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_reqq_wait</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_qfull</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_fcport_req_s</span><span class="p">));</span>
	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_FCPORT</span><span class="p">,</span> <span class="n">BFI_FCPORT_H2I_STATS_GET_REQ</span><span class="p">,</span>
			<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_PORT</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_fcport_stats_clr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_cb_pending_q_s</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * re-initialize time stamp for stats reset</span>
<span class="cm">		 */</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_reset_time</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">statsclr_pending_q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">statsclr_pending_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qe</span><span class="p">);</span>
			<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_cb_pending_q_s</span> <span class="o">*</span><span class="p">)</span><span class="n">qe</span><span class="p">;</span>
			<span class="n">bfa_cb_queue_status</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span>
						<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">statsclr_pending_q</span><span class="p">);</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_stats_clr_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_qfull</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_qfull</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_reqq_wait</span><span class="p">);</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_qfull</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_ETIMER</span><span class="p">;</span>
	<span class="n">__bfa_cb_fcport_stats_clr</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_TRUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcport_send_stats_clear</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_fcport_req_s</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_PORT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_qfull</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
		<span class="n">bfa_reqq_winit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_reqq_wait</span><span class="p">,</span>
				<span class="n">bfa_fcport_send_stats_clear</span><span class="p">,</span> <span class="n">fcport</span><span class="p">);</span>
		<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_PORT</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_reqq_wait</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_qfull</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_fcport_req_s</span><span class="p">));</span>
	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_FCPORT</span><span class="p">,</span> <span class="n">BFI_FCPORT_H2I_STATS_CLEAR_REQ</span><span class="p">,</span>
			<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_PORT</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle trunk SCN event from firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_trunk_scn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_fcport_trunk_scn_s</span> <span class="o">*</span><span class="n">scn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_trunk_s</span> <span class="o">*</span><span class="n">trunk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_fcport_trunk_link_s</span> <span class="o">*</span><span class="n">tlink</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_trunk_link_attr_s</span> <span class="o">*</span><span class="n">lattr</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">bfa_trunk_state</span> <span class="n">state_prev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link_bm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trunked</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">trunk_state</span> <span class="o">!=</span> <span class="n">BFA_TRUNK_ONLINE</span> <span class="o">&amp;&amp;</span>
		   <span class="n">scn</span><span class="o">-&gt;</span><span class="n">trunk_state</span> <span class="o">!=</span> <span class="n">BFA_TRUNK_OFFLINE</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">trunk</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">scn</span><span class="o">-&gt;</span><span class="n">trunk_state</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">scn</span><span class="o">-&gt;</span><span class="n">trunk_speed</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save off new state for trunk attribute query</span>
<span class="cm">	 */</span>
	<span class="n">state_prev</span> <span class="o">=</span> <span class="n">trunk</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trunked</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">trunk</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BFA_TRUNK_DISABLED</span><span class="p">))</span>
		<span class="n">trunk</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">scn</span><span class="o">-&gt;</span><span class="n">trunk_state</span><span class="p">;</span>
	<span class="n">trunk</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">scn</span><span class="o">-&gt;</span><span class="n">trunk_speed</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFA_TRUNK_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lattr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trunk</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">link_attr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">tlink</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">tlink</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">lattr</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="n">tlink</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
		<span class="n">lattr</span><span class="o">-&gt;</span><span class="n">trunk_wwn</span>  <span class="o">=</span> <span class="n">tlink</span><span class="o">-&gt;</span><span class="n">trunk_wwn</span><span class="p">;</span>
		<span class="n">lattr</span><span class="o">-&gt;</span><span class="n">fctl</span>	  <span class="o">=</span> <span class="n">tlink</span><span class="o">-&gt;</span><span class="n">fctl</span><span class="p">;</span>
		<span class="n">lattr</span><span class="o">-&gt;</span><span class="n">speed</span>	  <span class="o">=</span> <span class="n">tlink</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
		<span class="n">lattr</span><span class="o">-&gt;</span><span class="n">deskew</span>	  <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">deskew</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BFA_TRUNK_LINK_STATE_UP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">speed</span>	 <span class="o">=</span> <span class="n">tlink</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">topology</span> <span class="o">=</span> <span class="n">BFA_PORT_TOPOLOGY_P2P</span><span class="p">;</span>
			<span class="n">link_bm</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lattr</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lattr</span><span class="o">-&gt;</span><span class="n">trunk_wwn</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lattr</span><span class="o">-&gt;</span><span class="n">fctl</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lattr</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lattr</span><span class="o">-&gt;</span><span class="n">deskew</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">link_bm</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
			<span class="n">BFA_PL_EID_TRUNK_SCN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Trunk up(0,1)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
			<span class="n">BFA_PL_EID_TRUNK_SCN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Trunk up(-,1)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
			<span class="n">BFA_PL_EID_TRUNK_SCN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Trunk up(0,-)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span>
			<span class="n">BFA_PL_EID_TRUNK_SCN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Trunk down&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Notify upper layers if trunk state changed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state_prev</span> <span class="o">!=</span> <span class="n">trunk</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">trunk_state</span> <span class="o">==</span> <span class="n">BFA_TRUNK_OFFLINE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_fcport_scn</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="p">(</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">trunk_state</span> <span class="o">==</span> <span class="n">BFA_TRUNK_ONLINE</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">BFA_PORT_LINKUP</span> <span class="o">:</span> <span class="n">BFA_PORT_LINKDOWN</span><span class="p">,</span> <span class="n">BFA_TRUE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_trunk_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In trunked mode, notify upper layers that link is down</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trunked</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">BFA_TRUNK_ONLINE</span><span class="p">)</span>
			<span class="n">bfa_fcport_scn</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_PORT_LINKDOWN</span><span class="p">,</span> <span class="n">BFA_TRUE</span><span class="p">);</span>

		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">BFA_TRUNK_OFFLINE</span><span class="p">;</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">BFA_PORT_SPEED_UNKNOWN</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFA_TRUNK_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">link_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">trunk_wwn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">link_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fctl</span> <span class="o">=</span>
						<span class="n">BFA_TRUNK_LINK_FCTL_NORMAL</span><span class="p">;</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">link_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">link_state</span> <span class="o">=</span>
						<span class="n">BFA_TRUNK_LINK_STATE_DN_LINKDN</span><span class="p">;</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">link_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span> <span class="o">=</span>
						<span class="n">BFA_PORT_SPEED_UNKNOWN</span><span class="p">;</span>
			<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">link_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">deskew</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called to initialize port attributes</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcport_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize port attributes from IOC hardware data.</span>
<span class="cm">	 */</span>
	<span class="n">bfa_fcport_set_wwns</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">maxfrsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">maxfrsize</span> <span class="o">=</span> <span class="n">bfa_ioc_maxfrsize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">rx_bbcredit</span> <span class="o">=</span> <span class="n">bfa_ioc_rx_bbcredit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">speed_sup</span> <span class="o">=</span> <span class="n">bfa_ioc_speed_sup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_is_pbcdisabled</span><span class="p">(</span><span class="n">bfa</span><span class="p">))</span>
		<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">pbc_disabled</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">maxfrsize</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">rx_bbcredit</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">speed_sup</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Firmware message handler.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcport_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">bfi_fcport_i2h_msg_u</span> <span class="n">i2hmsg</span><span class="p">;</span>

	<span class="n">i2hmsg</span><span class="p">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">event_arg</span><span class="p">.</span><span class="n">i2hmsg</span> <span class="o">=</span> <span class="n">i2hmsg</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_sm_to_state</span><span class="p">(</span><span class="n">hal_port_sm_table</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFI_FCPORT_I2H_ENABLE_RSP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">msgtag</span> <span class="o">==</span> <span class="n">i2hmsg</span><span class="p">.</span><span class="n">penable_rsp</span><span class="o">-&gt;</span><span class="n">msgtag</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">use_flash_cfg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">i2hmsg</span><span class="p">.</span><span class="n">penable_rsp</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">;</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">maxfrsize</span> <span class="o">=</span>
					<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">maxfrsize</span><span class="p">);</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">path_tov</span> <span class="o">=</span>
					<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">path_tov</span><span class="p">);</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">q_depth</span> <span class="o">=</span>
					<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">q_depth</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trunked</span><span class="p">)</span>
					<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span>
						<span class="n">BFA_TRUNK_OFFLINE</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span>
						<span class="n">BFA_TRUNK_DISABLED</span><span class="p">;</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">use_flash_cfg</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">qos_enabled</span><span class="p">)</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">qos_attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">BFA_QOS_OFFLINE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">qos_attr</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">BFA_QOS_DISABLED</span><span class="p">;</span>

			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_FCPORT_SM_FWRSP</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_FCPORT_I2H_DISABLE_RSP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">msgtag</span> <span class="o">==</span> <span class="n">i2hmsg</span><span class="p">.</span><span class="n">penable_rsp</span><span class="o">-&gt;</span><span class="n">msgtag</span><span class="p">)</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_FCPORT_SM_FWRSP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_FCPORT_I2H_EVENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">i2hmsg</span><span class="p">.</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">.</span><span class="n">linkstate</span> <span class="o">==</span> <span class="n">BFA_PORT_LINKUP</span><span class="p">)</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_FCPORT_SM_LINKUP</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_FCPORT_SM_LINKDOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_FCPORT_I2H_TRUNK_SCN</span>:
		<span class="n">bfa_trunk_scn</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">i2hmsg</span><span class="p">.</span><span class="n">trunk_scn</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_FCPORT_I2H_STATS_GET_RSP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * check for timer pop before processing the rsp</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_pending_q</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span> <span class="o">==</span> <span class="n">BFA_STATUS_ETIMER</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span> <span class="o">=</span> <span class="n">i2hmsg</span><span class="p">.</span><span class="n">pstatsget_rsp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="n">__bfa_cb_fcport_stats_get</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_TRUE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_FCPORT_I2H_STATS_CLEAR_RSP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * check for timer pop before processing the rsp</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">statsclr_pending_q</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span> <span class="o">==</span> <span class="n">BFA_STATUS_ETIMER</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
		<span class="n">__bfa_cb_fcport_stats_clr</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_TRUE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_FCPORT_I2H_ENABLE_AEN</span>:
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_FCPORT_SM_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_FCPORT_I2H_DISABLE_AEN</span>:
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_FCPORT_SM_DISABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Registered callback for port events.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcport_event_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span>
				<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cbfn</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bfa_port_linkstate</span> <span class="n">event</span><span class="p">),</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">event_cbfn</span> <span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">event_cbarg</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcport_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_is_pbcdisabled</span><span class="p">(</span><span class="n">bfa</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_PBC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_is_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_IOC_DISABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">diag_busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_DIAG_BUSY</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">),</span> <span class="n">BFA_FCPORT_SM_ENABLE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcport_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_is_pbcdisabled</span><span class="p">(</span><span class="n">bfa</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_PBC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_is_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_IOC_DISABLED</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">),</span> <span class="n">BFA_FCPORT_SM_DISABLE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* If PBC is disabled on port, return error */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcport_is_pbcdisabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_iocfc_cfgrsp_s</span> <span class="o">*</span><span class="n">cfgrsp</span> <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfgrsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">port_enabled</span> <span class="o">==</span> <span class="n">BFI_PBC_PORT_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_PBC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure port speed.</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcport_cfg_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_port_speed</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trunked</span> <span class="o">==</span> <span class="n">BFA_TRUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_TRUNK_ENABLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">BFA_PORT_SPEED_AUTO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">speed_sup</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">speed_sup</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_UNSUPP_SPEED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Port speed entered needs to be checked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_get_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_IOC_TYPE_FC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* For CT2, 1G is not supported */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_1GBPS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">bfa_asic_id_ct2</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">pcidev</span><span class="p">.</span><span class="n">device_id</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">BFA_STATUS_UNSUPP_SPEED</span><span class="p">;</span>

		<span class="cm">/* Already checked for Auto Speed and Max Speed supp */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_1GBPS</span> <span class="o">||</span>
		      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_2GBPS</span> <span class="o">||</span>
		      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_4GBPS</span> <span class="o">||</span>
		      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_8GBPS</span> <span class="o">||</span>
		      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_16GBPS</span> <span class="o">||</span>
		      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_AUTO</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">BFA_STATUS_UNSUPP_SPEED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">BFA_PORT_SPEED_10GBPS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">BFA_STATUS_UNSUPP_SPEED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get current speed.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">bfa_port_speed</span>
<span class="nf">bfa_fcport_get_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure port topology.</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcport_cfg_topology</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_port_topology</span> <span class="n">topology</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">topology</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">topology</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">topology</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_PORT_TOPOLOGY_P2P</span>:
	<span class="k">case</span> <span class="n">BFA_PORT_TOPOLOGY_LOOP</span>:
	<span class="k">case</span> <span class="n">BFA_PORT_TOPOLOGY_AUTO</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">topology</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get current topology.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">bfa_port_topology</span>
<span class="nf">bfa_fcport_get_topology</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">topology</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcport_cfg_hardalpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u8</span> <span class="n">alpa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">alpa</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">cfg_hardalpa</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">hardalpa</span><span class="p">);</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">cfg_hardalpa</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">hardalpa</span> <span class="o">=</span> <span class="n">alpa</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcport_clr_hardalpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">cfg_hardalpa</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">hardalpa</span><span class="p">);</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">cfg_hardalpa</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_fcport_get_hardalpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">alpa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="o">*</span><span class="n">alpa</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">hardalpa</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">cfg_hardalpa</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span>
<span class="nf">bfa_fcport_get_myalpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">myalpa</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcport_cfg_maxfrsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u16</span> <span class="n">maxfrsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">maxfrsize</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">maxfrsize</span><span class="p">);</span>

	<span class="cm">/* with in range */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">maxfrsize</span> <span class="o">&gt;</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">maxfrsize</span> <span class="o">&lt;</span> <span class="n">FC_MIN_PDUSZ</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_INVLD_DFSZ</span><span class="p">;</span>

	<span class="cm">/* power of 2, if not the max frame size of 2112 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">maxfrsize</span> <span class="o">!=</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">maxfrsize</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">maxfrsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_INVLD_DFSZ</span><span class="p">;</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">maxfrsize</span> <span class="o">=</span> <span class="n">maxfrsize</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span>
<span class="nf">bfa_fcport_get_maxfrsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">maxfrsize</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span>
<span class="nf">bfa_fcport_get_rx_bbcredit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">rx_bbcredit</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcport_set_tx_bbcredit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tx_bbcredit</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bb_scn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">tx_bbcredit</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tx_bbcredit</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bb_scn</span> <span class="o">=</span> <span class="n">bb_scn</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bb_scn</span><span class="p">)</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bbsc_op_state</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get port attributes.</span>
<span class="cm"> */</span>

<span class="n">wwn_t</span>
<span class="nf">bfa_fcport_get_wwn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">nwwn</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcport_get_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_port_attr_s</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_port_attr_s</span><span class="p">));</span>

	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">nwwn</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">nwwn</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>

	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">factorypwwn</span> <span class="o">=</span>  <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">mfg_pwwn</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">factorynwwn</span> <span class="o">=</span>  <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">mfg_nwwn</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">pport_cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_port_cfg_s</span><span class="p">));</span>
	<span class="cm">/* speed attributes */</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">pport_cfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">speed_supported</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">speed_sup</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">cos_supported</span> <span class="o">=</span> <span class="n">FC_CLASS_3</span><span class="p">;</span>

	<span class="cm">/* topology attributes */</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">pport_cfg</span><span class="p">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">topology</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">topology</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">topology</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">pport_cfg</span><span class="p">.</span><span class="n">trunked</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trunked</span><span class="p">;</span>

	<span class="cm">/* beacon attributes */</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">beacon</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">link_e2e_beacon</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">link_e2e_beacon</span><span class="p">;</span>

	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">pport_cfg</span><span class="p">.</span><span class="n">path_tov</span>  <span class="o">=</span> <span class="n">bfa_fcpim_path_tov_get</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">pport_cfg</span><span class="p">.</span><span class="n">q_depth</span>  <span class="o">=</span> <span class="n">bfa_fcpim_qdepth_get</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span> <span class="n">bfa_sm_to_state</span><span class="p">(</span><span class="n">hal_port_sm_table</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">bbsc_op_status</span> <span class="o">=</span>  <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bbsc_op_state</span><span class="p">;</span>

	<span class="cm">/* PBC Disabled State */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_is_pbcdisabled</span><span class="p">(</span><span class="n">bfa</span><span class="p">))</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span> <span class="n">BFA_PORT_ST_PREBOOT_DISABLED</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_is_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">))</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span> <span class="n">BFA_PORT_ST_IOCDIS</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_fw_mismatch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">))</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span> <span class="n">BFA_PORT_ST_FWMISMATCH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FCoE vlan */</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">fcoe_vlan</span> <span class="o">=</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">fcoe_vlan</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define BFA_FCPORT_STATS_TOV	1000</span>

<span class="cm">/*</span>
<span class="cm"> * Fetch port statistics (FCQoS or FCoE).</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcport_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_cb_pending_q_s</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_is_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_IOC_DISABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">statsclr_pending_q</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_DEVBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_pending_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">.</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_pending_q</span><span class="p">);</span>
		<span class="n">bfa_fcport_send_stats_get</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">bfa_fcport_stats_get_timeout</span><span class="p">,</span>
				<span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_FCPORT_STATS_TOV</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">.</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_pending_q</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset port statistics (FCQoS or FCoE).</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcport_clear_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_cb_pending_q_s</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">stats_pending_q</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_DEVBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">statsclr_pending_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">.</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">statsclr_pending_q</span><span class="p">);</span>
		<span class="n">bfa_fcport_send_stats_clear</span><span class="p">(</span><span class="n">fcport</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">bfa_fcport_stats_clr_timeout</span><span class="p">,</span>
				<span class="n">fcport</span><span class="p">,</span> <span class="n">BFA_FCPORT_STATS_TOV</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">.</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">statsclr_pending_q</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fetch port attributes.</span>
<span class="cm"> */</span>
<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_fcport_is_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bfa_sm_to_state</span><span class="p">(</span><span class="n">hal_port_sm_table</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">BFA_PORT_ST_DISABLED</span><span class="p">;</span>

<span class="p">}</span>

<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_fcport_is_ratelim</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">ratelimit</span> <span class="o">?</span> <span class="n">BFA_TRUE</span> <span class="o">:</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Enable/Disable FAA feature in port config</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcport_cfg_faa</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">faa_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get default minimum ratelim speed</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">bfa_port_speed</span>
<span class="nf">bfa_fcport_get_ratelim_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trl_def_speed</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trl_def_speed</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcport_beacon</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">beacon</span><span class="p">,</span>
		  <span class="n">bfa_boolean_t</span> <span class="n">link_e2e_beacon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">beacon</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">link_e2e_beacon</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">link_e2e_beacon</span><span class="p">);</span>

	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">beacon</span> <span class="o">=</span> <span class="n">beacon</span><span class="p">;</span>
	<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">link_e2e_beacon</span> <span class="o">=</span> <span class="n">link_e2e_beacon</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_fcport_is_linkup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span>	<span class="p">(</span><span class="o">!</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trunked</span> <span class="o">&amp;&amp;</span>
		 <span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">fcport</span><span class="p">,</span> <span class="n">bfa_fcport_sm_linkup</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trunked</span> <span class="o">&amp;&amp;</span>
		 <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">BFA_TRUNK_ONLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_fcport_is_qos_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">qos_enabled</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_fcport_is_trunk_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fcport</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">trunked</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Rport State machine functions</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Beginning state, only online event expected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_CREATE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_un_cr</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_created</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_un_unexp</span><span class="p">);</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_created</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_ONLINE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_cr_on</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_rport_send_fwcreate</span><span class="p">(</span><span class="n">rp</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_fwcreate</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_fwcreate_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_DELETE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_cr_del</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_rport_free</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_HWFAIL</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_cr_hwf</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_iocdisable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_cr_unexp</span><span class="p">);</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Waiting for rport create response from firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_fwcreate</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_FWRSP</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwc_rsp</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_online</span><span class="p">);</span>
		<span class="n">bfa_rport_online_cb</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_DELETE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwc_del</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_delete_pending</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_OFFLINE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwc_off</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_offline_pending</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_HWFAIL</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwc_hwf</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_iocdisable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwc_unexp</span><span class="p">);</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Request queue is full, awaiting queue resume to send create request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_fwcreate_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_fwcreate</span><span class="p">);</span>
		<span class="n">bfa_rport_send_fwcreate</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_DELETE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwc_del</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_rport_free</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_OFFLINE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwc_off</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_rport_offline_cb</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_HWFAIL</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwc_hwf</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_iocdisable</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwc_unexp</span><span class="p">);</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Online state - normal parking state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_rport_qos_scn_s</span> <span class="o">*</span><span class="n">qos_scn</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_OFFLINE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_on_off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_rport_send_fwdelete</span><span class="p">(</span><span class="n">rp</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_fwdelete</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_fwdelete_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_DELETE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_on_del</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_rport_send_fwdelete</span><span class="p">(</span><span class="n">rp</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_deleting</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_deleting_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_HWFAIL</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_on_hwf</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_iocdisable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_SET_SPEED</span>:
		<span class="n">bfa_rport_send_fwspeed</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_QOS_SCN</span>:
		<span class="n">qos_scn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_rport_qos_scn_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">event_arg</span><span class="p">.</span><span class="n">fw_msg</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">qos_attr</span> <span class="o">=</span> <span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">new_qos_attr</span><span class="p">;</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">old_qos_attr</span><span class="p">.</span><span class="n">qos_flow_id</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">new_qos_attr</span><span class="p">.</span><span class="n">qos_flow_id</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">old_qos_attr</span><span class="p">.</span><span class="n">qos_priority</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">new_qos_attr</span><span class="p">.</span><span class="n">qos_priority</span><span class="p">);</span>

		<span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">old_qos_attr</span><span class="p">.</span><span class="n">qos_flow_id</span>  <span class="o">=</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">old_qos_attr</span><span class="p">.</span><span class="n">qos_flow_id</span><span class="p">);</span>
		<span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">new_qos_attr</span><span class="p">.</span><span class="n">qos_flow_id</span>  <span class="o">=</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">new_qos_attr</span><span class="p">.</span><span class="n">qos_flow_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">old_qos_attr</span><span class="p">.</span><span class="n">qos_flow_id</span> <span class="o">!=</span>
			<span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">new_qos_attr</span><span class="p">.</span><span class="n">qos_flow_id</span><span class="p">)</span>
			<span class="n">bfa_cb_rport_qos_scn_flowid</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_drv</span><span class="p">,</span>
						    <span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">old_qos_attr</span><span class="p">,</span>
						    <span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">new_qos_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">old_qos_attr</span><span class="p">.</span><span class="n">qos_priority</span> <span class="o">!=</span>
			<span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">new_qos_attr</span><span class="p">.</span><span class="n">qos_priority</span><span class="p">)</span>
			<span class="n">bfa_cb_rport_qos_scn_prio</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_drv</span><span class="p">,</span>
						  <span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">old_qos_attr</span><span class="p">,</span>
						  <span class="n">qos_scn</span><span class="o">-&gt;</span><span class="n">new_qos_attr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_on_unexp</span><span class="p">);</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Firmware rport is being deleted - awaiting f/w response.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_fwdelete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_FWRSP</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwd_rsp</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_rport_offline_cb</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_DELETE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwd_del</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_deleting</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_HWFAIL</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwd_hwf</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_iocdisable</span><span class="p">);</span>
		<span class="n">bfa_rport_offline_cb</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwd_unexp</span><span class="p">);</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_fwdelete_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_QRESUME</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_fwdelete</span><span class="p">);</span>
		<span class="n">bfa_rport_send_fwdelete</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_DELETE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwd_del</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_deleting_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_HWFAIL</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwd_hwf</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_iocdisable</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_rport_offline_cb</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_fwd_unexp</span><span class="p">);</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Offline state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_DELETE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_off_del</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_rport_free</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_ONLINE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_off_on</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_rport_send_fwcreate</span><span class="p">(</span><span class="n">rp</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_fwcreate</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_fwcreate_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_HWFAIL</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_off_hwf</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_iocdisable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_off_unexp</span><span class="p">);</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Rport is deleted, waiting for firmware response to delete.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_deleting</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_FWRSP</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_del_fwrsp</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_rport_free</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_HWFAIL</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_del_hwf</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_rport_free</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_deleting_qfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_QRESUME</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_del_fwrsp</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_deleting</span><span class="p">);</span>
		<span class="n">bfa_rport_send_fwdelete</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_HWFAIL</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_del_hwf</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_reqq_wcancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="n">bfa_rport_free</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Waiting for rport create response from firmware. A delete is pending.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_delete_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_FWRSP</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_delp_fwrsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_rport_send_fwdelete</span><span class="p">(</span><span class="n">rp</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_deleting</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_deleting_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_HWFAIL</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_delp_hwf</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_rport_free</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_delp_unexp</span><span class="p">);</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Waiting for rport create response from firmware. Rport offline is pending.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_offline_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_FWRSP</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_offp_fwrsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_rport_send_fwdelete</span><span class="p">(</span><span class="n">rp</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_fwdelete</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_fwdelete_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_DELETE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_offp_del</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_delete_pending</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_HWFAIL</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_offp_hwf</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_iocdisable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_offp_unexp</span><span class="p">);</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IOC h/w failed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_sm_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_RPORT_SM_OFFLINE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_iocd_off</span><span class="p">);</span>
		<span class="n">bfa_rport_offline_cb</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_DELETE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_iocd_del</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_rport_free</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_ONLINE</span>:
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_iocd_on</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_rport_send_fwcreate</span><span class="p">(</span><span class="n">rp</span><span class="p">))</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_fwcreate</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_fwcreate_qfull</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_RPORT_SM_HWFAIL</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sm_iocd_unexp</span><span class="p">);</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  bfa_rport_private BFA rport private functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_rport_online</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">bfa_cb_rport_online</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_rport_offline</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">bfa_cb_rport_offline</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_qresume</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span>	<span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_QRESUME</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_meminfo_s</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_mem_kva_s</span> <span class="o">*</span><span class="n">rport_kva</span> <span class="o">=</span> <span class="n">BFA_MEM_RPORT_KVA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_rports</span> <span class="o">&lt;</span> <span class="n">BFA_RPORT_MIN</span><span class="p">)</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_rports</span> <span class="o">=</span> <span class="n">BFA_RPORT_MIN</span><span class="p">;</span>

	<span class="cm">/* kva memory */</span>
	<span class="n">bfa_mem_kva_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">rport_kva</span><span class="p">,</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_rports</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_rport_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_RPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_free_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_active_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_unused_q</span><span class="p">);</span>

	<span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">rps_list</span> <span class="o">=</span> <span class="n">rp</span><span class="p">;</span>
	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_rports</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_rports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span><span class="p">));</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_uninit</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 *  - is unused</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_free_q</span><span class="p">);</span>

		<span class="n">bfa_reqq_winit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">,</span> <span class="n">bfa_rport_qresume</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * consume memory</span>
<span class="cm">	 */</span>
	<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">rp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_rport_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_RPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="cm">/* Enqueue unused rport resources to free_q */</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_unused_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_free_q</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_active_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_HWFAIL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span>
<span class="nf">bfa_rport_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_mod_s</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_active_q</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rport</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_rport_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_rport_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_RPORT_MOD</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bfa_q_is_on_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_active_q</span><span class="p">,</span> <span class="n">rport</span><span class="p">));</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_free_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bfa_boolean_t</span>
<span class="nf">bfa_rport_send_fwcreate</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_rport_create_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for room in queue to send request now</span>
<span class="cm">	 */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_RPORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_RPORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_RPORT</span><span class="p">,</span> <span class="n">BFI_RPORT_H2I_CREATE_REQ</span><span class="p">,</span>
			<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">bfa_handle</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">max_frmsz</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">max_frmsz</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">lp_fwtag</span> <span class="o">=</span> <span class="n">bfa_lps_get_fwtag</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">lp_tag</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">local_pid</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">local_pid</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">fc_class</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">fc_class</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">vf_en</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">vf_en</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">vf_id</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">vf_id</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">cisc</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">cisc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue I/O message to firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_RPORT</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bfa_boolean_t</span>
<span class="nf">bfa_rport_send_fwdelete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_rport_delete_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for room in queue to send request now</span>
<span class="cm">	 */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_RPORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_reqq_wait</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_RPORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">reqq_wait</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_RPORT</span><span class="p">,</span> <span class="n">BFI_RPORT_H2I_DELETE_REQ</span><span class="p">,</span>
			<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">fw_handle</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue I/O message to firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_RPORT</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bfa_boolean_t</span>
<span class="nf">bfa_rport_send_fwspeed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_rport_speed_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for room in queue to send request now</span>
<span class="cm">	 */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_RPORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_RPORT</span><span class="p">,</span> <span class="n">BFI_RPORT_H2I_SET_SPEED_REQ</span><span class="p">,</span>
			<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">fw_handle</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue I/O message to firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_RPORT</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  bfa_rport_public</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Rport interrupt processing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_rport_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">bfi_rport_i2h_msg_u</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFI_RPORT_I2H_CREATE_RSP</span>:
		<span class="n">rp</span> <span class="o">=</span> <span class="n">BFA_RPORT_FROM_TAG</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">create_rsp</span><span class="o">-&gt;</span><span class="n">bfa_handle</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">fw_handle</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">create_rsp</span><span class="o">-&gt;</span><span class="n">fw_handle</span><span class="p">;</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">qos_attr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">create_rsp</span><span class="o">-&gt;</span><span class="n">qos_attr</span><span class="p">;</span>
		<span class="n">bfa_rport_set_lunmask</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">create_rsp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_FWRSP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_RPORT_I2H_DELETE_RSP</span>:
		<span class="n">rp</span> <span class="o">=</span> <span class="n">BFA_RPORT_FROM_TAG</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">delete_rsp</span><span class="o">-&gt;</span><span class="n">bfa_handle</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">delete_rsp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">);</span>
		<span class="n">bfa_rport_unset_lunmask</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_FWRSP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_RPORT_I2H_QOS_SCN</span>:
		<span class="n">rp</span> <span class="o">=</span> <span class="n">BFA_RPORT_FROM_TAG</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">qos_scn_evt</span><span class="o">-&gt;</span><span class="n">bfa_handle</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">event_arg</span><span class="p">.</span><span class="n">fw_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">qos_scn_evt</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_QOS_SCN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_rport_res_recfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u16</span> <span class="n">num_rport_fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_rport_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_RPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">-</span> <span class="n">num_rport_fw</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_q_deq_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">rp_unused_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  bfa_rport_api</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span>
<span class="nf">bfa_rport_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">rport_drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>

	<span class="n">rp</span> <span class="o">=</span> <span class="n">bfa_rport_alloc</span><span class="p">(</span><span class="n">BFA_RPORT_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_drv</span> <span class="o">=</span> <span class="n">rport_drv</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">bfa_rport_sm_uninit</span><span class="p">));</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_CREATE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_rport_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_rport_info_s</span> <span class="o">*</span><span class="n">rport_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rport_info</span><span class="o">-&gt;</span><span class="n">max_frmsz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some JBODs are seen to be not setting PDU size correctly in PLOGI</span>
<span class="cm">	 * responses. Default to minimum size.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport_info</span><span class="o">-&gt;</span><span class="n">max_frmsz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">);</span>
		<span class="n">rport_info</span><span class="o">-&gt;</span><span class="n">max_frmsz</span> <span class="o">=</span> <span class="n">FC_MIN_PDUSZ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">rport_info</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_ONLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_rport_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_port_speed</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_AUTO</span><span class="p">);</span>

	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">BFA_RPORT_SM_SET_SPEED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set Rport LUN Mask */</span>
<span class="kt">void</span>
<span class="nf">bfa_rport_set_lunmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">lps_mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">wwn_t</span>	<span class="n">lp_wwn</span><span class="p">,</span> <span class="n">rp_wwn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lp_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">lp_tag</span><span class="p">;</span>

	<span class="n">rp_wwn</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_drv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>
	<span class="n">lp_wwn</span> <span class="o">=</span> <span class="p">(</span><span class="n">BFA_LPS_FROM_TAG</span><span class="p">(</span><span class="n">lps_mod</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">lp_tag</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>

	<span class="n">BFA_LPS_FROM_TAG</span><span class="p">(</span><span class="n">lps_mod</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">lp_tag</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lun_mask</span> <span class="o">=</span>
					<span class="n">rp</span><span class="o">-&gt;</span><span class="n">lun_mask</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="n">bfa_fcpim_lunmask_rp_update</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lp_wwn</span><span class="p">,</span> <span class="n">rp_wwn</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_tag</span><span class="p">,</span> <span class="n">lp_tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Unset Rport LUN mask */</span>
<span class="kt">void</span>
<span class="nf">bfa_rport_unset_lunmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_lps_mod_s</span>	<span class="o">*</span><span class="n">lps_mod</span> <span class="o">=</span> <span class="n">BFA_LPS_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">wwn_t</span>	<span class="n">lp_wwn</span><span class="p">,</span> <span class="n">rp_wwn</span><span class="p">;</span>

	<span class="n">rp_wwn</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_drv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>
	<span class="n">lp_wwn</span> <span class="o">=</span> <span class="p">(</span><span class="n">BFA_LPS_FROM_TAG</span><span class="p">(</span><span class="n">lps_mod</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">lp_tag</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>

	<span class="n">BFA_LPS_FROM_TAG</span><span class="p">(</span><span class="n">lps_mod</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">rport_info</span><span class="p">.</span><span class="n">lp_tag</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lun_mask</span> <span class="o">=</span>
				<span class="n">rp</span><span class="o">-&gt;</span><span class="n">lun_mask</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">bfa_fcpim_lunmask_rp_update</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">lp_wwn</span><span class="p">,</span> <span class="n">rp_wwn</span><span class="p">,</span>
			<span class="n">BFA_RPORT_TAG_INVALID</span><span class="p">,</span> <span class="n">BFA_LP_TAG_INVALID</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SGPG related functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Compute and return memory needed by FCP(im) module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_sgpg_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_meminfo_s</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_sgpg_mod_s</span> <span class="o">*</span><span class="n">sgpg_mod</span> <span class="o">=</span> <span class="n">BFA_SGPG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_kva_s</span> <span class="o">*</span><span class="n">sgpg_kva</span> <span class="o">=</span> <span class="n">BFA_MEM_SGPG_KVA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">seg_ptr</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">nsegs</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">per_seg_sgpg</span><span class="p">,</span> <span class="n">num_sgpg</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">sgpg_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_sgpg_s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sgpgs</span> <span class="o">&lt;</span> <span class="n">BFA_SGPG_MIN</span><span class="p">)</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sgpgs</span> <span class="o">=</span> <span class="n">BFA_SGPG_MIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sgpgs</span> <span class="o">&gt;</span> <span class="n">BFA_SGPG_MAX</span><span class="p">)</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sgpgs</span> <span class="o">=</span> <span class="n">BFA_SGPG_MAX</span><span class="p">;</span>

	<span class="n">num_sgpg</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sgpgs</span><span class="p">;</span>

	<span class="n">nsegs</span> <span class="o">=</span> <span class="n">BFI_MEM_DMA_NSEGS</span><span class="p">(</span><span class="n">num_sgpg</span><span class="p">,</span> <span class="n">sgpg_sz</span><span class="p">);</span>
	<span class="n">per_seg_sgpg</span> <span class="o">=</span> <span class="n">BFI_MEM_NREQS_SEG</span><span class="p">(</span><span class="n">sgpg_sz</span><span class="p">);</span>

	<span class="n">bfa_mem_dma_seg_iter</span><span class="p">(</span><span class="n">sgpg_mod</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span> <span class="n">nsegs</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_sgpg</span> <span class="o">&gt;=</span> <span class="n">per_seg_sgpg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">num_sgpg</span> <span class="o">-=</span> <span class="n">per_seg_sgpg</span><span class="p">;</span>
			<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span>
					<span class="n">per_seg_sgpg</span> <span class="o">*</span> <span class="n">sgpg_sz</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span>
					<span class="n">num_sgpg</span> <span class="o">*</span> <span class="n">sgpg_sz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* kva memory */</span>
	<span class="n">bfa_mem_kva_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">sgpg_kva</span><span class="p">,</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sgpgs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_sgpg_s</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_sgpg_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_sgpg_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_SGPG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_sgpg_s</span> <span class="o">*</span><span class="n">hsgpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_sgpg_s</span> <span class="o">*</span><span class="n">sgpg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">align_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">seg_ptr</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">sgpg_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_sgpg_s</span><span class="p">);</span>
	<span class="n">u16</span>	<span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">nsegs</span><span class="p">,</span> <span class="n">per_seg_sgpg</span><span class="p">,</span> <span class="n">num_sgpg</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">pa</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">bfi_addr_u</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">sgpg_pa</span><span class="p">,</span> <span class="n">sgpg_pa_tmp</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sgpg_wait_q</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sgpgs</span><span class="p">);</span>

	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">free_sgpgs</span> <span class="o">=</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_sgpgs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sgpgs</span><span class="p">;</span>

	<span class="n">num_sgpg</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sgpgs</span><span class="p">;</span>
	<span class="n">nsegs</span> <span class="o">=</span> <span class="n">BFI_MEM_DMA_NSEGS</span><span class="p">(</span><span class="n">num_sgpg</span><span class="p">,</span> <span class="n">sgpg_sz</span><span class="p">);</span>

	<span class="cm">/* dma/kva mem claim */</span>
	<span class="n">hsgpg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_sgpg_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>

	<span class="n">bfa_mem_dma_seg_iter</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span> <span class="n">nsegs</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_mem_dma_virt</span><span class="p">(</span><span class="n">seg_ptr</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">align_len</span> <span class="o">=</span> <span class="n">BFA_SGPG_ROUNDUP</span><span class="p">(</span><span class="n">bfa_mem_dma_phys</span><span class="p">(</span><span class="n">seg_ptr</span><span class="p">))</span> <span class="o">-</span>
					     <span class="n">bfa_mem_dma_phys</span><span class="p">(</span><span class="n">seg_ptr</span><span class="p">);</span>

		<span class="n">sgpg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_sgpg_s</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_dma_virt</span><span class="p">(</span><span class="n">seg_ptr</span><span class="p">))</span> <span class="o">+</span> <span class="n">align_len</span><span class="p">);</span>
		<span class="n">sgpg_pa</span><span class="p">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">bfa_mem_dma_phys</span><span class="p">(</span><span class="n">seg_ptr</span><span class="p">)</span> <span class="o">+</span> <span class="n">align_len</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">sgpg_pa</span><span class="p">.</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sgpg_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

		<span class="n">per_seg_sgpg</span> <span class="o">=</span> <span class="p">(</span><span class="n">seg_ptr</span><span class="o">-&gt;</span><span class="n">mem_len</span> <span class="o">-</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">align_len</span><span class="p">)</span> <span class="o">/</span> <span class="n">sgpg_sz</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">num_sgpg</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">per_seg_sgpg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">num_sgpg</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">hsgpg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hsgpg</span><span class="p">));</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">sgpg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sgpg</span><span class="p">));</span>

			<span class="n">hsgpg</span><span class="o">-&gt;</span><span class="n">sgpg</span> <span class="o">=</span> <span class="n">sgpg</span><span class="p">;</span>
			<span class="n">sgpg_pa_tmp</span><span class="p">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">bfa_sgaddr_le</span><span class="p">(</span><span class="n">sgpg_pa</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
			<span class="n">hsgpg</span><span class="o">-&gt;</span><span class="n">sgpg_pa</span> <span class="o">=</span> <span class="n">sgpg_pa_tmp</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsgpg</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">);</span>

			<span class="n">sgpg</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hsgpg</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sgpg_pa</span><span class="p">.</span><span class="n">pa</span> <span class="o">+=</span> <span class="n">sgpg_sz</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">hsgpg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_sgpg_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_sgpg_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_sgpg_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_sgpg_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_sgpg_malloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">sgpg_q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nsgpgs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_sgpg_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_SGPG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_sgpg_s</span> <span class="o">*</span><span class="n">hsgpg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">free_sgpgs</span> <span class="o">&lt;</span> <span class="n">nsgpgs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nsgpgs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsgpg</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">hsgpg</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsgpg</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="n">sgpg_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">free_sgpgs</span> <span class="o">-=</span> <span class="n">nsgpgs</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_sgpg_mfree</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">sgpg_q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nsgpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_sgpg_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_SGPG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_sgpg_wqe_s</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>

	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">free_sgpgs</span> <span class="o">+=</span> <span class="n">nsgpg</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">free_sgpgs</span> <span class="o">&gt;</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_sgpgs</span><span class="p">);</span>

	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="n">sgpg_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sgpg_wait_q</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * satisfy as many waiting requests as possible</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">wqe</span> <span class="o">=</span> <span class="n">bfa_q_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sgpg_wait_q</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">free_sgpgs</span> <span class="o">&lt;</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nsgpg</span><span class="p">)</span>
			<span class="n">nsgpg</span> <span class="o">=</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">free_sgpgs</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">nsgpg</span> <span class="o">=</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nsgpg</span><span class="p">;</span>
		<span class="n">bfa_sgpg_malloc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">,</span> <span class="n">nsgpg</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nsgpg</span> <span class="o">-=</span> <span class="n">nsgpg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nsgpg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
			<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="p">(</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">cbarg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">free_sgpgs</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sgpg_wait_q</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_sgpg_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_sgpg_wqe_s</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nsgpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_sgpg_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_SGPG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">nsgpg</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">nsgpg</span> <span class="o">&lt;=</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">free_sgpgs</span><span class="p">);</span>

	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nsgpg_total</span> <span class="o">=</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nsgpg</span> <span class="o">=</span> <span class="n">nsgpg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate any left to this one first</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">free_sgpgs</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * no one else is waiting for SGPG</span>
<span class="cm">		 */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sgpg_wait_q</span><span class="p">));</span>
		<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">);</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nsgpg</span> <span class="o">-=</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">free_sgpgs</span><span class="p">;</span>
		<span class="n">mod</span><span class="o">-&gt;</span><span class="n">free_sgpgs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sgpg_wait_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_sgpg_wcancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_sgpg_wqe_s</span> <span class="o">*</span><span class="n">wqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_sgpg_mod_s</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_SGPG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bfa_q_is_on_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sgpg_wait_q</span><span class="p">,</span> <span class="n">wqe</span><span class="p">));</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nsgpg_total</span> <span class="o">!=</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nsgpg</span><span class="p">)</span>
		<span class="n">bfa_sgpg_mfree</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">,</span>
				   <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nsgpg_total</span> <span class="o">-</span> <span class="n">wqe</span><span class="o">-&gt;</span><span class="n">nsgpg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_sgpg_winit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_sgpg_wqe_s</span> <span class="o">*</span><span class="n">wqe</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cbfn</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">),</span>
		   <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">sgpg_q</span><span class="p">);</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">cbfn</span> <span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">cbarg</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  UF related functions</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> * Internal functions</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__bfa_cb_uf_recv</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_uf_s</span>   <span class="o">*</span><span class="n">uf</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">ufm</span> <span class="o">=</span> <span class="n">BFA_UF_MOD</span><span class="p">(</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">ufm</span><span class="o">-&gt;</span><span class="n">ufrecv</span><span class="p">(</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">uf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claim_uf_post_msgs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">ufm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_uf_buf_post_s</span> <span class="o">*</span><span class="n">uf_bp_msg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_buf_posts</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_uf_buf_post_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">ufm</span><span class="p">);</span>
	<span class="n">uf_bp_msg</span> <span class="o">=</span> <span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_buf_posts</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uf_bp_msg</span> <span class="o">=</span> <span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_buf_posts</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ufm</span><span class="o">-&gt;</span><span class="n">num_ufs</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">uf_bp_msg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">uf_bp_msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_uf_buf_post_s</span><span class="p">));</span>

		<span class="n">uf_bp_msg</span><span class="o">-&gt;</span><span class="n">buf_tag</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">buf_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_buf_s</span><span class="p">);</span>
		<span class="n">uf_bp_msg</span><span class="o">-&gt;</span><span class="n">buf_len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">buf_len</span><span class="p">);</span>
		<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">uf_bp_msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_UF</span><span class="p">,</span> <span class="n">BFI_UF_H2I_BUF_POST</span><span class="p">,</span>
			    <span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
		<span class="n">bfa_alen_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf_bp_msg</span><span class="o">-&gt;</span><span class="n">alen</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">ufm_pbs_pa</span><span class="p">(</span><span class="n">ufm</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * advance pointer beyond consumed memory</span>
<span class="cm">	 */</span>
	<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">ufm</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">uf_bp_msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claim_ufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">ufm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_uf_s</span>   <span class="o">*</span><span class="n">uf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Claim block of memory for UF list</span>
<span class="cm">	 */</span>
	<span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_list</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">ufm</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize UFs and queue it in UF free queue</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uf</span> <span class="o">=</span> <span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_list</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ufm</span><span class="o">-&gt;</span><span class="n">num_ufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">uf</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">uf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_s</span><span class="p">));</span>
		<span class="n">uf</span><span class="o">-&gt;</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">ufm</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">;</span>
		<span class="n">uf</span><span class="o">-&gt;</span><span class="n">uf_tag</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">uf</span><span class="o">-&gt;</span><span class="n">pb_len</span> <span class="o">=</span> <span class="n">BFA_PER_UF_DMA_SZ</span><span class="p">;</span>
		<span class="n">uf</span><span class="o">-&gt;</span><span class="n">buf_kva</span> <span class="o">=</span> <span class="n">bfa_mem_get_dmabuf_kva</span><span class="p">(</span><span class="n">ufm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">BFA_PER_UF_DMA_SZ</span><span class="p">);</span>
		<span class="n">uf</span><span class="o">-&gt;</span><span class="n">buf_pa</span> <span class="o">=</span> <span class="n">ufm_pbs_pa</span><span class="p">(</span><span class="n">ufm</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_free_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * advance memory pointer</span>
<span class="cm">	 */</span>
	<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">ufm</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">uf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">uf_mem_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">ufm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">claim_ufs</span><span class="p">(</span><span class="n">ufm</span><span class="p">);</span>
	<span class="n">claim_uf_post_msgs</span><span class="p">(</span><span class="n">ufm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_uf_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_meminfo_s</span> <span class="o">*</span><span class="n">minfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">ufm</span> <span class="o">=</span> <span class="n">BFA_UF_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_kva_s</span> <span class="o">*</span><span class="n">uf_kva</span> <span class="o">=</span> <span class="n">BFA_MEM_UF_KVA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">u32</span>	<span class="n">num_ufs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_uf_bufs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">seg_ptr</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">nsegs</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">per_seg_uf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nsegs</span> <span class="o">=</span> <span class="n">BFI_MEM_DMA_NSEGS</span><span class="p">(</span><span class="n">num_ufs</span><span class="p">,</span> <span class="n">BFA_PER_UF_DMA_SZ</span><span class="p">);</span>
	<span class="n">per_seg_uf</span> <span class="o">=</span> <span class="n">BFI_MEM_NREQS_SEG</span><span class="p">(</span><span class="n">BFA_PER_UF_DMA_SZ</span><span class="p">);</span>

	<span class="n">bfa_mem_dma_seg_iter</span><span class="p">(</span><span class="n">ufm</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span> <span class="n">nsegs</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_ufs</span> <span class="o">&gt;=</span> <span class="n">per_seg_uf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">num_ufs</span> <span class="o">-=</span> <span class="n">per_seg_uf</span><span class="p">;</span>
			<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span>
				<span class="n">per_seg_uf</span> <span class="o">*</span> <span class="n">BFA_PER_UF_DMA_SZ</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">seg_ptr</span><span class="p">,</span>
				<span class="n">num_ufs</span> <span class="o">*</span> <span class="n">BFA_PER_UF_DMA_SZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* kva memory */</span>
	<span class="n">bfa_mem_kva_setup</span><span class="p">(</span><span class="n">minfo</span><span class="p">,</span> <span class="n">uf_kva</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_uf_bufs</span> <span class="o">*</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_s</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_uf_buf_post_s</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_uf_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">ufm</span> <span class="o">=</span> <span class="n">BFA_UF_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">ufm</span><span class="o">-&gt;</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>
	<span class="n">ufm</span><span class="o">-&gt;</span><span class="n">num_ufs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_uf_bufs</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_free_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_posted_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_unused_q</span><span class="p">);</span>

	<span class="n">uf_mem_claim</span><span class="p">(</span><span class="n">ufm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_uf_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_uf_s</span> <span class="o">*</span>
<span class="nf">bfa_uf_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">uf_mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_uf_s</span>   <span class="o">*</span><span class="n">uf</span><span class="p">;</span>

	<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf_mod</span><span class="o">-&gt;</span><span class="n">uf_free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">uf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_uf_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">uf_mod</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_uf_s</span> <span class="o">*</span><span class="n">uf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf_mod</span><span class="o">-&gt;</span><span class="n">uf_free_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bfa_status_t</span>
<span class="nf">bfa_uf_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">ufm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_uf_s</span> <span class="o">*</span><span class="n">uf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_uf_buf_post_s</span> <span class="o">*</span><span class="n">uf_post_msg</span><span class="p">;</span>

	<span class="n">uf_post_msg</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_FCXP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uf_post_msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_FAILED</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">uf_post_msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_buf_posts</span><span class="p">[</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">uf_tag</span><span class="p">],</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_uf_buf_post_s</span><span class="p">));</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_FCXP</span><span class="p">,</span> <span class="n">uf_post_msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">uf</span><span class="o">-&gt;</span><span class="n">uf_tag</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_posted_q</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_uf_post_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">uf_mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_uf_s</span>   <span class="o">*</span><span class="n">uf</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">uf</span> <span class="o">=</span> <span class="n">bfa_uf_get</span><span class="p">(</span><span class="n">uf_mod</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_uf_post</span><span class="p">(</span><span class="n">uf_mod</span><span class="p">,</span> <span class="n">uf</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">uf_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_uf_frm_rcvd_s</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">ufm</span> <span class="o">=</span> <span class="n">BFA_UF_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">uf_tag</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">buf_tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_uf_s</span> <span class="o">*</span><span class="n">uf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_list</span><span class="p">[</span><span class="n">uf_tag</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bfa_uf_buf_s</span> <span class="o">*</span><span class="n">uf_buf</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">fchs</span><span class="p">;</span>

	<span class="n">uf_buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_buf_s</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">bfa_mem_get_dmabuf_kva</span><span class="p">(</span><span class="n">ufm</span><span class="p">,</span> <span class="n">uf_tag</span><span class="p">,</span> <span class="n">uf</span><span class="o">-&gt;</span><span class="n">pb_len</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uf_buf</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">frm_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">frm_len</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">xfr_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">xfr_len</span><span class="p">);</span>

	<span class="n">fchs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="p">)</span><span class="n">uf_buf</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>	<span class="cm">/* dequeue from posted queue */</span>

	<span class="n">uf</span><span class="o">-&gt;</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">uf</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">xfr_len</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fchs_s</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fchs_s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_plog_fchdr</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL_UF</span><span class="p">,</span> <span class="n">BFA_PL_EID_RX</span><span class="p">,</span>
			       <span class="n">uf</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pld_w0</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fchs_s</span><span class="p">)));</span>
		<span class="n">bfa_plog_fchdr_and_pl</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL_UF</span><span class="p">,</span>
				      <span class="n">BFA_PL_EID_RX</span><span class="p">,</span> <span class="n">uf</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span>
				      <span class="p">(</span><span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">pld_w0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">)</span>
		<span class="n">__bfa_cb_uf_recv</span><span class="p">(</span><span class="n">uf</span><span class="p">,</span> <span class="n">BFA_TRUE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">hcb_qe</span><span class="p">,</span> <span class="n">__bfa_cb_uf_recv</span><span class="p">,</span> <span class="n">uf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_uf_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_uf_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">ufm</span> <span class="o">=</span> <span class="n">BFA_UF_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_uf_s</span> <span class="o">*</span><span class="n">uf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="cm">/* Enqueue unused uf resources to free_q */</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_unused_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_free_q</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ufm</span><span class="o">-&gt;</span><span class="n">uf_posted_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">bfa_uf_put</span><span class="p">(</span><span class="n">ufm</span><span class="p">,</span> <span class="n">uf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_uf_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_uf_post_all</span><span class="p">(</span><span class="n">BFA_UF_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register handler for all unsolicted receive frames.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	bfa		BFA instance</span>
<span class="cm"> * @param[in]	ufrecv	receive handler function</span>
<span class="cm"> * @param[in]	cbarg	receive handler arg</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_uf_recv_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_cb_uf_recv_t</span> <span class="n">ufrecv</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_uf_mod_s</span> <span class="o">*</span><span class="n">ufm</span> <span class="o">=</span> <span class="n">BFA_UF_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">ufm</span><span class="o">-&gt;</span><span class="n">ufrecv</span> <span class="o">=</span> <span class="n">ufrecv</span><span class="p">;</span>
	<span class="n">ufm</span><span class="o">-&gt;</span><span class="n">cbarg</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Free an unsolicited frame back to BFA.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]		uf		unsolicited frame to be freed</span>
<span class="cm"> *</span>
<span class="cm"> * @return None</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_uf_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_uf_s</span> <span class="o">*</span><span class="n">uf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_uf_put</span><span class="p">(</span><span class="n">BFA_UF_MOD</span><span class="p">(</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">),</span> <span class="n">uf</span><span class="p">);</span>
	<span class="n">bfa_uf_post_all</span><span class="p">(</span><span class="n">BFA_UF_MOD</span><span class="p">(</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  uf_pub BFA uf module public functions</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_uf_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFI_UF_I2H_FRM_RCVD</span>:
		<span class="n">uf_recv</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_uf_frm_rcvd_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_uf_res_recfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u16</span> <span class="n">num_uf_fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_uf_mod_s</span>	<span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">BFA_UF_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_ufs</span> <span class="o">-</span> <span class="n">num_uf_fw</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_q_deq_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">uf_free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">uf_unused_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	BFA fcdiag module</span>
<span class="cm"> */</span>
<span class="cp">#define BFA_DIAG_QTEST_TOV	1000    </span><span class="cm">/* msec */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *	Set port status to busy</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcdiag_set_busy_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcdiag_s</span> <span class="o">*</span><span class="n">fcdiag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcport_s</span> <span class="o">*</span><span class="n">fcport</span> <span class="o">=</span> <span class="n">BFA_FCPORT_MOD</span><span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">diag_busy</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fcport</span><span class="o">-&gt;</span><span class="n">diag_busy</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcdiag_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_meminfo_s</span> <span class="o">*</span><span class="n">meminfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcdiag_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcdiag_s</span> <span class="o">*</span><span class="n">fcdiag</span> <span class="o">=</span> <span class="n">BFA_FCDIAG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">bfa</span>             <span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">trcmod</span>  <span class="o">=</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">trcmod</span><span class="p">;</span>
	<span class="cm">/* The common DIAG attach bfa_diag_attach() will do all memory claim */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcdiag_iocdisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcdiag_s</span> <span class="o">*</span><span class="n">fcdiag</span> <span class="o">=</span> <span class="n">BFA_FCDIAG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">BFA_STATUS_IOC_FAILURE</span><span class="p">;</span>
		<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">cbfn</span><span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
		<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcdiag_set_busy_status</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcdiag_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcdiag_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcdiag_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcdiag_queuetest_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcdiag_s</span>       <span class="o">*</span><span class="n">fcdiag</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_diag_qtest_result_s</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">result</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">all</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>

	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">timer_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">BFA_STATUS_ETIMER</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">count</span>  <span class="o">=</span> <span class="n">QTEST_CNT_DEFAULT</span> <span class="o">-</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">all</span><span class="p">)</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">queue</span>  <span class="o">=</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">all</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">BFA_STATUS_ETIMER</span><span class="p">);</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">BFA_STATUS_ETIMER</span><span class="p">;</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">cbfn</span><span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bfa_status_t</span>
<span class="nf">bfa_fcdiag_queuetest_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcdiag_s</span> <span class="o">*</span><span class="n">fcdiag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_diag_qtest_req_s</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_DEVBUSY</span><span class="p">;</span>

	<span class="cm">/* build host command */</span>
	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_DIAG</span><span class="p">,</span> <span class="n">BFI_DIAG_H2I_QTEST</span><span class="p">,</span>
		<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFI_LMSG_PL_WSZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">QTEST_PAT_DEFAULT</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="cm">/* ring door bell */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcdiag_queuetest_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcdiag_s</span> <span class="o">*</span><span class="n">fcdiag</span><span class="p">,</span>
			<span class="n">bfi_diag_qtest_rsp_t</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_diag_qtest_result_s</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">result</span><span class="p">;</span>
	<span class="n">bfa_status_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Check timer, should still be active   */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">timer_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">timer_active</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update count */</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* Check result */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFI_LMSG_PL_WSZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">~</span><span class="p">(</span><span class="n">QTEST_PAT_DEFAULT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">BFA_STATUS_DATACORRUPTED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">bfa_fcdiag_queuetest_send</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">all</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">queue</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">BFI_IOC_MAX_CQS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">QTEST_CNT_DEFAULT</span><span class="p">;</span>
			<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">queue</span><span class="o">++</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">bfa_fcdiag_queuetest_send</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Stop timer when we comp all queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">timer_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">timer_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">QTEST_CNT_DEFAULT</span> <span class="o">-</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">cbfn</span><span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcdiag_loopback_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcdiag_s</span> <span class="o">*</span><span class="n">fcdiag</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bfi_diag_lb_rsp_s</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_diag_loopback_result_s</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">result</span><span class="p">;</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">numtxmfrm</span>  <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">numtxmfrm</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">numosffrm</span>  <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">numosffrm</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">numrcvfrm</span>  <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">numrcvfrm</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">badfrminf</span>  <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">badfrminf</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">badfrmnum</span>  <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">badfrmnum</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">status</span>     <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">cbfn</span><span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bfa_fcdiag_set_busy_status</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bfa_status_t</span>
<span class="nf">bfa_fcdiag_loopback_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcdiag_s</span> <span class="o">*</span><span class="n">fcdiag</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bfa_diag_loopback_s</span> <span class="o">*</span><span class="n">loopback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_diag_lb_req_s</span> <span class="o">*</span><span class="n">lb_req</span><span class="p">;</span>

	<span class="n">lb_req</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_DIAG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lb_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_DEVBUSY</span><span class="p">;</span>

	<span class="cm">/* build host command */</span>
	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">lb_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_DIAG</span><span class="p">,</span> <span class="n">BFI_DIAG_H2I_LOOPBACK</span><span class="p">,</span>
		<span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>

	<span class="n">lb_req</span><span class="o">-&gt;</span><span class="n">lb_mode</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">lb_mode</span><span class="p">;</span>
	<span class="n">lb_req</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
	<span class="n">lb_req</span><span class="o">-&gt;</span><span class="n">loopcnt</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">loopcnt</span><span class="p">;</span>
	<span class="n">lb_req</span><span class="o">-&gt;</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">;</span>

	<span class="cm">/* ring door bell */</span>
	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_DIAG</span><span class="p">,</span> <span class="n">lb_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">lb_mode</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">loopcnt</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">loopback</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	cpe/rme intr handler</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcdiag_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcdiag_s</span> <span class="o">*</span><span class="n">fcdiag</span> <span class="o">=</span> <span class="n">BFA_FCDIAG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFI_DIAG_I2H_LOOPBACK</span>:
		<span class="n">bfa_fcdiag_loopback_comp</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">bfi_diag_lb_rsp_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFI_DIAG_I2H_QTEST</span>:
		<span class="n">bfa_fcdiag_queuetest_comp</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="p">(</span><span class="n">bfi_diag_qtest_rsp_t</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Loopback test</span>
<span class="cm"> *</span>
<span class="cm"> *   @param[in] *bfa            - bfa data struct</span>
<span class="cm"> *   @param[in] opmode          - port operation mode</span>
<span class="cm"> *   @param[in] speed           - port speed</span>
<span class="cm"> *   @param[in] lpcnt           - loop count</span>
<span class="cm"> *   @param[in] pat                     - pattern to build packet</span>
<span class="cm"> *   @param[in] *result         - pt to bfa_diag_loopback_result_t data struct</span>
<span class="cm"> *   @param[in] cbfn            - callback function</span>
<span class="cm"> *   @param[in] cbarg           - callback functioin arg</span>
<span class="cm"> *</span>
<span class="cm"> *   @param[out]</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcdiag_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_port_opmode</span> <span class="n">opmode</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">bfa_port_speed</span> <span class="n">speed</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lpcnt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pat</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_diag_loopback_result_s</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="n">bfa_cb_diag_t</span> <span class="n">cbfn</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>  <span class="n">bfa_diag_loopback_s</span> <span class="n">loopback</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_port_attr_s</span> <span class="n">attr</span><span class="p">;</span>
	<span class="n">bfa_status_t</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcdiag_s</span> <span class="o">*</span><span class="n">fcdiag</span> <span class="o">=</span> <span class="n">BFA_FCDIAG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_iocfc_is_operational</span><span class="p">(</span><span class="n">bfa</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_IOC_NON_OP</span><span class="p">;</span>

	<span class="cm">/* if port is PBC disabled, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_is_pbcdisabled</span><span class="p">(</span><span class="n">bfa</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">BFA_STATUS_PBC</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_PBC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcport_is_disabled</span><span class="p">(</span><span class="n">bfa</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">opmode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_PORT_NOT_DISABLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if input speed is supported by the port mode</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_get_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_IOC_TYPE_FC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_1GBPS</span> <span class="o">||</span>
		      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_2GBPS</span> <span class="o">||</span>
		      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_4GBPS</span> <span class="o">||</span>
		      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_8GBPS</span> <span class="o">||</span>
		      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_16GBPS</span> <span class="o">||</span>
		      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_AUTO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BFA_STATUS_UNSUPP_SPEED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bfa_fcport_get_attr</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">attr</span><span class="p">.</span><span class="n">speed_supported</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">attr</span><span class="p">.</span><span class="n">speed_supported</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">BFA_STATUS_UNSUPP_SPEED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">BFA_PORT_SPEED_10GBPS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BFA_STATUS_UNSUPP_SPEED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* For Mezz card, port speed entered needs to be checked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_mfg_is_mezz</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">card_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_get_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_IOC_TYPE_FC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_1GBPS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">bfa_asic_id_ct2</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">pcidev</span><span class="p">.</span><span class="n">device_id</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">BFA_STATUS_UNSUPP_SPEED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_1GBPS</span> <span class="o">||</span>
			      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_2GBPS</span> <span class="o">||</span>
			      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_4GBPS</span> <span class="o">||</span>
			      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_8GBPS</span> <span class="o">||</span>
			      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_16GBPS</span> <span class="o">||</span>
			      <span class="n">speed</span> <span class="o">==</span> <span class="n">BFA_PORT_SPEED_AUTO</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">BFA_STATUS_UNSUPP_SPEED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">BFA_PORT_SPEED_10GBPS</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">BFA_STATUS_UNSUPP_SPEED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check to see if there is another destructive diag cmd running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_DEVBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">loopback</span><span class="p">.</span><span class="n">lb_mode</span> <span class="o">=</span> <span class="n">opmode</span><span class="p">;</span>
	<span class="n">loopback</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">loopback</span><span class="p">.</span><span class="n">loopcnt</span> <span class="o">=</span> <span class="n">lpcnt</span><span class="p">;</span>
	<span class="n">loopback</span><span class="p">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">pat</span><span class="p">;</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">cbfn</span> <span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">cbarg</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_diag_loopback_result_s</span><span class="p">));</span>
	<span class="n">bfa_fcdiag_set_busy_status</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">);</span>

	<span class="cm">/* Send msg to fw */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">bfa_fcdiag_loopback_send</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">loopback</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	DIAG queue test command</span>
<span class="cm"> *</span>
<span class="cm"> *   @param[in] *bfa            - bfa data struct</span>
<span class="cm"> *   @param[in] force           - 1: don&#39;t do ioc op checking</span>
<span class="cm"> *   @param[in] queue           - queue no. to test</span>
<span class="cm"> *   @param[in] *result         - pt to bfa_diag_qtest_result_t data struct</span>
<span class="cm"> *   @param[in] cbfn            - callback function</span>
<span class="cm"> *   @param[in] *cbarg          - callback functioin arg</span>
<span class="cm"> *</span>
<span class="cm"> *   @param[out]</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcdiag_queuetest</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u32</span> <span class="n">force</span><span class="p">,</span> <span class="n">u32</span> <span class="n">queue</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_diag_qtest_result_s</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="n">bfa_cb_diag_t</span> <span class="n">cbfn</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcdiag_s</span> <span class="o">*</span><span class="n">fcdiag</span> <span class="o">=</span> <span class="n">BFA_FCDIAG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_status_t</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">force</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bfa_iocfc_is_operational</span><span class="p">(</span><span class="n">bfa</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_IOC_NON_OP</span><span class="p">;</span>

	<span class="cm">/* check to see if there is another destructive diag cmd running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">,</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_DEVBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialization */</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">cbfn</span> <span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">cbarg</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">QTEST_CNT_DEFAULT</span><span class="p">;</span>

	<span class="cm">/* Init test results */</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
	<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">count</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* send */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&lt;</span> <span class="n">BFI_IOC_MAX_CQS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">queue</span>  <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">queue</span><span class="p">;</span>
		<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">queue</span><span class="p">;</span>
		<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">all</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">queue</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">all</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">bfa_fcdiag_queuetest_send</span><span class="p">(</span><span class="n">fcdiag</span><span class="p">);</span>

	<span class="cm">/* Start a timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span>
				<span class="n">bfa_fcdiag_queuetest_timeout</span><span class="p">,</span> <span class="n">fcdiag</span><span class="p">,</span>
				<span class="n">BFA_DIAG_QTEST_TOV</span><span class="p">);</span>
		<span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">qtest</span><span class="p">.</span><span class="n">timer_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DIAG PLB is running</span>
<span class="cm"> *</span>
<span class="cm"> *   @param[in] *bfa    - bfa data struct</span>
<span class="cm"> *</span>
<span class="cm"> *   @param[out]</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcdiag_lb_is_running</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcdiag_s</span> <span class="o">*</span><span class="n">fcdiag</span> <span class="o">=</span> <span class="n">BFA_FCDIAG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fcdiag</span><span class="o">-&gt;</span><span class="n">lb</span><span class="p">.</span><span class="n">lock</span> <span class="o">?</span>  <span class="n">BFA_STATUS_DIAG_BUSY</span> <span class="o">:</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
