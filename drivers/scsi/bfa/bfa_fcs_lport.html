<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › bfa › bfa_fcs_lport.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bfa_fcs_lport.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2010 Brocade Communications Systems, Inc.</span>
<span class="cm"> * All rights reserved</span>
<span class="cm"> * www.brocade.com</span>
<span class="cm"> *</span>
<span class="cm"> * Linux driver for Brocade Fibre Channel Host Bus Adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License (GPL) Version 2 as</span>
<span class="cm"> * published by the Free Software Foundation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;bfad_drv.h&quot;</span>
<span class="cp">#include &quot;bfad_im.h&quot;</span>
<span class="cp">#include &quot;bfa_fcs.h&quot;</span>
<span class="cp">#include &quot;bfa_fcbuild.h&quot;</span>
<span class="cp">#include &quot;bfa_fc.h&quot;</span>

<span class="n">BFA_TRC_FILE</span><span class="p">(</span><span class="n">FCS</span><span class="p">,</span> <span class="n">PORT</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_send_ls_rjt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason_code</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">reason_code_expl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_plogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_logi_s</span> <span class="o">*</span><span class="n">plogi</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_online_actions</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_offline_actions</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_unknown_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_unknown_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_unknown_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_deleted</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_echo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fc_echo_s</span> <span class="o">*</span><span class="n">echo</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_rnid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fc_rnid_cmd_s</span> <span class="o">*</span><span class="n">rnid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fs_port_get_gen_topo_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fc_rnid_general_topology_data_s</span> <span class="o">*</span><span class="n">gen_topo_data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_lport_fab_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_lport_fab_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_lport_fab_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_lport_n2n_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_lport_n2n_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_lport_n2n_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">online</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">offline</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span> <span class="n">__port_action</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	<span class="n">bfa_fcs_lport_unknown_init</span><span class="p">,</span> <span class="n">bfa_fcs_lport_unknown_online</span><span class="p">,</span>
			<span class="n">bfa_fcs_lport_unknown_offline</span><span class="p">},</span> <span class="p">{</span>
	<span class="n">bfa_fcs_lport_fab_init</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fab_online</span><span class="p">,</span>
			<span class="n">bfa_fcs_lport_fab_offline</span><span class="p">},</span> <span class="p">{</span>
	<span class="n">bfa_fcs_lport_n2n_init</span><span class="p">,</span> <span class="n">bfa_fcs_lport_n2n_online</span><span class="p">,</span>
			<span class="n">bfa_fcs_lport_n2n_offline</span><span class="p">},</span>
	<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  fcs_port_sm FCS logical port state machine</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="p">{</span>
	<span class="n">BFA_FCS_PORT_SM_CREATE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">BFA_FCS_PORT_SM_ONLINE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">BFA_FCS_PORT_SM_OFFLINE</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">BFA_FCS_PORT_SM_DELETE</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">BFA_FCS_PORT_SM_DELRPORT</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">BFA_FCS_PORT_SM_STOP</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_sm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_sm_deleting</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_lport_sm_stopping</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="n">event</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_sm_uninit</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_CREATE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_init</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_sm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_ONLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_online</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_online_actions</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_deleted</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_STOP</span>:
		<span class="cm">/* If vport - send completion call back */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span>
			<span class="n">bfa_fcs_vport_stop_comp</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_OFFLINE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_sm_online</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_offline_actions</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_STOP</span>:
		<span class="n">__port_action</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">fab_type</span><span class="p">].</span><span class="n">offline</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_init</span><span class="p">);</span>
			<span class="cm">/* If vport - send completion call back */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span>
				<span class="n">bfa_fcs_vport_stop_comp</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_stopping</span><span class="p">);</span>
			<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
				<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_DELETE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_DELETE</span>:

		<span class="n">__port_action</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">fab_type</span><span class="p">].</span><span class="n">offline</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_uninit</span><span class="p">);</span>
			<span class="n">bfa_fcs_lport_deleted</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_deleting</span><span class="p">);</span>
			<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
				<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_DELETE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_DELRPORT</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_sm_offline</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_ONLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_online</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_online_actions</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_STOP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_init</span><span class="p">);</span>
			<span class="cm">/* If vport - send completion call back */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span>
				<span class="n">bfa_fcs_vport_stop_comp</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_stopping</span><span class="p">);</span>
			<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
				<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_DELETE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_DELETE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_uninit</span><span class="p">);</span>
			<span class="n">bfa_fcs_lport_deleted</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_deleting</span><span class="p">);</span>
			<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
				<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_DELETE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_DELRPORT</span>:
	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_OFFLINE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_sm_stopping</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_DELRPORT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_init</span><span class="p">);</span>
			<span class="cm">/* If vport - send completion call back */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span>
				<span class="n">bfa_fcs_vport_stop_comp</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_sm_deleting</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">bfa_fcs_lport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_PORT_SM_DELRPORT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_uninit</span><span class="p">);</span>
			<span class="n">bfa_fcs_lport_deleted</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  fcs_port_pvt</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Send AEN notification</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_aen_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_lport_aen_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_aen_entry_s</span>  <span class="o">*</span><span class="n">aen_entry</span><span class="p">;</span>

	<span class="n">bfad_get_aen_entry</span><span class="p">(</span><span class="n">bfad</span><span class="p">,</span> <span class="n">aen_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aen_entry</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">lport</span><span class="p">.</span><span class="n">vf_id</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">;</span>
	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">lport</span><span class="p">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">roles</span><span class="p">;</span>
	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">lport</span><span class="p">.</span><span class="n">ppwwn</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span>
					<span class="n">bfa_fcs_get_base_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">));</span>
	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">lport</span><span class="p">.</span><span class="n">lpwwn</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* Send the AEN notification */</span>
	<span class="n">bfad_im_post_vendor_event</span><span class="p">(</span><span class="n">aen_entry</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="o">++</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">fcs_aen_seq</span><span class="p">,</span>
				  <span class="n">BFA_AEN_CAT_LPORT</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a LS reject</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_send_ls_rjt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">reason_code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason_code_expl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">bfa_rport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_ls_rjt_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
			      <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
			      <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">,</span> <span class="n">reason_code_expl</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="n">bfa_rport</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span>
			  <span class="n">BFA_FALSE</span><span class="p">,</span> <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a FCCT Reject</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_send_fcgs_rjt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason_code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason_code_expl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>   <span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">bfa_rport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="n">rx_cthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)(</span><span class="n">rx_fchs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="n">ct_hdr</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ct_hdr</span> <span class="o">=</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">ct_hdr</span><span class="o">-&gt;</span><span class="n">gs_type</span> <span class="o">=</span> <span class="n">rx_cthdr</span><span class="o">-&gt;</span><span class="n">gs_type</span><span class="p">;</span>
	<span class="n">ct_hdr</span><span class="o">-&gt;</span><span class="n">gs_sub_type</span> <span class="o">=</span> <span class="n">rx_cthdr</span><span class="o">-&gt;</span><span class="n">gs_sub_type</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_gs_rjt_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">ct_hdr</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span>
			<span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
			<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">,</span> <span class="n">reason_code_expl</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="n">bfa_rport</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span>
			<span class="n">BFA_FALSE</span><span class="p">,</span> <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process incoming plogi from a remote port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_plogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_logi_s</span> <span class="o">*</span><span class="n">plogi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If min cfg mode is enabled, drop any incoming PLOGIs</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__fcs_min_cfg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fc_plogi_parse</span><span class="p">(</span><span class="n">rx_fchs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FC_PARSE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * send a LS reject</span>
<span class="cm">		 */</span>
		<span class="n">bfa_fcs_lport_send_ls_rjt</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="p">,</span>
					<span class="n">FC_LS_RJT_RSN_PROTOCOL_ERROR</span><span class="p">,</span>
					<span class="n">FC_LS_RJT_EXP_SPARMS_ERR_OPTIONS</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Direct Attach P2P mode : verify address assigned by the r-port.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">bfa_fcs_fabric_is_switched</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">memcmp</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
			   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wwn_t</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BFA_FCS_PID_IS_WKA</span><span class="p">(</span><span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Address assigned to us cannot be a WKA */</span>
			<span class="n">bfa_fcs_lport_send_ls_rjt</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="p">,</span>
					<span class="n">FC_LS_RJT_RSN_PROTOCOL_ERROR</span><span class="p">,</span>
					<span class="n">FC_LS_RJT_EXP_INVALID_NPORT_ID</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span>  <span class="o">=</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">;</span>
		<span class="n">bfa_lps_set_n2n_pid</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">lps</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * First, check if we know the device by pwwn.</span>
<span class="cm">	 */</span>
	<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_rport_by_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">plogi</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Direct Attach P2P mode : handle address assigned by r-port.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">bfa_fcs_fabric_is_switched</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">memcmp</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wwn_t</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span>  <span class="o">=</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">;</span>
			<span class="n">bfa_lps_set_n2n_pid</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">lps</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bfa_fcs_rport_plogi</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="p">,</span> <span class="n">plogi</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Next, lookup rport by PID.</span>
<span class="cm">	 */</span>
	<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_rport_by_pid</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Inbound PLOGI from a new device.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_fcs_rport_plogi_create</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="p">,</span> <span class="n">plogi</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Rport is known only by PID.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is a different device with the same pid. Old device</span>
<span class="cm">		 * disappeared. Send implicit LOGO to old device.</span>
<span class="cm">		 */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">==</span> <span class="n">plogi</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_LOGO_IMP</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Inbound PLOGI from a new device (with old PID).</span>
<span class="cm">		 */</span>
		<span class="n">bfa_fcs_rport_plogi_create</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="p">,</span> <span class="n">plogi</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * PLOGI crossing each other.</span>
<span class="cm">	 */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">!=</span> <span class="n">WWN_NULL</span><span class="p">);</span>
	<span class="n">bfa_fcs_rport_plogi</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="p">,</span> <span class="n">plogi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process incoming ECHO.</span>
<span class="cm"> * Since it does not require a login, it is processed here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_echo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fc_echo_s</span> <span class="o">*</span><span class="n">echo</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rx_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>		<span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span>	<span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span>	<span class="o">*</span><span class="n">bfa_rport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">len</span><span class="p">,</span> <span class="n">pyld_len</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_ls_acc_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
				<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the payload (if any) from the echo frame</span>
<span class="cm">	 */</span>
	<span class="n">pyld_len</span> <span class="o">=</span> <span class="n">rx_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fchs_s</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">pyld_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pyld_len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">))</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_echo_s</span><span class="p">),</span> <span class="p">(</span><span class="n">echo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
			<span class="p">(</span><span class="n">pyld_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_echo_s</span><span class="p">)));</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="n">bfa_rport</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span>
			<span class="n">BFA_FALSE</span><span class="p">,</span> <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">pyld_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process incoming RNID.</span>
<span class="cm"> * Since it does not require a login, it is processed here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_rnid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fc_rnid_cmd_s</span> <span class="o">*</span><span class="n">rnid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rx_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rnid_common_id_data_s</span> <span class="n">common_id_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rnid_general_topology_data_s</span> <span class="n">gen_topo_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">bfa_rport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">data_format</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check Node Indentification Data Format</span>
<span class="cm">	 * We only support General Topology Discovery Format.</span>
<span class="cm">	 * For any other requested Data Formats, we return Common Node Id Data</span>
<span class="cm">	 * only, as per FC-LS.</span>
<span class="cm">	 */</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rnid</span><span class="o">-&gt;</span><span class="n">node_id_data_format</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rnid</span><span class="o">-&gt;</span><span class="n">node_id_data_format</span> <span class="o">==</span> <span class="n">RNID_NODEID_DATA_FORMAT_DISCOVERY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_format</span> <span class="o">=</span> <span class="n">RNID_NODEID_DATA_FORMAT_DISCOVERY</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Get General topology data for this port</span>
<span class="cm">		 */</span>
		<span class="n">bfa_fs_port_get_gen_topo_data</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gen_topo_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data_format</span> <span class="o">=</span> <span class="n">RNID_NODEID_DATA_FORMAT_COMMON</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the Node Id Info</span>
<span class="cm">	 */</span>
	<span class="n">common_id_data</span><span class="p">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">common_id_data</span><span class="p">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_nwwn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_rnid_acc_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
				<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">,</span> <span class="n">data_format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">common_id_data</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">gen_topo_data</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="n">bfa_rport</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span>
			<span class="n">BFA_FALSE</span><span class="p">,</span> <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Fill out General Topolpgy Discovery Data for RNID ELS.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fs_port_get_gen_topo_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fc_rnid_general_topology_data_s</span> <span class="o">*</span><span class="n">gen_topo_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">gen_topo_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rnid_general_topology_data_s</span><span class="p">));</span>

	<span class="n">gen_topo_data</span><span class="o">-&gt;</span><span class="n">asso_type</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">RNID_ASSOCIATED_TYPE_HOST</span><span class="p">);</span>
	<span class="n">gen_topo_data</span><span class="o">-&gt;</span><span class="n">phy_port_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* @todo */</span>
	<span class="n">gen_topo_data</span><span class="o">-&gt;</span><span class="n">num_attached_nodes</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_online_actions</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">lpwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">oper_type</span><span class="p">);</span>

	<span class="n">__port_action</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">fab_type</span><span class="p">].</span><span class="n">init</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">__port_action</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">fab_type</span><span class="p">].</span><span class="n">online</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">wwn2str</span><span class="p">(</span><span class="n">lpwwn_buf</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
		<span class="s">&quot;Logical port online: WWN = %s Role = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">lpwwn_buf</span><span class="p">,</span> <span class="s">&quot;Initiator&quot;</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_aen_post</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">BFA_LPORT_AEN_ONLINE</span><span class="p">);</span>

	<span class="n">bfad</span><span class="o">-&gt;</span><span class="n">bfad_flags</span> <span class="o">|=</span> <span class="n">BFAD_PORT_ONLINE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_offline_actions</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">char</span>    <span class="n">lpwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">oper_type</span><span class="p">);</span>

	<span class="n">__port_action</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">fab_type</span><span class="p">].</span><span class="n">offline</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">wwn2str</span><span class="p">(</span><span class="n">lpwwn_buf</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">,</span>
			<span class="n">bfa_fcs_fabric_sm_online</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_TRUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
		<span class="s">&quot;Logical port lost fabric connectivity: WWN = %s Role = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">lpwwn_buf</span><span class="p">,</span> <span class="s">&quot;Initiator&quot;</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_aen_post</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">BFA_LPORT_AEN_DISCONNECT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
		<span class="s">&quot;Logical port taken offline: WWN = %s Role = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">lpwwn_buf</span><span class="p">,</span> <span class="s">&quot;Initiator&quot;</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_aen_post</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">BFA_LPORT_AEN_OFFLINE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_LOGO_IMP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_unknown_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_unknown_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_unknown_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_abts_acc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_ba_acc_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
			<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
			<span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span>
			  <span class="n">BFA_FALSE</span><span class="p">,</span> <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_deleted</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">char</span>    <span class="n">lpwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>

	<span class="n">wwn2str</span><span class="p">(</span><span class="n">lpwwn_buf</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
		<span class="s">&quot;Logical port deleted: WWN = %s Role = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">lpwwn_buf</span><span class="p">,</span> <span class="s">&quot;Initiator&quot;</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_aen_post</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">BFA_LPORT_AEN_DELETE</span><span class="p">);</span>

	<span class="cm">/* Base port will be deleted by the OS driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span>
		<span class="n">bfa_fcs_vport_delete_comp</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bfa_wc_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Unsolicited frame receive handling.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_uf_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">fchs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">pid</span> <span class="o">=</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_cmd_s</span> <span class="o">*</span><span class="n">els_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_cmd_s</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">fchs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">bfa_stats</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">uf_recvs</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_fcs_lport_is_online</span><span class="p">(</span><span class="n">lport</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_stats</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">uf_recv_drops</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * First, handle ELSs that donot require a login.</span>
<span class="cm">	 */</span>
	<span class="cm">/*</span>
<span class="cm">	 * Handle PLOGI first</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fchs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FC_TYPE_ELS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span> <span class="o">==</span> <span class="n">FC_ELS_PLOGI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_fcs_lport_plogi</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_logi_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">els_cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle ECHO separately.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fchs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FC_TYPE_ELS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span> <span class="o">==</span> <span class="n">FC_ELS_ECHO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_fcs_lport_echo</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">fc_echo_s</span> <span class="o">*</span><span class="p">)</span><span class="n">els_cmd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle RNID separately.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fchs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FC_TYPE_ELS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span> <span class="o">==</span> <span class="n">FC_ELS_RNID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_fcs_lport_rnid</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">fc_rnid_cmd_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">els_cmd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fchs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FC_TYPE_BLS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fchs</span><span class="o">-&gt;</span><span class="n">routing</span> <span class="o">==</span> <span class="n">FC_RTG_BASIC_LINK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">fchs</span><span class="o">-&gt;</span><span class="n">cat_info</span> <span class="o">==</span> <span class="n">FC_CAT_ABTS</span><span class="p">))</span>
			<span class="n">bfa_fcs_lport_abts_acc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fchs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FC_TYPE_SERVICES</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Unhandled FC-GS frames. Send a FC-CT Reject</span>
<span class="cm">		 */</span>
		<span class="n">bfa_fcs_lport_send_fcgs_rjt</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">,</span> <span class="n">CT_RSN_NOT_SUPP</span><span class="p">,</span>
				<span class="n">CT_NS_EXP_NOADDITIONAL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * look for a matching remote port ID</span>
<span class="cm">	 */</span>
	<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_rport_by_pid</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

		<span class="n">bfa_fcs_rport_uf_recv</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only handles ELS frames for now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fchs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FC_TYPE_ELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
		<span class="cm">/* ignore type FC_TYPE_FC_FSS */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fchs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FC_TYPE_FC_FSS</span><span class="p">)</span>
			<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">fchs</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span> <span class="o">==</span> <span class="n">FC_ELS_RSCN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_lport_scn_process_rscn</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span> <span class="o">==</span> <span class="n">FC_ELS_LOGO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * @todo Handle LOGO frames received.</span>
<span class="cm">		 */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span> <span class="o">==</span> <span class="n">FC_ELS_PRLI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * @todo Handle PRLI frames received.</span>
<span class="cm">		 */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unhandled ELS frames. Send a LS_RJT.</span>
<span class="cm">	 */</span>
	<span class="n">bfa_fcs_lport_send_ls_rjt</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fchs</span><span class="p">,</span> <span class="n">FC_LS_RJT_RSN_CMD_NOT_SUPP</span><span class="p">,</span>
				 <span class="n">FC_LS_RJT_EXP_NO_ADDL_INFO</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   PID based Lookup for a R-Port in the Port R-Port Queue</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span>
<span class="nf">bfa_fcs_lport_get_rport_by_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rport</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   PWWN based Lookup for a R-Port in the Port R-Port Queue</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span>
<span class="nf">bfa_fcs_lport_get_rport_by_pwwn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">pwwn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wwn_is_equal</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">,</span> <span class="n">pwwn</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">rport</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">pwwn</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   NWWN based Lookup for a R-Port in the Port R-Port Queue</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span>
<span class="nf">bfa_fcs_lport_get_rport_by_nwwn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">nwwn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qe</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wwn_is_equal</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">nwwn</span><span class="p">,</span> <span class="n">nwwn</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">rport</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">nwwn</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by rport module when new rports are discovered.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_add_rport</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">num_rports</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by rport module to when rports are deleted.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_del_rport</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bfa_q_is_on_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">,</span> <span class="n">rport</span><span class="p">));</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">num_rports</span><span class="o">--</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">BFA_FCS_PORT_SM_DELRPORT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by fabric for base port when fabric login is complete.</span>
<span class="cm"> * Called by vport for virtual ports when FDISC is complete.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">BFA_FCS_PORT_SM_ONLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by fabric for base port when fabric goes offline.</span>
<span class="cm"> * Called by vport for virtual ports when virtual port becomes offline.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">BFA_FCS_PORT_SM_OFFLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by fabric to delete base lport and associated resources.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by vport to delete lport and associated resources. Should call</span>
<span class="cm"> * bfa_fcs_vport_delete_comp() for vports on completion.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">BFA_FCS_PORT_SM_DELETE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return TRUE if port is online, else return FALSE</span>
<span class="cm"> */</span>
<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_fcs_lport_is_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_online</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  * Attach time initialization of logical ports.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcs_s</span> <span class="o">*</span><span class="n">fcs</span><span class="p">,</span>
		   <span class="n">u16</span> <span class="n">vf_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">=</span> <span class="n">fcs</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">fabric</span> <span class="o">=</span> <span class="n">bfa_fcs_vf_lookup</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">vf_id</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">vport</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">vport</span><span class="p">)</span> <span class="o">?</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span> <span class="o">:</span>
				  <span class="n">lport</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">bfa_tag</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Logical port initialization of base or virtual port.</span>
<span class="cm"> * Called by fabric for base port or by vport for virtual ports.</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bfa_lport_cfg_s</span> <span class="o">*</span><span class="n">port_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="kt">char</span>    <span class="n">lpwwn_buf</span><span class="p">[</span><span class="n">BFA_STRING_32</span><span class="p">];</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_cfg</span> <span class="o">=</span> <span class="o">*</span><span class="n">port_cfg</span><span class="p">;</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">bfad_port</span> <span class="o">=</span> <span class="n">bfa_fcb_lport_new</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span>
					<span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">roles</span><span class="p">,</span>
					<span class="n">lport</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_drv</span><span class="p">,</span>
					<span class="n">vport</span> <span class="o">?</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_drv</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">wwn2str</span><span class="p">(</span><span class="n">lpwwn_buf</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>
	<span class="n">BFA_LOG</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">bfa_log_level</span><span class="p">,</span>
		<span class="s">&quot;New logical port created: WWN = %s Role = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">lpwwn_buf</span><span class="p">,</span> <span class="s">&quot;Initiator&quot;</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_aen_post</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">BFA_LPORT_AEN_NEW</span><span class="p">);</span>

	<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_uninit</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">BFA_FCS_PORT_SM_CREATE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  fcs_lport_api</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_get_attr</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bfa_lport_attr_s</span> <span class="o">*</span><span class="n">port_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bfa_fcs_lport_sm_online</span><span class="p">))</span>
		<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">port_cfg</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">oper_type</span><span class="p">;</span>
		<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">loopback</span> <span class="o">=</span> <span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">,</span>
				<span class="n">bfa_fcs_fabric_sm_loopback</span><span class="p">);</span>
		<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">authfail</span> <span class="o">=</span>
			<span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">,</span>
				<span class="n">bfa_fcs_fabric_sm_auth_failed</span><span class="p">);</span>
		<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">fabric_name</span>  <span class="o">=</span> <span class="n">bfa_fcs_lport_get_fabric_name</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">fabric_ip_addr</span><span class="p">,</span>
			<span class="n">bfa_fcs_lport_get_fabric_ipaddr</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
			<span class="n">BFA_FCS_FABRIC_IPADDR_SZ</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">BFA_PORT_TYPE_VPORT</span><span class="p">;</span>
			<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">fpma_mac</span> <span class="o">=</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">lp_mac</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">fpma_mac</span> <span class="o">=</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">lp_mac</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">BFA_PORT_TYPE_UNKNOWN</span><span class="p">;</span>
		<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BFA_LPORT_UNINIT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  bfa_fcs_lport_fab port fab functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *   Called by port to initialize fabric services of the base port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fab_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fcs_lport_ns_init</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_scn_init</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_ms_init</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Called by port to notify transition to online state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fab_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fcs_lport_ns_online</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_scn_online</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Called by port to notify transition to offline state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fab_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fcs_lport_ns_offline</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_scn_offline</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_ms_offline</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  bfa_fcs_lport_n2n  functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *   Called by fcs/port to initialize N2N topology.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_n2n_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Called by fcs/port to notify transition to online state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_n2n_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_n2n_s</span> <span class="o">*</span><span class="n">n2n_port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_topo</span><span class="p">.</span><span class="n">pn2n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_lport_cfg_s</span> <span class="o">*</span><span class="n">pcfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">pcfg</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If our PWWN is &gt; than that of the r-port, we have to initiate PLOGI</span>
<span class="cm">	 * and assign an Address. if not, we need to wait for its PLOGI.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If our PWWN is &lt; than that of the remote port, it will send a PLOGI</span>
<span class="cm">	 * with the PIDs assigned. The rport state machine take care of this</span>
<span class="cm">	 * incoming PLOGI.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span>
	    <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pcfg</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">n2n_port</span><span class="o">-&gt;</span><span class="n">rem_port_wwn</span><span class="p">,</span>
	     <span class="k">sizeof</span><span class="p">(</span><span class="n">wwn_t</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">N2N_LOCAL_PID</span><span class="p">;</span>
		<span class="n">bfa_lps_set_n2n_pid</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">lps</span><span class="p">,</span> <span class="n">N2N_LOCAL_PID</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * First, check if we know the device by pwwn.</span>
<span class="cm">		 */</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_rport_by_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
							<span class="n">n2n_port</span><span class="o">-&gt;</span><span class="n">rem_port_wwn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
			<span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">N2N_REMOTE_PID</span><span class="p">;</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_PLOGI_SEND</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * In n2n there can be only one rport. Delete the old one</span>
<span class="cm">		 * whose pid should be zero, because it is offline.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">num_rports</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_rport_by_pid</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
				<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">RPSM_EVENT_DELETE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bfa_fcs_rport_create</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">N2N_REMOTE_PID</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   Called by fcs/port to notify transition to offline state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_n2n_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_n2n_s</span> <span class="o">*</span><span class="n">n2n_port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_topo</span><span class="p">.</span><span class="n">pn2n</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">n2n_port</span><span class="o">-&gt;</span><span class="n">rem_port_wwn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">n2n_port</span><span class="o">-&gt;</span><span class="n">reply_oxid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define BFA_FCS_FDMI_CMD_MAX_RETRIES 2</span>

<span class="cm">/*</span>
<span class="cm"> * forward declarations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_send_rhba</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fdmi_cbarg</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_send_rprt</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fdmi_cbarg</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_send_rpa</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fdmi_cbarg</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_rhba_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
						<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
						<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_rprt_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
						<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
						<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_rpa_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
					       <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
					       <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">bfa_fcs_lport_fdmi_build_rhba_pyld</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
						  <span class="n">u8</span> <span class="o">*</span><span class="n">pyld</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">bfa_fcs_lport_fdmi_build_rprt_pyld</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
						  <span class="n">u8</span> <span class="o">*</span><span class="n">pyld</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">bfa_fcs_lport_fdmi_build_rpa_pyld</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
						 <span class="n">u8</span> <span class="o">*</span><span class="n">pyld</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">bfa_fcs_lport_fdmi_build_portattr_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span>
						       <span class="n">fdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pyld</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_fdmi_get_hbaattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">bfa_fcs_fdmi_hba_attr_s</span> <span class="o">*</span><span class="n">hba_attr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_fdmi_get_portattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">bfa_fcs_fdmi_port_attr_s</span> <span class="o">*</span><span class="n">port_attr</span><span class="p">);</span>
<span class="n">u32</span>	<span class="n">bfa_fcs_fdmi_convert_speed</span><span class="p">(</span><span class="k">enum</span> <span class="n">bfa_port_speed</span> <span class="n">pport_speed</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  fcs_fdmi_sm FCS FDMI state machine</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  FDMI State Machine events</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="p">{</span>
	<span class="n">FDMISM_EVENT_PORT_ONLINE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">FDMISM_EVENT_PORT_OFFLINE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">FDMISM_EVENT_RSP_OK</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">FDMISM_EVENT_RSP_ERROR</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">FDMISM_EVENT_TIMEOUT</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">FDMISM_EVENT_RHBA_SENT</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">FDMISM_EVENT_RPRT_SENT</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">FDMISM_EVENT_RPA_SENT</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
					     <span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_sm_sending_rhba</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_sm_rhba</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
					  <span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_sm_rhba_retry</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_sm_sending_rprt</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_sm_rprt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
					  <span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_sm_rprt_retry</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_sm_sending_rpa</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_sm_rpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_sm_rpa_retry</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
					    <span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_fdmi_sm_disabled</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> *	Start in offline state - awaiting MS to send start.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDMISM_EVENT_PORT_ONLINE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * For Vports, register a new port.</span>
<span class="cm">			 */</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span>
					 <span class="n">bfa_fcs_lport_fdmi_sm_sending_rprt</span><span class="p">);</span>
			<span class="n">bfa_fcs_lport_fdmi_send_rprt</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * For a base port, we should first register the HBA</span>
<span class="cm">			 * attribute. The HBA attribute also contains the base</span>
<span class="cm">			 *  port registration.</span>
<span class="cm">			 */</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span>
					 <span class="n">bfa_fcs_lport_fdmi_sm_sending_rhba</span><span class="p">);</span>
			<span class="n">bfa_fcs_lport_fdmi_send_rhba</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_PORT_OFFLINE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_sm_sending_rhba</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDMISM_EVENT_RHBA_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_rhba</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_sm_rhba</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDMISM_EVENT_RSP_ERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * if max retries have not been reached, start timer for a</span>
<span class="cm">		 * delayed retry</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">retry_cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">BFA_FCS_FDMI_CMD_MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_fdmi_sm_rhba_retry</span><span class="p">);</span>
			<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
					    <span class="o">&amp;</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
					    <span class="n">bfa_fcs_lport_fdmi_timeout</span><span class="p">,</span> <span class="n">fdmi</span><span class="p">,</span>
					    <span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * set state to offline</span>
<span class="cm">			 */</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_RSP_OK</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Initiate Register Port Attributes</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_sending_rpa</span><span class="p">);</span>
		<span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_lport_fdmi_send_rpa</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_sm_rhba_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDMISM_EVENT_TIMEOUT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Retry Timer Expired. Re-send</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_sending_rhba</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_fdmi_send_rhba</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* RPRT : Register Port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_sm_sending_rprt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDMISM_EVENT_RPRT_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_rprt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_sm_rprt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDMISM_EVENT_RSP_ERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * if max retries have not been reached, start timer for a</span>
<span class="cm">		 * delayed retry</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">retry_cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">BFA_FCS_FDMI_CMD_MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_fdmi_sm_rprt_retry</span><span class="p">);</span>
			<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
					    <span class="o">&amp;</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
					    <span class="n">bfa_fcs_lport_fdmi_timeout</span><span class="p">,</span> <span class="n">fdmi</span><span class="p">,</span>
					    <span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * set state to offline</span>
<span class="cm">			 */</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
			<span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_RSP_OK</span>:
		<span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_online</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_sm_rprt_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDMISM_EVENT_TIMEOUT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Retry Timer Expired. Re-send</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_sending_rprt</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_fdmi_send_rprt</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register Port Attributes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_sm_sending_rpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDMISM_EVENT_RPA_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_rpa</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_sm_rpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDMISM_EVENT_RSP_ERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * if max retries have not been reached, start timer for a</span>
<span class="cm">		 * delayed retry</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">retry_cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">BFA_FCS_FDMI_CMD_MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_rpa_retry</span><span class="p">);</span>
			<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
					    <span class="o">&amp;</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
					    <span class="n">bfa_fcs_lport_fdmi_timeout</span><span class="p">,</span> <span class="n">fdmi</span><span class="p">,</span>
					    <span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * set state to offline</span>
<span class="cm">			 */</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
			<span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_RSP_OK</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_online</span><span class="p">);</span>
		<span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_sm_rpa_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDMISM_EVENT_TIMEOUT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Retry Timer Expired. Re-send</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_sending_rpa</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_fdmi_send_rpa</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FDMISM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDMISM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *  FDMI is disabled state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_sm_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">port_fdmi_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="cm">/* No op State. It can only be enabled at Driver Init. */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">*  RHBA : Register HBA Attributes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_send_rhba</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fdmi_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span> <span class="o">=</span> <span class="n">fdmi_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">len</span><span class="p">,</span> <span class="n">attr_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="n">u8</span>        <span class="o">*</span><span class="n">pyld</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_fdmi_send_rhba</span><span class="p">,</span> <span class="n">fdmi</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">pyld</span> <span class="o">=</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pyld</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_fdmi_reqhdr_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">pyld</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				   <span class="n">FDMI_RHBA</span><span class="p">);</span>

	<span class="n">attr_len</span> <span class="o">=</span>
		<span class="n">bfa_fcs_lport_fdmi_build_rhba_pyld</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">pyld</span>
						       <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">attr_len</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
			  <span class="n">bfa_fcs_lport_fdmi_rhba_response</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdmi</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_FCCT_TOV</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_RHBA_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>          <span class="n">u16</span>
<span class="nf">bfa_fcs_lport_fdmi_build_rhba_pyld</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pyld</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_fdmi_hba_attr_s</span> <span class="n">hba_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_fdmi_hba_attr_s</span> <span class="o">*</span><span class="n">fcs_hba_attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hba_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fdmi_rhba_s</span> <span class="o">*</span><span class="n">rhba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_rhba_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">pyld</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="n">u8</span>        <span class="o">*</span><span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">u16</span>        <span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">templen</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * get hba attributes</span>
<span class="cm">	 */</span>
	<span class="n">bfa_fcs_fdmi_get_hbaattr</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">fcs_hba_attr</span><span class="p">);</span>

	<span class="n">rhba</span><span class="o">-&gt;</span><span class="n">hba_id</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">rhba</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">.</span><span class="n">num_ports</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">rhba</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">.</span><span class="n">port_entry</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rhba</span><span class="o">-&gt;</span><span class="n">hba_id</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rhba</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rhba</span><span class="o">-&gt;</span><span class="n">hba_attr_blk</span><span class="p">.</span><span class="n">attr_count</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * fill out the invididual entries of the HBA attrib Block</span>
<span class="cm">	 */</span>
	<span class="n">curr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rhba</span><span class="o">-&gt;</span><span class="n">hba_attr_blk</span><span class="p">.</span><span class="n">hba_attr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Node Name</span>
<span class="cm">	 */</span>
	<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_ATTRIB_NODENAME</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wwn_t</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfa_fcs_lport_get_nwwn</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">templen</span><span class="p">);</span>
	<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Manufacturer</span>
<span class="cm">	 */</span>
	<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_ATTRIB_MANUFACTURER</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="n">fc_roundup</span><span class="p">(</span><span class="n">templen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Serial Number</span>
<span class="cm">	 */</span>
	<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_ATTRIB_SERIALNUM</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">serial_num</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">serial_num</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="n">fc_roundup</span><span class="p">(</span><span class="n">templen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Model</span>
<span class="cm">	 */</span>
	<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_ATTRIB_MODEL</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="n">fc_roundup</span><span class="p">(</span><span class="n">templen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Model Desc</span>
<span class="cm">	 */</span>
	<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_ATTRIB_MODEL_DESC</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">model_desc</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">model_desc</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="n">fc_roundup</span><span class="p">(</span><span class="n">templen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * H/W Version</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_ATTRIB_HW_VERSION</span><span class="p">);</span>
		<span class="n">templen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
		<span class="n">templen</span> <span class="o">=</span> <span class="n">fc_roundup</span><span class="p">(</span><span class="n">templen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Driver Version</span>
<span class="cm">	 */</span>
	<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_ATTRIB_DRIVER_VERSION</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="n">fc_roundup</span><span class="p">(</span><span class="n">templen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Option Rom Version</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">option_rom_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_ATTRIB_ROM_VERSION</span><span class="p">);</span>
		<span class="n">templen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">option_rom_ver</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">option_rom_ver</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
		<span class="n">templen</span> <span class="o">=</span> <span class="n">fc_roundup</span><span class="p">(</span><span class="n">templen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * f/w Version = driver version</span>
<span class="cm">	 */</span>
	<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_ATTRIB_FW_VERSION</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="n">fc_roundup</span><span class="p">(</span><span class="n">templen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * OS Name</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">os_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_ATTRIB_OS_NAME</span><span class="p">);</span>
		<span class="n">templen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">os_name</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">os_name</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
		<span class="n">templen</span> <span class="o">=</span> <span class="n">fc_roundup</span><span class="p">(</span><span class="n">templen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * MAX_CT_PAYLOAD</span>
<span class="cm">	 */</span>
	<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_HBA_ATTRIB_MAX_CT</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">max_ct_pyld</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcs_hba_attr</span><span class="o">-&gt;</span><span class="n">max_ct_pyld</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update size of payload</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">rhba</span><span class="o">-&gt;</span><span class="n">hba_attr_blk</span><span class="p">.</span><span class="n">attr_count</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_rhba_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="n">cthdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">==</span> <span class="n">CT_RSP_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">exp_code</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_RSP_ERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">*  RPRT : Register Port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_send_rprt</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fdmi_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span> <span class="o">=</span> <span class="n">fdmi_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="n">fchs</span><span class="p">;</span>
	<span class="n">u16</span>        <span class="n">len</span><span class="p">,</span> <span class="n">attr_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="n">u8</span>        <span class="o">*</span><span class="n">pyld</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_fdmi_send_rprt</span><span class="p">,</span> <span class="n">fdmi</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">pyld</span> <span class="o">=</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pyld</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_fdmi_reqhdr_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">pyld</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				   <span class="n">FDMI_RPRT</span><span class="p">);</span>

	<span class="n">attr_len</span> <span class="o">=</span>
		<span class="n">bfa_fcs_lport_fdmi_build_rprt_pyld</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">pyld</span>
						       <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">attr_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
			  <span class="n">bfa_fcs_lport_fdmi_rprt_response</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdmi</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_FCCT_TOV</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_RPRT_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine builds Port Attribute Block that used in RPA, RPRT commands.</span>
<span class="cm"> */</span>
<span class="k">static</span>          <span class="n">u16</span>
<span class="nf">bfa_fcs_lport_fdmi_build_portattr_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="o">*</span><span class="n">pyld</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_fdmi_port_attr_s</span> <span class="n">fcs_port_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fdmi_port_attr_s</span> <span class="o">*</span><span class="n">port_attrib</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_port_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">pyld</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="n">u8</span>        <span class="o">*</span><span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">u16</span>        <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">templen</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * get port attributes</span>
<span class="cm">	 */</span>
	<span class="n">bfa_fcs_fdmi_get_portattr</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcs_port_attr</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">port_attrib</span><span class="o">-&gt;</span><span class="n">attr_count</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * fill out the invididual entries</span>
<span class="cm">	 */</span>
	<span class="n">curr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">port_attrib</span><span class="o">-&gt;</span><span class="n">port_attr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FC4 Types</span>
<span class="cm">	 */</span>
	<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_PORT_ATTRIB_FC4_TYPES</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">supp_fc4_types</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">supp_fc4_types</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
	<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
	<span class="o">++</span><span class="n">count</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span>
		<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Supported Speed</span>
<span class="cm">	 */</span>
	<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_PORT_ATTRIB_SUPP_SPEED</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">supp_speed</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">supp_speed</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
	<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
	<span class="o">++</span><span class="n">count</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span>
		<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * current Port Speed</span>
<span class="cm">	 */</span>
	<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_PORT_ATTRIB_PORT_SPEED</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">curr_speed</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">curr_speed</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
	<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
	<span class="o">++</span><span class="n">count</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * max frame size</span>
<span class="cm">	 */</span>
	<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_PORT_ATTRIB_FRAME_SIZE</span><span class="p">);</span>
	<span class="n">templen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">max_frm_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">max_frm_size</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
	<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
	<span class="o">++</span><span class="n">count</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * OS Device Name</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">os_device_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_PORT_ATTRIB_DEV_NAME</span><span class="p">);</span>
		<span class="n">templen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">os_device_name</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">os_device_name</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
		<span class="n">templen</span> <span class="o">=</span> <span class="n">fc_roundup</span><span class="p">(</span><span class="n">templen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
		<span class="o">++</span><span class="n">count</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Host Name</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">host_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_attr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr_ptr</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">FDMI_PORT_ATTRIB_HOST_NAME</span><span class="p">);</span>
		<span class="n">templen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">host_name</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fcs_port_attr</span><span class="p">.</span><span class="n">host_name</span><span class="p">,</span> <span class="n">templen</span><span class="p">);</span>
		<span class="n">templen</span> <span class="o">=</span> <span class="n">fc_roundup</span><span class="p">(</span><span class="n">templen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">curr_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">)</span> <span class="o">+</span> <span class="n">templen</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">templen</span><span class="p">;</span>
		<span class="o">++</span><span class="n">count</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">templen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">templen</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update size of payload</span>
<span class="cm">	 */</span>
	<span class="n">port_attrib</span><span class="o">-&gt;</span><span class="n">attr_count</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>          <span class="n">u16</span>
<span class="nf">bfa_fcs_lport_fdmi_build_rprt_pyld</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pyld</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fdmi_rprt_s</span> <span class="o">*</span><span class="n">rprt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_rprt_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">pyld</span><span class="p">;</span>
	<span class="n">u16</span>        <span class="n">len</span><span class="p">;</span>

	<span class="n">rprt</span><span class="o">-&gt;</span><span class="n">hba_id</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">bfa_fcs_get_base_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">));</span>
	<span class="n">rprt</span><span class="o">-&gt;</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_fdmi_build_portattr_block</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rprt</span><span class="o">-&gt;</span><span class="n">port_attr_blk</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rprt</span><span class="o">-&gt;</span><span class="n">hba_id</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rprt</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_rprt_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="n">cthdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">==</span> <span class="n">CT_RSP_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">exp_code</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_RSP_ERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">*  RPA : Register Port Attributes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_send_rpa</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fdmi_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span> <span class="o">=</span> <span class="n">fdmi_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="n">fchs</span><span class="p">;</span>
	<span class="n">u16</span>        <span class="n">len</span><span class="p">,</span> <span class="n">attr_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="n">u8</span>        <span class="o">*</span><span class="n">pyld</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_fdmi_send_rpa</span><span class="p">,</span> <span class="n">fdmi</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">pyld</span> <span class="o">=</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pyld</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_fdmi_reqhdr_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">pyld</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				   <span class="n">FDMI_RPA</span><span class="p">);</span>

	<span class="n">attr_len</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_fdmi_build_rpa_pyld</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">pyld</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">attr_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
			  <span class="n">bfa_fcs_lport_fdmi_rpa_response</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdmi</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_FCCT_TOV</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_RPA_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>          <span class="n">u16</span>
<span class="nf">bfa_fcs_lport_fdmi_build_rpa_pyld</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pyld</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fdmi_rpa_s</span> <span class="o">*</span><span class="n">rpa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fdmi_rpa_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">pyld</span><span class="p">;</span>
	<span class="n">u16</span>        <span class="n">len</span><span class="p">;</span>

	<span class="n">rpa</span><span class="o">-&gt;</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_fdmi_build_portattr_block</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rpa</span><span class="o">-&gt;</span><span class="n">port_attr_blk</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpa</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_rpa_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="n">cthdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">==</span> <span class="n">CT_RSP_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">exp_code</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_RSP_ERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_fdmi_get_hbaattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">bfa_fcs_fdmi_hba_attr_s</span> <span class="o">*</span><span class="n">hba_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_driver_info_s</span>  <span class="o">*</span><span class="n">driver_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">hba_attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_fdmi_hba_attr_s</span><span class="p">));</span>

	<span class="n">bfa_ioc_get_adapter_manufacturer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">);</span>
	<span class="n">bfa_ioc_get_adapter_serial_num</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">serial_num</span><span class="p">);</span>
	<span class="n">bfa_ioc_get_adapter_model</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">);</span>
	<span class="n">bfa_ioc_get_adapter_model</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">model_desc</span><span class="p">);</span>
	<span class="n">bfa_ioc_get_pci_chip_rev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">);</span>
	<span class="n">bfa_ioc_get_adapter_optrom_ver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">option_rom_ver</span><span class="p">);</span>
	<span class="n">bfa_ioc_get_adapter_fw_ver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">);</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">));</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">os_name</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">host_os_name</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">os_name</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is a patch level, append it</span>
<span class="cm">	 * to the os name along with a separator</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">host_os_patch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncat</span><span class="p">(</span><span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">os_name</span><span class="p">,</span> <span class="n">BFA_FCS_PORT_SYMBNAME_SEPARATOR</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">BFA_FCS_PORT_SYMBNAME_SEPARATOR</span><span class="p">));</span>
		<span class="n">strncat</span><span class="p">(</span><span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">os_name</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">host_os_patch</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">host_os_patch</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">hba_attr</span><span class="o">-&gt;</span><span class="n">max_ct_pyld</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">FC_MAX_PDUSZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_fdmi_get_portattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">bfa_fcs_fdmi_port_attr_s</span> <span class="o">*</span><span class="n">port_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_driver_info_s</span>  <span class="o">*</span><span class="n">driver_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_port_attr_s</span> <span class="n">pport_attr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">port_attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_fdmi_port_attr_s</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * get pport attributes from hal</span>
<span class="cm">	 */</span>
	<span class="n">bfa_fcport_get_attr</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pport_attr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * get FC4 type Bitmask</span>
<span class="cm">	 */</span>
	<span class="n">fc_get_fc4type_bitmask</span><span class="p">(</span><span class="n">FC_TYPE_FCP</span><span class="p">,</span> <span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">supp_fc4_types</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Supported Speeds</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pport_attr</span><span class="p">.</span><span class="n">speed_supported</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_16GBPS</span>:
		<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">supp_speed</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">BFA_FCS_FDMI_SUPP_SPEEDS_16G</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_10GBPS</span>:
		<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">supp_speed</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">BFA_FCS_FDMI_SUPP_SPEEDS_10G</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_8GBPS</span>:
		<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">supp_speed</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">BFA_FCS_FDMI_SUPP_SPEEDS_8G</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_4GBPS</span>:
		<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">supp_speed</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">BFA_FCS_FDMI_SUPP_SPEEDS_4G</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">pport_attr</span><span class="p">.</span><span class="n">speed_supported</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Current Speed</span>
<span class="cm">	 */</span>
	<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">curr_speed</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span>
				<span class="n">bfa_fcs_fdmi_convert_speed</span><span class="p">(</span><span class="n">pport_attr</span><span class="p">.</span><span class="n">speed</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Max PDU Size.</span>
<span class="cm">	 */</span>
	<span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">max_frm_size</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">FC_MAX_PDUSZ</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * OS device Name</span>
<span class="cm">	 */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">os_device_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">os_device_name</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">os_device_name</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Host name</span>
<span class="cm">	 */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">host_machine_name</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">port_attr</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">));</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert BFA speed to FDMI format.</span>
<span class="cm"> */</span>
<span class="n">u32</span>
<span class="nf">bfa_fcs_fdmi_convert_speed</span><span class="p">(</span><span class="n">bfa_port_speed_t</span> <span class="n">pport_speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pport_speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_1GBPS</span>:
	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_2GBPS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pport_speed</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_4GBPS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FDMI_TRANS_SPEED_4G</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_8GBPS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FDMI_TRANS_SPEED_8G</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_10GBPS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FDMI_TRANS_SPEED_10G</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_PORT_SPEED_16GBPS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FDMI_TRANS_SPEED_16G</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FDMI_TRANS_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">fdmi</span><span class="p">;</span>

	<span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">fdmi_enabled</span><span class="p">)</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_offline</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">bfa_fcs_lport_fdmi_sm_disabled</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">fdmi</span><span class="p">;</span>

	<span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_PORT_OFFLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_fdmi_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_fdmi_s</span> <span class="o">*</span><span class="n">fdmi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">fdmi</span><span class="p">;</span>

	<span class="n">fdmi</span><span class="o">-&gt;</span><span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">fdmi</span><span class="p">,</span> <span class="n">FDMISM_EVENT_PORT_ONLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define BFA_FCS_MS_CMD_MAX_RETRIES  2</span>

<span class="cm">/*</span>
<span class="cm"> * forward declarations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_send_plogi</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ms_cbarg</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_plogi_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
					       <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
					       <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_lport_ms_send_gmal</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ms_cbarg</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_gmal_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
					       <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
					       <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_lport_ms_send_gfn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ms_cbarg</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_gfn_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
					       <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
					       <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> *  fcs_ms_sm FCS MS state machine</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  MS State Machine events</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">port_ms_event</span> <span class="p">{</span>
	<span class="n">MSSM_EVENT_PORT_ONLINE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">MSSM_EVENT_PORT_OFFLINE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">MSSM_EVENT_RSP_OK</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">MSSM_EVENT_RSP_ERROR</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">MSSM_EVENT_TIMEOUT</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">MSSM_EVENT_FCXP_SENT</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">MSSM_EVENT_PORT_FABRIC_RSCN</span> <span class="o">=</span> <span class="mi">7</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
					   <span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_sm_plogi_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
						 <span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_sm_plogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_sm_plogi_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
					       <span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_sm_gmal_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
						 <span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_sm_gmal</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_sm_gmal_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
					       <span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_sm_gfn_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
						 <span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_sm_gfn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_sm_gfn_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
					       <span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ms_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
					  <span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> *	Start in offline state - awaiting NS to send start.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_ONLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_plogi_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ms_send_plogi</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_OFFLINE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_sm_plogi_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSSM_EVENT_FCXP_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_plogi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_sm_plogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSSM_EVENT_RSP_ERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Start timer for a delayed retry</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_plogi_retry</span><span class="p">);</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ms_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
				    <span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_timeout</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span>
				    <span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_RSP_OK</span>:
		<span class="cm">/*</span>
<span class="cm">		 * since plogi is done, now invoke MS related sub-modules</span>
<span class="cm">		 */</span>
		<span class="n">bfa_fcs_lport_fdmi_online</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * if this is a Vport, go to online state.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_online</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * For a base port we need to get the</span>
<span class="cm">		 * switch&#39;s IP address.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_gmal_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ms_send_gmal</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_sm_plogi_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSSM_EVENT_TIMEOUT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Retry Timer Expired. Re-send</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_plogi_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ms_send_plogi</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_offline</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_FABRIC_RSCN</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_gfn_sending</span><span class="p">);</span>
		<span class="n">ms</span><span class="o">-&gt;</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_lport_ms_send_gfn</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_sm_gmal_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSSM_EVENT_FCXP_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_gmal</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_sm_gmal</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSSM_EVENT_RSP_ERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Start timer for a delayed retry</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">retry_cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">BFA_FCS_MS_CMD_MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_gmal_retry</span><span class="p">);</span>
			<span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ms_retries</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_timeout</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span>
				<span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_gfn_sending</span><span class="p">);</span>
			<span class="n">bfa_fcs_lport_ms_send_gfn</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">ms</span><span class="o">-&gt;</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_RSP_OK</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_gfn_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ms_send_gfn</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_sm_gmal_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSSM_EVENT_TIMEOUT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Retry Timer Expired. Re-send</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_gmal_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ms_send_gmal</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *  ms_pvt MS local functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_send_gmal</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ms_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="n">ms_cbarg</span><span class="p">;</span>
	<span class="n">bfa_fcs_lport_t</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_ms_send_gmal</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_gmal_req_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
			     <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				 <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">pr_nwwn</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
			  <span class="n">bfa_fcs_lport_ms_gmal_response</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ms</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_FCCT_TOV</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_FCXP_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_gmal_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="n">bfa_fcs_lport_t</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span>		<span class="o">*</span><span class="n">cthdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcgs_gmal_resp_s</span> <span class="o">*</span><span class="n">gmal_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcgs_gmal_entry_s</span> <span class="o">*</span><span class="n">gmal_entry</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">num_entries</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">rsp_str</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">==</span> <span class="n">CT_RSP_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gmal_resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcgs_gmal_resp_s</span> <span class="o">*</span><span class="p">)(</span><span class="n">cthdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">num_entries</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">gmal_resp</span><span class="o">-&gt;</span><span class="n">ms_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_entries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		* The response could contain multiple Entries.</span>
<span class="cm">		* Entries for SNMP interface, etc.</span>
<span class="cm">		* We look for the entry with a telnet prefix.</span>
<span class="cm">		* First &quot;http://&quot; entry refers to IP addr</span>
<span class="cm">		*/</span>

		<span class="n">gmal_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcgs_gmal_entry_s</span> <span class="o">*</span><span class="p">)</span><span class="n">gmal_resp</span><span class="o">-&gt;</span><span class="n">ms_ma</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">num_entries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">gmal_entry</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">,</span>
				<span class="n">CT_GMAL_RESP_PREFIX_HTTP</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">gmal_entry</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/*</span>
<span class="cm">				* if the IP address is terminating with a &#39;/&#39;,</span>
<span class="cm">				* remove it.</span>
<span class="cm">				* Byte 0 consists of the length of the string.</span>
<span class="cm">				*/</span>
				<span class="n">rsp_str</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">gmal_entry</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rsp_str</span><span class="p">[</span><span class="n">gmal_entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
					<span class="n">rsp_str</span><span class="p">[</span><span class="n">gmal_entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* copy IP Address to fabric */</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">bfa_fcs_lport_get_fabric_ipaddr</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
					<span class="n">gmal_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span>
					<span class="n">BFA_FCS_FABRIC_IPADDR_SZ</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">num_entries</span><span class="p">;</span>
				<span class="o">++</span><span class="n">gmal_entry</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">exp_code</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_sm_gfn_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSSM_EVENT_FCXP_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_gfn</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_sm_gfn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSSM_EVENT_RSP_ERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Start timer for a delayed retry</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">retry_cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">BFA_FCS_MS_CMD_MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_gfn_retry</span><span class="p">);</span>
			<span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ms_retries</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_timeout</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span>
				<span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_online</span><span class="p">);</span>
			<span class="n">ms</span><span class="o">-&gt;</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_RSP_OK</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_online</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_sm_gfn_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_ms_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSSM_EVENT_TIMEOUT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Retry Timer Expired. Re-send</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_gfn_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ms_send_gfn</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *  ms_pvt MS local functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_send_gfn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ms_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="n">ms_cbarg</span><span class="p">;</span>
	<span class="n">bfa_fcs_lport_t</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>		<span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_ms_send_gfn</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_gfn_req_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
			     <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				 <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">pr_nwwn</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
			  <span class="n">bfa_fcs_lport_ms_gfn_response</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ms</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_FCCT_TOV</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_FCXP_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_gfn_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="n">bfa_fcs_lport_t</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span>	<span class="o">*</span><span class="n">cthdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wwn_t</span>	       <span class="o">*</span><span class="n">gfn_resp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">==</span> <span class="n">CT_RSP_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gfn_resp</span> <span class="o">=</span> <span class="p">(</span><span class="n">wwn_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">cthdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* check if it has actually changed */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">memcmp</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bfa_fcs_lport_get_fabric_name</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
				<span class="n">gfn_resp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wwn_t</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_fcs_fabric_set_fabric_name</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">,</span> <span class="o">*</span><span class="n">gfn_resp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">exp_code</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ms_pvt MS local functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_send_plogi</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ms_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="n">ms_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span>	<span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ms_plogi_alloc_wait</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_ms_send_plogi</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_plogi_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
			     <span class="n">bfa_hton3b</span><span class="p">(</span><span class="n">FC_MGMT_SERVER</span><span class="p">),</span>
			     <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">nwwn</span><span class="p">,</span>
			     <span class="n">bfa_fcport_get_maxfrsize</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">),</span>
			     <span class="n">bfa_fcport_get_rx_bbcredit</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
			  <span class="n">bfa_fcs_lport_ms_plogi_response</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ms</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_ELS_TOV</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ms_plogi_sent</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_FCXP_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_plogi_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_cmd_s</span> <span class="o">*</span><span class="n">els_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_ls_rjt_s</span> <span class="o">*</span><span class="n">ls_rjt</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ms_plogi_rsp_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">els_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_cmd_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">FC_ELS_ACC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_logi_s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">);</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ms_plogi_acc_err</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ms_plogi_accepts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_ELS_LS_RJT</span>:
		<span class="n">ls_rjt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_ls_rjt_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>

		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code_expl</span><span class="p">);</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ms_rejects</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ms_plogi_unknown_rsp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ms_timeouts</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="n">BFA_FCS_GET_MS_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_offline</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Invoke init routines of sub modules.</span>
<span class="cm">	 */</span>
	<span class="n">bfa_fcs_lport_fdmi_init</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="n">BFA_FCS_GET_MS_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_PORT_OFFLINE</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_fdmi_offline</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="n">BFA_FCS_GET_MS_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">ms</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_PORT_ONLINE</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ms_fabric_rscn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ms_s</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="n">BFA_FCS_GET_MS_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* todo.  Handle this only  when in Online state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ms_sm_online</span><span class="p">))</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">MSSM_EVENT_PORT_FABRIC_RSCN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * @page ns_sm_info VPORT NS State Machine</span>
<span class="cm"> *</span>
<span class="cm"> * @section ns_sm_interactions VPORT NS State Machine Interactions</span>
<span class="cm"> *</span>
<span class="cm"> * @section ns_sm VPORT NS State Machine</span>
<span class="cm"> * img ns_sm.jpg</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * forward declarations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_send_plogi</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ns_cbarg</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_send_rspn_id</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ns_cbarg</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_send_rft_id</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ns_cbarg</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_send_rff_id</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ns_cbarg</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_send_gid_ft</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ns_cbarg</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_plogi_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
					       <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
					       <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_rspn_id_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
						 <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
						 <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
						 <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
						 <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_rft_id_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
						<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
						<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_rff_id_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
						<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
						<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_gid_ft_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
						<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
						<span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_process_gidft_pids</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">pid_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n_pids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_fcs_lport_ns_boot_target_disc</span><span class="p">(</span><span class="n">bfa_fcs_lport_t</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> *  fcs_ns_sm FCS nameserver interface state machine</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * VPort NS State Machine events</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="p">{</span>
	<span class="n">NSSM_EVENT_PORT_ONLINE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">NSSM_EVENT_PORT_OFFLINE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">NSSM_EVENT_PLOGI_SENT</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">NSSM_EVENT_RSP_OK</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">NSSM_EVENT_RSP_ERROR</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">NSSM_EVENT_TIMEOUT</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">NSSM_EVENT_NS_QUERY</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">NSSM_EVENT_RSPNID_SENT</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">NSSM_EVENT_RFTID_SENT</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">NSSM_EVENT_RFFID_SENT</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="n">NSSM_EVENT_GIDFT_SENT</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
					   <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_plogi_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
						 <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_plogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_plogi_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
					       <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_sending_rspn_id</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_rspn_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
					   <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_rspn_id_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
						 <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_sending_rft_id</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_rft_id_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_rft_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
					  <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_sending_rff_id</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_rff_id_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_rff_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
					  <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_sending_gid_ft</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_gid_ft</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
					  <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_gid_ft_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_ns_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
					  <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> *	Start in offline state - awaiting linkup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_ONLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_plogi_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ns_send_plogi</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_plogi_sending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_PLOGI_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_plogi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_plogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_RSP_ERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Start timer for a delayed retry</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_plogi_retry</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
				    <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_timeout</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span>
				    <span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_RSP_OK</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_sending_rspn_id</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ns_send_rspn_id</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_plogi_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_TIMEOUT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Retry Timer Expired. Re-send</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_plogi_sending</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ns_send_plogi</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_sending_rspn_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_RSPNID_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_rspn_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_rspn_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_RSP_ERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Start timer for a delayed retry</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_rspn_id_retry</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
				    <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_timeout</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span>
				    <span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_RSP_OK</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_sending_rft_id</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ns_send_rft_id</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_rspn_id_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_TIMEOUT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Retry Timer Expired. Re-send</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_sending_rspn_id</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ns_send_rspn_id</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_sending_rft_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_RFTID_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_rft_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_rft_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_RSP_OK</span>:
		<span class="cm">/* Now move to register FC4 Features */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_sending_rff_id</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ns_send_rff_id</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_RSP_ERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Start timer for a delayed retry</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_rft_id_retry</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
				    <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_timeout</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span>
				    <span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_rft_id_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_TIMEOUT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_sending_rft_id</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ns_send_rft_id</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_sending_rff_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_RFFID_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_rff_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_rff_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_RSP_OK</span>:

		<span class="cm">/*</span>
<span class="cm">		 * If min cfg mode is enabled, we donot initiate rport</span>
<span class="cm">		 * discovery with the fabric. Instead, we will retrieve the</span>
<span class="cm">		 * boot targets from HAL/FW.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__fcs_min_cfg</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_fcs_lport_ns_boot_target_disc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_online</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the port role is Initiator Mode issue NS query.</span>
<span class="cm">		 * If it is Target Mode, skip this and go to online.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BFA_FCS_VPORT_IS_INITIATOR_MODE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span>
				<span class="n">bfa_fcs_lport_ns_sm_sending_gid_ft</span><span class="p">);</span>
			<span class="n">bfa_fcs_lport_ns_send_gid_ft</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * kick off mgmt srvr state machine</span>
<span class="cm">		 */</span>
		<span class="n">bfa_fcs_lport_ms_online</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_RSP_ERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Start timer for a delayed retry</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_rff_id_retry</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
				    <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_timeout</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span>
				    <span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_rff_id_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_TIMEOUT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_sending_rff_id</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ns_send_rff_id</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_sending_gid_ft</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_GIDFT_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_gid_ft</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_gid_ft</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_RSP_OK</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_online</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_RSP_ERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * TBD: for certain reject codes, we don&#39;t need to retry</span>
<span class="cm">		 */</span>
		<span class="cm">/*</span>
<span class="cm">		 * Start timer for a delayed retry</span>
<span class="cm">		 */</span>
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_gid_ft_retry</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">BFA_FCS_GET_HAL_FROM_PORT</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
				    <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_timeout</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span>
				    <span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span>  <span class="n">NSSM_EVENT_NS_QUERY</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_gid_ft_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_TIMEOUT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_sending_gid_ft</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ns_send_gid_ft</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">vport_ns_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NSSM_EVENT_NS_QUERY</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If the port role is Initiator Mode issue NS query.</span>
<span class="cm">		 * If it is Target Mode, skip this and go to online.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BFA_FCS_VPORT_IS_INITIATOR_MODE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span>
				<span class="n">bfa_fcs_lport_ns_sm_sending_gid_ft</span><span class="p">);</span>
			<span class="n">bfa_fcs_lport_ns_send_gid_ft</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">};</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  ns_pvt Nameserver local functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_send_plogi</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ns_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_plogi_alloc_wait</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_ns_send_plogi</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_plogi_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
			     <span class="n">bfa_hton3b</span><span class="p">(</span><span class="n">FC_NAME_SERVER</span><span class="p">),</span>
			     <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">nwwn</span><span class="p">,</span>
			     <span class="n">bfa_fcport_get_maxfrsize</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">),</span>
			     <span class="n">bfa_fcport_get_rx_bbcredit</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">));</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
			  <span class="n">bfa_fcs_lport_ns_plogi_response</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ns</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_ELS_TOV</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_plogi_sent</span><span class="o">++</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_PLOGI_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_plogi_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="cm">/* struct fc_logi_s *plogi_resp; */</span>
	<span class="k">struct</span> <span class="n">fc_els_cmd_s</span> <span class="o">*</span><span class="n">els_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_ls_rjt_s</span> <span class="o">*</span><span class="n">ls_rjt</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_plogi_rsp_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">els_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_cmd_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">FC_ELS_ACC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_logi_s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">);</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_plogi_acc_err</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_plogi_accepts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_ELS_LS_RJT</span>:
		<span class="n">ls_rjt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_ls_rjt_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>

		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code_expl</span><span class="p">);</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rejects</span><span class="o">++</span><span class="p">;</span>

		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_plogi_unknown_rsp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register the symbolic port name.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_send_rspn_id</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ns_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="n">u8</span>         <span class="n">symbl</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="n">u8</span>         <span class="o">*</span><span class="n">psymbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">symbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">symbl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">symbl</span><span class="p">));</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rspnid_alloc_wait</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_ns_send_rspn_id</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * for V-Port, form a Port Symbolic Name</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For Vports, we append the vport&#39;s port symbolic name</span>
<span class="cm">		 * to that of the base port.</span>
<span class="cm">		 */</span>

		<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">psymbl</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">bfa_fcs_lport_get_psym_name</span>
			 <span class="p">(</span><span class="n">bfa_fcs_get_base_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">))),</span>
			<span class="n">strlen</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span>
			       <span class="n">bfa_fcs_lport_get_psym_name</span><span class="p">(</span><span class="n">bfa_fcs_get_base_port</span>
							  <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">))));</span>

		<span class="cm">/* Ensure we have a null terminating string. */</span>
		<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">psymbl</span><span class="p">)[</span><span class="n">strlen</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">bfa_fcs_lport_get_psym_name</span><span class="p">(</span><span class="n">bfa_fcs_get_base_port</span>
						<span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">)))]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">strncat</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">psymbl</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">bfa_fcs_lport_get_psym_name</span><span class="p">(</span><span class="n">port</span><span class="p">)),</span>
		<span class="n">strlen</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bfa_fcs_lport_get_psym_name</span><span class="p">(</span><span class="n">port</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">psymbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">bfa_fcs_lport_get_psym_name</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_rspnid_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
			      <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">psymbl</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
			  <span class="n">bfa_fcs_lport_ns_rspn_id_response</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ns</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_FCCT_TOV</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rspnid_sent</span><span class="o">++</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSPNID_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_rspn_id_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
				 <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="n">cthdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rspnid_rsp_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">==</span> <span class="n">CT_RSP_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rspnid_accepts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rspnid_rejects</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">exp_code</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register FC4-Types</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_send_rft_id</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ns_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rftid_alloc_wait</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_ns_send_rft_id</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_rftid_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
		     <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">roles</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
			  <span class="n">bfa_fcs_lport_ns_rft_id_response</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ns</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_FCCT_TOV</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rftid_sent</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RFTID_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_rft_id_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="n">cthdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rftid_rsp_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">==</span> <span class="n">CT_RSP_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rftid_accepts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rftid_rejects</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">exp_code</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register FC4-Features : Should be done after RFT_ID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_send_rff_id</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ns_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">fc4_ftrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rffid_alloc_wait</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_ns_send_rff_id</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BFA_FCS_VPORT_IS_INITIATOR_MODE</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
		<span class="n">fc4_ftrs</span> <span class="o">=</span> <span class="n">FC_GS_FCP_FC4_FEATURE_INITIATOR</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_rffid_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
			     <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">FC_TYPE_FCP</span><span class="p">,</span> <span class="n">fc4_ftrs</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
			  <span class="n">bfa_fcs_lport_ns_rff_id_response</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ns</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_FCCT_TOV</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rffid_sent</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RFFID_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_rff_id_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="n">cthdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rffid_rsp_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">==</span> <span class="n">CT_RSP_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rffid_accepts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_rffid_rejects</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">exp_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span> <span class="o">==</span> <span class="n">CT_RSN_NOT_SUPP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if this command is not supported, we don&#39;t retry */</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_OK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Query Fabric for FC4-Types Devices.</span>
<span class="cm"> *</span>
<span class="cm">* TBD : Need to use a local (FCS private) response buffer, since the response</span>
<span class="cm"> * can be larger than 2K.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_send_gid_ft</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ns_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_gidft_alloc_wait</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_ns_send_gid_ft</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This query is only initiated for FCP initiator mode.</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_gid_ft_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
			      <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">FC_TYPE_FCP</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
			  <span class="n">bfa_fcs_lport_ns_gid_ft_response</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ns</span><span class="p">,</span>
			  <span class="n">bfa_fcxp_get_maxrsp</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">),</span> <span class="n">FC_FCCT_TOV</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_gidft_sent</span><span class="o">++</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_GIDFT_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_gid_ft_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="n">cthdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span>        <span class="n">n_pids</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_gidft_rsp_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resid_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TBD : we will need to allocate a larger buffer &amp; retry the</span>
<span class="cm">		 * command</span>
<span class="cm">		 */</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">resid_len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_hdr_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>
	<span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">CT_RSP_ACCEPT</span>:

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_gidft_accepts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">n_pids</span> <span class="o">=</span> <span class="p">(</span><span class="n">fc_get_ctresp_pyld_len</span><span class="p">(</span><span class="n">rsp_len</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">n_pids</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_ns_process_gidft_pids</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
						   <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cthdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
						   <span class="n">n_pids</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_RSP_REJECT</span>:

		<span class="cm">/*</span>
<span class="cm">		 * Check the reason code  &amp; explanation.</span>
<span class="cm">		 * There may not have been any FC4 devices in the fabric</span>
<span class="cm">		 */</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_gidft_rejects</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">exp_code</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">reason_code</span> <span class="o">==</span> <span class="n">CT_RSN_UNABLE_TO_PERF</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">exp_code</span> <span class="o">==</span> <span class="n">CT_NS_EXP_FT_NOT_REG</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * for all other errors, retry</span>
<span class="cm">			 */</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_gidft_unknown_rsp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">cthdr</span><span class="o">-&gt;</span><span class="n">cmd_rsp_code</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_RSP_ERROR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *     This routine will be called by bfa_timer on timer timeouts.</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in]	port - pointer to bfa_fcs_lport_t.</span>
<span class="cm"> *</span>
<span class="cm"> *	return</span>
<span class="cm"> *		void</span>
<span class="cm"> *</span>
<span class="cm"> *	Special Considerations:</span>
<span class="cm"> *</span>
<span class="cm"> *	note</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ns_timeouts</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process the PID list in GID_FT response</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_process_gidft_pids</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pid_buf</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">n_pids</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcgs_gidft_resp_s</span> <span class="o">*</span><span class="n">gidft_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="n">u32</span>        <span class="n">ii</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">n_pids</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gidft_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcgs_gidft_resp_s</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pid_buf</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gidft_entry</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check if this rport already exists</span>
<span class="cm">		 */</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_rport_by_pid</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">gidft_entry</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * this is a new device. create rport</span>
<span class="cm">			 */</span>
			<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_rport_create</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">gidft_entry</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * this rport already exists</span>
<span class="cm">			 */</span>
			<span class="n">bfa_fcs_rport_scn</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">gidft_entry</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * if the last entry bit is set, bail out.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gidft_entry</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  fcs_ns_public FCS nameserver public interfaces</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Functions called by port/fab.</span>
<span class="cm"> * These will send relevant Events to the ns state machine.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="n">BFA_FCS_GET_NS_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">bfa_fcs_lport_ns_sm_offline</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="n">BFA_FCS_GET_NS_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_PORT_OFFLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="n">BFA_FCS_GET_NS_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_PORT_ONLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_ns_s</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="n">BFA_FCS_GET_NS_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">NSSM_EVENT_NS_QUERY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_ns_boot_target_disc</span><span class="p">(</span><span class="n">bfa_fcs_lport_t</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nwwns</span><span class="p">;</span>
	<span class="n">wwn_t</span>  <span class="n">wwns</span><span class="p">[</span><span class="n">BFA_PREBOOT_BOOTLUN_MAX</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>

	<span class="n">bfa_iocfc_get_bootwwns</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nwwns</span><span class="p">,</span> <span class="n">wwns</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">nwwns</span><span class="p">;</span> <span class="o">++</span><span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_rport_create_by_wwn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">wwns</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FCS SCN</span>
<span class="cm"> */</span>

<span class="cp">#define FC_QOS_RSCN_EVENT		0x0c</span>
<span class="cp">#define FC_FABRIC_NAME_RSCN_EVENT	0x0d</span>

<span class="cm">/*</span>
<span class="cm"> * forward declarations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_scn_send_scr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">scn_cbarg</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_scn_scr_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
					      <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span>
					      <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span>
					      <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
					      <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_scn_send_ls_acc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_scn_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  fcs_scm_sm FCS SCN state machine</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * VPort SCN State Machine events</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">port_scn_event</span> <span class="p">{</span>
	<span class="n">SCNSM_EVENT_PORT_ONLINE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">SCNSM_EVENT_PORT_OFFLINE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">SCNSM_EVENT_RSP_OK</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">SCNSM_EVENT_RSP_ERROR</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">SCNSM_EVENT_TIMEOUT</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">SCNSM_EVENT_SCR_SENT</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_scn_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span><span class="p">,</span>
					    <span class="k">enum</span> <span class="n">port_scn_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_scn_sm_sending_scr</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">port_scn_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_scn_sm_scr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">port_scn_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_scn_sm_scr_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span><span class="p">,</span>
					      <span class="k">enum</span> <span class="n">port_scn_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_lport_scn_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span><span class="p">,</span>
					   <span class="k">enum</span> <span class="n">port_scn_event</span> <span class="n">event</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Starting state - awaiting link up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">port_scn_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCNSM_EVENT_PORT_ONLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">bfa_fcs_lport_scn_sm_sending_scr</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_scn_send_scr</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCNSM_EVENT_PORT_OFFLINE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_sm_sending_scr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_scn_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCNSM_EVENT_SCR_SENT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">bfa_fcs_lport_scn_sm_scr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCNSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">bfa_fcs_lport_scn_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_walloc_cancel</span><span class="p">(</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_sm_scr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">port_scn_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">scn</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCNSM_EVENT_RSP_OK</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">bfa_fcs_lport_scn_sm_online</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCNSM_EVENT_RSP_ERROR</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">bfa_fcs_lport_scn_sm_scr_retry</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				    <span class="n">bfa_fcs_lport_scn_timeout</span><span class="p">,</span> <span class="n">scn</span><span class="p">,</span>
				    <span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCNSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">bfa_fcs_lport_scn_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_fcxp_discard</span><span class="p">(</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">fcxp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_sm_scr_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">port_scn_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCNSM_EVENT_TIMEOUT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">bfa_fcs_lport_scn_sm_sending_scr</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_scn_send_scr</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCNSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">bfa_fcs_lport_scn_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">port_scn_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCNSM_EVENT_PORT_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">bfa_fcs_lport_scn_sm_offline</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  fcs_scn_private FCS SCN private functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This routine will be called to send a SCR command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_send_scr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">scn_cbarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp_alloced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span> <span class="o">=</span> <span class="n">scn_cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">scn</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="n">fchs</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp_alloced</span> <span class="o">?</span> <span class="n">fcxp_alloced</span> <span class="o">:</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fcs_fcxp_alloc_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scn</span><span class="o">-&gt;</span><span class="n">fcxp_wqe</span><span class="p">,</span>
					<span class="n">bfa_fcs_lport_scn_send_scr</span><span class="p">,</span> <span class="n">scn</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scn</span><span class="o">-&gt;</span><span class="n">fcxp</span> <span class="o">=</span> <span class="n">fcxp</span><span class="p">;</span>

	<span class="cm">/* Handle VU registrations for Base port only */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bfa_ioc_get_fcmode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">fc_scr_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">brcd_switch</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">len</span> <span class="o">=</span> <span class="n">fc_scr_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
				    <span class="n">BFA_FALSE</span><span class="p">,</span>
				    <span class="n">port</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">,</span>
			  <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span>
			  <span class="n">bfa_fcs_lport_scn_scr_response</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">scn</span><span class="p">,</span> <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="n">FC_ELS_TOV</span><span class="p">);</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">SCNSM_EVENT_SCR_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_scr_response</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fcsarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">req_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rsp_len</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">resid_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rsp_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">scn</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_cmd_s</span> <span class="o">*</span><span class="n">els_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_ls_rjt_s</span> <span class="o">*</span><span class="n">ls_rjt</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity Checks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">req_status</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">SCNSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">els_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_cmd_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">els_cmd</span><span class="o">-&gt;</span><span class="n">els_code</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">FC_ELS_ACC</span>:
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">SCNSM_EVENT_RSP_OK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_ELS_LS_RJT</span>:

		<span class="n">ls_rjt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_ls_rjt_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">BFA_FCXP_RSP_PLD</span><span class="p">(</span><span class="n">fcxp</span><span class="p">);</span>

		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ls_rjt</span><span class="o">-&gt;</span><span class="n">reason_code_expl</span><span class="p">);</span>

		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">SCNSM_EVENT_RSP_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">SCNSM_EVENT_RSP_ERROR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a LS Accept</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_send_ls_acc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">rx_fchs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fchs_s</span> <span class="n">fchs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcxp_s</span> <span class="o">*</span><span class="n">fcxp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_rport_s</span> <span class="o">*</span><span class="n">bfa_rport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">len</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>

	<span class="n">fcxp</span> <span class="o">=</span> <span class="n">bfa_fcs_fcxp_alloc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcxp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fc_ls_acc_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="n">bfa_fcxp_get_reqbuf</span><span class="p">(</span><span class="n">fcxp</span><span class="p">),</span>
			      <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">bfa_fcs_lport_get_fcid</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
			      <span class="n">rx_fchs</span><span class="o">-&gt;</span><span class="n">ox_id</span><span class="p">);</span>

	<span class="n">bfa_fcxp_send</span><span class="p">(</span><span class="n">fcxp</span><span class="p">,</span> <span class="n">bfa_rport</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lp_tag</span><span class="p">,</span>
			  <span class="n">BFA_FALSE</span><span class="p">,</span> <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fchs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">FC_MAX_PDUSZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *     This routine will be called by bfa_timer on timer timeouts.</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in]	vport		- pointer to bfa_fcs_lport_t.</span>
<span class="cm"> *	param[out]	vport_status	- pointer to return vport status in</span>
<span class="cm"> *</span>
<span class="cm"> *	return</span>
<span class="cm"> *		void</span>
<span class="cm"> *</span>
<span class="cm"> *	Special Considerations:</span>
<span class="cm"> *</span>
<span class="cm"> *	note</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">SCNSM_EVENT_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  fcs_scn_public FCS state change notification public interfaces</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Functions called by port/fab</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span> <span class="o">=</span> <span class="n">BFA_FCS_GET_SCN_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">scn</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">bfa_fcs_lport_scn_sm_offline</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span> <span class="o">=</span> <span class="n">BFA_FCS_GET_SCN_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">scn</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">SCNSM_EVENT_PORT_OFFLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_lport_scn_s</span> <span class="o">*</span><span class="n">scn</span> <span class="o">=</span> <span class="n">BFA_FCS_GET_SCN_FROM_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">scn</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">scn</span><span class="p">,</span> <span class="n">SCNSM_EVENT_PORT_ONLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_portid_rscn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rpid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rpid</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is an unknown device, then it just came online.</span>
<span class="cm">	 * Otherwise let rport handle the RSCN event.</span>
<span class="cm">	 */</span>
	<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_rport_by_pid</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rpid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If min cfg mode is enabled, we donot need to</span>
<span class="cm">		 * discover any new rports.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__fcs_min_cfg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">))</span>
			<span class="n">rport</span> <span class="o">=</span> <span class="n">bfa_fcs_rport_create</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rpid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">bfa_fcs_rport_scn</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rscn format based PID comparison</span>
<span class="cm"> */</span>
<span class="cp">#define __fc_pid_match(__c0, __c1, __fmt)		\</span>
<span class="cp">	(((__fmt) == FC_RSCN_FORMAT_FABRIC) ||		\</span>
<span class="cp">	 (((__fmt) == FC_RSCN_FORMAT_DOMAIN) &amp;&amp;		\</span>
<span class="cp">	  ((__c0)[0] == (__c1)[0])) ||				\</span>
<span class="cp">	 (((__fmt) == FC_RSCN_FORMAT_AREA) &amp;&amp;		\</span>
<span class="cp">	  ((__c0)[0] == (__c1)[0]) &amp;&amp;				\</span>
<span class="cp">	  ((__c0)[1] == (__c1)[1])))</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_multiport_rscn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">fc_rscn_format</span> <span class="n">format</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">rscn_pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>        <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qe_next</span><span class="p">;</span>
	<span class="n">u8</span>        <span class="o">*</span><span class="n">c0</span><span class="p">,</span> <span class="o">*</span><span class="n">c1</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rscn_pid</span><span class="p">);</span>

	<span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rscn_pid</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qe_next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__fc_pid_match</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">format</span><span class="p">))</span>
			<span class="n">bfa_fcs_rport_scn</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_scn_process_rscn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fchs_s</span> <span class="o">*</span><span class="n">fchs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rscn_pl_s</span> <span class="o">*</span><span class="n">rscn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_rscn_pl_s</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">fchs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">int</span>             <span class="n">num_entries</span><span class="p">;</span>
	<span class="n">u32</span>        <span class="n">rscn_pid</span><span class="p">;</span>
	<span class="n">bfa_boolean_t</span>   <span class="n">nsquery</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">,</span> <span class="n">found</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">num_entries</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rscn</span><span class="o">-&gt;</span><span class="n">payldlen</span><span class="p">)</span> <span class="o">-</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rscn</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">num_entries</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">num_rscn</span><span class="o">++</span><span class="p">;</span>

	<span class="n">bfa_fcs_lport_scn_send_ls_acc</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">fchs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rscn_pid</span> <span class="o">=</span> <span class="n">rscn</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">portid</span><span class="p">;</span>

		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rscn</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">format</span><span class="p">);</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rscn_pid</span><span class="p">);</span>

		<span class="cm">/* check for duplicate entries in the list */</span>
		<span class="n">found</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rscn</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">portid</span> <span class="o">==</span> <span class="n">rscn_pid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* if found in down the list, pid has been already processed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rscn_pid</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">rscn</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FC_RSCN_FORMAT_PORTID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">rscn</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qualifier</span> <span class="o">==</span> <span class="n">FC_QOS_RSCN_EVENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Ignore this event.</span>
<span class="cm">				 * f/w would have processed it</span>
<span class="cm">				 */</span>
				<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rscn_pid</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">num_portid_rscn</span><span class="o">++</span><span class="p">;</span>
				<span class="n">bfa_fcs_lport_scn_portid_rscn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rscn_pid</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FC_RSCN_FORMAT_FABRIC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">rscn</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qualifier</span> <span class="o">==</span>
					<span class="n">FC_FABRIC_NAME_RSCN_EVENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bfa_fcs_lport_ms_fabric_rscn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* !!!!!!!!! Fall Through !!!!!!!!!!!!! */</span>

		<span class="k">case</span> <span class="n">FC_RSCN_FORMAT_AREA</span>:
		<span class="k">case</span> <span class="n">FC_RSCN_FORMAT_DOMAIN</span>:
			<span class="n">nsquery</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
			<span class="n">bfa_fcs_lport_scn_multiport_rscn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
							<span class="n">rscn</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">format</span><span class="p">,</span>
							<span class="n">rscn_pid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>


		<span class="nl">default:</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">nsquery</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If any of area, domain or fabric RSCN is received, do a fresh</span>
<span class="cm">	 * discovery to find new devices.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nsquery</span><span class="p">)</span>
		<span class="n">bfa_fcs_lport_ns_query</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * BFA FCS port</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> *  fcs_port_api BFA FCS port API</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span>
<span class="nf">bfa_fcs_get_base_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_s</span> <span class="o">*</span><span class="n">fcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">.</span><span class="n">bport</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">wwn_t</span>
<span class="nf">bfa_fcs_lport_get_rport</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">wwn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">nrports</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">bwwn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qh</span><span class="p">,</span> <span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_s</span>	<span class="o">*</span><span class="n">fcs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">nrports</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">wwn_t</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fcs</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">nrports</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">;</span>
	<span class="n">qe</span> <span class="o">=</span> <span class="n">bfa_q_first</span><span class="p">(</span><span class="n">qh</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">qe</span> <span class="o">!=</span> <span class="n">qh</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nrports</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ntoh3b</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xFFF000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qe</span> <span class="o">=</span> <span class="n">bfa_q_next</span><span class="p">(</span><span class="n">qe</span><span class="p">);</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bwwn</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wwn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">qe</span> <span class="o">=</span> <span class="n">bfa_q_next</span><span class="p">(</span><span class="n">qe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">wwn_t</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_get_rports</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	 <span class="n">wwn_t</span> <span class="n">rport_wwns</span><span class="p">[],</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nrports</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">qh</span><span class="p">,</span> <span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_s</span>	<span class="o">*</span><span class="n">fcs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">rport_wwns</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">*</span><span class="n">nrports</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fcs</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span><span class="n">nrports</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">;</span>
	<span class="n">qe</span> <span class="o">=</span> <span class="n">bfa_q_first</span><span class="p">(</span><span class="n">qh</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">qe</span> <span class="o">!=</span> <span class="n">qh</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nrports</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ntoh3b</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xFFF000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qe</span> <span class="o">=</span> <span class="n">bfa_q_next</span><span class="p">(</span><span class="n">qe</span><span class="p">);</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">);</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
			<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rport_wwns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">qe</span> <span class="o">=</span> <span class="n">bfa_q_next</span><span class="p">(</span><span class="n">qe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="o">*</span><span class="n">nrports</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Iterate&#39;s through all the rport&#39;s in the given port to</span>
<span class="cm"> * determine the maximum operating speed.</span>
<span class="cm"> *</span>
<span class="cm"> * !!!! To be used in TRL Functionality only !!!!</span>
<span class="cm"> */</span>
<span class="n">bfa_port_speed_t</span>
<span class="nf">bfa_fcs_lport_get_rport_max_speed</span><span class="p">(</span><span class="n">bfa_fcs_lport_t</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qh</span><span class="p">,</span> <span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_s</span>	<span class="o">*</span><span class="n">fcs</span><span class="p">;</span>
	<span class="n">bfa_port_speed_t</span> <span class="n">max_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_port_attr_s</span> <span class="n">port_attr</span><span class="p">;</span>
	<span class="n">bfa_port_speed_t</span> <span class="n">port_speed</span><span class="p">,</span> <span class="n">rport_speed</span><span class="p">;</span>
	<span class="n">bfa_boolean_t</span> <span class="n">trl_enabled</span> <span class="o">=</span> <span class="n">bfa_fcport_is_ratelim</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fcs</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">;</span>

	<span class="cm">/* Get Physical port&#39;s current speed */</span>
	<span class="n">bfa_fcport_get_attr</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_attr</span><span class="p">);</span>
	<span class="n">port_speed</span> <span class="o">=</span> <span class="n">port_attr</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port_speed</span><span class="p">);</span>

	<span class="n">qh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport_q</span><span class="p">;</span>
	<span class="n">qe</span> <span class="o">=</span> <span class="n">bfa_q_first</span><span class="p">(</span><span class="n">qh</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">qe</span> <span class="o">!=</span> <span class="n">qh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_rport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bfa_ntoh3b</span><span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xFFF000</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">bfa_fcs_rport_get_state</span><span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFA_RPORT_OFFLINE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">scsi_function</span> <span class="o">!=</span> <span class="n">BFA_RPORT_TARGET</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qe</span> <span class="o">=</span> <span class="n">bfa_q_next</span><span class="p">(</span><span class="n">qe</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rport_speed</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">rpf</span><span class="p">.</span><span class="n">rpsc_speed</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">trl_enabled</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rport_speed</span> <span class="o">==</span>
			<span class="n">BFA_PORT_SPEED_UNKNOWN</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Use default ratelim speed setting */</span>
			<span class="n">rport_speed</span> <span class="o">=</span>
				<span class="n">bfa_fcport_get_ratelim_speed</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rport_speed</span> <span class="o">&gt;</span> <span class="n">max_speed</span><span class="p">)</span>
			<span class="n">max_speed</span> <span class="o">=</span> <span class="n">rport_speed</span><span class="p">;</span>

		<span class="n">qe</span> <span class="o">=</span> <span class="n">bfa_q_next</span><span class="p">(</span><span class="n">qe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_speed</span> <span class="o">&gt;</span> <span class="n">port_speed</span><span class="p">)</span>
		<span class="n">max_speed</span> <span class="o">=</span> <span class="n">port_speed</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">max_speed</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">max_speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span>
<span class="nf">bfa_fcs_lookup_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_s</span> <span class="o">*</span><span class="n">fcs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vf_id</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">lpwwn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="n">bfa_fcs_vf_t</span>   <span class="o">*</span><span class="n">vf</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fcs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">vf</span> <span class="o">=</span> <span class="n">bfa_fcs_vf_lookup</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">vf_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">vf_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpwwn</span> <span class="o">||</span> <span class="p">(</span><span class="n">vf</span><span class="o">-&gt;</span><span class="n">bport</span><span class="p">.</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">pwwn</span> <span class="o">==</span> <span class="n">lpwwn</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">vf</span><span class="o">-&gt;</span><span class="n">bport</span><span class="p">;</span>

	<span class="n">vport</span> <span class="o">=</span> <span class="n">bfa_fcs_fabric_vport_lookup</span><span class="p">(</span><span class="n">vf</span><span class="p">,</span> <span class="n">lpwwn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  API corresponding to NPIV_VPORT_GETINFO.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	 <span class="k">struct</span> <span class="n">bfa_lport_info_s</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">fabric_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is a Physical port</span>
<span class="cm">		 */</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">BFA_LPORT_TYPE_PHYSICAL</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * @todo : need to fix the state &amp; reason</span>
<span class="cm">		 */</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">offline_reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">port_wwn</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">node_wwn</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_nwwn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">max_vports_supp</span> <span class="o">=</span>
			<span class="n">bfa_lps_get_max_vport</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_vports_inuse</span> <span class="o">=</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">num_vports</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">max_rports_supp</span> <span class="o">=</span> <span class="n">BFA_FCS_MAX_RPORTS_SUPP</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_rports_inuse</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">num_rports</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is a virtual port</span>
<span class="cm">		 */</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">BFA_LPORT_TYPE_VIRTUAL</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * @todo : need to fix the state &amp; reason</span>
<span class="cm">		 */</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">offline_reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">port_wwn</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">node_wwn</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_nwwn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">fcs_port</span><span class="p">,</span>
	 <span class="k">struct</span> <span class="n">bfa_lport_stats_s</span> <span class="o">*</span><span class="n">port_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">port_stats</span> <span class="o">=</span> <span class="n">fcs_port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_fcs_lport_clear_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">fcs_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcs_port</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_lport_stats_s</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FCS virtual port state machine</span>
<span class="cm"> */</span>

<span class="cp">#define __vport_fcs(__vp)       ((__vp)-&gt;lport.fcs)</span>
<span class="cp">#define __vport_pwwn(__vp)      ((__vp)-&gt;lport.port_cfg.pwwn)</span>
<span class="cp">#define __vport_nwwn(__vp)      ((__vp)-&gt;lport.port_cfg.nwwn)</span>
<span class="cp">#define __vport_bfa(__vp)       ((__vp)-&gt;lport.fcs-&gt;bfa)</span>
<span class="cp">#define __vport_fcid(__vp)      ((__vp)-&gt;lport.pid)</span>
<span class="cp">#define __vport_fabric(__vp)    ((__vp)-&gt;lport.fabric)</span>
<span class="cp">#define __vport_vfid(__vp)      ((__vp)-&gt;lport.fabric-&gt;vf_id)</span>

<span class="cp">#define BFA_FCS_VPORT_MAX_RETRIES  5</span>
<span class="cm">/*</span>
<span class="cm"> * Forward declarations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_do_fdisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vport_arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_do_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  fcs_vport_sm FCS virtual port state machine</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * VPort State Machine events</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="p">{</span>
	<span class="n">BFA_FCS_VPORT_SM_CREATE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/*  vport create event */</span>
	<span class="n">BFA_FCS_VPORT_SM_DELETE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/*  vport delete event */</span>
	<span class="n">BFA_FCS_VPORT_SM_START</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="cm">/*  vport start request */</span>
	<span class="n">BFA_FCS_VPORT_SM_STOP</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/*  stop: unsupported */</span>
	<span class="n">BFA_FCS_VPORT_SM_ONLINE</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/*  fabric online */</span>
	<span class="n">BFA_FCS_VPORT_SM_OFFLINE</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	<span class="cm">/*  fabric offline event */</span>
	<span class="n">BFA_FCS_VPORT_SM_FRMSENT</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>	<span class="cm">/*  fdisc/logo sent events */</span>
	<span class="n">BFA_FCS_VPORT_SM_RSP_OK</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/*  good response */</span>
	<span class="n">BFA_FCS_VPORT_SM_RSP_ERROR</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>	<span class="cm">/*  error/bad response */</span>
	<span class="n">BFA_FCS_VPORT_SM_TIMEOUT</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>	<span class="cm">/*  delay timer event */</span>
	<span class="n">BFA_FCS_VPORT_SM_DELCOMP</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>	<span class="cm">/*  lport delete completion */</span>
	<span class="n">BFA_FCS_VPORT_SM_RSP_DUP_WWN</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>	<span class="cm">/*  Dup wnn error*/</span>
	<span class="n">BFA_FCS_VPORT_SM_RSP_FAILED</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>	<span class="cm">/*  non-retryable failure */</span>
	<span class="n">BFA_FCS_VPORT_SM_STOPCOMP</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>	<span class="cm">/* vport delete completion */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_sm_created</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_sm_fdisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_sm_fdisc_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
					     <span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_vport_sm_fdisc_rsp_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_sm_deleting</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
					  <span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_sm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_sm_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">bfa_fcs_vport_sm_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_vport_sm_stopping</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">bfa_fcs_vport_sm_logo_for_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_sm_table_s</span>  <span class="n">vport_sm_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_vport_sm_uninit</span><span class="p">),</span> <span class="n">BFA_FCS_VPORT_UNINIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_vport_sm_created</span><span class="p">),</span> <span class="n">BFA_FCS_VPORT_CREATED</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_vport_sm_offline</span><span class="p">),</span> <span class="n">BFA_FCS_VPORT_OFFLINE</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_vport_sm_fdisc</span><span class="p">),</span> <span class="n">BFA_FCS_VPORT_FDISC</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_vport_sm_fdisc_retry</span><span class="p">),</span> <span class="n">BFA_FCS_VPORT_FDISC_RETRY</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_vport_sm_fdisc_rsp_wait</span><span class="p">),</span> <span class="n">BFA_FCS_VPORT_FDISC_RSP_WAIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_vport_sm_online</span><span class="p">),</span> <span class="n">BFA_FCS_VPORT_ONLINE</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_vport_sm_deleting</span><span class="p">),</span> <span class="n">BFA_FCS_VPORT_DELETING</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_vport_sm_cleanup</span><span class="p">),</span> <span class="n">BFA_FCS_VPORT_CLEANUP</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_vport_sm_logo</span><span class="p">),</span> <span class="n">BFA_FCS_VPORT_LOGO</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_fcs_vport_sm_error</span><span class="p">),</span> <span class="n">BFA_FCS_VPORT_ERROR</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Beginning state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_CREATE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_created</span><span class="p">);</span>
		<span class="n">bfa_fcs_fabric_addvport</span><span class="p">(</span><span class="n">__vport_fabric</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">vport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Created state - a start event is required to start up the state machine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_created</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_START</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_sm_cmp_state</span><span class="p">(</span><span class="n">__vport_fabric</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span>
					<span class="n">bfa_fcs_fabric_sm_online</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">bfa_fcs_fabric_npiv_capable</span><span class="p">(</span><span class="n">__vport_fabric</span><span class="p">(</span><span class="n">vport</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_fdisc</span><span class="p">);</span>
			<span class="n">bfa_fcs_vport_do_fdisc</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Fabric is offline or not NPIV capable, stay in</span>
<span class="cm">			 * offline state.</span>
<span class="cm">			 */</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fab_no_npiv</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_offline</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_cleanup</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_ONLINE</span>:
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_OFFLINE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Ignore ONLINE/OFFLINE events from fabric</span>
<span class="cm">		 * till vport is started.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Offline state - awaiting ONLINE event from fabric SM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_cleanup</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_ONLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_fdisc</span><span class="p">);</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fdisc_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_fcs_vport_do_fdisc</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_STOP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_cleanup</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">,</span> <span class="n">BFA_FCS_PORT_SM_STOP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_OFFLINE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This can happen if the vport couldn&#39;t be initialzied</span>
<span class="cm">		 * due the fact that the npiv was not enabled on the switch.</span>
<span class="cm">		 * In that case we will put the vport in offline state.</span>
<span class="cm">		 * However, the link can go down and cause the this event to</span>
<span class="cm">		 * be sent when we are already offline. Ignore it.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * FDISC is sent and awaiting reply from fabric.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_fdisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_fdisc_rsp_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_OFFLINE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_RSP_OK</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_online</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_online</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_RSP_ERROR</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_fdisc_retry</span><span class="p">);</span>
		<span class="n">bfa_timer_start</span><span class="p">(</span><span class="n">__vport_bfa</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
				    <span class="n">bfa_fcs_vport_timeout</span><span class="p">,</span> <span class="n">vport</span><span class="p">,</span>
				    <span class="n">BFA_FCS_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_RSP_FAILED</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_offline</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_RSP_DUP_WWN</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_error</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FDISC attempt failed - a timer is active to retry FDISC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_fdisc_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_cleanup</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_timer_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_TIMEOUT</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_fdisc</span><span class="p">);</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fdisc_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fdisc_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_fcs_vport_do_fdisc</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FDISC is in progress and we got a vport delete request -</span>
<span class="cm"> * this is a wait state while we wait for fdisc response and</span>
<span class="cm"> * we will transition to the appropriate state - on rsp status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_fdisc_rsp_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_RSP_OK</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_deleting</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_DELETE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_OFFLINE</span>:
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_RSP_ERROR</span>:
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_RSP_FAILED</span>:
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_RSP_DUP_WWN</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_cleanup</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_OFFLINE</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Vport is online (FDISC is complete).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_deleting</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_STOP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_stopping</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">,</span> <span class="n">BFA_FCS_PORT_SM_STOP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_offline</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_OFFLINE</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_offline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Vport is being stopped - awaiting lport stop completion to send</span>
<span class="cm"> * LOGO to fabric.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_stopping</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_STOPCOMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_logo_for_stop</span><span class="p">);</span>
		<span class="n">bfa_fcs_vport_do_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_cleanup</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Vport is being deleted - awaiting lport delete completion to send</span>
<span class="cm"> * LOGO to fabric.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_deleting</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_DELETE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_DELCOMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_logo</span><span class="p">);</span>
		<span class="n">bfa_fcs_vport_do_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_OFFLINE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_cleanup</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Error State.</span>
<span class="cm"> * This state will be set when the Vport Creation fails due</span>
<span class="cm"> * to errors like Dup WWN. In this state only operation allowed</span>
<span class="cm"> * is a Vport Delete.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_DELETE</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_cleanup</span><span class="p">);</span>
		<span class="n">bfa_fcs_lport_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Lport cleanup is in progress since vport is being deleted. Fabric is</span>
<span class="cm"> * offline, so no LOGO is needed to complete vport deletion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_DELCOMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcs_vport_free</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_STOPCOMP</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_created</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_DELETE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LOGO is sent to fabric. Vport stop is in progress. Lport stop cleanup</span>
<span class="cm"> * is done.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_logo_for_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_OFFLINE</span>:
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_OFFLINE</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * !!! fall through !!!</span>
<span class="cm">		 */</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_RSP_OK</span>:
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_RSP_ERROR</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_created</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LOGO is sent to fabric. Vport delete is in progress. Lport delete cleanup</span>
<span class="cm"> * is done.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_sm_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bfa_fcs_vport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_OFFLINE</span>:
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="p">,</span> <span class="n">BFA_LPS_SM_OFFLINE</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * !!! fall through !!!</span>
<span class="cm">		 */</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_RSP_OK</span>:
	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_RSP_ERROR</span>:
		<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_fcs_vport_free</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_FCS_VPORT_SM_DELETE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  fcs_vport_private FCS virtual port private functions</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Send AEN notification</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_aen_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_lport_s</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">bfa_lport_aen_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_aen_entry_s</span>  <span class="o">*</span><span class="n">aen_entry</span><span class="p">;</span>

	<span class="n">bfad_get_aen_entry</span><span class="p">(</span><span class="n">bfad</span><span class="p">,</span> <span class="n">aen_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aen_entry</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">lport</span><span class="p">.</span><span class="n">vf_id</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">vf_id</span><span class="p">;</span>
	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">lport</span><span class="p">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">roles</span><span class="p">;</span>
	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">lport</span><span class="p">.</span><span class="n">ppwwn</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span>
					<span class="n">bfa_fcs_get_base_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="p">));</span>
	<span class="n">aen_entry</span><span class="o">-&gt;</span><span class="n">aen_data</span><span class="p">.</span><span class="n">lport</span><span class="p">.</span><span class="n">lpwwn</span> <span class="o">=</span> <span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* Send the AEN notification */</span>
	<span class="n">bfad_im_post_vendor_event</span><span class="p">(</span><span class="n">aen_entry</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="o">++</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">fcs_aen_seq</span><span class="p">,</span>
				  <span class="n">BFA_AEN_CAT_LPORT</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine will be called to send a FDISC command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_do_fdisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_lps_fdisc</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="p">,</span> <span class="n">vport</span><span class="p">,</span>
		<span class="n">bfa_fcport_get_maxfrsize</span><span class="p">(</span><span class="n">__vport_bfa</span><span class="p">(</span><span class="n">vport</span><span class="p">)),</span>
		<span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_nwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fdisc_sent</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_fdisc_rejected</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>		<span class="n">lsrjt_rsn</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">lsrjt_rsn</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">lsrjt_expl</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">lsrjt_expl</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">lsrjt_rsn</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">lsrjt_expl</span><span class="p">);</span>

	<span class="cm">/* For certain reason codes, we don&#39;t want to retry. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">lsrjt_expl</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FC_LS_RJT_EXP_INV_PORT_NAME</span>: <span class="cm">/* by brocade */</span>
	<span class="k">case</span> <span class="n">FC_LS_RJT_EXP_INVALID_NPORT_ID</span>: <span class="cm">/* by Cisco */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fdisc_retries</span> <span class="o">&lt;</span> <span class="n">BFA_FCS_VPORT_MAX_RETRIES</span><span class="p">)</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_RSP_ERROR</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_fcs_vport_aen_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">,</span>
					<span class="n">BFA_LPORT_AEN_NPIV_DUP_WWN</span><span class="p">);</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_RSP_DUP_WWN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_LS_RJT_EXP_INSUFF_RES</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This means max logins per port/switch setting on the</span>
<span class="cm">		 * switch was exceeded.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fdisc_retries</span> <span class="o">&lt;</span> <span class="n">BFA_FCS_VPORT_MAX_RETRIES</span><span class="p">)</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_RSP_ERROR</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_fcs_vport_aen_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">,</span>
					<span class="n">BFA_LPORT_AEN_NPIV_FABRIC_MAX</span><span class="p">);</span>
			<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_RSP_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fdisc_retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bfa_fcs_vport_aen_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">,</span>
					<span class="n">BFA_LPORT_AEN_NPIV_UNKNOWN</span><span class="p">);</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_RSP_ERROR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Called to send a logout to the fabric. Used when a V-Port is</span>
<span class="cm"> *	deleted/stopped.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_do_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>

	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">logo_sent</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_lps_fdisclogo</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *     This routine will be called by bfa_timer on timer timeouts.</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in]	vport		- pointer to bfa_fcs_vport_t.</span>
<span class="cm"> *	param[out]	vport_status	- pointer to return vport status in</span>
<span class="cm"> *</span>
<span class="cm"> *	return</span>
<span class="cm"> *		void</span>
<span class="cm"> *</span>
<span class="cm"> *	Special Considerations:</span>
<span class="cm"> *</span>
<span class="cm"> *	note</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vport_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">vport_arg</span><span class="p">;</span>

	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fdisc_timeouts</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_fcs_vport_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfad_vport_s</span> <span class="o">*</span><span class="n">vport_drv</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfad_vport_s</span> <span class="o">*</span><span class="p">)</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_drv</span><span class="p">;</span>

	<span class="n">bfa_fcs_fabric_delvport</span><span class="p">(</span><span class="n">__vport_fabric</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">vport</span><span class="p">);</span>
	<span class="n">bfa_lps_delete</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vport_drv</span><span class="o">-&gt;</span><span class="n">comp_del</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">vport_drv</span><span class="o">-&gt;</span><span class="n">comp_del</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We queue the vport delete work to the IM work_q from here.</span>
<span class="cm">	 * The memory for the bfad_vport_s is freed from the FC function</span>
<span class="cm">	 * template vport_delete entry point.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport_drv</span><span class="p">)</span>
		<span class="n">bfad_im_port_delete</span><span class="p">(</span><span class="n">vport_drv</span><span class="o">-&gt;</span><span class="n">drv_port</span><span class="p">.</span><span class="n">bfad</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">vport_drv</span><span class="o">-&gt;</span><span class="n">drv_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  fcs_vport_public FCS virtual port public interfaces</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Online notification from fabric SM.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_vport_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fab_online</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_fabric_npiv_capable</span><span class="p">(</span><span class="n">__vport_fabric</span><span class="p">(</span><span class="n">vport</span><span class="p">)))</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_ONLINE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fab_no_npiv</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Offline notification from fabric SM.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_vport_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fab_offline</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_OFFLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cleanup notification from fabric SM on link timer expiry.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_vport_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fab_cleanup</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * delete notification from fabric SM. To be invoked from within FCS.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_vport_fcs_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_DELETE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop completion callback from associated lport</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_vport_stop_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_STOPCOMP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Delete completion callback from associated lport</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_vport_delete_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_DELCOMP</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  fcs_vport_api Virtual port API</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *	Use this function to instantiate a new FCS vport object. This</span>
<span class="cm"> *	function will not trigger any HW initialization process (which will be</span>
<span class="cm"> *	done in vport_start() call)</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in] vport	-		pointer to bfa_fcs_vport_t. This space</span>
<span class="cm"> *					needs to be allocated by the driver.</span>
<span class="cm"> *	param[in] fcs		-	FCS instance</span>
<span class="cm"> *	param[in] vport_cfg	-	vport configuration</span>
<span class="cm"> *	param[in] vf_id		-	VF_ID if vport is created within a VF.</span>
<span class="cm"> *					FC_VF_ID_NULL to specify base fabric.</span>
<span class="cm"> *	param[in] vport_drv	-	Opaque handle back to the driver&#39;s vport</span>
<span class="cm"> *					structure</span>
<span class="cm"> *</span>
<span class="cm"> *	retval BFA_STATUS_OK - on success.</span>
<span class="cm"> *	retval BFA_STATUS_FAILED - on failure.</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcs_vport_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcs_s</span> <span class="o">*</span><span class="n">fcs</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">vf_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_lport_cfg_s</span> <span class="o">*</span><span class="n">vport_cfg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfad_vport_s</span> <span class="o">*</span><span class="n">vport_drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport_cfg</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_INVALID_WWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_lport_get_pwwn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">.</span><span class="n">bport</span><span class="p">)</span> <span class="o">==</span> <span class="n">vport_cfg</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_VPORT_WWN_BP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fcs_vport_lookup</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">vf_id</span><span class="p">,</span> <span class="n">vport_cfg</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_VPORT_EXISTS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">.</span><span class="n">num_vports</span> <span class="o">==</span>
			<span class="n">bfa_lps_get_max_vport</span><span class="p">(</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_VPORT_MAX</span><span class="p">;</span>

	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span> <span class="o">=</span> <span class="n">bfa_lps_alloc</span><span class="p">(</span><span class="n">fcs</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_VPORT_MAX</span><span class="p">;</span>

	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_drv</span> <span class="o">=</span> <span class="n">vport_drv</span><span class="p">;</span>
	<span class="n">vport_cfg</span><span class="o">-&gt;</span><span class="n">preboot_vp</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="n">bfa_sm_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bfa_fcs_vport_sm_uninit</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">,</span> <span class="n">fcs</span><span class="p">,</span> <span class="n">vf_id</span><span class="p">,</span> <span class="n">vport</span><span class="p">);</span>
	<span class="n">bfa_fcs_lport_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">,</span> <span class="n">vport_cfg</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_CREATE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Use this function to instantiate a new FCS PBC vport object. This</span>
<span class="cm"> *	function will not trigger any HW initialization process (which will be</span>
<span class="cm"> *	done in vport_start() call)</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in] vport	-	pointer to bfa_fcs_vport_t. This space</span>
<span class="cm"> *				needs to be allocated by the driver.</span>
<span class="cm"> *	param[in] fcs	-	FCS instance</span>
<span class="cm"> *	param[in] vport_cfg	-	vport configuration</span>
<span class="cm"> *	param[in] vf_id		-	VF_ID if vport is created within a VF.</span>
<span class="cm"> *					FC_VF_ID_NULL to specify base fabric.</span>
<span class="cm"> *	param[in] vport_drv	-	Opaque handle back to the driver&#39;s vport</span>
<span class="cm"> *					structure</span>
<span class="cm"> *</span>
<span class="cm"> *	retval BFA_STATUS_OK - on success.</span>
<span class="cm"> *	retval BFA_STATUS_FAILED - on failure.</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcs_pbc_vport_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_fcs_s</span> <span class="o">*</span><span class="n">fcs</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">vf_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_lport_cfg_s</span> <span class="o">*</span><span class="n">vport_cfg</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bfad_vport_s</span> <span class="o">*</span><span class="n">vport_drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_status_t</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bfa_fcs_vport_create</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">fcs</span><span class="p">,</span> <span class="n">vf_id</span><span class="p">,</span> <span class="n">vport_cfg</span><span class="p">,</span> <span class="n">vport_drv</span><span class="p">);</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">.</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">preboot_vp</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Use this function to findout if this is a pbc vport or not.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] vport - pointer to bfa_fcs_vport_t.</span>
<span class="cm"> *</span>
<span class="cm"> * @returns None</span>
<span class="cm"> */</span>
<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_fcs_is_pbc_vport</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">.</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">preboot_vp</span> <span class="o">==</span> <span class="n">BFA_TRUE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Use this function initialize the vport.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] vport - pointer to bfa_fcs_vport_t.</span>
<span class="cm"> *</span>
<span class="cm"> * @returns None</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcs_vport_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_START</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Use this function quiese the vport object. This function will return</span>
<span class="cm"> *	immediately, when the vport is actually stopped, the</span>
<span class="cm"> *	bfa_drv_vport_stop_cb() will be called.</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in] vport - pointer to bfa_fcs_vport_t.</span>
<span class="cm"> *</span>
<span class="cm"> *	return None</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcs_vport_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_STOP</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Use this function to delete a vport object. Fabric object should</span>
<span class="cm"> *	be stopped before this function call.</span>
<span class="cm"> *</span>
<span class="cm"> *	!!!!!!! Donot invoke this from within FCS  !!!!!!!</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in] vport - pointer to bfa_fcs_vport_t.</span>
<span class="cm"> *</span>
<span class="cm"> *	return     None</span>
<span class="cm"> */</span>
<span class="n">bfa_status_t</span>
<span class="nf">bfa_fcs_vport_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">.</span><span class="n">port_cfg</span><span class="p">.</span><span class="n">preboot_vp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_PBC</span><span class="p">;</span>

	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_DELETE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Use this function to get vport&#39;s current status info.</span>
<span class="cm"> *</span>
<span class="cm"> *	param[in] vport		pointer to bfa_fcs_vport_t.</span>
<span class="cm"> *	param[out] attr		pointer to return vport attributes</span>
<span class="cm"> *</span>
<span class="cm"> *	return None</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_fcs_vport_get_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bfa_vport_attr_s</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">attr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_vport_attr_s</span><span class="p">));</span>

	<span class="n">bfa_fcs_lport_get_attr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">port_attr</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">vport_state</span> <span class="o">=</span> <span class="n">bfa_sm_to_state</span><span class="p">(</span><span class="n">vport_sm_table</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Lookup a virtual port. Excludes base port from lookup.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span>
<span class="nf">bfa_fcs_vport_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_fcs_s</span> <span class="o">*</span><span class="n">fcs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vf_id</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="n">vpwwn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_fabric_s</span> <span class="o">*</span><span class="n">fabric</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">vf_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">vpwwn</span><span class="p">);</span>

	<span class="n">fabric</span> <span class="o">=</span> <span class="n">bfa_fcs_vf_lookup</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">vf_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fabric</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">vf_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vport</span> <span class="o">=</span> <span class="n">bfa_fcs_fabric_vport_lookup</span><span class="p">(</span><span class="n">fabric</span><span class="p">,</span> <span class="n">vpwwn</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">vport</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FDISC Response</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_cb_lps_fdisc_comp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">uarg</span><span class="p">,</span> <span class="n">bfa_status_t</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">uarg</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">__vport_pwwn</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">__vport_fcs</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_STATUS_OK</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Initialize the V-Port fields</span>
<span class="cm">		 */</span>
		<span class="n">__vport_fcid</span><span class="p">(</span><span class="n">vport</span><span class="p">)</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">lp_pid</span><span class="p">;</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fdisc_accepts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_RSP_OK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_STATUS_INVALID_MAC</span>:
		<span class="cm">/* Only for CNA */</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fdisc_acc_bad</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_RSP_ERROR</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_STATUS_EPROTOCOL</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">lps</span><span class="o">-&gt;</span><span class="n">ext_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BFA_EPROTO_BAD_ACCEPT</span>:
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fdisc_acc_bad</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BFA_EPROTO_UNKNOWN_RSP</span>:
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fdisc_unknown_rsp</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_RSP_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_STATUS_FABRIC_RJT</span>:
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fdisc_rejects</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_fcs_vport_fdisc_rejected</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_stats</span><span class="p">.</span><span class="n">fdisc_rsp_err</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_RSP_ERROR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LOGO response</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_cb_lps_fdisclogo_comp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">uarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">uarg</span><span class="p">;</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_RSP_OK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Received clear virtual link</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_cb_lps_cvl_event</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">uarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_fcs_vport_s</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">uarg</span><span class="p">;</span>

	<span class="cm">/* Send an Offline followed by an ONLINE */</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_OFFLINE</span><span class="p">);</span>
	<span class="n">bfa_sm_send_event</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">BFA_FCS_VPORT_SM_ONLINE</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
