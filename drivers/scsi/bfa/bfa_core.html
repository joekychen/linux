<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › bfa › bfa_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bfa_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2010 Brocade Communications Systems, Inc.</span>
<span class="cm"> * All rights reserved</span>
<span class="cm"> * www.brocade.com</span>
<span class="cm"> *</span>
<span class="cm"> * Linux driver for Brocade Fibre Channel Host Bus Adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License (GPL) Version 2 as</span>
<span class="cm"> * published by the Free Software Foundation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;bfad_drv.h&quot;</span>
<span class="cp">#include &quot;bfa_modules.h&quot;</span>
<span class="cp">#include &quot;bfi_reg.h&quot;</span>

<span class="n">BFA_TRC_FILE</span><span class="p">(</span><span class="n">HAL</span><span class="p">,</span> <span class="n">CORE</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * BFA module list terminated by NULL</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_module_s</span> <span class="o">*</span><span class="n">hal_mods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">hal_mod_fcdiag</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">hal_mod_sgpg</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">hal_mod_fcport</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">hal_mod_fcxp</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">hal_mod_lps</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">hal_mod_uf</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">hal_mod_rport</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">hal_mod_fcp</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">hal_mod_dconf</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Message handlers for various modules.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bfa_isr_func_t</span>  <span class="n">bfa_isrs</span><span class="p">[</span><span class="n">BFI_MC_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* NONE */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* BFI_MC_IOC */</span>
	<span class="n">bfa_fcdiag_intr</span><span class="p">,</span>	<span class="cm">/* BFI_MC_DIAG */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* BFI_MC_FLASH */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* BFI_MC_CEE */</span>
	<span class="n">bfa_fcport_isr</span><span class="p">,</span>		<span class="cm">/* BFI_MC_FCPORT */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* BFI_MC_IOCFC */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* BFI_MC_LL */</span>
	<span class="n">bfa_uf_isr</span><span class="p">,</span>		<span class="cm">/* BFI_MC_UF */</span>
	<span class="n">bfa_fcxp_isr</span><span class="p">,</span>		<span class="cm">/* BFI_MC_FCXP */</span>
	<span class="n">bfa_lps_isr</span><span class="p">,</span>		<span class="cm">/* BFI_MC_LPS */</span>
	<span class="n">bfa_rport_isr</span><span class="p">,</span>		<span class="cm">/* BFI_MC_RPORT */</span>
	<span class="n">bfa_itn_isr</span><span class="p">,</span>		<span class="cm">/* BFI_MC_ITN */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* BFI_MC_IOIM_READ */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* BFI_MC_IOIM_WRITE */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* BFI_MC_IOIM_IO */</span>
	<span class="n">bfa_ioim_isr</span><span class="p">,</span>		<span class="cm">/* BFI_MC_IOIM */</span>
	<span class="n">bfa_ioim_good_comp_isr</span><span class="p">,</span>	<span class="cm">/* BFI_MC_IOIM_IOCOM */</span>
	<span class="n">bfa_tskim_isr</span><span class="p">,</span>		<span class="cm">/* BFI_MC_TSKIM */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* BFI_MC_SBOOT */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* BFI_MC_IPFC */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* BFI_MC_PORT */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* --------- */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* --------- */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* --------- */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* --------- */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* --------- */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* --------- */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* --------- */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* --------- */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* --------- */</span>
	<span class="n">bfa_isr_unhandled</span><span class="p">,</span>	<span class="cm">/* --------- */</span>
<span class="p">};</span>
<span class="cm">/*</span>
<span class="cm"> * Message handlers for mailbox command classes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bfa_ioc_mbox_mcfunc_t</span>  <span class="n">bfa_mbox_isrs</span><span class="p">[</span><span class="n">BFI_MC_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* BFI_MC_IOC   */</span>
	<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* BFI_MC_DIAG  */</span>
	<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* BFI_MC_FLASH */</span>
	<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* BFI_MC_CEE   */</span>
	<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* BFI_MC_PORT  */</span>
	<span class="n">bfa_iocfc_isr</span><span class="p">,</span>	<span class="cm">/* BFI_MC_IOCFC */</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>



<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_com_port_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_port_s</span>	<span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span>	<span class="o">*</span><span class="n">port_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_PORT_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_port_attach</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">trcmod</span><span class="p">);</span>
	<span class="n">bfa_port_mem_claim</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">port_dma</span><span class="o">-&gt;</span><span class="n">kva_curp</span><span class="p">,</span> <span class="n">port_dma</span><span class="o">-&gt;</span><span class="n">dma_curp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ablk module attach</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_com_ablk_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ablk_s</span>	<span class="o">*</span><span class="n">ablk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">.</span><span class="n">ablk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span>	<span class="o">*</span><span class="n">ablk_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_ABLK_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_ablk_attach</span><span class="p">(</span><span class="n">ablk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">bfa_ablk_memclaim</span><span class="p">(</span><span class="n">ablk</span><span class="p">,</span> <span class="n">ablk_dma</span><span class="o">-&gt;</span><span class="n">kva_curp</span><span class="p">,</span> <span class="n">ablk_dma</span><span class="o">-&gt;</span><span class="n">dma_curp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_com_cee_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_cee_s</span>	<span class="o">*</span><span class="n">cee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">.</span><span class="n">cee</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span>	<span class="o">*</span><span class="n">cee_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_CEE_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">cee</span><span class="o">-&gt;</span><span class="n">trcmod</span> <span class="o">=</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">trcmod</span><span class="p">;</span>
	<span class="n">bfa_cee_attach</span><span class="p">(</span><span class="n">cee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_cee_mem_claim</span><span class="p">(</span><span class="n">cee</span><span class="p">,</span> <span class="n">cee_dma</span><span class="o">-&gt;</span><span class="n">kva_curp</span><span class="p">,</span> <span class="n">cee_dma</span><span class="o">-&gt;</span><span class="n">dma_curp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_com_sfp_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_sfp_s</span>	<span class="o">*</span><span class="n">sfp</span> <span class="o">=</span> <span class="n">BFA_SFP_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span>	<span class="o">*</span><span class="n">sfp_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_SFP_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_sfp_attach</span><span class="p">(</span><span class="n">sfp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">trcmod</span><span class="p">);</span>
	<span class="n">bfa_sfp_memclaim</span><span class="p">(</span><span class="n">sfp</span><span class="p">,</span> <span class="n">sfp_dma</span><span class="o">-&gt;</span><span class="n">kva_curp</span><span class="p">,</span> <span class="n">sfp_dma</span><span class="o">-&gt;</span><span class="n">dma_curp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_com_flash_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">mincfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_flash_s</span>	<span class="o">*</span><span class="n">flash</span> <span class="o">=</span> <span class="n">BFA_FLASH</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span>	<span class="o">*</span><span class="n">flash_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_FLASH_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_flash_attach</span><span class="p">(</span><span class="n">flash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">trcmod</span><span class="p">,</span> <span class="n">mincfg</span><span class="p">);</span>
	<span class="n">bfa_flash_memclaim</span><span class="p">(</span><span class="n">flash</span><span class="p">,</span> <span class="n">flash_dma</span><span class="o">-&gt;</span><span class="n">kva_curp</span><span class="p">,</span>
			   <span class="n">flash_dma</span><span class="o">-&gt;</span><span class="n">dma_curp</span><span class="p">,</span> <span class="n">mincfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_com_diag_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_diag_s</span>	<span class="o">*</span><span class="n">diag</span> <span class="o">=</span> <span class="n">BFA_DIAG_MOD</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span>	<span class="o">*</span><span class="n">diag_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_DIAG_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_diag_attach</span><span class="p">(</span><span class="n">diag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_fcport_beacon</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">trcmod</span><span class="p">);</span>
	<span class="n">bfa_diag_memclaim</span><span class="p">(</span><span class="n">diag</span><span class="p">,</span> <span class="n">diag_dma</span><span class="o">-&gt;</span><span class="n">kva_curp</span><span class="p">,</span> <span class="n">diag_dma</span><span class="o">-&gt;</span><span class="n">dma_curp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_com_phy_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">mincfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_phy_s</span>	<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">BFA_PHY</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span>	<span class="o">*</span><span class="n">phy_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_PHY_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa_phy_attach</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">trcmod</span><span class="p">,</span> <span class="n">mincfg</span><span class="p">);</span>
	<span class="n">bfa_phy_memclaim</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">phy_dma</span><span class="o">-&gt;</span><span class="n">kva_curp</span><span class="p">,</span> <span class="n">phy_dma</span><span class="o">-&gt;</span><span class="n">dma_curp</span><span class="p">,</span> <span class="n">mincfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * BFA IOC FC related definitions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * IOC local definitions</span>
<span class="cm"> */</span>
<span class="cp">#define BFA_IOCFC_TOV		5000	</span><span class="cm">/* msecs */</span><span class="cp"></span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">BFA_IOCFC_ACT_NONE</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">BFA_IOCFC_ACT_INIT</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">BFA_IOCFC_ACT_STOP</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">BFA_IOCFC_ACT_DISABLE</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">BFA_IOCFC_ACT_ENABLE</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define DEF_CFG_NUM_FABRICS		1</span>
<span class="cp">#define DEF_CFG_NUM_LPORTS		256</span>
<span class="cp">#define DEF_CFG_NUM_CQS			4</span>
<span class="cp">#define DEF_CFG_NUM_IOIM_REQS		(BFA_IOIM_MAX)</span>
<span class="cp">#define DEF_CFG_NUM_TSKIM_REQS		128</span>
<span class="cp">#define DEF_CFG_NUM_FCXP_REQS		64</span>
<span class="cp">#define DEF_CFG_NUM_UF_BUFS		64</span>
<span class="cp">#define DEF_CFG_NUM_RPORTS		1024</span>
<span class="cp">#define DEF_CFG_NUM_ITNIMS		(DEF_CFG_NUM_RPORTS)</span>
<span class="cp">#define DEF_CFG_NUM_TINS		256</span>

<span class="cp">#define DEF_CFG_NUM_SGPGS		2048</span>
<span class="cp">#define DEF_CFG_NUM_REQQ_ELEMS		256</span>
<span class="cp">#define DEF_CFG_NUM_RSPQ_ELEMS		64</span>
<span class="cp">#define DEF_CFG_NUM_SBOOT_TGTS		16</span>
<span class="cp">#define DEF_CFG_NUM_SBOOT_LUNS		16</span>

<span class="cm">/*</span>
<span class="cm"> * IOCFC state machine definitions/declarations</span>
<span class="cm"> */</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">stopped</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">initing</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">dconf_read</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">init_cfg_wait</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">init_cfg_done</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">operational</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">dconf_write</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">stopping</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">enabling</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">cfg_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">disabling</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">disabled</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocfc</span><span class="p">,</span> <span class="n">init_failed</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">bfa_iocfc_s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * forward declaration for IOC FC functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocfc_start_submod</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocfc_disable_submod</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocfc_send_cfg</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocfc_enable_cbfn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_status</span> <span class="n">status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocfc_disable_cbfn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocfc_hbfail_cbfn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocfc_reset_cbfn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_ioc_cbfn_s</span> <span class="n">bfa_iocfc_cbfn</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocfc_init_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocfc_stop_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">compl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocfc_enable_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">compl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocfc_disable_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">compl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_stopped_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_INIT</span>:
	<span class="k">case</span> <span class="n">IOCFC_E_ENABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_initing</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_initing_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_initing</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_ENABLED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_dconf_read</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_FAILED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_init_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_dconf_read_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_dconf_modinit</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_dconf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_DCONF_DONE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_init_cfg_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_FAILED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_init_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_init_cfg_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_iocfc_send_cfg</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_init_cfg_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_CFG_DONE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_init_cfg_done</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_FAILED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_init_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_init_cfg_done_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">op_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
	<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">init_hcb_qe</span><span class="p">,</span>
		     <span class="n">bfa_iocfc_init_cb</span><span class="p">,</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_init_cfg_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_START</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_operational</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_STOP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_stopping</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_disabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_FAILED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_operational_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fcport_init</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_iocfc_start_submod</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_operational</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_STOP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_dconf_write</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_disabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_FAILED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_dconf_write_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_dconf_modexit</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_dconf_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_DCONF_DONE</span>:
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_FAILED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_stopping</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_stopping_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_stopping</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_DISABLED</span>:
		<span class="n">bfa_isr_disable</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="n">bfa_iocfc_disable_submod</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_stopped</span><span class="p">);</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">op_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">stop_hcb_qe</span><span class="p">,</span>
			     <span class="n">bfa_iocfc_stop_cb</span><span class="p">,</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_enabling_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_enabling</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_ENABLED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_cfg_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_FAILED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_failed</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cb_reqd</span> <span class="o">==</span> <span class="n">BFA_FALSE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">op_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_FAILED</span><span class="p">;</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">en_hcb_qe</span><span class="p">,</span>
			     <span class="n">bfa_iocfc_enable_cb</span><span class="p">,</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cb_reqd</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_cfg_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_iocfc_send_cfg</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_cfg_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_CFG_DONE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_operational</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cb_reqd</span> <span class="o">==</span> <span class="n">BFA_FALSE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">op_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">en_hcb_qe</span><span class="p">,</span>
			     <span class="n">bfa_iocfc_enable_cb</span><span class="p">,</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cb_reqd</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_FAILED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_failed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cb_reqd</span> <span class="o">==</span> <span class="n">BFA_FALSE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">op_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_FAILED</span><span class="p">;</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">en_hcb_qe</span><span class="p">,</span>
			     <span class="n">bfa_iocfc_enable_cb</span><span class="p">,</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cb_reqd</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_disabling_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_disabling</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_DISABLED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_disabled</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_disabled_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_isr_disable</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_iocfc_disable_submod</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">op_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
	<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">dis_hcb_qe</span><span class="p">,</span>
		     <span class="n">bfa_iocfc_disable_cb</span><span class="p">,</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_STOP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_dconf_write</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_ENABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_enabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_failed_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_isr_disable</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_iocfc_disable_submod</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_STOP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_dconf_write</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_disabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_ENABLED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_cfg_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_FAILED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_init_failed_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_isr_disable</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">op_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_FAILED</span><span class="p">;</span>
	<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">init_hcb_qe</span><span class="p">,</span>
		     <span class="n">bfa_iocfc_init_cb</span><span class="p">,</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_sm_init_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocfc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCFC_E_STOP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_stopping</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_DISABLE</span>:
		<span class="n">bfa_ioc_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_ENABLED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_dconf_read</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_DISABLED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_stopped</span><span class="p">);</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">op_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
		<span class="n">bfa_cb_queue</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">dis_hcb_qe</span><span class="p">,</span>
			     <span class="n">bfa_iocfc_disable_cb</span><span class="p">,</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOCFC_E_IOC_FAILED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * BFA Interrupt handling functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_reqq_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">waitq</span><span class="p">,</span> <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">qen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_reqq_wait_s</span> <span class="o">*</span><span class="n">wqe</span><span class="p">;</span>

	<span class="n">waitq</span> <span class="o">=</span> <span class="n">bfa_reqq</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="n">waitq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Callback only as long as there is room in request queue</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_reqq_full</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qid</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">wqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_reqq_wait_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">wqe</span><span class="o">-&gt;</span><span class="n">qresume</span><span class="p">(</span><span class="n">wqe</span><span class="o">-&gt;</span><span class="n">cbarg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_isr_rspq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">pi</span><span class="p">,</span> <span class="n">ci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">waitq</span><span class="p">;</span>
	<span class="n">bfa_boolean_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ci</span> <span class="o">=</span> <span class="n">bfa_rspq_ci</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>
	<span class="n">pi</span> <span class="o">=</span> <span class="n">bfa_rspq_pi</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ci</span> <span class="o">!=</span> <span class="n">pi</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ci</span> <span class="o">!=</span> <span class="n">pi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_rspq_elem</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qid</span><span class="p">,</span> <span class="n">ci</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_class</span> <span class="o">&gt;=</span> <span class="n">BFI_MC_MAX</span><span class="p">);</span>

		<span class="n">bfa_isrs</span><span class="p">[</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_class</span><span class="p">]</span> <span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">CQ_INCR</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_rspq_elems</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * acknowledge RME completions and update CI</span>
<span class="cm">	 */</span>
	<span class="n">bfa_isr_rspq_ack</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qid</span><span class="p">,</span> <span class="n">ci</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Resume any pending requests in the corresponding reqq.</span>
<span class="cm">	 */</span>
	<span class="n">waitq</span> <span class="o">=</span> <span class="n">bfa_reqq</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">waitq</span><span class="p">))</span>
		<span class="n">bfa_reqq_resume</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">bfa_isr_reqq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">waitq</span><span class="p">;</span>

	<span class="n">bfa_isr_reqq_ack</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Resume any pending requests in the corresponding reqq.</span>
<span class="cm">	 */</span>
	<span class="n">waitq</span> <span class="o">=</span> <span class="n">bfa_reqq</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">waitq</span><span class="p">))</span>
		<span class="n">bfa_reqq_resume</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_msix_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">intr</span><span class="p">,</span> <span class="n">qintr</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">queue</span><span class="p">;</span>

	<span class="n">intr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">bfa_regs</span><span class="p">.</span><span class="n">intr_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * RME completion queue interrupt</span>
<span class="cm">	 */</span>
	<span class="n">qintr</span> <span class="o">=</span> <span class="n">intr</span> <span class="o">&amp;</span> <span class="n">__HFN_INT_RME_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qintr</span> <span class="o">&amp;&amp;</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">queue_process</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">queue</span> <span class="o">&lt;</span> <span class="n">BFI_IOC_MAX_CQS</span><span class="p">;</span> <span class="n">queue</span><span class="o">++</span><span class="p">)</span>
			<span class="n">bfa_isr_rspq</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">qintr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * CPE completion queue interrupt</span>
<span class="cm">	 */</span>
	<span class="n">qintr</span> <span class="o">=</span> <span class="n">intr</span> <span class="o">&amp;</span> <span class="n">__HFN_INT_CPE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qintr</span> <span class="o">&amp;&amp;</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">queue_process</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">queue</span> <span class="o">&lt;</span> <span class="n">BFI_IOC_MAX_CQS</span><span class="p">;</span> <span class="n">queue</span><span class="o">++</span><span class="p">)</span>
			<span class="n">bfa_isr_reqq</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">intr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">qintr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bfa_msix_lpu_err</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_intx</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">intr</span><span class="p">,</span> <span class="n">qintr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue</span><span class="p">;</span>
	<span class="n">bfa_boolean_t</span> <span class="n">rspq_comp</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="n">intr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">bfa_regs</span><span class="p">.</span><span class="n">intr_status</span><span class="p">);</span>

	<span class="n">qintr</span> <span class="o">=</span> <span class="n">intr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">__HFN_INT_RME_MASK</span> <span class="o">|</span> <span class="n">__HFN_INT_CPE_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qintr</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">qintr</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">bfa_regs</span><span class="p">.</span><span class="n">intr_status</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unconditional RME completion queue interrupt</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">queue_process</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">queue</span> <span class="o">&lt;</span> <span class="n">BFI_IOC_MAX_CQS</span><span class="p">;</span> <span class="n">queue</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bfa_isr_rspq</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">queue</span><span class="p">))</span>
				<span class="n">rspq_comp</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intr</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">qintr</span> <span class="o">|</span> <span class="n">rspq_comp</span><span class="p">)</span> <span class="o">?</span> <span class="n">BFA_TRUE</span> <span class="o">:</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * CPE completion queue interrupt</span>
<span class="cm">	 */</span>
	<span class="n">qintr</span> <span class="o">=</span> <span class="n">intr</span> <span class="o">&amp;</span> <span class="n">__HFN_INT_CPE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qintr</span> <span class="o">&amp;&amp;</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">queue_process</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">queue</span> <span class="o">&lt;</span> <span class="n">BFI_IOC_MAX_CQS</span><span class="p">;</span> <span class="n">queue</span><span class="o">++</span><span class="p">)</span>
			<span class="n">bfa_isr_reqq</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">intr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">qintr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>

	<span class="n">bfa_msix_lpu_err</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_isr_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">umsk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pci_func</span> <span class="o">=</span> <span class="n">bfa_ioc_pcifn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">);</span>

	<span class="n">bfa_msix_ctrl_install</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_asic_id_ct2</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">pcidev</span><span class="p">.</span><span class="n">device_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">umsk</span> <span class="o">=</span> <span class="n">__HFN_INT_ERR_MASK_CT2</span><span class="p">;</span>
		<span class="n">umsk</span> <span class="o">|=</span> <span class="n">pci_func</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span>
			<span class="n">__HFN_INT_FN0_MASK_CT2</span> <span class="o">:</span> <span class="n">__HFN_INT_FN1_MASK_CT2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">umsk</span> <span class="o">=</span> <span class="n">__HFN_INT_ERR_MASK</span><span class="p">;</span>
		<span class="n">umsk</span> <span class="o">|=</span> <span class="n">pci_func</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">__HFN_INT_FN0_MASK</span> <span class="o">:</span> <span class="n">__HFN_INT_FN1_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">umsk</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">bfa_regs</span><span class="p">.</span><span class="n">intr_status</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="n">umsk</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">bfa_regs</span><span class="p">.</span><span class="n">intr_mask</span><span class="p">);</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">intr_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">umsk</span><span class="p">;</span>
	<span class="n">bfa_isr_mode_set</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">.</span><span class="n">nvecs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_isr_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_isr_mode_set</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="o">-</span><span class="mi">1L</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">bfa_regs</span><span class="p">.</span><span class="n">intr_mask</span><span class="p">);</span>
	<span class="n">bfa_msix_uninstall</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_msix_reqq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_isr_reqq</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">vec</span> <span class="o">-</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">hwif</span><span class="p">.</span><span class="n">cpe_vec_q0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_isr_unhandled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msg_s</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_class</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mhdr</span><span class="p">.</span><span class="n">mtag</span><span class="p">.</span><span class="n">i2htok</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">bfa_trc_stop</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">trcmod</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_msix_rspq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_isr_rspq</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">vec</span> <span class="o">-</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">hwif</span><span class="p">.</span><span class="n">rme_vec_q0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_msix_lpu_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">intr</span><span class="p">,</span> <span class="n">curr_value</span><span class="p">;</span>
	<span class="n">bfa_boolean_t</span> <span class="n">lpu_isr</span><span class="p">,</span> <span class="n">halt_isr</span><span class="p">,</span> <span class="n">pss_isr</span><span class="p">;</span>

	<span class="n">intr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">bfa_regs</span><span class="p">.</span><span class="n">intr_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_asic_id_ct2</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">pcidev</span><span class="p">.</span><span class="n">device_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">halt_isr</span> <span class="o">=</span> <span class="n">intr</span> <span class="o">&amp;</span> <span class="n">__HFN_INT_CPQ_HALT_CT2</span><span class="p">;</span>
		<span class="n">pss_isr</span>  <span class="o">=</span> <span class="n">intr</span> <span class="o">&amp;</span> <span class="n">__HFN_INT_ERR_PSS_CT2</span><span class="p">;</span>
		<span class="n">lpu_isr</span>  <span class="o">=</span> <span class="n">intr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">__HFN_INT_MBOX_LPU0_CT2</span> <span class="o">|</span>
				   <span class="n">__HFN_INT_MBOX_LPU1_CT2</span><span class="p">);</span>
		<span class="n">intr</span>    <span class="o">&amp;=</span> <span class="n">__HFN_INT_ERR_MASK_CT2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">halt_isr</span> <span class="o">=</span> <span class="n">bfa_asic_id_ct</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">pcidev</span><span class="p">.</span><span class="n">device_id</span><span class="p">)</span> <span class="o">?</span>
					  <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">__HFN_INT_LL_HALT</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pss_isr</span>  <span class="o">=</span> <span class="n">intr</span> <span class="o">&amp;</span> <span class="n">__HFN_INT_ERR_PSS</span><span class="p">;</span>
		<span class="n">lpu_isr</span>  <span class="o">=</span> <span class="n">intr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">__HFN_INT_MBOX_LPU0</span> <span class="o">|</span> <span class="n">__HFN_INT_MBOX_LPU1</span><span class="p">);</span>
		<span class="n">intr</span>    <span class="o">&amp;=</span> <span class="n">__HFN_INT_ERR_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpu_isr</span><span class="p">)</span>
		<span class="n">bfa_ioc_mbox_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">halt_isr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If LL_HALT bit is set then FW Init Halt LL Port</span>
<span class="cm">			 * Register needs to be cleared as well so Interrupt</span>
<span class="cm">			 * Status Register will be cleared.</span>
<span class="cm">			 */</span>
			<span class="n">curr_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ll_halt</span><span class="p">);</span>
			<span class="n">curr_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">__FW_INIT_HALT_P</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">curr_value</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ll_halt</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pss_isr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * ERR_PSS bit needs to be cleared as well in case</span>
<span class="cm">			 * interrups are shared so driver&#39;s interrupt handler is</span>
<span class="cm">			 * still called even though it is already masked out.</span>
<span class="cm">			 */</span>
			<span class="n">curr_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span>
					<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_err_status_reg</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">curr_value</span><span class="p">,</span>
				<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_err_status_reg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">intr</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">bfa_regs</span><span class="p">.</span><span class="n">intr_status</span><span class="p">);</span>
		<span class="n">bfa_ioc_error_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * BFA IOC FC related functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  BFA IOC private functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Use the Mailbox interface to send BFI_IOCFC_H2I_CFG_REQ</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_send_cfg</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_iocfc_cfg_req_s</span> <span class="n">cfg_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg_info</span> <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span>	<span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_cqs</span> <span class="o">&gt;</span> <span class="n">BFI_IOC_MAX_CQS</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_cqs</span><span class="p">);</span>

	<span class="n">bfa_iocfc_reset_queues</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize IOC configuration info</span>
<span class="cm">	 */</span>
	<span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">single_msix_vec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">.</span><span class="n">nvecs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">single_msix_vec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">endian_sig</span> <span class="o">=</span> <span class="n">BFI_IOC_ENDIAN_SIG</span><span class="p">;</span>
	<span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">num_cqs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_cqs</span><span class="p">;</span>
	<span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span><span class="p">);</span>
	<span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">num_fwtio_reqs</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span><span class="p">);</span>

	<span class="n">bfa_dma_be_addr_set</span><span class="p">(</span><span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">cfgrsp_addr</span><span class="p">,</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfgrsp_dma</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * dma map REQ and RSP circular queues and shadow pointers</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_cqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_dma_be_addr_set</span><span class="p">(</span><span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">req_cq_ba</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">req_cq_ba</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa</span><span class="p">);</span>
		<span class="n">bfa_dma_be_addr_set</span><span class="p">(</span><span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">req_shadow_ci</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">req_cq_shadow_ci</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa</span><span class="p">);</span>
		<span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">req_cq_elems</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_reqq_elems</span><span class="p">);</span>

		<span class="n">bfa_dma_be_addr_set</span><span class="p">(</span><span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">rsp_cq_ba</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">rsp_cq_ba</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa</span><span class="p">);</span>
		<span class="n">bfa_dma_be_addr_set</span><span class="p">(</span><span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">rsp_shadow_pi</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">rsp_cq_shadow_pi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa</span><span class="p">);</span>
		<span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">rsp_cq_elems</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_rspq_elems</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable interrupt coalescing if it is driver init path</span>
<span class="cm">	 * and not ioc disable/enable path.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_fsm_cmp_state</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_init_cfg_wait</span><span class="p">))</span>
		<span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">coalesce</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * dma map IOC configuration itself</span>
<span class="cm">	 */</span>
	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">cfg_req</span><span class="p">.</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_IOCFC</span><span class="p">,</span> <span class="n">BFI_IOCFC_H2I_CFG_REQ</span><span class="p">,</span>
		    <span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">bfa_dma_be_addr_set</span><span class="p">(</span><span class="n">cfg_req</span><span class="p">.</span><span class="n">ioc_cfg_dma_addr</span><span class="p">,</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfg_info</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>

	<span class="n">bfa_ioc_mbox_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_req</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_iocfc_cfg_req_s</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_init_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span>	<span class="o">*</span><span class="n">iocfc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>

	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">bfad</span><span class="p">;</span>
	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>
	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">*</span><span class="n">cfg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize chip specific handlers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_asic_id_ctc</span><span class="p">(</span><span class="n">bfa_ioc_devid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_reginit</span> <span class="o">=</span> <span class="n">bfa_hwct_reginit</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_reqq_ack</span> <span class="o">=</span> <span class="n">bfa_hwct_reqq_ack</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_rspq_ack</span> <span class="o">=</span> <span class="n">bfa_hwct_rspq_ack</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_msix_init</span> <span class="o">=</span> <span class="n">bfa_hwct_msix_init</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_msix_ctrl_install</span> <span class="o">=</span> <span class="n">bfa_hwct_msix_ctrl_install</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_msix_queue_install</span> <span class="o">=</span> <span class="n">bfa_hwct_msix_queue_install</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_msix_uninstall</span> <span class="o">=</span> <span class="n">bfa_hwct_msix_uninstall</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_isr_mode_set</span> <span class="o">=</span> <span class="n">bfa_hwct_isr_mode_set</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_msix_getvecs</span> <span class="o">=</span> <span class="n">bfa_hwct_msix_getvecs</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_msix_get_rme_range</span> <span class="o">=</span> <span class="n">bfa_hwct_msix_get_rme_range</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">rme_vec_q0</span> <span class="o">=</span> <span class="n">BFI_MSIX_RME_QMIN_CT</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">cpe_vec_q0</span> <span class="o">=</span> <span class="n">BFI_MSIX_CPE_QMIN_CT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_reginit</span> <span class="o">=</span> <span class="n">bfa_hwcb_reginit</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_reqq_ack</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_rspq_ack</span> <span class="o">=</span> <span class="n">bfa_hwcb_rspq_ack</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_msix_init</span> <span class="o">=</span> <span class="n">bfa_hwcb_msix_init</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_msix_ctrl_install</span> <span class="o">=</span> <span class="n">bfa_hwcb_msix_ctrl_install</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_msix_queue_install</span> <span class="o">=</span> <span class="n">bfa_hwcb_msix_queue_install</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_msix_uninstall</span> <span class="o">=</span> <span class="n">bfa_hwcb_msix_uninstall</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_isr_mode_set</span> <span class="o">=</span> <span class="n">bfa_hwcb_isr_mode_set</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_msix_getvecs</span> <span class="o">=</span> <span class="n">bfa_hwcb_msix_getvecs</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_msix_get_rme_range</span> <span class="o">=</span> <span class="n">bfa_hwcb_msix_get_rme_range</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">rme_vec_q0</span> <span class="o">=</span> <span class="n">BFI_MSIX_RME_QMIN_CB</span> <span class="o">+</span>
			<span class="n">bfa_ioc_pcifn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)</span> <span class="o">*</span> <span class="n">BFI_IOC_MAX_CQS</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">cpe_vec_q0</span> <span class="o">=</span> <span class="n">BFI_MSIX_CPE_QMIN_CB</span> <span class="o">+</span>
			<span class="n">bfa_ioc_pcifn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)</span> <span class="o">*</span> <span class="n">BFI_IOC_MAX_CQS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_asic_id_ct2</span><span class="p">(</span><span class="n">bfa_ioc_devid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_reginit</span> <span class="o">=</span> <span class="n">bfa_hwct2_reginit</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_isr_mode_set</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_rspq_ack</span> <span class="o">=</span> <span class="n">bfa_hwct2_rspq_ack</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">.</span><span class="n">hw_reginit</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">msix</span><span class="p">.</span><span class="n">nvecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_mem_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">dm_kva</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">dm_pa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">per_reqq_sz</span><span class="p">,</span> <span class="n">per_rspq_sz</span><span class="p">,</span> <span class="n">dbgsz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span>  <span class="o">*</span><span class="n">iocfc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">ioc_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_IOC_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">iocfc_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_IOCFC_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">reqq_dma</span><span class="p">,</span> <span class="o">*</span><span class="n">rspq_dma</span><span class="p">;</span>

	<span class="cm">/* First allocate dma memory for IOC */</span>
	<span class="n">bfa_ioc_mem_claim</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_mem_dma_virt</span><span class="p">(</span><span class="n">ioc_dma</span><span class="p">),</span>
			<span class="n">bfa_mem_dma_phys</span><span class="p">(</span><span class="n">ioc_dma</span><span class="p">));</span>

	<span class="cm">/* Claim DMA-able memory for the request/response queues */</span>
	<span class="n">per_reqq_sz</span> <span class="o">=</span> <span class="n">BFA_ROUNDUP</span><span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_reqq_elems</span> <span class="o">*</span> <span class="n">BFI_LMSG_SZ</span><span class="p">),</span>
				<span class="n">BFA_DMA_ALIGN_SZ</span><span class="p">);</span>
	<span class="n">per_rspq_sz</span> <span class="o">=</span> <span class="n">BFA_ROUNDUP</span><span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_rspq_elems</span> <span class="o">*</span> <span class="n">BFI_LMSG_SZ</span><span class="p">),</span>
				<span class="n">BFA_DMA_ALIGN_SZ</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_cqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reqq_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_REQQ_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">req_cq_ba</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kva</span> <span class="o">=</span> <span class="n">bfa_mem_dma_virt</span><span class="p">(</span><span class="n">reqq_dma</span><span class="p">);</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">req_cq_ba</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa</span> <span class="o">=</span> <span class="n">bfa_mem_dma_phys</span><span class="p">(</span><span class="n">reqq_dma</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">req_cq_ba</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kva</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">per_reqq_sz</span><span class="p">);</span>

		<span class="n">rspq_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_RSPQ_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">rsp_cq_ba</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kva</span> <span class="o">=</span> <span class="n">bfa_mem_dma_virt</span><span class="p">(</span><span class="n">rspq_dma</span><span class="p">);</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">rsp_cq_ba</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa</span> <span class="o">=</span> <span class="n">bfa_mem_dma_phys</span><span class="p">(</span><span class="n">rspq_dma</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">rsp_cq_ba</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kva</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">per_rspq_sz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Claim IOCFC dma memory - for shadow CI/PI */</span>
	<span class="n">dm_kva</span> <span class="o">=</span> <span class="n">bfa_mem_dma_virt</span><span class="p">(</span><span class="n">iocfc_dma</span><span class="p">);</span>
	<span class="n">dm_pa</span>  <span class="o">=</span> <span class="n">bfa_mem_dma_phys</span><span class="p">(</span><span class="n">iocfc_dma</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_cqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">req_cq_shadow_ci</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kva</span> <span class="o">=</span> <span class="n">dm_kva</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">req_cq_shadow_ci</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa</span> <span class="o">=</span> <span class="n">dm_pa</span><span class="p">;</span>
		<span class="n">dm_kva</span> <span class="o">+=</span> <span class="n">BFA_CACHELINE_SZ</span><span class="p">;</span>
		<span class="n">dm_pa</span> <span class="o">+=</span> <span class="n">BFA_CACHELINE_SZ</span><span class="p">;</span>

		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">rsp_cq_shadow_pi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kva</span> <span class="o">=</span> <span class="n">dm_kva</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">rsp_cq_shadow_pi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa</span> <span class="o">=</span> <span class="n">dm_pa</span><span class="p">;</span>
		<span class="n">dm_kva</span> <span class="o">+=</span> <span class="n">BFA_CACHELINE_SZ</span><span class="p">;</span>
		<span class="n">dm_pa</span> <span class="o">+=</span> <span class="n">BFA_CACHELINE_SZ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Claim IOCFC dma memory - for the config info page */</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cfg_info</span><span class="p">.</span><span class="n">kva</span> <span class="o">=</span> <span class="n">dm_kva</span><span class="p">;</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cfg_info</span><span class="p">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">dm_pa</span><span class="p">;</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cfginfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_iocfc_cfg_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">dm_kva</span><span class="p">;</span>
	<span class="n">dm_kva</span> <span class="o">+=</span> <span class="n">BFA_ROUNDUP</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_iocfc_cfg_s</span><span class="p">),</span> <span class="n">BFA_CACHELINE_SZ</span><span class="p">);</span>
	<span class="n">dm_pa</span> <span class="o">+=</span> <span class="n">BFA_ROUNDUP</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_iocfc_cfg_s</span><span class="p">),</span> <span class="n">BFA_CACHELINE_SZ</span><span class="p">);</span>

	<span class="cm">/* Claim IOCFC dma memory - for the config response */</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cfgrsp_dma</span><span class="p">.</span><span class="n">kva</span> <span class="o">=</span> <span class="n">dm_kva</span><span class="p">;</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cfgrsp_dma</span><span class="p">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">dm_pa</span><span class="p">;</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cfgrsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_iocfc_cfgrsp_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">dm_kva</span><span class="p">;</span>
	<span class="n">dm_kva</span> <span class="o">+=</span> <span class="n">BFA_ROUNDUP</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_iocfc_cfgrsp_s</span><span class="p">),</span>
			<span class="n">BFA_CACHELINE_SZ</span><span class="p">);</span>
	<span class="n">dm_pa</span> <span class="o">+=</span> <span class="n">BFA_ROUNDUP</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_iocfc_cfgrsp_s</span><span class="p">),</span>
			<span class="n">BFA_CACHELINE_SZ</span><span class="p">);</span>

	<span class="cm">/* Claim IOCFC kva memory */</span>
	<span class="n">dbgsz</span> <span class="o">=</span> <span class="p">(</span><span class="n">bfa_auto_recover</span><span class="p">)</span> <span class="o">?</span> <span class="n">BFA_DBG_FWTRC_LEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbgsz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_ioc_debug_memclaim</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">iocfc</span><span class="p">));</span>
		<span class="n">bfa_mem_kva_curp</span><span class="p">(</span><span class="n">iocfc</span><span class="p">)</span> <span class="o">+=</span> <span class="n">dbgsz</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start BFA submodules.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_start_submod</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">queue_process</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFI_IOC_MAX_CQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bfa_isr_rspq_ack</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">bfa_rspq_ci</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hal_mods</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hal_mods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">submod_enabled</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable BFA submodules.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_disable_submod</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">submod_enabled</span> <span class="o">==</span> <span class="n">BFA_FALSE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hal_mods</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hal_mods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">iocdisable</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">submod_enabled</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_init_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>	<span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa_arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">bfa_cb_init</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">,</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">op_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_stop_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">compl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>  <span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">compl</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_enable_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">compl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>	<span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">compl</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">enable_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_disable_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">,</span> <span class="n">bfa_boolean_t</span> <span class="n">compl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>  <span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfad_s</span> <span class="o">*</span><span class="n">bfad</span> <span class="o">=</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">bfad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">compl</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfad</span><span class="o">-&gt;</span><span class="n">disable_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * configure queue registers from firmware response</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_qreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_iocfc_qreg_s</span> <span class="o">*</span><span class="n">qreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>     <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_regs_s</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">bfa_regs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">kva</span> <span class="o">=</span> <span class="n">bfa_ioc_bar0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFI_IOC_MAX_CQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">hw_qid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">qreg</span><span class="o">-&gt;</span><span class="n">hw_qid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">cpe_q_ci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">+</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">qreg</span><span class="o">-&gt;</span><span class="n">cpe_q_ci_off</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">cpe_q_pi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">+</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">qreg</span><span class="o">-&gt;</span><span class="n">cpe_q_pi_off</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">cpe_q_ctrl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">+</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">qreg</span><span class="o">-&gt;</span><span class="n">cpe_qctl_off</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">rme_q_ci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">+</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">qreg</span><span class="o">-&gt;</span><span class="n">rme_q_ci_off</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">rme_q_pi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">+</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">qreg</span><span class="o">-&gt;</span><span class="n">rme_q_pi_off</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">rme_q_ctrl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">+</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">qreg</span><span class="o">-&gt;</span><span class="n">rme_qctl_off</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_res_recfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_fwcfg_s</span> <span class="o">*</span><span class="n">fwcfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fcxp_res_recfg</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_fcxp_reqs</span><span class="p">);</span>
	<span class="n">bfa_uf_res_recfg</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_uf_bufs</span><span class="p">);</span>
	<span class="n">bfa_rport_res_recfg</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_rports</span><span class="p">);</span>
	<span class="n">bfa_fcp_res_recfg</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span><span class="p">);</span>
	<span class="n">bfa_tskim_res_recfg</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_tskim_reqs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update BFA configuration from firmware configuration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_cfgrsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span>		<span class="o">*</span><span class="n">iocfc</span>	 <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_iocfc_cfgrsp_s</span>	<span class="o">*</span><span class="n">cfgrsp</span>	 <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfgrsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_fwcfg_s</span>	<span class="o">*</span><span class="n">fwcfg</span>	 <span class="o">=</span> <span class="o">&amp;</span><span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">;</span>

	<span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_cqs</span>	      <span class="o">=</span> <span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_cqs</span><span class="p">;</span>
	<span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span>  <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_ioim_reqs</span><span class="p">);</span>
	<span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_fwtio_reqs</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_fwtio_reqs</span><span class="p">);</span>
	<span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_tskim_reqs</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_tskim_reqs</span><span class="p">);</span>
	<span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_fcxp_reqs</span>  <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_fcxp_reqs</span><span class="p">);</span>
	<span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_uf_bufs</span>    <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_uf_bufs</span><span class="p">);</span>
	<span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_rports</span>     <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fwcfg</span><span class="o">-&gt;</span><span class="n">num_rports</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * configure queue register offsets as learnt from firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_iocfc_qreg</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">qreg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Re-configure resources as learnt from Firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_iocfc_res_recfg</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">fwcfg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Install MSIX queue handlers</span>
<span class="cm">	 */</span>
	<span class="n">bfa_msix_queue_install</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">pbc_pwwn</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">=</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">pbc_pwwn</span><span class="p">;</span>
		<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nwwn</span> <span class="o">=</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">pbc_nwwn</span><span class="p">;</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">IOCFC_E_CFG_DONE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_iocfc_reset_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">q</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">q</span> <span class="o">&lt;</span> <span class="n">BFI_IOC_MAX_CQS</span><span class="p">;</span> <span class="n">q</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_reqq_ci</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_reqq_pi</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_rspq_ci</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bfa_rspq_pi</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Process FAA pwwn msg from fw.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_process_faa_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_faa_addr_msg_s</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span>		<span class="o">*</span><span class="n">iocfc</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_iocfc_cfgrsp_s</span>	<span class="o">*</span><span class="n">cfgrsp</span>  <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfgrsp</span><span class="p">;</span>

	<span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">pbc_pwwn</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>
	<span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">pbc_nwwn</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">nwwn</span><span class="p">;</span>

	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nwwn</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">nwwn</span><span class="p">;</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">IOCFC_E_CFG_DONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Fabric Assigned Address specific functions */</span>

<span class="cm">/*</span>
<span class="cm"> *	Check whether IOC is ready before sending command down</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bfa_status_t</span>
<span class="nf">bfa_faa_validate_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">bfa_ioc_type_e</span>	<span class="n">ioc_type</span> <span class="o">=</span> <span class="n">bfa_get_type</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">u32</span>	<span class="n">card_type</span> <span class="o">=</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">.</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">card_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_is_operational</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ioc_type</span> <span class="o">!=</span> <span class="n">BFA_IOC_TYPE_FC</span><span class="p">)</span> <span class="o">||</span> <span class="n">bfa_mfg_is_mezz</span><span class="p">(</span><span class="n">card_type</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">BFA_STATUS_FEATURE_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_IOC_NON_OP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_faa_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_faa_attr_s</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="n">bfa_cb_iocfc_t</span> <span class="n">cbfn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_faa_query_s</span>  <span class="n">faa_attr_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span>      <span class="o">*</span><span class="n">iocfc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>
	<span class="n">bfa_status_t</span>            <span class="n">status</span><span class="p">;</span>

	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">faa_attr</span> <span class="o">=</span> <span class="n">attr</span><span class="p">;</span>
	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">faa_cb</span><span class="p">.</span><span class="n">faa_cbfn</span> <span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">faa_cb</span><span class="p">.</span><span class="n">faa_cbarg</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">bfa_faa_validate_request</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">busy</span> <span class="o">==</span> <span class="n">BFA_TRUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_DEVBUSY</span><span class="p">;</span>

	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">faa_attr_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_faa_query_s</span><span class="p">));</span>
	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">faa_attr_req</span><span class="p">.</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_IOCFC</span><span class="p">,</span>
		<span class="n">BFI_IOCFC_H2I_FAA_QUERY_REQ</span><span class="p">,</span> <span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">bfa</span><span class="p">));</span>

	<span class="n">bfa_ioc_mbox_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">faa_attr_req</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_faa_query_s</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	FAA query response</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_faa_query_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span><span class="p">,</span>
		<span class="n">bfi_faa_query_rsp_t</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span>	<span class="o">*</span><span class="n">cbarg</span> <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">faa_cb</span><span class="p">.</span><span class="n">faa_cbarg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">faa_attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">faa_attr</span><span class="o">-&gt;</span><span class="n">faa</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">faa</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">faa_attr</span><span class="o">-&gt;</span><span class="n">faa_state</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">faa_status</span><span class="p">;</span>
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">faa_attr</span><span class="o">-&gt;</span><span class="n">pwwn_source</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">addr_source</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">faa_cb</span><span class="p">.</span><span class="n">faa_cbfn</span><span class="p">);</span>

	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">faa_cb</span><span class="p">.</span><span class="n">faa_cbfn</span><span class="p">(</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">BFA_STATUS_OK</span><span class="p">);</span>
	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">faa_args</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IOC enable request is complete</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_enable_cbfn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_status</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>	<span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa_arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">IOCFC_E_IOC_ENABLED</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">IOCFC_E_IOC_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IOC disable request is complete</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_disable_cbfn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>	<span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa_arg</span><span class="p">;</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">IOCFC_E_IOC_DISABLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Notify sub-modules of hardware failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_hbfail_cbfn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>	<span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa_arg</span><span class="p">;</span>

	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">queue_process</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">IOCFC_E_IOC_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Actions on chip-reset completion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocfc_reset_cbfn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfa_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>	<span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfa_arg</span><span class="p">;</span>

	<span class="n">bfa_iocfc_reset_queues</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_isr_enable</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Query IOC memory requirement information.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_iocfc_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_meminfo_s</span> <span class="o">*</span><span class="n">meminfo</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">q</span><span class="p">,</span> <span class="n">per_reqq_sz</span><span class="p">,</span> <span class="n">per_rspq_sz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">ioc_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_IOC_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">iocfc_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_IOCFC_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_kva_s</span> <span class="o">*</span><span class="n">iocfc_kva</span> <span class="o">=</span> <span class="n">BFA_MEM_IOCFC_KVA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">u32</span>	<span class="n">dm_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* dma memory setup for IOC */</span>
	<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">ioc_dma</span><span class="p">,</span>
		<span class="n">BFA_ROUNDUP</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_ioc_attr_s</span><span class="p">),</span> <span class="n">BFA_DMA_ALIGN_SZ</span><span class="p">));</span>

	<span class="cm">/* dma memory setup for REQ/RSP queues */</span>
	<span class="n">per_reqq_sz</span> <span class="o">=</span> <span class="n">BFA_ROUNDUP</span><span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_reqq_elems</span> <span class="o">*</span> <span class="n">BFI_LMSG_SZ</span><span class="p">),</span>
				<span class="n">BFA_DMA_ALIGN_SZ</span><span class="p">);</span>
	<span class="n">per_rspq_sz</span> <span class="o">=</span> <span class="n">BFA_ROUNDUP</span><span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_rspq_elems</span> <span class="o">*</span> <span class="n">BFI_LMSG_SZ</span><span class="p">),</span>
				<span class="n">BFA_DMA_ALIGN_SZ</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">q</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_cqs</span><span class="p">;</span> <span class="n">q</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">BFA_MEM_REQQ_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">q</span><span class="p">),</span>
				<span class="n">per_reqq_sz</span><span class="p">);</span>
		<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">BFA_MEM_RSPQ_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">q</span><span class="p">),</span>
				<span class="n">per_rspq_sz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* IOCFC dma memory - calculate Shadow CI/PI size */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">q</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_cqs</span><span class="p">;</span> <span class="n">q</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dm_len</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">BFA_CACHELINE_SZ</span><span class="p">);</span>

	<span class="cm">/* IOCFC dma memory - calculate config info / rsp size */</span>
	<span class="n">dm_len</span> <span class="o">+=</span> <span class="n">BFA_ROUNDUP</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_iocfc_cfg_s</span><span class="p">),</span> <span class="n">BFA_CACHELINE_SZ</span><span class="p">);</span>
	<span class="n">dm_len</span> <span class="o">+=</span> <span class="n">BFA_ROUNDUP</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_iocfc_cfgrsp_s</span><span class="p">),</span>
			<span class="n">BFA_CACHELINE_SZ</span><span class="p">);</span>

	<span class="cm">/* dma memory setup for IOCFC */</span>
	<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">iocfc_dma</span><span class="p">,</span> <span class="n">dm_len</span><span class="p">);</span>

	<span class="cm">/* kva memory setup for IOCFC */</span>
	<span class="n">bfa_mem_kva_setup</span><span class="p">(</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">iocfc_kva</span><span class="p">,</span>
			<span class="p">((</span><span class="n">bfa_auto_recover</span><span class="p">)</span> <span class="o">?</span> <span class="n">BFA_DBG_FWTRC_LEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Query IOC memory requirement information.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_iocfc_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_ioc_s</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="n">bfa_iocfc_cbfn</span><span class="p">.</span><span class="n">enable_cbfn</span> <span class="o">=</span> <span class="n">bfa_iocfc_enable_cbfn</span><span class="p">;</span>
	<span class="n">bfa_iocfc_cbfn</span><span class="p">.</span><span class="n">disable_cbfn</span> <span class="o">=</span> <span class="n">bfa_iocfc_disable_cbfn</span><span class="p">;</span>
	<span class="n">bfa_iocfc_cbfn</span><span class="p">.</span><span class="n">hbfail_cbfn</span> <span class="o">=</span> <span class="n">bfa_iocfc_hbfail_cbfn</span><span class="p">;</span>
	<span class="n">bfa_iocfc_cbfn</span><span class="p">.</span><span class="n">reset_cbfn</span> <span class="o">=</span> <span class="n">bfa_iocfc_reset_cbfn</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">trcmod</span> <span class="o">=</span> <span class="n">bfa</span><span class="o">-&gt;</span><span class="n">trcmod</span><span class="p">;</span>
	<span class="n">bfa_ioc_attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfa_iocfc_cbfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">timer_mod</span><span class="p">);</span>

	<span class="n">bfa_ioc_pci_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">pcidev</span><span class="p">,</span> <span class="n">BFI_PCIFN_CLASS_FC</span><span class="p">);</span>
	<span class="n">bfa_ioc_mbox_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_mbox_isrs</span><span class="p">);</span>

	<span class="n">bfa_iocfc_init_mem</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">pcidev</span><span class="p">);</span>
	<span class="n">bfa_iocfc_mem_claim</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">timer_mod</span><span class="p">.</span><span class="n">timer_q</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">comp_q</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFI_IOC_MAX_CQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">reqq_waitq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cb_reqd</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">op_status</span> <span class="o">=</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">submod_enabled</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_stopped</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Query IOC memory requirement information.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_iocfc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">IOCFC_E_INIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IOC start called from bfa_start(). Called to start IOC operations</span>
<span class="cm"> * at driver instantiation for this instance.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_iocfc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">IOCFC_E_START</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IOC stop called from bfa_stop(). Called only when driver is unloaded</span>
<span class="cm"> * for this instance.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_iocfc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">queue_process</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">IOCFC_E_STOP</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_iocfc_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bfaarg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_mbmsg_s</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_s</span>		<span class="o">*</span><span class="n">bfa</span> <span class="o">=</span> <span class="n">bfaarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span>	<span class="o">*</span><span class="n">iocfc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">bfi_iocfc_i2h_msg_u</span>	<span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">bfi_iocfc_i2h_msg_u</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">.</span><span class="n">msg_id</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">.</span><span class="n">msg_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFI_IOCFC_I2H_CFG_REPLY</span>:
		<span class="n">bfa_iocfc_cfgrsp</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFI_IOCFC_I2H_UPDATEQ_RSP</span>:
		<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">updateq_cbfn</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">updateq_cbarg</span><span class="p">,</span> <span class="n">BFA_STATUS_OK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFI_IOCFC_I2H_ADDR_MSG</span>:
		<span class="n">bfa_iocfc_process_faa_addr</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">bfi_faa_addr_msg_s</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFI_IOCFC_I2H_FAA_QUERY_RSP</span>:
		<span class="n">bfa_faa_query_reply</span><span class="p">(</span><span class="n">iocfc</span><span class="p">,</span> <span class="p">(</span><span class="n">bfi_faa_query_rsp_t</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_iocfc_get_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_attr_s</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span>	<span class="o">*</span><span class="n">iocfc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>

	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">coalesce</span> <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">coalesce</span><span class="p">;</span>

	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">delay</span> <span class="o">?</span>
				<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">delay</span><span class="p">)</span> <span class="o">:</span>
				<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">delay</span><span class="p">);</span>

	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">latency</span> <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">latency</span> <span class="o">?</span>
			<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">latency</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">latency</span><span class="p">);</span>

	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">config</span>	<span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bfa_status_t</span>
<span class="nf">bfa_iocfc_israttr_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_intr_attr_s</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span>		<span class="o">*</span><span class="n">iocfc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_iocfc_set_intr_req_s</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">coalesce</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">coalesce</span><span class="p">;</span>
	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>
	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">latency</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">latency</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_iocfc_is_operational</span><span class="p">(</span><span class="n">bfa</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">bfa_reqq_next</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_IOC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_DEVBUSY</span><span class="p">;</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_IOCFC</span><span class="p">,</span> <span class="n">BFI_IOCFC_H2I_SET_INTR_REQ</span><span class="p">,</span>
		    <span class="n">bfa_fn_lpu</span><span class="p">(</span><span class="n">bfa</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">coalesce</span> <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">coalesce</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">delay</span>    <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">delay</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">latency</span>  <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">intr_attr</span><span class="p">.</span><span class="n">latency</span><span class="p">;</span>

	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>
	<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">latency</span><span class="p">);</span>

	<span class="n">bfa_reqq_produce</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_REQQ_IOC</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_iocfc_set_snsbase</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg_no</span><span class="p">,</span> <span class="n">u64</span> <span class="n">snsbase_pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span>	<span class="o">*</span><span class="n">iocfc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>

	<span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">sense_buf_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">BFI_IOIM_SNSLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bfa_dma_be_addr_set</span><span class="p">(</span><span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfginfo</span><span class="o">-&gt;</span><span class="n">ioim_snsbase</span><span class="p">[</span><span class="n">seg_no</span><span class="p">],</span> <span class="n">snsbase_pa</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Enable IOC after it is disabled.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_iocfc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span> <span class="n">BFA_PL_EID_MISC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="s">&quot;IOC Enable&quot;</span><span class="p">);</span>
	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">.</span><span class="n">cb_reqd</span> <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">IOCFC_E_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_iocfc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_plog_str</span><span class="p">(</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">plog</span><span class="p">,</span> <span class="n">BFA_PL_MID_HAL</span><span class="p">,</span> <span class="n">BFA_PL_EID_MISC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="s">&quot;IOC Disable&quot;</span><span class="p">);</span>

	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">queue_process</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">IOCFC_E_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bfa_boolean_t</span>
<span class="nf">bfa_iocfc_is_operational</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bfa_ioc_is_operational</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">bfa_fsm_cmp_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">,</span> <span class="n">bfa_iocfc_sm_operational</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return boot target port wwns -- read from boot information in flash.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_iocfc_get_bootwwns</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">nwwns</span><span class="p">,</span> <span class="n">wwn_t</span> <span class="o">*</span><span class="n">wwns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_iocfc_cfgrsp_s</span> <span class="o">*</span><span class="n">cfgrsp</span> <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfgrsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">boot_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">nbluns</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_trc</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">nbluns</span><span class="p">);</span>
		<span class="o">*</span><span class="n">nwwns</span> <span class="o">=</span> <span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">nbluns</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">nbluns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">wwns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">blun</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tgt_pwwn</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">nwwns</span> <span class="o">=</span> <span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">bootwwns</span><span class="p">.</span><span class="n">nwwns</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wwns</span><span class="p">,</span> <span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">bootwwns</span><span class="p">.</span><span class="n">wwn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">bootwwns</span><span class="p">.</span><span class="n">wwn</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">bfa_iocfc_get_pbc_vports</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_pbc_vport_s</span> <span class="o">*</span><span class="n">pbc_vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_iocfc_s</span> <span class="o">*</span><span class="n">iocfc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">iocfc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_iocfc_cfgrsp_s</span> <span class="o">*</span><span class="n">cfgrsp</span> <span class="o">=</span> <span class="n">iocfc</span><span class="o">-&gt;</span><span class="n">cfgrsp</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pbc_vport</span><span class="p">,</span> <span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">vport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">vport</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">cfgrsp</span><span class="o">-&gt;</span><span class="n">pbc_cfg</span><span class="p">.</span><span class="n">nvports</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Use this function query the memory requirement of the BFA library.</span>
<span class="cm"> * This function needs to be called before bfa_attach() to get the</span>
<span class="cm"> * memory required of the BFA layer for a given driver configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * This call will fail, if the cap is out of range compared to pre-defined</span>
<span class="cm"> * values within the BFA library</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] cfg -	pointer to bfa_ioc_cfg_t. Driver layer should indicate</span>
<span class="cm"> *			its configuration in this structure.</span>
<span class="cm"> *			The default values for struct bfa_iocfc_cfg_s can be</span>
<span class="cm"> *			fetched using bfa_cfg_get_default() API.</span>
<span class="cm"> *</span>
<span class="cm"> *			If cap&#39;s boundary check fails, the library will use</span>
<span class="cm"> *			the default bfa_cap_t values (and log a warning msg).</span>
<span class="cm"> *</span>
<span class="cm"> * @param[out] meminfo - pointer to bfa_meminfo_t. This content</span>
<span class="cm"> *			indicates the memory type (see bfa_mem_type_t) and</span>
<span class="cm"> *			amount of memory required.</span>
<span class="cm"> *</span>
<span class="cm"> *			Driver should allocate the memory, populate the</span>
<span class="cm"> *			starting address for each block and provide the same</span>
<span class="cm"> *			structure as input parameter to bfa_attach() call.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] bfa -	pointer to the bfa structure, used while fetching the</span>
<span class="cm"> *			dma, kva memory information of the bfa sub-modules.</span>
<span class="cm"> *</span>
<span class="cm"> * @return void</span>
<span class="cm"> *</span>
<span class="cm"> * Special Considerations: @note</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_cfg_get_meminfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_meminfo_s</span> <span class="o">*</span><span class="n">meminfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">port_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_PORT_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">ablk_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_ABLK_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">cee_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_CEE_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">sfp_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_SFP_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">flash_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_FLASH_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">diag_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_DIAG_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">phy_dma</span> <span class="o">=</span> <span class="n">BFA_MEM_PHY_DMA</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">((</span><span class="n">cfg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">meminfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">meminfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_meminfo_s</span><span class="p">));</span>

	<span class="cm">/* Initialize the DMA &amp; KVA meminfo queues */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meminfo</span><span class="o">-&gt;</span><span class="n">dma_info</span><span class="p">.</span><span class="n">qe</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meminfo</span><span class="o">-&gt;</span><span class="n">kva_info</span><span class="p">.</span><span class="n">qe</span><span class="p">);</span>

	<span class="n">bfa_iocfc_meminfo</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">meminfo</span><span class="p">,</span> <span class="n">bfa</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hal_mods</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hal_mods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">meminfo</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">meminfo</span><span class="p">,</span> <span class="n">bfa</span><span class="p">);</span>

	<span class="cm">/* dma info setup */</span>
	<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">port_dma</span><span class="p">,</span> <span class="n">bfa_port_meminfo</span><span class="p">());</span>
	<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">ablk_dma</span><span class="p">,</span> <span class="n">bfa_ablk_meminfo</span><span class="p">());</span>
	<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">cee_dma</span><span class="p">,</span> <span class="n">bfa_cee_meminfo</span><span class="p">());</span>
	<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">sfp_dma</span><span class="p">,</span> <span class="n">bfa_sfp_meminfo</span><span class="p">());</span>
	<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">flash_dma</span><span class="p">,</span>
			  <span class="n">bfa_flash_meminfo</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">min_cfg</span><span class="p">));</span>
	<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">diag_dma</span><span class="p">,</span> <span class="n">bfa_diag_meminfo</span><span class="p">());</span>
	<span class="n">bfa_mem_dma_setup</span><span class="p">(</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">phy_dma</span><span class="p">,</span>
			  <span class="n">bfa_phy_meminfo</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">min_cfg</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Use this function to do attach the driver instance with the BFA</span>
<span class="cm"> * library. This function will not trigger any HW initialization</span>
<span class="cm"> * process (which will be done in bfa_init() call)</span>
<span class="cm"> *</span>
<span class="cm"> * This call will fail, if the cap is out of range compared to</span>
<span class="cm"> * pre-defined values within the BFA library</span>
<span class="cm"> *</span>
<span class="cm"> * @param[out]	bfa	Pointer to bfa_t.</span>
<span class="cm"> * @param[in]	bfad	Opaque handle back to the driver&#39;s IOC structure</span>
<span class="cm"> * @param[in]	cfg	Pointer to bfa_ioc_cfg_t. Should be same structure</span>
<span class="cm"> *			that was used in bfa_cfg_get_meminfo().</span>
<span class="cm"> * @param[in]	meminfo	Pointer to bfa_meminfo_t. The driver should</span>
<span class="cm"> *			use the bfa_cfg_get_meminfo() call to</span>
<span class="cm"> *			find the memory blocks required, allocate the</span>
<span class="cm"> *			required memory and provide the starting addresses.</span>
<span class="cm"> * @param[in]	pcidev	pointer to struct bfa_pcidev_s</span>
<span class="cm"> *</span>
<span class="cm"> * @return</span>
<span class="cm"> * void</span>
<span class="cm"> *</span>
<span class="cm"> * Special Considerations:</span>
<span class="cm"> *</span>
<span class="cm"> * @note</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">bfa_meminfo_s</span> <span class="o">*</span><span class="n">meminfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_pcidev_s</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="n">dma_info</span><span class="p">,</span> <span class="o">*</span><span class="n">dma_elem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_mem_kva_s</span> <span class="o">*</span><span class="n">kva_info</span><span class="p">,</span> <span class="o">*</span><span class="n">kva_elem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">dm_qe</span><span class="p">,</span> <span class="o">*</span><span class="n">km_qe</span><span class="p">;</span>

	<span class="n">bfa</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">((</span><span class="n">cfg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">meminfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">));</span>

	<span class="cm">/* Initialize memory pointers for iterative allocation */</span>
	<span class="n">dma_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">meminfo</span><span class="o">-&gt;</span><span class="n">dma_info</span><span class="p">;</span>
	<span class="n">dma_info</span><span class="o">-&gt;</span><span class="n">kva_curp</span> <span class="o">=</span> <span class="n">dma_info</span><span class="o">-&gt;</span><span class="n">kva</span><span class="p">;</span>
	<span class="n">dma_info</span><span class="o">-&gt;</span><span class="n">dma_curp</span> <span class="o">=</span> <span class="n">dma_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>

	<span class="n">kva_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">meminfo</span><span class="o">-&gt;</span><span class="n">kva_info</span><span class="p">;</span>
	<span class="n">kva_info</span><span class="o">-&gt;</span><span class="n">kva_curp</span> <span class="o">=</span> <span class="n">kva_info</span><span class="o">-&gt;</span><span class="n">kva</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">dm_qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_info</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_elem</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_mem_dma_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">dm_qe</span><span class="p">;</span>
		<span class="n">dma_elem</span><span class="o">-&gt;</span><span class="n">kva_curp</span> <span class="o">=</span> <span class="n">dma_elem</span><span class="o">-&gt;</span><span class="n">kva</span><span class="p">;</span>
		<span class="n">dma_elem</span><span class="o">-&gt;</span><span class="n">dma_curp</span> <span class="o">=</span> <span class="n">dma_elem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">km_qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kva_info</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kva_elem</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_mem_kva_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">km_qe</span><span class="p">;</span>
		<span class="n">kva_elem</span><span class="o">-&gt;</span><span class="n">kva_curp</span> <span class="o">=</span> <span class="n">kva_elem</span><span class="o">-&gt;</span><span class="n">kva</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_iocfc_attach</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">pcidev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hal_mods</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hal_mods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">attach</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">bfad</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">pcidev</span><span class="p">);</span>

	<span class="n">bfa_com_port_attach</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_com_ablk_attach</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_com_cee_attach</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_com_sfp_attach</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_com_flash_attach</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">min_cfg</span><span class="p">);</span>
	<span class="n">bfa_com_diag_attach</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_com_phy_attach</span><span class="p">(</span><span class="n">bfa</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">min_cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Use this function to delete a BFA IOC. IOC should be stopped (by</span>
<span class="cm"> * calling bfa_stop()) before this function call.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] bfa - pointer to bfa_t.</span>
<span class="cm"> *</span>
<span class="cm"> * @return</span>
<span class="cm"> * void</span>
<span class="cm"> *</span>
<span class="cm"> * Special Considerations:</span>
<span class="cm"> *</span>
<span class="cm"> * @note</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hal_mods</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hal_mods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">detach</span><span class="p">(</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_ioc_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_comp_deq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">comp_q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="n">comp_q</span><span class="p">);</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfa</span><span class="o">-&gt;</span><span class="n">comp_q</span><span class="p">,</span> <span class="n">comp_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_comp_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">comp_q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="o">*</span><span class="n">qen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_cb_qe_s</span>	<span class="o">*</span><span class="n">hcb_qe</span><span class="p">;</span>
	<span class="n">bfa_cb_cbfn_status_t</span>	<span class="n">cbfn</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="n">qen</span><span class="p">,</span> <span class="n">comp_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hcb_qe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_cb_qe_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hcb_qe</span><span class="o">-&gt;</span><span class="n">pre_rmv</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* qe is invalid after return, dequeue before cbfn() */</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">qe</span><span class="p">);</span>
			<span class="n">cbfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">bfa_cb_cbfn_status_t</span><span class="p">)(</span><span class="n">hcb_qe</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="p">);</span>
			<span class="n">cbfn</span><span class="p">(</span><span class="n">hcb_qe</span><span class="o">-&gt;</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">hcb_qe</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">hcb_qe</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="p">(</span><span class="n">hcb_qe</span><span class="o">-&gt;</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">BFA_TRUE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_comp_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_s</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">comp_q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_cb_qe_s</span>	<span class="o">*</span><span class="n">hcb_qe</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">comp_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_q_deq</span><span class="p">(</span><span class="n">comp_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">hcb_qe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_cb_qe_s</span> <span class="o">*</span><span class="p">)</span> <span class="n">qe</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">hcb_qe</span><span class="o">-&gt;</span><span class="n">pre_rmv</span><span class="p">);</span>
		<span class="n">hcb_qe</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="p">(</span><span class="n">hcb_qe</span><span class="o">-&gt;</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">BFA_FALSE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return the list of PCI vendor/device id lists supported by this</span>
<span class="cm"> * BFA instance.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_get_pciids</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_pciid_s</span> <span class="o">**</span><span class="n">pciids</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">npciids</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_pciid_s</span> <span class="n">__pciids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">BFA_PCI_VENDOR_ID_BROCADE</span><span class="p">,</span> <span class="n">BFA_PCI_DEVICE_ID_FC_8G2P</span><span class="p">},</span>
		<span class="p">{</span><span class="n">BFA_PCI_VENDOR_ID_BROCADE</span><span class="p">,</span> <span class="n">BFA_PCI_DEVICE_ID_FC_8G1P</span><span class="p">},</span>
		<span class="p">{</span><span class="n">BFA_PCI_VENDOR_ID_BROCADE</span><span class="p">,</span> <span class="n">BFA_PCI_DEVICE_ID_CT</span><span class="p">},</span>
		<span class="p">{</span><span class="n">BFA_PCI_VENDOR_ID_BROCADE</span><span class="p">,</span> <span class="n">BFA_PCI_DEVICE_ID_CT_FC</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">npciids</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__pciids</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__pciids</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="o">*</span><span class="n">pciids</span> <span class="o">=</span> <span class="n">__pciids</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Use this function query the default struct bfa_iocfc_cfg_s value (compiled</span>
<span class="cm"> * into BFA layer). The OS driver can then turn back and overwrite entries that</span>
<span class="cm"> * have been configured by the user.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] cfg - pointer to bfa_ioc_cfg_t</span>
<span class="cm"> *</span>
<span class="cm"> * @return</span>
<span class="cm"> *	void</span>
<span class="cm"> *</span>
<span class="cm"> * Special Considerations:</span>
<span class="cm"> * note</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_cfg_get_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fabrics</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_FABRICS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_lports</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_LPORTS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_rports</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_RPORTS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_IOIM_REQS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_tskim_reqs</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_TSKIM_REQS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fcxp_reqs</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_FCXP_REQS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_uf_bufs</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_UF_BUFS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_cqs</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_CQS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_reqq_elems</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_REQQ_ELEMS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_rspq_elems</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_RSPQ_ELEMS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sgpgs</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_SGPGS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sboot_tgts</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_SBOOT_TGTS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sboot_luns</span> <span class="o">=</span> <span class="n">DEF_CFG_NUM_SBOOT_LUNS</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">path_tov</span> <span class="o">=</span> <span class="n">BFA_FCPIM_PATHTOV_DEF</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">ioc_recover</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">delay_comp</span> <span class="o">=</span> <span class="n">BFA_FALSE</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_cfg_get_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocfc_cfg_s</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_cfg_get_default</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_ioim_reqs</span>   <span class="o">=</span> <span class="n">BFA_IOIM_MIN</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_tskim_reqs</span>  <span class="o">=</span> <span class="n">BFA_TSKIM_MIN</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fcxp_reqs</span>   <span class="o">=</span> <span class="n">BFA_FCXP_MIN</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_uf_bufs</span>     <span class="o">=</span> <span class="n">BFA_UF_MIN</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_rports</span>      <span class="o">=</span> <span class="n">BFA_RPORT_MIN</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fwcfg</span><span class="p">.</span><span class="n">num_fwtio_reqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_sgpgs</span>      <span class="o">=</span> <span class="n">BFA_SGPG_MIN</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_reqq_elems</span> <span class="o">=</span> <span class="n">BFA_REQQ_NELEMS_MIN</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">num_rspq_elems</span> <span class="o">=</span> <span class="n">BFA_RSPQ_NELEMS_MIN</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvcfg</span><span class="p">.</span><span class="n">min_cfg</span>	   <span class="o">=</span> <span class="n">BFA_TRUE</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
