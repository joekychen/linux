<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › osst.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>osst.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">  SCSI Tape Driver for Linux version 1.1 and newer. See the accompanying</span>
<span class="cm">  file Documentation/scsi/st.txt for more information.</span>

<span class="cm">  History:</span>

<span class="cm">  OnStream SCSI Tape support (osst) cloned from st.c by</span>
<span class="cm">  Willem Riede (osst@riede.org) Feb 2000</span>
<span class="cm">  Fixes ... Kurt Garloff &lt;garloff@suse.de&gt; Mar 2000</span>

<span class="cm">  Rewritten from Dwayne Forsyth&#39;s SCSI tape driver by Kai Makisara.</span>
<span class="cm">  Contribution and ideas from several people including (in alphabetical</span>
<span class="cm">  order) Klaus Ehrenfried, Wolfgang Denk, Steve Hirsch, Andreas Koppenh&quot;ofer,</span>
<span class="cm">  Michael Leodolter, Eyal Lebedinsky, J&quot;org Weule, and Eric Youngdale.</span>

<span class="cm">  Copyright 1992 - 2002 Kai Makisara / 2000 - 2006 Willem Riede</span>
<span class="cm">	 email osst@riede.org</span>

<span class="cm">  $Header: /cvsroot/osst/Driver/osst.c,v 1.73 2005/01/01 21:13:34 wriede Exp $</span>

<span class="cm">  Microscopic alterations - Rik Ling, 2000/12/21</span>
<span class="cm">  Last st.c sync: Tue Oct 15 22:01:04 2002 by makisara</span>
<span class="cm">  Some small formal changes - aeb, 950809</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">cvsid</span> <span class="o">=</span> <span class="s">&quot;$Id: osst.c,v 1.73 2005/01/01 21:13:34 wriede Exp $&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">osst_version</span> <span class="o">=</span> <span class="s">&quot;0.99.4&quot;</span><span class="p">;</span>

<span class="cm">/* The &quot;failure to reconnect&quot; firmware bug */</span>
<span class="cp">#define OSST_FW_NEED_POLL_MIN 10601 </span><span class="cm">/*(107A)*/</span><span class="cp"></span>
<span class="cp">#define OSST_FW_NEED_POLL_MAX 10704 </span><span class="cm">/*(108D)*/</span><span class="cp"></span>
<span class="cp">#define OSST_FW_NEED_POLL(x,d) ((x) &gt;= OSST_FW_NEED_POLL_MIN &amp;&amp; (x) &lt;= OSST_FW_NEED_POLL_MAX &amp;&amp; d-&gt;host-&gt;this_id != 7)</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/mtio.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cm">/* The driver prints some debugging information on the console if DEBUG</span>
<span class="cm">   is defined and non-zero. */</span>
<span class="cp">#define DEBUG 0</span>

<span class="cm">/* The message level for the debug messages is currently set to KERN_NOTICE</span>
<span class="cm">   so that people can easily see the messages. Later when the debugging messages</span>
<span class="cm">   in the drivers are more widely classified, this may be changed to KERN_DEBUG. */</span>
<span class="cp">#define OSST_DEB_MSG  KERN_NOTICE</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_driver.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_ioctl.h&gt;</span>

<span class="cp">#define ST_KILOBYTE 1024</span>

<span class="cp">#include &quot;st.h&quot;</span>
<span class="cp">#include &quot;osst.h&quot;</span>
<span class="cp">#include &quot;osst_options.h&quot;</span>
<span class="cp">#include &quot;osst_detect.h&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">osst_int_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">write_threshold_kbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_sg_segs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef MODULE</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Willem Riede&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;OnStream {DI-|FW-|SC-|USB}{30|50} Tape Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_CHARDEV_MAJOR</span><span class="p">(</span><span class="n">OSST_MAJOR</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_SCSI_DEVICE</span><span class="p">(</span><span class="n">TYPE_TAPE</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">max_dev</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_dev</span><span class="p">,</span> <span class="s">&quot;Maximum number of OnStream Tape Drives to attach (4)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">write_threshold_kbs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">write_threshold_kbs</span><span class="p">,</span> <span class="s">&quot;Asynchronous write threshold (KB; 32)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">max_sg_segs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_sg_segs</span><span class="p">,</span> <span class="s">&quot;Maximum number of scatter/gather segments to use (9)&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">osst_dev_parm</span> <span class="p">{</span>
       <span class="kt">char</span>   <span class="o">*</span><span class="n">name</span><span class="p">;</span>
       <span class="kt">int</span>    <span class="o">*</span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span> <span class="n">parms</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
       <span class="p">{</span> <span class="s">&quot;max_dev&quot;</span><span class="p">,</span>             <span class="o">&amp;</span><span class="n">max_dev</span>             <span class="p">},</span>
       <span class="p">{</span> <span class="s">&quot;write_threshold_kbs&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">write_threshold_kbs</span> <span class="p">},</span>
       <span class="p">{</span> <span class="s">&quot;max_sg_segs&quot;</span><span class="p">,</span>         <span class="o">&amp;</span><span class="n">max_sg_segs</span>         <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* Some default definitions have been moved to osst_options.h */</span>
<span class="cp">#define OSST_BUFFER_SIZE (OSST_BUFFER_BLOCKS * ST_KILOBYTE)</span>
<span class="cp">#define OSST_WRITE_THRESHOLD (OSST_WRITE_THRESHOLD_BLOCKS * ST_KILOBYTE)</span>

<span class="cm">/* The buffer size should fit into the 24 bits for length in the</span>
<span class="cm">   6-byte SCSI read and write commands. */</span>
<span class="cp">#if OSST_BUFFER_SIZE &gt;= (2 &lt;&lt; 24 - 1)</span>
<span class="cp">#error &quot;Buffer size should not exceed (2 &lt;&lt; 24 - 1) bytes!&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#if DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debugging</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cm">/* uncomment define below to test error recovery */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define OSST<em>INJECT</em>ERRORS 1</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>

<span class="cm">/* Do not retry! The drive firmware already retries when appropriate,</span>
<span class="cm">   and when it tries to tell us something, we had better listen... */</span>
<span class="cp">#define MAX_RETRIES 0</span>

<span class="cp">#define NO_TAPE  NOT_READY</span>

<span class="cp">#define OSST_WAIT_POSITION_COMPLETE   (HZ &gt; 200 ? HZ / 200 : 1)</span>
<span class="cp">#define OSST_WAIT_WRITE_COMPLETE      (HZ / 12)</span>
<span class="cp">#define OSST_WAIT_LONG_WRITE_COMPLETE (HZ / 2)</span>
	
<span class="cp">#define OSST_TIMEOUT (200 * HZ)</span>
<span class="cp">#define OSST_LONG_TIMEOUT (1800 * HZ)</span>

<span class="cp">#define TAPE_NR(x) (iminor(x) &amp; ~(-1 &lt;&lt; ST_MODE_SHIFT))</span>
<span class="cp">#define TAPE_MODE(x) ((iminor(x) &amp; ST_MODE_MASK) &gt;&gt; ST_MODE_SHIFT)</span>
<span class="cp">#define TAPE_REWIND(x) ((iminor(x) &amp; 0x80) == 0)</span>
<span class="cp">#define TAPE_IS_RAW(x) (TAPE_MODE(x) &amp; (ST_NBR_MODES &gt;&gt; 1))</span>

<span class="cm">/* Internal ioctl to set both density (uppermost 8 bits) and blocksize (lower</span>
<span class="cm">   24 bits) */</span>
<span class="cp">#define SET_DENS_AND_BLK 0x10001</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_buffer_size</span>       <span class="o">=</span> <span class="n">OSST_BUFFER_SIZE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_write_threshold</span>   <span class="o">=</span> <span class="n">OSST_WRITE_THRESHOLD</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_max_sg_segs</span>       <span class="o">=</span> <span class="n">OSST_MAX_SG</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_max_dev</span>           <span class="o">=</span> <span class="n">OSST_MAX_TAPES</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_nr_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">**</span><span class="n">os_scsi_tapes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modes_defined</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="n">new_tape_buffer</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">enlarge_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">normalize_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">append_to_buffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">from_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_zero_buffer_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_copy_to_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_copy_from_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_driver</span> <span class="n">osst_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gendrv</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span>  <span class="s">&quot;osst&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">osst_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">osst_remove</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_int_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_set_frame_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frame</span><span class="p">,</span> <span class="kt">int</span> <span class="n">skip</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_get_frame_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_flush_write_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">osst_write_error_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pending</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tape_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">tape</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tape</span><span class="o">-&gt;</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Routines that handle the interaction with mid-layer SCSI routines */</span>


<span class="cm">/* Normalize Sense */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">osst_analyze_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">st_cmdstatus</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ucp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sense</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">have_sense</span> <span class="o">=</span> <span class="n">scsi_normalize_sense</span><span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span>
				<span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sense_hdr</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">have_sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">remainder_valid</span> <span class="o">=</span>
			<span class="n">scsi_get_sense_info_fld</span><span class="p">(</span><span class="n">sense</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">uremainder64</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x71</span>:
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x70</span>:
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">fixed_format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x73</span>:
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">deferred</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x72</span>:
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">fixed_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ucp</span> <span class="o">=</span> <span class="n">scsi_sense_desc_find</span><span class="p">(</span><span class="n">sense</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ucp</span> <span class="o">?</span> <span class="p">(</span><span class="n">ucp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Convert the result to success code */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_chk_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span> <span class="n">SRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span> <span class="n">sense</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">scode</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">st_cmdstatus</span> <span class="o">*</span><span class="n">cmdstatp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmdstatp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">;</span>
	<span class="n">osst_analyze_sense</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">cmdstatp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span><span class="p">)</span>
		<span class="n">scode</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">.</span><span class="n">sense_hdr</span><span class="p">.</span><span class="n">sense_key</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Error: %x, cmd: %x %x %x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span>
		   <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		   <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scode</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Sense: %02x, ASC: %02x, ASCQ: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       	<span class="n">name</span><span class="p">,</span> <span class="n">scode</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span><span class="p">)</span>
			<span class="n">__scsi_print_sense</span><span class="p">(</span><span class="s">&quot;osst &quot;</span><span class="p">,</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
		 <span class="n">scode</span> <span class="o">!=</span> <span class="n">NO_SENSE</span> <span class="o">&amp;&amp;</span>
		 <span class="n">scode</span> <span class="o">!=</span> <span class="n">RECOVERED_ERROR</span> <span class="o">&amp;&amp;</span>
<span class="cm">/*      	 scode != UNIT_ATTENTION &amp;&amp; */</span>
		 <span class="n">scode</span> <span class="o">!=</span> <span class="n">BLANK_CHECK</span> <span class="o">&amp;&amp;</span>
		 <span class="n">scode</span> <span class="o">!=</span> <span class="n">VOLUME_OVERFLOW</span> <span class="o">&amp;&amp;</span>
		 <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MODE_SENSE</span> <span class="o">&amp;&amp;</span>
		 <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TEST_UNIT_READY</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Abnormal conditions for tape */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Command with sense data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="n">__scsi_print_sense</span><span class="p">(</span><span class="s">&quot;osst &quot;</span><span class="p">,</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">static</span>	<span class="kt">int</span>	<span class="n">notyetprinted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			     <span class="s">&quot;%s:W: Warning %x (driver bt 0x%x, host bt 0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">driver_byte</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
			     <span class="n">host_byte</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">notyetprinted</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">notyetprinted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					<span class="s">&quot;%s:I: This warning may be caused by your scsi controller,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					<span class="s">&quot;%s:I: it has been reported with some Buslogic cards.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span> <span class="o">|=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">was_reset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdstatp</span><span class="o">-&gt;</span><span class="n">have_sense</span> <span class="o">&amp;&amp;</span> <span class="n">scode</span> <span class="o">==</span> <span class="n">RECOVERED_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_erreg</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_6</span><span class="p">)</span>
				<span class="n">stp</span> <span class="o">=</span> <span class="s">&quot;read&quot;</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_6</span><span class="p">)</span>
				<span class="n">stp</span> <span class="o">=</span> <span class="s">&quot;write&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">stp</span> <span class="o">=</span> <span class="s">&quot;ioctl&quot;</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Recovered %s error (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">stp</span><span class="p">,</span>
					     <span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_count</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Wakeup from interrupt */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">osst_end_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">update</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span><span class="n">SRpnt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">end_io_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rq_map_data</span> <span class="o">*</span><span class="n">mdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">map_data</span><span class="p">;</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">.</span><span class="n">midlevel_result</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">waiting</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">waiting</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mdata</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">);</span>
		<span class="n">blk_rq_unmap_user</span><span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__blk_put_request</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* osst_request memory management */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span><span class="nf">osst_allocate_request</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_request</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osst_release_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span><span class="n">streq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">streq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_direction</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bufflen</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">use_sg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rq_map_data</span> <span class="o">*</span><span class="n">mdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">map_data</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DRIVER_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_QUIET</span><span class="p">;</span>

	<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_sg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="o">*</span><span class="n">sgl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">pages</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">use_sg</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pages</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_req</span><span class="p">;</span>

		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">use_sg</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">null_mapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">page_order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">nr_entries</span> <span class="o">=</span>
			<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">bufflen</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">mdata</span><span class="o">-&gt;</span><span class="n">page_order</span><span class="p">);</span>
		<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">blk_rq_map_user</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">mdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bufflen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pages</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_req</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">;</span>
		<span class="n">mdata</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bufflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">blk_rq_map_kern</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bufflen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_req</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">cmd_len</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BLK_MAX_CDB</span><span class="p">);</span> <span class="cm">/* ATAPI hates garbage after CDB */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="n">retries</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">end_io_data</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

	<span class="n">blk_execute_rq_nowait</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">osst_end_async</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">free_req:</span>
	<span class="n">blk_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">DRIVER_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Do the scsi command. Waits until command performed if do_wait is true.</span>
<span class="cm">   Otherwise osst_write_behind_check() is used to check that the command</span>
<span class="cm">   has finished. */</span>
<span class="k">static</span>	<span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span> <span class="nf">osst_do_scsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span><span class="n">SRpnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> 
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">use_sg</span><span class="p">;</span>
<span class="cp">#ifdef OSST_INJECT_ERRORS</span>
	<span class="k">static</span>   <span class="kt">int</span>   <span class="n">inject</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span>   <span class="kt">int</span>   <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">waiting</span><span class="p">;</span>

	<span class="cm">/* if async, make sure there&#39;s no command outstanding */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_wait</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Async command already active.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINTR</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_allocate_request</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t allocate SCSI request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINTR</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">stp</span> <span class="o">=</span> <span class="n">STp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If async IO, set last_SRpnt. This ptr tells write_behind_check</span>
<span class="cm">	   which IO is outstanding. It&#39;s nulled out when the IO completes. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_wait</span><span class="p">)</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

	<span class="n">waiting</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="n">waiting</span><span class="p">);</span>
	<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="n">waiting</span><span class="p">;</span>

	<span class="n">use_sg</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">?</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">use_sg</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_sg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">&lt;</span> <span class="n">use_sg</span><span class="p">)</span>
			<span class="n">use_sg</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">.</span><span class="n">have_sense</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osst_execute</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">COMMAND_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">direction</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span>
			 <span class="n">use_sg</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">retries</span><span class="p">))</span>
		<span class="cm">/* could not allocate the buffer or request was too large */</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">do_wait</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="n">waiting</span><span class="p">);</span>
		<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="n">osst_chk_result</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">SRpnt</span><span class="p">);</span>
<span class="cp">#ifdef OSST_INJECT_ERRORS</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_6</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;&amp;</span> 
		    <span class="p">(</span> <span class="p">(</span><span class="o">++</span> <span class="n">inject</span> <span class="o">%</span> <span class="mi">83</span><span class="p">)</span> <span class="o">==</span> <span class="mi">29</span>  <span class="o">||</span>
		      <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">==</span> <span class="mi">240</span> 
			         <span class="cm">/* or STp-&gt;read_error_frame to fail again on the block calculated above */</span> <span class="o">&amp;&amp;</span>
				 <span class="o">++</span><span class="n">repeat</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Injecting read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">));</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">last_result_fatal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">SRpnt</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Handle the write-behind checking (downs the semaphore) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">osst_write_behind_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span> <span class="n">STbuffer</span><span class="p">;</span>

	<span class="n">STbuffer</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>

<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_pending</span><span class="p">)</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_waits</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_finished</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">));</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="n">osst_chk_result</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span>
			<span class="n">osst_write_error_recovery</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="o">++</span><span class="p">;</span>

	<span class="n">osst_release_request</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">&lt;</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;osst :A: write_behind_check: something left in buffer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">-=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">writing</span><span class="p">;</span>
	<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* Onstream specific Routines */</span>
<span class="cm">/*</span>
<span class="cm"> * Initialize the OnStream AUX</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">osst_init_aux</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frame_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frame_seq_number</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">logical_blk_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blk_sz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blk_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">os_aux_t</span>       <span class="o">*</span><span class="n">aux</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">;</span>
	<span class="n">os_partition_t</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">;</span>
	<span class="n">os_dat_t</span>       <span class="o">*</span><span class="n">dat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">aux</span><span class="p">));</span>
	<span class="n">aux</span><span class="o">-&gt;</span><span class="n">format_id</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">application_sig</span><span class="p">,</span> <span class="s">&quot;LIN4&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">aux</span><span class="o">-&gt;</span><span class="n">hdwr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">=</span> <span class="n">frame_type</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">frame_type</span><span class="p">)</span> <span class="p">{</span>
	  <span class="k">case</span>	<span class="n">OS_FRAME_TYPE_HEADER</span>:
		<span class="n">aux</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span>    <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">partition_num</span>        <span class="o">=</span> <span class="n">OS_CONFIG_PARTITION</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">par_desc_ver</span>         <span class="o">=</span> <span class="n">OS_PARTITION_VERSION</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span>        <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>
		<span class="cm">/* 0-4 = reserved, 5-9 = header, 2990-2994 = header, 2995-2999 = reserved */</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">first_frame_ppos</span>     <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">last_frame_ppos</span>      <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mh">0xbb7</span><span class="p">);</span>
		<span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_seq_num</span>        <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">aux</span><span class="o">-&gt;</span><span class="n">logical_blk_num_high</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">aux</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span>      <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">aux</span><span class="o">-&gt;</span><span class="n">next_mark_ppos</span>       <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_mark_ppos</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	  <span class="k">case</span>	<span class="n">OS_FRAME_TYPE_DATA</span>:
	  <span class="k">case</span>	<span class="n">OS_FRAME_TYPE_MARKER</span>:
		<span class="n">dat</span><span class="o">-&gt;</span><span class="n">dat_sz</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">dat</span><span class="o">-&gt;</span><span class="n">reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dat</span><span class="o">-&gt;</span><span class="n">entry_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dat</span><span class="o">-&gt;</span><span class="n">reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dat</span><span class="o">-&gt;</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_sz</span>   <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">blk_sz</span><span class="p">);</span>
		<span class="n">dat</span><span class="o">-&gt;</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_cnt</span>  <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">blk_cnt</span><span class="p">);</span>
		<span class="n">dat</span><span class="o">-&gt;</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">frame_type</span><span class="o">==</span><span class="n">OS_FRAME_TYPE_MARKER</span><span class="o">?</span>
							<span class="nl">OS_DAT_FLAGS_MARK:</span><span class="n">OS_DAT_FLAGS_DATA</span><span class="p">;</span>
		<span class="n">dat</span><span class="o">-&gt;</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	  <span class="k">case</span>	<span class="n">OS_FRAME_TYPE_EOD</span>:
		<span class="n">aux</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span>    <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">partition_num</span>        <span class="o">=</span> <span class="n">OS_DATA_PARTITION</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">par_desc_ver</span>         <span class="o">=</span> <span class="n">OS_PARTITION_VERSION</span><span class="p">;</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span>        <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">first_frame_ppos</span>     <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span><span class="p">);</span>
		<span class="n">par</span><span class="o">-&gt;</span><span class="n">last_frame_ppos</span>      <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">);</span>
		<span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_seq_num</span>        <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">frame_seq_number</span><span class="p">);</span>
		<span class="n">aux</span><span class="o">-&gt;</span><span class="n">logical_blk_num_high</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">aux</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span>      <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">logical_blk_num</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	  <span class="nl">default:</span> <span class="p">;</span> <span class="cm">/* probably FILL */</span>
	<span class="p">}</span>
	<span class="n">aux</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">);</span>
	<span class="n">aux</span><span class="o">-&gt;</span><span class="n">phys_fm</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">);</span>
	<span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span>  <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Verify that we have the correct tape frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_verify_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frame_seq_number</span><span class="p">,</span> <span class="kt">int</span> <span class="n">quiet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>               <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="n">os_aux_t</span>           <span class="o">*</span> <span class="n">aux</span>  <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">;</span>
	<span class="n">os_partition_t</span>     <span class="o">*</span> <span class="n">par</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span> <span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="kt">int</span>		     <span class="n">blk_cnt</span><span class="p">,</span> <span class="n">blk_sz</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="s">&quot;READ ERROR ON FRAME&quot;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">OS_FRAME_SIZE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping frame, read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">format_id</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping frame, format_id %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">format_id</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">application_sig</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">application_sig</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">application_sig</span><span class="p">,</span> <span class="s">&quot;LIN3&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping frame, incorrect application signature</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">partition_num</span> <span class="o">!=</span> <span class="n">OS_DATA_PARTITION</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media</span> <span class="o">||</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping frame, partition num %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">partition_num</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">par_desc_ver</span> <span class="o">!=</span> <span class="n">OS_PARTITION_VERSION</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping frame, partition version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">par_desc_ver</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping frame, wrt_pass_cntr %d (expected %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				    <span class="n">name</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span><span class="p">),</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="n">OS_FRAME_TYPE_DATA</span> <span class="o">&amp;&amp;</span>
	    <span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="n">OS_FRAME_TYPE_EOD</span> <span class="o">&amp;&amp;</span>
	    <span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="n">OS_FRAME_TYPE_MARKER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">quiet</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping frame, frame type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">OS_FRAME_TYPE_EOD</span> <span class="o">&amp;&amp;</span>
	    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">&lt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Skipping premature EOD frame %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				 <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">frame_seq_number</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_seq_num</span><span class="p">)</span> <span class="o">!=</span> <span class="n">frame_seq_number</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">quiet</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping frame, sequence number %u (expected %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
					    <span class="n">name</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_seq_num</span><span class="p">),</span> <span class="n">frame_seq_number</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">OS_FRAME_TYPE_MARKER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_FM_HIT</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OS_FM_TAB_MAX</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span> <span class="o">||</span>
		    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: %s filemark %d at frame pos %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				  <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="o">?</span><span class="s">&quot;Learned&quot;</span><span class="o">:</span><span class="s">&quot;Corrected&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">)</span>
				 <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">OS_FRAME_TYPE_EOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD_1</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">OS_FRAME_TYPE_DATA</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">blk_cnt</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dat</span><span class="p">.</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_cnt</span><span class="p">);</span>
		<span class="n">blk_sz</span>  <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dat</span><span class="p">.</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_sz</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">blk_cnt</span> <span class="o">*</span> <span class="n">blk_sz</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* See what block size was used to write file */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="n">blk_sz</span> <span class="o">&amp;&amp;</span> <span class="n">blk_sz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	    	<span class="s">&quot;%s:I: File was written with block size %d%c, currently %d%c, adjusted to match.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
       				<span class="n">name</span><span class="p">,</span> <span class="n">blk_sz</span><span class="o">&lt;</span><span class="mi">1024</span><span class="o">?</span><span class="n">blk_sz</span><span class="o">:</span><span class="n">blk_sz</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="n">blk_sz</span><span class="o">&lt;</span><span class="mi">1024</span><span class="o">?</span><span class="sc">&#39;b&#39;</span><span class="o">:</span><span class="sc">&#39;k&#39;</span><span class="p">,</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">&lt;</span><span class="mi">1024</span><span class="o">?</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">:</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">&lt;</span><span class="mi">1024</span><span class="o">?</span><span class="sc">&#39;b&#39;</span><span class="o">:</span><span class="sc">&#39;k&#39;</span><span class="p">);</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span>            <span class="o">=</span> <span class="n">blk_sz</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span> <span class="o">=</span> <span class="n">OS_DATA_SIZE</span> <span class="o">/</span> <span class="n">blk_sz</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_seq_num</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span>  <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for the unit to become Ready</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_wait_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initial_delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">startwait</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">int</span>			<span class="n">dbg</span>  <span class="o">=</span> <span class="n">debugging</span><span class="p">;</span>
	<span class="kt">char</span>    	      <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reached onstream wait ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initial_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">initial_delay</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEST_UNIT_READY</span><span class="p">;</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">startwait</span> <span class="o">+</span> <span class="n">timeout</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">((</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span>    <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>    <span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x28</span> <span class="o">&amp;&amp;</span>
		  <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>                                        <span class="p">)</span>  <span class="p">))</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Sleeping in onstream wait ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Turning off debugging for a while</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">debugging</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
<span class="cp">#endif</span>
	    <span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	    <span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	    <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEST_UNIT_READY</span><span class="p">;</span>

	    <span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="n">debugging</span> <span class="o">=</span> <span class="n">dbg</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">&amp;&amp;</span>
	     <span class="n">osst_write_error_recovery</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Abnormal exit from onstream wait ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Result = %d, Sense: 0=%02x, 2=%02x, 12=%02x, 13=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">,</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
<span class="cp">#endif</span>
	    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Normal exit from onstream wait ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for a tape to be inserted in the unit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_wait_for_medium</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">startwait</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">int</span>			<span class="n">dbg</span> <span class="o">=</span> <span class="n">debugging</span><span class="p">;</span>
	<span class="kt">char</span>    	      <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reached onstream wait for medium</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEST_UNIT_READY</span><span class="p">;</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">startwait</span> <span class="o">+</span> <span class="n">timeout</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x3a</span> <span class="o">&amp;&amp;</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>  <span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Sleeping in onstream wait medium</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Turning off debugging for a while</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">debugging</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
<span class="cp">#endif</span>
	    <span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	    <span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	    <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEST_UNIT_READY</span><span class="p">;</span>

	    <span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="n">debugging</span> <span class="o">=</span> <span class="n">dbg</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span>     <span class="o">&amp;&amp;</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
	     <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Abnormal exit from onstream wait medium</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Result = %d, Sense: 0=%02x, 2=%02x, 12=%02x, 13=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">,</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
<span class="cp">#endif</span>
	    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Normal exit from onstream wait medium</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_position_tape_and_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">retval</span><span class="p">;</span>

	<span class="n">osst_wait_ready</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">15</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>			<span class="cm">/* TODO - can this catch a write error? */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
	<span class="n">osst_wait_ready</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">15</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="n">OSST_WAIT_POSITION_COMPLETE</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for write(s) to complete</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_flush_drive_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">delay</span>  <span class="o">=</span> <span class="n">OSST_WAIT_WRITE_COMPLETE</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">char</span>		      <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reached onstream flush drive buffer (write filemark)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_FILEMARKS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">delay</span> <span class="o">=</span> <span class="n">OSST_WAIT_LONG_WRITE_COMPLETE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">osst_write_error_recovery</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="n">osst_wait_ready</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">].</span><span class="n">rw</span> <span class="o">=</span> <span class="n">OS_WRITING_COMPLETE</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define OSST_POLL_PER_SEC 10</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_wait_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">curr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">minlast</span><span class="p">,</span> <span class="kt">int</span> <span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">startwait</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">char</span>	      <span class="o">*</span> <span class="n">name</span>      <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">char</span>	   <span class="n">notyetprinted</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minlast</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">].</span><span class="n">rw</span> <span class="o">!=</span> <span class="n">ST_READING</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:A: Waiting for frame without having initialized read!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span> <span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">startwait</span> <span class="o">+</span> <span class="n">to</span><span class="o">*</span><span class="n">HZ</span><span class="p">))</span>
	<span class="p">{</span> 
		<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">osst_write_error_recovery</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* successful recovery leaves drive ready for frame */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">==</span> <span class="n">curr</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">minlast</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="kt">signed</span><span class="p">)</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)</span><span class="n">curr</span> <span class="o">+</span> <span class="n">minlast</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">minlast</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span> <span class="o">&gt;</span> <span class="n">minlast</span><span class="p">)</span>
		    <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
<span class="cp">#if DEBUG			</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span> <span class="o">||</span> <span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">startwait</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="n">OSST_POLL_PER_SEC</span><span class="p">))</span>
				<span class="n">printk</span> <span class="p">(</span><span class="n">OSST_DEB_MSG</span>
					<span class="s">&quot;%s:D: Succ wait f fr %i (&gt;%i): %i-%i %i (%i): %3li.%li s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">curr</span><span class="o">+</span><span class="n">minlast</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span>
					<span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="p">,</span>
					<span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">jiffies</span><span class="o">-</span><span class="n">startwait</span><span class="p">)</span><span class="o">/</span><span class="n">HZ</span><span class="p">,</span> 
					<span class="p">(((</span><span class="n">jiffies</span><span class="o">-</span><span class="n">startwait</span><span class="p">)</span><span class="o">%</span><span class="n">HZ</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">startwait</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="n">OSST_POLL_PER_SEC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">notyetprinted</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Wait for frame %i (&gt;%i): %i-%i %i (%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">curr</span><span class="o">+</span><span class="n">minlast</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="n">notyetprinted</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">OSST_POLL_PER_SEC</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Fail wait f fr %i (&gt;%i): %i-%i %i: %3li.%li s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">name</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">curr</span><span class="o">+</span><span class="n">minlast</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="p">,</span>
		<span class="p">(</span><span class="n">jiffies</span><span class="o">-</span><span class="n">startwait</span><span class="p">)</span><span class="o">/</span><span class="n">HZ</span><span class="p">,</span> <span class="p">(((</span><span class="n">jiffies</span><span class="o">-</span><span class="n">startwait</span><span class="p">)</span><span class="o">%</span><span class="n">HZ</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>
<span class="cp">#endif	</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_recover_wait_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">writing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   	<span class="n">startwait</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kt">char</span>		      <span class="o">*</span> <span class="n">name</span>      <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
                                                                                                                                
	<span class="k">if</span> <span class="p">(</span><span class="n">writing</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span>	<span class="n">mybuf</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
		<span class="kt">char</span>  <span class="o">*</span> <span class="n">olddata</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
		<span class="kt">int</span>	<span class="n">oldsize</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>

		<span class="cm">/* write zero fm then read pos - if shows write error, try to recover - if no progress, wait */</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_FILEMARKS</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span>
								<span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span> <span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">startwait</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* some failure - not just not-ready */</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">osst_write_error_recovery</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="n">OSST_POLL_PER_SEC</span><span class="p">);</span>

			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">=</span> <span class="n">mybuf</span><span class="p">;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">READ_POSITION</span><span class="p">;</span>

			<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span>
										<span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">||</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">25</span> <span class="p">);</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">=</span> <span class="n">olddata</span><span class="p">;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">oldsize</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Device did not succeed to write buffered data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* TODO - figure out which error conditions can be handled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				<span class="s">&quot;%s:W: Recover_wait_frame(read) cannot handle %02x:%02x:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
					<span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>
					<span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
					<span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the next OnStream tape frame at the current location</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_read_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="n">os_aux_t</span>	      <span class="o">*</span> <span class="n">aux</span>    <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">;</span>
	<span class="kt">char</span>		      <span class="o">*</span> <span class="n">name</span>   <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_wait_frame</span> <span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">osst_recover_wait_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">READ_6</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reading frame from OnStream tape</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">OS_FRAME_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span>
				      <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Recording read error at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span><span class="p">);</span>
<span class="cp">#endif</span>
	    <span class="p">}</span>
<span class="cp">#if DEBUG</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Sense: %2x %2x %2x %2x %2x %2x %2x %2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">name</span><span class="p">,</span>
		   <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		   <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		   <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		   <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">else</span>
	    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
	   <span class="kt">char</span> <span class="n">sig</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		   <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="o">-&gt;</span><span class="n">application_sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">?</span><span class="sc">&#39;^&#39;</span><span class="o">:</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">application_sig</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	   <span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	   <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> 
		<span class="s">&quot;%s:D: AUX: %s UpdFrCt#%d Wpass#%d %s FrSeq#%d LogBlk#%d Qty=%d Sz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">.</span><span class="n">wrt_pass_cntr</span><span class="p">),</span>
			<span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span><span class="o">==</span><span class="mi">1</span><span class="o">?</span><span class="s">&quot;EOD&quot;</span><span class="o">:</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span><span class="o">==</span><span class="mi">2</span><span class="o">?</span><span class="s">&quot;MARK&quot;</span><span class="o">:</span>
			<span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span><span class="o">==</span><span class="mi">8</span><span class="o">?</span><span class="s">&quot;HEADR&quot;</span><span class="o">:</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span><span class="o">==</span><span class="mh">0x80</span><span class="o">?</span><span class="s">&quot;DATA&quot;</span><span class="o">:</span><span class="s">&quot;FILL&quot;</span><span class="p">,</span> 
			<span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_seq_num</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">),</span>
			<span class="n">ntohs</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dat</span><span class="p">.</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_cnt</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dat</span><span class="p">.</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_sz</span><span class="p">)</span> <span class="p">);</span>
	   <span class="k">if</span> <span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: mark_cnt=%d, last_mark_ppos=%d, last_mark_lbn=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span><span class="p">));</span>
	   <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Exit read frame from OnStream tape with code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_initiate_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_partstat</span>    <span class="o">*</span> <span class="n">STps</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span>  <span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span>		      <span class="o">*</span> <span class="n">name</span>   <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">!=</span> <span class="n">ST_READING</span><span class="p">)</span> <span class="p">{</span>         <span class="cm">/* Initialize read operation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span> <span class="o">||</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">=</span> <span class="n">OS_WRITE_DATA</span><span class="p">;</span>
                        <span class="n">osst_flush_write_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
			<span class="n">osst_flush_drive_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_READING</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 *      Issue a read 0 command to get the OnStream drive</span>
<span class="cm">                 *      read frames into its buffer.</span>
<span class="cm">		 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">READ_6</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Start Read Ahead on OnStream tape</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">SRpnt</span>   <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Error starting read ahead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_get_logical_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">frame_seq_number</span><span class="p">,</span> <span class="kt">int</span> <span class="n">quiet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span> <span class="n">STps</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="kt">char</span>		   <span class="o">*</span> <span class="n">name</span>  <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="kt">int</span>		     <span class="n">cnt</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">bad</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">past</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">x</span><span class="p">,</span>
			     <span class="n">position</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we want just any frame (-1) and there is a frame in the buffer, return it</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame_seq_number</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Frame %d still in buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">         * Search and wait for the next logical tape frame</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Couldn&#39;t find logical frame %d, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">name</span><span class="p">,</span> <span class="n">frame_seq_number</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
                        	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Repositioning tape to bad frame %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">abort_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Looking for frame %d, attempt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">name</span><span class="p">,</span> <span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">osst_initiate_read</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">)</span>
                <span class="o">||</span> <span class="p">(</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">osst_read_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="n">position</span> <span class="o">=</span> <span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">position</span> <span class="o">&gt;=</span> <span class="mh">0xbae</span> <span class="o">&amp;&amp;</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="mh">0xbb8</span><span class="p">)</span>
				<span class="n">position</span> <span class="o">=</span> <span class="mh">0xbb8</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">position</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span> <span class="o">||</span> <span class="o">++</span><span class="n">bad</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">position</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">bad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">position</span> <span class="o">+=</span> <span class="mi">29</span><span class="p">;</span>
				<span class="n">cnt</span>      <span class="o">+=</span> <span class="mi">19</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Bad frame detected, positioning tape to block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">name</span><span class="p">,</span> <span class="n">position</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_verify_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">quiet</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_verify_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">quiet</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_seq_num</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_open</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;%s:W: Found logical frame %d instead of %d after fast open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">frame_seq_number</span><span class="p">);</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">frame_seq_number</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">past</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* positioning backwards did not bring us to the desired frame */</span>
					<span class="n">position</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
			        	<span class="n">position</span> <span class="o">=</span> <span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">)</span>
					         <span class="o">+</span> <span class="n">frame_seq_number</span> <span class="o">-</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">&gt;=</span> <span class="mi">3000</span> <span class="o">&amp;&amp;</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="mi">3000</span><span class="p">)</span>
						<span class="n">position</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
				<span class="p">}</span>
<span class="cp">#if DEBUG</span>
                                <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
				       <span class="s">&quot;%s:D: Found logical frame %d while looking for %d: back up %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">frame_seq_number</span><span class="p">,</span>
					       	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>
<span class="cp">#endif</span>
                        	<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">cnt</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">past</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xbaf</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping config partition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mh">0xbb8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_erreg</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:I: Don&#39;t worry, Read error at position %d recovered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
					<span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span><span class="p">);</span>
 	<span class="p">}</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_count</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span> <span class="o">||</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
			<span class="s">&quot;%s:D: Exit get logical frame (%d=&gt;%d) from OnStream tape with code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">,</span> <span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_error_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_seek_logical_blk</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">logical_blk_num</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span> <span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="kt">char</span>		   <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="kt">int</span>	<span class="n">retries</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">frame_seq_estimate</span><span class="p">,</span> <span class="n">ppos_estimate</span><span class="p">,</span> <span class="n">move</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">logical_blk_num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">logical_blk_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Seeking logical block %d (now at %d, size %d%c)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">logical_blk_num</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">,</span> 
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">&lt;</span><span class="mi">1024</span><span class="o">?</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">:</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">&lt;</span><span class="mi">1024</span><span class="o">?</span><span class="sc">&#39;b&#39;</span><span class="o">:</span><span class="sc">&#39;k&#39;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Do we know where we are? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">move</span>                <span class="o">=</span> <span class="n">logical_blk_num</span> <span class="o">-</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">move</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">move</span> <span class="o">-=</span> <span class="p">(</span><span class="n">OS_DATA_SIZE</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">move</span>               <span class="o">/=</span> <span class="p">(</span><span class="n">OS_DATA_SIZE</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
		<span class="n">frame_seq_estimate</span>  <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span> <span class="o">+</span> <span class="n">move</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">frame_seq_estimate</span>  <span class="o">=</span> <span class="n">logical_blk_num</span> <span class="o">*</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">/</span> <span class="n">OS_DATA_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame_seq_estimate</span> <span class="o">&lt;</span> <span class="mi">2980</span><span class="p">)</span> <span class="n">ppos_estimate</span> <span class="o">=</span> <span class="n">frame_seq_estimate</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">else</span>			       <span class="n">ppos_estimate</span> <span class="o">=</span> <span class="n">frame_seq_estimate</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
	   <span class="k">if</span> <span class="p">(</span><span class="n">ppos_estimate</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">frame_seq_estimate</span> <span class="o">+=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">ppos_estimate</span><span class="p">;</span>
	       <span class="n">ppos_estimate</span>       <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	   <span class="p">}</span>
	   <span class="k">if</span> <span class="p">(</span><span class="n">frame_seq_estimate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">frame_seq_estimate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	       <span class="n">ppos_estimate</span>      <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	   <span class="p">}</span>
	   <span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">ppos_estimate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	   <span class="k">if</span> <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">frame_seq_estimate</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	      <span class="cm">/* we&#39;ve located the estimated frame, now does it have our block? */</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">logical_blk_num</span> <span class="o">&lt;</span>  <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">||</span>
	          <span class="n">logical_blk_num</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">+</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dat</span><span class="p">.</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_cnt</span><span class="p">))</span> <span class="p">{</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span>
		    <span class="n">move</span> <span class="o">=</span> <span class="n">logical_blk_num</span> <span class="o">&lt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="o">?</span> <span class="o">-</span><span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		 <span class="k">else</span> <span class="p">{</span>
		    <span class="n">move</span>                <span class="o">=</span> <span class="n">logical_blk_num</span> <span class="o">-</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">;</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">move</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">move</span> <span class="o">-=</span> <span class="p">(</span><span class="n">OS_DATA_SIZE</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		    <span class="n">move</span>               <span class="o">/=</span> <span class="p">(</span><span class="n">OS_DATA_SIZE</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
		 <span class="p">}</span>
		 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">move</span><span class="p">)</span> <span class="n">move</span> <span class="o">=</span> <span class="n">logical_blk_num</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		 <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
			<span class="s">&quot;%s:D: Seek retry %d at ppos %d fsq %d (est %d) lbn %d (need %d) move %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">retries</span><span class="p">,</span> <span class="n">ppos_estimate</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">frame_seq_estimate</span><span class="p">,</span> 
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">,</span> <span class="n">logical_blk_num</span><span class="p">,</span> <span class="n">move</span><span class="p">);</span>
<span class="cp">#endif</span>
		 <span class="n">frame_seq_estimate</span> <span class="o">+=</span> <span class="n">move</span><span class="p">;</span>
		 <span class="n">ppos_estimate</span>      <span class="o">+=</span> <span class="n">move</span><span class="p">;</span>
		 <span class="k">continue</span><span class="p">;</span>
	      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span>  <span class="o">=</span> <span class="p">(</span><span class="n">logical_blk_num</span> <span class="o">-</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">)</span> <span class="o">*</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		 <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">-=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span><span class="p">;</span>
		 <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span>       <span class="o">=</span>  <span class="n">logical_blk_num</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		 <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> 
			<span class="s">&quot;%s:D: Seek success at ppos %d fsq %d in_buf %d, bytes %d, ptr %d*%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">ppos_estimate</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span><span class="p">,</span> 
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">,</span> 
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
<span class="cp">#endif</span>
		 <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">);</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
		     <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
		     <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		     <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span><span class="p">)</span><span class="o">?</span>
					  <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">-</span>
					     <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">?</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span><span class="o">:</span>
					<span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		 <span class="p">}</span>
		 <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span><span class="o">?</span><span class="n">ST_EOD</span><span class="o">:</span><span class="n">ST_NOEOF</span><span class="p">;</span>
		 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="p">}</span>
	   <span class="p">}</span>
	   <span class="k">if</span> <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	      <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	   <span class="cm">/* we are not yet at the estimated frame, adjust our estimate of its physical position */</span>
<span class="cp">#if DEBUG</span>
	   <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Seek retry %d at ppos %d fsq %d (est %d) lbn %d (need %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			   <span class="n">name</span><span class="p">,</span> <span class="n">retries</span><span class="p">,</span> <span class="n">ppos_estimate</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">frame_seq_estimate</span><span class="p">,</span> 
			   <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">,</span> <span class="n">logical_blk_num</span><span class="p">);</span>
<span class="cp">#endif</span>
	   <span class="k">if</span> <span class="p">(</span><span class="n">frame_seq_estimate</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">)</span>
	      <span class="n">ppos_estimate</span> <span class="o">+=</span> <span class="n">frame_seq_estimate</span> <span class="o">-</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">;</span>
	   <span class="k">else</span>
	      <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Couldn&#39;t seek to logical block %d (at %d), %d retries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			    <span class="n">name</span><span class="p">,</span> <span class="n">logical_blk_num</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">,</span> <span class="n">retries</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The values below are based on the OnStream frame payload size of 32K == 2**15,</span>
<span class="cm"> * that is, OSST_FRAME_SHIFT + OSST_SECTOR_SHIFT must be 15. With a minimum block</span>
<span class="cm"> * size of 512 bytes, we need to be able to resolve 32K/512 == 64 == 2**6 positions</span>
<span class="cm"> * inside each frame. Finally, OSST_SECTOR_MASK == 2**OSST_FRAME_SHIFT - 1.</span>
<span class="cm"> */</span>
<span class="cp">#define OSST_FRAME_SHIFT  6</span>
<span class="cp">#define OSST_SECTOR_SHIFT 9</span>
<span class="cp">#define OSST_SECTOR_MASK  0x03F</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_get_sector</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">sector</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">char</span>  <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> 
		<span class="s">&quot;%s:D: Positioned at ppos %d, frame %d, lbn %d, file %d, blk %d, %cptr %d, eof %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">,</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">].</span><span class="n">drv_file</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">].</span><span class="n">drv_block</span><span class="p">,</span> 
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">].</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span><span class="o">?</span><span class="sc">&#39;w&#39;</span><span class="o">:</span><span class="sc">&#39;r&#39;</span><span class="p">,</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">].</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span><span class="o">?</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="o">:</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">].</span><span class="n">eof</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* do we know where we are inside a file? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">].</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">?</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="o">-</span><span class="mi">1</span> <span class="o">:</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">OSST_FRAME_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">].</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span><span class="p">)</span>
		       	<span class="n">sector</span> <span class="o">|=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">&gt;&gt;</span> <span class="n">OSST_SECTOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OSST_SECTOR_MASK</span><span class="p">;</span>
		<span class="k">else</span>
	       		<span class="n">sector</span> <span class="o">|=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">&gt;&gt;</span> <span class="n">OSST_SECTOR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OSST_SECTOR_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sector</span> <span class="o">=</span> <span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sector</span> <span class="o">&lt;&lt;=</span> <span class="n">OSST_FRAME_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sector</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_seek_sector</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span> <span class="n">STps</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="kt">int</span>		     <span class="n">frame</span>  <span class="o">=</span> <span class="n">sector</span> <span class="o">&gt;&gt;</span> <span class="n">OSST_FRAME_SHIFT</span><span class="p">,</span>
			     <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&amp;</span> <span class="n">OSST_SECTOR_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">OSST_SECTOR_SHIFT</span><span class="p">,</span> 
			     <span class="n">r</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">char</span>          <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Seeking sector %d in frame %d at offset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">frame</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">&lt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">offset</span><span class="o">?</span><span class="n">frame</span><span class="o">:</span><span class="n">frame</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">offset</span><span class="o">?</span><span class="n">frame</span><span class="o">+</span><span class="mi">1</span><span class="o">:</span><span class="n">frame</span><span class="p">))</span> <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span>      <span class="o">+=</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span>  <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="o">++</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span>      <span class="o">+=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dat</span><span class="p">.</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_cnt</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span>  <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span><span class="p">)</span><span class="o">?</span>
				    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">-</span>
					<span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">?</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span><span class="o">:</span>
				  <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span>       <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span><span class="o">?</span><span class="n">ST_EOD</span><span class="o">:</span><span class="n">ST_NOEOF</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> 
		<span class="s">&quot;%s:D: Now positioned at ppos %d, frame %d, lbn %d, file %d, blk %d, rptr %d, eof %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">,</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">,</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span><span class="p">,</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read back the drive&#39;s internal buffer contents, as a part</span>
<span class="cm"> * of the write error recovery mechanism for old OnStream</span>
<span class="cm"> * firmware revisions.</span>
<span class="cm"> * Precondition for this function to work: all frames in the</span>
<span class="cm"> * drive&#39;s buffer must be of one type (DATA, MARK or EOD)!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_read_back_buffer_and_rewrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pending</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span> <span class="o">=</span> <span class="o">*</span> <span class="n">aSRpnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	      <span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">flag</span><span class="p">,</span> <span class="n">new_frame</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">nframes</span>          <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">blks_per_frame</span>   <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dat</span><span class="p">.</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_cnt</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">frame_seq_number</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_seq_num</span><span class="p">)</span>
						<span class="o">-</span> <span class="p">(</span><span class="n">nframes</span> <span class="o">+</span> <span class="n">pending</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">logical_blk_num</span>  <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">)</span> 
						<span class="o">-</span> <span class="p">(</span><span class="n">nframes</span> <span class="o">+</span> <span class="n">pending</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">blks_per_frame</span><span class="p">;</span>
	<span class="kt">char</span>		      <span class="o">*</span> <span class="n">name</span>             <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">startwait</span>        <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">int</span>			<span class="n">dbg</span>              <span class="o">=</span> <span class="n">debugging</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">((</span><span class="n">nframes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">OS_DATA_SIZE</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Reading back %d frames from drive buffer%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">name</span><span class="p">,</span> <span class="n">nframes</span><span class="p">,</span> <span class="n">pending</span><span class="o">?</span><span class="s">&quot; and one that was pending&quot;</span><span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">osst_copy_from_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">nframes</span> <span class="o">*</span> <span class="n">OS_DATA_SIZE</span><span class="p">]));</span>
<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;&amp;</span> <span class="n">debugging</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Pending frame %d (lblk %d), data %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">frame_seq_number</span> <span class="o">+</span> <span class="n">nframes</span><span class="p">,</span>
			       	<span class="n">logical_blk_num</span> <span class="o">+</span> <span class="n">nframes</span> <span class="o">*</span> <span class="n">blks_per_frame</span><span class="p">,</span>
			       	<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">OS_DATA_SIZE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3C</span><span class="p">;</span>		<span class="cm">/* Buffer Read           */</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>		<span class="cm">/* Retrieve Faulty Block */</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32768</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32768</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">OS_FRAME_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span>
					    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">||</span> <span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Failed to read frame back from OnStream buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
			<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">osst_copy_from_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Read back logical frame %d, data %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">name</span><span class="p">,</span> <span class="n">frame_seq_number</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>

<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Frames left in buffer: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Write synchronously so we can be sure we&#39;re OK again and don&#39;t have to recover recursively */</span>
	<span class="cm">/* In the header we don&#39;t actually re-write the frames that fail, just the ones after them */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_frame</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nframes</span> <span class="o">+</span> <span class="n">pending</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">==</span> <span class="n">OS_WRITE_HEADER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">i</span> <span class="o">+=</span> <span class="n">skip</span><span class="p">;</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">skip</span> <span class="o">*</span> <span class="n">OS_DATA_SIZE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_frame</span> <span class="o">&lt;</span> <span class="mi">2990</span> <span class="o">&amp;&amp;</span> <span class="n">new_frame</span><span class="o">+</span><span class="n">skip</span><span class="o">+</span><span class="n">nframes</span><span class="o">+</span><span class="n">pending</span> <span class="o">&gt;=</span> <span class="mi">2990</span><span class="p">)</span>
				<span class="n">new_frame</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">-</span><span class="n">i</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">new_frame</span> <span class="o">+=</span> <span class="n">skip</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Position to frame %d, write fseq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">name</span><span class="p">,</span> <span class="n">new_frame</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">frame_seq_number</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">new_frame</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">osst_wait_ready</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">OSST_WAIT_POSITION_COMPLETE</span><span class="p">);</span>
			<span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
			<span class="n">SRpnt</span> <span class="o">=</span> <span class="o">*</span> <span class="n">aSRpnt</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">new_frame</span> <span class="o">&gt;</span> <span class="n">frame</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Failed to find writable tape media</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">nframes</span> <span class="o">+</span> <span class="n">pending</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">osst_copy_to_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * IMPORTANT: for error recovery to work, _never_ queue frames with mixed frame type!</span>
<span class="cm">		 */</span>
		<span class="n">osst_init_aux</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span><span class="p">,</span> <span class="n">frame_seq_number</span><span class="o">+</span><span class="n">i</span><span class="p">,</span>
			       	<span class="n">logical_blk_num</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">blks_per_frame</span><span class="p">,</span>
			       	<span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dat</span><span class="p">.</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_sz</span><span class="p">),</span> <span class="n">blks_per_frame</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_6</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
				<span class="s">&quot;%s:D: About to write frame %d, seq %d, lbn %d, data %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">new_frame</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">frame_seq_number</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">logical_blk_num</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">blks_per_frame</span><span class="p">,</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">OS_FRAME_SIZE</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span>
					    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">OS_DATA_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* if we just sent the last frame, wait till all successfully written */</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nframes</span> <span class="o">+</span> <span class="n">pending</span> <span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Check re-write successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
				<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_FILEMARKS</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span>
							    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Sleeping in re-write wait ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Turning off debugging for a while</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
					<span class="n">debugging</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
<span class="cp">#endif</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span> <span class="o">!</span><span class="n">flag</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">startwait</span> <span class="o">+</span> <span class="mi">60</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

					<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
					<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEST_UNIT_READY</span><span class="p">;</span>

					<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span>
												<span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
					    <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* in the process of becoming ready */</span>
						<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span>
						<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
<span class="cp">#if DEBUG</span>
				<span class="n">debugging</span> <span class="o">=</span> <span class="n">dbg</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Wait re-write finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">13</span> <span class="o">&amp;&amp;</span>
			     <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>         <span class="o">==</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			     <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>         <span class="o">==</span>  <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Volume overflow in write error recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>			<span class="cm">/* hit end of tape = fail */</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>        <span class="p">)</span> <span class="o">-</span> <span class="n">new_frame</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">OS_DATA_SIZE</span><span class="p">];</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Additional write error at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_frame</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: reported frame positions: host = %d, tape = %d, buffer = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* error recovery did not successfully complete */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:D: Write error recovery failed in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">==</span> <span class="n">OS_WRITE_HEADER</span><span class="o">?</span><span class="s">&quot;header&quot;</span><span class="o">:</span><span class="s">&quot;body&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pending</span><span class="p">)</span>
		<span class="n">osst_copy_to_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>	<span class="cm">/* so buffer content == at entry in all cases */</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_reposition_and_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pending</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="kt">char</span>		      <span class="o">*</span> <span class="n">name</span>      <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">expected</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">attempts</span>  <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">skip</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">flag</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">startwait</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">int</span>			<span class="n">dbg</span>       <span class="o">=</span> <span class="n">debugging</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">attempts</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">startwait</span> <span class="o">+</span> <span class="mi">60</span><span class="o">*</span><span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">debugging</span> <span class="o">=</span> <span class="n">dbg</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">2990</span> <span class="o">&amp;&amp;</span> <span class="n">frame</span><span class="o">+</span><span class="n">skip</span><span class="o">+</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="o">+</span><span class="n">pending</span> <span class="o">&gt;=</span> <span class="mi">2990</span><span class="p">)</span>
				<span class="n">frame</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">-</span><span class="n">skip</span><span class="p">;</span>
			<span class="n">expected</span> <span class="o">=</span> <span class="n">frame</span><span class="o">+</span><span class="n">skip</span><span class="o">+</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="o">+</span><span class="n">pending</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Position to fppos %d, re-write from fseq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">name</span><span class="p">,</span> <span class="n">frame</span><span class="o">+</span><span class="n">skip</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="o">-</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="o">-</span><span class="n">pending</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">frame</span> <span class="o">+</span> <span class="n">skip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">attempts</span><span class="o">--</span><span class="p">;</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* additional write error */</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Addl error, host %d, tape %d, buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span>
					  <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">frame</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span><span class="p">;</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_6</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: About to write pending fseq %d at fppos %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">OS_FRAME_SIZE</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span>
						      <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* additional write error */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">13</span> <span class="o">&amp;&amp;</span>
				     <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>         <span class="o">==</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				     <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>         <span class="o">==</span>  <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					       <span class="s">&quot;%s:E: Volume overflow in write error recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">name</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>				<span class="cm">/* hit end of tape = fail */</span>
				<span class="p">}</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">debugging</span> <span class="o">=</span> <span class="n">dbg</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Wait re-write finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:A: Actual position %d - expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
						<span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="n">expected</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Sleeping in re-write wait ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Turning off debugging for a while</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="n">debugging</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Failed to find valid tape media</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
	<span class="n">debugging</span> <span class="o">=</span> <span class="n">dbg</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Error recovery algorithm for the OnStream tape.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_write_error_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pending</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span> <span class="n">SRpnt</span>  <span class="o">=</span> <span class="o">*</span> <span class="n">aSRpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span>  <span class="o">*</span> <span class="n">STps</span>   <span class="o">=</span> <span class="o">&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">];</span>
	<span class="kt">char</span>		    <span class="o">*</span> <span class="n">name</span>   <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="kt">int</span>		      <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		      <span class="n">rw_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	      <span class="n">frame</span><span class="p">,</span> <span class="n">skip</span><span class="p">;</span>

	<span class="n">rw_state</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span>
	  <span class="o">||</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>         <span class="o">!=</span> <span class="mi">12</span>
	  <span class="o">||</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>         <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Write error recovery cannot handle %02x:%02x:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">frame</span> <span class="o">=</span>	<span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">skip</span>  <span class="o">=</span>  <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
 
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Detected physical bad frame at %u, advised to skip %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">skip</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: reported frame positions: host = %d, tape = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span><span class="p">)</span> <span class="p">{</span>
	   <span class="k">case</span> <span class="n">OS_WRITE_DATA</span>:
	   <span class="k">case</span> <span class="n">OS_WRITE_EOD</span>:
	   <span class="k">case</span> <span class="n">OS_WRITE_NEW_MARK</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
			<span class="s">&quot;%s:I: Relocating %d buffered logical frames from position %u to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">frame</span> <span class="o">+</span> <span class="n">skip</span> <span class="o">&gt;</span> <span class="mi">3000</span> <span class="o">&amp;&amp;</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">3000</span><span class="p">)</span><span class="o">?</span><span class="mi">3000</span><span class="o">:</span><span class="n">frame</span> <span class="o">+</span> <span class="n">skip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">os_fw_rev</span> <span class="o">&gt;=</span> <span class="mi">10600</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">osst_reposition_and_retry</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">pending</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">osst_read_back_buffer_and_rewrite</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">pending</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:%s: %sWrite error%srecovered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			       	<span class="n">retval</span><span class="o">?</span><span class="s">&quot;E&quot;</span>    <span class="o">:</span><span class="s">&quot;I&quot;</span><span class="p">,</span>
			       	<span class="n">retval</span><span class="o">?</span><span class="s">&quot;&quot;</span>     <span class="o">:</span><span class="s">&quot;Don&#39;t worry, &quot;</span><span class="p">,</span>
			       	<span class="n">retval</span><span class="o">?</span><span class="s">&quot; not &quot;</span><span class="o">:</span><span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	   <span class="k">case</span> <span class="n">OS_WRITE_LAST_MARK</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Bad frame in update last marker, fatal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">frame</span> <span class="o">+</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span> <span class="o">+</span> <span class="n">pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	   <span class="k">case</span> <span class="n">OS_WRITE_HEADER</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:I: Bad frame in header partition, skipped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">osst_read_back_buffer_and_rewrite</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pending</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	   <span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Bad frame in filler, ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">frame</span> <span class="o">+</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span> <span class="o">+</span> <span class="n">pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Positioning complete, cur_frames %d, pos %d, tape pos %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: next logical frame to write: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_erreg</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">abort_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">rw_state</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_space_over_filemarks_backward</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span>
								 <span class="kt">int</span> <span class="n">mt_op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>  <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="kt">int</span>     <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span>     <span class="n">last_mark_ppos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reached space_over_filemarks_backwards %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mt_op</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Couldn&#39;t get logical blk num in space_filemarks_bwd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * direct lookup in header filemark list</span>
<span class="cm">		 */</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span>                         <span class="o">&amp;&amp;</span> 
		    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">!=</span> <span class="nb">NULL</span>              <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cnt</span> <span class="o">-</span> <span class="n">mt_count</span><span class="p">)</span>  <span class="o">&gt;=</span> <span class="mi">0</span>                 <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cnt</span> <span class="o">-</span> <span class="n">mt_count</span><span class="p">)</span>   <span class="o">&lt;</span> <span class="n">OS_FM_TAB_MAX</span>     <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cnt</span> <span class="o">-</span> <span class="n">mt_count</span><span class="p">)</span>   <span class="o">&lt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span> <span class="o">&amp;&amp;</span>
		    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">[</span><span class="n">cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">)</span>

			<span class="n">last_mark_ppos</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">[</span><span class="n">cnt</span> <span class="o">-</span> <span class="n">mt_count</span><span class="p">]);</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">-</span> <span class="n">mt_count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">-</span> <span class="n">mt_count</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">OS_FM_TAB_MAX</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Filemark lookup fail due to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			       <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="o">?</span><span class="s">&quot;lack of header cache&quot;</span><span class="o">:</span><span class="s">&quot;count out of range&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Filemark lookup: prev mark %d (%s), skip %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span>
				<span class="p">((</span><span class="n">cnt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
				 <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">[</span><span class="n">cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span>
					 <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">))</span><span class="o">?</span><span class="s">&quot;match&quot;</span><span class="o">:</span><span class="s">&quot;error&quot;</span><span class="p">,</span>
			       <span class="n">mt_count</span><span class="p">,</span> <span class="n">last_mark_ppos</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_mark_ppos</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">last_mark_ppos</span> <span class="o">&lt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">osst_position_tape_and_confirm</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">last_mark_ppos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> 
					<span class="s">&quot;%s:D: Couldn&#39;t get logical blk num in space_filemarks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="n">OS_FRAME_TYPE_MARKER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Expected to find marker at ppos %d, not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">name</span><span class="p">,</span> <span class="n">last_mark_ppos</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reverting to scan filemark backwards</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">!=</span> <span class="n">mt_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last_mark_ppos</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_mark_ppos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Positioning to last mark at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">last_mark_ppos</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">osst_position_tape_and_confirm</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">last_mark_ppos</span><span class="p">);</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Couldn&#39;t get logical blk num in space_filemarks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="n">OS_FRAME_TYPE_MARKER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Expected to find marker at ppos %d, not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">name</span><span class="p">,</span> <span class="n">last_mark_ppos</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">found:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSFM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="o">++</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span>     <span class="o">+=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dat</span><span class="p">.</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_cnt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ADRL 1.1 compatible &quot;slow&quot; space filemarks fwd version</span>
<span class="cm"> *</span>
<span class="cm"> * Just scans for the filemark sequentially.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_space_over_filemarks_forward_slow</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span>
								     <span class="kt">int</span> <span class="n">mt_op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">char</span>  <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reached space_over_filemarks_forward_slow %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mt_op</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Couldn&#39;t get logical blk num in space_filemarks_fwd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Couldn&#39;t get logical blk num in space_filemarks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">OS_FRAME_TYPE_MARKER</span><span class="p">)</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">OS_FRAME_TYPE_EOD</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: space_fwd: EOD reached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: EOD position corrected (%d=&gt;%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       	<span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="n">mt_count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTFSF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="o">++</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span>     <span class="o">+=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dat</span><span class="p">.</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_cnt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fast linux specific version of OnStream FSF</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_space_over_filemarks_forward_fast</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span>
								     <span class="kt">int</span> <span class="n">mt_op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>  <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="kt">int</span>	<span class="n">cnt</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">next_mark_ppos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reached space_over_filemarks_forward_fast %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mt_op</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Couldn&#39;t get logical blk num in space_filemarks_fwd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * direct lookup in header filemark list</span>
<span class="cm">		 */</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span>                         <span class="o">&amp;&amp;</span> 
		    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">!=</span> <span class="nb">NULL</span>              <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cnt</span> <span class="o">+</span> <span class="n">mt_count</span><span class="p">)</span>   <span class="o">&lt;</span> <span class="n">OS_FM_TAB_MAX</span>     <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cnt</span> <span class="o">+</span> <span class="n">mt_count</span><span class="p">)</span>   <span class="o">&lt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">cnt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">==</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">)))</span>

			<span class="n">next_mark_ppos</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">[</span><span class="n">cnt</span> <span class="o">+</span> <span class="n">mt_count</span><span class="p">]);</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">+</span> <span class="n">mt_count</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">OS_FM_TAB_MAX</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Filemark lookup fail due to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			       <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="o">?</span><span class="s">&quot;lack of header cache&quot;</span><span class="o">:</span><span class="s">&quot;count out of range&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Filemark lookup: prev mark %d (%s), skip %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">name</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">cnt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">==</span>
					 <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">))</span><span class="o">?</span><span class="s">&quot;match&quot;</span><span class="o">:</span><span class="s">&quot;error&quot;</span><span class="p">,</span>
			       <span class="n">mt_count</span><span class="p">,</span> <span class="n">next_mark_ppos</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next_mark_ppos</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="o">||</span> <span class="n">next_mark_ppos</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reverting to slow filemark space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">return</span> <span class="n">osst_space_over_filemarks_forward_slow</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">mt_op</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">osst_position_tape_and_confirm</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">next_mark_ppos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Couldn&#39;t get logical blk num in space_filemarks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="n">OS_FRAME_TYPE_MARKER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Expected to find marker at ppos %d, not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">name</span><span class="p">,</span> <span class="n">next_mark_ppos</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="n">mt_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Expected to find marker %d at ppos %d, not %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">name</span><span class="p">,</span> <span class="n">cnt</span><span class="o">+</span><span class="n">mt_count</span><span class="p">,</span> <span class="n">next_mark_ppos</span><span class="p">,</span>
						 <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">));</span>
       				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Find nearest (usually previous) marker, then jump from marker to marker</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">OS_FRAME_TYPE_MARKER</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">OS_FRAME_TYPE_EOD</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: space_fwd: EOD reached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_mark_ppos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reverting to slow filemark space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="k">return</span> <span class="n">osst_space_over_filemarks_forward_slow</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">mt_op</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">osst_position_tape_and_confirm</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_mark_ppos</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
					       <span class="s">&quot;%s:D: Couldn&#39;t get logical blk num in space_filemarks_fwd_fast</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="n">OS_FRAME_TYPE_MARKER</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Expected to find filemark at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_mark_ppos</span><span class="p">);</span>
					<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">osst_space_over_filemarks_backward</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">MTBSF</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
				<span class="n">mt_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">!=</span> <span class="n">mt_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next_mark_ppos</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">next_mark_ppos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next_mark_ppos</span> <span class="o">||</span> <span class="n">next_mark_ppos</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reverting to slow filemark space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">return</span> <span class="n">osst_space_over_filemarks_forward_slow</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">mt_op</span><span class="p">,</span> <span class="n">mt_count</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#if DEBUG</span>
			<span class="k">else</span> <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Positioning to next mark at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">next_mark_ppos</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">osst_position_tape_and_confirm</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">next_mark_ppos</span><span class="p">);</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Couldn&#39;t get logical blk num in space_filemarks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="n">OS_FRAME_TYPE_MARKER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Expected to find marker at ppos %d, not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">name</span><span class="p">,</span> <span class="n">next_mark_ppos</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTFSF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="o">++</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span>     <span class="o">+=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">dat</span><span class="p">.</span><span class="n">dat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blk_cnt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * In debug mode, we want to see as many errors as possible</span>
<span class="cm"> * to test the error recovery mechanism.</span>
<span class="cm"> */</span>
<span class="cp">#if DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">osst_set_retries</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span>  <span class="o">=</span> <span class="o">*</span> <span class="n">aSRpnt</span><span class="p">;</span>
	<span class="kt">char</span>		      <span class="o">*</span> <span class="n">name</span>   <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SELECT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">NUMBER_RETRIES_PAGE_LENGTH</span> <span class="o">+</span> <span class="n">MODE_HEADER_LENGTH</span><span class="p">;</span>

	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* Medium Type - ignoring */</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* Reserved */</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* Block Descriptor Length */</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NUMBER_RETRIES_PAGE</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">retries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Setting number of retries on OnStream tape to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">retries</span><span class="p">);</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span>
	    <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:D: Couldn&#39;t set retries to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">retries</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_write_filemark</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">this_mark_ppos</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">this_mark_lbn</span>  <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">char</span>  <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">=</span> <span class="n">OS_WRITE_NEW_MARK</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Writing Filemark %i at fppos %d (fseq %d, lblk %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
	       <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">,</span> <span class="n">this_mark_ppos</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">this_mark_lbn</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">result</span>  <span class="o">=</span> <span class="n">osst_flush_write_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="n">osst_flush_drive_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span> <span class="o">=</span> <span class="n">this_mark_ppos</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span>  <span class="o">=</span> <span class="n">this_mark_lbn</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span> <span class="o">&lt;</span> <span class="n">OS_FM_TAB_MAX</span><span class="p">)</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">this_mark_ppos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_mark_ppos</span> <span class="o">=</span> <span class="n">this_mark_ppos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_write_eod</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">result</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">char</span>  <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">=</span> <span class="n">OS_WRITE_EOD</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Writing EOD at fppos %d (fseq %d, lblk %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">result</span>  <span class="o">=</span> <span class="n">osst_flush_write_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>	
	<span class="n">result</span> <span class="o">|=</span> <span class="n">osst_flush_drive_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_lfa</span> <span class="o">=</span> <span class="o">--</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_write_filler</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reached onstream write filler group %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">osst_wait_ready</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">=</span> <span class="n">OS_WRITE_FILLER</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="s">&quot;Filler&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_flush_write_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Couldn&#39;t write filler frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Exiting onstream write filler group</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">osst_flush_drive_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__osst_write_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="kt">int</span>     <span class="n">result</span><span class="p">;</span>

<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reached onstream write header group %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">osst_wait_ready</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">=</span> <span class="n">OS_WRITE_HEADER</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">osst_copy_to_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">os_header_t</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_flush_write_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Couldn&#39;t write header frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">osst_flush_drive_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Write onstream header group %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="o">?</span><span class="s">&quot;failed&quot;</span><span class="o">:</span><span class="s">&quot;done&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_write_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">locate_eod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">os_header_t</span> <span class="o">*</span> <span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span>	      <span class="n">result</span><span class="p">;</span>
	<span class="kt">char</span>        <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Writing tape header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">os_header_t</span><span class="p">)))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Failed to allocate header cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">os_header_t</span><span class="p">));</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Allocated and cleared memory for header cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span><span class="p">)</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>                <span class="n">STp</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">header</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ident_str</span><span class="p">,</span> <span class="s">&quot;ADR_SEQ&quot;</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">major_rev</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">minor_rev</span>      <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_trk_tb_off</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">17192</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">pt_par_num</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">partition_num</span>              <span class="o">=</span> <span class="n">OS_DATA_PARTITION</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">par_desc_ver</span>               <span class="o">=</span> <span class="n">OS_PARTITION_VERSION</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wrt_pass_cntr</span>              <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">first_frame_ppos</span>           <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">last_frame_ppos</span>            <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">eod_frame_ppos</span>             <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">cfg_col_width</span>                           <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">dat_col_width</span>                           <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">qfa_col_width</span>                           <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">nr_stream_part</span>             <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">et_ent_sz</span>                  <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">dat_ext_trk_ey</span><span class="p">.</span><span class="n">et_part_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">dat_ext_trk_ey</span><span class="p">.</span><span class="n">fmt</span>         <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">dat_ext_trk_ey</span><span class="p">.</span><span class="n">fm_tab_off</span>  <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">17736</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">dat_ext_trk_ey</span><span class="p">.</span><span class="n">last_hlb_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">dat_ext_trk_ey</span><span class="p">.</span><span class="n">last_hlb</span>    <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_lfa</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">dat_ext_trk_ey</span><span class="p">.</span><span class="n">last_pp</span>	<span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_part_num</span>                  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent_sz</span>                <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent_cnt</span>               <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="o">&lt;</span><span class="n">OS_FM_TAB_MAX</span><span class="o">?</span>
								<span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="o">:</span><span class="n">OS_FM_TAB_MAX</span><span class="p">);</span>

	<span class="n">result</span>  <span class="o">=</span> <span class="n">__osst_write_header</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mh">0xbae</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		    <span class="n">osst_write_filler</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mh">0xbb3</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">&amp;=</span> <span class="n">__osst_write_header</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span>     <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">locate_eod</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Locating back to eod frame addr %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Write header failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">application_sig</span><span class="p">,</span> <span class="s">&quot;LIN4&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media</span>         <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span>           <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_reset_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">os_header_t</span><span class="p">));</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span> <span class="o">=</span> <span class="mh">0x0000000A</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_mark_ppos</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">osst_write_header</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__osst_analyze_headers</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>        <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="n">os_header_t</span> <span class="o">*</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">os_aux_t</span>    <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>
	<span class="kt">char</span>          <span class="n">id_string</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span>	      <span class="n">linux_media_version</span><span class="p">,</span>
		      <span class="n">update_frame_cntr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppos</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">ppos</span> <span class="o">==</span> <span class="mh">0xbae</span> <span class="o">||</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Couldn&#39;t position tape</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">osst_wait_ready</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_initiate_read</span> <span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Couldn&#39;t initiate read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osst_read_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">180</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Couldn&#39;t read header frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">os_header_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>	<span class="cm">/* warning: only first segment addressable */</span>
	<span class="n">aux</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="n">OS_FRAME_TYPE_HEADER</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping non-header frame (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_seq_num</span><span class="p">)</span>              <span class="o">!=</span> <span class="mi">0</span>                   <span class="o">||</span>
	    <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">)</span>            <span class="o">!=</span> <span class="mi">0</span>                   <span class="o">||</span>
	          <span class="n">aux</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">.</span><span class="n">partition_num</span>     <span class="o">!=</span> <span class="n">OS_CONFIG_PARTITION</span> <span class="o">||</span>
	    <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">.</span><span class="n">first_frame_ppos</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>                   <span class="o">||</span>
	    <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">.</span><span class="n">last_frame_ppos</span><span class="p">)</span>  <span class="o">!=</span> <span class="mh">0xbb7</span>               <span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Invalid header frame (%d,%d,%d,%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				<span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_seq_num</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">),</span>
			       	<span class="n">aux</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">.</span><span class="n">partition_num</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">.</span><span class="n">first_frame_ppos</span><span class="p">),</span>
			       	<span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">.</span><span class="n">last_frame_ppos</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ident_str</span><span class="p">,</span> <span class="s">&quot;ADR_SEQ&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strncmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ident_str</span><span class="p">,</span> <span class="s">&quot;ADR-SEQ&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">id_string</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">ident_str</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Invalid header identification string %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">id_string</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">update_frame_cntr</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">update_frame_cntr</span> <span class="o">&lt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping frame %d with update_frame_counter %d&lt;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">name</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">update_frame_cntr</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">major_rev</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">minor_rev</span> <span class="o">!=</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: %s revision %d.%d detected (1.4 supported)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				 <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">major_rev</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">minor_rev</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> 
				       <span class="n">header</span><span class="o">-&gt;</span><span class="n">minor_rev</span>  <span class="o">&gt;</span> <span class="mi">4</span> <span class="p">)</span><span class="o">?</span> <span class="s">&quot;Invalid&quot;</span> <span class="o">:</span> <span class="s">&quot;Warning:&quot;</span><span class="p">,</span>
				 <span class="n">header</span><span class="o">-&gt;</span><span class="n">major_rev</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">minor_rev</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">major_rev</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">minor_rev</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">minor_rev</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">pt_par_num</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:W: %d partitions defined, only one supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				 <span class="n">name</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">pt_par_num</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">id_string</span><span class="p">,</span> <span class="n">aux</span><span class="o">-&gt;</span><span class="n">application_sig</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">id_string</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">id_string</span><span class="p">,</span> <span class="s">&quot;LIN&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">linux_media_version</span> <span class="o">=</span> <span class="n">id_string</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">linux_media_version</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Linux media version %d detected (current 4)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">name</span><span class="p">,</span> <span class="n">linux_media_version</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Non Linux media detected (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">id_string</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linux_media_version</span> <span class="o">&lt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping frame %d with linux_media_version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">name</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">linux_media_version</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linux_media_version</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Frame %d sets linux_media_version to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">name</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">linux_media_version</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">application_sig</span><span class="p">,</span> <span class="n">id_string</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span> <span class="o">=</span> <span class="n">linux_media_version</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">update_frame_cntr</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Frame %d sets update_frame_counter to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">name</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">update_frame_cntr</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">os_header_t</span><span class="p">)))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Failed to allocate header cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Allocated memory for header cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="n">osst_copy_from_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="p">);</span>
		<span class="n">header</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="p">;</span>	<span class="cm">/* further accesses from cached (full) copy */</span>

		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span>     <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wrt_pass_cntr</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span>   <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">first_frame_ppos</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span>    <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">eod_frame_ppos</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_lfa</span>     <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">dat_ext_trk_ey</span><span class="p">.</span><span class="n">last_hlb</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span>      <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_mark_ppos</span>   <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">next_mark_ppos</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span>    <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span>     <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span> <span class="o">=</span> <span class="n">update_frame_cntr</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Detected write pass %d, update frame counter %d, filemark counter %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: first data frame on tape = %d, last = %d, eod frame = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			  <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span><span class="p">,</span>
			  <span class="n">ntohl</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">last_frame_ppos</span><span class="p">),</span>
			  <span class="n">ntohl</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">eod_frame_ppos</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: first mark on tape = %d, last = %d, eod frame = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			  <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_mark_ppos</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">minor_rev</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Moving filemark list to ADR 1.4 location</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">,</span> 
			       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">old_filemark_list</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">));</span>
			<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">old_filemark_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">old_filemark_list</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">minor_rev</span> <span class="o">==</span> <span class="mi">4</span>   <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_trk_tb_off</span>                          <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">17192</span><span class="p">)</span>               <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">partition_num</span>              <span class="o">!=</span> <span class="n">OS_DATA_PARTITION</span>          <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">par_desc_ver</span>               <span class="o">!=</span> <span class="n">OS_PARTITION_VERSION</span>       <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">last_frame_ppos</span>            <span class="o">!=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">)</span>       <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">cfg_col_width</span>                           <span class="o">!=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>                  <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">dat_col_width</span>                           <span class="o">!=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">1500</span><span class="p">)</span>                <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">qfa_col_width</span>                           <span class="o">!=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">nr_stream_part</span>             <span class="o">!=</span> <span class="mi">1</span>                          <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">et_ent_sz</span>                  <span class="o">!=</span> <span class="mi">32</span>                         <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">dat_ext_trk_ey</span><span class="p">.</span><span class="n">et_part_num</span> <span class="o">!=</span> <span class="n">OS_DATA_PARTITION</span>          <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">dat_ext_trk_ey</span><span class="p">.</span><span class="n">fmt</span>         <span class="o">!=</span> <span class="mi">1</span>                          <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">dat_ext_trk_ey</span><span class="p">.</span><span class="n">fm_tab_off</span>  <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">17736</span><span class="p">)</span>               <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">dat_ext_trk_ey</span><span class="p">.</span><span class="n">last_hlb_hi</span> <span class="o">!=</span> <span class="mi">0</span>                          <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">ext_track_tb</span><span class="p">.</span><span class="n">dat_ext_trk_ey</span><span class="p">.</span><span class="n">last_pp</span>     <span class="o">!=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_part_num</span>                  <span class="o">!=</span> <span class="n">OS_DATA_PARTITION</span>          <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent_sz</span>                <span class="o">!=</span> <span class="mi">4</span>                          <span class="o">||</span>
		     <span class="n">header</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent_cnt</span>               <span class="o">!=</span>
			     <span class="n">htons</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="o">&lt;</span><span class="n">OS_FM_TAB_MAX</span><span class="o">?</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="o">:</span><span class="n">OS_FM_TAB_MAX</span><span class="p">)))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Failed consistency check ADR 1.4 format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_analyze_headers</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">position</span><span class="p">,</span> <span class="n">ppos</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span>  <span class="o">*</span> <span class="n">name</span>  <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="n">position</span> <span class="o">=</span> <span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">update_frame_cntr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_mark_ppos</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reading header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* optimization for speed - if we are positioned at ppos 10, read second group first  */</span>	
	<span class="cm">/* TODO try the ADR 1.1 locations for the second group if we have no valid one yet... */</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">position</span><span class="o">==</span><span class="mi">10</span><span class="o">?</span><span class="mh">0xbae</span><span class="o">:</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">last</span>  <span class="o">=</span> <span class="n">position</span><span class="o">==</span><span class="mi">10</span><span class="o">?</span><span class="mh">0xbb3</span><span class="o">:</span><span class="mi">10</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ppos</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">ppos</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">;</span> <span class="n">ppos</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__osst_analyze_headers</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">ppos</span><span class="p">))</span>
			<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">position</span><span class="o">==</span><span class="mi">10</span><span class="o">?</span> <span class="mi">5</span><span class="o">:</span><span class="mh">0xbae</span><span class="p">;</span>
	<span class="n">last</span>  <span class="o">=</span> <span class="n">position</span><span class="o">==</span><span class="mi">10</span><span class="o">?</span><span class="mi">10</span><span class="o">:</span><span class="mh">0xbb3</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ppos</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">ppos</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">;</span> <span class="n">ppos</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__osst_analyze_headers</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">ppos</span><span class="p">))</span>
			<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Failed to find valid ADRL header, new media?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">position</span> <span class="o">&lt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">position</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_verify_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">frame_position</span>  <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">frame_seq_numbr</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">logical_blk_num</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">;</span>
       	<span class="kt">int</span>	<span class="n">halfway_frame</span>   <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">read_pointer</span>    <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">prev_mark_ppos</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">actual_mark_ppos</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">char</span>  <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Verify that the tape is really the one we think before writing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">frame_position</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Couldn&#39;t get logical blk num in verify_position</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">n</span><span class="o">=</span><span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="n">frame_position</span><span class="p">)</span>
				<span class="n">prev_mark_ppos</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">prev_mark_ppos</span> <span class="o">=</span> <span class="n">frame_position</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* usually - we don&#39;t really know */</span>
	<span class="n">actual_mark_ppos</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">OS_FRAME_TYPE_MARKER</span> <span class="o">?</span>
				<span class="n">frame_position</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame_position</span>  <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span>                   <span class="o">||</span>
	    <span class="n">frame_seq_numbr</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span> <span class="o">+</span> <span class="p">(</span><span class="n">halfway_frame</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">prev_mark_ppos</span>  <span class="o">!=</span> <span class="n">actual_mark_ppos</span>                            <span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Block mismatch: fppos %d-%d, fseq %d-%d, mark %d-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				  <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="n">frame_position</span><span class="p">,</span> 
				  <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span> <span class="o">+</span> <span class="p">(</span><span class="n">halfway_frame</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span>
				  <span class="n">frame_seq_numbr</span><span class="p">,</span> <span class="n">actual_mark_ppos</span><span class="p">,</span> <span class="n">prev_mark_ppos</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">halfway_frame</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* prepare buffer for append and rewrite on top of original */</span>
		<span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">frame_position</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span>  <span class="o">=</span> <span class="n">read_pointer</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">].</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_WRITING</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span>                 <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span>  <span class="o">=</span> <span class="n">halfway_frame</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span> <span class="o">=</span> <span class="n">frame_seq_numbr</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span>  <span class="o">=</span> <span class="n">logical_blk_num</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Acc. to OnStream, the vers. numbering is the following:</span>
<span class="cm"> * X.XX for released versions (X=digit), </span>
<span class="cm"> * XXXY for unreleased versions (Y=letter)</span>
<span class="cm"> * Ordering 1.05 &lt; 106A &lt; 106B &lt; ...  &lt; 106a &lt; ... &lt; 1.06</span>
<span class="cm"> * This fn makes monoton numbers out of this scheme ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">osst_parse_firmware_rev</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">10000</span>
			<span class="o">+</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span>
			<span class="o">+</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">10000</span>
			<span class="o">+</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span>
			<span class="o">+</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="o">-</span> <span class="mi">100</span>
			<span class="o">+</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;@&#39;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the OnStream SCII tape drive for default operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_configure_onstream</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>                  <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="kt">char</span>                         <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">osst_request</span>          <span class="o">*</span> <span class="n">SRpnt</span> <span class="o">=</span> <span class="o">*</span> <span class="n">aSRpnt</span><span class="p">;</span>
	<span class="n">osst_mode_parameter_header_t</span> <span class="o">*</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">osst_block_size_page_t</span>       <span class="o">*</span> <span class="n">bs</span><span class="p">;</span>
	<span class="n">osst_capabilities_page_t</span>     <span class="o">*</span> <span class="n">cp</span><span class="p">;</span>
	<span class="n">osst_tape_paramtr_page_t</span>     <span class="o">*</span> <span class="n">prm</span><span class="p">;</span>
	<span class="kt">int</span>                            <span class="n">drive_buffer_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Not Ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">os_fw_rev</span> <span class="o">&lt;</span> <span class="mi">10600</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Old OnStream firmware revision detected (%s),</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">);</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: an upgrade to version 1.06 or above is recommended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure 32.5KB (data+aux) frame size.</span>
<span class="cm">         * Get the current frame size from the block size mode page</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SENSE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">BLOCK_SIZE_PAGE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">BLOCK_SIZE_PAGE_LENGTH</span> <span class="o">+</span> <span class="n">MODE_HEADER_LENGTH</span><span class="p">;</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
 	    <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;osst :D: Busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Can&#39;t get tape block size mode page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">osst_mode_parameter_header_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="n">bs</span> <span class="o">=</span> <span class="p">(</span><span class="n">osst_block_size_page_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">osst_mode_parameter_header_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">bdl</span><span class="p">);</span>

<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: 32KB play back: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>   <span class="n">name</span><span class="p">,</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">play32</span>     <span class="o">?</span> <span class="s">&quot;Yes&quot;</span> <span class="o">:</span> <span class="s">&quot;No&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: 32.5KB play back: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">play32_5</span>   <span class="o">?</span> <span class="s">&quot;Yes&quot;</span> <span class="o">:</span> <span class="s">&quot;No&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: 32KB record: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>      <span class="n">name</span><span class="p">,</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">record32</span>   <span class="o">?</span> <span class="s">&quot;Yes&quot;</span> <span class="o">:</span> <span class="s">&quot;No&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: 32.5KB record: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>    <span class="n">name</span><span class="p">,</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">record32_5</span> <span class="o">?</span> <span class="s">&quot;Yes&quot;</span> <span class="o">:</span> <span class="s">&quot;No&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure default auto columns mode, 32.5KB transfer mode</span>
<span class="cm">	 */</span> 
	<span class="n">bs</span><span class="o">-&gt;</span><span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bs</span><span class="o">-&gt;</span><span class="n">play32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bs</span><span class="o">-&gt;</span><span class="n">play32_5</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bs</span><span class="o">-&gt;</span><span class="n">record32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bs</span><span class="o">-&gt;</span><span class="n">record32_5</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SELECT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">BLOCK_SIZE_PAGE_LENGTH</span> <span class="o">+</span> <span class="n">MODE_HEADER_LENGTH</span><span class="p">;</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Couldn&#39;t set tape block size mode page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:D: Drive Block Size changed to 32.5K</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	 <span class="cm">/*</span>
<span class="cm">	 * In debug mode, we want to see as many errors as possible</span>
<span class="cm">	 * to test the error recovery mechanism.</span>
<span class="cm">	 */</span>
	<span class="n">osst_set_retries</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="o">*</span> <span class="n">aSRpnt</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set vendor name to &#39;LIN4&#39; for &quot;Linux support version 4&quot;.</span>
<span class="cm">	 */</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SELECT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">VENDOR_IDENT_PAGE_LENGTH</span> <span class="o">+</span> <span class="n">MODE_HEADER_LENGTH</span><span class="p">;</span>

	<span class="n">header</span><span class="o">-&gt;</span><span class="n">mode_data_length</span> <span class="o">=</span> <span class="n">VENDOR_IDENT_PAGE_LENGTH</span> <span class="o">+</span> <span class="n">MODE_HEADER_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">medium_type</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Medium Type - ignoring */</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">dsp</span>              <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Reserved */</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">bdl</span>              <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Block Descriptor Length */</span>
	
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">VENDOR_IDENT_PAGE</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;L&#39;</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;I&#39;</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;N&#39;</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;4&#39;</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Couldn&#39;t set vendor name to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> 
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SENSE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">CAPABILITIES_PAGE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">CAPABILITIES_PAGE_LENGTH</span> <span class="o">+</span> <span class="n">MODE_HEADER_LENGTH</span><span class="p">;</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Can&#39;t get capabilities page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">osst_mode_parameter_header_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="n">cp</span>     <span class="o">=</span> <span class="p">(</span><span class="n">osst_capabilities_page_t</span>    <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">osst_mode_parameter_header_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">bdl</span><span class="p">);</span>

	<span class="n">drive_buffer_size</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SENSE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">TAPE_PARAMTR_PAGE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">TAPE_PARAMTR_PAGE_LENGTH</span> <span class="o">+</span> <span class="n">MODE_HEADER_LENGTH</span><span class="p">;</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Can&#39;t get tape parameter page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">osst_mode_parameter_header_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="n">prm</span>    <span class="o">=</span> <span class="p">(</span><span class="n">osst_tape_paramtr_page_t</span>    <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">osst_mode_parameter_header_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">bdl</span><span class="p">);</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span>  <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">density</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">segtrk</span><span class="p">)</span> <span class="o">*</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">trks</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Density %d, tape length: %dMB, drive buffer size: %dKB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">/</span> <span class="mi">32</span><span class="p">,</span> <span class="n">drive_buffer_size</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	
<span class="p">}</span>


<span class="cm">/* Step over EOF if it has been inadvertently crossed (ioctl not used because</span>
<span class="cm">   it messes up the block number). */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cross_eof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">forward</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">result</span><span class="p">;</span>
	<span class="kt">char</span>  <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Stepping over filemark %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   			  <span class="n">name</span><span class="p">,</span> <span class="n">forward</span> <span class="o">?</span> <span class="s">&quot;forward&quot;</span> <span class="o">:</span> <span class="s">&quot;backward&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">forward</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/* assumes that the filemark is already read by the drive, so this is low cost */</span>
	   <span class="n">result</span> <span class="o">=</span> <span class="n">osst_space_over_filemarks_forward_slow</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">MTFSF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	   <span class="cm">/* assumes this is only called if we just read the filemark! */</span>
	   <span class="n">result</span> <span class="o">=</span> <span class="n">osst_seek_logical_blk</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	   <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Stepping over filemark %s failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">forward</span> <span class="o">?</span> <span class="s">&quot;forward&quot;</span> <span class="o">:</span> <span class="s">&quot;backward&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Get the tape position. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_get_frame_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">scmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span>    	      <span class="o">*</span> <span class="n">name</span>   <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="cm">/* KG: We want to be able to use it for checking Write Buffer availability</span>
<span class="cm">	 *  and thus don&#39;t want to risk to overwrite anything. Exchange buffers ... */</span>
	<span class="kt">char</span>		<span class="n">mybuf</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
	<span class="kt">char</span>	      <span class="o">*</span> <span class="n">olddata</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">oldsize</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">memset</span> <span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">scmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">READ_POSITION</span><span class="p">;</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">=</span> <span class="n">mybuf</span><span class="p">;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">scmd</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span>
				      <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">=</span> <span class="n">olddata</span><span class="p">;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">oldsize</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* 3: Write Error */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Can&#39;t read tape position.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* re-read position - this needs to preserve media errors */</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mysense</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
			<span class="n">memcpy</span> <span class="p">(</span><span class="n">mysense</span><span class="p">,</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">memset</span> <span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
			<span class="n">scmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">READ_POSITION</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">=</span> <span class="n">mybuf</span><span class="p">;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">scmd</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span>
						    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reread position, reason=[%02x:%02x:%02x], result=[%s%02x:%02x:%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">mysense</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mysense</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">mysense</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="o">?</span><span class="s">&quot;&quot;</span><span class="o">:</span><span class="s">&quot;ok:&quot;</span><span class="p">,</span>
					<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span>
				<span class="n">memcpy</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">mysense</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Double error in get position</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
					  <span class="o">+</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
					  <span class="o">+</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
					  <span class="o">+</span>  <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span>  <span class="o">=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
					  <span class="o">+</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span> <span class="mi">9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
					  <span class="o">+</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span>
					  <span class="o">+</span>  <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span>           <span class="o">=</span>  <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Drive Positions: host %d, tape %d%s, buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
					    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span><span class="p">,</span>
					    <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x80</span><span class="p">)</span><span class="o">?</span><span class="s">&quot; (BOP)&quot;</span><span class="o">:</span>
					    <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x40</span><span class="p">)</span><span class="o">?</span><span class="s">&quot; (EOP)&quot;</span><span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span>
					    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Correcting read position %d, %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
					<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">cur_frames</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">=</span> <span class="n">olddata</span><span class="p">;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">oldsize</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">:</span> <span class="n">result</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Set the tape block */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_set_frame_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ppos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">skip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">scmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span>    <span class="o">*</span> <span class="n">STps</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">pp</span>     <span class="o">=</span> <span class="p">(</span><span class="n">ppos</span> <span class="o">==</span> <span class="mi">3000</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">skip</span><span class="p">)</span><span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ppos</span><span class="p">;</span>
	<span class="kt">char</span>		      <span class="o">*</span> <span class="n">name</span>   <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ppos</span> <span class="o">&gt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Reposition request %d out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">ppos</span> <span class="o">=</span> <span class="n">ppos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Setting ppos to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">memset</span> <span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SEEK_10</span><span class="p">;</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">scmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>  <span class="n">pp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip</span><span class="p">)</span>
			<span class="n">scmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">scmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">long_timeout</span><span class="p">,</span>
								<span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
		<span class="o">*</span><span class="n">aSRpnt</span>  <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: SEEK command from %d to %d failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">!=</span> <span class="n">ppos</span><span class="p">)</span>
			<span class="n">osst_wait_ready</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="n">OSST_WAIT_POSITION_COMPLETE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">pp</span> <span class="o">!=</span> <span class="n">ppos</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ppos</span><span class="p">));</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_frame_position</span> <span class="o">=</span> <span class="n">ppos</span><span class="p">;</span>
	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_write_trailer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">leave_at_EOT</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span> <span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">!=</span> <span class="n">OS_WRITE_NEW_MARK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* true unless the user wrote the filemark for us */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">osst_flush_drive_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">osst_write_filemark</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span> <span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">osst_write_eod</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
	<span class="n">osst_write_header</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">leave_at_EOT</span><span class="p">);</span>

	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_FM</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* osst versions of st functions - augmented and stripped to suit OnStream only */</span>

<span class="cm">/* Flush the write buffer (never need to write if variable blocksize). */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_flush_write_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">offset</span><span class="p">,</span> <span class="n">transfer</span><span class="p">,</span> <span class="n">blks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span> <span class="o">=</span> <span class="o">*</span><span class="n">aSRpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span>    <span class="o">*</span> <span class="n">STps</span><span class="p">;</span>
	<span class="kt">char</span>		      <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">writing</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">==</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_SRpnt</span><span class="p">)</span>
<span class="cp">#if DEBUG</span>
			<span class="p">{</span> <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
	 <span class="s">&quot;%s:D: aSRpnt points to osst_request that write_behind_check will release -- cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
	 <span class="s">&quot;%s:D: aSRpnt does not point to osst_request that write_behind_check will release -- strange</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif	</span>
		<span class="n">osst_write_behind_check</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Async write error (flush) %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">midlevel_result</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">midlevel_result</span> <span class="o">==</span> <span class="n">INT_MAX</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">STps</span>     <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_WRITING</span><span class="p">;</span>
		<span class="n">offset</span>   <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">;</span>
		<span class="n">blks</span>     <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="n">transfer</span> <span class="o">=</span> <span class="n">OS_FRAME_SIZE</span><span class="p">;</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">OS_DATA_SIZE</span><span class="p">)</span>
			<span class="n">osst_zero_buffer_tail</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">osst_wait_frame</span> <span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">osst_recover_wait_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_6</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">switch</span>	<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span><span class="p">)</span> <span class="p">{</span>
		   <span class="k">case</span> <span class="n">OS_WRITE_DATA</span>:
<span class="cp">#if DEBUG</span>
   			<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Writing %d blocks to frame %d, lblks %d-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">blks</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> 
					<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">-</span> <span class="n">blks</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">osst_init_aux</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">OS_FRAME_TYPE_DATA</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="o">++</span><span class="p">,</span>
				      <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">-</span> <span class="n">blks</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">,</span> <span class="n">blks</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		   <span class="k">case</span> <span class="n">OS_WRITE_EOD</span>:
			<span class="n">osst_init_aux</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">OS_FRAME_TYPE_EOD</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="o">++</span><span class="p">,</span>
				      <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		   <span class="k">case</span> <span class="n">OS_WRITE_NEW_MARK</span>:
			<span class="n">osst_init_aux</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">OS_FRAME_TYPE_MARKER</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="o">++</span><span class="p">,</span>
				      <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blks</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		   <span class="k">case</span> <span class="n">OS_WRITE_HEADER</span>:
			<span class="n">osst_init_aux</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">OS_FRAME_TYPE_HEADER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blks</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* probably FILLER */</span>
			<span class="n">osst_init_aux</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">OS_FRAME_TYPE_FILL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Flushing %d bytes, Transferring %d bytes in %d lblocks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  			 <span class="n">name</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">transfer</span><span class="p">,</span> <span class="n">blks</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">transfer</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span>
					      <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
				<span class="s">&quot;%s:D: write sense [0]=0x%02x [2]=%02x [12]=%02x [13]=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				<span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x70</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="cm">/* FIXME - SC-30 drive doesn&#39;t assert EOM bit */</span>
			    <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">NO_SENSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">osst_write_error_recovery</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Error on flush write.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
					<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>		<span class="cm">/* FIXME - even if write recovery succeeds? */</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="o">++</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Exit flush write buffer with code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Flush the tape buffer. The tape will be positioned correctly unless</span>
<span class="cm">   seek_next is true. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seek_next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span> <span class="n">STps</span><span class="p">;</span>
	<span class="kt">int</span>    <span class="n">backspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there was a bus reset, block further access</span>
<span class="cm">	 * to this device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span> <span class="o">||</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Writing */</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">=</span> <span class="n">OS_WRITE_DATA</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">osst_flush_write_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reached flush (read) buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_bsr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">backspace</span> <span class="o">=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">+</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">read_pointer</span><span class="p">)</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">-</span>
			    <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">+</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">-</span> <span class="mi">1</span>        <span class="p">)</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="p">;</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* FIXME is this relevant w. OSST? */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seek_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">cross_eof</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Back over the EOF hit */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">backspace</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* TODO -- design and run a test case for this */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">osst_seek_logical_blk</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">-</span> <span class="n">backspace</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_write_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">synchronous</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">blks</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="kt">char</span>		      <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span> <span class="n">raw</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">==</span> <span class="mh">0xbae</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* _must_ preserve buffer! */</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Reaching config partition.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_flush_drive_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* error recovery may have bumped us past the header partition */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0xbb8</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping over config partition.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">osst_position_tape_and_confirm</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mh">0xbb8</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_wait_frame</span> <span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">osst_recover_wait_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>osst<em>build</em>stats(STp, &amp;SRpnt);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">].</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_WRITING</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span>            <span class="o">=</span> <span class="n">OS_WRITE_DATA</span><span class="p">;</span>
			
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="o">=</span> <span class="n">WRITE_6</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>						<span class="cm">/* one frame at a time... */</span>
	<span class="n">blks</span>     <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Writing %d blocks to frame %d, lblks %d-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">blks</span><span class="p">,</span> 
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">-</span> <span class="n">blks</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">osst_init_aux</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">OS_FRAME_TYPE_DATA</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="o">++</span><span class="p">,</span>
		      <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">-</span> <span class="n">blks</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">,</span> <span class="n">blks</span><span class="p">);</span>

<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">synchronous</span><span class="p">)</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="o">*</span><span class="n">aSRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">OS_FRAME_SIZE</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span>
									<span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="n">synchronous</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synchronous</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Error on write:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x70</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">VOLUME_OVERFLOW</span><span class="p">)</span>
					<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">osst_write_error_recovery</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">aSRpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
					<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Lock or unlock the drive door. Don&#39;t use when struct osst_request allocated. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_door_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">do_lock</span> <span class="o">?</span> <span class="n">SCSI_IOCTL_DOORLOCK</span> <span class="o">:</span> <span class="n">SCSI_IOCTL_DOORUNLOCK</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: %socking drive door.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">),</span> <span class="n">do_lock</span> <span class="o">?</span> <span class="s">&quot;L&quot;</span> <span class="o">:</span> <span class="s">&quot;Unl&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">scsi_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">=</span> <span class="n">do_lock</span> <span class="o">?</span> <span class="n">ST_LOCKED_EXPLICIT</span> <span class="o">:</span> <span class="n">ST_UNLOCKED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">=</span> <span class="n">ST_LOCK_FAILS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set the internal state after reset */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span><span class="n">STps</span><span class="p">;</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
				

<span class="cm">/* Entry points to osst */</span>

<span class="cm">/* Write command */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">osst_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span>		      <span class="n">total</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span>		      <span class="n">i</span><span class="p">,</span> <span class="n">do_count</span><span class="p">,</span> <span class="n">blks</span><span class="p">,</span> <span class="n">transfer</span><span class="p">;</span>
	<span class="kt">int</span>		      <span class="n">write_threshold</span><span class="p">;</span>
	<span class="kt">int</span>		      <span class="n">doing_write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>   <span class="n">__user</span> <span class="o">*</span> <span class="n">b_point</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span> <span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span>   <span class="o">*</span> <span class="n">STm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span>  <span class="o">*</span> <span class="n">STps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_tape</span>    <span class="o">*</span> <span class="n">STp</span>  <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span>		    <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are in the middle of error recovery, don&#39;t let anyone</span>
<span class="cm">	 * else try and use this device.  Also, if error recovery fails, it</span>
<span class="cm">	 * may try and take the device offline, in which case all further</span>
<span class="cm">	 * access to the device is prohibited.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">scsi_block_when_processing_errors</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_NO_TAPE</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">defined</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there was a bus reset, block further access</span>
<span class="cm">	 * to this device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Incorrect device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_prot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write must be integral number of blocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Write (%Zd bytes) not multiple of tape block size (%d%c).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">&lt;</span><span class="mi">1024</span><span class="o">?</span>
				       <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">:</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">&lt;</span><span class="mi">1024</span><span class="o">?</span><span class="sc">&#39;b&#39;</span><span class="o">:</span><span class="sc">&#39;k&#39;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">-</span> <span class="n">OSST_EOM_RESERVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Write truncated at EOM early warning (frame %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">do_auto_lock</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">==</span> <span class="n">ST_UNLOCKED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">do_door_lock</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">=</span> <span class="n">ST_LOCKED_AUTO</span><span class="p">;</span>

	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_READING</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Switching from read to write at file %d, block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> 
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">,</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">osst_flush_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">!=</span> <span class="n">ST_WRITING</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Are we totally rewriting this tape? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">==</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span> <span class="o">&amp;&amp;</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Allocating next write pass counter: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">osst_reset_header</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">);</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Do we know where we&#39;ll be writing on the tape? */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_open</span> <span class="o">&amp;&amp;</span> <span class="n">osst_verify_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">))</span> <span class="o">||</span>
			  		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">==</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* at EOD */</span>
			  		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">;</span>
			  		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* We have no idea where the tape is positioned - give up */</span>
<span class="cp">#if DEBUG</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
						<span class="s">&quot;%s:D: Cannot write at indeterminate position.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
      			<span class="p">}</span>	  
			<span class="k">if</span> <span class="p">((</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">+</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&lt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">;</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span> <span class="o">=</span>
				       	<span class="n">ntohl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">dat_fm_tab</span><span class="p">.</span><span class="n">fm_tab_ent</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					<span class="s">&quot;%s:W: Overwriting file %d with old write pass counter %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">name</span><span class="p">,</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">wrt_pass_cntr</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					<span class="s">&quot;%s:W: may lead to stale data being accepted on reading back!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">name</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
				  <span class="s">&quot;%s:D: resetting filemark count to %d and last mark ppos,lbn to %d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_ppos</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">last_mark_lbn</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Write cannot proceed without valid headers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">writing</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:A: Not supposed to have SRpnt at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">osst_write_behind_check</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Async write error (write) %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">midlevel_result</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">midlevel_result</span> <span class="o">==</span> <span class="n">INT_MAX</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_OK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOM_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOM_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check the buffer readability in cases where copy_user might catch</span>
<span class="cm">		 the problems after some tape movement. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	     <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">write_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span> <span class="o">*</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span><span class="p">)</span>
		<span class="n">write_threshold</span><span class="o">--</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Writing %d bytes to file %d block %d lblk %d fseq %d fppos %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">count</span><span class="p">,</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">,</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span><span class="p">,</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">b_point</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">write_threshold</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">doing_write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">do_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span> <span class="o">*</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">-</span>
			   <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_count</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
			<span class="n">do_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">append_to_buffer</span><span class="p">(</span><span class="n">b_point</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">do_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">blks</span> <span class="o">=</span> <span class="n">do_count</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">+=</span> <span class="n">blks</span><span class="p">;</span>  <span class="cm">/* logical_blk_num is incremented as data is moved from user */</span>
  
		<span class="n">i</span> <span class="o">=</span> <span class="n">osst_write_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">transfer</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">writing</span><span class="p">;</span>	<span class="cm">/* FIXME -- check this logic */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">transfer</span> <span class="o">&lt;=</span> <span class="n">do_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">ppos</span> <span class="o">+=</span> <span class="n">do_count</span> <span class="o">-</span> <span class="n">transfer</span><span class="p">;</span>
				<span class="n">count</span> <span class="o">-=</span> <span class="n">do_count</span> <span class="o">-</span> <span class="n">transfer</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="p">(</span><span class="n">do_count</span> <span class="o">-</span> <span class="n">transfer</span><span class="p">)</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_OK</span><span class="p">;</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>		<span class="cm">/* EOM within current request */</span>
<span class="cp">#if DEBUG</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
				      <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: EOM with %d bytes unwritten.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							     <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">transfer</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_ERROR</span><span class="p">;</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>		<span class="cm">/* Too cautious? */</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>		<span class="cm">/* EOM for old data */</span>
<span class="cp">#if DEBUG</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
				      <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: EOM with lost data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">osst_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
				<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">total</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">total</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">ppos</span> <span class="o">+=</span> <span class="n">do_count</span><span class="p">;</span>
		<span class="n">b_point</span> <span class="o">+=</span> <span class="n">do_count</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">do_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="n">blks</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>  <span class="cm">/* end while write threshold exceeded */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">append_to_buffer</span><span class="p">(</span><span class="n">b_point</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">blks</span> <span class="o">=</span> <span class="n">count</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">+=</span> <span class="n">blks</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">+=</span> <span class="n">blks</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">ppos</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">doing_write</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_threshold</span><span class="p">))</span> <span class="p">{</span> 
		<span class="cm">/* Schedule an asynchronous write */</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">/</span>
					   <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="o">!</span><span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">==</span>
				          <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">osst_write_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>			<span class="cm">/* Prevent releasing this request! */</span>
	<span class="p">}</span>
	<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">osst_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Read command */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">osst_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span>		      <span class="n">total</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span>		      <span class="n">i</span><span class="p">,</span> <span class="n">transfer</span><span class="p">;</span>
	<span class="kt">int</span>		      <span class="n">special</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span>   <span class="o">*</span> <span class="n">STm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span>  <span class="o">*</span> <span class="n">STps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span> <span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_tape</span>    <span class="o">*</span> <span class="n">STp</span>   <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span>		    <span class="o">*</span> <span class="n">name</span>  <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are in the middle of error recovery, don&#39;t let anyone</span>
<span class="cm">	 * else try and use this device.  Also, if error recovery fails, it</span>
<span class="cm">	 * may try and take the device offline, in which case all further</span>
<span class="cm">	 * access to the device is prohibited.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">scsi_block_when_processing_errors</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_NO_TAPE</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">defined</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Incorrect device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Must have initialized medium */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">do_auto_lock</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">==</span> <span class="n">ST_UNLOCKED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">do_door_lock</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">=</span> <span class="n">ST_LOCKED_AUTO</span><span class="p">;</span>

	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">osst_flush_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
		<span class="cm">/* FIXME -- this may leave the tape without EOD and up2date headers */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">%</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		    <span class="s">&quot;%s:W: Read (%Zd bytes) not multiple of tape block size (%d%c).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
		    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">&lt;</span><span class="mi">1024</span><span class="o">?</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">:</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">&lt;</span><span class="mi">1024</span><span class="o">?</span><span class="sc">&#39;b&#39;</span><span class="o">:</span><span class="sc">&#39;k&#39;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span> <span class="o">&amp;&amp;</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">!=</span> <span class="n">ST_NOEOF</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: EOF/EOM flag up (%d). Bytes %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				     <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">,</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	     <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">&gt;=</span> <span class="n">ST_EOD_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">&lt;</span> <span class="n">ST_EOD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>  <span class="cm">/* EOM or Blank Check */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check the buffer writability before any tape movement. Don&#39;t alter</span>
<span class="cm">		 buffer data. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>             <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">copy_to_user</span>  <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>             <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">copy_to_user</span>  <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Loop until enough data in buffer or a special condition found */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">special</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">-</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">special</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Get new data if the buffer is empty */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">special</span> <span class="o">=</span> <span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">special</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 			<span class="cm">/* No need to continue read */</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">special</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Move the data from driver buffer to user buffer */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span> <span class="o">&amp;&amp;</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">!=</span> <span class="n">ST_NOEOF</span><span class="p">)</span>
			    <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: EOF up (%d). Left %d, needed %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
						 <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">,</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">total</span><span class="p">));</span>
<span class="cp">#endif</span>
		       	<span class="cm">/* force multiple of block size, note block_size may have been adjusted */</span>
			<span class="n">transfer</span> <span class="o">=</span> <span class="p">(((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">-</span> <span class="n">total</span> <span class="o">?</span>
				     <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">:</span> <span class="n">count</span> <span class="o">-</span> <span class="n">total</span><span class="p">)</span><span class="o">/</span>
					<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">transfer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				  <span class="s">&quot;%s:W: Nothing can be transferred, requested %Zd, tape block size (%d%c).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   		<span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="o">?</span>
					<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">:</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span>
				       	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="o">&lt;</span><span class="mi">1024</span><span class="o">?</span><span class="sc">&#39;b&#39;</span><span class="o">:</span><span class="sc">&#39;k&#39;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">from_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">transfer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">+=</span> <span class="n">transfer</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span>      <span class="o">+=</span> <span class="n">transfer</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ppos</span>          <span class="o">+=</span> <span class="n">transfer</span><span class="p">;</span>
			<span class="n">buf</span>                  <span class="o">+=</span> <span class="n">transfer</span><span class="p">;</span>
			<span class="n">total</span>                <span class="o">+=</span> <span class="n">transfer</span><span class="p">;</span>
		<span class="p">}</span>
 
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Finished with frame %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       	<span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="o">++</span><span class="p">;</span>              <span class="cm">/* frame to look for next time */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* for (total = 0, special = 0; total &lt; count &amp;&amp; !special; ) */</span>

	<span class="cm">/* Change the eof state if no data from tape or buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span><span class="o">?</span><span class="n">ST_EOD_2</span><span class="o">:</span><span class="n">ST_FM</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOD_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD_2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOD_2</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM</span><span class="p">)</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">osst_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Set the driver options */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">osst_log_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span><span class="n">STm</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
<span class="s">&quot;%s:I: Mode %d options: buffer writes: %d, async writes: %d, read ahead: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span><span class="p">,</span>
	 <span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_read_ahead</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
<span class="s">&quot;%s:I:    can bsr: %d, two FMs: %d, fast mteom: %d, auto lock: %d,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_bsr</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">two_fm</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_mteom</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">do_auto_lock</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
<span class="s">&quot;%s:I:    defs for wr: %d, no block limits: %d, partitions: %d, s2 log: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">name</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">defaults_for_writes</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">omit_blklims</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span><span class="p">,</span>
	 <span class="n">STp</span><span class="o">-&gt;</span><span class="n">scsi2_logical</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
<span class="s">&quot;%s:I:    sysv: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">sysv</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	 <span class="s">&quot;%s:D:    debugging: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">name</span><span class="p">,</span> <span class="n">debugging</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_set_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">long</span> <span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		    <span class="n">value</span><span class="p">;</span>
	<span class="kt">long</span>		    <span class="n">code</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span> <span class="o">*</span> <span class="n">STm</span><span class="p">;</span>
	<span class="kt">char</span>		  <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">defined</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">STm</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">STm</span><span class="p">));</span>
		<span class="n">modes_defined</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Initialized mode %d definition from mode 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">code</span> <span class="o">=</span> <span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_OPTIONS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_BOOLEANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_BUFFER_WRITES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span>  <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_ASYNC_WRITES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">defaults_for_writes</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_DEF_WRITES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_read_ahead</span>    <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_READ_AHEAD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">two_fm</span>	      <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_TWO_FM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_mteom</span>	      <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_FAST_MTEOM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">do_auto_lock</span>     <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_AUTO_LOCK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_bsr</span>          <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_CAN_BSR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">omit_blklims</span>     <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_NO_BLKLIMS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&gt;=</span> <span class="n">SCSI_2</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_CAN_PARTITIONS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">scsi2_logical</span>    <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_SCSI2LOGICAL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">sysv</span>	      <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_SYSV</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		<span class="n">debugging</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_DEBUGGING</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">osst_log_options</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">STm</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_SETBOOLEANS</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_CLEARBOOLEANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_SETBOOLEANS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_BUFFER_WRITES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_ASYNC_WRITES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_DEF_WRITES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">defaults_for_writes</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_READ_AHEAD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_read_ahead</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_TWO_FM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">two_fm</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_FAST_MTEOM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_mteom</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_AUTO_LOCK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">do_auto_lock</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_CAN_BSR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_bsr</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_NO_BLKLIMS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">omit_blklims</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&gt;=</span> <span class="n">SCSI_2</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_CAN_PARTITIONS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_SCSI2LOGICAL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">scsi2_logical</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_SYSV</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">sysv</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_DEBUGGING</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">debugging</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">osst_log_options</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">STm</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_WRITE_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MT_ST_OPTIONS</span><span class="p">)</span> <span class="o">*</span> <span class="n">ST_KILOBYTE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">osst_buffer_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Write threshold %d too small or too large.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_threshold</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Write threshold set to %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_DEF_BLKSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MT_ST_OPTIONS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="o">~</span><span class="n">MT_ST_OPTIONS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Default block size disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">512</span> <span class="o">||</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">OS_DATA_SIZE</span> <span class="o">||</span> <span class="n">OS_DATA_SIZE</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Default block size cannot be set to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Default block size set to %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">name</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_TIMEOUTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MT_ST_OPTIONS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">MT_ST_SET_LONG_TIMEOUT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">long_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MT_ST_SET_LONG_TIMEOUT</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Long timeout set to %d seconds.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
					     <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MT_ST_SET_LONG_TIMEOUT</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Normal timeout set to %d seconds.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_DEF_OPTIONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MT_ST_CLEAR_DEFAULT</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MT_ST_CLEAR_DEFAULT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_DEF_DENSITY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">MT_ST_CLEAR_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Density default disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Density default set to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">name</span><span class="p">,</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_DEF_DRVBUFFER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">MT_ST_CLEAR_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">default_drvbuffer</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Drive buffer default disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">default_drvbuffer</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Drive buffer default set to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">default_drvbuffer</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">MT_ST_DEF_COMPRESSION</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">MT_ST_CLEAR_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_compression</span> <span class="o">=</span> <span class="n">ST_DONT_TOUCH</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Compression default disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_compression</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">ST_YES</span> <span class="o">:</span> <span class="n">ST_NO</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Compression default set to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Internal ioctl function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_int_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_request</span> <span class="o">**</span> <span class="n">aSRpnt</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">timeout</span><span class="p">;</span>
	<span class="kt">long</span>			<span class="n">ltmp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">,</span> <span class="n">ioctl_result</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">chg_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osst_request</span>   <span class="o">*</span> <span class="n">SRpnt</span> <span class="o">=</span> <span class="o">*</span> <span class="n">aSRpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span>    <span class="o">*</span> <span class="n">STps</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">fileno</span><span class="p">,</span> <span class="n">blkno</span><span class="p">,</span> <span class="n">at_sm</span><span class="p">,</span> <span class="n">frame_seq_numbr</span><span class="p">,</span> <span class="n">logical_blk_num</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">datalen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_NONE</span><span class="p">;</span>
	<span class="kt">char</span>		      <span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">!=</span> <span class="n">ST_READY</span> <span class="o">&amp;&amp;</span> <span class="n">cmd_in</span> <span class="o">!=</span> <span class="n">MTLOAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_NO_TAPE</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">long_timeout</span><span class="p">;</span>
	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="n">fileno</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">;</span>
	<span class="n">blkno</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span><span class="p">;</span>
	<span class="n">at_sm</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span><span class="p">;</span>
	<span class="n">frame_seq_numbr</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">;</span>
	<span class="n">logical_blk_num</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_in</span><span class="p">)</span> <span class="p">{</span>
	 <span class="k">case</span> <span class="n">MTFSFM</span>:
		<span class="n">chg_eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Changed from the FSF after this */</span>
	 <span class="k">case</span> <span class="n">MTFSF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span>
		   <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media</span><span class="p">)</span>
		   <span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">osst_space_over_filemarks_forward_fast</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">else</span>
		   <span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">osst_space_over_filemarks_forward_slow</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fileno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		   <span class="n">fileno</span> <span class="o">+=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">blkno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">at_sm</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">os_bypass</span><span class="p">;</span>

	 <span class="k">case</span> <span class="n">MTBSF</span>:
		<span class="n">chg_eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Changed from the FSF after this */</span>
	 <span class="k">case</span> <span class="n">MTBSFM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span>
		   <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">osst_space_over_filemarks_backward</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fileno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		   <span class="n">fileno</span> <span class="o">-=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">blkno</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>  <span class="cm">/* We can&#39;t know the block number */</span>
		<span class="n">at_sm</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">os_bypass</span><span class="p">;</span>

	 <span class="k">case</span> <span class="n">MTFSR</span>:
	 <span class="k">case</span> <span class="n">MTBSR</span>:
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
		   <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Skipping %lu blocks %s from logical block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cmd_in</span><span class="o">==</span><span class="n">MTFSR</span><span class="o">?</span><span class="s">&quot;forward&quot;</span><span class="o">:</span><span class="s">&quot;backward&quot;</span><span class="p">,</span> <span class="n">logical_blk_num</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTFSR</span><span class="p">)</span> <span class="p">{</span>
		   <span class="n">logical_blk_num</span> <span class="o">+=</span> <span class="n">arg</span><span class="p">;</span>
		   <span class="k">if</span> <span class="p">(</span><span class="n">blkno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">blkno</span> <span class="o">+=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
		   <span class="n">logical_blk_num</span> <span class="o">-=</span> <span class="n">arg</span><span class="p">;</span>
		   <span class="k">if</span> <span class="p">(</span><span class="n">blkno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">blkno</span> <span class="o">-=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">osst_seek_logical_blk</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">logical_blk_num</span><span class="p">);</span>
		<span class="n">fileno</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">;</span>
		<span class="n">blkno</span>  <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span><span class="p">;</span>
		<span class="n">at_sm</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">os_bypass</span><span class="p">;</span>

	 <span class="k">case</span> <span class="n">MTFSS</span>:
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* Space Setmarks */</span>   <span class="cm">/* FIXME -- OS can&#39;t do this? */</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Spacing tape forward %d setmarks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">65536</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blkno</span> <span class="o">=</span> <span class="n">fileno</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">at_sm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	 <span class="k">case</span> <span class="n">MTBSS</span>:
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* Space Setmarks */</span>   <span class="cm">/* FIXME -- OS can&#39;t do this? */</span>
		<span class="n">ltmp</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ltmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ltmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ltmp</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			   <span class="n">ltmp</span> <span class="o">=</span> <span class="mh">0xff000000</span><span class="p">;</span>
			<span class="n">ltmp</span> <span class="o">=</span> <span class="n">ltmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Spacing tape backward %ld setmarks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">ltmp</span><span class="p">));</span>
		 <span class="p">}</span>
<span class="cp">#endif</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blkno</span> <span class="o">=</span> <span class="n">fileno</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">at_sm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		 <span class="p">}</span>
		 <span class="k">break</span><span class="p">;</span>
	 <span class="k">case</span> <span class="n">MTWEOF</span>:
		 <span class="k">if</span> <span class="p">((</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span> <span class="o">||</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">=</span> <span class="n">OS_WRITE_DATA</span><span class="p">;</span>
			<span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">osst_flush_write_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">);</span>
		 <span class="p">}</span> <span class="k">else</span>
			<span class="n">ioctl_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> 
			   <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Writing %ld filemark(s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="cp">#endif</span>
		 <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">arg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ioctl_result</span> <span class="o">|=</span> <span class="n">osst_write_filemark</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">);</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">fileno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">fileno</span> <span class="o">+=</span> <span class="n">arg</span><span class="p">;</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">blkno</span>  <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">blkno</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 <span class="k">goto</span> <span class="n">os_bypass</span><span class="p">;</span>

	 <span class="k">case</span> <span class="n">MTWSM</span>:
		 <span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_prot</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
		 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		 <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_FILEMARKS</span><span class="p">;</span>   <span class="cm">/* FIXME -- need OS version */</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTWSM</span><span class="p">)</span>
			 <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		 <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		 <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		 <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		 <span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> 
			   <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Writing %d setmark(s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				  <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">65536</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="cp">#endif</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">fileno</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fileno</span> <span class="o">+=</span> <span class="n">arg</span><span class="p">;</span>
		 <span class="n">blkno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 <span class="n">at_sm</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTWSM</span><span class="p">);</span>
		 <span class="k">break</span><span class="p">;</span>
	 <span class="k">case</span> <span class="n">MTOFFL</span>:
	 <span class="k">case</span> <span class="n">MTLOAD</span>:
	 <span class="k">case</span> <span class="n">MTUNLOAD</span>:
	 <span class="k">case</span> <span class="n">MTRETEN</span>:
		 <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">START_STOP</span><span class="p">;</span>
		 <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>			<span class="cm">/* Don&#39;t wait for completion */</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTLOAD</span><span class="p">)</span> <span class="p">{</span>
		     <span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_NO_TAPE</span><span class="p">)</span>
			 <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>		<span class="cm">/* open tray */</span>
		      <span class="k">else</span>
			 <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* load */</span>
		 <span class="p">}</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTRETEN</span><span class="p">)</span>
			 <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* retension then mount */</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTOFFL</span><span class="p">)</span>
			 <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>		<span class="cm">/* rewind then eject */</span>
		 <span class="n">timeout</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
			 <span class="k">switch</span> <span class="p">(</span><span class="n">cmd_in</span><span class="p">)</span> <span class="p">{</span>
				 <span class="k">case</span> <span class="n">MTUNLOAD</span>:
					 <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Unloading tape.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
					 <span class="k">break</span><span class="p">;</span>
				 <span class="k">case</span> <span class="n">MTLOAD</span>:
					 <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Loading tape.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
					 <span class="k">break</span><span class="p">;</span>
				 <span class="k">case</span> <span class="n">MTRETEN</span>:
					 <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Retensioning tape.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
					 <span class="k">break</span><span class="p">;</span>
				 <span class="k">case</span> <span class="n">MTOFFL</span>:
					 <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Ejecting tape.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
					 <span class="k">break</span><span class="p">;</span>
			 <span class="p">}</span>
		 <span class="p">}</span>
<span class="cp">#endif</span>
       <span class="n">fileno</span> <span class="o">=</span> <span class="n">blkno</span> <span class="o">=</span> <span class="n">at_sm</span> <span class="o">=</span> <span class="n">frame_seq_numbr</span> <span class="o">=</span> <span class="n">logical_blk_num</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		 <span class="k">break</span><span class="p">;</span>
	 <span class="k">case</span> <span class="n">MTNOP</span>:
<span class="cp">#if DEBUG</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
			 <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: No-op on tape.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Should do something ? */</span>
		 <span class="k">break</span><span class="p">;</span>
	 <span class="k">case</span> <span class="n">MTEOM</span>:
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
		   <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Spacing to end of recorded medium.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">osst_position_tape_and_confirm</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">osst_get_logical_frame</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>               <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		   <span class="n">ioctl_result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		   <span class="k">goto</span> <span class="n">os_bypass</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">frame_type</span> <span class="o">!=</span> <span class="n">OS_FRAME_TYPE_EOD</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		   <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: No EOD frame found where expected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		   <span class="n">ioctl_result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		   <span class="k">goto</span> <span class="n">os_bypass</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">fileno</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">;</span>
		<span class="n">blkno</span>  <span class="o">=</span> <span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">os_bypass</span><span class="p">;</span>

	 <span class="k">case</span> <span class="n">MTERASE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_prot</span><span class="p">)</span>
		   <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
		<span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">osst_reset_header</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">osst_write_eod</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioctl_result</span><span class="p">)</span> <span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">osst_position_tape_and_confirm</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioctl_result</span><span class="p">)</span> <span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">fileno</span> <span class="o">=</span> <span class="n">blkno</span> <span class="o">=</span> <span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">goto</span> <span class="n">os_bypass</span><span class="p">;</span>

	 <span class="k">case</span> <span class="n">MTREW</span>:
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REZERO_UNIT</span><span class="p">;</span> <span class="cm">/* rewind */</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
		   <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Rewinding tape, Immed=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="n">fileno</span> <span class="o">=</span> <span class="n">blkno</span> <span class="o">=</span> <span class="n">at_sm</span> <span class="o">=</span> <span class="n">frame_seq_numbr</span> <span class="o">=</span> <span class="n">logical_blk_num</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	 <span class="k">case</span> <span class="n">MTSETBLK</span>:           <span class="cm">/* Set block length */</span>
		 <span class="k">if</span> <span class="p">((</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>			  <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span>				  <span class="o">&amp;&amp;</span>
		     <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		  <span class="o">&amp;&amp;</span>
		     <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">512</span> <span class="p">)</span>	  <span class="o">&amp;&amp;</span> 
		     <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">OS_DATA_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="p">(</span><span class="n">OS_DATA_SIZE</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">))</span>  <span class="p">)</span> <span class="p">{</span>
			 <span class="cm">/*</span>
<span class="cm">			  * Only allowed to change the block size if you opened the</span>
<span class="cm">			  * device at the beginning of a file before writing anything.</span>
<span class="cm">			  * Note, that when reading, changing block_size is futile,</span>
<span class="cm">			  * as the size used when writing overrides it.</span>
<span class="cm">			  */</span>
			 <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">);</span>
			 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Block size set to %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
			 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		 <span class="p">}</span>
	 <span class="k">case</span> <span class="n">MTSETDENSITY</span>:       <span class="cm">/* Set tape density */</span>
	 <span class="k">case</span> <span class="n">MTSETDRVBUFFER</span>:     <span class="cm">/* Set drive buffering */</span>
	 <span class="k">case</span> <span class="n">SET_DENS_AND_BLK</span>:   <span class="cm">/* Set density and block size */</span>
		 <span class="n">chg_eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">||</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			 <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>       <span class="cm">/* Not allowed if data in buffer */</span>
		 <span class="k">if</span> <span class="p">((</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTSETBLK</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">SET_DENS_AND_BLK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>                    <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span>       <span class="p">)</span> <span class="p">{</span>
			 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: Illegal to set block size to %d%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">),</span>
						<span class="p">(</span><span class="n">OS_DATA_SIZE</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">))</span><span class="o">?</span><span class="s">&quot;&quot;</span><span class="o">:</span><span class="s">&quot; now&quot;</span><span class="p">);</span>
			 <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		 <span class="p">}</span>
		 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* FIXME silently ignore if block size didn&#39;t change */</span>

	 <span class="nl">default:</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSYS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ioctl_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Couldn&#39;t exec scsi cmd for IOCTL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">ioctl_result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioctl_result</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* SCSI command successful */</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span> <span class="o">=</span> <span class="n">frame_seq_numbr</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span>  <span class="o">=</span> <span class="n">logical_blk_num</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">os_bypass:</span>
<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: IOCTL (%d) Result=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="n">ioctl_result</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioctl_result</span><span class="p">)</span> <span class="p">{</span>				<span class="cm">/* success */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTFSFM</span><span class="p">)</span> <span class="p">{</span>
			 <span class="n">fileno</span><span class="o">--</span><span class="p">;</span>
			 <span class="n">blkno</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTBSFM</span><span class="p">)</span> <span class="p">{</span>
			 <span class="n">fileno</span><span class="o">++</span><span class="p">;</span>
			 <span class="n">blkno</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">blkno</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">fileno</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="n">at_sm</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTEOM</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTFSFM</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTBSF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">osst_seek_logical_blk</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span><span class="o">++</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="o">++</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="o">++</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTFSF</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span><span class="o">?</span><span class="n">ST_EOD</span><span class="o">:</span><span class="n">ST_FM</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chg_eof</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTOFFL</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTUNLOAD</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">rew_at_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTLOAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
			    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_block_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="cm">/* FIXME - where else is this field maintained? */</span>
			<span class="p">}</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTREW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">osst_position_tape_and_confirm</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span><span class="p">);</span> 
			<span class="k">if</span> <span class="p">(</span><span class="n">ioctl_result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ioctl_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTBSF</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTBSFM</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_position_tape_and_confirm</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTFSF</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTFSFM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osst_position_tape_and_confirm</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span>  <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTBSR</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTFSR</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTWEOF</span> <span class="o">||</span> <span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTEOM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTERASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* SCSI command was not completely successful. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOM_OK</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chg_eof</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">BLANK_CHECK</span><span class="p">)</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_EOD</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in</span> <span class="o">==</span> <span class="n">MTLOAD</span> <span class="o">&amp;&amp;</span> <span class="n">osst_wait_for_medium</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
			<span class="n">ioctl_result</span> <span class="o">=</span> <span class="n">osst_wait_ready</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="n">OSST_WAIT_POSITION_COMPLETE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">aSRpnt</span> <span class="o">=</span> <span class="n">SRpnt</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ioctl_result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Open the device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__os_scsi_tape_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span> <span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	      <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		      <span class="n">i</span><span class="p">,</span> <span class="n">b_size</span><span class="p">,</span> <span class="n">new_session</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	      <span class="n">cmd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span> <span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_tape</span>    <span class="o">*</span> <span class="n">STp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span>   <span class="o">*</span> <span class="n">STm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span>  <span class="o">*</span> <span class="n">STps</span><span class="p">;</span>
	<span class="kt">char</span>		    <span class="o">*</span> <span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span>		      <span class="n">dev</span>  <span class="o">=</span> <span class="n">TAPE_NR</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span>		      <span class="n">mode</span> <span class="o">=</span> <span class="n">TAPE_MODE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We really want to do nonseekable_open(inode, filp); here, but some</span>
<span class="cm">	 * versions of tar incorrectly call lseek on tapes and bail out if that</span>
<span class="cm">	 * fails.  So we disallow pread() and pwrite(), but permit lseeks.</span>
<span class="cm">	 */</span>
	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FMODE_PREAD</span> <span class="o">|</span> <span class="n">FMODE_PWRITE</span><span class="p">);</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">osst_max_dev</span> <span class="o">||</span> <span class="n">os_scsi_tapes</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">STp</span> <span class="o">=</span> <span class="n">os_scsi_tapes</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">name</span> <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Device already in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_device_get</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Failed scsi_device_get.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">STp</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">rew_at_close</span> <span class="o">=</span> <span class="n">TAPE_REWIND</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">scsi_block_when_processing_errors</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Mode change from %d to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">new_session</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_prot</span> <span class="o">=</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">O_RDONLY</span><span class="p">);</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span> <span class="o">=</span> <span class="n">TAPE_IS_RAW</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allocate data segments for this device&#39;s tape buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enlarge_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">restr_dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:E: Unable to allocate memory segments for tape buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">&gt;=</span> <span class="n">OS_FRAME_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
		     <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">b_size</span> <span class="o">+</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">OS_DATA_SIZE</span><span class="p">);</span> 
		     <span class="n">b_size</span> <span class="o">+=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="n">os_aux_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">+</span> <span class="n">OS_DATA_SIZE</span> <span class="o">-</span> <span class="n">b_size</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: b_data points to %p in segment 0 at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">page_address</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">page</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: AUX points to %p in segment %d at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			 <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">page_address</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aux</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* this had better never happen! */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s:A: Framesize %d too large for buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">OS_FRAME_SIZE</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">writing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="n">ST_READY</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_waits</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_finished</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">memset</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEST_UNIT_READY</span><span class="p">;</span>

	<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SRpnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span><span class="p">;</span>		<span class="cm">/* FIXME - valid? */</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x70</span>      <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOT_READY</span> <span class="o">&amp;&amp;</span>
	     <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>        <span class="o">==</span> <span class="mi">4</span>         <span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Unit not ready, cause %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* initialize command required (LOAD) */</span>
			<span class="n">memset</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
        		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">START_STOP</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span>
					     <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">osst_wait_ready</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="o">?</span><span class="mi">15</span><span class="o">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x70</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">UNIT_ATTENTION</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* New media? */</span>
<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Unit wants attention</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">memset</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEST_UNIT_READY</span><span class="p">;</span>

			<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span>
					     <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x70</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">UNIT_ATTENTION</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span><span class="p">)</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* This guess will be updated later if necessary */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>		<span class="cm">/* FIXME - seems to be redundant... */</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">new_session</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">abort_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * if we have valid headers from before, and the drive/tape seem untouched,</span>
<span class="cm">	 * open without reconfiguring and re-reading the headers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SENSE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">VENDOR_IDENT_PAGE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">VENDOR_IDENT_PAGE_LENGTH</span> <span class="o">+</span> <span class="n">MODE_HEADER_LENGTH</span><span class="p">;</span>

		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">syscall_result</span>                     <span class="o">||</span>
		    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;L&#39;</span> <span class="o">||</span>
		    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span>
		    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;N&#39;</span> <span class="o">||</span>
		    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;4&#39;</span>  <span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Signature was changed to %c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			  <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span>
			  <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">],</span>
			  <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">4</span><span class="p">],</span>
			  <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]);</span>
<span class="cp">#endif</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">==</span> <span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">==</span> <span class="n">ST_UNLOCKED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">do_door_lock</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Can&#39;t lock drive door</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">=</span> <span class="n">ST_LOCKED_AUTO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
							<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span> <span class="o">:</span> <span class="n">OS_DATA_SIZE</span><span class="p">;</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span> <span class="o">=</span> <span class="n">OS_DATA_SIZE</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">osst_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Tape position changed from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">fast_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>   <span class="cm">/* in all error conditions except no medium */</span> 
	    <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x3A</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SELECT</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">MODE_HEADER_LENGTH</span><span class="p">;</span>

		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* Medium Type - ignoring */</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* Reserved */</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* Block Descriptor Length */</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">[</span><span class="n">MODE_HEADER_LENGTH</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

<span class="cp">#if DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Applying soft reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">memset</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEST_UNIT_READY</span><span class="p">;</span>

			<span class="n">SRpnt</span> <span class="o">=</span> <span class="n">osst_do_scsi</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span>
						    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x70</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOT_READY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">UNIT_ATTENTION</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span><span class="p">)</span>
					<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* This guess will be updated later if necessary */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
				<span class="p">}</span>
				<span class="n">new_session</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osst_wait_ready</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="mi">15</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>		<span class="cm">/* FIXME - not allowed with NOBLOCK */</span>
		 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Device did not become Ready in open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syscall_result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&gt;=</span> <span class="n">SCSI_2</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x70</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOT_READY</span> <span class="o">&amp;&amp;</span>
		     <span class="n">SRpnt</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x3a</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Check ASC */</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="n">ST_NO_TAPE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="n">ST_NOT_READY</span><span class="p">;</span>
		<span class="n">osst_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
		<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   	<span class="cm">/* Clear the erroneous &quot;residue&quot; */</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_prot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">=</span> <span class="n">ST_UNLOCKED</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">osst_configure_onstream</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">);</span>

	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span> <span class="o">?</span> <span class="n">OS_FRAME_SIZE</span> <span class="o">:</span> <span class="p">(</span>
			     <span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span> <span class="o">:</span> <span class="n">OS_DATA_SIZE</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">OS_DATA_SIZE</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span>  <span class="o">=</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">read_pointer</span>  <span class="o">=</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Block size: %d, frame size: %d, buffer size: %d (%d blocks).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">,</span> <span class="n">OS_FRAME_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_blocks</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_write_prot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_prot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Write protected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">O_WRONLY</span> <span class="o">||</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">O_RDWR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EROFS</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_session</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Change the drive parameters for the new mode */</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: New Session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">density_changed</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">blksize_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">compression_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * properly position the tape and check the ADR headers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">==</span> <span class="n">ST_UNLOCKED</span><span class="p">)</span> <span class="p">{</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">do_door_lock</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I: Can&#39;t lock drive door</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		 <span class="k">else</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">=</span> <span class="n">ST_LOCKED_AUTO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">osst_analyze_headers</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">);</span>

	<span class="n">osst_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
	<span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">osst_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>
	<span class="n">normalize_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* BKL pushdown: spaghetti avoidance wrapper */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">os_scsi_tape_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span> <span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osst_int_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__os_scsi_tape_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osst_int_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* Flush the tape buffer before close */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">os_scsi_tape_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">,</span> <span class="n">fl_owner_t</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		      <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">result2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_tape</span>    <span class="o">*</span> <span class="n">STp</span>    <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span>   <span class="o">*</span> <span class="n">STm</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">st_partstat</span>  <span class="o">*</span> <span class="n">STps</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span> <span class="n">SRpnt</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span>		    <span class="o">*</span> <span class="n">name</span>   <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file_count</span><span class="p">(</span><span class="n">filp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span> <span class="o">||</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">=</span> <span class="n">OS_WRITE_DATA</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">osst_flush_write_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">&gt;=</span> <span class="n">ST_WRITING</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span><span class="p">)</span> <span class="p">{</span>

<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: File length %ld bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">));</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Async write waits %d, finished %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">name</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_waits</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_finished</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">osst_write_trailer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="o">!</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">rew_at_close</span><span class="p">));</span>
<span class="cp">#if DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Buffer flushed, %d EOF(s) written</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">two_fm</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">rew_at_close</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">sysv</span> <span class="o">||</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">!=</span> <span class="n">ST_READING</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_bsr</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">osst_flush_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* this is the default path */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">cross_eof</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
							<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_FM</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_NOEOF</span> <span class="o">&amp;&amp;</span>
			  <span class="o">!</span><span class="p">(</span><span class="n">result</span> <span class="o">=</span> <span class="n">cross_eof</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">||</span>
			 <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="o">++</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_FM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">rew_at_close</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result2</span> <span class="o">=</span> <span class="n">osst_position_tape_and_confirm</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span><span class="p">);</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">result2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">result2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="p">)</span> <span class="n">osst_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">abort_count</span> <span class="o">||</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:I:&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">abort_count</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %d unrecovered errors&quot;</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">abort_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_count</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %d recovered errors&quot;</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_count</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; in %d frames written&quot;</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_count</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; in %d frames read&quot;</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_count</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">abort_count</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">read_count</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Close the device and release it */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">os_scsi_tape_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span> <span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		      <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_tape</span>    <span class="o">*</span> <span class="n">STp</span>    <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">==</span> <span class="n">ST_LOCKED_AUTO</span><span class="p">)</span>
		<span class="n">do_door_lock</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span>
		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">normalize_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
	<span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>

	<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* The ioctl command */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">osst_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span>
	 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		      <span class="n">i</span><span class="p">,</span> <span class="n">cmd_nr</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span>   <span class="o">*</span> <span class="n">STm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span>  <span class="o">*</span> <span class="n">STps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_request</span> <span class="o">*</span> <span class="n">SRpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_tape</span>    <span class="o">*</span> <span class="n">STp</span>   <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span>		    <span class="o">*</span> <span class="n">name</span>  <span class="o">=</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
	<span class="kt">void</span>	    <span class="n">__user</span>  <span class="o">*</span> <span class="n">p</span>     <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osst_int_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osst_int_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Incorrect device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">current_mode</span><span class="p">]);</span>
	<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are in the middle of error recovery, don&#39;t let anyone</span>
<span class="cm">	 * else try and use this device.  Also, if error recovery fails, it</span>
<span class="cm">	 * may try and take the device offline, in which case all further</span>
<span class="cm">	 * access to the device is prohibited.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">scsi_block_when_processing_errors</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd_type</span> <span class="o">=</span> <span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd_in</span><span class="p">);</span>
	<span class="n">cmd_nr</span>   <span class="o">=</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd_in</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;%s:D: Ioctl %d,%d in %s mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			    <span class="n">cmd_type</span><span class="p">,</span> <span class="n">cmd_nr</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="o">?</span><span class="s">&quot;raw&quot;</span><span class="o">:</span><span class="s">&quot;normal&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">MTIOCTOP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmd_nr</span> <span class="o">==</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">MTIOCTOP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mtop</span> <span class="n">mtc</span><span class="p">;</span>
		<span class="kt">int</span>    <span class="n">auto_weof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd_in</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mtc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">mtc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtop</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTSETDRVBUFFER</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:W: MTSETDRVBUFFER only allowed for root.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EPERM</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">defined</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTSETDRVBUFFER</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">&amp;</span> <span class="n">MT_ST_OPTIONS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">pos_unknown</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_FM_HIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTFSF</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTFSFM</span><span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTEOM</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSF</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSFM</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTSEEK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Old position must be restored if partition will be changed */</span>
				<span class="n">i</span> <span class="o">=</span> <span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">||</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">!=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTREW</span>   <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTOFFL</span> <span class="o">||</span>
				    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTRETEN</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTEOM</span>  <span class="o">||</span>
				    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTLOCK</span>  <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTLOAD</span> <span class="o">||</span>
				    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTFSF</span>   <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTFSFM</span> <span class="o">||</span>
				    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSF</span>   <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTBSFM</span> <span class="o">||</span>
				    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTCOMPRESSION</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">osst_flush_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If there was a bus reset, block further access</span>
<span class="cm">			 * to this device.  If the user wants to rewind the tape,</span>
<span class="cm">			 * then reset the flag and allow access again.</span>
<span class="cm">			 */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTREW</span>   <span class="o">&amp;&amp;</span>
			   <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTOFFL</span>  <span class="o">&amp;&amp;</span>
			   <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTRETEN</span> <span class="o">&amp;&amp;</span>
			   <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTERASE</span> <span class="o">&amp;&amp;</span>
			   <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTSEEK</span>  <span class="o">&amp;&amp;</span>
			   <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTEOM</span><span class="p">)</span>   <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">reset_state</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
			<span class="cm">/* remove this when the midlevel properly clears was_reset */</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">was_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTCOMPRESSION</span>  <span class="o">&amp;&amp;</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTLOCK</span>         <span class="o">&amp;&amp;</span>
		    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTNOP</span>          <span class="o">&amp;&amp;</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTSETBLK</span>       <span class="o">&amp;&amp;</span>
		    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTSETDENSITY</span>   <span class="o">&amp;&amp;</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTSETDRVBUFFER</span> <span class="o">&amp;&amp;</span> 
		    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTMKPART</span>       <span class="o">&amp;&amp;</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTSETPART</span>      <span class="o">&amp;&amp;</span>
		    <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTWEOF</span>         <span class="o">&amp;&amp;</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">!=</span> <span class="n">MTWSM</span>           <span class="p">)</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 * The user tells us to move to another position on the tape.</span>
<span class="cm">			 * If we were appending to the tape content, that would leave</span>
<span class="cm">			 * the tape without proper end, in that case write EOD and</span>
<span class="cm">			 * update the header to reflect its position.</span>
<span class="cm">			 */</span>
<span class="cp">#if DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:D: auto_weod %s at ffp=%d,efp=%d,fsn=%d,lbn=%d,fn=%d,bn=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
					<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">&gt;=</span> <span class="n">ST_WRITING</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_READING</span> <span class="o">?</span> <span class="s">&quot;read&quot;</span> <span class="o">:</span> <span class="s">&quot;idle&quot;</span><span class="p">,</span>
					<span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span>
					<span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">,</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">,</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">&gt;=</span> <span class="n">ST_WRITING</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">auto_weof</span> <span class="o">=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">!=</span> <span class="n">OS_WRITE_NEW_MARK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
							<span class="o">!</span><span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTREW</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTOFFL</span><span class="p">));</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">osst_write_trailer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span>
							<span class="o">!</span><span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTREW</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTOFFL</span><span class="p">));</span>
<span class="cp">#if DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:D: post trailer xeof=%d,ffp=%d,efp=%d,fsn=%d,lbn=%d,fn=%d,bn=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">name</span><span class="p">,</span> <span class="n">auto_weof</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_frame_position</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">,</span>
						<span class="n">STp</span><span class="o">-&gt;</span><span class="n">frame_seq_number</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">logical_blk_num</span><span class="p">,</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">,</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTOFFL</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">door_locked</span> <span class="o">!=</span> <span class="n">ST_UNLOCKED</span><span class="p">)</span>
			<span class="n">do_door_lock</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="cm">/* Ignore result! */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTSETDRVBUFFER</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">&amp;</span> <span class="n">MT_ST_OPTIONS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">osst_set_options</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTSETPART</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span> <span class="o">&gt;=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span><span class="p">;</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTMKPART</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">osst_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">MTREW</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="cm">/*||</span>
<span class="cm">			    (i = partition_tape(inode, mtc.mt_count)) &lt; 0*/</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_block_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">STp</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* Bad guess ?-) */</span>
			<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	 	<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTSEEK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">osst_set_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">osst_seek_sector</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">can_partitions</span><span class="p">)</span>
				<span class="n">STp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
 
		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTLOCK</span> <span class="o">||</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTUNLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">do_door_lock</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTLOCK</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">auto_weof</span><span class="p">)</span>
			<span class="n">cross_eof</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span> <span class="o">==</span> <span class="n">MTCOMPRESSION</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>       <span class="cm">/* OnStream drives don&#39;t have compression hardware */</span>
		<span class="k">else</span>
			<span class="cm">/* MTBSF MTBSFM MTBSR MTBSS MTEOM MTERASE MTFSF MTFSFB MTFSR MTFSS</span>
<span class="cm">			 * MTLOAD MTOFFL MTRESET MTRETEN MTREW MTUNLOAD MTWEOF MTWSM */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">osst_int_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_op</span><span class="p">,</span> <span class="n">mtc</span><span class="p">.</span><span class="n">mt_count</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">defined</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">osst_flush_buffer</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">MTIOCGET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmd_nr</span> <span class="o">==</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">MTIOCGET</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mtget</span> <span class="n">mt_status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd_in</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtget</span><span class="p">))</span> <span class="p">{</span>
			 <span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
			 <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_type</span> <span class="o">=</span> <span class="n">MT_ISONSTREAM_SC</span><span class="p">;</span>
		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_erreg</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_erreg</span> <span class="o">&lt;&lt;</span> <span class="n">MT_ST_SOFTERR_SHIFT</span><span class="p">;</span>
		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_dsreg</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">&lt;&lt;</span> <span class="n">MT_ST_BLKSIZE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MT_ST_BLKSIZE_MASK</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span>    <span class="o">&lt;&lt;</span> <span class="n">MT_ST_DENSITY_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MT_ST_DENSITY_MASK</span><span class="p">);</span>
		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_blkno</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span><span class="p">;</span>
		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_fileno</span> <span class="o">=</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_WRITING</span><span class="p">)</span>
				<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_blkno</span> <span class="o">+=</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">==</span> <span class="n">ST_READING</span><span class="p">)</span>
				<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_blkno</span> <span class="o">-=</span> <span class="p">((</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">+</span>
							<span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_write_prot</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_WR_PROT</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mt_status</span><span class="p">.</span><span class="n">mt_blkno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mt_status</span><span class="p">.</span><span class="n">mt_fileno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_BOT</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_EOF</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_resid</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOM_OK</span> <span class="o">||</span> <span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">==</span> <span class="n">ST_EOM_ERROR</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_EOT</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">&gt;=</span> <span class="n">ST_EOM_OK</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_EOD</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_D_800</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_D_1600</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_D_6250</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_READY</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_ONLINE</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">==</span> <span class="n">ST_NO_TAPE</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_DR_OPEN</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_SM</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span> <span class="o">||</span> <span class="p">(</span><span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">STp</span><span class="o">-&gt;</span><span class="n">drv_buffer</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mt_status</span><span class="p">.</span><span class="n">mt_gstat</span> <span class="o">|=</span> <span class="n">GMT_IM_REP_EN</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt_status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtget</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">STp</span><span class="o">-&gt;</span><span class="n">recover_erreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Clear after read */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* End of MTIOCGET */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">MTIOCPOS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmd_nr</span> <span class="o">==</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">MTIOCPOS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mtpos</span> <span class="n">mt_pos</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd_in</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtpos</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span>
			<span class="n">blk</span> <span class="o">=</span> <span class="n">osst_get_frame_position</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">blk</span> <span class="o">=</span> <span class="n">osst_get_sector</span><span class="p">(</span><span class="n">STp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SRpnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mt_pos</span><span class="p">.</span><span class="n">mt_blkno</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt_pos</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtpos</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="p">)</span> <span class="n">osst_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">scsi_ioctl</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osst_int_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SRpnt</span><span class="p">)</span> <span class="n">osst_release_request</span><span class="p">(</span><span class="n">SRpnt</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osst_int_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">osst_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="n">STp</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">compat_ioctl</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">compat_ioctl</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">cmd_in</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>



<span class="cm">/* Memory handling routines */</span>

<span class="cm">/* Try to allocate a new tape buffer skeleton. Caller must not hold os_scsi_tapes_lock */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span> <span class="nf">new_tape_buffer</span><span class="p">(</span> <span class="kt">int</span> <span class="n">from_initialization</span><span class="p">,</span> <span class="kt">int</span> <span class="n">need_dma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_sg</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">priority</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">from_initialization</span><span class="p">)</span>
		<span class="n">priority</span> <span class="o">=</span> <span class="n">GFP_ATOMIC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priority</span> <span class="o">=</span> <span class="n">GFP_KERNEL</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">osst_max_sg_segs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span><span class="p">);</span>
	<span class="n">tb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;osst :I: Can&#39;t allocate new tape buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">=</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">orig_sg_segs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">use_sg</span> <span class="o">=</span> <span class="n">max_sg</span><span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">need_dma</span><span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> 
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
			<span class="s">&quot;osst :D: Allocated tape buffer skeleton (%d bytes, %d segments, dma: %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span><span class="p">,</span> <span class="n">max_sg</span><span class="p">,</span> <span class="n">need_dma</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">tb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Try to allocate a temporary (while a user has the device open) enlarged tape buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">enlarge_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="n">STbuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">need_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">segs</span><span class="p">,</span> <span class="n">nbr</span><span class="p">,</span> <span class="n">max_segs</span><span class="p">,</span> <span class="n">b_size</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">got</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">priority</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">&gt;=</span> <span class="n">OS_FRAME_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;osst :A: Buffer not previously normalized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">normalize_buffer</span><span class="p">(</span><span class="n">STbuffer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* See how many segments we can use -- need at least two */</span>
	<span class="n">nbr</span> <span class="o">=</span> <span class="n">max_segs</span> <span class="o">=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">use_sg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nbr</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priority</span> <span class="o">=</span> <span class="n">GFP_KERNEL</span> <span class="cm">/* | __GFP_NOWARN */</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_dma</span><span class="p">)</span>
		<span class="n">priority</span> <span class="o">|=</span> <span class="n">GFP_DMA</span><span class="p">;</span>

	<span class="cm">/* Try to allocate the first segment up to OS_DATA_SIZE and the others</span>
<span class="cm">	   big enough to reach the goal (code assumes no segments in place) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">b_size</span> <span class="o">=</span> <span class="n">OS_DATA_SIZE</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="n">OSST_FIRST_ORDER</span><span class="p">;</span> <span class="n">b_size</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">order</span><span class="o">--</span><span class="p">,</span> <span class="n">b_size</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>

		<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">page</span><span class="p">,</span> <span class="n">b_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		    <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;osst :I: Can&#39;t allocate tape buffer main segment.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Got initial segment of &#39;bsize,order&#39;, continue with same size if possible, except for AUX */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">segs</span><span class="o">=</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">got</span><span class="o">=</span><span class="n">b_size</span><span class="p">;</span>
	     <span class="n">segs</span> <span class="o">&lt;</span> <span class="n">max_segs</span> <span class="o">&amp;&amp;</span> <span class="n">got</span> <span class="o">&lt;</span> <span class="n">OS_FRAME_SIZE</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="p">(</span><span class="n">OS_FRAME_SIZE</span> <span class="o">-</span> <span class="n">got</span> <span class="o">&lt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">order</span><span class="p">);</span>
		<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">segs</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;osst :W: Failed to enlarge buffer to %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">OS_FRAME_SIZE</span><span class="p">);</span>
<span class="cp">#if DEBUG</span>
			<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">got</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">normalize_buffer</span><span class="p">(</span><span class="n">STbuffer</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">segs</span><span class="p">],</span> <span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">OS_FRAME_SIZE</span> <span class="o">-</span> <span class="n">got</span> <span class="o">&lt;=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">OS_FRAME_SIZE</span> <span class="o">-</span> <span class="n">got</span><span class="p">)</span> <span class="o">:</span> <span class="n">b_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">got</span> <span class="o">+=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">segs</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">got</span><span class="p">;</span>
		<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">=</span> <span class="o">++</span><span class="n">segs</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
			   <span class="s">&quot;osst :D: Expanded tape buffer (%d bytes, %d-&gt;%d segments, dma: %d, at: %p).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">got</span><span class="p">,</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">orig_sg_segs</span><span class="p">,</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">,</span> <span class="n">need_dma</span><span class="p">,</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span>
			   <span class="s">&quot;osst :D: segment sizes: first %d at %p, last %d bytes at %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">page_address</span><span class="p">(</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">page</span><span class="p">),</span>
			   <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">segs</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">page_address</span><span class="p">(</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">segs</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">page</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Release the segments */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">normalize_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="n">STbuffer</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">b_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">b_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">b_size</span> <span class="o">&lt;</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		     <span class="n">b_size</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">order</span><span class="o">++</span><span class="p">);</span>

		<span class="n">__free_pages</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">order</span><span class="p">);</span>
		<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugging</span> <span class="o">&amp;&amp;</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">orig_sg_segs</span> <span class="o">&lt;</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;osst :D: Buffer at %p normalized to %d bytes (segs %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">,</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">=</span> <span class="n">STbuffer</span><span class="o">-&gt;</span><span class="n">orig_sg_segs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Move data from the user buffer to the tape buffer. Returns zero (success) or</span>
<span class="cm">   negative error code. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">append_to_buffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="n">st_bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="n">offset</span> <span class="o">-=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Should never happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;osst :A: Append_to_buffer offset overflow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">&amp;&amp;</span> <span class="n">do_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">do_count</span> <span class="o">?</span>
		      <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">:</span> <span class="n">do_count</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ubp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="n">do_count</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">ubp</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_count</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Should never happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;osst :A: Append_to_buffer overflow (left %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">do_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Move data from the tape buffer to the user buffer. Returns zero (success) or</span>
<span class="cm">   negative error code. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">from_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="n">st_bp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">read_pointer</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Should never happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;osst :A: From_buffer offset overflow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">&amp;&amp;</span> <span class="n">do_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">do_count</span> <span class="o">?</span>
		      <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">:</span> <span class="n">do_count</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">ubp</span><span class="p">,</span> <span class="n">page_address</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="n">do_count</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">read_pointer</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">ubp</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_count</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Should never happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;osst :A: From_buffer overflow (left %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">do_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sets the tail of the buffer after fill point to zero.</span>
<span class="cm">   Returns zero (success) or negative error code.        */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_zero_buffer_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="n">st_bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">do_count</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Should never happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;osst :A: Zero_buffer offset overflow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">do_count</span> <span class="o">=</span> <span class="n">OS_DATA_SIZE</span> <span class="o">-</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">buffer_bytes</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">&amp;&amp;</span> <span class="n">do_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">do_count</span> <span class="o">?</span>
		      <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">:</span> <span class="n">do_count</span> <span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">do_count</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_count</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Should never happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;osst :A: Zero_buffer overflow (left %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">do_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Copy a osst 32K chunk of memory into the buffer.</span>
<span class="cm">   Returns zero (success) or negative error code.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_copy_to_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="n">st_bp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">do_count</span> <span class="o">=</span> <span class="n">OS_DATA_SIZE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">&amp;&amp;</span> <span class="n">do_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">do_count</span> <span class="o">?</span>
		      <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">:</span> <span class="n">do_count</span> <span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">do_count</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">ptr</span>      <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_count</span> <span class="o">||</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Should never happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;osst :A: Copy_to_buffer overflow (left %d at sg %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">do_count</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Copy a osst 32K chunk of memory from the buffer.</span>
<span class="cm">   Returns zero (success) or negative error code.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_copy_from_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span><span class="n">st_bp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">do_count</span> <span class="o">=</span> <span class="n">OS_DATA_SIZE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span> <span class="o">&amp;&amp;</span> <span class="n">do_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">do_count</span> <span class="o">?</span>
		      <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">:</span> <span class="n">do_count</span> <span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">page_address</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">do_count</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">ptr</span>      <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_count</span> <span class="o">||</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">st_bp</span><span class="o">-&gt;</span><span class="n">sg_segs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Should never happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;osst :A: Copy_from_buffer overflow (left %d at sg %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">do_count</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Module housekeeping */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">validate_options</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">max_dev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">osst_max_dev</span> <span class="o">=</span> <span class="n">max_dev</span><span class="p">;</span>  
  <span class="k">if</span> <span class="p">(</span><span class="n">write_threshold_kbs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">osst_write_threshold</span> <span class="o">=</span> <span class="n">write_threshold_kbs</span> <span class="o">*</span> <span class="n">ST_KILOBYTE</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">osst_write_threshold</span> <span class="o">&gt;</span> <span class="n">osst_buffer_size</span><span class="p">)</span>
		<span class="n">osst_write_threshold</span> <span class="o">=</span> <span class="n">osst_buffer_size</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">max_sg_segs</span> <span class="o">&gt;=</span> <span class="n">OSST_FIRST_SG</span><span class="p">)</span>
		<span class="n">osst_max_sg_segs</span> <span class="o">=</span> <span class="n">max_sg_segs</span><span class="p">;</span>
<span class="cp">#if DEBUG</span>
  <span class="n">printk</span><span class="p">(</span><span class="n">OSST_DEB_MSG</span> <span class="s">&quot;osst :D: max tapes %d, write threshold %d, max s/g segs %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">osst_max_dev</span><span class="p">,</span> <span class="n">osst_write_threshold</span><span class="p">,</span> <span class="n">osst_max_sg_segs</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
	
<span class="cp">#ifndef MODULE</span>
<span class="cm">/* Set the boot options. Syntax: osst=xxx,yyy,...</span>
<span class="cm">   where xxx is write threshold in 1024 byte blocks,</span>
<span class="cm">   and   yyy is number of s/g segments to use. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">osst_setup</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ints</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">stp</span><span class="p">;</span>

  <span class="n">stp</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">parms</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		  <span class="o">*</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">stp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">parms</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">stp</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="p">(</span><span class="n">stp</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span>
					<span class="n">simple_strtoul</span><span class="p">(</span><span class="n">stp</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">parms</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;osst :I: Illegal parameter in &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">stp</span><span class="p">);</span>
		<span class="n">stp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">stp</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="p">)</span>
			<span class="n">stp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;osst=&quot;</span><span class="p">,</span> <span class="n">osst_setup</span><span class="p">);</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">osst_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">osst_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>        <span class="n">osst_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">osst_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">osst_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">os_scsi_tape_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush</span> <span class="o">=</span>        <span class="n">os_scsi_tape_flush</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">os_scsi_tape_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_supports</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">SDp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">osst_support_data</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">rev</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">driver_hint</span><span class="p">;</span> <span class="cm">/* Name of the correct driver, NULL if unknown */</span>
	<span class="p">};</span>

<span class="k">static</span>	<span class="k">struct</span>	<span class="n">osst_support_data</span> <span class="n">support_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* {&quot;XXX&quot;, &quot;Yy-&quot;, &quot;&quot;, NULL},  example */</span>
		<span class="n">SIGS_FROM_OSST</span><span class="p">,</span>
		<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">}};</span>

	<span class="k">struct</span>	<span class="n">osst_support_data</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>

	<span class="cm">/* We are willing to drive OnStream SC-x0 as well as the</span>
<span class="cm">	 * 	 * IDE, ParPort, FireWire, USB variants, if accessible by</span>
<span class="cm">	 * 	 	 * emulation layer (ide-scsi, usb-storage, ...) */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rp</span><span class="o">=&amp;</span><span class="p">(</span><span class="n">support_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">rp</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">SDp</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">SDp</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">,</span> <span class="n">SDp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">)))</span> 
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sysfs support for osst driver parameter information</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">osst_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osst_version</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">osst_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_create_sysfs_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">sysfs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_version</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osst_remove_sysfs_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">sysfs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">sysfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_version</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sysfs support for accessing ADR header information</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">osst_adr_rev_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_get_drvdata</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">major_rev</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="o">-&gt;</span><span class="n">minor_rev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ADR_rev</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">osst_adr_rev_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">osst_linux_media_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_get_drvdata</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;LIN%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media_version</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">media_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">osst_linux_media_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">osst_capacity_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_get_drvdata</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">osst_capacity_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">osst_first_data_ppos_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_get_drvdata</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">first_data_ppos</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">BOT_frame</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">osst_first_data_ppos_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">osst_eod_frame_ppos_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_get_drvdata</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">eod_frame_ppos</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">EOD_frame</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">osst_eod_frame_ppos_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">osst_filemark_cnt_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_get_drvdata</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STp</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">&amp;&amp;</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">linux_media</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">STp</span><span class="o">-&gt;</span><span class="n">filemark_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">file_count</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">osst_filemark_cnt_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">osst_sysfs_class</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_sysfs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">osst_sysfs_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;onstream_tape&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">osst_sysfs_class</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;osst :W: Unable to register sysfs class</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">osst_sysfs_class</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osst_sysfs_destroy</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_destroy</span><span class="p">(</span><span class="n">osst_sysfs_class</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_sysfs_add</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">osst_member</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">osst_member</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">osst_sysfs_class</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">STp</span><span class="p">,</span>
				    <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">osst_member</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;osst :W: Unable to add sysfs class member %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">osst_member</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">osst_member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_ADR_rev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">osst_member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_media_version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">osst_member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_capacity</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">osst_member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_BOT_frame</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">osst_member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_EOD_frame</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">osst_member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_file_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">osst_sysfs_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osst_sysfs_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">class_destroy</span><span class="p">(</span><span class="n">osst_sysfs_class</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * osst startup / cleanup code</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">SDp</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">osst_tape</span>   <span class="o">*</span> <span class="n">tpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_modedef</span>  <span class="o">*</span> <span class="n">STm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_partstat</span> <span class="o">*</span> <span class="n">STps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_buffer</span> <span class="o">*</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span>	   <span class="o">*</span> <span class="n">drive</span><span class="p">;</span>
	<span class="kt">int</span>		     <span class="n">i</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TYPE_TAPE</span> <span class="o">||</span> <span class="o">!</span><span class="n">osst_supports</span><span class="p">(</span><span class="n">SDp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">drive</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drive</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;osst :E: Out of memory. Device not attached.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if this is the first attach, build the infrastructure */</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os_scsi_tapes</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">os_scsi_tapes</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">osst_max_dev</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">os_scsi_tapes</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;osst :E: Unable to allocate array for OnStream SCSI tapes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_put_disk</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">osst_max_dev</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="n">os_scsi_tapes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">osst_nr_dev</span> <span class="o">&gt;=</span> <span class="n">osst_max_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;osst :E: Too many tape devices (max. %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osst_max_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_put_disk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* find a free minor number */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">osst_max_dev</span> <span class="o">&amp;&amp;</span> <span class="n">os_scsi_tapes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">osst_max_dev</span><span class="p">)</span> <span class="n">panic</span> <span class="p">(</span><span class="s">&quot;Scsi_devices corrupt (osst)&quot;</span><span class="p">);</span>
	<span class="n">dev_num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* allocate a struct osst_tape for this device */</span>
	<span class="n">tpnt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osst_tape</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;osst :E: Can&#39;t allocate device descriptor, device not attached.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_put_disk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate a buffer for this device */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">SDp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osst_max_sg_segs</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">osst_max_sg_segs</span><span class="p">;</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">new_tape_buffer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SDp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;osst :E: Unable to allocate a tape buffer, device not attached.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tpnt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_put_disk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">os_scsi_tapes</span><span class="p">[</span><span class="n">dev_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpnt</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">SDp</span><span class="p">;</span>
	<span class="n">drive</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">drive</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;osst%d&quot;</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">);</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osst_template</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">drive</span> <span class="o">=</span> <span class="n">drive</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mh">0xfffff</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">drv_buffer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* Try buffering if no mode sense */</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">restr_dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">density</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">do_auto_lock</span> <span class="o">=</span> <span class="n">OSST_AUTO_LOCK</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">can_bsr</span> <span class="o">=</span> <span class="n">OSST_IN_FILE_POS</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">can_partitions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">two_fm</span> <span class="o">=</span> <span class="n">OSST_TWO_FM</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">fast_mteom</span> <span class="o">=</span> <span class="n">OSST_FAST_MTEOM</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">scsi2_logical</span> <span class="o">=</span> <span class="n">OSST_SCSI2LOGICAL</span><span class="p">;</span> <span class="cm">/* FIXME */</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">write_threshold</span> <span class="o">=</span> <span class="n">osst_write_threshold</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">default_drvbuffer</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* No forced buffering */</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">new_partition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">nbr_partitions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">min_block</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">max_block</span> <span class="o">=</span> <span class="n">OS_DATA_SIZE</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">OSST_TIMEOUT</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">long_timeout</span> <span class="o">=</span> <span class="n">OSST_LONG_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* Recognize OnStream tapes */</span>
	<span class="cm">/* We don&#39;t need to test for OnStream, as this has been done in detect () */</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">os_fw_rev</span> <span class="o">=</span> <span class="n">osst_parse_firmware_rev</span> <span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">);</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">omit_blklims</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;DI-&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> 
		     <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;FW-&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">OSST_FW_NEED_POLL</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">os_fw_rev</span><span class="p">,</span><span class="n">SDp</span><span class="p">);</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">frame_in_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">header_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">linux_media</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">header_cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_MODES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">defined</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">sysv</span> <span class="o">=</span> <span class="n">OSST_SYSV</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">defaults_for_writes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_async_writes</span> <span class="o">=</span> <span class="n">OSST_ASYNC_WRITES</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_buffer_writes</span> <span class="o">=</span> <span class="n">OSST_BUFFER_WRITES</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">do_read_ahead</span> <span class="o">=</span> <span class="n">OSST_READ_AHEAD</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_compression</span> <span class="o">=</span> <span class="n">ST_DONT_TOUCH</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_blksize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">STm</span><span class="o">-&gt;</span><span class="n">default_density</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>  <span class="cm">/* No forced density */</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ST_NBR_PARTITIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">rw</span> <span class="o">=</span> <span class="n">ST_IDLE</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="n">ST_NOEOF</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">at_sm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">last_block_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_block</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">STps</span><span class="o">-&gt;</span><span class="n">drv_file</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">current_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">defined</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">defined</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">density_changed</span> <span class="o">=</span> <span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">compression_changed</span> <span class="o">=</span> <span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">blksize_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">osst_nr_dev</span><span class="o">++</span><span class="p">;</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

		<span class="cm">/*  Rewind entry  */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">osst_sysfs_add</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">OSST_MAJOR</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">),</span> <span class="n">dev</span><span class="p">,</span> <span class="n">tpnt</span><span class="p">,</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">tpnt</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_buffer</span><span class="p">;</span>

		<span class="cm">/*  No-rewind entry  */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">tpnt</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">osst_sysfs_add</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">OSST_MAJOR</span><span class="p">,</span> <span class="n">dev_num</span> <span class="o">+</span> <span class="mi">128</span><span class="p">),</span> <span class="n">dev</span><span class="p">,</span> <span class="n">tpnt</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_sysfs1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SDp</span><span class="p">,</span>
		<span class="s">&quot;osst :I: Attached OnStream %.5s tape as %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">SDp</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">tape_name</span><span class="p">(</span><span class="n">tpnt</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_sysfs1:</span>
	<span class="n">osst_sysfs_destroy</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">OSST_MAJOR</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">));</span>
<span class="nl">out_free_buffer:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="nl">out_put_disk:</span>
        <span class="n">put_disk</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">osst_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">SDp</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">tpnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TYPE_TAPE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">osst_nr_dev</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">osst_max_dev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">tpnt</span> <span class="o">=</span> <span class="n">os_scsi_tapes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">SDp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">osst_sysfs_destroy</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">OSST_MAJOR</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
			<span class="n">osst_sysfs_destroy</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">OSST_MAJOR</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">128</span><span class="p">));</span>
			<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">put_disk</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">drive</span><span class="p">);</span>
			<span class="n">os_scsi_tapes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">osst_nr_dev</span><span class="o">--</span><span class="p">;</span>
			<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">normalize_buffer</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tpnt</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_scsi_tapes_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_osst</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;osst :I: Tape driver with OnStream support version %s</span><span class="se">\n</span><span class="s">osst :I: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">osst_version</span><span class="p">,</span> <span class="n">cvsid</span><span class="p">);</span>

	<span class="n">validate_options</span><span class="p">();</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">osst_sysfs_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_chrdev</span><span class="p">(</span><span class="n">OSST_MAJOR</span><span class="p">,</span> <span class="s">&quot;osst&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osst_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;osst :E: Unable to register major %d for OnStream tapes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">OSST_MAJOR</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">scsi_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osst_template</span><span class="p">.</span><span class="n">gendrv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_chrdev</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">osst_create_sysfs_files</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osst_template</span><span class="p">.</span><span class="n">gendrv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_scsidrv</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_scsidrv:</span>
	<span class="n">scsi_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osst_template</span><span class="p">.</span><span class="n">gendrv</span><span class="p">);</span>
<span class="nl">err_out_chrdev:</span>
	<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">OSST_MAJOR</span><span class="p">,</span> <span class="s">&quot;osst&quot;</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">osst_sysfs_cleanup</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_osst</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osst_tape</span> <span class="o">*</span> <span class="n">STp</span><span class="p">;</span>

	<span class="n">osst_remove_sysfs_files</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osst_template</span><span class="p">.</span><span class="n">gendrv</span><span class="p">);</span>
	<span class="n">scsi_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osst_template</span><span class="p">.</span><span class="n">gendrv</span><span class="p">);</span>
	<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">OSST_MAJOR</span><span class="p">,</span> <span class="s">&quot;osst&quot;</span><span class="p">);</span>
	<span class="n">osst_sysfs_cleanup</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">os_scsi_tapes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">osst_max_dev</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">STp</span> <span class="o">=</span> <span class="n">os_scsi_tapes</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* This is defensive, supposed to happen during detach */</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">header_cache</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">normalize_buffer</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">put_disk</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">drive</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">STp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">os_scsi_tapes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;osst :I: Unloaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_osst</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_osst</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
