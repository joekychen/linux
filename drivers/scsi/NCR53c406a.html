<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › NCR53c406a.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>NCR53c406a.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* </span>
<span class="cm"> *  NCR53c406.c</span>
<span class="cm"> *  Low-level SCSI driver for NCR53c406a chip.</span>
<span class="cm"> *  Copyright (C) 1994, 1995, 1996 Normunds Saumanis (normunds@fi.ibm.com)</span>
<span class="cm"> * </span>
<span class="cm"> *  LILO command line usage: ncr53c406a=&lt;PORTBASE&gt;[,&lt;IRQ&gt;[,&lt;FASTPIO&gt;]]</span>
<span class="cm"> *  Specify IRQ = 0 for non-interrupt driven mode.</span>
<span class="cm"> *  FASTPIO = 1 for fast pio mode, 0 for slow mode.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *  under the terms of the GNU General Public License as published by the</span>
<span class="cm"> *  Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm"> *  later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> *  WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> *  General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define NCR53C406A_DEBUG 0</span>
<span class="cp">#define VERBOSE_NCR53C406A_DEBUG 0</span>

<span class="cm">/* Set this to 1 for PIO mode (recommended) or to 0 for DMA mode */</span>
<span class="cp">#define USE_PIO 1</span>

<span class="cp">#define USE_BIOS 0</span>
				<span class="cm">/* #define BIOS_ADDR 0xD8000 *//* define this if autoprobe fails */</span>
				<span class="cm">/* #define PORT_BASE 0x330 *//* define this if autoprobe fails */</span>
				<span class="cm">/* #define IRQ_LEV   0	*//* define this if autoprobe fails */</span>
<span class="cp">#define DMA_CHAN  5		</span><span class="cm">/* this is ignored if DMA is disabled */</span><span class="cp"></span>

<span class="cm">/* Set this to 0 if you encounter kernel lockups while transferring </span>
<span class="cm"> * data in PIO mode */</span>
<span class="cp">#define USE_FAST_PIO 1</span>

<span class="cm">/* ============= End of user configurable parameters ============= */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &quot;scsi.h&quot;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cm">/* ============================================================= */</span>

<span class="cp">#define WATCHDOG 5000000</span>

<span class="cp">#define SYNC_MODE 0		</span><span class="cm">/* Synchronous transfer mode */</span><span class="cp"></span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#undef NCR53C406A_DEBUG</span>
<span class="cp">#define NCR53C406A_DEBUG 1</span>
<span class="cp">#endif</span>

<span class="cp">#if USE_PIO</span>
<span class="cp">#define USE_DMA 0</span>
<span class="cp">#else</span>
<span class="cp">#define USE_DMA 1</span>
<span class="cp">#endif</span>

<span class="cm">/* Default configuration */</span>
<span class="cp">#define C1_IMG   0x07		</span><span class="cm">/* ID=7 */</span><span class="cp"></span>
<span class="cp">#define C2_IMG   0x48		</span><span class="cm">/* FE SCSI2 */</span><span class="cp"></span>
<span class="cp">#if USE_DMA</span>
<span class="cp">#define C3_IMG   0x21		</span><span class="cm">/* CDB TE */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define C3_IMG   0x20		</span><span class="cm">/* CDB */</span><span class="cp"></span>
<span class="cp">#endif</span>
<span class="cp">#define C4_IMG   0x04		</span><span class="cm">/* ANE */</span><span class="cp"></span>
<span class="cp">#define C5_IMG   0xb6		</span><span class="cm">/* AA PI SIE POL */</span><span class="cp"></span>

<span class="cp">#define REG0 (outb(C4_IMG, CONFIG4))</span>
<span class="cp">#define REG1 (outb(C5_IMG, CONFIG5))</span>

<span class="cp">#if NCR53C406A_DEBUG</span>
<span class="cp">#define DEB(x) x</span>
<span class="cp">#else</span>
<span class="cp">#define DEB(x)</span>
<span class="cp">#endif</span>

<span class="cp">#if VERBOSE_NCR53C406A_DEBUG</span>
<span class="cp">#define VDEB(x) x</span>
<span class="cp">#else</span>
<span class="cp">#define VDEB(x)</span>
<span class="cp">#endif</span>

<span class="cp">#define LOAD_DMA_COUNT(count) \</span>
<span class="cp">  outb(count &amp; 0xff, TC_LSB); \</span>
<span class="cp">  outb((count &gt;&gt; 8) &amp; 0xff, TC_MSB); \</span>
<span class="cp">  outb((count &gt;&gt; 16) &amp; 0xff, TC_HIGH);</span>

<span class="cm">/* Chip commands */</span>
<span class="cp">#define DMA_OP               0x80</span>

<span class="cp">#define SCSI_NOP             0x00</span>
<span class="cp">#define FLUSH_FIFO           0x01</span>
<span class="cp">#define CHIP_RESET           0x02</span>
<span class="cp">#define SCSI_RESET           0x03</span>
<span class="cp">#define RESELECT             0x40</span>
<span class="cp">#define SELECT_NO_ATN        0x41</span>
<span class="cp">#define SELECT_ATN           0x42</span>
<span class="cp">#define SELECT_ATN_STOP      0x43</span>
<span class="cp">#define ENABLE_SEL           0x44</span>
<span class="cp">#define DISABLE_SEL          0x45</span>
<span class="cp">#define SELECT_ATN3          0x46</span>
<span class="cp">#define RESELECT3            0x47</span>
<span class="cp">#define TRANSFER_INFO        0x10</span>
<span class="cp">#define INIT_CMD_COMPLETE    0x11</span>
<span class="cp">#define MSG_ACCEPT           0x12</span>
<span class="cp">#define TRANSFER_PAD         0x18</span>
<span class="cp">#define SET_ATN              0x1a</span>
<span class="cp">#define RESET_ATN            0x1b</span>
<span class="cp">#define SEND_MSG             0x20</span>
<span class="cp">#define SEND_STATUS          0x21</span>
<span class="cp">#define SEND_DATA            0x22</span>
<span class="cp">#define DISCONN_SEQ          0x23</span>
<span class="cp">#define TERMINATE_SEQ        0x24</span>
<span class="cp">#define TARG_CMD_COMPLETE    0x25</span>
<span class="cp">#define DISCONN              0x27</span>
<span class="cp">#define RECV_MSG             0x28</span>
<span class="cp">#define RECV_CMD             0x29</span>
<span class="cp">#define RECV_DATA            0x2a</span>
<span class="cp">#define RECV_CMD_SEQ         0x2b</span>
<span class="cp">#define TARGET_ABORT_DMA     0x04</span>

<span class="cm">/*----------------------------------------------------------------*/</span>
<span class="cm">/* the following will set the monitor border color (useful to find</span>
<span class="cm">   where something crashed or gets stuck at */</span>
<span class="cm">/* 1 = blue</span>
<span class="cm">   2 = green</span>
<span class="cm">   3 = cyan</span>
<span class="cm">   4 = red</span>
<span class="cm">   5 = magenta</span>
<span class="cm">   6 = yellow</span>
<span class="cm">   7 = white</span>
<span class="cm">*/</span>

<span class="cp">#if NCR53C406A_DEBUG</span>
<span class="cp">#define rtrc(i) {inb(0x3da);outb(0x31,0x3c0);outb((i),0x3c0);}</span>
<span class="cp">#else</span>
<span class="cp">#define rtrc(i) {}</span>
<span class="cp">#endif</span>
<span class="cm">/*----------------------------------------------------------------*/</span>

<span class="k">enum</span> <span class="n">Phase</span> <span class="p">{</span>
	<span class="n">idle</span><span class="p">,</span>
	<span class="n">data_out</span><span class="p">,</span>
	<span class="n">data_in</span><span class="p">,</span>
	<span class="n">command_ph</span><span class="p">,</span>
	<span class="n">status_ph</span><span class="p">,</span>
	<span class="n">message_out</span><span class="p">,</span>
	<span class="n">message_in</span>
<span class="p">};</span>

<span class="cm">/* Static function prototypes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">NCR53c406a_intr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">do_NCR53c406a_intr</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">chip_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">calc_port_addr</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#ifndef IRQ_LEV</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* ================================================================= */</span>

<span class="cp">#if USE_BIOS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bios_base</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef PORT_BASE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">port_base</span> <span class="o">=</span> <span class="n">PORT_BASE</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">port_base</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef IRQ_LEV</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq_level</span> <span class="o">=</span> <span class="n">IRQ_LEV</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 0 is &#39;no irq&#39;, so use -1 for &#39;uninitialized&#39; */</span>
<span class="cp">#endif</span>

<span class="cp">#if USE_DMA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dma_chan</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if USE_PIO</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fast_pio</span> <span class="o">=</span> <span class="n">USE_FAST_PIO</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">current_SC</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">info_msg</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="cm">/* ================================================================= */</span>

<span class="cm">/* possible BIOS locations */</span>
<span class="cp">#if USE_BIOS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addresses</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xd8000</span><span class="p">,</span>
	<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xc8000</span>
<span class="p">};</span>
<span class="cp">#define ADDRESS_COUNT ARRAY_SIZE(addresses)</span>
<span class="cp">#endif				</span><span class="cm">/* USE_BIOS */</span><span class="cp"></span>

<span class="cm">/* possible i/o port addresses */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ports</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x230</span><span class="p">,</span> <span class="mh">0x330</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x290</span><span class="p">,</span> <span class="mh">0x330</span><span class="p">,</span> <span class="mh">0x340</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x310</span><span class="p">,</span> <span class="mh">0x348</span><span class="p">,</span> <span class="mh">0x350</span> <span class="p">};</span>
<span class="cp">#define PORT_COUNT ARRAY_SIZE(ports)</span>

<span class="cp">#ifndef MODULE</span>
<span class="cm">/* possible interrupt channels */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">intrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span> <span class="p">};</span>
<span class="cp">#define INTR_COUNT ARRAY_SIZE(intrs)</span>
<span class="cp">#endif </span><span class="cm">/* !MODULE */</span><span class="cp"></span>

<span class="cm">/* signatures for NCR 53c406a based controllers */</span>
<span class="cp">#if USE_BIOS</span>
<span class="k">struct</span> <span class="n">signature</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">signature</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sig_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sig_length</span><span class="p">;</span>
<span class="p">}</span> <span class="n">signatures</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*          1         2         3         4         5         6 */</span>
	<span class="cm">/* 123456789012345678901234567890123456789012345678901234567890 */</span>
	<span class="p">{</span>
<span class="s">&quot;Copyright (C) Acculogic, Inc.</span><span class="se">\r\n</span><span class="s">2.8M Diskette Extension Bios ver 4.04.03 03/01/1993&quot;</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">82</span><span class="p">},};</span>

<span class="cp">#define SIGNATURE_COUNT ARRAY_SIZE(signatures)</span>
<span class="cp">#endif				</span><span class="cm">/* USE_BIOS */</span><span class="cp"></span>

<span class="cm">/* ============================================================ */</span>

<span class="cm">/* Control Register Set 0 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">TC_LSB</span><span class="p">;</span>		<span class="cm">/* transfer counter lsb         */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">TC_MSB</span><span class="p">;</span>		<span class="cm">/* transfer counter msb */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">SCSI_FIFO</span><span class="p">;</span>		<span class="cm">/* scsi fifo register   */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">CMD_REG</span><span class="p">;</span>		<span class="cm">/* command register             */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">STAT_REG</span><span class="p">;</span>		<span class="cm">/* status register              */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">DEST_ID</span><span class="p">;</span>		<span class="cm">/* selection/reselection bus id */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">INT_REG</span><span class="p">;</span>		<span class="cm">/* interrupt status register    */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">SRTIMOUT</span><span class="p">;</span>		<span class="cm">/* select/reselect timeout reg  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">SEQ_REG</span><span class="p">;</span>		<span class="cm">/* sequence step register       */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">SYNCPRD</span><span class="p">;</span>		<span class="cm">/* synchronous transfer period  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">FIFO_FLAGS</span><span class="p">;</span>		<span class="cm">/* indicates # of bytes in fifo */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">SYNCOFF</span><span class="p">;</span>		<span class="cm">/* synchronous offset register  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">CONFIG1</span><span class="p">;</span>		<span class="cm">/* configuration register       */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">CLKCONV</span><span class="p">;</span>		<span class="cm">/* clock conversion reg */</span>
				<span class="cm">/*static int TESTREG;*//* test mode register           */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">CONFIG2</span><span class="p">;</span>		<span class="cm">/* Configuration 2 Register     */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">CONFIG3</span><span class="p">;</span>		<span class="cm">/* Configuration 3 Register     */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">CONFIG4</span><span class="p">;</span>		<span class="cm">/* Configuration 4 Register     */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">TC_HIGH</span><span class="p">;</span>		<span class="cm">/* Transfer Counter High */</span>
				<span class="cm">/*static int FIFO_BOTTOM;*//* Reserve FIFO byte register   */</span>

<span class="cm">/* Control Register Set 1 */</span>
				<span class="cm">/*static int JUMPER_SENSE;*//* Jumper sense port reg (r/w) */</span>
				<span class="cm">/*static int SRAM_PTR;*//* SRAM address pointer reg (r/w) */</span>
				<span class="cm">/*static int SRAM_DATA;*//* SRAM data register (r/w) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">PIO_FIFO</span><span class="p">;</span>		<span class="cm">/* PIO FIFO registers (r/w) */</span>
				<span class="cm">/*static int PIO_FIFO1;*//*  */</span>
				<span class="cm">/*static int PIO_FIFO2;*//*  */</span>
				<span class="cm">/*static int PIO_FIFO3;*//*  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">PIO_STATUS</span><span class="p">;</span>		<span class="cm">/* PIO status (r/w) */</span>
				<span class="cm">/*static int ATA_CMD;*//* ATA command/status reg (r/w) */</span>
				<span class="cm">/*static int ATA_ERR;*//* ATA features/error register (r/w) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">PIO_FLAG</span><span class="p">;</span>		<span class="cm">/* PIO flag interrupt enable (r/w) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">CONFIG5</span><span class="p">;</span>		<span class="cm">/* Configuration 5 register (r/w) */</span>
				<span class="cm">/*static int SIGNATURE;*//* Signature Register (r) */</span>
				<span class="cm">/*static int CONFIG6;*//* Configuration 6 register (r) */</span>

<span class="cm">/* ============================================================== */</span>

<span class="cp">#if USE_DMA</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">NCR53c406a_dma_setup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">limit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;dma: before count=%d   &quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="mi">65536</span> <span class="o">-</span> <span class="p">(((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">65536</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="mi">65536</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">65536</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1FFFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span>

	<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;after count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;NCR53c406a: attempted unaligned DMA transfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="n">set_dma_count</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">NCR53c406a_dma_write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NCR53c406a_dma_setup</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">DMA_MODE_WRITE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">NCR53c406a_dma_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NCR53c406a_dma_setup</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">NCR53c406a_dma_residual</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* USE_DMA */</span><span class="cp"></span>

<span class="cp">#if USE_PIO</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">NCR53c406a_pio_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reqlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>		<span class="cm">/* current scsi fifo size */</span>

	<span class="n">REG1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">reqlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">PIO_STATUS</span><span class="p">);</span>
		<span class="cm">/*    VDEB(printk(&quot;pio_status=%x\n&quot;, i)); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="mh">0x10</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x8</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xc</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">84</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xe</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* fifo empty and interrupt occurred */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">reqlen</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">reqlen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fast_pio</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">insl</span><span class="p">(</span><span class="n">PIO_FIFO</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">request</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">;</span>
				<span class="n">reqlen</span> <span class="o">-=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">request</span><span class="o">++</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">PIO_FIFO</span><span class="p">);</span>
					<span class="n">reqlen</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">NCR53c406a_pio_write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reqlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>		<span class="cm">/* current scsi fifo size */</span>

	<span class="n">REG1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">reqlen</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">PIO_STATUS</span><span class="p">);</span>
		<span class="cm">/*    VDEB(printk(&quot;pio_status=%x\n&quot;, i)); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/* error */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x10</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">84</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x8</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xc</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="mh">0xe</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">reqlen</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">reqlen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fast_pio</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outsl</span><span class="p">(</span><span class="n">PIO_FIFO</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">request</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">;</span>
				<span class="n">reqlen</span> <span class="o">-=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">outb</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="o">++</span><span class="p">,</span> <span class="n">PIO_FIFO</span><span class="p">);</span>
					<span class="n">reqlen</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* USE_PIO */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">NCR53c406a_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span> <span class="n">tpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifndef PORT_BASE</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if USE_BIOS</span>
	<span class="kt">int</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">;</span>
	<span class="n">bios_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* look for a valid signature */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">ADDRESS_COUNT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bios_base</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">jj</span> <span class="o">&lt;</span> <span class="n">SIGNATURE_COUNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bios_base</span><span class="p">;</span> <span class="n">jj</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">addresses</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="n">signatures</span><span class="p">[</span><span class="n">jj</span><span class="p">].</span><span class="n">sig_offset</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">signatures</span><span class="p">[</span><span class="n">jj</span><span class="p">].</span><span class="n">signature</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">signatures</span><span class="p">[</span><span class="n">jj</span><span class="p">].</span><span class="n">sig_length</span><span class="p">))</span>
				<span class="n">bios_base</span> <span class="o">=</span> <span class="n">addresses</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bios_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: BIOS signature not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a BIOS found at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">bios_base</span><span class="p">);</span>
	    <span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* USE_BIOS */</span><span class="cp"></span>

<span class="cp">#ifdef PORT_BASE</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s">&quot;NCR53c406a&quot;</span><span class="p">))</span>	<span class="cm">/* ports already snatched */</span>
		<span class="n">port_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#else				</span><span class="cm">/* autodetect */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_base</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* LILO override */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s">&quot;NCR53c406a&quot;</span><span class="p">))</span>
			<span class="n">port_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PORT_COUNT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port_base</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s">&quot;NCR53c406a&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: port 0x%x in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: port 0x%x available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">C5_IMG</span><span class="p">,</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x0d</span><span class="p">);</span>	<span class="cm">/* reg set 1 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="o">^</span> <span class="n">inb</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x0e</span><span class="p">))</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="o">^</span> <span class="n">inb</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x0e</span><span class="p">))</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x58</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">port_base</span> <span class="o">=</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Sig register valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
					<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;port_base=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_base</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">release_region</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* PORT_BASE */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_base</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* no ports found */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: no available ports found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">calc_port_addr</span><span class="p">();</span>
	<span class="n">chip_init</span><span class="p">();</span>

<span class="cp">#ifndef IRQ_LEV</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* LILO override if &gt;= 0 */</span>
		<span class="n">irq_level</span> <span class="o">=</span> <span class="n">irq_probe</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq_level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Trouble */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: IRQ problem, irq_level=%d, giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_level</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: using port_base 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_base</span><span class="p">));</span>

	<span class="n">present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">proc_name</span> <span class="o">=</span> <span class="s">&quot;NCR53c406a&quot;</span><span class="p">;</span>

	<span class="n">shpnt</span> <span class="o">=</span> <span class="n">scsi_register</span><span class="p">(</span><span class="n">tpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shpnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Unable to register host, giving up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq_level</span><span class="p">,</span> <span class="n">do_NCR53c406a_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;NCR53c406a&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: unable to allocate IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_level</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_free_scsi</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: allocated IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_level</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: No interrupts detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a driver no longer supports polling interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Please email linux-scsi@vger.kernel.org</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        
<span class="cp">#if USE_DMA</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: No interrupts found and DMA mode defined. Giving up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* USE_DMA */</span><span class="cp"></span>
		<span class="k">goto</span> <span class="n">err_free_scsi</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Shouldn&#39;t get here!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_free_scsi</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if USE_DMA</span>
	<span class="n">dma_chan</span> <span class="o">=</span> <span class="n">DMA_CHAN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">,</span> <span class="s">&quot;NCR53c406a&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: unable to allocate DMA channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_chan</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Allocated DMA channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_chan</span><span class="p">));</span>
<span class="cp">#endif				</span><span class="cm">/* USE_DMA */</span><span class="cp"></span>

	<span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq_level</span><span class="p">;</span>
	<span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">port_base</span><span class="p">;</span>
	<span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
<span class="cp">#if USE_DMA</span>
	<span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma_chan</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if USE_DMA</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">info_msg</span><span class="p">,</span> <span class="s">&quot;NCR53c406a at 0x%x, IRQ %d, DMA channel %d.&quot;</span><span class="p">,</span> <span class="n">port_base</span><span class="p">,</span> <span class="n">irq_level</span><span class="p">,</span> <span class="n">dma_chan</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">info_msg</span><span class="p">,</span> <span class="s">&quot;NCR53c406a at 0x%x, IRQ %d, %s PIO mode.&quot;</span><span class="p">,</span> <span class="n">port_base</span><span class="p">,</span> <span class="n">irq_level</span><span class="p">,</span> <span class="n">fast_pio</span> <span class="o">?</span> <span class="s">&quot;fast&quot;</span> <span class="o">:</span> <span class="s">&quot;slow&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">present</span><span class="p">);</span>

<span class="cp">#if USE_DMA</span>
      <span class="nl">err_free_irq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_level</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">irq_level</span><span class="p">,</span> <span class="n">shpnt</span><span class="p">);</span>
<span class="cp">#endif</span>
      <span class="nl">err_free_scsi:</span>
	<span class="n">scsi_unregister</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
      <span class="nl">err_release:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">NCR53c406a_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#ifdef USE_DMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">&amp;&amp;</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">n_io_port</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">n_io_port</span><span class="p">);</span>

	<span class="n">scsi_unregister</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="cm">/* called from init/main.c */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">NCR53c406a_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">size_t</span> <span class="n">setup_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Setup called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setup_idx</span> <span class="o">&gt;=</span> <span class="n">PORT_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Setup called too many times.  Bad LILO params?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Malformed command line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Usage: ncr53c406a=&lt;PORTBASE&gt;[,&lt;IRQ&gt;[,&lt;FASTPIO&gt;]]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PORT_COUNT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port_base</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">port_base</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Specified port_base 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_base</span><span class="p">);</span>
			    <span class="p">)</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Invalid PORTBASE 0x%x specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">irq_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Specified irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_level</span><span class="p">);</span>
			    <span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">INTR_COUNT</span> <span class="o">&amp;&amp;</span> <span class="n">irq_level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">intrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">irq_level</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
					<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Specified irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_base</span><span class="p">);</span>
					    <span class="p">)</span>
				<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq_level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Invalid IRQ %d specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">fast_pio</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: port_base=0x%x, irq=%d, fast_pio=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_base</span><span class="p">,</span> <span class="n">irq_level</span><span class="p">,</span> <span class="n">fast_pio</span><span class="p">);)</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;ncr53c406a=&quot;</span><span class="p">,</span> <span class="n">NCR53c406a_setup</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* !MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">NCR53c406a_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">SChost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a_info called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">info_msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void wait_intr(void)</span>
<span class="c">{</span>
<span class="c">	unsigned long i = jiffies + WATCHDOG;</span>

<span class="c">	while (time_after(i, jiffies) &amp;&amp; !(inb(STAT_REG) &amp; 0xe0)) {	/* wait for a pseudo-interrupt */</span>
<span class="c">		cpu_relax();</span>
<span class="c">		barrier();</span>
<span class="c">	}</span>

<span class="c">	if (time_before_eq(i, jiffies)) {	/* Timed out */</span>
<span class="c">		rtrc(0);</span>
<span class="c">		current_SC-&gt;result = DID_TIME_OUT &lt;&lt; 16;</span>
<span class="c">		current_SC-&gt;SCp.phase = idle;</span>
<span class="c">		current_SC-&gt;scsi_done(current_SC);</span>
<span class="c">		return;</span>
<span class="c">	}</span>

<span class="c">	NCR53c406a_intr(NULL);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">NCR53c406a_queue_lck</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)</span> <span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a_queue called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cmd=%02x, cmd_len=%02x, target=%02x, lun=%02x, bufflen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)));</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	VDEB(for (i = 0; i &lt; SCpnt-&gt;cmd_len; i++)</span>
<span class="c">	     printk(&quot;cmd[%d]=%02x  &quot;, i, SCpnt-&gt;cmnd[i]));</span>
<span class="c">	VDEB(printk(&quot;\n&quot;));</span>
<span class="cp">#endif</span>

	<span class="n">current_SC</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="p">;</span>
	<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">command_ph</span><span class="p">;</span>
	<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We are locked here already by the mid layer */</span>
	<span class="n">REG0</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span> <span class="n">DEST_ID</span><span class="p">);</span>	<span class="cm">/* set destination */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">FLUSH_FIFO</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>	<span class="cm">/* reset the fifos */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">SCSI_FIFO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SELECT_NO_ATN</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>

	<span class="n">rtrc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">NCR53c406a_queue</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">NCR53c406a_host_reset</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a_reset called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">C4_IMG</span><span class="p">,</span> <span class="n">CONFIG4</span><span class="p">);</span>	<span class="cm">/* Select reg set 0 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CHIP_RESET</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SCSI_NOP</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>	<span class="cm">/* required after reset */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SCSI_RESET</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>
	<span class="n">chip_init</span><span class="p">();</span>

	<span class="n">rtrc</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">NCR53c406a_biosparm</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
                               <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">info_array</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a_biosparm called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span>
	<span class="n">info_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>	<span class="cm">/* heads */</span>
	<span class="n">info_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>	<span class="cm">/* sectors */</span>
	<span class="n">info_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span>	<span class="cm">/* cylinders */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* big disk */</span>
		<span class="n">info_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">info_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">info_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="mi">63</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">do_NCR53c406a_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">unused</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">NCR53c406a_intr</span><span class="p">(</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">NCR53c406a_intr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEB</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fifo_size</span><span class="p">;</span>
	    <span class="p">)</span>
	    <span class="n">DEB</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">seq_reg</span><span class="p">;</span>
	    <span class="p">)</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">,</span> <span class="n">int_reg</span><span class="p">;</span>
<span class="cp">#if USE_PIO</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pio_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a_intr called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

<span class="cp">#if USE_PIO</span>
	<span class="n">REG1</span><span class="p">;</span>
	<span class="n">pio_status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">PIO_STATUS</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">REG0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">STAT_REG</span><span class="p">);</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">seq_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SEQ_REG</span><span class="p">));</span>
	<span class="n">int_reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">INT_REG</span><span class="p">);</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">FIFO_FLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>

<span class="cp">#if NCR53C406A_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;status=%02x, seq_reg=%02x, int_reg=%02x, fifo_size=%02x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">seq_reg</span><span class="p">,</span> <span class="n">int_reg</span><span class="p">,</span> <span class="n">fifo_size</span><span class="p">);</span>
<span class="cp">#if (USE_DMA)</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, pio=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pio_status</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* USE_DMA */</span><span class="cp"></span>
<span class="cp">#endif				</span><span class="cm">/* NCR53C406A_DEBUG */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* SCSI reset intr */</span>
		<span class="n">rtrc</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: reset intr received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">current_SC</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if USE_PIO</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pio_status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53C406A: Warning: PIO error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">current_SC</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* USE_PIO */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Parity error */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Warning: parity error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_PARITY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">current_SC</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Gross error */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Warning: gross error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">current_SC</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Disconnect */</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: disconnect intr received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">!=</span> <span class="n">message_in</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Unexpected disconnect */</span>
			<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* Command complete, return status and message */</span>
			<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
			    <span class="o">|</span> <span class="p">((</span><span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rtrc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">current_SC</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* scsi phase */</span>
	<span class="k">case</span> <span class="mh">0x00</span>:		<span class="cm">/* DATA-OUT */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Target requesting info transfer */</span>
			<span class="n">rtrc</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">data_out</span><span class="p">;</span>
			<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Data-Out phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">FLUSH_FIFO</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>
			<span class="n">LOAD_DMA_COUNT</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">current_SC</span><span class="p">));</span>	<span class="cm">/* Max transfer size */</span>
<span class="cp">#if USE_DMA			</span><span class="cm">/* No s/g support for DMA */</span><span class="cp"></span>
			<span class="n">NCR53c406a_dma_write</span><span class="p">(</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">current_SC</span><span class="p">),</span>
                                             <span class="n">scsdi_bufflen</span><span class="p">(</span><span class="n">current_SC</span><span class="p">));</span>

<span class="cp">#endif				</span><span class="cm">/* USE_DMA */</span><span class="cp"></span>
			<span class="n">outb</span><span class="p">(</span><span class="n">TRANSFER_INFO</span> <span class="o">|</span> <span class="n">DMA_OP</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>
<span class="cp">#if USE_PIO</span>
                        <span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">current_SC</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">current_SC</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">NCR53c406a_pio_write</span><span class="p">(</span><span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
                        <span class="p">}</span>
			<span class="n">REG0</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* USE_PIO */</span><span class="cp"></span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x01</span>:		<span class="cm">/* DATA-IN */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Target requesting info transfer */</span>
			<span class="n">rtrc</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
			<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">data_in</span><span class="p">;</span>
			<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Data-In phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">FLUSH_FIFO</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>
			<span class="n">LOAD_DMA_COUNT</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">current_SC</span><span class="p">));</span>	<span class="cm">/* Max transfer size */</span>
<span class="cp">#if USE_DMA			</span><span class="cm">/* No s/g support for DMA */</span><span class="cp"></span>
			<span class="n">NCR53c406a_dma_read</span><span class="p">(</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">current_SC</span><span class="p">),</span>
                                            <span class="n">scsdi_bufflen</span><span class="p">(</span><span class="n">current_SC</span><span class="p">));</span>
<span class="cp">#endif				</span><span class="cm">/* USE_DMA */</span><span class="cp"></span>
			<span class="n">outb</span><span class="p">(</span><span class="n">TRANSFER_INFO</span> <span class="o">|</span> <span class="n">DMA_OP</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>
<span class="cp">#if USE_PIO</span>
                        <span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">current_SC</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">current_SC</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">NCR53c406a_pio_read</span><span class="p">(</span><span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
                        <span class="p">}</span>
			<span class="n">REG0</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* USE_PIO */</span><span class="cp"></span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x02</span>:		<span class="cm">/* COMMAND */</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">command_ph</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Warning: Unknown interrupt occurred in command phase!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x03</span>:		<span class="cm">/* STATUS */</span>
		<span class="n">rtrc</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">status_ph</span><span class="p">;</span>
		<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Status phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">FLUSH_FIFO</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">INIT_CMD_COMPLETE</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x04</span>:		<span class="cm">/* Reserved */</span>
	<span class="k">case</span> <span class="mh">0x05</span>:		<span class="cm">/* Reserved */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: WARNING: Reserved phase!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x06</span>:		<span class="cm">/* MESSAGE-OUT */</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Message-Out phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">message_out</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">SET_ATN</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>	<span class="cm">/* Reject the message */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">MSG_ACCEPT</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x07</span>:		<span class="cm">/* MESSAGE-IN */</span>
		<span class="n">rtrc</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;NCR53c406a: Message-In phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">message_in</span><span class="p">;</span>

		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SCSI_FIFO</span><span class="p">);</span>
		<span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SCSI_FIFO</span><span class="p">);</span>

		<span class="n">VDEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSI FIFO size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">FIFO_FLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">));</span>
		<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Status = %02x  Message = %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span><span class="p">,</span> <span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">==</span> <span class="n">SAVE_POINTERS</span> <span class="o">||</span> <span class="n">current_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">==</span> <span class="n">DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">SET_ATN</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>	<span class="cm">/* Reject message */</span>
			<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Discarding SAVE_POINTERS message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">MSG_ACCEPT</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifndef IRQ_LEV</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">irq_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irqs</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">inb</span><span class="p">(</span><span class="n">INT_REG</span><span class="p">);</span>		<span class="cm">/* clear the interrupt register */</span>
	<span class="n">irqs</span> <span class="o">=</span> <span class="n">probe_irq_on</span><span class="p">();</span>

	<span class="cm">/* Invalid command will cause an interrupt */</span>
	<span class="n">REG0</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>

	<span class="cm">/* Wait for the interrupt to occur */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">WATCHDOG</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">STAT_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before_eq</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* Timed out, must be hardware trouble */</span>
		<span class="n">probe_irq_off</span><span class="p">(</span><span class="n">irqs</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">probe_irq_off</span><span class="p">(</span><span class="n">irqs</span><span class="p">);</span>

	<span class="cm">/* Kick the chip */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CHIP_RESET</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SCSI_NOP</span><span class="p">,</span> <span class="n">CMD_REG</span><span class="p">);</span>
	<span class="n">chip_init</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* IRQ_LEV */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">chip_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG1</span><span class="p">;</span>
<span class="cp">#if USE_DMA</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">PIO_STATUS</span><span class="p">);</span>
<span class="cp">#else				</span><span class="cm">/* USE_PIO */</span><span class="cp"></span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">PIO_STATUS</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">PIO_FLAG</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">C4_IMG</span><span class="p">,</span> <span class="n">CONFIG4</span><span class="p">);</span>	<span class="cm">/* REG0; */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">C3_IMG</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">C2_IMG</span><span class="p">,</span> <span class="n">CONFIG2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">C1_IMG</span><span class="p">,</span> <span class="n">CONFIG1</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">CLKCONV</span><span class="p">);</span>	<span class="cm">/* clock conversion factor */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x9C</span><span class="p">,</span> <span class="n">SRTIMOUT</span><span class="p">);</span>	<span class="cm">/* Selection timeout */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">SYNCPRD</span><span class="p">);</span>	<span class="cm">/* Synchronous transfer period */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SYNC_MODE</span><span class="p">,</span> <span class="n">SYNCOFF</span><span class="p">);</span>	<span class="cm">/* synchronous mode */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calc_port_addr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Control Register Set 0 */</span>
	<span class="n">TC_LSB</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">TC_MSB</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">SCSI_FIFO</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">CMD_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">STAT_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">DEST_ID</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">INT_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="n">SRTIMOUT</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="n">SEQ_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">SYNCPRD</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">FIFO_FLAGS</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">SYNCOFF</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">CONFIG1</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">CLKCONV</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x09</span><span class="p">);</span>
	<span class="cm">/* TESTREG          = (port_base+0x0A); */</span>
	<span class="n">CONFIG2</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x0B</span><span class="p">);</span>
	<span class="n">CONFIG3</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x0C</span><span class="p">);</span>
	<span class="n">CONFIG4</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x0D</span><span class="p">);</span>
	<span class="n">TC_HIGH</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x0E</span><span class="p">);</span>
	<span class="cm">/* FIFO_BOTTOM      = (port_base+0x0F); */</span>

	<span class="cm">/* Control Register Set 1 */</span>
	<span class="cm">/* JUMPER_SENSE     = (port_base+0x00); */</span>
	<span class="cm">/* SRAM_PTR         = (port_base+0x01); */</span>
	<span class="cm">/* SRAM_DATA        = (port_base+0x02); */</span>
	<span class="n">PIO_FIFO</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="cm">/* PIO_FIFO1        = (port_base+0x05); */</span>
	<span class="cm">/* PIO_FIFO2        = (port_base+0x06); */</span>
	<span class="cm">/* PIO_FIFO3        = (port_base+0x07); */</span>
	<span class="n">PIO_STATUS</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="cm">/* ATA_CMD          = (port_base+0x09); */</span>
	<span class="cm">/* ATA_ERR          = (port_base+0x0A); */</span>
	<span class="n">PIO_FLAG</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x0B</span><span class="p">);</span>
	<span class="n">CONFIG5</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="mh">0x0D</span><span class="p">);</span>
	<span class="cm">/* SIGNATURE        = (port_base+0x0E); */</span>
	<span class="cm">/* CONFIG6          = (port_base+0x0F); */</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* NOTE:  scatter-gather support only works in PIO mode.</span>
<span class="cm"> * Use SG_NONE if DMA mode is enabled!</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">driver_template</span> <span class="o">=</span>
<span class="p">{</span>
     <span class="p">.</span><span class="n">proc_name</span>         	<span class="o">=</span> <span class="s">&quot;NCR53c406a&quot;</span>		<span class="cm">/* proc_name */</span><span class="p">,</span>        
     <span class="p">.</span><span class="n">name</span>              	<span class="o">=</span> <span class="s">&quot;NCR53c406a&quot;</span>		<span class="cm">/* name */</span><span class="p">,</span>             
     <span class="p">.</span><span class="n">detect</span>            	<span class="o">=</span> <span class="n">NCR53c406a_detect</span>	<span class="cm">/* detect */</span><span class="p">,</span>           
     <span class="p">.</span><span class="n">release</span>            	<span class="o">=</span> <span class="n">NCR53c406a_release</span><span class="p">,</span>
     <span class="p">.</span><span class="n">info</span>              	<span class="o">=</span> <span class="n">NCR53c406a_info</span>		<span class="cm">/* info */</span><span class="p">,</span>             
     <span class="p">.</span><span class="n">queuecommand</span>      	<span class="o">=</span> <span class="n">NCR53c406a_queue</span>	<span class="cm">/* queuecommand */</span><span class="p">,</span>     
     <span class="p">.</span><span class="n">eh_host_reset_handler</span>     <span class="o">=</span> <span class="n">NCR53c406a_host_reset</span>	<span class="cm">/* reset */</span><span class="p">,</span>            
     <span class="p">.</span><span class="n">bios_param</span>        	<span class="o">=</span> <span class="n">NCR53c406a_biosparm</span>	<span class="cm">/* biosparm */</span><span class="p">,</span>         
     <span class="p">.</span><span class="n">can_queue</span>         	<span class="o">=</span> <span class="mi">1</span>			<span class="cm">/* can_queue */</span><span class="p">,</span>        
     <span class="p">.</span><span class="n">this_id</span>           	<span class="o">=</span> <span class="mi">7</span>			<span class="cm">/* SCSI ID of the chip */</span><span class="p">,</span>
     <span class="p">.</span><span class="n">sg_tablesize</span>      	<span class="o">=</span> <span class="mi">32</span>			<span class="cm">/*SG_ALL*/</span> <span class="cm">/*SG_NONE*/</span><span class="p">,</span> 
     <span class="p">.</span><span class="n">cmd_per_lun</span>       	<span class="o">=</span> <span class="mi">1</span>			<span class="cm">/* commands per lun */</span><span class="p">,</span> 
     <span class="p">.</span><span class="n">unchecked_isa_dma</span> 	<span class="o">=</span> <span class="mi">1</span>			<span class="cm">/* unchecked_isa_dma */</span><span class="p">,</span>
     <span class="p">.</span><span class="n">use_clustering</span>    	<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#include &quot;scsi_module.c&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Overrides for Emacs so that we get a uniform tabbing style.</span>
<span class="cm"> * Emacs will notice this stuff at the end of the file and automatically</span>
<span class="cm"> * adjust the settings for this buffer only.  This must remain at the end</span>
<span class="cm"> * of the file.</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-indent-level: 4</span>
<span class="cm"> * c-brace-imaginary-offset: 0</span>
<span class="cm"> * c-brace-offset: -4</span>
<span class="cm"> * c-argdecl-indent: 4</span>
<span class="cm"> * c-label-offset: -4</span>
<span class="cm"> * c-continued-statement-offset: 4</span>
<span class="cm"> * c-continued-brace-offset: 0</span>
<span class="cm"> * indent-tabs-mode: nil</span>
<span class="cm"> * tab-width: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
