<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › net › claw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>claw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/s390/net/claw.c</span>
<span class="cm"> *    ESCON CLAW network driver</span>
<span class="cm"> *</span>
<span class="cm"> *  Linux for zSeries version</span>
<span class="cm"> *    Copyright IBM Corp. 2002, 2009</span>
<span class="cm"> *  Author(s) Original code written by:</span>
<span class="cm"> *		Kazuo Iimura &lt;iimura@jp.ibm.com&gt;</span>
<span class="cm"> *   	      Rewritten by</span>
<span class="cm"> *		Andy Richter &lt;richtera@us.ibm.com&gt;</span>
<span class="cm"> *		Marc Price &lt;mwprice@us.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *    sysfs parms:</span>
<span class="cm"> *   group x.x.rrrr,x.x.wwww</span>
<span class="cm"> *   read_buffer nnnnnnn</span>
<span class="cm"> *   write_buffer nnnnnn</span>
<span class="cm"> *   host_name  aaaaaaaa</span>
<span class="cm"> *   adapter_name aaaaaaaa</span>
<span class="cm"> *   api_type    aaaaaaaa</span>
<span class="cm"> *</span>
<span class="cm"> *  eg.</span>
<span class="cm"> *   group  0.0.0200 0.0.0201</span>
<span class="cm"> *   read_buffer 25</span>
<span class="cm"> *   write_buffer 20</span>
<span class="cm"> *   host_name LINUX390</span>
<span class="cm"> *   adapter_name RS6K</span>
<span class="cm"> *   api_type     TCPIP</span>
<span class="cm"> *</span>
<span class="cm"> *  where</span>
<span class="cm"> *</span>
<span class="cm"> *   The device id is decided by the order entries</span>
<span class="cm"> *   are added to the group the first is claw0 the second claw1</span>
<span class="cm"> *   up to CLAW_MAX_DEV</span>
<span class="cm"> *</span>
<span class="cm"> *   rrrr     -	the first of 2 consecutive device addresses used for the</span>
<span class="cm"> *		CLAW protocol.</span>
<span class="cm"> *		The specified address is always used as the input (Read)</span>
<span class="cm"> *		channel and the next address is used as the output channel.</span>
<span class="cm"> *</span>
<span class="cm"> *   wwww     -	the second of 2 consecutive device addresses used for</span>
<span class="cm"> *		the CLAW protocol.</span>
<span class="cm"> *              The specified address is always used as the output</span>
<span class="cm"> *		channel and the previous address is used as the input channel.</span>
<span class="cm"> *</span>
<span class="cm"> *   read_buffer	-       specifies number of input buffers to allocate.</span>
<span class="cm"> *   write_buffer       -       specifies number of output buffers to allocate.</span>
<span class="cm"> *   host_name          -       host name</span>
<span class="cm"> *   adaptor_name       -       adaptor name</span>
<span class="cm"> *   api_type           -       API type TCPIP or API will be sent and expected</span>
<span class="cm"> *				as ws_name</span>
<span class="cm"> *</span>
<span class="cm"> *   Note the following requirements:</span>
<span class="cm"> *   1)  host_name must match the configured adapter_name on the remote side</span>
<span class="cm"> *   2)  adaptor_name must match the configured host name on the remote side</span>
<span class="cm"> *</span>
<span class="cm"> *  Change History</span>
<span class="cm"> *    1.00  Initial release shipped</span>
<span class="cm"> *    1.10  Changes for Buffer allocation</span>
<span class="cm"> *    1.15  Changed for 2.6 Kernel  No longer compiles on 2.4 or lower</span>
<span class="cm"> *    1.25  Added Packing support</span>
<span class="cm"> *    1.5</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;claw&quot;</span>

<span class="cp">#include &lt;asm/ccwdev.h&gt;</span>
<span class="cp">#include &lt;asm/ccwgroup.h&gt;</span>
<span class="cp">#include &lt;asm/debug.h&gt;</span>
<span class="cp">#include &lt;asm/idals.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#include &quot;claw.h&quot;</span>

<span class="cm">/*</span>
<span class="cm">   CLAW uses the s390dbf file system  see claw_trace and claw_setup</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="s">&quot;CLAW driver&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">debug_buffer</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
<span class="cm">/**</span>
<span class="cm"> * Debug Facility Stuff</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">debug_info_t</span> <span class="o">*</span><span class="n">claw_dbf_setup</span><span class="p">;</span>
<span class="k">static</span> <span class="n">debug_info_t</span> <span class="o">*</span><span class="n">claw_dbf_trace</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> *  CLAW Debug Facility functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_unregister_debug_facility</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">claw_dbf_setup</span><span class="p">)</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">claw_dbf_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">claw_dbf_trace</span><span class="p">)</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">claw_dbf_trace</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_register_debug_facility</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">claw_dbf_setup</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="s">&quot;claw_setup&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">claw_dbf_trace</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="s">&quot;claw_trace&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">claw_dbf_setup</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">claw_dbf_trace</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">claw_unregister_debug_facility</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">claw_dbf_setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">claw_dbf_setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">claw_dbf_trace</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">claw_dbf_trace</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">claw_set_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
 <span class="p">((</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tbusy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">claw_clear_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(((</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tbusy</span><span class="p">));</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">claw_check_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tbusy</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">claw_setbit_busy</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(((</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tbusy</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">claw_clearbit_busy</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(((</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tbusy</span><span class="p">));</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">claw_test_and_setbit_busy</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(((</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tbusy</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/* Functions for the DEV methods */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">claw_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">claw_purge_skb_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">q</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_new_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_shutdown_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_change_mtu</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">claw_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">intparm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">claw_irq_tasklet</span> <span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">claw_write_retry</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span> <span class="n">p_ch</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">claw_write_next</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span> <span class="n">p_ch</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">claw_timer</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span> <span class="n">p_ch</span> <span class="p">);</span>

<span class="cm">/* Functions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">add_claw_reads</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span> <span class="n">p_first</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span> <span class="n">p_last</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ccw_check_return_code</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">return_code</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ccw_check_unit_check</span> <span class="p">(</span><span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span> <span class="n">p_ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sense</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">find_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host_name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ws_name</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_hw_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">long</span> <span class="n">linkid</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">init_ccw_bk</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">probe_error</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">claw_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pages_to_order_of_mag</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_of_pages</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">claw_pack_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">);</span>
<span class="cm">/* sysfs Functions */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">claw_hname_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">claw_hname_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">claw_adname_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">claw_adname_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">claw_apname_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">claw_apname_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">claw_wbuff_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">claw_wbuff_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">claw_rbuff_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">claw_rbuff_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>

<span class="cm">/*   Functions for System Validate  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_process_control</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ccwbk</span> <span class="o">*</span> <span class="n">p_ccw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_send_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">link</span><span class="p">,</span>
       <span class="n">__u8</span> <span class="n">correlator</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">rc</span> <span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">local_name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">remote_name</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_snd_conn_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_snd_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">clawctl</span> <span class="o">*</span> <span class="n">p_ctl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_snd_sys_validate_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
        <span class="k">struct</span> <span class="n">clawctl</span> <span class="o">*</span> <span class="n">p_ctl</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">return_code</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">claw_strt_conn_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">claw_strt_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">claw_strt_out_IO</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">claw_free_wrt_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* Functions for unpack reads   */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">unpack_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">claw_pm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* the root device for claw group devices */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">claw_root_dev</span><span class="p">;</span>

<span class="cm">/* ccwgroup table  */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccwgroup_driver</span> <span class="n">claw_group_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;claw&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">setup</span>	     <span class="o">=</span> <span class="n">claw_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>      <span class="o">=</span> <span class="n">claw_remove_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_online</span>  <span class="o">=</span> <span class="n">claw_new_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_offline</span> <span class="o">=</span> <span class="n">claw_shutdown_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>     <span class="o">=</span> <span class="n">claw_pm_prepare</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_device_id</span> <span class="n">claw_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">CCW_DEVICE</span><span class="p">(</span><span class="mh">0x3088</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">claw_channel_type_claw</span><span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">claw_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_driver</span> <span class="n">claw_ccw_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;claw&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ids</span>	<span class="o">=</span> <span class="n">claw_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">ccwgroup_probe_ccwdev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">ccwgroup_remove_ccwdev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">int_class</span> <span class="o">=</span> <span class="n">IOINT_CLW</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">claw_driver_group_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddrv</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>	<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ccwgroup_create_dev</span><span class="p">(</span><span class="n">claw_root_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">claw_group_driver</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">claw_driver_group_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">claw_drv_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">driver_attr_group</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">claw_drv_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">claw_drv_attrs</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">claw_drv_attr_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">claw_drv_attr_group</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">*       Key functions</span>
<span class="cm">*/</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm"> *   claw_tx                                                         *</span>
<span class="cm"> *-------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span>             <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saveflags</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span><span class="n">p_ch</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;claw_tx&quot;</span><span class="p">);</span>
	<span class="n">p_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">];</span>
        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>
        <span class="n">rc</span><span class="o">=</span><span class="n">claw_hw_tx</span><span class="p">(</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>
	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;clawtx%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>   <span class="cm">/*  end of claw_tx */</span>

<span class="cm">/*------------------------------------------------------------------*</span>
<span class="cm"> *  pack the collect queue into an skb and return it                *</span>
<span class="cm"> *   If not packing just return the top skb from the queue          *</span>
<span class="cm"> *------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">claw_pack_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">,</span><span class="o">*</span><span class="n">held_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span><span class="n">p_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">claw_env</span>  <span class="o">*</span><span class="n">p_env</span> <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">pkt_cnt</span><span class="p">,</span><span class="n">pk_ind</span><span class="p">,</span><span class="n">so_far</span><span class="p">;</span>

	<span class="n">new_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>		<span class="cm">/* assume no dice */</span>
	<span class="n">pkt_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;PackSKBe&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">))</span> <span class="p">{</span>
	<span class="cm">/* some data */</span>
		<span class="n">held_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">held_skb</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">held_skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">!=</span> <span class="n">DO_PACKED</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">held_skb</span><span class="p">;</span>
		<span class="cm">/* get a new SKB we will pack at least one */</span>
		<span class="n">new_skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">held_skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
			<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">,</span><span class="n">held_skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* we have packed packet and a place to put it  */</span>
		<span class="n">pk_ind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">so_far</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;P&#39;</span><span class="p">;</span> <span class="cm">/* every skb on queue has pack header */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">pk_ind</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">held_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">held_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">+</span><span class="n">so_far</span> <span class="o">&lt;=</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span><span class="n">held_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
					<span class="n">held_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">held_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">so_far</span> <span class="o">+=</span> <span class="n">held_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="n">pkt_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">held_skb</span><span class="p">);</span>
				<span class="n">held_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">held_skb</span><span class="p">)</span>
					<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">held_skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pk_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">held_skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
				<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">,</span><span class="n">held_skb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;PackSKBx&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">new_skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm"> *   claw_change_mtu                                                 *</span>
<span class="cm"> *                                                                   *</span>
<span class="cm"> *-------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buff_size</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;setmtu&quot;</span><span class="p">);</span>
	<span class="n">buff_size</span> <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">buff_size</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>  <span class="cm">/*   end of claw_change_mtu */</span>


<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm"> *   claw_open                                                       *</span>
<span class="cm"> *                                                                   *</span>
<span class="cm"> *-------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

        <span class="kt">int</span>     <span class="n">rc</span><span class="p">;</span>
        <span class="kt">int</span>     <span class="n">i</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span>       <span class="n">saveflags</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span>       <span class="n">parm</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">claw_privbk</span>  <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">timer_list</span>  <span class="n">timer</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccwbk</span> <span class="o">*</span><span class="n">p_buf</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;open&quot;</span><span class="p">);</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
        <span class="cm">/*   allocate and initialize CCW blocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">buffs_alloc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">rc</span><span class="o">=</span><span class="n">init_ccw_bk</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;openmem&quot;</span><span class="p">);</span>
                	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
        	<span class="p">}</span>
	<span class="p">}</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">system_validate_comp</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">release_pend</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span><span class="p">,</span><span class="n">WS_APPL_NAME_PACKED</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="o">=</span><span class="n">DEF_PACK_BUFSIZE</span><span class="p">;</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="o">=</span><span class="n">DEF_PACK_BUFSIZE</span><span class="p">;</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span><span class="o">=</span><span class="n">PACKING_ASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="o">=</span><span class="n">CLAW_FRAME_SIZE</span><span class="p">;</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="o">=</span><span class="n">CLAW_FRAME_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="n">claw_set_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">claw_irq_tasklet</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">]);</span>
        <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span>  <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;opn_ch%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait</span><span class="p">);</span>
		<span class="cm">/* skb_queue_head_init(&amp;p_ch-&gt;io_queue); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">WRITE_CHANNEL</span><span class="p">)</span>
			<span class="n">skb_queue_head_init</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">].</span><span class="n">collect_queue</span><span class="p">);</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">IO_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span>  <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLAW_TIMER</span><span class="p">;</span>
                <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
                <span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">claw_timer</span><span class="p">;</span>
                <span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">15</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
                <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
                <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">claw_state</span> <span class="o">=</span> <span class="n">CLAW_START_HALT_IO</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_halt</span><span class="p">(</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">,</span><span class="n">parm</span><span class="p">);</span>
                <span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span>
			<span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>
                <span class="n">schedule</span><span class="p">();</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
                <span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">ccw_check_return_code</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
                <span class="k">if</span><span class="p">((</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">CLAW_TIMER</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
                        <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
        <span class="p">}</span>
	<span class="k">if</span> <span class="p">((((</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">last_dstat</span> <span class="o">|</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">].</span><span class="n">last_dstat</span><span class="p">)</span> <span class="o">&amp;</span>
           <span class="o">~</span><span class="p">(</span><span class="n">DEV_STAT_CHN_END</span> <span class="o">|</span> <span class="n">DEV_STAT_DEV_END</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(((</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">flag</span> <span class="o">|</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">].</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CLAW_TIMER</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: remote side is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;notrdy&quot;</span><span class="p">);</span>

                <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span>  <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">spin_lock_irqsave</span><span class="p">(</span>
				<span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">),</span>
				<span class="n">saveflags</span><span class="p">);</span>
                        <span class="n">parm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">claw_state</span> <span class="o">=</span> <span class="n">CLAW_STOP</span><span class="p">;</span>
                        <span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_halt</span><span class="p">(</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">,</span>
				<span class="n">parm</span><span class="p">);</span>
                        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span>
				<span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">),</span>
				<span class="n">saveflags</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">ccw_check_return_code</span><span class="p">(</span>
					<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw_num</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
			       		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read_num</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                        <span class="n">p_buf</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_first</span><span class="p">;</span>
                        <span class="k">while</span> <span class="p">(</span><span class="n">p_buf</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">,</span>
				      <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
				      	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perread</span> <span class="p">));</span>
                                <span class="n">p_buf</span><span class="o">=</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
			     	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write_num</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                        <span class="n">p_buf</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="p">;</span>
                        <span class="k">while</span> <span class="p">(</span><span class="n">p_buf</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
				     	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perwrite</span> <span class="p">));</span>
                                <span class="n">p_buf</span><span class="o">=</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">buffs_alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">flag</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">].</span><span class="n">flag</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
                <span class="n">claw_clear_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;open EIO&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*   Send SystemValidate command */</span>

        <span class="n">claw_clear_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;openok&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>    <span class="cm">/*     end of claw_open    */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*       claw_irq_handler                                             *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">intparm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span><span class="n">p_ch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">claw_env</span>  <span class="o">*</span><span class="n">p_env</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span><span class="n">p_ch_r</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;clawirq&quot;</span><span class="p">);</span>
        <span class="cm">/* Bypass all &#39;unsolicited interrupts&#39; */</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">privptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;An uninitialized CLAW device received an&quot;</span>
			<span class="s">&quot; IRQ, c-%02x d-%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span><span class="p">,</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span><span class="p">);</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;badirq&quot;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="cm">/* Try to extract channel from driver data. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">cdev</span> <span class="o">==</span> <span class="n">cdev</span><span class="p">)</span>
		<span class="n">p_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">].</span><span class="n">cdev</span> <span class="o">==</span> <span class="n">cdev</span><span class="p">)</span>
		<span class="n">p_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">];</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The device is not a CLAW device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;badchan&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;IRQCH=%d&quot;</span><span class="p">,</span> <span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
        <span class="n">p_env</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>

	<span class="cm">/* Copy interruption response block. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irb</span><span class="p">));</span>

	<span class="cm">/* Check for good subchannel return code, otherwise info message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span> <span class="o">&amp;</span> <span class="n">SCHN_STAT_PCI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: subchannel check for device: %04x -&quot;</span>
			<span class="s">&quot; Sch Stat %02x  Dev Stat %02x CPA - %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">,</span>
			<span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span><span class="p">,</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span><span class="p">,</span>
			<span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span><span class="p">);</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;chanchk&quot;</span><span class="p">);</span>
                <span class="cm">/* return; */</span>
        <span class="p">}</span>

        <span class="cm">/* Check the reason-code of a unit check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span>
                <span class="n">ccw_check_unit_check</span><span class="p">(</span><span class="n">p_ch</span><span class="p">,</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

        <span class="cm">/* State machine to bring the connection up, down and to restart */</span>
	<span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">last_dstat</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">claw_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLAW_STOP</span>:<span class="cm">/* HALT_IO by claw_release (halt sequence) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">&amp;</span> <span class="n">SCSW_STCTL_SEC_STATUS</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">==</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">==</span>
		<span class="p">(</span><span class="n">SCSW_STCTL_ALERT_STATUS</span> <span class="o">|</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">))))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>   <span class="cm">/* wake up claw_release */</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;stop&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLAW_START_HALT_IO</span>: <span class="cm">/* HALT_IO issued by claw_open  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">&amp;</span> <span class="n">SCSW_STCTL_SEC_STATUS</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">==</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">==</span>
		<span class="p">(</span><span class="n">SCSW_STCTL_ALERT_STATUS</span> <span class="o">|</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;haltio&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">==</span> <span class="n">CLAW_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">claw_state</span> <span class="o">=</span> <span class="n">CLAW_START_READ</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span> <span class="cm">/* wake claw_open (READ)*/</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">==</span> <span class="n">CLAW_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">claw_state</span> <span class="o">=</span> <span class="n">CLAW_START_WRITE</span><span class="p">;</span>
			<span class="cm">/*      send SYSTEM_VALIDATE                    */</span>
			<span class="n">claw_strt_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCK_NO</span><span class="p">);</span>
			<span class="n">claw_send_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">SYSTEM_VALIDATE_REQUEST</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span>
				<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The CLAW device received&quot;</span>
				<span class="s">&quot; an unexpected IRQ, &quot;</span>
				<span class="s">&quot;c-%02x d-%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span><span class="p">,</span>
				<span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;haltio&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLAW_START_READ</span>:
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;ReadIRQ&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">IO_active</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x41</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x41</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>        <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s: Restart is required after remote &quot;</span>
					<span class="s">&quot;side recovers </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;notrdy&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span> <span class="o">&amp;</span> <span class="n">SCHN_STAT_PCI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">CLAW_BH_ACTIVE</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">flag_a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;PCINoBH&quot;</span><span class="p">);</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;PCI_read&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">&amp;</span> <span class="n">SCSW_STCTL_SEC_STATUS</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">==</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">==</span>
		 <span class="p">(</span><span class="n">SCSW_STCTL_ALERT_STATUS</span> <span class="o">|</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;SPend_rd&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">IO_active</span><span class="p">);</span>
		<span class="n">claw_clearbit_busy</span><span class="p">(</span><span class="n">TB_RETRY</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">CLAW_BH_ACTIVE</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">flag_a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;RdBHAct&quot;</span><span class="p">);</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;RdIRQXit&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLAW_START_WRITE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: Unit Check Occurred in &quot;</span>
				<span class="s">&quot;write channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">IO_active</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s: Resetting Event &quot;</span>
					<span class="s">&quot;occurred:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
				<span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span>
					<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">claw_write_retry</span><span class="p">;</span>
				<span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p_ch</span><span class="p">;</span>
				<span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
				<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s: write connection &quot;</span>
					<span class="s">&quot;restarting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;rstrtwrt&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_EXCEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">IO_active</span><span class="p">);</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: Unit Exception &quot;</span>
				<span class="s">&quot;occurred in write channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">&amp;</span> <span class="n">SCSW_STCTL_SEC_STATUS</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">==</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">==</span>
		<span class="p">(</span><span class="n">SCSW_STCTL_ALERT_STATUS</span> <span class="o">|</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;writeUE&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">IO_active</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">claw_test_and_setbit_busy</span><span class="p">(</span><span class="n">TB_TX</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">claw_write_next</span><span class="p">(</span><span class="n">p_ch</span><span class="p">);</span>
			<span class="n">claw_clearbit_busy</span><span class="p">(</span><span class="n">TB_TX</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">claw_clear_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">p_ch_r</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">CLAW_BH_ACTIVE</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ch_r</span><span class="o">-&gt;</span><span class="n">flag_a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch_r</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;StWtExit&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The CLAW device for %s received an unexpected IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;badIRQ&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

<span class="p">}</span>       <span class="cm">/*   end of claw_irq_handler    */</span>


<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*       claw_irq_tasklet                                             *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_irq_tasklet</span> <span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span> <span class="n">p_ch</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">p_ch</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;IRQtask&quot;</span><span class="p">);</span>
        <span class="n">unpack_read</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">clear_bit</span><span class="p">(</span><span class="n">CLAW_BH_ACTIVE</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">flag_a</span><span class="p">);</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;TskletXt&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>       <span class="cm">/*    end of claw_irq_bh    */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*       claw_release                                                 *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span>                <span class="n">rc</span><span class="p">;</span>
        <span class="kt">int</span>                <span class="n">i</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span>      <span class="n">saveflags</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span>      <span class="n">parm</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
        <span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span>             <span class="n">p_this_ccw</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span>             <span class="n">p_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">privptr</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;release&quot;</span><span class="p">);</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">release_pend</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">claw_setbit_busy</span><span class="p">(</span><span class="n">TB_STOP</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span><span class="mi">0</span> <span class="p">;</span>  <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">spin_lock_irqsave</span><span class="p">(</span>
			<span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>
	     <span class="cm">/*   del_timer(&amp;privptr-&gt;channel[READ_CHANNEL].timer);  */</span>
 		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">claw_state</span> <span class="o">=</span> <span class="n">CLAW_STOP</span><span class="p">;</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">IO_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">WRITE_CHANNEL</span><span class="p">)</span>
			<span class="n">claw_purge_skb_queue</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">].</span><span class="n">collect_queue</span><span class="p">);</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_halt</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
	        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">system_validate_comp</span><span class="o">==</span><span class="mh">0x00</span><span class="p">)</span>  <span class="cm">/* never opened? */</span>
                   <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait</span><span class="p">);</span>
                <span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
                <span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span>
			<span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>
	        <span class="n">schedule</span><span class="p">();</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	        <span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">ccw_check_return_code</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">pk_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">pk_skb</span><span class="p">);</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">pk_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">buffs_alloc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;none2fre&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;freebufs&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="p">,</span>
	        	<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw_num</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;freeread&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read_num</span><span class="p">));</span>
		<span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
                <span class="n">p_buf</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_first</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">p_buf</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
			     	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perread</span> <span class="p">));</span>
                        <span class="n">p_buf</span><span class="o">=</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
	 <span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;freewrit&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write_num</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
                <span class="n">p_buf</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">p_buf</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
			      <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perwrite</span> <span class="p">));</span>
                        <span class="n">p_buf</span><span class="o">=</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
	 <span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;clearptr&quot;</span><span class="p">);</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">buffs_alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">system_validate_comp</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">release_pend</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="cm">/*      Remove any writes that were pending and reset all reads   */</span>
        <span class="n">p_this_ccw</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_first</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">p_this_ccw</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
                <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">opcode</span><span class="o">=</span><span class="mh">0xff</span><span class="p">;</span>
                <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="o">=</span><span class="mh">0x00</span><span class="p">;</span>
                <span class="n">p_this_ccw</span><span class="o">=</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">p_this_ccw</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="p">;</span>
                <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="o">=</span><span class="n">CLAW_PENDING</span><span class="p">;</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="o">=</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span><span class="p">;</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span><span class="o">=</span><span class="n">p_this_ccw</span><span class="p">;</span>
                <span class="o">++</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_last</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_logical_link</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_skipping</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">last_dstat</span> <span class="o">|</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">].</span><span class="n">last_dstat</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="n">DEV_STAT_CHN_END</span> <span class="o">|</span> <span class="n">DEV_STAT_DEV_END</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Deactivating %s completed with incorrect&quot;</span>
			<span class="s">&quot; subchannel status &quot;</span>
			<span class="s">&quot;(read %02x, write %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">last_dstat</span><span class="p">,</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">].</span><span class="n">last_dstat</span><span class="p">);</span>
		 <span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;badclose&quot;</span><span class="p">);</span>
        <span class="p">}</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;rlsexit&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>      <span class="cm">/* end of claw_release     */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*       claw_write_retry                                             *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_write_retry</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span><span class="n">p_ch</span> <span class="p">)</span>
<span class="p">{</span>

        <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="o">=</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;w_retry&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">claw_state</span> <span class="o">==</span> <span class="n">CLAW_STOP</span><span class="p">)</span> <span class="p">{</span>
        	<span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">claw_strt_out_IO</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;rtry_xit&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>      <span class="cm">/* end of claw_write_retry      */</span>


<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*       claw_write_next                                              *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_write_next</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span> <span class="n">p_ch</span> <span class="p">)</span>
<span class="p">{</span>

        <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pk_skb</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;claw_wrt&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">claw_state</span> <span class="o">==</span> <span class="n">CLAW_STOP</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
        <span class="n">claw_free_wrt_buf</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">))</span> <span class="p">{</span>
	  	<span class="n">pk_skb</span> <span class="o">=</span> <span class="n">claw_pack_skb</span><span class="p">(</span><span class="n">privptr</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pk_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">claw_hw_tx</span><span class="p">(</span><span class="n">pk_skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	   			<span class="n">pk_skb</span> <span class="o">=</span> <span class="n">claw_pack_skb</span><span class="p">(</span><span class="n">privptr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">pk_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">claw_strt_out_IO</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>      <span class="cm">/* end of claw_write_next      */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*       claw_timer                                                   *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_timer</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span> <span class="n">p_ch</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;timer&quot;</span><span class="p">);</span>
        <span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">CLAW_TIMER</span><span class="p">;</span>
        <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>      <span class="cm">/* end of claw_timer  */</span>

<span class="cm">/*</span>
<span class="cm">*</span>
<span class="cm">*       functions</span>
<span class="cm">*/</span>


<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*     pages_to_order_of_mag                                          *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*    takes a number of pages from 1 to 512 and returns the           *</span>
<span class="cm">*    log(num_pages)/log(2) get_free_pages() needs a base 2 order     *</span>
<span class="cm">*    of magnitude get_free_pages() has an upper order of 9           *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pages_to_order_of_mag</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_of_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">order_of_mag</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* assume 2 pages */</span>
	<span class="kt">int</span>	<span class="n">nump</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;pages%d&quot;</span><span class="p">,</span> <span class="n">num_of_pages</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_of_pages</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>   <span class="p">{</span><span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>  <span class="cm">/* magnitude of 0 = 1 page */</span>
	<span class="cm">/* 512 pages = 2Meg on 4k page systems */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_of_pages</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="mi">9</span><span class="p">;</span> <span class="p">}</span>
	<span class="cm">/* we have two or more pages order is at least 1 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">nump</span><span class="o">=</span><span class="mi">2</span> <span class="p">;</span><span class="n">nump</span> <span class="o">&lt;=</span> <span class="mi">512</span><span class="p">;</span><span class="n">nump</span><span class="o">*=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">num_of_pages</span> <span class="o">&lt;=</span> <span class="n">nump</span><span class="p">)</span>
		  <span class="k">break</span><span class="p">;</span>
	  <span class="n">order_of_mag</span> <span class="o">+=</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">order_of_mag</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span> <span class="n">order_of_mag</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="p">}</span>  <span class="cm">/* I know it&#39;s paranoid */</span>
	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;mag%d&quot;</span><span class="p">,</span> <span class="n">order_of_mag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">order_of_mag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*     add_claw_reads                                                 *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">add_claw_reads</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span> <span class="n">p_first</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span> <span class="n">p_last</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccw1</span>  <span class="n">temp_ccw</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">endccw</span> <span class="o">*</span> <span class="n">p_end</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;addreads&quot;</span><span class="p">);</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
        <span class="n">p_end</span> <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_end_ccw</span><span class="p">;</span>

        <span class="cm">/* first CCW and last CCW contains a new set of read channel programs</span>
<span class="cm">        *       to apend the running channel programs</span>
<span class="cm">        */</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">p_first</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;addexit&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* set up ending CCW sequence for this segment */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read1</span><span class="o">=</span><span class="mh">0x00</span><span class="p">;</span>    <span class="cm">/*  second ending CCW is now active */</span>
                <span class="cm">/*      reset ending CCWs and setup TIC CCWs              */</span>
                <span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read2_nop2</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READFF</span><span class="p">;</span>
                <span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read2_nop2</span><span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_SKIP</span><span class="p">;</span>
                <span class="n">p_last</span><span class="o">-&gt;</span><span class="n">r_TIC_1</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span><span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read2_nop1</span><span class="p">);</span>
                <span class="n">p_last</span><span class="o">-&gt;</span><span class="n">r_TIC_2</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span><span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read2_nop1</span><span class="p">);</span>
                <span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read2_nop2</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                <span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read2_nop2</span><span class="p">.</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
                <span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read1</span><span class="o">=</span><span class="mh">0x01</span><span class="p">;</span>  <span class="cm">/* first ending CCW is now active */</span>
                <span class="cm">/*      reset ending CCWs and setup TIC CCWs          */</span>
                <span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read1_nop2</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READFF</span><span class="p">;</span>
                <span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read1_nop2</span><span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_SKIP</span><span class="p">;</span>
                <span class="n">p_last</span><span class="o">-&gt;</span><span class="n">r_TIC_1</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read1_nop1</span><span class="p">);</span>
                <span class="n">p_last</span><span class="o">-&gt;</span><span class="n">r_TIC_2</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read1_nop1</span><span class="p">);</span>
                <span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read1_nop2</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                <span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read1_nop2</span><span class="p">.</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">privptr</span><span class="o">-&gt;</span> <span class="n">p_read_active_first</span> <span class="o">==</span><span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_first</span> <span class="o">=</span> <span class="n">p_first</span><span class="p">;</span>  <span class="cm">/*  set new first */</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_last</span>  <span class="o">=</span> <span class="n">p_last</span><span class="p">;</span>   <span class="cm">/*  set new last  */</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>

                <span class="cm">/* set up TIC ccw  */</span>
                <span class="n">temp_ccw</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_first</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
                <span class="n">temp_ccw</span><span class="p">.</span><span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                <span class="n">temp_ccw</span><span class="p">.</span><span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                <span class="n">temp_ccw</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_TIC</span><span class="p">;</span>


                <span class="k">if</span> <span class="p">(</span><span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read1</span><span class="p">)</span> <span class="p">{</span>

               <span class="cm">/* first set of CCW&#39;s is chained to the new read              */</span>
               <span class="cm">/* chain, so the second set is chained to the active chain.   */</span>
               <span class="cm">/* Therefore modify the second set to point to the new        */</span>
               <span class="cm">/* read chain set up TIC CCWs                                 */</span>
               <span class="cm">/* make sure we update the CCW so channel doesn&#39;t fetch it    */</span>
               <span class="cm">/* when it&#39;s only half done                                   */</span>
                        <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read2_nop2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_ccw</span> <span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_last</span><span class="o">-&gt;</span><span class="n">r_TIC_1</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_first</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_last</span><span class="o">-&gt;</span><span class="n">r_TIC_2</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_first</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                        <span class="cm">/* make sure we update the CCW so channel doesn&#39;t   */</span>
			<span class="cm">/* fetch it when it is only half done               */</span>
                        <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">p_end</span><span class="o">-&gt;</span><span class="n">read1_nop2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_ccw</span> <span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_last</span><span class="o">-&gt;</span><span class="n">r_TIC_1</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_first</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_last</span><span class="o">-&gt;</span><span class="n">r_TIC_2</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_first</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
                <span class="p">}</span>
		<span class="cm">/*      chain in new set of blocks                         */</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_last</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">p_first</span><span class="p">;</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_last</span><span class="o">=</span><span class="n">p_last</span><span class="p">;</span>
        <span class="p">}</span> <span class="cm">/* end of if ( privptr-&gt; p_read_active_first ==NULL)  */</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;addexit&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>    <span class="cm">/*     end of add_claw_reads   */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm"> *   ccw_check_return_code                                           *</span>
<span class="cm"> *                                                                   *</span>
<span class="cm"> *-------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_check_return_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">return_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;ccwret&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">return_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">return_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EBUSY</span>: <span class="cm">/* BUSY is a transient state no action needed */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The remote channel adapter is not&quot;</span>
				<span class="s">&quot; available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EINVAL</span>:
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;The status of the remote channel adapter&quot;</span>
				<span class="s">&quot; is not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The common device layer&quot;</span>
				<span class="s">&quot; returned error code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">return_code</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;ccwret&quot;</span><span class="p">);</span>
<span class="p">}</span>    <span class="cm">/*    end of ccw_check_return_code   */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*       ccw_check_unit_check                                         *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_check_unit_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span> <span class="n">p_ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sense</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;unitchek&quot;</span><span class="p">);</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The communication peer of %s disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The remote channel adapter for&quot;</span>
				<span class="s">&quot; %s has been reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A data streaming timeout occurred&quot;</span>
				<span class="s">&quot; for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The remote channel adapter for %s&quot;</span>
				<span class="s">&quot; is faulty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A data transfer parity error occurred&quot;</span>
				<span class="s">&quot; for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A read data parity error occurred&quot;</span>
			<span class="s">&quot; for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>   <span class="cm">/*    end of ccw_check_unit_check    */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*               find_link                                            *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">find_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host_name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ws_name</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span><span class="n">p_env</span><span class="p">;</span>
	<span class="kt">int</span>    <span class="n">rc</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;findlink&quot;</span><span class="p">);</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
        <span class="n">p_env</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span>  <span class="n">PACKING_ASK</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">memcmp</span><span class="p">(</span><span class="n">WS_APPL_NAME_PACKED</span><span class="p">,</span> <span class="n">host_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">WS_APPL_NAME_PACKED</span><span class="p">,</span> <span class="n">ws_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="p">))</span>
        	             <span class="n">rc</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span>  <span class="n">DO_PACKED</span>:
		<span class="k">case</span>  <span class="n">PACK_SEND</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">memcmp</span><span class="p">(</span><span class="n">WS_APPL_NAME_IP_NAME</span><span class="p">,</span> <span class="n">host_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">WS_APPL_NAME_IP_NAME</span><span class="p">,</span> <span class="n">ws_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="p">))</span>
        	        	<span class="n">rc</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
	       		<span class="k">if</span> <span class="p">((</span><span class="n">memcmp</span><span class="p">(</span><span class="n">HOST_APPL_NAME</span><span class="p">,</span> <span class="n">host_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    	    <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span> <span class="p">,</span> <span class="n">ws_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span>
        	        	<span class="n">rc</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>    <span class="cm">/*    end of find_link    */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm"> *   claw_hw_tx                                                      *</span>
<span class="cm"> *                                                                   *</span>
<span class="cm"> *                                                                   *</span>
<span class="cm"> *-------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_hw_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">long</span> <span class="n">linkid</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span>                             <span class="n">rc</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">claw_privbk</span> 		<span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccwbk</span>           <span class="o">*</span><span class="n">p_this_ccw</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccwbk</span>           <span class="o">*</span><span class="n">p_first_ccw</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccwbk</span>           <span class="o">*</span><span class="n">p_last_ccw</span><span class="p">;</span>
        <span class="n">__u32</span>                           <span class="n">numBuffers</span><span class="p">;</span>
        <span class="kt">signed</span> <span class="kt">long</span>                     <span class="n">len_of_data</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span>                   <span class="n">bytesInThisBuffer</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span>                   <span class="o">*</span><span class="n">pDataAddress</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">endccw</span>                   <span class="o">*</span><span class="n">pEnd</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccw1</span>                     <span class="n">tempCCW</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span>			<span class="o">*</span><span class="n">p_env</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clawph</span>			<span class="o">*</span><span class="n">pk_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chbk</span>			<span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;hw_tx&quot;</span><span class="p">);</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">);</span>
	<span class="n">p_env</span> <span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="n">claw_free_wrt_buf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* Clean up free chain if posible */</span>
        <span class="cm">/*  scan the write queue to free any completed write packets   */</span>
        <span class="n">p_first_ccw</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
        <span class="n">p_last_ccw</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">&gt;=</span> <span class="n">PACK_SEND</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
       	    <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;P&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawph</span><span class="p">));</span>
		<span class="n">pk_head</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawph</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">pk_head</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">=</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawph</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pk_head</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">%</span><span class="mi">4</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">pk_head</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">+=</span> <span class="mi">4</span><span class="o">-</span><span class="p">(</span><span class="n">pk_head</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">%</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">skb_pad</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="mi">4</span><span class="o">-</span><span class="p">(</span><span class="n">pk_head</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">%</span><span class="mi">4</span><span class="p">));</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="mi">4</span><span class="o">-</span><span class="p">(</span><span class="n">pk_head</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">%</span><span class="mi">4</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">DO_PACKED</span><span class="p">)</span>
			<span class="n">pk_head</span><span class="o">-&gt;</span><span class="n">link_num</span> <span class="o">=</span> <span class="n">linkid</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pk_head</span><span class="o">-&gt;</span><span class="n">link_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pk_head</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">skb_pad</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;P&#39;</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">linkid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        	<span class="k">if</span> <span class="p">(</span><span class="n">claw_check_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
                	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">claw_clear_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                                <span class="n">claw_strt_out_IO</span><span class="p">(</span><span class="n">dev</span> <span class="p">);</span>
                                <span class="n">claw_free_wrt_buf</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">];</span>
					<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
					<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
                                	<span class="k">goto</span> <span class="n">Done</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="k">else</span> <span class="p">{</span>
                                	<span class="n">claw_clear_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                <span class="p">}</span>
                <span class="cm">/*  tx lock  */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">claw_test_and_setbit_busy</span><span class="p">(</span><span class="n">TB_TX</span><span class="p">,</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* set to busy */</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">];</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
                        <span class="n">claw_strt_out_IO</span><span class="p">(</span><span class="n">dev</span> <span class="p">);</span>
                        <span class="n">rc</span><span class="o">=-</span><span class="n">EBUSY</span><span class="p">;</span>
                        <span class="k">goto</span> <span class="n">Done2</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="cm">/*      See how many write buffers are required to hold this data */</span>
	<span class="n">numBuffers</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">);</span>

        <span class="cm">/*      If that number of buffers isn&#39;t available, give up for now */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span> <span class="o">&lt;</span> <span class="n">numBuffers</span> <span class="o">||</span>
            <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>

                <span class="n">claw_setbit_busy</span><span class="p">(</span><span class="n">TB_NOBUFFER</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">];</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;clawbusy&quot;</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">Done2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pDataAddress</span><span class="o">=</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
        <span class="n">len_of_data</span><span class="o">=</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">len_of_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">p_this_ccw</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span><span class="p">;</span>  <span class="cm">/* get a block */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_this_ccw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* lost the race */</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">];</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">Done2</span><span class="p">;</span>
		<span class="p">}</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span><span class="o">=</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
                <span class="o">--</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span><span class="p">;</span> <span class="cm">/* -1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len_of_data</span> <span class="o">&gt;=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">)</span>
			<span class="n">bytesInThisBuffer</span> <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bytesInThisBuffer</span> <span class="o">=</span> <span class="n">len_of_data</span><span class="p">;</span>
                <span class="n">memcpy</span><span class="p">(</span> <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">,</span><span class="n">pDataAddress</span><span class="p">,</span> <span class="n">bytesInThisBuffer</span><span class="p">);</span>
                <span class="n">len_of_data</span><span class="o">-=</span><span class="n">bytesInThisBuffer</span><span class="p">;</span>
                <span class="n">pDataAddress</span><span class="o">+=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bytesInThisBuffer</span><span class="p">;</span>
                <span class="cm">/*      setup write CCW         */</span>
                <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">linkid</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">len_of_data</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">cmd_code</span><span class="o">+=</span><span class="n">MORE_to_COME_FLAG</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">count</span><span class="o">=</span><span class="n">bytesInThisBuffer</span><span class="p">;</span>
                <span class="cm">/*      now add to end of this chain    */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p_first_ccw</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>    <span class="p">{</span>
                        <span class="n">p_first_ccw</span><span class="o">=</span><span class="n">p_this_ccw</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p_last_ccw</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">p_last_ccw</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">p_this_ccw</span><span class="p">;</span>
                        <span class="cm">/*      set up TIC ccws         */</span>
                        <span class="n">p_last_ccw</span><span class="o">-&gt;</span><span class="n">w_TIC_1</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">p_last_ccw</span><span class="o">=</span><span class="n">p_this_ccw</span><span class="p">;</span>      <span class="cm">/* save new last block */</span>
        <span class="p">}</span>

        <span class="cm">/*      FirstCCW and LastCCW now contain a new set of write channel</span>
<span class="cm">        *       programs to append to the running channel program</span>
<span class="cm">        */</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">p_first_ccw</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*      setup ending ccw sequence for this segment           */</span>
                <span class="n">pEnd</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_end_ccw</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write1</span><span class="o">=</span><span class="mh">0x00</span><span class="p">;</span>   <span class="cm">/* second end ccw is now active */</span>
                        <span class="cm">/*      set up Tic CCWs         */</span>
                        <span class="n">p_last_ccw</span><span class="o">-&gt;</span><span class="n">w_TIC_1</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write2_nop1</span><span class="p">);</span>
                        <span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write2_nop2</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READFF</span><span class="p">;</span>
                        <span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write2_nop2</span><span class="p">.</span><span class="n">flags</span>    <span class="o">=</span>
				<span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_SKIP</span><span class="p">;</span>
                        <span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write2_nop2</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                        <span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write2_nop2</span><span class="p">.</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>  <span class="cm">/*  end of if (pEnd-&gt;write1)*/</span>
                        <span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write1</span><span class="o">=</span><span class="mh">0x01</span><span class="p">;</span>   <span class="cm">/* first end ccw is now active */</span>
                        <span class="cm">/*      set up Tic CCWs         */</span>
                        <span class="n">p_last_ccw</span><span class="o">-&gt;</span><span class="n">w_TIC_1</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write1_nop1</span><span class="p">);</span>
                        <span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write1_nop2</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READFF</span><span class="p">;</span>
                        <span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write1_nop2</span><span class="p">.</span><span class="n">flags</span>    <span class="o">=</span>
				<span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_SKIP</span><span class="p">;</span>
                        <span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write1_nop2</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                        <span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write1_nop2</span><span class="p">.</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>  <span class="cm">/* end if if (pEnd-&gt;write1) */</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="o">==</span><span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="o">=</span><span class="n">p_first_ccw</span><span class="p">;</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_last</span><span class="o">=</span><span class="n">p_last_ccw</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                        <span class="cm">/*      set up Tic CCWs         */</span>

                        <span class="n">tempCCW</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span><span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_first_ccw</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
                        <span class="n">tempCCW</span><span class="p">.</span><span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                        <span class="n">tempCCW</span><span class="p">.</span><span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                        <span class="n">tempCCW</span><span class="p">.</span><span class="n">cmd_code</span><span class="o">=</span><span class="n">CCW_CLAW_CMD_TIC</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write1</span><span class="p">)</span> <span class="p">{</span>

                 <span class="cm">/*</span>
<span class="cm">                 * first set of ending CCW&#39;s is chained to the new write</span>
<span class="cm">                 * chain, so the second set is chained to the active chain</span>
<span class="cm">                 * Therefore modify the second set to point the new write chain.</span>
<span class="cm">                 * make sure we update the CCW atomically</span>
<span class="cm">                 * so channel does not fetch it when it&#39;s only half done</span>
<span class="cm">                 */</span>
                                <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write2_nop2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempCCW</span> <span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>
                                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_last</span><span class="o">-&gt;</span><span class="n">w_TIC_1</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span>
					<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_first_ccw</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>

                        <span class="cm">/*make sure we update the CCW atomically</span>
<span class="cm">                         *so channel does not fetch it when it&#39;s only half done</span>
<span class="cm">                         */</span>
                                <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">write1_nop2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempCCW</span> <span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>
                                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_last</span><span class="o">-&gt;</span><span class="n">w_TIC_1</span><span class="p">.</span><span class="n">cda</span><span class="o">=</span>
				        <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_first_ccw</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>

                        <span class="p">}</span> <span class="cm">/* end if if (pEnd-&gt;write1) */</span>

                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_last</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">p_first_ccw</span><span class="p">;</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_last</span><span class="o">=</span><span class="n">p_last_ccw</span><span class="p">;</span>
                <span class="p">}</span>

        <span class="p">}</span> <span class="cm">/* endif (p_first_ccw!=NULL)  */</span>
        <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="n">claw_strt_out_IO</span><span class="p">(</span><span class="n">dev</span> <span class="p">);</span>
        <span class="cm">/*      if write free count is zero , set NOBUFFER       */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">claw_setbit_busy</span><span class="p">(</span><span class="n">TB_NOBUFFER</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
        <span class="p">}</span>
<span class="nl">Done2:</span>
	<span class="n">claw_clearbit_busy</span><span class="p">(</span><span class="n">TB_TX</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">Done:</span>
	<span class="k">return</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>    <span class="cm">/*    end of claw_hw_tx    */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*     init_ccw_bk                                                    *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_ccw_bk</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

        <span class="n">__u32</span>   <span class="n">ccw_blocks_required</span><span class="p">;</span>
        <span class="n">__u32</span>   <span class="n">ccw_blocks_perpage</span><span class="p">;</span>
        <span class="n">__u32</span>   <span class="n">ccw_pages_required</span><span class="p">;</span>
        <span class="n">__u32</span>   <span class="n">claw_reads_perpage</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">__u32</span>   <span class="n">claw_read_pages</span><span class="p">;</span>
        <span class="n">__u32</span>   <span class="n">claw_writes_perpage</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">__u32</span>   <span class="n">claw_write_pages</span><span class="p">;</span>
        <span class="kt">void</span>    <span class="o">*</span><span class="n">p_buff</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span><span class="n">p_free_chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span><span class="n">p_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span><span class="n">p_last_CCWB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span><span class="n">p_first_CCWB</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">endccw</span> <span class="o">*</span><span class="n">p_endccw</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">addr_t</span>  <span class="n">real_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">clawh</span> <span class="o">*</span><span class="n">pClawH</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
        <span class="n">addr_t</span>   <span class="n">real_TIC_address</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;init_ccw&quot;</span><span class="p">);</span>

        <span class="cm">/*  initialize  statistics field */</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">active_link_ID</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="cm">/*  initialize  ccwbk pointers  */</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>   <span class="cm">/* pointer to free ccw chain*/</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* pointer to the first write ccw*/</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_last</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>  <span class="cm">/* pointer to the last write ccw*/</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_first</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>  <span class="cm">/* pointer to the first read ccw*/</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_last</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>   <span class="cm">/* pointer to the last read ccw */</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_end_ccw</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>            <span class="cm">/* pointer to ending ccw        */</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_claw_signal_blk</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>    <span class="cm">/* pointer to signal block      */</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">buffs_alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">end_ccw</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">endccw</span><span class="p">));</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">ctl_bk</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawctl</span><span class="p">));</span>
        <span class="cm">/*  initialize  free write ccwbk counter  */</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>  <span class="cm">/* number of free bufs on write chain */</span>
        <span class="n">p_last_CCWB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">p_first_CCWB</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="cm">/*</span>
<span class="cm">        *  We need 1 CCW block for each read buffer, 1 for each</span>
<span class="cm">        *  write buffer, plus 1 for ClawSignalBlock</span>
<span class="cm">        */</span>
        <span class="n">ccw_blocks_required</span> <span class="o">=</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_buffers</span><span class="o">+</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_buffers</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="cm">/*</span>
<span class="cm">        * compute number of CCW blocks that will fit in a page</span>
<span class="cm">        */</span>
        <span class="n">ccw_blocks_perpage</span><span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span>  <span class="n">CCWBK_SIZE</span><span class="p">;</span>
        <span class="n">ccw_pages_required</span><span class="o">=</span>
		<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">ccw_blocks_required</span><span class="p">,</span> <span class="n">ccw_blocks_perpage</span><span class="p">);</span>

        <span class="cm">/*</span>
<span class="cm">         *  read and write sizes are set by 2 constants in claw.h</span>
<span class="cm">	 *  4k and 32k.  Unpacked values other than 4k are not going to</span>
<span class="cm">	 * provide good performance. With packing buffers support 32k</span>
<span class="cm">	 * buffers are used.</span>
<span class="cm">         */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">claw_reads_perpage</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">;</span>
		<span class="n">claw_read_pages</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_buffers</span><span class="p">,</span>
						<span class="n">claw_reads_perpage</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">else</span> <span class="p">{</span>       <span class="cm">/* &gt; or equal  */</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perread</span> <span class="o">=</span>
			<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">claw_read_pages</span> <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_buffers</span> <span class="o">*</span>
					<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perread</span><span class="p">;</span>
         <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">claw_writes_perpage</span> <span class="o">=</span>
			<span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">;</span>
		<span class="n">claw_write_pages</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_buffers</span><span class="p">,</span>
						<span class="n">claw_writes_perpage</span><span class="p">);</span>

        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>      <span class="cm">/* &gt;  or equal  */</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perwrite</span> <span class="o">=</span>
			<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">claw_write_pages</span> <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_buffers</span> <span class="o">*</span>
					<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perwrite</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/*</span>
<span class="cm">        *               allocate ccw_pages_required</span>
<span class="cm">        */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">__GFP_DMA</span><span class="p">,</span>
		        <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span><span class="n">ccw_pages_required</span> <span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw_num</span><span class="o">=</span><span class="n">ccw_pages_required</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw_num</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

        <span class="cm">/*</span>
<span class="cm">        *               obtain ending ccw block address</span>
<span class="cm">        *</span>
<span class="cm">        */</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_end_ccw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">endccw</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">end_ccw</span><span class="p">;</span>
        <span class="n">real_address</span>  <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_end_ccw</span><span class="p">);</span>
        <span class="cm">/*                              Initialize ending CCW block       */</span>
        <span class="n">p_endccw</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_end_ccw</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">real</span><span class="o">=</span><span class="n">real_address</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write1</span><span class="o">=</span><span class="mh">0x00</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read1</span><span class="o">=</span><span class="mh">0x00</span><span class="p">;</span>

        <span class="cm">/*      write1_nop1                                     */</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write1_nop1</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_NOP</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write1_nop1</span><span class="p">.</span><span class="n">flags</span>       <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write1_nop1</span><span class="p">.</span><span class="n">count</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write1_nop1</span><span class="p">.</span><span class="n">cda</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/*      write1_nop2                                     */</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write1_nop2</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READFF</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write1_nop2</span><span class="p">.</span><span class="n">flags</span>        <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_SKIP</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write1_nop2</span><span class="p">.</span><span class="n">count</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write1_nop2</span><span class="p">.</span><span class="n">cda</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/*      write2_nop1                                     */</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write2_nop1</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_NOP</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write2_nop1</span><span class="p">.</span><span class="n">flags</span>        <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write2_nop1</span><span class="p">.</span><span class="n">count</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write2_nop1</span><span class="p">.</span><span class="n">cda</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/*      write2_nop2                                     */</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write2_nop2</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READFF</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write2_nop2</span><span class="p">.</span><span class="n">flags</span>        <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_SKIP</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write2_nop2</span><span class="p">.</span><span class="n">count</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">write2_nop2</span><span class="p">.</span><span class="n">cda</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/*      read1_nop1                                      */</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read1_nop1</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_NOP</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read1_nop1</span><span class="p">.</span><span class="n">flags</span>        <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read1_nop1</span><span class="p">.</span><span class="n">count</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read1_nop1</span><span class="p">.</span><span class="n">cda</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/*      read1_nop2                                      */</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read1_nop2</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READFF</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read1_nop2</span><span class="p">.</span><span class="n">flags</span>        <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_SKIP</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read1_nop2</span><span class="p">.</span><span class="n">count</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read1_nop2</span><span class="p">.</span><span class="n">cda</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/*      read2_nop1                                      */</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read2_nop1</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_NOP</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read2_nop1</span><span class="p">.</span><span class="n">flags</span>        <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read2_nop1</span><span class="p">.</span><span class="n">count</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read2_nop1</span><span class="p">.</span><span class="n">cda</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/*      read2_nop2                                      */</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read2_nop2</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READFF</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read2_nop2</span><span class="p">.</span><span class="n">flags</span>        <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_SKIP</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read2_nop2</span><span class="p">.</span><span class="n">count</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">p_endccw</span><span class="o">-&gt;</span><span class="n">read2_nop2</span><span class="p">.</span><span class="n">cda</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/*</span>
<span class="cm">        *                               Build a chain of CCWs</span>
<span class="cm">        *</span>
<span class="cm">        */</span>
        <span class="n">p_buff</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="p">;</span>

        <span class="n">p_free_chain</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ccw_pages_required</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">real_address</span>  <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="n">p_buff</span><span class="p">);</span>
                <span class="n">p_buf</span><span class="o">=</span><span class="n">p_buff</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ccw_blocks_perpage</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span>  <span class="o">=</span> <span class="n">p_free_chain</span><span class="p">;</span>
                        <span class="n">p_free_chain</span> <span class="o">=</span> <span class="n">p_buf</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">real</span><span class="o">=</span><span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="n">p_buf</span><span class="p">);</span>
                        <span class="o">++</span><span class="n">p_buf</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">p_buff</span><span class="o">+=</span><span class="n">PAGE_SIZE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/*</span>
<span class="cm">        *                               Initialize ClawSignalBlock</span>
<span class="cm">        *</span>
<span class="cm">        */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_claw_signal_blk</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_claw_signal_blk</span><span class="o">=</span><span class="n">p_free_chain</span><span class="p">;</span>
                <span class="n">p_free_chain</span><span class="o">=</span><span class="n">p_free_chain</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="n">pClawH</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawh</span> <span class="o">*</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_claw_signal_blk</span><span class="p">;</span>
                <span class="n">pClawH</span><span class="o">-&gt;</span><span class="n">length</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
                <span class="n">pClawH</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="o">=</span><span class="mh">0xff</span><span class="p">;</span>
                <span class="n">pClawH</span><span class="o">-&gt;</span><span class="n">flag</span><span class="o">=</span><span class="n">CLAW_BUSY</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*</span>
<span class="cm">        *               allocate write_pages_required and add to free chain</span>
<span class="cm">        */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">__GFP_DMA</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span><span class="n">claw_write_pages</span> <span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
                        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="cm">/*</span>
<span class="cm">                *                               Build CLAW write free chain</span>
<span class="cm">                *</span>
<span class="cm">                */</span>

                <span class="n">memset</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
			<span class="n">ccw_pages_required</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>

                <span class="n">p_buff</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="p">;</span>

                <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_buffers</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">p_buf</span>        <span class="o">=</span> <span class="n">p_free_chain</span><span class="p">;</span>      <span class="cm">/*  get a CCW */</span>
                        <span class="n">p_free_chain</span> <span class="o">=</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span>  <span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span><span class="p">;</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span> <span class="o">=</span> <span class="n">p_buf</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">p_buffer</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">clawbuf</span> <span class="o">*</span><span class="p">)</span><span class="n">p_buff</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">write</span><span class="p">.</span><span class="n">cda</span>       <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="n">p_buff</span><span class="p">);</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">write</span><span class="p">.</span><span class="n">flags</span>     <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_read_FF</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READFF</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_read_FF</span><span class="p">.</span><span class="n">flags</span>   <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_read_FF</span><span class="p">.</span><span class="n">count</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_read_FF</span><span class="p">.</span><span class="n">cda</span>     <span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_TIC_1</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_TIC</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_TIC_1</span><span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_TIC_1</span><span class="p">.</span><span class="n">count</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p_buff</span> <span class="o">+</span>
					    <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">)</span> <span class="o">&gt;=</span>
			   <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">p_buff</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span>
			    <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">p_buff</span> <span class="o">=</span> <span class="n">p_buff</span><span class="o">+</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
           <span class="p">}</span>
           <span class="k">else</span>      <span class="cm">/*  Buffers are =&gt; PAGE_SIZE. 1 buff per get_free_pages */</span>
           <span class="p">{</span>
               <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
               <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_buffers</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                   <span class="n">p_buff</span><span class="o">=</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">__GFP_DMA</span><span class="p">,</span>
		        <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perwrite</span><span class="p">)</span> <span class="p">);</span>
                   <span class="k">if</span> <span class="p">(</span><span class="n">p_buff</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
			      		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw_num</span><span class="p">));</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
			<span class="n">p_buf</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="p">;</span>
                        <span class="k">while</span> <span class="p">(</span><span class="n">p_buf</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
					<span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
					<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perwrite</span><span class="p">));</span>
                                <span class="n">p_buf</span><span class="o">=</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                   <span class="p">}</span>  <span class="cm">/* Error on get_pages   */</span>
                   <span class="n">memset</span><span class="p">(</span><span class="n">p_buff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span> <span class="p">);</span>
                   <span class="n">p_buf</span>         <span class="o">=</span> <span class="n">p_free_chain</span><span class="p">;</span>
                   <span class="n">p_free_chain</span>  <span class="o">=</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                   <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span>   <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span><span class="p">;</span>
                   <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span> <span class="o">=</span> <span class="n">p_buf</span><span class="p">;</span>
                   <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span> <span class="o">=</span> <span class="n">p_buf</span><span class="p">;</span>
                   <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawbuf</span> <span class="o">*</span><span class="p">)</span><span class="n">p_buff</span><span class="p">;</span>
                   <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">write</span><span class="p">.</span><span class="n">cda</span>     <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="n">p_buff</span><span class="p">);</span>
                   <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">write</span><span class="p">.</span><span class="n">flags</span>   <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
                   <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_read_FF</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READFF</span><span class="p">;</span>
                   <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_read_FF</span><span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
                   <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_read_FF</span><span class="p">.</span><span class="n">count</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                   <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_read_FF</span><span class="p">.</span><span class="n">cda</span>      <span class="o">=</span>
			<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
                   <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_TIC_1</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_TIC</span><span class="p">;</span>
                   <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_TIC_1</span><span class="p">.</span><span class="n">flags</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                   <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">w_TIC_1</span><span class="p">.</span><span class="n">count</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
               <span class="p">}</span>  <span class="cm">/* for all write_buffers   */</span>

           <span class="p">}</span>    <span class="cm">/* else buffers are PAGE_SIZE or bigger */</span>

        <span class="p">}</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write_num</span><span class="o">=</span><span class="n">claw_write_pages</span><span class="p">;</span>
        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_buffers</span><span class="p">;</span>


        <span class="cm">/*</span>
<span class="cm">        *               allocate read_pages_required and chain to free chain</span>
<span class="cm">        */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>  <span class="p">{</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read</span><span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">__GFP_DMA</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span><span class="n">claw_read_pages</span><span class="p">)</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
					<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw_num</span><span class="p">));</span>
			<span class="cm">/* free the write pages size is &lt; page size  */</span>
                        <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
				<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write_num</span><span class="p">));</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
                        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">memset</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">claw_read_pages</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read_num</span><span class="o">=</span><span class="n">claw_read_pages</span><span class="p">;</span>
                <span class="cm">/*</span>
<span class="cm">                *                               Build CLAW read free chain</span>
<span class="cm">                *</span>
<span class="cm">                */</span>
                <span class="n">p_buff</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_buffers</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">p_buf</span>        <span class="o">=</span> <span class="n">p_free_chain</span><span class="p">;</span>
                        <span class="n">p_free_chain</span> <span class="o">=</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">p_last_CCWB</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
                                <span class="n">real_TIC_address</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                                <span class="n">p_last_CCWB</span><span class="o">=</span><span class="n">p_buf</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                                <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">p_first_CCWB</span><span class="p">;</span>
                                <span class="n">real_TIC_address</span><span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_first_CCWB</span> <span class="o">-&gt;</span> <span class="n">read</span> <span class="p">);</span>
                        <span class="p">}</span>

                        <span class="n">p_first_CCWB</span><span class="o">=</span><span class="n">p_buf</span><span class="p">;</span>

                        <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawbuf</span> <span class="o">*</span><span class="p">)</span><span class="n">p_buff</span><span class="p">;</span>
                        <span class="cm">/*  initialize read command */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READ</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="n">p_buff</span><span class="p">);</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read</span><span class="p">.</span><span class="n">count</span>       <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">;</span>

                        <span class="cm">/*  initialize read_h command */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read_h</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READHEADER</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read_h</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">));</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read_h</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read_h</span><span class="p">.</span><span class="n">count</span>      <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawh</span><span class="p">);</span>

                        <span class="cm">/*  initialize Signal command */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">signal</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_SIGNAL_SMOD</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">signal</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pClawH</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">));</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">signal</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">signal</span><span class="p">.</span><span class="n">count</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                        <span class="cm">/*  initialize r_TIC_1 command */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_TIC_1</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_TIC</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_TIC_1</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">real_TIC_address</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_TIC_1</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_TIC_1</span><span class="p">.</span><span class="n">count</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                        <span class="cm">/*  initialize r_read_FF command */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_read_FF</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READFF</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_read_FF</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pClawH</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">));</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_read_FF</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
				<span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span> <span class="o">|</span> <span class="n">CCW_FLAG_PCI</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_read_FF</span><span class="p">.</span><span class="n">count</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                        <span class="cm">/*    initialize r_TIC_2          */</span>
                        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">r_TIC_2</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">r_TIC_1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>

                        <span class="cm">/*     initialize Header     */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">opcode</span><span class="o">=</span><span class="mh">0xff</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="o">=</span><span class="n">CLAW_PENDING</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p_buff</span><span class="o">+</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">)</span> <span class="o">&gt;=</span>
			  <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">p_buff</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">)</span>
				 <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			   <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span> <span class="p">{</span>
                                <span class="n">p_buff</span><span class="o">=</span> <span class="n">p_buff</span><span class="o">+</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                                <span class="n">p_buff</span><span class="o">=</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
					<span class="p">(</span><span class="n">p_buff</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					 <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">)</span> <span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>   <span class="cm">/* for read_buffers   */</span>
          <span class="p">}</span>         <span class="cm">/* read_size &lt; PAGE_SIZE  */</span>
          <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* read Size &gt;= PAGE_SIZE  */</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_buffers</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">p_buff</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">__GFP_DMA</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
					<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perread</span><span class="p">));</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">p_buff</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span>
					<span class="n">p_buff_ccw_num</span><span class="p">));</span>
				<span class="cm">/* free the write pages  */</span>
	                        <span class="n">p_buf</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="p">;</span>
                                <span class="k">while</span> <span class="p">(</span><span class="n">p_buf</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">free_pages</span><span class="p">(</span>
					    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">,</span>
					    <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
					    <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perwrite</span><span class="p">));</span>
                                        <span class="n">p_buf</span><span class="o">=</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                                <span class="p">}</span>
				<span class="cm">/* free any read pages already alloc  */</span>
	                        <span class="n">p_buf</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read</span><span class="p">;</span>
                                <span class="k">while</span> <span class="p">(</span><span class="n">p_buf</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">free_pages</span><span class="p">(</span>
					    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">,</span>
					    <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pages_to_order_of_mag</span><span class="p">(</span>
					     <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_pages_perread</span><span class="p">));</span>
                                        <span class="n">p_buf</span><span class="o">=</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_ccw</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
                                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_write</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
                                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">memset</span><span class="p">(</span><span class="n">p_buff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">);</span>
                        <span class="n">p_buf</span>        <span class="o">=</span> <span class="n">p_free_chain</span><span class="p">;</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_buff_read</span> <span class="o">=</span> <span class="n">p_buf</span><span class="p">;</span>
                        <span class="n">p_free_chain</span> <span class="o">=</span> <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">p_last_CCWB</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
                                <span class="n">real_TIC_address</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                                <span class="n">p_last_CCWB</span><span class="o">=</span><span class="n">p_buf</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                                <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">p_first_CCWB</span><span class="p">;</span>
                                <span class="n">real_TIC_address</span><span class="o">=</span>
					<span class="p">(</span><span class="n">addr_t</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">p_first_CCWB</span> <span class="o">-&gt;</span> <span class="n">read</span> <span class="p">);</span>
                        <span class="p">}</span>

                        <span class="n">p_first_CCWB</span><span class="o">=</span><span class="n">p_buf</span><span class="p">;</span>
				<span class="cm">/* save buff address */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawbuf</span> <span class="o">*</span><span class="p">)</span><span class="n">p_buff</span><span class="p">;</span>
                        <span class="cm">/*  initialize read command */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READ</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="n">p_buff</span><span class="p">);</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read</span><span class="p">.</span><span class="n">count</span>       <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">;</span>

                        <span class="cm">/*  initialize read_h command */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read_h</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READHEADER</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read_h</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">));</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read_h</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">read_h</span><span class="p">.</span><span class="n">count</span>      <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawh</span><span class="p">);</span>

                        <span class="cm">/*  initialize Signal command */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">signal</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_SIGNAL_SMOD</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">signal</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pClawH</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">));</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">signal</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">signal</span><span class="p">.</span><span class="n">count</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                        <span class="cm">/*  initialize r_TIC_1 command */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_TIC_1</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_TIC</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_TIC_1</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">real_TIC_address</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_TIC_1</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_TIC_1</span><span class="p">.</span><span class="n">count</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                        <span class="cm">/*  initialize r_read_FF command */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_read_FF</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CLAW_CMD_READFF</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_read_FF</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pClawH</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">));</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_read_FF</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
				<span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span> <span class="o">|</span> <span class="n">CCW_FLAG_PCI</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span> <span class="n">r_read_FF</span><span class="p">.</span><span class="n">count</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                        <span class="cm">/*    initialize r_TIC_2          */</span>
                        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">r_TIC_2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">r_TIC_1</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>

                        <span class="cm">/*     initialize Header     */</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">opcode</span><span class="o">=</span><span class="mh">0xff</span><span class="p">;</span>
                        <span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="o">=</span><span class="n">CLAW_PENDING</span><span class="p">;</span>

                <span class="p">}</span>    <span class="cm">/* For read_buffers   */</span>
          <span class="p">}</span>     <span class="cm">/*  read_size &gt;= PAGE_SIZE   */</span>
        <span class="p">}</span>       <span class="cm">/*  pBuffread = NULL */</span>
        <span class="n">add_claw_reads</span><span class="p">(</span> <span class="n">dev</span>  <span class="p">,</span><span class="n">p_first_CCWB</span> <span class="p">,</span> <span class="n">p_last_CCWB</span><span class="p">);</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">buffs_alloc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>    <span class="cm">/*    end of init_ccw_bk */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*       probe_error                                                  *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">probe_error</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;proberr&quot;</span><span class="p">);</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_mtc_envelope</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">privptr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>    <span class="cm">/*    probe_error    */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*    claw_process_control                                            *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_process_control</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ccwbk</span> <span class="o">*</span> <span class="n">p_ccw</span><span class="p">)</span>
<span class="p">{</span>

        <span class="k">struct</span> <span class="n">clawbuf</span> <span class="o">*</span><span class="n">p_buf</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">clawctl</span>  <span class="n">ctlbk</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">clawctl</span> <span class="o">*</span><span class="n">p_ctlbk</span><span class="p">;</span>
        <span class="kt">char</span>    <span class="n">temp_host_name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
        <span class="kt">char</span>    <span class="n">temp_ws_name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
        <span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span><span class="n">p_env</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sysval</span> <span class="o">*</span><span class="n">p_sysval</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">conncmd</span> <span class="o">*</span><span class="n">p_connect</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span><span class="n">p_ch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;clw_cntl&quot;</span><span class="p">);</span>
        <span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>  <span class="cm">/* Wait a ms for the control packets to</span>
<span class="cm">			*catch up to each other */</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
        <span class="n">p_env</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="n">tdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">temp_host_name</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">temp_ws_name</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">adapter_name</span> <span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;%s: CLAW device %.8s: &quot;</span>
		<span class="s">&quot;Received Control Packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">temp_ws_name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">release_pend</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">p_buf</span><span class="o">=</span><span class="n">p_ccw</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">;</span>
        <span class="n">p_ctlbk</span><span class="o">=&amp;</span><span class="n">ctlbk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">DO_PACKED</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* packing in progress?*/</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p_ctlbk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p_buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawctl</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p_ctlbk</span><span class="p">,</span> <span class="n">p_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawctl</span><span class="p">));</span>
	<span class="p">}</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span>
        <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYSTEM_VALIDATE_REQUEST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">CLAW_VERSION_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">claw_snd_sys_validate_rsp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="p">,</span>
				<span class="n">CLAW_RC_WRONG_VERSION</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;The communication peer of %s&quot;</span>
				<span class="s">&quot; uses an incorrect API version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">p_sysval</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sysval</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;%s: Recv Sys Validate Request: &quot;</span>
			<span class="s">&quot;Vers=%d,link_id=%d,Corr=%d,WS name=%.8s,&quot;</span>
			<span class="s">&quot;Host name=%.8s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">correlator</span><span class="p">,</span>
			<span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">,</span>
			<span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">temp_host_name</span><span class="p">,</span> <span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">claw_snd_sys_validate_rsp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="p">,</span>
				<span class="n">CLAW_RC_NAME_MISMATCH</span><span class="p">);</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;HSTBAD&quot;</span><span class="p">);</span>
			<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">);</span>
			<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">temp_host_name</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span>
				<span class="s">&quot;Host name %s for %s does not match the&quot;</span>
				<span class="s">&quot; remote adapter name %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">temp_host_name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">temp_ws_name</span><span class="p">,</span> <span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">claw_snd_sys_validate_rsp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="p">,</span>
				<span class="n">CLAW_RC_NAME_MISMATCH</span><span class="p">);</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;WSNBAD&quot;</span><span class="p">);</span>
			<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">);</span>
			<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">temp_ws_name</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;Adapter name %s for %s does not match&quot;</span>
				<span class="s">&quot; the remote host name %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">temp_ws_name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">write_frame_size</span> <span class="o">&lt;</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">claw_snd_sys_validate_rsp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="p">,</span>
				<span class="n">CLAW_RC_HOST_RCV_TOO_SMALL</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span>
				<span class="s">&quot;The local write buffer is smaller than the&quot;</span>
				<span class="s">&quot; remote read buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;wrtszbad&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">read_frame_size</span> <span class="o">&lt;</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">claw_snd_sys_validate_rsp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="p">,</span>
				<span class="n">CLAW_RC_HOST_RCV_TOO_SMALL</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span>
				<span class="s">&quot;The local read buffer is smaller than the&quot;</span>
				<span class="s">&quot; remote write buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;rdsizbad&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">claw_snd_sys_validate_rsp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span>
			<span class="s">&quot;CLAW device %.8s: System validate&quot;</span>
			<span class="s">&quot; completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_ws_name</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span>
			<span class="s">&quot;%s: sys Validate Rsize:%d Wsize:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">read_frame_size</span><span class="p">,</span>
			<span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">write_frame_size</span><span class="p">);</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">system_validate_comp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span><span class="p">,</span> <span class="n">WS_APPL_NAME_PACKED</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">=</span> <span class="n">PACKING_ASK</span><span class="p">;</span>
		<span class="n">claw_strt_conn_req</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYSTEM_VALIDATE_RESPONSE</span>:
		<span class="n">p_sysval</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sysval</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span>
			<span class="s">&quot;Settings for %s validated (version=%d, &quot;</span>
			<span class="s">&quot;remote device=%d, rc=%d, adapter name=%.8s, &quot;</span>
			<span class="s">&quot;host name=%.8s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">correlator</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span>
			<span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">,</span>
			<span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;%s: CLAW device &quot;</span>
				<span class="s">&quot;%.8s: System validate completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">temp_ws_name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">system_validate_comp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">claw_strt_conn_req</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">system_validate_comp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLAW_RC_NAME_MISMATCH</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;Validating %s failed because of&quot;</span>
				<span class="s">&quot; a host or adapter name mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLAW_RC_WRONG_VERSION</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;Validating %s failed because of a&quot;</span>
				<span class="s">&quot; version conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLAW_RC_HOST_RCV_TOO_SMALL</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;Validating %s failed because of a&quot;</span>
				<span class="s">&quot; frame size conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;The communication peer of %s rejected&quot;</span>
				<span class="s">&quot; the connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CONNECTION_REQUEST</span>:
		<span class="n">p_connect</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">conncmd</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;%s: Recv Conn Req: Vers=%d,link_id=%d,&quot;</span>
			<span class="s">&quot;Corr=%d,HOST appl=%.8s,WS appl=%.8s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">correlator</span><span class="p">,</span>
			<span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span>
			<span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">active_link_ID</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">claw_snd_disc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="p">);</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;%s rejected a connection request&quot;</span>
				<span class="s">&quot; because it is already active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">claw_snd_disc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="p">);</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;%s rejected a request to open multiple&quot;</span>
				<span class="s">&quot; connections</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">find_link</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span> <span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">claw_snd_disc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="p">);</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;%s rejected a connection request&quot;</span>
				<span class="s">&quot; because of a type mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">claw_send_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">CONNECTION_CONFIRM</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">correlator</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span>
			<span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">PACKING_ASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">=</span> <span class="n">PACK_SEND</span><span class="p">;</span>
			<span class="n">claw_snd_conn_req</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;%s: CLAW device %.8s: Connection &quot;</span>
			<span class="s">&quot;completed link_id=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">temp_ws_name</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">);</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">active_link_ID</span> <span class="o">=</span> <span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">;</span>
			<span class="n">p_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">];</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>  <span class="cm">/* wake up claw_open ( WRITE) */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CONNECTION_RESPONSE</span>:
		<span class="n">p_connect</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">conncmd</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;%s: Recv Conn Resp: Vers=%d,link_id=%d,&quot;</span>
			<span class="s">&quot;Corr=%d,RC=%d,Host appl=%.8s, WS appl=%.8s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">correlator</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span>
			<span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span>
			<span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;The communication peer of %s rejected&quot;</span>
				<span class="s">&quot; a connection request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">find_link</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span> <span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">claw_snd_disc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;The communication peer of %s&quot;</span>
				<span class="s">&quot; rejected a connection &quot;</span>
				<span class="s">&quot;request because of a type mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* should be until CONNECTION_CONFIRM */</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">active_link_ID</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CONNECTION_CONFIRM</span>:
		<span class="n">p_connect</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">conncmd</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span>
			<span class="s">&quot;%s: Recv Conn Confirm:Vers=%d,link_id=%d,&quot;</span>
			<span class="s">&quot;Corr=%d,Host appl=%.8s,WS appl=%.8s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">correlator</span><span class="p">,</span>
			<span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span>
			<span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span> <span class="o">==</span> <span class="o">-</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">active_link_ID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">active_link_ID</span> <span class="o">=</span> <span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">&gt;</span> <span class="n">PACKING_ASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span>
				<span class="s">&quot;%s: Confirmed Now packing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">=</span> <span class="n">DO_PACKED</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">p_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">];</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;Activating %s failed because of&quot;</span>
				<span class="s">&quot; an incorrect link ID=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">);</span>
			<span class="n">claw_snd_disc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISCONNECT</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;%s: Disconnect: &quot;</span>
			<span class="s">&quot;Vers=%d,link_id=%d,Corr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
			<span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">,</span> <span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">correlator</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p_ctlbk</span><span class="o">-&gt;</span><span class="n">linkid</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">PACK_SEND</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">active_link_ID</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">=</span> <span class="n">DO_PACKED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">active_link_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLAW_ERROR</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;The communication peer of %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="s">&quot;The communication peer of %s sent&quot;</span>
			<span class="s">&quot; an unknown command code</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>   <span class="cm">/*    end of claw_process_control    */</span>


<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*               claw_send_control                                    *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_send_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">link</span><span class="p">,</span>
	 <span class="n">__u8</span> <span class="n">correlator</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">rc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">local_name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">remote_name</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">claw_privbk</span> 		<span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">clawctl</span>                  <span class="o">*</span><span class="n">p_ctl</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sysval</span>                   <span class="o">*</span><span class="n">p_sysval</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">conncmd</span>                  <span class="o">*</span><span class="n">p_connect</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sk_buff</span> 			<span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;sndcntl&quot;</span><span class="p">);</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
        <span class="n">p_ctl</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawctl</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">ctl_bk</span><span class="p">;</span>

        <span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">command</span><span class="o">=</span><span class="n">type</span><span class="p">;</span>
        <span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">version</span><span class="o">=</span><span class="n">CLAW_VERSION_ID</span><span class="p">;</span>
        <span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="o">=</span><span class="n">link</span><span class="p">;</span>
        <span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">correlator</span><span class="o">=</span><span class="n">correlator</span><span class="p">;</span>
        <span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">=</span><span class="n">rc</span><span class="p">;</span>

        <span class="n">p_sysval</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">sysval</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
        <span class="n">p_connect</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">conncmd</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="n">SYSTEM_VALIDATE_REQUEST</span>:
                <span class="k">case</span> <span class="n">SYSTEM_VALIDATE_RESPONSE</span>:
                        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span> <span class="n">local_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
                        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">,</span> <span class="n">remote_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">read_frame_size</span> <span class="o">=</span> <span class="n">DEF_PACK_BUFSIZE</span><span class="p">;</span>
				<span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">write_frame_size</span> <span class="o">=</span> <span class="n">DEF_PACK_BUFSIZE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* how big is the biggest group of packets */</span>
			   <span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">read_frame_size</span> <span class="o">=</span>
				<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">;</span>
			   <span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">write_frame_size</span> <span class="o">=</span>
				<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">;</span>
			<span class="p">}</span>
                        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">CONNECTION_REQUEST</span>:
                <span class="k">case</span> <span class="n">CONNECTION_RESPONSE</span>:
                <span class="k">case</span> <span class="n">CONNECTION_CONFIRM</span>:
                <span class="k">case</span> <span class="n">DISCONNECT</span>:
                        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span> <span class="n">local_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
                        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_sysval</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">,</span> <span class="n">remote_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* How big is the biggest packet */</span>
				<span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">reserved1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">CLAW_FRAME_SIZE</span><span class="p">;</span>
                        	<span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">reserved1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">CLAW_FRAME_SIZE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	                        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">reserved1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
        	                <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">reserved2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="nl">default:</span>
                        <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*      write Control Record to the device                   */</span>


        <span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawctl</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawctl</span><span class="p">)),</span>
		<span class="n">p_ctl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawctl</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">&gt;=</span> <span class="n">PACK_SEND</span><span class="p">)</span>
		<span class="n">claw_hw_tx</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
        	<span class="n">claw_hw_tx</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>  <span class="cm">/*   end of claw_send_control  */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*               claw_snd_conn_req                                    *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_snd_conn_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span>                <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">clawctl</span> 	   <span class="o">*</span><span class="n">p_ctl</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;snd_conn&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">p_ctl</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawctl</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">ctl_bk</span><span class="p">;</span>
	<span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">linkid</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">system_validate_comp</span><span class="o">==</span><span class="mh">0x00</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">PACKING_ASK</span> <span class="p">)</span>
		<span class="n">rc</span><span class="o">=</span><span class="n">claw_send_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONNECTION_REQUEST</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
        		<span class="n">WS_APPL_NAME_PACKED</span><span class="p">,</span> <span class="n">WS_APPL_NAME_PACKED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">PACK_SEND</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">rc</span><span class="o">=</span><span class="n">claw_send_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONNECTION_REQUEST</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
        		<span class="n">WS_APPL_NAME_IP_NAME</span><span class="p">,</span> <span class="n">WS_APPL_NAME_IP_NAME</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        	<span class="n">rc</span><span class="o">=</span><span class="n">claw_send_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONNECTION_REQUEST</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
       			<span class="n">HOST_APPL_NAME</span><span class="p">,</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>  <span class="cm">/*  end of claw_snd_conn_req */</span>


<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*               claw_snd_disc                                        *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_snd_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">clawctl</span> <span class="o">*</span> <span class="n">p_ctl</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">conncmd</span> <span class="o">*</span>  <span class="n">p_connect</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;snd_dsc&quot;</span><span class="p">);</span>
        <span class="n">p_connect</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">conncmd</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

        <span class="n">rc</span><span class="o">=</span><span class="n">claw_send_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DISCONNECT</span><span class="p">,</span> <span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">,</span>
		<span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">correlator</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span> <span class="n">p_connect</span><span class="o">-&gt;</span><span class="n">WS_name</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>     <span class="cm">/*   end of claw_snd_disc    */</span>


<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*               claw_snd_sys_validate_rsp                            *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_snd_sys_validate_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">clawctl</span> <span class="o">*</span><span class="n">p_ctl</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">return_code</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span>  <span class="n">p_env</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
        <span class="kt">int</span>    <span class="n">rc</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;chkresp&quot;</span><span class="p">);</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
        <span class="n">p_env</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
        <span class="n">rc</span><span class="o">=</span><span class="n">claw_send_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SYSTEM_VALIDATE_RESPONSE</span><span class="p">,</span>
		<span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">linkid</span><span class="p">,</span>
		<span class="n">p_ctl</span><span class="o">-&gt;</span><span class="n">correlator</span><span class="p">,</span>
                <span class="n">return_code</span><span class="p">,</span>
		<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span>
		<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">adapter_name</span>  <span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>     <span class="cm">/*    end of claw_snd_sys_validate_rsp    */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*               claw_strt_conn_req                                   *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_strt_conn_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;conn_req&quot;</span><span class="p">);</span>
        <span class="n">rc</span><span class="o">=</span><span class="n">claw_snd_conn_req</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>    <span class="cm">/*   end of claw_strt_conn_req   */</span>



<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm"> *   claw_stats                                                      *</span>
<span class="cm"> *-------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span>
<span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">claw_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;stats&quot;</span><span class="p">);</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>     <span class="cm">/*   end of claw_stats   */</span>


<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*       unpack_read                                                  *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">unpack_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span>    <span class="o">*</span><span class="n">p_env</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccwbk</span> 	<span class="o">*</span><span class="n">p_this_ccw</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccwbk</span> 	<span class="o">*</span><span class="n">p_first_ccw</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccwbk</span> 	<span class="o">*</span><span class="n">p_last_ccw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clawph</span> 	<span class="o">*</span><span class="n">p_packh</span><span class="p">;</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">p_packd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clawctl</span> 	<span class="o">*</span><span class="n">p_ctlrec</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>	<span class="o">*</span><span class="n">p_dev</span><span class="p">;</span>

        <span class="n">__u32</span>	<span class="n">len_of_data</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">pack_off</span><span class="p">;</span>
        <span class="n">__u8</span>	<span class="n">link_num</span><span class="p">;</span>
        <span class="n">__u8</span> 	<span class="n">mtc_this_frm</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">__u32</span>	<span class="n">bytes_to_mov</span><span class="p">;</span>
        <span class="kt">int</span>	<span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>     <span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;unpkread&quot;</span><span class="p">);</span>
        <span class="n">p_first_ccw</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
        <span class="n">p_last_ccw</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">p_packh</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">p_packd</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">p_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">p_env</span> <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
        <span class="n">p_this_ccw</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_first</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p_this_ccw</span><span class="o">!=</span><span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="o">!=</span><span class="n">CLAW_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pack_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="o">=</span><span class="n">CLAW_PENDING</span><span class="p">;</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_first</span><span class="o">=</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
		<span class="n">p_packh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">clawph</span> <span class="o">*</span><span class="p">)</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">PACK_SEND</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">p_packh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>           <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">p_packh</span><span class="o">-&gt;</span><span class="n">link_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>   <span class="cm">/* is it a packed ctl rec? */</span>
			<span class="n">p_packh</span><span class="o">++</span><span class="p">;</span>  <span class="cm">/* peek past pack header */</span>
			<span class="n">p_ctlrec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">clawctl</span> <span class="o">*</span><span class="p">)</span><span class="n">p_packh</span><span class="p">;</span>
			<span class="n">p_packh</span><span class="o">--</span><span class="p">;</span>  <span class="cm">/* un peek */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">p_ctlrec</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">==</span> <span class="n">CONNECTION_RESPONSE</span><span class="p">)</span> <span class="o">||</span>
		            <span class="p">(</span><span class="n">p_ctlrec</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">==</span> <span class="n">CONNECTION_CONFIRM</span><span class="p">))</span>
				<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">=</span> <span class="n">DO_PACKED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">DO_PACKED</span><span class="p">)</span>
			<span class="n">link_num</span><span class="o">=</span><span class="n">p_packh</span><span class="o">-&gt;</span><span class="n">link_num</span><span class="p">;</span>
		<span class="k">else</span>
	                <span class="n">link_num</span><span class="o">=</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">opcode</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">MORE_to_COME_FLAG</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">mtc_this_frm</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="o">!=</span>
				<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">p_dev</span><span class="p">,</span>
					<span class="s">&quot;The communication peer of %s&quot;</span>
					<span class="s">&quot; sent a faulty&quot;</span>
					<span class="s">&quot; frame of length %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
                        <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_skipping</span><span class="p">)</span> <span class="p">{</span>
                        <span class="cm">/*</span>
<span class="cm">                        *   We&#39;re in the mode of skipping past a</span>
<span class="cm">			*   multi-frame message</span>
<span class="cm">                        *   that we can&#39;t process for some reason or other.</span>
<span class="cm">                        *   The first frame without the More-To-Come flag is</span>
<span class="cm">			*   the last frame of the skipped message.</span>
<span class="cm">                        */</span>
                        <span class="cm">/*  in case of More-To-Come not set in this frame */</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">mtc_this_frm</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_skipping</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="cm">/* Ok, the end */</span>
                                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_logical_link</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">goto</span> <span class="n">NextFrame</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">link_num</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">claw_process_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_this_ccw</span><span class="p">);</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;UnpkCntl&quot;</span><span class="p">);</span>
                        <span class="k">goto</span> <span class="n">NextFrame</span><span class="p">;</span>
                <span class="p">}</span>
<span class="nl">unpack_next:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">DO_PACKED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pack_off</span> <span class="o">&gt;</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">NextFrame</span><span class="p">;</span>
			<span class="n">p_packd</span> <span class="o">=</span> <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="o">+</span><span class="n">pack_off</span><span class="p">;</span>
			<span class="n">p_packh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">clawph</span> <span class="o">*</span><span class="p">)</span> <span class="n">p_packd</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">p_packh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="cm">/* done with this frame? */</span>
			    <span class="p">(</span><span class="n">p_packh</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">NextFrame</span><span class="p">;</span>
			<span class="n">bytes_to_mov</span> <span class="o">=</span> <span class="n">p_packh</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">pack_off</span> <span class="o">+=</span> <span class="n">bytes_to_mov</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawph</span><span class="p">);</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                	<span class="n">bytes_to_mov</span><span class="o">=</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_logical_link</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

                <span class="cm">/*</span>
<span class="cm">                *  if More-To-Come is set in this frame then we don&#39;t know</span>
<span class="cm">                *  length of entire message, and hence have to allocate</span>
<span class="cm">		*  large buffer   */</span>

                <span class="cm">/*      We are starting a new envelope  */</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_logical_link</span><span class="o">=</span><span class="n">link_num</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">bytes_to_mov</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_ENVELOPE_SIZE</span><span class="o">-</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_offset</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="cm">/*      error     */</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
                        <span class="k">goto</span> <span class="n">NextFrame</span><span class="p">;</span>
                <span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">DO_PACKED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_mtc_envelope</span><span class="o">+</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_offset</span><span class="p">,</span>
				<span class="n">p_packd</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawph</span><span class="p">),</span> <span class="n">bytes_to_mov</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span>	<span class="p">{</span>
                	<span class="n">memcpy</span><span class="p">(</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_mtc_envelope</span><span class="o">+</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_offset</span><span class="p">,</span>
                        	<span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">p_buffer</span><span class="p">,</span> <span class="n">bytes_to_mov</span><span class="p">);</span>
		<span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mtc_this_frm</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">len_of_data</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_offset</span><span class="o">+</span><span class="n">bytes_to_mov</span><span class="p">;</span>
                        <span class="n">skb</span><span class="o">=</span><span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len_of_data</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">len_of_data</span><span class="p">),</span>
					<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_mtc_envelope</span><span class="p">,</span>
					<span class="n">len_of_data</span><span class="p">);</span>
                                <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">=</span><span class="n">dev</span><span class="p">;</span>
				<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
                                <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">);</span>
                                <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span><span class="o">=</span><span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
                                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="o">+=</span><span class="n">len_of_data</span><span class="p">;</span>
                                <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">p_dev</span><span class="p">,</span> <span class="s">&quot;Allocating a buffer for&quot;</span>
					<span class="s">&quot; incoming data failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_logical_link</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">mtc_offset</span><span class="o">+=</span><span class="n">bytes_to_mov</span><span class="p">;</span>
                <span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">==</span> <span class="n">DO_PACKED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unpack_next</span><span class="p">;</span>
<span class="nl">NextFrame:</span>
                <span class="cm">/*</span>
<span class="cm">                *   Remove ThisCCWblock from active read queue, and add it</span>
<span class="cm">                *   to queue of free blocks to be reused.</span>
<span class="cm">                */</span>
                <span class="n">i</span><span class="o">++</span><span class="p">;</span>
                <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
                <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">opcode</span><span class="o">=</span><span class="mh">0xff</span><span class="p">;</span>
                <span class="cm">/*</span>
<span class="cm">                *       add this one to the free queue for later reuse</span>
<span class="cm">                */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p_first_ccw</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">p_first_ccw</span> <span class="o">=</span> <span class="n">p_this_ccw</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                        <span class="n">p_last_ccw</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">p_this_ccw</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">p_last_ccw</span> <span class="o">=</span> <span class="n">p_this_ccw</span><span class="p">;</span>
                <span class="cm">/*</span>
<span class="cm">                *       chain to next block on active read queue</span>
<span class="cm">                */</span>
                <span class="n">p_this_ccw</span> <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_first</span><span class="p">;</span>
		<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;rxpkt %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
        <span class="p">}</span> <span class="cm">/* end of while */</span>

        <span class="cm">/*      check validity                  */</span>

	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;rxfrm %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">add_claw_reads</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p_first_ccw</span><span class="p">,</span> <span class="n">p_last_ccw</span><span class="p">);</span>
        <span class="n">claw_strt_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCK_YES</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>     <span class="cm">/*  end of unpack_read   */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*       claw_strt_read                                               *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_strt_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span> <span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span>        <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">__u32</span>      <span class="n">parm</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">saveflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span><span class="n">p_ccwbk</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span><span class="n">p_ch</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">clawh</span> <span class="o">*</span><span class="n">p_clawh</span><span class="p">;</span>
	<span class="n">p_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">];</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;StRdNter&quot;</span><span class="p">);</span>
        <span class="n">p_clawh</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">clawh</span> <span class="o">*</span><span class="p">)</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_claw_signal_blk</span><span class="p">;</span>
        <span class="n">p_clawh</span><span class="o">-&gt;</span><span class="n">flag</span><span class="o">=</span><span class="n">CLAW_IDLE</span><span class="p">;</span>    <span class="cm">/* 0x00 */</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="o">!=</span><span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
             <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="o">!=</span><span class="n">CLAW_PENDING</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_first</span><span class="o">!=</span><span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
             <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_first</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="o">!=</span><span class="n">CLAW_PENDING</span> <span class="p">))</span> <span class="p">{</span>
                <span class="n">p_clawh</span><span class="o">-&gt;</span><span class="n">flag</span><span class="o">=</span><span class="n">CLAW_BUSY</span><span class="p">;</span>    <span class="cm">/* 0xff */</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="o">==</span><span class="n">LOCK_YES</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">IO_active</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;HotRead&quot;</span><span class="p">);</span>
                <span class="n">p_ccwbk</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_read_active_first</span><span class="p">;</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">p_ch</span><span class="p">;</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_start</span> <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p_ccwbk</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">,</span> <span class="n">parm</span><span class="p">,</span>
				       <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">ccw_check_return_code</span><span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;ReadAct&quot;</span><span class="p">);</span>
	<span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="o">==</span><span class="n">LOCK_YES</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>
        <span class="p">}</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;StRdExit&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>       <span class="cm">/*    end of claw_strt_read    */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*       claw_strt_out_IO                                             *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_strt_out_IO</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span>             	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span>   	<span class="n">parm</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">claw_privbk</span> 	<span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">chbk</span>     	<span class="o">*</span><span class="n">p_ch</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ccwbk</span>   	<span class="o">*</span><span class="n">p_first_ccw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">p_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">];</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;strt_io&quot;</span><span class="p">);</span>
        <span class="n">p_first_ccw</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">claw_state</span> <span class="o">==</span> <span class="n">CLAW_STOP</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p_first_ccw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">IO_active</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">p_ch</span><span class="p">;</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;StWrtIO&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_start</span><span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p_first_ccw</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">,</span> <span class="n">parm</span><span class="p">,</span>
				      <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">ccw_check_return_code</span><span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>       <span class="cm">/*    end of claw_strt_out_IO    */</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*       Free write buffers                                           *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_free_wrt_buf</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span><span class="n">p_this_ccw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccwbk</span><span class="o">*</span><span class="n">p_next_ccw</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;freewrtb&quot;</span><span class="p">);</span>
        <span class="cm">/*  scan the write queue to free any completed write packets   */</span>
        <span class="n">p_this_ccw</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">p_this_ccw</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="o">!=</span><span class="n">CLAW_PENDING</span><span class="p">))</span>
        <span class="p">{</span>
                <span class="n">p_next_ccw</span> <span class="o">=</span> <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(((</span><span class="n">p_next_ccw</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">p_next_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="o">!=</span><span class="n">CLAW_PENDING</span><span class="p">))</span> <span class="o">||</span>
                    <span class="p">((</span><span class="n">p_this_ccw</span> <span class="o">==</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_last</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                     <span class="p">(</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="o">!=</span><span class="n">CLAW_PENDING</span><span class="p">)))</span> <span class="p">{</span>
                        <span class="cm">/* The next CCW is OK or this is  */</span>
			<span class="cm">/* the last CCW...free it   @A1A  */</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="o">=</span><span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span><span class="o">=</span><span class="n">CLAW_PENDING</span><span class="p">;</span>
                        <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span><span class="p">;</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_free_chain</span><span class="o">=</span><span class="n">p_this_ccw</span><span class="p">;</span>
                        <span class="o">++</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span><span class="p">;</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="o">+=</span> <span class="n">p_this_ccw</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
			<span class="n">p_this_ccw</span><span class="o">=</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="p">;</span>
                        <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">claw_clearbit_busy</span><span class="p">(</span><span class="n">TB_NOBUFFER</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/*   whole chain removed?   */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_first</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_write_active_last</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;FWC=%d&quot;</span><span class="p">,</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">write_free_count</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">*       claw free netdevice                                          *</span>
<span class="cm">*                                                                    *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_free_netdevice</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">free_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;free_dev&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_RUNNING</span><span class="p">)</span>
		<span class="n">claw_release</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="cm">/* say it&#39;s free */</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef MODULE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;free_ok&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Claw init netdevice</span>
<span class="cm"> * Initialize everything of the net device except the name and the</span>
<span class="cm"> * channel structs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">claw_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">claw_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">claw_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">claw_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">claw_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">claw_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_init_netdevice</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;init_dev&quot;</span><span class="p">);</span>
	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">CLAW_DEFAULT_MTU_SIZE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_SLIP</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">1300</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IFF_POINTOPOINT</span> <span class="o">|</span> <span class="n">IFF_NOARP</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">claw_netdev_ops</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;initok&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Init a new channel in the privptr-&gt;channel[i].</span>
<span class="cm"> *</span>
<span class="cm"> * @param cdev  The ccw_device to be added.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, !0 on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">add_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">chbk</span> <span class="o">*</span><span class="n">p_ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span>  <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>   <span class="cm">/* Read is 1 Write is 2 */</span>
	<span class="n">p_ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">CLAW_ID_SIZE</span><span class="p">,</span> <span class="s">&quot;cl-%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">ccw_device_get_id</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">devno</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p_ch</span><span class="o">-&gt;</span><span class="n">irb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">irb</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> * Setup an interface.</span>
<span class="cm"> *</span>
<span class="cm"> * @param cgdev  Device to be setup.</span>
<span class="cm"> *</span>
<span class="cm"> * @returns 0 on success, !0 on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_new_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span><span class="n">p_env</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;add for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;new_dev&quot;</span><span class="p">);</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">privptr</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">privptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">privptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">p_env</span> <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="n">ccw_device_get_id</span><span class="p">(</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">;</span>
	<span class="n">ccw_device_get_id</span><span class="p">(</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">add_channel</span><span class="p">(</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">privptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">add_channel</span><span class="p">(</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="n">privptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Creating a CLAW group device&quot;</span>
			<span class="s">&quot; failed with error code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccw_device_set_online</span><span class="p">(</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Setting the read subchannel online&quot;</span>
			<span class="s">&quot; failed with error code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccw_device_set_online</span><span class="p">(</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Setting the write subchannel online &quot;</span>
			<span class="s">&quot;failed with error code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;claw%d&quot;</span><span class="p">,</span><span class="n">claw_init_netdevice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Activating the CLAW device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">=</span> <span class="n">privptr</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">privptr</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">privptr</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">privptr</span><span class="p">);</span>
	<span class="cm">/* sysfs magic */</span>
        <span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">claw_free_netdevice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;regfail&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=~</span><span class="n">IFF_RUNNING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">buffs_alloc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">ret</span><span class="o">=</span><span class="n">init_ccw_bk</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">claw_free_netdevice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;ccwmem&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">].</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:readsize=%d  writesize=%d &quot;</span>
		<span class="s">&quot;readbuffer=%d writebuffer=%d read=0x%04x write=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="p">,</span>
		<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_buffers</span><span class="p">,</span>
		<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_buffers</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">],</span>
		<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">]);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:host_name:%.8s, adapter_name &quot;</span>
		<span class="s">&quot;:%.8s api_type: %.8s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span>
		<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">adapter_name</span> <span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_purge_skb_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;purgque&quot;</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span> <span class="p">{</span>
                <span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
                <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Shutdown an interface.</span>
<span class="cm"> *</span>
<span class="cm"> * @param cgdev  Device to be shut down.</span>
<span class="cm"> *</span>
<span class="cm"> * @returns 0 on success, !0 on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">claw_shutdown_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">ndev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Close the device */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: shutting down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_RUNNING</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">claw_release</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=~</span><span class="n">IFF_RUNNING</span><span class="p">;</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="cm">/* cgdev data, not ndev&#39;s to free */</span>
		<span class="n">claw_free_netdevice</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">].</span><span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">].</span><span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">claw_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cgdev</span><span class="p">);</span>
	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; will be removed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CCWGROUP_ONLINE</span><span class="p">)</span>
		<span class="n">claw_shutdown_device</span><span class="p">(</span><span class="n">cgdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_mtc_envelope</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_mtc_envelope</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irb</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">irb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">irb</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="n">READ_CHANNEL</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="n">WRITE_CHANNEL</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * sysfs attributes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">claw_hname_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span>  <span class="n">p_env</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">p_env</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">claw_hname_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span>  <span class="n">p_env</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">p_env</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_NAME_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">MAX_NAME_LEN</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">[</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>  <span class="cm">/* clear extra 0x0a */</span>
	<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">[</span><span class="n">MAX_NAME_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;HstnSet&quot;</span><span class="p">);</span>
	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">host_name</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">claw_hname_show</span><span class="p">,</span> <span class="n">claw_hname_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">claw_adname_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span>  <span class="n">p_env</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">p_env</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">claw_adname_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span>  <span class="n">p_env</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">p_env</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_NAME_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">MAX_NAME_LEN</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">[</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* clear extra 0x0a */</span>
	<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">[</span><span class="n">MAX_NAME_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;AdnSet&quot;</span><span class="p">);</span>
	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">adapter_name</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">claw_adname_show</span><span class="p">,</span> <span class="n">claw_adname_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">claw_apname_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span>  <span class="n">p_env</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">p_env</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">claw_apname_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span>  <span class="n">p_env</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">p_env</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_NAME_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">MAX_NAME_LEN</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span><span class="p">[</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>  <span class="cm">/* we get a loose 0x0a */</span>
	<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span><span class="p">[</span><span class="n">MAX_NAME_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span><span class="p">,</span><span class="n">WS_APPL_NAME_PACKED</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="o">=</span><span class="n">DEF_PACK_BUFSIZE</span><span class="p">;</span>
		<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="o">=</span><span class="n">DEF_PACK_BUFSIZE</span><span class="p">;</span>
		<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span><span class="o">=</span><span class="n">PACKING_ASK</span><span class="p">;</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;PACKING&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span><span class="o">=</span><span class="n">CLAW_FRAME_SIZE</span><span class="p">;</span>
		<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="o">=</span><span class="n">CLAW_FRAME_SIZE</span><span class="p">;</span>
		<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;ApiSet&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">api_type</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">claw_apname_show</span><span class="p">,</span> <span class="n">claw_apname_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">claw_wbuff_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span> <span class="n">p_env</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">p_env</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_buffers</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">claw_wbuff_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span>  <span class="n">p_env</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nnn</span><span class="p">,</span><span class="n">max</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">p_env</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nnn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">max</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nnn</span> <span class="o">&gt;</span> <span class="n">max</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">nnn</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_buffers</span> <span class="o">=</span> <span class="n">nnn</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;Wbufset&quot;</span><span class="p">);</span>
	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;WB=%d&quot;</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_buffers</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">write_buffer</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">claw_wbuff_show</span><span class="p">,</span> <span class="n">claw_wbuff_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">claw_rbuff_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span>  <span class="n">p_env</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">p_env</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_buffers</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">claw_rbuff_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">claw_env</span> <span class="o">*</span><span class="n">p_env</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nnn</span><span class="p">,</span><span class="n">max</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">p_env</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="p">;</span>
	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nnn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">max</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nnn</span> <span class="o">&gt;</span> <span class="n">max</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">nnn</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_buffers</span> <span class="o">=</span> <span class="n">nnn</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;Rbufset&quot;</span><span class="p">);</span>
	<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;RB=%d&quot;</span><span class="p">,</span> <span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_buffers</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">read_buffer</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">claw_rbuff_show</span><span class="p">,</span> <span class="n">claw_rbuff_write</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">claw_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_read_buffer</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_write_buffer</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_adapter_name</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_api_type</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_host_name</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">claw_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">claw_attr</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">claw_attr_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">claw_attr_group</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">device_type</span> <span class="n">claw_devtype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;claw&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">claw_attr_groups</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------*</span>
<span class="cm"> *   claw_probe 						  *</span>
<span class="cm"> *	this function is called for each CLAW device.		  *</span>
<span class="cm"> *----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">claw_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">claw_privbk</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;probe&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">privptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">claw_privbk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">privptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">probe_error</span><span class="p">(</span><span class="n">cgdev</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;probex%d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_mtc_envelope</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">MAX_ENVELOPE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">claw_env</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_mtc_envelope</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">probe_error</span><span class="p">(</span><span class="n">cgdev</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">CLAW_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;probex%d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">,</span> <span class="n">WS_NAME_NOT_DEF</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span> <span class="n">WS_NAME_NOT_DEF</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">api_type</span><span class="p">,</span> <span class="n">WS_NAME_NOT_DEF</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">packing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_buffers</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_buffers</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">read_size</span> <span class="o">=</span> <span class="n">CLAW_FRAME_SIZE</span><span class="p">;</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">write_size</span> <span class="o">=</span> <span class="n">CLAW_FRAME_SIZE</span><span class="p">;</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">p_env</span><span class="o">-&gt;</span><span class="n">p_priv</span> <span class="o">=</span> <span class="n">privptr</span><span class="p">;</span>
	<span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">claw_irq_handler</span><span class="p">;</span>
	<span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">claw_irq_handler</span><span class="p">;</span>
	<span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">claw_devtype</span><span class="p">;</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;prbext 0&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>  <span class="cm">/*  end of claw_probe       */</span>

<span class="cm">/*--------------------------------------------------------------------*</span>
<span class="cm">*    claw_init  and cleanup                                           *</span>
<span class="cm">*---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">claw_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccwgroup_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">claw_group_driver</span><span class="p">);</span>
	<span class="n">ccw_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">claw_ccw_driver</span><span class="p">);</span>
	<span class="n">root_device_unregister</span><span class="p">(</span><span class="n">claw_root_dev</span><span class="p">);</span>
	<span class="n">claw_unregister_debug_facility</span><span class="p">();</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Driver unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Initialize module.</span>
<span class="cm"> * This is called just after the module is loaded.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, !0 on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">claw_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Loading %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">claw_register_debug_facility</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Registering with the S/390 debug feature&quot;</span>
			<span class="s">&quot; failed with error code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;init_mod&quot;</span><span class="p">);</span>
	<span class="n">claw_root_dev</span> <span class="o">=</span> <span class="n">root_device_register</span><span class="p">(</span><span class="s">&quot;claw&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">claw_root_dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">claw_root_dev</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">register_err</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccw_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">claw_ccw_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ccw_err</span><span class="p">;</span>
	<span class="n">claw_group_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">claw_drv_attr_groups</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccwgroup_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">claw_group_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ccwgroup_err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">ccwgroup_err:</span>
	<span class="n">ccw_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">claw_ccw_driver</span><span class="p">);</span>
<span class="nl">ccw_err:</span>
	<span class="n">root_device_unregister</span><span class="p">(</span><span class="n">claw_root_dev</span><span class="p">);</span>
<span class="nl">register_err:</span>
	<span class="n">CLAW_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;init_bad&quot;</span><span class="p">);</span>
	<span class="n">claw_unregister_debug_facility</span><span class="p">();</span>
<span class="nl">out_err:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Initializing the claw device driver failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">claw_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">claw_cleanup</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andy Richter &lt;richtera@us.ibm.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Linux for System z CLAW Driver</span><span class="se">\n</span><span class="s">&quot;</span> \
			<span class="s">&quot;Copyright 2000,2008 IBM Corporation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
