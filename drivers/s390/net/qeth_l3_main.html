<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › net › qeth_l3_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qeth_l3_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/s390/net/qeth_l3_main.c</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright IBM Corp. 2007, 2009</span>
<span class="cm"> *    Author(s): Utz Bacher &lt;utz.bacher@de.ibm.com&gt;,</span>
<span class="cm"> *		 Frank Pavlic &lt;fpavlic@de.ibm.com&gt;,</span>
<span class="cm"> *		 Thomas Spatzier &lt;tspat@de.ibm.com&gt;,</span>
<span class="cm"> *		 Frank Blaschka &lt;frank.blaschka@de.ibm.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;qeth&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/igmp.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>

<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/arp.h&gt;</span>
<span class="cp">#include &lt;net/route.h&gt;</span>
<span class="cp">#include &lt;net/ip6_fib.h&gt;</span>
<span class="cp">#include &lt;net/ip6_checksum.h&gt;</span>
<span class="cp">#include &lt;net/iucv/af_iucv.h&gt;</span>

<span class="cp">#include &quot;qeth_l3.h&quot;</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">qeth_l3_set_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qeth_l3_recover</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qeth_l3_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qeth_l3_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qeth_l3_neigh_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">neigh_parms</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qeth_l3_register_addr_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qeth_l3_deregister_addr_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__qeth_l3_set_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__qeth_l3_set_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_isxdigit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isxdigit</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_l3_ipaddr4_to_string</span><span class="p">(</span><span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i.%i.%i.%i&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_l3_string_to_ipaddr4</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u.%u.%u.%u%c&quot;</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_l3_ipaddr6_to_string</span><span class="p">(</span><span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI6&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_l3_string_to_ipaddr6</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">end_tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="o">*</span><span class="n">in</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">num</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">num2</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">save_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">in_tmp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">out</span> <span class="o">=</span> <span class="n">found</span> <span class="o">=</span> <span class="n">save_cnt</span> <span class="o">=</span> <span class="n">num2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">in</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">end_tmp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">end_tmp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">end</span> <span class="o">=</span> <span class="n">end_tmp</span><span class="p">;</span>
			<span class="n">out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_isxdigit</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">sscanf</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
				<span class="n">in_tmp</span><span class="p">[</span><span class="n">save_cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">num2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">in</span><span class="p">[</span><span class="n">cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">num2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start</span> <span class="o">=</span> <span class="o">++</span><span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">+</span> <span class="n">save_cnt</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">save_cnt</span><span class="p">)</span>
		<span class="n">in</span><span class="p">[</span><span class="n">cnt</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_tmp</span><span class="p">[</span><span class="o">--</span><span class="n">save_cnt</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_l3_ipaddr_to_string</span><span class="p">(</span><span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">proto</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span>
		<span class="n">qeth_l3_ipaddr4_to_string</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span>
		<span class="n">qeth_l3_ipaddr6_to_string</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_l3_string_to_ipaddr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">proto</span><span class="p">,</span>
				<span class="n">__u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">qeth_l3_string_to_ipaddr4</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">qeth_l3_string_to_ipaddr6</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_convert_addr_to_bits</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">octet</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">octet</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">octet</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">octet</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_l3_is_addr_covered_by_ipato</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipato_entry</span> <span class="o">*</span><span class="n">ipatoe</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr_bits</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">ipatoe_bits</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipato</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qeth_l3_convert_addr_to_bits</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">,</span> <span class="n">addr_bits</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span><span class="o">?</span> <span class="mi">4</span><span class="o">:</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ipatoe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipato</span><span class="p">.</span><span class="n">entries</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">qeth_l3_convert_addr_to_bits</span><span class="p">(</span><span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ipatoe_bits</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="o">?</span>
					  <span class="mi">4</span> <span class="o">:</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">addr_bits</span><span class="p">,</span> <span class="n">ipatoe_bits</span><span class="p">,</span>
				     <span class="n">min</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">mask_bits</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">addr_bits</span><span class="p">,</span> <span class="n">ipatoe_bits</span><span class="p">,</span>
				     <span class="n">min</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">mask_bits</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* invert? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ipato</span><span class="p">.</span><span class="n">invert4</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">!</span><span class="n">rc</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ipato</span><span class="p">.</span><span class="n">invert6</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">!</span><span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add IP to be added to todo list. If there is already an &quot;add todo&quot;</span>
<span class="cm"> * in this list we just incremenent the reference count.</span>
<span class="cm"> * Returns 0 if we  just incremented reference count.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qeth_l3_insert_ip_todo</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">sniffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_IP_TYPE_DEL_ALL_MC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_IP_TYPE_DEL_ALL_MC</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">proto</span>        <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span>     <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span>       <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span>     <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span>         <span class="o">==</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>         <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">is_multicast</span> <span class="o">==</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">is_multicast</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span>    <span class="o">==</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span>    <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">mask</span>    <span class="o">==</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">proto</span>        <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span>      <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span>       <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span>      <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span>         <span class="o">==</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>          <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">is_multicast</span> <span class="o">==</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">is_multicast</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">pfxlen</span>  <span class="o">==</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">pfxlen</span><span class="p">)</span>   <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">+=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">+=</span> <span class="n">add</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_IP_TYPE_DEL_ALL_MC</span><span class="p">)</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">addr</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">+=</span> <span class="n">add</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">add</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_IP_TYPE_NORMAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">qeth_l3_is_addr_covered_by_ipato</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;tkovaddr&quot;</span><span class="p">);</span>
				<span class="n">addr</span><span class="o">-&gt;</span><span class="n">set_flags</span> <span class="o">|=</span> <span class="n">QETH_IPA_SETIP_TAKEOVER_FLAG</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_l3_delete_ip</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;delip&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__qeth_l3_insert_ip_todo</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_l3_add_ip</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;addip&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__qeth_l3_insert_ip_todo</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="nf">qeth_l3_get_addr_buffer</span><span class="p">(</span>
				<span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipaddr</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">QETH_IP_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="n">prot</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_delete_mc_addresses</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">iptodo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;delmc&quot;</span><span class="p">);</span>
	<span class="n">iptodo</span> <span class="o">=</span> <span class="n">qeth_l3_get_addr_buffer</span><span class="p">(</span><span class="n">QETH_PROT_IPV4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iptodo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;dmcnomem&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iptodo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">QETH_IP_TYPE_DEL_ALL_MC</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__qeth_l3_insert_ip_todo</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iptodo</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">iptodo</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add/remove address to/from card&#39;s ip list, i.e. try to add or remove</span>
<span class="cm"> * reference to/from an IP address that is already registered on the card.</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	0  address was on card and its reference count has been adjusted,</span>
<span class="cm"> *	   but is still &gt; 0, so nothing has to be done</span>
<span class="cm"> *	   also returns 0 if card was not on card and the todo was to delete</span>
<span class="cm"> *	   the address -&gt; there is also nothing to be done</span>
<span class="cm"> *	1  address was not on card and the todo is to add it to the card&#39;s ip</span>
<span class="cm"> *	   list</span>
<span class="cm"> *	-1 address was on card and its reference count has been decremented</span>
<span class="cm"> *	   to &lt;= 0 by the todo -&gt; address must be removed from card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qeth_l3_ref_ip_on_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">todo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">**</span><span class="n">__addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">todo</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">todo</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span> <span class="o">==</span> <span class="n">todo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">mask</span> <span class="o">==</span> <span class="n">todo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">todo</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">todo</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">pfxlen</span> <span class="o">==</span> <span class="n">todo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">pfxlen</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">todo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">+=</span> <span class="n">todo</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">__addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* for VIPA and RXIP limit refcount to 1 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QETH_IP_TYPE_NORMAL</span><span class="p">)</span>
				<span class="n">addr</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">todo</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for VIPA and RXIP limit refcount to 1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">todo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QETH_IP_TYPE_NORMAL</span><span class="p">)</span>
			<span class="n">todo</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__qeth_l3_delete_all_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">fail_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fail_list</span><span class="p">);</span>
<span class="nl">again:</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">is_multicast</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="o">*</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_deregister_addr_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="o">*</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">||</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IPA_RC_MC_ADDR_NOT_FOUND</span><span class="p">))</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fail_list</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fail_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_l3_set_ip_addr_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tbd_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">todo</span><span class="p">,</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;sdiplist&quot;</span><span class="p">);</span>
	<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_STATE_UP</span> <span class="o">&amp;&amp;</span>
	     <span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_STATE_SOFTSETUP</span><span class="p">)</span> <span class="o">||</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">sniffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tbd_list</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;silnomem&quot;</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span> <span class="o">=</span> <span class="n">tbd_list</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">tbd_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">todo</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tbd_list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_ipaddr</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">todo</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">todo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_IP_TYPE_DEL_ALL_MC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__qeth_l3_delete_all_mc</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">__qeth_l3_ref_ip_on_card</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">todo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* nothing to be done; only adjusted refcount */</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* new entry to be added to on-card list */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_register_addr_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">todo</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">||</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IPA_RC_LAN_OFFLINE</span><span class="p">))</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">todo</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_list</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* on-card entry to be removed */</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_deregister_addr_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">||</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IPA_RC_IP_ADDRESS_NOT_DEFINED</span><span class="p">))</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">todo</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tbd_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_clear_ip_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">recover</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;clearip&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recover</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">sniffer</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* clear todo list */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">qeth_ipaddr</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">recover</span> <span class="o">||</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">is_multicast</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_address_exists_in_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">same_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">same_type</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">same_type</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span> <span class="o">==</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">same_type</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">same_type</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_send_setdelmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ipacmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setdelmc&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipacmd</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setdelipm</span><span class="p">.</span><span class="n">mac</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">OSA_ADDR_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setdelipm</span><span class="p">.</span><span class="n">ip6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setdelipm</span><span class="p">.</span><span class="n">ip4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_fill_netmask</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">netmask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">netmask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">netmask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="mh">0xFF00</span> <span class="o">&gt;&gt;</span> <span class="n">j</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">netmask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_send_setdelip</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ipacmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">netmask</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setdelip&quot;</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;flags%02X&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipacmd</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setdelip6</span><span class="p">.</span><span class="n">ip_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">));</span>
		<span class="n">qeth_l3_fill_netmask</span><span class="p">(</span><span class="n">netmask</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">pfxlen</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setdelip6</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">netmask</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setdelip6</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setdelip4</span><span class="p">.</span><span class="n">ip_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setdelip4</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setdelip4</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_send_setrouting</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">qeth_routing_types</span> <span class="n">type</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setroutg&quot;</span><span class="p">);</span>
	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_CMD_SETRTG</span><span class="p">,</span> <span class="n">prot</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setrtg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_correct_routing_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">qeth_routing_types</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NO_ROUTER</span>:
		<span class="k">case</span> <span class="n">PRIMARY_CONNECTOR</span>:
		<span class="k">case</span> <span class="n">SECONDARY_CONNECTOR</span>:
		<span class="k">case</span> <span class="n">MULTICAST_ROUTER</span>:
			<span class="k">return</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">out_inval</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NO_ROUTER</span>:
		<span class="k">case</span> <span class="n">PRIMARY_ROUTER</span>:
		<span class="k">case</span> <span class="n">SECONDARY_ROUTER</span>:
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MULTICAST_ROUTER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">qeth_is_ipafunc_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span>
						      <span class="n">IPA_OSA_MC_ROUTER</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">out_inval</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out_inval:</span>
	<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">NO_ROUTER</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_l3_setrouting_v4</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;setrtg4&quot;</span><span class="p">);</span>

	<span class="n">qeth_l3_correct_routing_type</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">route4</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
				  <span class="n">QETH_PROT_IPV4</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_setrouting</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">route4</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
				  <span class="n">QETH_PROT_IPV4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">route4</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NO_ROUTER</span><span class="p">;</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Error (0x%04x) while setting routing type&quot;</span>
			<span class="s">&quot; on %s. Type set to &#39;no router&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_l3_setrouting_v6</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;setrtg6&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_QETH_IPV6</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_IPV6</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qeth_l3_correct_routing_type</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">route6</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
				  <span class="n">QETH_PROT_IPV6</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_setrouting</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">route6</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
				  <span class="n">QETH_PROT_IPV6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">route6</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NO_ROUTER</span><span class="p">;</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Error (0x%04x) while setting routing type&quot;</span>
			<span class="s">&quot; on %s. Type set to &#39;no router&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IP address takeover related functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_clear_ipato_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">qeth_ipato_entry</span> <span class="o">*</span><span class="n">ipatoe</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ipatoe</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipato</span><span class="p">.</span><span class="n">entries</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ipatoe</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_l3_add_ipato_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qeth_ipato_entry</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipato_entry</span> <span class="o">*</span><span class="n">ipatoe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;addipato&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ipatoe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipato</span><span class="p">.</span><span class="n">entries</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span><span class="o">?</span> <span class="mi">4</span><span class="o">:</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">mask_bits</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">mask_bits</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipato</span><span class="p">.</span><span class="n">entries</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_l3_del_ipato_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">proto</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipato_entry</span> <span class="o">*</span><span class="n">ipatoe</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;delipato&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ipatoe</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipato</span><span class="p">.</span><span class="n">entries</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">proto</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span><span class="o">?</span> <span class="mi">4</span><span class="o">:</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">mask_bits</span> <span class="o">==</span> <span class="n">mask_bits</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipatoe</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ipatoe</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * VIPA related functions</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qeth_l3_add_vipa</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">proto</span><span class="p">,</span>
	      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">ipaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ipaddr</span> <span class="o">=</span> <span class="n">qeth_l3_get_addr_buffer</span><span class="p">(</span><span class="n">proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;addvipa4&quot;</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;addvipa6&quot;</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">pfxlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">QETH_IP_TYPE_VIPA</span><span class="p">;</span>
		<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">set_flags</span> <span class="o">=</span> <span class="n">QETH_IPA_SETIP_VIPA_FLAG</span><span class="p">;</span>
		<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">del_flags</span> <span class="o">=</span> <span class="n">QETH_IPA_DELIP_VIPA_FLAG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_l3_address_exists_in_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_list</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">qeth_l3_address_exists_in_list</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_add_ip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">);</span>
	<span class="n">qeth_l3_set_ip_addr_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_l3_del_vipa</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">proto</span><span class="p">,</span>
	      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">ipaddr</span><span class="p">;</span>

	<span class="n">ipaddr</span> <span class="o">=</span> <span class="n">qeth_l3_get_addr_buffer</span><span class="p">(</span><span class="n">proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;delvipa4&quot;</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;delvipa6&quot;</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">pfxlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">QETH_IP_TYPE_VIPA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_delete_ip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">);</span>
	<span class="n">qeth_l3_set_ip_addr_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * proxy ARP related functions</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qeth_l3_add_rxip</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">proto</span><span class="p">,</span>
	      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">ipaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ipaddr</span> <span class="o">=</span> <span class="n">qeth_l3_get_addr_buffer</span><span class="p">(</span><span class="n">proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;addrxip4&quot;</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;addrxip6&quot;</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">pfxlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">QETH_IP_TYPE_RXIP</span><span class="p">;</span>
		<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">set_flags</span> <span class="o">=</span> <span class="n">QETH_IPA_SETIP_TAKEOVER_FLAG</span><span class="p">;</span>
		<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">del_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_l3_address_exists_in_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_list</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">qeth_l3_address_exists_in_list</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_add_ip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">);</span>
	<span class="n">qeth_l3_set_ip_addr_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_l3_del_rxip</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">proto</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">ipaddr</span><span class="p">;</span>

	<span class="n">ipaddr</span> <span class="o">=</span> <span class="n">qeth_l3_get_addr_buffer</span><span class="p">(</span><span class="n">proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;addrxip4&quot;</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;addrxip6&quot;</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">pfxlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ipaddr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">QETH_IP_TYPE_RXIP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_delete_ip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">);</span>
	<span class="n">qeth_l3_set_ip_addr_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_register_addr_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;setaddr4&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;setaddr6&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;setaddr?&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipaddr</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">is_multicast</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span>  <span class="n">qeth_l3_send_setdelmc</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">IPA_CMD_SETIPM</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_setdelip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">IPA_CMD_SETIP</span><span class="p">,</span>
					<span class="n">addr</span><span class="o">-&gt;</span><span class="n">set_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;failed&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">--</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;FAILED&quot;</span><span class="p">);</span>
		<span class="n">qeth_l3_ipaddr_to_string</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Registering IP address %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_deregister_addr_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;deladdr4&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;deladdr6&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;deladdr?&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipaddr</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">is_multicast</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_setdelmc</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">IPA_CMD_DELIPM</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_setdelip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">IPA_CMD_DELIP</span><span class="p">,</span>
					<span class="n">addr</span><span class="o">-&gt;</span><span class="n">del_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;failed&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">qeth_l3_get_qeth_hdr_flags4</span><span class="p">(</span><span class="kt">int</span> <span class="n">cast_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cast_type</span> <span class="o">==</span> <span class="n">RTN_MULTICAST</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QETH_CAST_MULTICAST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cast_type</span> <span class="o">==</span> <span class="n">RTN_BROADCAST</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QETH_CAST_BROADCAST</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">QETH_CAST_UNICAST</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">qeth_l3_get_qeth_hdr_flags6</span><span class="p">(</span><span class="kt">int</span> <span class="n">cast_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ct</span> <span class="o">=</span> <span class="n">QETH_HDR_PASSTHRU</span> <span class="o">|</span> <span class="n">QETH_HDR_IPV6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cast_type</span> <span class="o">==</span> <span class="n">RTN_MULTICAST</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ct</span> <span class="o">|</span> <span class="n">QETH_CAST_MULTICAST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cast_type</span> <span class="o">==</span> <span class="n">RTN_ANYCAST</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ct</span> <span class="o">|</span> <span class="n">QETH_CAST_ANYCAST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cast_type</span> <span class="o">==</span> <span class="n">RTN_BROADCAST</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ct</span> <span class="o">|</span> <span class="n">QETH_CAST_BROADCAST</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ct</span> <span class="o">|</span> <span class="n">QETH_CAST_UNICAST</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_setadapter_parms</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;setadprm&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADAPTERPARMS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;set adapter parameters not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot; notsupp&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_query_setadapterparms</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s couldn&#39;t set adapter parameters: &quot;</span>
			<span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_adp_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_ALTER_MAC_ADDRESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_setadpparms_change_macaddr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reading the adapter MAC&quot;</span>
				<span class="s">&quot; address failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_default_setassparms_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;defadpcb&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">prot_version</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">ipa4</span><span class="p">.</span><span class="n">enabled_funcs</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ipa_enabled</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">prot_version</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">ipa6</span><span class="p">.</span><span class="n">enabled_funcs</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ipa_enabled</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">assist_no</span> <span class="o">==</span> <span class="n">IPA_INBOUND_CHECKSUM</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">command_code</span> <span class="o">==</span> <span class="n">IPA_CMD_ASS_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">csum_mask</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags_32bit</span><span class="p">;</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;csum:%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">csum_mask</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">assist_no</span> <span class="o">==</span> <span class="n">IPA_OUTBOUND_CHECKSUM</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">command_code</span> <span class="o">==</span> <span class="n">IPA_CMD_ASS_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx_csum_mask</span> <span class="o">=</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags_32bit</span><span class="p">;</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;tcsu:%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx_csum_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="nf">qeth_l3_get_setassparms_cmd</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_ipa_funcs</span> <span class="n">ipa_func</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">cmd_code</span><span class="p">,</span>
	<span class="n">__u16</span> <span class="n">len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;getasscm&quot;</span><span class="p">);</span>
	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_CMD_SETASSPARMS</span><span class="p">,</span> <span class="n">prot</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">assist_no</span> <span class="o">=</span> <span class="n">ipa_func</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">command_code</span> <span class="o">=</span> <span class="n">cmd_code</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">iob</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_send_setassparms</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">len</span><span class="p">,</span> <span class="kt">long</span> <span class="n">data</span><span class="p">,</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">reply_cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">reply_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;sendassp&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">))</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags_32bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">else</span>   <span class="cm">/* (len &gt; sizeof(__u32)) */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">reply_cb</span><span class="p">,</span> <span class="n">reply_param</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QETH_IPV6</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_send_simple_setassparms_ipv6</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">qeth_ipa_funcs</span> <span class="n">ipa_func</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">cmd_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;simassp6&quot;</span><span class="p">);</span>
	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_l3_get_setassparms_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipa_func</span><span class="p">,</span> <span class="n">cmd_code</span><span class="p">,</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="n">QETH_PROT_IPV6</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="n">qeth_l3_default_setassparms_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">qeth_ipa_funcs</span> <span class="n">ipa_func</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">cmd_code</span><span class="p">,</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;simassp4&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">);</span>
	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_l3_get_setassparms_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipa_func</span><span class="p">,</span> <span class="n">cmd_code</span><span class="p">,</span>
				       <span class="n">length</span><span class="p">,</span> <span class="n">QETH_PROT_IPV4</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				   <span class="n">qeth_l3_default_setassparms_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_start_ipa_arp_processing</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;ipaarp&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_ARP_PROCESSING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;ARP processing not supported on %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_ARP_PROCESSING</span><span class="p">,</span>
					<span class="n">IPA_CMD_ASS_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Starting ARP processing support for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_start_ipa_ip_fragmentation</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;ipaipfrg&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_IP_FRAGMENTATION</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Hardware IP fragmentation not supported on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_IP_FRAGMENTATION</span><span class="p">,</span>
					  <span class="n">IPA_CMD_ASS_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Starting IP fragmentation support for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Hardware IP fragmentation enabled </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_start_ipa_source_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;stsrcmac&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SOURCE_MAC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Inbound source MAC-address not supported on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SOURCE_MAC</span><span class="p">,</span>
					  <span class="n">IPA_CMD_ASS_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Starting source MAC-address support for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_start_ipa_vlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;strtvlan&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_FULL_VLAN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;VLAN not supported on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_VLAN_PRIO</span><span class="p">,</span>
					  <span class="n">IPA_CMD_ASS_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Starting VLAN support for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VLAN enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_start_ipa_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;stmcast&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_MULTICASTING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Multicast not supported on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_MULTICASTING</span><span class="p">,</span>
					  <span class="n">IPA_CMD_ASS_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Starting multicast support for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Multicast enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_MULTICAST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QETH_IPV6</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_softsetup_ipv6</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;softipv6&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_query_ipassists</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_PROT_IPV6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Activating IPv6 support for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_IPV6</span><span class="p">,</span>
					  <span class="n">IPA_CMD_ASS_START</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Activating IPv6 support for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms_ipv6</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_IPV6</span><span class="p">,</span>
					       <span class="n">IPA_CMD_ASS_START</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Activating IPv6 support for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms_ipv6</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_PASSTHRU</span><span class="p">,</span>
					       <span class="n">IPA_CMD_ASS_START</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Enabling the passthrough mode for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IPV6 enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_start_ipa_ipv6</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;strtipv6&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_IPV6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;IPv6 not supported on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_QETH_IPV6</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_softsetup_ipv6</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">rc</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_start_ipa_broadcast</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;stbrdcst&quot;</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">broadcast_capable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_FILTERING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Broadcast not supported on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_FILTERING</span><span class="p">,</span>
					  <span class="n">IPA_CMD_ASS_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enabling broadcast filtering for &quot;</span>
			<span class="s">&quot;%s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_FILTERING</span><span class="p">,</span>
					  <span class="n">IPA_CMD_ASS_CONFIGURE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Setting up broadcast filtering for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">broadcast_capable</span> <span class="o">=</span> <span class="n">QETH_BROADCAST_WITH_ECHO</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Broadcast enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_FILTERING</span><span class="p">,</span>
					  <span class="n">IPA_CMD_ASS_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Setting up broadcast echo &quot;</span>
			<span class="s">&quot;filtering for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">broadcast_capable</span> <span class="o">=</span> <span class="n">QETH_BROADCAST_WITHOUT_ECHO</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">broadcast_capable</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_BROADCAST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFF_BROADCAST</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_send_checksum_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_INBOUND_CHECKSUM</span><span class="p">,</span>
					  <span class="n">IPA_CMD_ASS_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Starting HW checksumming for %s &quot;</span>
			<span class="s">&quot;failed, using SW checksumming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_INBOUND_CHECKSUM</span><span class="p">,</span>
					  <span class="n">IPA_CMD_ASS_ENABLE</span><span class="p">,</span>
					  <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">csum_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enabling HW checksumming for %s &quot;</span>
			<span class="s">&quot;failed, using SW checksumming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_set_rx_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_checksum_command</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;HW Checksumming (inbound) enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
			<span class="n">IPA_INBOUND_CHECKSUM</span><span class="p">,</span> <span class="n">IPA_CMD_ASS_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_start_ipa_checksum</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;strtcsum&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="cm">/* force set_features call */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
		<span class="n">netdev_update_features</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_start_ipa_tx_checksum</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_OUTBOUND_CHECKSUM</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_OUTBOUND_CHECKSUM</span><span class="p">,</span>
			  <span class="n">IPA_CMD_ASS_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_OUTBOUND_CHECKSUM</span><span class="p">,</span>
			  <span class="n">IPA_CMD_ASS_ENABLE</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx_csum_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HW TX Checksumming enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">err_out:</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enabling HW TX checksumming for %s &quot;</span>
		<span class="s">&quot;failed, using SW TX checksumming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_start_ipa_tso</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;sttso&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_OUTBOUND_TSO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Outbound TSO not supported on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_OUTBOUND_TSO</span><span class="p">,</span>
						<span class="n">IPA_CMD_ASS_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Starting outbound TCP &quot;</span>
				<span class="s">&quot;segmentation offload for %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Outbound TSO enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_TSO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_start_ipassists</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;strtipas&quot;</span><span class="p">);</span>

	<span class="n">qeth_set_access_ctrl_online</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>	<span class="cm">/* go on*/</span>
	<span class="n">qeth_l3_start_ipa_arp_processing</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>	<span class="cm">/* go on*/</span>
	<span class="n">qeth_l3_start_ipa_ip_fragmentation</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>	<span class="cm">/* go on*/</span>
	<span class="n">qeth_l3_start_ipa_source_mac</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>	<span class="cm">/* go on*/</span>
	<span class="n">qeth_l3_start_ipa_vlan</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>		<span class="cm">/* go on*/</span>
	<span class="n">qeth_l3_start_ipa_multicast</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>		<span class="cm">/* go on*/</span>
	<span class="n">qeth_l3_start_ipa_ipv6</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>		<span class="cm">/* go on*/</span>
	<span class="n">qeth_l3_start_ipa_broadcast</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>		<span class="cm">/* go on*/</span>
	<span class="n">qeth_l3_start_ipa_checksum</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>		<span class="cm">/* go on*/</span>
	<span class="n">qeth_l3_start_ipa_tx_checksum</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">qeth_l3_start_ipa_tso</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>		<span class="cm">/* go on*/</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_iqd_read_initial_mac_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">create_destroy_addr</span><span class="p">.</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">random_ether_addr</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_iqd_read_initial_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;hsrmac&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_CMD_CREATE_ADDR</span><span class="p">,</span>
				     <span class="n">QETH_PROT_IPV6</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="o">*</span><span class="p">((</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">create_destroy_addr</span><span class="p">.</span><span class="n">unique_id</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">=</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">unique_id</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">qeth_l3_iqd_read_initial_mac_cb</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_get_unique_id_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">unique_id</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span>
				<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">create_destroy_addr</span><span class="p">.</span><span class="n">unique_id</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">unique_id</span> <span class="o">=</span>  <span class="n">UNIQUE_ID_IF_CREATE_ADDR_FAILED</span> <span class="o">|</span>
					<span class="n">UNIQUE_ID_NOT_BY_CARD</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The network adapter failed to &quot;</span>
			<span class="s">&quot;generate a unique ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_get_unique_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;guniqeid&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_IPV6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">unique_id</span> <span class="o">=</span>  <span class="n">UNIQUE_ID_IF_CREATE_ADDR_FAILED</span> <span class="o">|</span>
					<span class="n">UNIQUE_ID_NOT_BY_CARD</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_CMD_CREATE_ADDR</span><span class="p">,</span>
				     <span class="n">QETH_PROT_IPV6</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="o">*</span><span class="p">((</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">create_destroy_addr</span><span class="p">.</span><span class="n">unique_id</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">=</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">unique_id</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">qeth_l3_get_unique_id_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qeth_diags_trace_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span>	   <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;diastrcb&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;dxter%x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_DIAGS_CMD_TRACE_QUERY</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_DIAGS_CMD_TRACE_DISABLE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">case</span> <span class="n">IPA_RC_INVALID_SUBCMD</span>:
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">promisc_mode</span> <span class="o">=</span> <span class="n">SET_PROMISC_MODE_OFF</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The HiperSockets network &quot;</span>
				<span class="s">&quot;traffic analyzer is deactivated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_DIAGS_CMD_TRACE_ENABLE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">promisc_mode</span> <span class="o">=</span> <span class="n">SET_PROMISC_MODE_ON</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The HiperSockets network &quot;</span>
				<span class="s">&quot;traffic analyzer is activated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPA_RC_HARDWARE_AUTH_ERROR</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The device is not &quot;</span>
				<span class="s">&quot;authorized to run as a HiperSockets network &quot;</span>
				<span class="s">&quot;traffic analyzer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPA_RC_TRACE_ALREADY_ACTIVE</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A HiperSockets &quot;</span>
				<span class="s">&quot;network traffic analyzer is already &quot;</span>
				<span class="s">&quot;active in the HiperSockets LAN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Unknown sniffer action (0x%04x) on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">action</span><span class="p">,</span> <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qeth_diags_trace</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_diags_trace_cmds</span> <span class="n">diags_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span>    <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;diagtrac&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_CMD_SET_DIAG_ASS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">subcmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">=</span> <span class="n">QETH_DIAGS_CMD_TRACE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">QETH_DIAGS_TYPE_HIPERSOCKET</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">diags_cmd</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">qeth_diags_trace_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_get_mac_for_ipm</span><span class="p">(</span><span class="n">__u32</span> <span class="n">ipm</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ip_eth_mc_map</span><span class="p">(</span><span class="n">ipm</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_add_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in4_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">ipm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im4</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;addmc&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">im4</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">in4_dev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">);</span> <span class="n">im4</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">im4</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">im4</span><span class="o">-&gt;</span><span class="n">next_rcu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qeth_l3_get_mac_for_ipm</span><span class="p">(</span><span class="n">im4</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">in4_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ipm</span> <span class="o">=</span> <span class="n">qeth_l3_get_addr_buffer</span><span class="p">(</span><span class="n">QETH_PROT_IPV4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipm</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ipm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">im4</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">OSA_ADDR_LEN</span><span class="p">);</span>
		<span class="n">ipm</span><span class="o">-&gt;</span><span class="n">is_multicast</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_add_ip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipm</span><span class="p">))</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ipm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_add_vlan_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;addmcvl&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_FULL_VLAN</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">,</span> <span class="n">VLAN_N_VID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">netdev</span> <span class="o">=</span> <span class="n">__vlan_find_dev_deep</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">in_dev</span> <span class="o">=</span> <span class="n">in_dev_get</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">qeth_l3_add_mc</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">in_dev</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="n">in_dev_put</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_add_multicast_ipv4</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in4_dev</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;chkmcv4&quot;</span><span class="p">);</span>
	<span class="n">in4_dev</span> <span class="o">=</span> <span class="n">in_dev_get</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in4_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">qeth_l3_add_mc</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">in4_dev</span><span class="p">);</span>
	<span class="n">qeth_l3_add_vlan_mc</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">in_dev_put</span><span class="p">(</span><span class="n">in4_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QETH_IPV6</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_add_mc6</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">in6_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">ipm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifmcaddr6</span> <span class="o">*</span><span class="n">im6</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;addmc6&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">im6</span> <span class="o">=</span> <span class="n">in6_dev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">;</span> <span class="n">im6</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">im6</span> <span class="o">=</span> <span class="n">im6</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndisc_mc_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">im6</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">in6_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ipm</span> <span class="o">=</span> <span class="n">qeth_l3_get_addr_buffer</span><span class="p">(</span><span class="n">QETH_PROT_IPV6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipm</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ipm</span><span class="o">-&gt;</span><span class="n">is_multicast</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">OSA_ADDR_LEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">im6</span><span class="o">-&gt;</span><span class="n">mca_addr</span><span class="p">.</span><span class="n">s6_addr</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_add_ip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipm</span><span class="p">))</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ipm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_add_vlan_mc6</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;admc6vl&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_FULL_VLAN</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">,</span> <span class="n">VLAN_N_VID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

		<span class="n">netdev</span> <span class="o">=</span> <span class="n">__vlan_find_dev_deep</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">in_dev</span> <span class="o">=</span> <span class="n">in6_dev_get</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">qeth_l3_add_mc6</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">in_dev</span><span class="p">);</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">in6_dev_put</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_add_multicast_ipv6</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">in6_dev</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;chkmcv6&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_IPV6</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="n">in6_dev</span> <span class="o">=</span> <span class="n">in6_dev_get</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in6_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in6_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">qeth_l3_add_mc6</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">in6_dev</span><span class="p">);</span>
	<span class="n">qeth_l3_add_vlan_mc6</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in6_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">in6_dev_put</span><span class="p">(</span><span class="n">in6_dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_QETH_IPV6 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_free_vlan_addresses4</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;frvaddr4&quot;</span><span class="p">);</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">__vlan_find_dev_deep</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="n">in_dev</span> <span class="o">=</span> <span class="n">in_dev_get</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span> <span class="n">ifa</span><span class="p">;</span> <span class="n">ifa</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">qeth_l3_get_addr_buffer</span><span class="p">(</span><span class="n">QETH_PROT_IPV4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">;</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span><span class="p">;</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">QETH_IP_TYPE_NORMAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_delete_ip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">in_dev_put</span><span class="p">(</span><span class="n">in_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_free_vlan_addresses6</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_QETH_IPV6</span>
	<span class="k">struct</span> <span class="n">inet6_dev</span> <span class="o">*</span><span class="n">in6_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet6_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;frvaddr6&quot;</span><span class="p">);</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">__vlan_find_dev_deep</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="n">in6_dev</span> <span class="o">=</span> <span class="n">in6_dev_get</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in6_dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ifa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in6_dev</span><span class="o">-&gt;</span><span class="n">addr_list</span><span class="p">,</span> <span class="n">if_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">qeth_l3_get_addr_buffer</span><span class="p">(</span><span class="n">QETH_PROT_IPV6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">));</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">pfxlen</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">prefix_len</span><span class="p">;</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">QETH_IP_TYPE_NORMAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_delete_ip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">in6_dev_put</span><span class="p">(</span><span class="n">in6_dev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_QETH_IPV6 */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_free_vlan_addresses</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qeth_l3_free_vlan_addresses4</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="n">qeth_l3_free_vlan_addresses6</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_vlan_rx_add_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_vlan_rx_kill_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;kid:%d&quot;</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_wait_for_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_RECOVER_THREAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;kidREC&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vlanlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* unregister IP addresses of vlan device */</span>
	<span class="n">qeth_l3_free_vlan_addresses</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vlanlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qeth_l3_set_multicast_list</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qeth_l3_rebuild_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">vlan_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be16</span> <span class="n">prot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip_hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tg_addr</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">is_vlan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QETH_HDR_PASSTHRU</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prot</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QETH_HDR_IPV6</span><span class="p">)</span><span class="o">?</span> <span class="n">ETH_P_IPV6</span> <span class="o">:</span>
			      <span class="n">ETH_P_IP</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QETH_HDR_CAST_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QETH_CAST_MULTICAST</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">prot</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_QETH_IPV6</span>
			<span class="k">case</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">)</span>:
				<span class="n">ndisc_mc_map</span><span class="p">((</span><span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="p">)</span>
				     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span>
				     <span class="n">tg_addr</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">case</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">)</span>:
				<span class="n">ip_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
				<span class="n">ip_eth_mc_map</span><span class="p">(</span><span class="n">ip_hdr</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">tg_addr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">tg_addr</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_MULTICAST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CAST_BROADCAST</span>:
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tg_addr</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_BROADCAST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CAST_UNICAST</span>:
		<span class="k">case</span> <span class="n">QETH_CAST_ANYCAST</span>:
		<span class="k">case</span> <span class="n">QETH_CAST_NOCAST</span>:
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">sniffer</span><span class="p">)</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tg_addr</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">QETH_HDR_EXT_SRC_MAC_ADDR</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span>
				<span class="n">tg_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span>
				<span class="n">tg_addr</span><span class="p">,</span> <span class="s">&quot;FAKELL&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">ext_flags</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">QETH_HDR_EXT_VLAN_FRAME</span> <span class="o">|</span> <span class="n">QETH_HDR_EXT_INCLUDE_VLAN_TAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">QETH_HDR_EXT_VLAN_FRAME</span><span class="p">)</span> <span class="o">?</span>
		 <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">vlan_id</span> <span class="o">:</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
		<span class="n">is_vlan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">ext_flags</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">QETH_HDR_EXT_CSUM_HDR_REQ</span> <span class="o">|</span>
		     <span class="n">QETH_HDR_EXT_CSUM_TRANSP_REQ</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">QETH_HDR_EXT_CSUM_HDR_REQ</span> <span class="o">|</span>
		     <span class="n">QETH_HDR_EXT_CSUM_TRANSP_REQ</span><span class="p">))</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">is_vlan</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_process_inbound_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">budget</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">vlan_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_vlan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">magic</span><span class="p">;</span>

	<span class="o">*</span><span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">budget</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">qeth_core_get_next_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_index</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_element</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">e_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QETH_HEADER_TYPE_LAYER3</span>:
			<span class="n">magic</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">magic</span> <span class="o">==</span> <span class="n">ETH_P_AF_IUCV</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ETH_P_AF_IUCV</span><span class="p">;</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mac_header</span> <span class="o">=</span> <span class="n">NET_SKB_PAD</span><span class="p">;</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="s">&quot;FAKELL&quot;</span><span class="p">,</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
				<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">is_vlan</span> <span class="o">=</span> <span class="n">qeth_l3_rebuild_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">vlan_tag</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_vlan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">sniffer</span><span class="p">)</span>
					<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">);</span>
				<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_HEADER_TYPE_LAYER2</span>: <span class="cm">/* for HiperSockets sniffer */</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;inbunkno&quot;</span><span class="p">);</span>
			<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">CTRL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">QETH_DBF_CTRL_LEN</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">work_done</span><span class="o">++</span><span class="p">;</span>
		<span class="n">budget</span><span class="o">--</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_card</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_budget</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">inbound_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">inbound_start_time</span> <span class="o">=</span> <span class="n">qeth_get_micros</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">qdio_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_count</span> <span class="o">=</span> <span class="n">qdio_get_next_buffers</span><span class="p">(</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_index</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">qdio_err</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_element</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_index</span><span class="p">]</span>
				<span class="p">.</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">e_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_index</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">qdio_err</span> <span class="o">&amp;&amp;</span>
			    <span class="n">qeth_check_qdio_errors</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">qdio_err</span><span class="p">,</span> <span class="s">&quot;qinerr&quot;</span><span class="p">)))</span>
				<span class="n">work_done</span> <span class="o">+=</span> <span class="n">qeth_l3_process_inbound_buffer</span><span class="p">(</span>
					<span class="n">card</span><span class="p">,</span> <span class="n">new_budget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">bufs_rec</span><span class="o">++</span><span class="p">;</span>
				<span class="n">qeth_put_buffer_pool_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
					<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">pool_entry</span><span class="p">);</span>
				<span class="n">qeth_queue_input_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_index</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_count</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_count</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_index</span> <span class="o">=</span>
						<span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
						<span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_element</span> <span class="o">=</span>
						<span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span>
						<span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">b_index</span><span class="p">]</span>
						<span class="p">.</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">e_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&gt;=</span> <span class="n">budget</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">new_budget</span> <span class="o">=</span> <span class="n">budget</span> <span class="o">-</span> <span class="n">work_done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdio_start_irq</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">inbound_time</span> <span class="o">+=</span> <span class="n">qeth_get_micros</span><span class="p">()</span> <span class="o">-</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">inbound_start_time</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_verify_vlan_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">;</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">,</span> <span class="n">VLAN_N_VID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">netdev</span> <span class="o">=</span> <span class="n">__vlan_find_dev_deep</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">QETH_VLAN_CARD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">vlan_dev_real_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_verify_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">read_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_core_card_list</span><span class="p">.</span><span class="n">rwlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qeth_core_card_list</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">QETH_REAL_CARD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_verify_vlan_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_core_card_list</span><span class="p">.</span><span class="n">rwlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="nf">qeth_l3_get_card_from_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_verify_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">QETH_REAL_CARD</span><span class="p">)</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">QETH_VLAN_CARD</span><span class="p">)</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">vlan_dev_real_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">layer2</span><span class="p">)</span>
		<span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">card</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_stop_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">recovery_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;stopcard&quot;</span><span class="p">);</span>
	<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

	<span class="n">qeth_set_allowed_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">sniffer</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">promisc_mode</span> <span class="o">==</span> <span class="n">SET_PROMISC_MODE_ON</span><span class="p">))</span>
		<span class="n">qeth_diags_trace</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_DIAGS_CMD_TRACE_DISABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CH_STATE_UP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CH_STATE_UP</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_STATE_UP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">recovery_mode</span><span class="p">)</span>
			<span class="n">qeth_l3_stop</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rtnl_lock</span><span class="p">();</span>
			<span class="n">dev_close</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_SOFTSETUP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_STATE_SOFTSETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qeth_l3_clear_ip_list</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">qeth_clear_ipacmd_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_HARDSETUP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_STATE_HARDSETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qeth_qdio_clear_card</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">qeth_clear_qdio_buffers</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">qeth_clear_working_pool_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_DOWN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_STATE_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qeth_clear_cmd_buffers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
		<span class="n">qeth_clear_cmd_buffers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * test for and Switch promiscuous mode (on or off)</span>
<span class="cm"> *  either for guestlan or HiperSocket Sniffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qeth_l3_handle_promisc_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">promisc_mode</span> <span class="o">==</span> <span class="n">SET_PROMISC_MODE_ON</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">promisc_mode</span> <span class="o">==</span> <span class="n">SET_PROMISC_MODE_OFF</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Guestlan trace */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qeth_adp_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_SET_PROMISC_MODE</span><span class="p">))</span>
			<span class="n">qeth_setadp_promisc_mode</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">sniffer</span> <span class="o">&amp;&amp;</span>	<span class="cm">/* HiperSockets trace */</span>
		   <span class="n">qeth_adp_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_SET_DIAG_ASSIST</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;+promisc&quot;</span><span class="p">);</span>
			<span class="n">qeth_diags_trace</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_DIAGS_CMD_TRACE_ENABLE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;-promisc&quot;</span><span class="p">);</span>
			<span class="n">qeth_diags_trace</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_DIAGS_CMD_TRACE_DISABLE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;setmulti&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_threads_running</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_RECOVER_THREAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_STATE_UP</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">sniffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qeth_l3_delete_mc_addresses</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">qeth_l3_add_multicast_ipv4</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_QETH_IPV6</span>
		<span class="n">qeth_l3_add_multicast_ipv6</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">qeth_l3_set_ip_addr_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_adp_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_SET_PROMISC_MODE</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qeth_l3_handle_promisc_mode</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">qeth_l3_arp_get_error_cause</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_IPA_ARP_RC_FAILED</span>:
		<span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="s">&quot;operation failed&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_IPA_ARP_RC_NOTSUPP</span>:
		<span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">return</span> <span class="s">&quot;operation not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_IPA_ARP_RC_OUT_OF_RANGE</span>:
		<span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="s">&quot;argument out of range&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_IPA_ARP_RC_Q_NOTSUPP</span>:
		<span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">return</span> <span class="s">&quot;query operation not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_IPA_ARP_RC_Q_NO_DATA</span>:
		<span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">return</span> <span class="s">&quot;no query data available&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="s">&quot;unknown error&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_arp_set_no_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no_entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;arpstnoe&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * currently GuestLAN only supports the ARP assist function</span>
<span class="cm">	 * IPA_CMD_ASS_ARP_QUERY_INFO, but not IPA_CMD_ASS_ARP_SET_NO_ENTRIES;</span>
<span class="cm">	 * thus we say EOPNOTSUPP for this ARP function</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_ARP_PROCESSING</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_ARP_PROCESSING</span><span class="p">,</span>
					  <span class="n">IPA_CMD_ASS_ARP_SET_NO_ENTRIES</span><span class="p">,</span>
					  <span class="n">no_entries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Could not set number of ARP entries on &quot;</span>
			<span class="s">&quot;%s: %s (0x%x/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
			<span class="n">qeth_l3_arp_get_error_cause</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__u32</span> <span class="nf">get_arp_entry_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qeth_arp_query_data</span> <span class="o">*</span><span class="n">qdata</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qeth_arp_entrytype</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">strip_entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">is_hsi</span><span class="p">;</span>

	<span class="n">is_hsi</span> <span class="o">=</span> <span class="n">qdata</span><span class="o">-&gt;</span><span class="n">reply_bits</span> <span class="o">==</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">==</span> <span class="n">QETHARP_IP_ADDR_V4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;arpev4&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strip_entries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">is_hsi</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_qi_entry5_short</span><span class="p">)</span> <span class="o">:</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_qi_entry7_short</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">is_hsi</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_qi_entry5</span><span class="p">)</span> <span class="o">:</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_qi_entry7</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">==</span> <span class="n">QETHARP_IP_ADDR_V6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;arpev6&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strip_entries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">is_hsi</span> <span class="o">?</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_qi_entry5_short_ipv6</span><span class="p">)</span> <span class="o">:</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_qi_entry7_short_ipv6</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">is_hsi</span> <span class="o">?</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_qi_entry5_ipv6</span><span class="p">)</span> <span class="o">:</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_qi_entry7_ipv6</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;arpinv&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arpentry_matches_prot</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_entrytype</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">==</span> <span class="n">QETHARP_IP_ADDR_V4</span> <span class="o">&amp;&amp;</span> <span class="n">prot</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">==</span> <span class="n">QETHARP_IP_ADDR_V6</span> <span class="o">&amp;&amp;</span> <span class="n">prot</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV6</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_arp_query_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_arp_query_data</span> <span class="o">*</span><span class="n">qdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_arp_query_info</span> <span class="o">*</span><span class="n">qinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entrybytes_done</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stripped_bytes</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">do_strip_entries</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;arpquecb&quot;</span><span class="p">);</span>

	<span class="n">qinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_query_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">prot_version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;arpcberr&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">;</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setaperr&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">query_arp</span><span class="p">;</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;anoen%i&quot;</span><span class="p">,</span> <span class="n">qdata</span><span class="o">-&gt;</span><span class="n">no_entries</span><span class="p">);</span>

	<span class="n">do_strip_entries</span> <span class="o">=</span> <span class="p">(</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">mask_bits</span> <span class="o">&amp;</span> <span class="n">QETH_QARP_STRIP_ENTRIES</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stripped_bytes</span> <span class="o">=</span> <span class="n">do_strip_entries</span> <span class="o">?</span> <span class="n">QETH_QARP_MEDIASPECIFIC_BYTES</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">entrybytes_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">qdata</span><span class="o">-&gt;</span><span class="n">no_entries</span><span class="p">;</span> <span class="o">++</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">cur_entry</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">esize</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">qeth_arp_entrytype</span> <span class="o">*</span><span class="n">etype</span><span class="p">;</span>

		<span class="n">cur_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdata</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">entrybytes_done</span><span class="p">;</span>
		<span class="n">etype</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">qeth_arp_qi_entry5</span> <span class="o">*</span><span class="p">)</span> <span class="n">cur_entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arpentry_matches_prot</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">prot_version</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;pmis&quot;</span><span class="p">);</span>
			<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="n">etype</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">esize</span> <span class="o">=</span> <span class="n">get_arp_entry_size</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">qdata</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span>
			<span class="n">do_strip_entries</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;esz%i&quot;</span><span class="p">,</span> <span class="n">esize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">esize</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata_len</span> <span class="o">-</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata_offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">esize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;qaer3%i&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span> <span class="o">=</span> <span class="n">IPA_RC_ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata</span> <span class="o">+</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata_offset</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">qdata</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">entrybytes_done</span> <span class="o">+</span> <span class="n">stripped_bytes</span><span class="p">,</span>
			<span class="n">esize</span><span class="p">);</span>
		<span class="n">entrybytes_done</span> <span class="o">+=</span> <span class="n">esize</span> <span class="o">+</span> <span class="n">stripped_bytes</span><span class="p">;</span>
		<span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata_offset</span> <span class="o">+=</span> <span class="n">esize</span><span class="p">;</span>
		<span class="o">++</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">no_entries</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* check if all replies received ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq_no</span> <span class="o">&lt;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">number_of_replies</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;nove%i&quot;</span><span class="p">,</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">no_entries</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">no_entries</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* keep STRIP_ENTRIES flag so the user program can distinguish</span>
<span class="cm">	 * stripped entries from normal ones */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">mask_bits</span> <span class="o">&amp;</span> <span class="n">QETH_QARP_STRIP_ENTRIES</span><span class="p">)</span>
		<span class="n">qdata</span><span class="o">-&gt;</span><span class="n">reply_bits</span> <span class="o">|=</span> <span class="n">QETH_QARP_STRIP_ENTRIES</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata</span> <span class="o">+</span> <span class="n">QETH_QARP_MASK_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdata</span><span class="o">-&gt;</span><span class="n">reply_bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;rc%i&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_error:</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_send_ipa_arp_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">reply_cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">reply_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;sendarp&quot;</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">IPA_PDU_HEADER</span><span class="p">,</span> <span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IPA_CMD_DEST_ADDR</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">ulp_connection_r</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">qeth_send_control_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_PDU_HEADER_SIZE</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span>
				      <span class="n">reply_cb</span><span class="p">,</span> <span class="n">reply_param</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_query_arp_cache_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">prot</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qeth_arp_query_info</span> <span class="o">*</span><span class="n">qinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qarpipv%i&quot;</span><span class="p">,</span> <span class="n">prot</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_l3_get_setassparms_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_ARP_PROCESSING</span><span class="p">,</span>
			<span class="n">IPA_CMD_ASS_ARP_QUERY_INFO</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_query_data</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span>
			<span class="n">prot</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">query_arp</span><span class="p">.</span><span class="n">request_bits</span> <span class="o">=</span> <span class="mh">0x000F</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">query_arp</span><span class="p">.</span><span class="n">reply_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setassparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">query_arp</span><span class="p">.</span><span class="n">no_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_ipa_arp_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span>
			   <span class="n">QETH_SETASS_BASE_LEN</span><span class="o">+</span><span class="n">QETH_ARP_CMD_LEN</span><span class="p">,</span>
			   <span class="n">qeth_l3_arp_query_cb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">qinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
			<span class="s">&quot;Error while querying ARP cache on %s: %s &quot;</span>
			<span class="s">&quot;(0x%x/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
			<span class="n">qeth_l3_arp_get_error_cause</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_arp_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_arp_query_info</span> <span class="n">qinfo</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;arpquery&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span><span class="cm">/*IPA_QUERY_ARP_ADDR_INFO*/</span>
			       <span class="n">IPA_ARP_PROCESSING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;arpqnsup&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* get size of userspace buffer and mask_bits -&gt; 6 bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qinfo</span><span class="p">,</span> <span class="n">udata</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qinfo</span><span class="p">.</span><span class="n">udata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">qinfo</span><span class="p">.</span><span class="n">udata_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qinfo</span><span class="p">.</span><span class="n">udata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qinfo</span><span class="p">.</span><span class="n">udata_offset</span> <span class="o">=</span> <span class="n">QETH_QARP_ENTRIES_OFFSET</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_query_arp_cache_info</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_PROT_IPV4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="n">qinfo</span><span class="p">.</span><span class="n">udata</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_and_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_QETH_IPV6</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qinfo</span><span class="p">.</span><span class="n">mask_bits</span> <span class="o">&amp;</span> <span class="n">QETH_QARP_WITH_IPV6</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* fails in case of GuestLAN QDIO mode */</span>
			<span class="n">qeth_l3_query_arp_cache_info</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_PROT_IPV6</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">qinfo</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="n">qinfo</span><span class="p">.</span><span class="n">udata</span><span class="p">,</span> <span class="n">qinfo</span><span class="p">.</span><span class="n">udata_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;qactf&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_and_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;qacts&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">free_and_out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">qinfo</span><span class="p">.</span><span class="n">udata</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_arp_add_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qeth_arp_cache_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;arpadent&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * currently GuestLAN only supports the ARP assist function</span>
<span class="cm">	 * IPA_CMD_ASS_ARP_QUERY_INFO, but not IPA_CMD_ASS_ARP_ADD_ENTRY;</span>
<span class="cm">	 * thus we say EOPNOTSUPP for this ARP function</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_ARP_PROCESSING</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_l3_get_setassparms_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_ARP_PROCESSING</span><span class="p">,</span>
				       <span class="n">IPA_CMD_ASS_ARP_ADD_ENTRY</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_cache_entry</span><span class="p">),</span>
				       <span class="n">QETH_PROT_IPV4</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_cache_entry</span><span class="p">),</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span>
				   <span class="n">qeth_l3_default_setassparms_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">qeth_l3_ipaddr4_to_string</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Could not add ARP entry for address %s &quot;</span>
			<span class="s">&quot;on %s: %s (0x%x/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
			<span class="n">qeth_l3_arp_get_error_cause</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_arp_remove_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qeth_arp_cache_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;arprment&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * currently GuestLAN only supports the ARP assist function</span>
<span class="cm">	 * IPA_CMD_ASS_ARP_QUERY_INFO, but not IPA_CMD_ASS_ARP_REMOVE_ENTRY;</span>
<span class="cm">	 * thus we say EOPNOTSUPP for this ARP function</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_ARP_PROCESSING</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_l3_get_setassparms_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_ARP_PROCESSING</span><span class="p">,</span>
				       <span class="n">IPA_CMD_ASS_ARP_REMOVE_ENTRY</span><span class="p">,</span>
				       <span class="mi">12</span><span class="p">,</span>
				       <span class="n">QETH_PROT_IPV4</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span>
				   <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span>
				   <span class="n">qeth_l3_default_setassparms_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">qeth_l3_ipaddr4_to_string</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Could not delete ARP entry for address %s&quot;</span>
			<span class="s">&quot; on %s: %s (0x%x/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
			<span class="n">qeth_l3_arp_get_error_cause</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_arp_flush_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;arpflush&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * currently GuestLAN only supports the ARP assist function</span>
<span class="cm">	 * IPA_CMD_ASS_ARP_QUERY_INFO, but not IPA_CMD_ASS_ARP_FLUSH_CACHE;</span>
<span class="cm">	 * thus we say EOPNOTSUPP for this ARP function</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_ARP_PROCESSING</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_send_simple_setassparms</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_ARP_PROCESSING</span><span class="p">,</span>
					  <span class="n">IPA_CMD_ASS_ARP_FLUSH_CACHE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Could not flush ARP cache on %s: %s &quot;</span>
			<span class="s">&quot;(0x%x/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
			<span class="n">qeth_l3_arp_get_error_cause</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_do_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_arp_cache_entry</span> <span class="n">arp_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">mii_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_STATE_UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_STATE_SOFTSETUP</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOC_QETH_ARP_SET_NO_ENTRIES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_arp_set_no_entries</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_ifru</span><span class="p">.</span><span class="n">ifru_ivalue</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOC_QETH_ARP_QUERY_INFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_arp_query</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_ifru</span><span class="p">.</span><span class="n">ifru_data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOC_QETH_ARP_ADD_ENTRY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arp_entry</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_ifru</span><span class="p">.</span><span class="n">ifru_data</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_cache_entry</span><span class="p">)))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_arp_add_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arp_entry</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOC_QETH_ARP_REMOVE_ENTRY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arp_entry</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_ifru</span><span class="p">.</span><span class="n">ifru_data</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_cache_entry</span><span class="p">)))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_arp_remove_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arp_entry</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOC_QETH_ARP_FLUSH_CACHE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_arp_flush_cache</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOC_QETH_ADP_SET_SNMP_CONTROL</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_snmp_command</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_ifru</span><span class="p">.</span><span class="n">ifru_data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOC_QETH_GET_CARD_TYPE</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSD</span> <span class="o">||</span>
		     <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:
		<span class="n">mii_data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
		<span class="n">mii_data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>:
		<span class="n">mii_data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mii_data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mii_data</span><span class="o">-&gt;</span><span class="n">val_out</span> <span class="o">=</span> <span class="n">qeth_mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">mii_data</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span>
							<span class="n">mii_data</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOC_QETH_QUERY_OAT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_query_oat_command</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_ifru</span><span class="p">.</span><span class="n">ifru_data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ioce%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="kr">inline</span> <span class="nf">qeth_l3_get_cast_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cast_type</span> <span class="o">=</span> <span class="n">RTN_UNSPEC</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">dst_get_neighbour_noref</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cast_type</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cast_type</span> <span class="o">==</span> <span class="n">RTN_BROADCAST</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cast_type</span> <span class="o">==</span> <span class="n">RTN_MULTICAST</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cast_type</span> <span class="o">==</span> <span class="n">RTN_ANYCAST</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">cast_type</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">RTN_UNSPEC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="cm">/* try something else */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_IPV6</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)[</span><span class="mi">24</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">RTN_MULTICAST</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_IP</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">RTN_MULTICAST</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RTN_BROADCAST</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">hdr_mac</span><span class="p">;</span>

		<span class="n">hdr_mac</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="cm">/* tr multicast? */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QETH_LINK_TYPE_HSTR</span>:
		<span class="k">case</span> <span class="n">QETH_LINK_TYPE_LANE_TR</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">hdr_mac</span> <span class="o">==</span> <span class="n">QETH_TR_MAC_NC</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">hdr_mac</span> <span class="o">==</span> <span class="n">QETH_TR_MAC_C</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">RTN_MULTICAST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* eth or so multicast? */</span>
		<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdr_mac</span> <span class="o">==</span> <span class="n">QETH_ETH_MAC_V4</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">hdr_mac</span> <span class="o">==</span> <span class="n">QETH_ETH_MAC_V6</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">RTN_MULTICAST</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cast_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_fill_af_iucv_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">daddr</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">af_iucv_trans_hdr</span> <span class="o">*</span><span class="n">iucv_hdr</span><span class="p">;</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
				      <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">iucv_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">af_iucv_trans_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">QETH_HEADER_TYPE_LAYER3</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">ext_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">QETH_HDR_IPV6</span> <span class="o">|</span> <span class="n">QETH_CAST_UNICAST</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">daddr</span><span class="p">));</span>
	<span class="n">daddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="n">daddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">daddr</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">iucv_hdr</span><span class="o">-&gt;</span><span class="n">destUserID</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">dest_addr</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_fill_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ipv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cast_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">QETH_HEADER_TYPE_LAYER3</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">ext_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * before we&#39;re going to overwrite this location with next hop ip.</span>
<span class="cm">	 * v6 uses passthrough, v4 sets the tag in the QDIO header.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ipv</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">))</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">ext_flags</span> <span class="o">=</span> <span class="n">QETH_HDR_EXT_VLAN_FRAME</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">ext_flags</span> <span class="o">=</span> <span class="n">QETH_HDR_EXT_INCLUDE_VLAN_TAG</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipv</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>
		<span class="n">__be32</span> <span class="o">*</span><span class="n">pkey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">)</span>
			<span class="n">pkey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_gateway</span><span class="p">;</span>

		<span class="cm">/* IPv4 */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">qeth_l3_get_qeth_hdr_flags4</span><span class="p">(</span><span class="n">cast_type</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">dest_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
		<span class="o">*</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">12</span><span class="p">]))</span> <span class="o">=</span> <span class="o">*</span><span class="n">pkey</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipv</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt6_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">pkey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv6_addr_any</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_gateway</span><span class="p">))</span>
			<span class="n">pkey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt6i_gateway</span><span class="p">;</span>

		<span class="cm">/* IPv6 */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">qeth_l3_get_qeth_hdr_flags6</span><span class="p">(</span><span class="n">cast_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QETH_HDR_PASSTHRU</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">dest_addr</span><span class="p">,</span> <span class="n">pkey</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span><span class="p">),</span>
			    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* broadcast? */</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">QETH_CAST_BROADCAST</span> <span class="o">|</span>
						<span class="n">QETH_HDR_PASSTHRU</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">cast_type</span> <span class="o">==</span> <span class="n">RTN_MULTICAST</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">QETH_CAST_MULTICAST</span> <span class="o">|</span> <span class="n">QETH_HDR_PASSTHRU</span> <span class="o">:</span>
				<span class="n">QETH_CAST_UNICAST</span> <span class="o">|</span> <span class="n">QETH_HDR_PASSTHRU</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qeth_l3_hdr_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* tcph-&gt;check contains already the pseudo hdr checksum</span>
<span class="cm">	 * so just set the header flags</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">ext_flags</span> <span class="o">|=</span> <span class="n">QETH_HDR_EXT_UDP</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">ext_flags</span> <span class="o">|=</span> <span class="n">QETH_HDR_EXT_CSUM_TRANSP_REQ</span> <span class="o">|</span>
		<span class="n">QETH_HDR_EXT_CSUM_HDR_REQ</span><span class="p">;</span>
	<span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">tx_csum</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_tso_fill_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">*</span><span class="n">qhdr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_hdr_tso</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr_tso</span> <span class="o">*</span><span class="p">)</span><span class="n">qhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipv6hdr</span> <span class="o">*</span><span class="n">ip6h</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/*fix header to TSO values ...*/</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">QETH_HEADER_TYPE_TSO</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr_tso</span><span class="p">);</span>
	<span class="cm">/*set values which are fix for the first approach ...*/</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">hdr_tot_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr_ext_tso</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">imb_hdr_no</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">hdr_type</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">hdr_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">hdr_len</span>     <span class="o">=</span> <span class="mi">28</span><span class="p">;</span>
	<span class="cm">/*insert non-fix values */</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">mss</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">dg_hdr_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">tcph</span><span class="o">-&gt;</span><span class="n">doff</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">payload_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">dg_hdr_len</span> <span class="o">-</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr_tso</span><span class="p">));</span>
	<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_IPV6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ip6h</span><span class="o">-&gt;</span><span class="n">payload_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="o">~</span><span class="n">csum_ipv6_magic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip6h</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip6h</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
					       <span class="mi">0</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*OSA want us to set these values ...*/</span>
		<span class="n">tcph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="o">~</span><span class="n">csum_tcpudp_magic</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qeth_l3_tso_elements</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tcpd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tcpd_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">tcpd</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">PFN_UP</span><span class="p">(</span><span class="n">tcpd</span> <span class="o">+</span> <span class="n">tcpd_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">tcpd</span><span class="p">);</span>
	<span class="n">elements</span> <span class="o">+=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">elements</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">elements_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">elems</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ipv</span> <span class="o">=</span> <span class="n">qeth_get_ip_version</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cast_type</span> <span class="o">=</span> <span class="n">qeth_l3_get_cast_type</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span>
		<span class="p">[</span><span class="n">qeth_get_priority_queue</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ipv</span><span class="p">,</span> <span class="n">cast_type</span><span class="p">)];</span>
	<span class="kt">int</span> <span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">large_send</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_frags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">!=</span> <span class="n">QETH_CQ_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ipv</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">==</span> <span class="n">QETH_CQ_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ETH_P_AF_IUCV</span><span class="p">))))</span> <span class="o">||</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">sniffer</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">tx_drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_STATE_UP</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">tx_drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cast_type</span> <span class="o">==</span> <span class="n">RTN_BROADCAST</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">broadcast_capable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">tx_drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_start_time</span> <span class="o">=</span> <span class="n">qeth_get_micros</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">large_send</span> <span class="o">=</span> <span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">large_send</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">new_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_AF_IUCV</span><span class="p">)</span>
			<span class="n">data_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data_offset</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">qeth_core_header_cache</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">tx_drop</span><span class="p">;</span>
		<span class="n">elements_needed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* create a clone with writeable headroom */</span>
		<span class="n">new_skb</span> <span class="o">=</span> <span class="n">skb_realloc_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr_tso</span><span class="p">)</span>
					<span class="o">+</span> <span class="n">VLAN_HLEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">tx_drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipv</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipv</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">new_skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb_push</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">VLAN_HLEN</span><span class="p">);</span>
			<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">skb_copy_to_linear_data_offset</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				<span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">skb_copy_to_linear_data_offset</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
				<span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
			<span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">new_skb</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* fix hardware limitation: as long as we do not have sbal</span>
<span class="cm">	 * chaining we can not send long frag lists</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">large_send</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qeth_l3_tso_elements</span><span class="p">(</span><span class="n">new_skb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb_linearize</span><span class="p">(</span><span class="n">new_skb</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">tx_drop</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">tx_lin</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">large_send</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cast_type</span> <span class="o">==</span> <span class="n">RTN_UNSPEC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr_tso</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr_tso</span><span class="p">));</span>
		<span class="n">qeth_l3_fill_header</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">new_skb</span><span class="p">,</span> <span class="n">ipv</span><span class="p">,</span> <span class="n">cast_type</span><span class="p">);</span>
		<span class="n">qeth_tso_fill_header</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">new_skb</span><span class="p">);</span>
		<span class="n">elements_needed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span><span class="p">));</span>
			<span class="n">qeth_l3_fill_header</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">new_skb</span><span class="p">,</span> <span class="n">ipv</span><span class="p">,</span>
						<span class="n">cast_type</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_AF_IUCV</span><span class="p">)</span>
				<span class="n">qeth_l3_fill_af_iucv_hdr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">new_skb</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">qeth_l3_fill_header</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">new_skb</span><span class="p">,</span> <span class="n">ipv</span><span class="p">,</span>
							<span class="n">cast_type</span><span class="p">);</span>
				<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">data_offset</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
			<span class="n">qeth_l3_hdr_csum</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">new_skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">elems</span> <span class="o">=</span> <span class="n">qeth_get_elements_no</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">,</span> <span class="n">new_skb</span><span class="p">,</span>
						 <span class="n">elements_needed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">elems</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">qeth_core_header_cache</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">tx_drop</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">elements_needed</span> <span class="o">+=</span> <span class="n">elems</span><span class="p">;</span>
	<span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">new_skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">large_send</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tcp_hdr</span><span class="p">(</span><span class="n">new_skb</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">new_skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr_layer3</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qeth_hdr_chk_and_bounce</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">tx_drop</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_do_send_packet</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">new_skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span>
					 <span class="n">elements_needed</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_do_send_packet_fast</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">new_skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span>
					<span class="n">elements_needed</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">tx_bytes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_skb</span> <span class="o">!=</span> <span class="n">skb</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">large_send</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">large_send_bytes</span> <span class="o">+=</span> <span class="n">tx_bytes</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">large_send_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nr_frags</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sg_skbs_sent</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* nr_frags + skb-&gt;data */</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sg_frags_sent</span> <span class="o">+=</span> <span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">qeth_core_header_cache</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_skb</span> <span class="o">!=</span> <span class="n">skb</span><span class="p">)</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">new_skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">tx_drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_time</span> <span class="o">+=</span> <span class="n">qeth_get_micros</span><span class="p">()</span> <span class="o">-</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_start_time</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">tx_drop:</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_skb</span> <span class="o">!=</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">new_skb</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">new_skb</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qeth_l3_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;qethopen&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_STATE_UP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_STATE_SOFTSETUP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_UP</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_UP</span><span class="p">;</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdio_stop_irq</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qethope_&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_wait_for_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_RECOVER_THREAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;openREC&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">__qeth_l3_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;qethstop&quot;</span><span class="p">);</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_STATE_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_SOFTSETUP</span><span class="p">;</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span> <span class="nf">qeth_l3_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_OUTBOUND_CHECKSUM</span><span class="p">))</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_IP_CSUM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_OUTBOUND_TSO</span><span class="p">))</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_TSO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_INBOUND_CHECKSUM</span><span class="p">))</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_STATE_DOWN</span> <span class="o">||</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_STATE_RECOVER</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qeth_l3_set_rx_csum</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span> <span class="o">^</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">qeth_l3_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span> <span class="o">=</span> <span class="n">qeth_core_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span> <span class="o">=</span> <span class="n">qeth_core_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span> <span class="o">=</span> <span class="n">qeth_core_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">qeth_core_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">qeth_core_ethtool_get_settings</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * we need NOARP for IPv4 but we want neighbor solicitation for IPv6. Setting</span>
<span class="cm"> * NOARP on the netdevice is no option because it also turns off neighbor</span>
<span class="cm"> * solicitation. For IPv4 we install a neighbor_setup function. We don&#39;t want</span>
<span class="cm"> * arp resolution but we want the hard header (packet socket will work</span>
<span class="cm"> * e.g. tcpdump)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_neigh_setup_noarp</span><span class="p">(</span><span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">n</span><span class="o">-&gt;</span><span class="n">nud_state</span> <span class="o">=</span> <span class="n">NUD_NOARP</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">,</span> <span class="s">&quot;FAKELL&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">n</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">connected_output</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qeth_l3_neigh_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">neigh_parms</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">AF_INET</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">neigh_setup</span> <span class="o">=</span> <span class="n">qeth_l3_neigh_setup_noarp</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">qeth_l3_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">qeth_l3_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">qeth_l3_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">qeth_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">qeth_l3_hard_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">qeth_l3_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">qeth_l3_do_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">qeth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">qeth_l3_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">qeth_l3_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_add_vid</span>	<span class="o">=</span> <span class="n">qeth_l3_vlan_rx_add_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_kill_vid</span>   <span class="o">=</span> <span class="n">qeth_l3_vlan_rx_kill_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">qeth_tx_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">qeth_l3_osa_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">qeth_l3_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">qeth_l3_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">qeth_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">qeth_l3_hard_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">qeth_l3_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">qeth_l3_do_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">qeth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">qeth_l3_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">qeth_l3_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_add_vid</span>	<span class="o">=</span> <span class="n">qeth_l3_vlan_rx_add_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_kill_vid</span>   <span class="o">=</span> <span class="n">qeth_l3_vlan_rx_kill_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">qeth_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_neigh_setup</span>	<span class="o">=</span> <span class="n">qeth_l3_neigh_setup</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_setup_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSD</span> <span class="o">||</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span> <span class="o">==</span> <span class="n">QETH_LINK_TYPE_LANE_TR</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span> <span class="o">==</span> <span class="n">QETH_LINK_TYPE_HSTR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;qeth_l3: ignoring TR device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qeth_l3_osa_netdev_ops</span><span class="p">;</span>

			<span class="cm">/*IPv6 address autoconfiguration stuff*/</span>
			<span class="n">qeth_l3_get_unique_id</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">unique_id</span> <span class="o">&amp;</span> <span class="n">UNIQUE_ID_NOT_BY_CARD</span><span class="p">))</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">unique_id</span> <span class="o">&amp;</span>
							 <span class="mh">0xffff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span>
					<span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span>
					<span class="n">NETIF_F_TSO</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;hsi%d&quot;</span><span class="p">,</span> <span class="n">ether_setup</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_NOARP</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qeth_l3_netdev_ops</span><span class="p">;</span>
		<span class="n">qeth_l3_iqd_read_initial_mac</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">hsuid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">hsuid</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">QETH_TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">initial_mtu</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qeth_l3_ethtool_ops</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span>	<span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span>
				<span class="n">NETIF_F_HW_VLAN_RX</span> <span class="o">|</span>
				<span class="n">NETIF_F_HW_VLAN_FILTER</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFF_XMIT_DST_RELEASE</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gso_max_size</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">qeth_l3_poll</span><span class="p">,</span> <span class="n">QETH_NAPI_WEIGHT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_probe_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">qeth_l3_create_device_attributes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">layer2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">hwtrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">qeth_l3_remove_device_attributes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">qeth_set_allowed_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span> <span class="n">qeth_threads_running</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CCWGROUP_ONLINE</span><span class="p">)</span>
		<span class="n">qeth_l3_set_offline</span><span class="p">(</span><span class="n">cgdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qeth_l3_clear_ip_list</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qeth_l3_clear_ipato_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qeth_l3_set_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">recovery_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">qeth_card_states</span> <span class="n">recover_flag</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline_mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;setonlin&quot;</span><span class="p">);</span>
	<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

	<span class="n">recover_flag</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_core_hardsetup_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;2err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_remove</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">qeth_l3_setup_netdev</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_remove</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_is_diagass_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_DIAGS_CMD_TRAP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">hwtrap</span> <span class="o">&amp;&amp;</span>
		    <span class="n">qeth_hw_trap</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_DIAGS_TRAP_ARM</span><span class="p">))</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">hwtrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">hwtrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_HARDSETUP</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_rx</span><span class="p">));</span>
	<span class="n">qeth_print_status_message</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* softsetup */</span>
	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;softsetp&quot;</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_startlan</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;1err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mh">0xe080</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;The LAN is offline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">contin</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_remove</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">contin:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_setadapter_parms</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;2err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">sniffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_start_ipassists</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;3err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_setrouting_v4</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;4err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_setrouting_v6</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;5err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_init_qdio_queues</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;6err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_remove</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_SOFTSETUP</span><span class="p">;</span>

	<span class="n">qeth_set_allowed_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qeth_l3_set_ip_addr_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_online</span><span class="p">)</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recover_flag</span> <span class="o">==</span> <span class="n">CARD_STATE_RECOVER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">recovery_mode</span><span class="p">)</span>
			<span class="n">__qeth_l3_open</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_open</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">qeth_l3_set_multicast_list</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* let user_space know that device is online */</span>
	<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_remove:</span>
	<span class="n">qeth_l3_stop_card</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">CARD_WDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">CARD_RDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recover_flag</span> <span class="o">==</span> <span class="n">CARD_STATE_RECOVER</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_RECOVER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_DOWN</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_set_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__qeth_l3_set_online</span><span class="p">(</span><span class="n">gdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qeth_l3_set_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">recovery_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">qeth_card_states</span> <span class="n">recover_flag</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline_mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;setoffl&quot;</span><span class="p">);</span>
	<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">recover_flag</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">recovery_mode</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">hwtrap</span><span class="p">)</span> <span class="o">||</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">hwtrap</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qeth_hw_trap</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_DIAGS_TRAP_DISARM</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">hwtrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qeth_l3_stop_card</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">recovery_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">==</span> <span class="n">QETH_CQ_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">call_netdevice_notifiers</span><span class="p">(</span><span class="n">NETDEV_REBOOT</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">rc</span>  <span class="o">=</span> <span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="n">rc2</span> <span class="o">=</span> <span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">CARD_WDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="n">rc3</span> <span class="o">=</span> <span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">CARD_RDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rc2</span><span class="p">)</span> <span class="o">?</span> <span class="n">rc2</span> <span class="o">:</span> <span class="n">rc3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;1err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recover_flag</span> <span class="o">==</span> <span class="n">CARD_STATE_UP</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_RECOVER</span><span class="p">;</span>
	<span class="cm">/* let user_space know that device is offline */</span>
	<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_set_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__qeth_l3_set_offline</span><span class="p">(</span><span class="n">cgdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_recover</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;recover1&quot;</span><span class="p">);</span>
	<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_do_run_thread</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_RECOVER_THREAD</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;recover2&quot;</span><span class="p">);</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;A recovery process has been started for the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">__qeth_l3_set_offline</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__qeth_l3_set_online</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Device successfully recovered!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">dev_close</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The qeth device driver &quot;</span>
			<span class="s">&quot;failed to recover an error on the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qeth_clear_thread_start_bit</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_RECOVER_THREAD</span><span class="p">);</span>
	<span class="n">qeth_clear_thread_running_bit</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_RECOVER_THREAD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">qeth_set_allowed_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CCWGROUP_ONLINE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">hwtrap</span><span class="p">)</span>
		<span class="n">qeth_hw_trap</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_DIAGS_TRAP_DISARM</span><span class="p">);</span>
	<span class="n">qeth_qdio_clear_card</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qeth_clear_qdio_buffers</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_pm_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">qeth_set_allowed_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span> <span class="n">qeth_threads_running</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CCWGROUP_OFFLINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_STATE_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">hwtrap</span><span class="p">)</span>
			<span class="n">qeth_hw_trap</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_DIAGS_TRAP_DISARM</span><span class="p">);</span>
		<span class="n">__qeth_l3_set_offline</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">__qeth_l3_set_offline</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_pm_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CCWGROUP_OFFLINE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_STATE_RECOVER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">__qeth_l3_set_online</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtnl_lock</span><span class="p">();</span>
			<span class="n">dev_close</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">__qeth_l3_set_online</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">qeth_set_allowed_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The qeth device driver &quot;</span>
			<span class="s">&quot;failed to recover an error on the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">qeth_discipline</span> <span class="n">qeth_l3_discipline</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start_poll</span> <span class="o">=</span> <span class="n">qeth_qdio_start_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">input_handler</span> <span class="o">=</span> <span class="p">(</span><span class="n">qdio_handler_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">qeth_qdio_input_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_handler</span> <span class="o">=</span> <span class="p">(</span><span class="n">qdio_handler_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">qeth_qdio_output_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recover</span> <span class="o">=</span> <span class="n">qeth_l3_recover</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">qeth_l3_probe_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">qeth_l3_remove_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_online</span> <span class="o">=</span> <span class="n">qeth_l3_set_online</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_offline</span> <span class="o">=</span> <span class="n">qeth_l3_set_offline</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">qeth_l3_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">qeth_l3_pm_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span> <span class="o">=</span> <span class="n">qeth_l3_pm_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">qeth_l3_pm_resume</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_l3_discipline</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_ip_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">init_net</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">qeth_l3_get_card_from_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;ipevent&quot;</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">qeth_l3_get_addr_buffer</span><span class="p">(</span><span class="n">QETH_PROT_IPV4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a4</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">QETH_IP_TYPE_NORMAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_add_ip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_delete_ip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qeth_l3_set_ip_addr_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">qeth_l3_ip_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">qeth_l3_ip_event</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_QETH_IPV6</span>
<span class="cm">/**</span>
<span class="cm"> * IPv6 event handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_ip6_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet6_ifaddr</span> <span class="o">*</span><span class="n">ifa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inet6_ifaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">qeth_l3_get_card_from_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;ip6event&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_IPV6</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">qeth_l3_get_addr_buffer</span><span class="p">(</span><span class="n">QETH_PROT_IPV6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">));</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">a6</span><span class="p">.</span><span class="n">pfxlen</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">prefix_len</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">QETH_IP_TYPE_NORMAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_add_ip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_l3_delete_ip</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qeth_l3_set_ip_addr_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">qeth_l3_ip6_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">qeth_l3_ip6_event</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_l3_register_notifiers</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;regnotif&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_inetaddr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_l3_ip_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QETH_IPV6</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_inet6addr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_l3_ip6_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_inetaddr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_l3_ip_notifier</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;There is no IPv6 support for the layer 3 discipline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_l3_unregister_notifiers</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;unregnot&quot;</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">unregister_inetaddr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_l3_ip_notifier</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_QETH_IPV6</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">unregister_inet6addr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_l3_ip6_notifier</span><span class="p">));</span>
<span class="cp">#endif </span><span class="cm">/* QETH_IPV6 */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">qeth_l3_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;register layer 3 discipline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_l3_register_notifiers</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">qeth_l3_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qeth_l3_unregister_notifiers</span><span class="p">();</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;unregister layer 3 discipline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">qeth_l3_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">qeth_l3_exit</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Frank Blaschka &lt;frank.blaschka@de.ibm.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;qeth layer 3 discipline&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
