<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › net › ctcm_mpc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ctcm_mpc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	drivers/s390/net/ctcm_mpc.c</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright IBM Corp. 2004, 2007</span>
<span class="cm"> *	Authors:	Belinda Thompson (belindat@us.ibm.com)</span>
<span class="cm"> *			Andy Richter (richtera@us.ibm.com)</span>
<span class="cm"> *			Peter Tiedemann (ptiedem@de.ibm.com)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm">	This module exports functions to be used by CCS:</span>
<span class="cm">	EXPORT_SYMBOL(ctc_mpc_alloc_channel);</span>
<span class="cm">	EXPORT_SYMBOL(ctc_mpc_establish_connectivity);</span>
<span class="cm">	EXPORT_SYMBOL(ctc_mpc_dealloc_ch);</span>
<span class="cm">	EXPORT_SYMBOL(ctc_mpc_flow_control);</span>
<span class="cm">*/</span>

<span class="cp">#undef DEBUG</span>
<span class="cp">#undef DEBUGDATA</span>
<span class="cp">#undef DEBUGCCW</span>

<span class="cp">#define KMSG_COMPONENT &quot;ctcm&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>

<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;net/dst.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;		</span><span class="cm">/* instead of &lt;asm/io.h&gt; ok ? */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/ccwdev.h&gt;</span>
<span class="cp">#include &lt;asm/ccwgroup.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;	</span><span class="cm">/* instead of &lt;asm/bitops.h&gt; ok ? */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/uaccess.h&gt;	</span><span class="cm">/* instead of &lt;asm/uaccess.h&gt; ok ? */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;asm/idals.h&gt;</span>

<span class="cp">#include &quot;ctcm_main.h&quot;</span>
<span class="cp">#include &quot;ctcm_mpc.h&quot;</span>
<span class="cp">#include &quot;ctcm_fsms.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xid2</span> <span class="n">init_xid</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xid2_type_id</span>	<span class="o">=</span>	<span class="n">XID_FM2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_len</span>	<span class="o">=</span>	<span class="mh">0x45</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_adj_id</span>	<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_rlen</span>	<span class="o">=</span>	<span class="mh">0x31</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_resv1</span>	<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_flag1</span>	<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_fmtt</span>	<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_flag4</span>	<span class="o">=</span>	<span class="mh">0x80</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_resv2</span>	<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_tgnum</span>	<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_sender_id</span>	<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_flag2</span>	<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_option</span>	<span class="o">=</span>	<span class="n">XID2_0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_resv3</span>	<span class="o">=</span>	<span class="s">&quot;</span><span class="se">\x00</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_resv4</span>	<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_dlc_type</span>	<span class="o">=</span>	<span class="n">XID2_READ_SIDE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_resv5</span>	<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_mpc_flag</span>	<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_resv6</span>	<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xid2_buf_len</span>	<span class="o">=</span>	<span class="p">(</span><span class="n">MPC_BUFSIZE_DEFAULT</span> <span class="o">-</span> <span class="mi">35</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">th_header</span> <span class="n">thnorm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">th_seg</span>		<span class="o">=</span>	<span class="mh">0x00</span><span class="p">,</span>
	<span class="p">.</span><span class="n">th_ch_flag</span>	<span class="o">=</span>	<span class="n">TH_IS_XID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">th_blk_flag</span>	<span class="o">=</span>	<span class="n">TH_DATA_IS_XID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">th_is_xid</span>	<span class="o">=</span>	<span class="mh">0x01</span><span class="p">,</span>
	<span class="p">.</span><span class="n">th_seq_num</span>	<span class="o">=</span>	<span class="mh">0x00000000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">th_header</span> <span class="n">thdummy</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">th_seg</span>		<span class="o">=</span>	<span class="mh">0x00</span><span class="p">,</span>
	<span class="p">.</span><span class="n">th_ch_flag</span>	<span class="o">=</span>	<span class="mh">0x00</span><span class="p">,</span>
	<span class="p">.</span><span class="n">th_blk_flag</span>	<span class="o">=</span>	<span class="n">TH_DATA_IS_XID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">th_is_xid</span>	<span class="o">=</span>	<span class="mh">0x01</span><span class="p">,</span>
	<span class="p">.</span><span class="n">th_seq_num</span>	<span class="o">=</span>	<span class="mh">0x00000000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Definition of one MPC group</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Compatibility macros for busy handling</span>
<span class="cm"> * of network devices.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ctcmpc_unpack_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pskb</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * MPC Group state machine actions (static prototypes)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_action_nop</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_action_go_ready</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_action_go_inop</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_action_timeout</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">mpc_validate_xid</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpcg_info</span> <span class="o">*</span><span class="n">mpcginfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_action_yside_xid</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_action_doxid0</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_action_doxid7</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_action_xside_xid</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_action_rcvd_xid0</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpc_action_rcvd_xid7</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="cp">#ifdef DEBUGDATA</span>
<span class="cm">/*-------------------------------------------------------------------*</span>
<span class="cm">* Dump buffer format						     *</span>
<span class="cm">*								     *</span>
<span class="cm">*--------------------------------------------------------------------*/</span>
<span class="kt">void</span> <span class="nf">ctcmpc_dumpit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span>	<span class="n">ct</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">dup</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">rptr</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">tbuf</span><span class="p">[</span><span class="mi">82</span><span class="p">],</span> <span class="n">tdup</span><span class="p">[</span><span class="mi">82</span><span class="p">];</span>
	<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="kt">char</span>	<span class="n">addr</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>
	<span class="cp">#else</span>
	<span class="kt">char</span>	<span class="n">addr</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="cp">#endif</span>
	<span class="kt">char</span>	<span class="n">boff</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="kt">char</span>	<span class="n">bhex</span><span class="p">[</span><span class="mi">82</span><span class="p">],</span> <span class="n">duphex</span><span class="p">[</span><span class="mi">82</span><span class="p">];</span>
	<span class="kt">char</span>	<span class="n">basc</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>

	<span class="n">sw</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rptr</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">rm</span>  <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">duphex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">dup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ct</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">ct</span><span class="o">++</span><span class="p">,</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="n">rptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cp">#ifdef CONFIG_64BIT</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="s">&quot;%16.16llx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">rptr</span><span class="p">);</span>
			<span class="cp">#else</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="s">&quot;%8.8X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">rptr</span><span class="p">);</span>
			<span class="cp">#endif</span>

			<span class="n">sprintf</span><span class="p">(</span><span class="n">boff</span><span class="p">,</span> <span class="s">&quot;%4.4X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">ct</span><span class="p">);</span>
			<span class="n">bhex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">basc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sw</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sw</span> <span class="o">==</span> <span class="mi">12</span><span class="p">))</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">bhex</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sw</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">bhex</span><span class="p">,</span> <span class="s">&quot;	&quot;</span><span class="p">);</span>

		<span class="cp">#if CONFIG_64BIT</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="s">&quot;%2.2llX&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
		<span class="cp">#else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="s">&quot;%2.2X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
		<span class="cp">#endif</span>

		<span class="n">tbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">bhex</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">isprint</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">))</span>
			<span class="n">basc</span><span class="p">[</span><span class="n">sw</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">basc</span><span class="p">[</span><span class="n">sw</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>

		<span class="n">basc</span><span class="p">[</span><span class="n">sw</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">sw</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rm</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sw</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">strcmp</span><span class="p">(</span><span class="n">duphex</span><span class="p">,</span> <span class="n">bhex</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dup</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">tdup</span><span class="p">,</span>
					<span class="s">&quot;Duplicate as above to %s&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
				<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;		       --- %s ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">tdup</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;   %s (+%s) : %s  [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">addr</span><span class="p">,</span> <span class="n">boff</span><span class="p">,</span> <span class="n">bhex</span><span class="p">,</span> <span class="n">basc</span><span class="p">);</span>
			<span class="n">dup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">duphex</span><span class="p">,</span> <span class="n">bhex</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dup</span><span class="o">++</span><span class="p">;</span>

		<span class="n">sw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rm</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>  <span class="cm">/* endfor */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sw</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">rm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rm</span><span class="o">--</span><span class="p">,</span> <span class="n">sw</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sw</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sw</span> <span class="o">==</span> <span class="mi">12</span><span class="p">))</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">bhex</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sw</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">bhex</span><span class="p">,</span> <span class="s">&quot;	&quot;</span><span class="p">);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">bhex</span><span class="p">,</span> <span class="s">&quot;	&quot;</span><span class="p">);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">basc</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dup</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">tdup</span><span class="p">,</span> <span class="s">&quot;Duplicate as above to %s&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;		       --- %s ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tdup</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;   %s (+%s) : %s  [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">addr</span><span class="p">,</span> <span class="n">boff</span><span class="p">,</span> <span class="n">bhex</span><span class="p">,</span> <span class="n">basc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dup</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">tdup</span><span class="p">,</span> <span class="s">&quot;Duplicate as above to %s&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;		       --- %s ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tdup</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dup</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;   %s (+%s) : %s  [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">addr</span><span class="p">,</span> <span class="n">boff</span><span class="p">,</span> <span class="n">bhex</span><span class="p">,</span> <span class="n">basc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>   <span class="cm">/*	 end of ctcmpc_dumpit  */</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUGDATA</span>
<span class="cm">/*</span>
<span class="cm"> * Dump header and first 16 bytes of an sk_buff for debugging purposes.</span>
<span class="cm"> *</span>
<span class="cm"> * skb		The sk_buff to dump.</span>
<span class="cm"> * offset	Offset relative to skb-data, where to start the dump.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ctcmpc_dump_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">th_header</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pdu</span> <span class="o">*</span><span class="n">pheader</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bl</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">th_header</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>

	<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;skb len=%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_ch_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TH_HAS_PDU</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
		<span class="k">case</span> <span class="n">TH_IS_XID</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_blk_flag</span> <span class="o">==</span> <span class="n">TH_DATA_IS_XID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_is_xid</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">dumpth</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TH_SWEEP_REQ</span>:
				<span class="k">goto</span> <span class="n">dumpth</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TH_SWEEP_RESP</span>:
				<span class="k">goto</span> <span class="n">dumpth</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pheader</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pdu</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;pdu-&gt;offset: %d hex: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pheader</span><span class="o">-&gt;</span><span class="n">pdu_offset</span><span class="p">,</span> <span class="n">pheader</span><span class="o">-&gt;</span><span class="n">pdu_offset</span><span class="p">);</span>
		<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;pdu-&gt;flag  : %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pheader</span><span class="o">-&gt;</span><span class="n">pdu_flag</span><span class="p">);</span>
		<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;pdu-&gt;proto : %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pheader</span><span class="o">-&gt;</span><span class="n">pdu_proto</span><span class="p">);</span>
		<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;pdu-&gt;seq   : %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pheader</span><span class="o">-&gt;</span><span class="n">pdu_seq</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">dumpdata</span><span class="p">;</span>

<span class="nl">dumpth:</span>
		<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;th-&gt;seg     : %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">th_seg</span><span class="p">);</span>
		<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;th-&gt;ch      : %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">th_ch_flag</span><span class="p">);</span>
		<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;th-&gt;blk_flag: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">th_blk_flag</span><span class="p">);</span>
		<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;th-&gt;type    : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_is_xid</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DATA&quot;</span> <span class="o">:</span> <span class="s">&quot;XID&quot;</span><span class="p">);</span>
		<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;th-&gt;seqnum  : %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">th_seq_num</span><span class="p">);</span>

	<span class="p">}</span>
<span class="nl">dumpdata:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bl</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">bl</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;data: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;%02x%s&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">ctcmpc_get_dev</span><span class="p">(</span><span class="kt">int</span> <span class="n">port_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">device</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s%i&quot;</span><span class="p">,</span> <span class="n">MPC_DEVICE_NAME</span><span class="p">,</span> <span class="n">port_num</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
			<span class="s">&quot;%s: Device not found by name: %s&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): dev-&gt;ml_priv is NULL&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): priv-&gt;mpcg is NULL&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ctc_mpc_alloc_channel</span>
<span class="cm"> *	(exported interface)</span>
<span class="cm"> *</span>
<span class="cm"> * Device Initialization :</span>
<span class="cm"> *	ACTPATH  driven IO operations</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ctc_mpc_alloc_channel</span><span class="p">(</span><span class="kt">int</span> <span class="n">port_num</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ctcmpc_get_dev</span><span class="p">(</span><span class="n">port_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">allochanfunc</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">port_num</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_persist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_SETUP</span><span class="p">,</span> <span class="n">CTC_DBF_INFO</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): state=%s&quot;</span><span class="p">,</span>
			<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fsm_getstate_str</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_INOP</span>:
		<span class="cm">/* Group is in the process of terminating */</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">alloc_called</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_RESET</span>:
		<span class="cm">/* MPC Group will transition to state		  */</span>
		<span class="cm">/* MPCG_STATE_XID2INITW iff the minimum number	  */</span>
		<span class="cm">/* of 1 read and 1 write channel have successfully*/</span>
		<span class="cm">/* activated					  */</span>
		<span class="cm">/*fsm_newstate(grp-&gt;fsm, MPCG_STATE_XID2INITW);*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">send_qllc_disc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID0IOWAIT</span>:
		<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7_p2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_xid2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
			<span class="n">ctcm_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">fsm_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">DEV_EVENT_START</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_READY</span>:
		<span class="cm">/* XID exchanges completed after PORT was activated */</span>
		<span class="cm">/* Link station already active			    */</span>
		<span class="cm">/* Maybe timing issue...retry callback		    */</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">allocchan_callback_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">allocchan_callback_retries</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">allochanfunc</span><span class="p">)</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">allochanfunc</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span>
						  <span class="n">grp</span><span class="o">-&gt;</span><span class="n">group_max_buflen</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* there are problems...bail out	    */</span>
			<span class="cm">/* there may be a state mismatch so restart */</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">allocchan_callback_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ctc_mpc_alloc_channel</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * ctc_mpc_establish_connectivity</span>
<span class="cm"> *	(exported interface)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ctc_mpc_establish_connectivity</span><span class="p">(</span><span class="kt">int</span> <span class="n">port_num</span><span class="p">,</span>
				<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">rch</span><span class="p">,</span> <span class="o">*</span><span class="n">wch</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ctcmpc_get_dev</span><span class="p">(</span><span class="n">port_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>
	<span class="n">rch</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">];</span>
	<span class="n">wch</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_WRITE</span><span class="p">];</span>

	<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_SETUP</span><span class="p">,</span> <span class="n">CTC_DBF_INFO</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): state=%s&quot;</span><span class="p">,</span>
			<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fsm_getstate_str</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">));</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">port_num</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_READY</span>:
		<span class="cm">/* XID exchanges completed after PORT was activated */</span>
		<span class="cm">/* Link station already active			    */</span>
		<span class="cm">/* Maybe timing issue...retry callback		    */</span>
		<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconn_callback_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconn_callback_retries</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">grp</span><span class="o">-&gt;</span><span class="n">group_max_buflen</span><span class="p">);</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* there are problems...bail out	 */</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconn_callback_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_INOP</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_RESET</span>:
		<span class="cm">/* MPC Group is not ready to start XID - min num of */</span>
		<span class="cm">/* 1 read and 1 write channel have not been acquired*/</span>

		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): REJECTED - inactive channels&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID2INITW</span>:
		<span class="cm">/* alloc channel was called but no XID exchange    */</span>
		<span class="cm">/* has occurred. initiate xside XID exchange	   */</span>
		<span class="cm">/* make sure yside XID0 processing has not started */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">rch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CH_XID0_PENDING</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">wch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CH_XID0_PENDING</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): ABORT - PASSIVE XID&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">send_qllc_disc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_XID0IOWAIT</span><span class="p">);</span>
		<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">fsm_addtimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">MPC_XID_TIMEOUT_VALUE</span><span class="p">,</span>
						<span class="n">MPCG_EVENT_TIMER</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7_p2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_xid2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rch</span><span class="o">-&gt;</span><span class="n">in_mpcgroup</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">rch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">==</span> <span class="n">CH_XID0_PENDING</span><span class="p">))</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_XID0DO</span><span class="p">,</span> <span class="n">rch</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): RX-%s not ready for ACTIVE XID0&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">wch</span><span class="o">-&gt;</span><span class="n">in_mpcgroup</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">wch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">==</span> <span class="n">CH_XID0_PENDING</span><span class="p">))</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_XID0DO</span><span class="p">,</span> <span class="n">wch</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): WX-%s not ready for ACTIVE XID0&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">wch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID0IOWAIT</span>:
		<span class="cm">/* already in active XID negotiations */</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;Exit %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ctc_mpc_establish_connectivity</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * ctc_mpc_dealloc_ch</span>
<span class="cm"> *	(exported interface)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ctc_mpc_dealloc_ch</span><span class="p">(</span><span class="kt">int</span> <span class="n">port_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ctcmpc_get_dev</span><span class="p">(</span><span class="n">port_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>

	<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_SETUP</span><span class="p">,</span> <span class="n">CTC_DBF_DEBUG</span><span class="p">,</span>
			<span class="s">&quot;%s: %s: refcount = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">netdev_refcnt_read</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">restart_timer</span><span class="p">);</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">channels_terminating</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">allochanfunc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_persist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">send_qllc_disc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">ctcm_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ctc_mpc_dealloc_ch</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * ctc_mpc_flow_control</span>
<span class="cm"> *	(exported interface)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ctc_mpc_flow_control</span><span class="p">(</span><span class="kt">int</span> <span class="n">port_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flowc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">rch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mpcg_state</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ctcmpc_get_dev</span><span class="p">(</span><span class="n">port_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>

	<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_TRACE</span><span class="p">,</span> <span class="n">CTC_DBF_DEBUG</span><span class="p">,</span>
			<span class="s">&quot;%s: %s: flowc = %d&quot;</span><span class="p">,</span>
				<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">flowc</span><span class="p">);</span>

	<span class="n">rch</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">];</span>

	<span class="n">mpcg_state</span> <span class="o">=</span> <span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flowc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mpcg_state</span> <span class="o">==</span> <span class="n">MPCG_STATE_FLOWC</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpcg_state</span> <span class="o">==</span> <span class="n">MPCG_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">flow_off_called</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">flow_off_called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_FLOWC</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mpcg_state</span> <span class="o">==</span> <span class="n">MPCG_STATE_FLOWC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_READY</span><span class="p">);</span>
			<span class="cm">/* ensure any data that has accumulated */</span>
			<span class="cm">/* on the io_queue will now be sen t	*/</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rch</span><span class="o">-&gt;</span><span class="n">ch_tasklet</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* possible race condition			*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpcg_state</span> <span class="o">==</span> <span class="n">MPCG_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">flow_off_called</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ctc_mpc_flow_control</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpc_send_qllc_discontact</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * helper function of ctcmpc_unpack_skb</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_rcvd_sweep_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpcg_info</span> <span class="o">*</span><span class="n">mpcginfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">channel</span>	  <span class="o">*</span><span class="n">rch</span> <span class="o">=</span> <span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rch</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span>   <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span>  <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span>	  <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_WRITE</span><span class="p">];</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;%s: ch=0x%p id=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">CTCM_D3_DUMP</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">sweep</span><span class="p">,</span> <span class="n">TH_SWEEP_LENGTH</span><span class="p">);</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">sweep_rsp_pend_num</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">sweep_req_pend_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">sweep_rsp_pend_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sweep_timer</span><span class="p">);</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">in_sweep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rch</span><span class="o">-&gt;</span><span class="n">th_seq_num</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">th_seq_num</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">ctcm_clear_busy_do</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * helper function of mpc_rcvd_sweep_req</span>
<span class="cm"> * which is a helper of ctcmpc_unpack_skb</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ctcmpc_send_sweep_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">rch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rch</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">th_sweep</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sweep_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">ch</span>  <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_WRITE</span><span class="p">];</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;%s: ch=0x%p id=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rch</span><span class="p">,</span> <span class="n">rch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">sweep_skb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">MPC_BUFSIZE_DEFAULT</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sweep_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): sweep_skb allocation ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">rch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">header</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">th_sweep</span><span class="p">),</span> <span class="n">gfp_type</span><span class="p">());</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">sweep_skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">header</span><span class="o">-&gt;</span><span class="n">th</span><span class="p">.</span><span class="n">th_seg</span>	<span class="o">=</span> <span class="mh">0x00</span> <span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">th</span><span class="p">.</span><span class="n">th_ch_flag</span>	<span class="o">=</span> <span class="n">TH_SWEEP_RESP</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">th</span><span class="p">.</span><span class="n">th_blk_flag</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">th</span><span class="p">.</span><span class="n">th_is_xid</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">th</span><span class="p">.</span><span class="n">th_seq_num</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">sw</span><span class="p">.</span><span class="n">th_last_seq</span>	<span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">th_seq_num</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">sweep_skb</span><span class="p">,</span> <span class="n">TH_SWEEP_LENGTH</span><span class="p">),</span> <span class="n">header</span><span class="p">,</span> <span class="n">TH_SWEEP_LENGTH</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sweep_queue</span><span class="p">,</span> <span class="n">sweep_skb</span><span class="p">);</span>

	<span class="n">fsm_addtimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sweep_timer</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">CTC_EVENT_RSWEEP_TIMER</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">in_sweep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctcm_clear_busy_do</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * helper function of ctcmpc_unpack_skb</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_rcvd_sweep_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpcg_info</span> <span class="o">*</span><span class="n">mpcginfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">channel</span>	  <span class="o">*</span><span class="n">rch</span>     <span class="o">=</span> <span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span>     <span class="o">=</span> <span class="n">rch</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span>  <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span>  <span class="o">*</span><span class="n">grp</span>  <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span>	  <span class="o">*</span><span class="n">ch</span>	   <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_WRITE</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_debug</span><span class="p">)</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_TRACE</span><span class="p">,</span> <span class="n">CTC_DBF_DEBUG</span><span class="p">,</span>
			<span class="s">&quot; %s(): ch=0x%p id=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">in_sweep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">in_sweep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ctcm_test_and_set_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">sweep_req_pend_num</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">];</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">sweep_rsp_pend_num</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">CTCM_D3_DUMP</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">sweep</span><span class="p">,</span> <span class="n">TH_SWEEP_LENGTH</span><span class="p">);</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">sweep_req_pend_num</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ctcmpc_send_sweep_resp</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  * MPC Group Station FSM definitions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mpcg_event_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">MPCG_EVENT_INOP</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;INOP Condition&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_EVENT_DISCONC</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Discontact Received&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_EVENT_XID0DO</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Channel Active - Start XID&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_EVENT_XID2</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;XID2 Received&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_EVENT_XID2DONE</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;XID0 Complete&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_EVENT_XID7DONE</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;XID7 Complete&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_EVENT_TIMER</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;XID Setup Timer&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_EVENT_DOIO</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;XID DoIO&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mpcg_state_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">MPCG_STATE_RESET</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Reset&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_STATE_INOP</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;INOP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_STATE_XID2INITW</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Passive XID- XID0 Pending Start&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_STATE_XID2INITX</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Passive XID- XID0 Pending Complete&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_STATE_XID7INITW</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Passive XID- XID7 Pending P1 Start&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_STATE_XID7INITX</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Passive XID- XID7 Pending P2 Complete&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_STATE_XID0IOWAIT</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Active  XID- XID0 Pending Start&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_STATE_XID0IOWAIX</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Active  XID- XID0 Pending Complete&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_STATE_XID7INITI</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Active  XID- XID7 Pending Start&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_STATE_XID7INITZ</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Active  XID- XID7 Pending Complete &quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_STATE_XID7INITF</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;XID        - XID7 Complete &quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_STATE_FLOWC</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;FLOW CONTROL ON&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MPCG_STATE_READY</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;READY&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The MPC Group Station FSM</span>
<span class="cm"> *   22 events</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">fsm_node</span> <span class="n">mpcg_fsm</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_RESET</span><span class="p">,</span>	<span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_go_inop</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_INOP</span><span class="p">,</span>	<span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_nop</span>        <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_FLOWC</span><span class="p">,</span>	<span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_go_inop</span>    <span class="p">},</span>

	<span class="p">{</span> <span class="n">MPCG_STATE_READY</span><span class="p">,</span>	<span class="n">MPCG_EVENT_DISCONC</span><span class="p">,</span>	<span class="n">mpc_action_discontact</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_READY</span><span class="p">,</span>	<span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_go_inop</span>    <span class="p">},</span>

	<span class="p">{</span> <span class="n">MPCG_STATE_XID2INITW</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID0DO</span><span class="p">,</span>	<span class="n">mpc_action_doxid0</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID2INITW</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID2</span><span class="p">,</span>	<span class="n">mpc_action_rcvd_xid0</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID2INITW</span><span class="p">,</span>	<span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_go_inop</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID2INITW</span><span class="p">,</span>	<span class="n">MPCG_EVENT_TIMER</span><span class="p">,</span>	<span class="n">mpc_action_timeout</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID2INITW</span><span class="p">,</span>	<span class="n">MPCG_EVENT_DOIO</span><span class="p">,</span>	<span class="n">mpc_action_yside_xid</span>  <span class="p">},</span>

	<span class="p">{</span> <span class="n">MPCG_STATE_XID2INITX</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID0DO</span><span class="p">,</span>	<span class="n">mpc_action_doxid0</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID2INITX</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID2</span><span class="p">,</span>	<span class="n">mpc_action_rcvd_xid0</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID2INITX</span><span class="p">,</span>	<span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_go_inop</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID2INITX</span><span class="p">,</span>	<span class="n">MPCG_EVENT_TIMER</span><span class="p">,</span>	<span class="n">mpc_action_timeout</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID2INITX</span><span class="p">,</span>	<span class="n">MPCG_EVENT_DOIO</span><span class="p">,</span>	<span class="n">mpc_action_yside_xid</span>  <span class="p">},</span>

	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITW</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID2DONE</span><span class="p">,</span>	<span class="n">mpc_action_doxid7</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITW</span><span class="p">,</span>	<span class="n">MPCG_EVENT_DISCONC</span><span class="p">,</span>	<span class="n">mpc_action_discontact</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITW</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID2</span><span class="p">,</span>	<span class="n">mpc_action_rcvd_xid7</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITW</span><span class="p">,</span>	<span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_go_inop</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITW</span><span class="p">,</span>	<span class="n">MPCG_EVENT_TIMER</span><span class="p">,</span>	<span class="n">mpc_action_timeout</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITW</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID7DONE</span><span class="p">,</span>	<span class="n">mpc_action_doxid7</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITW</span><span class="p">,</span>	<span class="n">MPCG_EVENT_DOIO</span><span class="p">,</span>	<span class="n">mpc_action_yside_xid</span>  <span class="p">},</span>

	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITX</span><span class="p">,</span>	<span class="n">MPCG_EVENT_DISCONC</span><span class="p">,</span>	<span class="n">mpc_action_discontact</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITX</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID2</span><span class="p">,</span>	<span class="n">mpc_action_rcvd_xid7</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITX</span><span class="p">,</span>	<span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_go_inop</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITX</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID7DONE</span><span class="p">,</span>	<span class="n">mpc_action_doxid7</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITX</span><span class="p">,</span>	<span class="n">MPCG_EVENT_TIMER</span><span class="p">,</span>	<span class="n">mpc_action_timeout</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITX</span><span class="p">,</span>	<span class="n">MPCG_EVENT_DOIO</span><span class="p">,</span>	<span class="n">mpc_action_yside_xid</span>  <span class="p">},</span>

	<span class="p">{</span> <span class="n">MPCG_STATE_XID0IOWAIT</span><span class="p">,</span> <span class="n">MPCG_EVENT_XID0DO</span><span class="p">,</span>	<span class="n">mpc_action_doxid0</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID0IOWAIT</span><span class="p">,</span> <span class="n">MPCG_EVENT_DISCONC</span><span class="p">,</span>	<span class="n">mpc_action_discontact</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID0IOWAIT</span><span class="p">,</span> <span class="n">MPCG_EVENT_XID2</span><span class="p">,</span>	<span class="n">mpc_action_rcvd_xid0</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID0IOWAIT</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_go_inop</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID0IOWAIT</span><span class="p">,</span> <span class="n">MPCG_EVENT_TIMER</span><span class="p">,</span>	<span class="n">mpc_action_timeout</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID0IOWAIT</span><span class="p">,</span> <span class="n">MPCG_EVENT_DOIO</span><span class="p">,</span>	<span class="n">mpc_action_xside_xid</span>  <span class="p">},</span>

	<span class="p">{</span> <span class="n">MPCG_STATE_XID0IOWAIX</span><span class="p">,</span> <span class="n">MPCG_EVENT_XID0DO</span><span class="p">,</span>	<span class="n">mpc_action_doxid0</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID0IOWAIX</span><span class="p">,</span> <span class="n">MPCG_EVENT_DISCONC</span><span class="p">,</span>	<span class="n">mpc_action_discontact</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID0IOWAIX</span><span class="p">,</span> <span class="n">MPCG_EVENT_XID2</span><span class="p">,</span>	<span class="n">mpc_action_rcvd_xid0</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID0IOWAIX</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_go_inop</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID0IOWAIX</span><span class="p">,</span> <span class="n">MPCG_EVENT_TIMER</span><span class="p">,</span>	<span class="n">mpc_action_timeout</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID0IOWAIX</span><span class="p">,</span> <span class="n">MPCG_EVENT_DOIO</span><span class="p">,</span>	<span class="n">mpc_action_xside_xid</span>  <span class="p">},</span>

	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITI</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID2DONE</span><span class="p">,</span>	<span class="n">mpc_action_doxid7</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITI</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID2</span><span class="p">,</span>	<span class="n">mpc_action_rcvd_xid7</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITI</span><span class="p">,</span>	<span class="n">MPCG_EVENT_DISCONC</span><span class="p">,</span>	<span class="n">mpc_action_discontact</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITI</span><span class="p">,</span>	<span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_go_inop</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITI</span><span class="p">,</span>	<span class="n">MPCG_EVENT_TIMER</span><span class="p">,</span>	<span class="n">mpc_action_timeout</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITI</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID7DONE</span><span class="p">,</span>	<span class="n">mpc_action_doxid7</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITI</span><span class="p">,</span>	<span class="n">MPCG_EVENT_DOIO</span><span class="p">,</span>	<span class="n">mpc_action_xside_xid</span>  <span class="p">},</span>

	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITZ</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID2</span><span class="p">,</span>	<span class="n">mpc_action_rcvd_xid7</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITZ</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID7DONE</span><span class="p">,</span>	<span class="n">mpc_action_doxid7</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITZ</span><span class="p">,</span>	<span class="n">MPCG_EVENT_DISCONC</span><span class="p">,</span>	<span class="n">mpc_action_discontact</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITZ</span><span class="p">,</span>	<span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_go_inop</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITZ</span><span class="p">,</span>	<span class="n">MPCG_EVENT_TIMER</span><span class="p">,</span>	<span class="n">mpc_action_timeout</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITZ</span><span class="p">,</span>	<span class="n">MPCG_EVENT_DOIO</span><span class="p">,</span>	<span class="n">mpc_action_xside_xid</span>  <span class="p">},</span>

	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITF</span><span class="p">,</span>	<span class="n">MPCG_EVENT_INOP</span><span class="p">,</span>	<span class="n">mpc_action_go_inop</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPCG_STATE_XID7INITF</span><span class="p">,</span>	<span class="n">MPCG_EVENT_XID7DONE</span><span class="p">,</span>	<span class="n">mpc_action_go_ready</span>   <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpcg_fsm_len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mpcg_fsm</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * MPC Group Station FSM action</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_action_go_ready</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): No MPC group&quot;</span><span class="p">,</span>
				<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_xid2</span><span class="o">-&gt;</span><span class="n">xid2_flag2</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_flag2</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">grp</span><span class="o">-&gt;</span><span class="n">group_max_buflen</span><span class="p">);</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">allochanfunc</span><span class="p">)</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">send_qllc_disc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): fails&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_persist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">out_of_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconn_called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">mpc_tasklet2</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * helper of ctcm_init_netdevice</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mpc_group_ready</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">adev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): No MPC group&quot;</span><span class="p">,</span>
				<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_SETUP</span><span class="p">,</span> <span class="n">CTC_DBF_NOTICE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s: GROUP TRANSITIONED TO READY, maxbuf = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">group_max_buflen</span><span class="p">);</span>

	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_READY</span><span class="p">);</span>

	<span class="cm">/* Put up a read on the channel */</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">];</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">pdu_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CTCM_PR_DBGDATA</span><span class="p">(</span><span class="s">&quot;ctcmpc: %s() ToDCM_pdu_seq= %08x</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">pdu_seq</span><span class="p">);</span>

	<span class="n">ctcmpc_chx_rxidle</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CTC_EVENT_START</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="cm">/* Put the write channel in idle state */</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_WRITE</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">collect_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">collect_lock</span><span class="p">);</span>
		<span class="n">ctcm_purge_skb_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">collect_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">collect_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ctcm_chx_txidle</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CTC_EVENT_START</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">ctcm_clear_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">grp</span><span class="o">-&gt;</span><span class="n">group_max_buflen</span><span class="p">);</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> 	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">allochanfunc</span><span class="p">)</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">allochanfunc</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">group_max_buflen</span><span class="p">);</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">send_qllc_disc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">changed_side</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Increment the MPC Group Active Channel Counts</span>
<span class="cm"> * helper of dev_action (called from channel fsm)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mpc_channel_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">int</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span>   <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span>   <span class="o">*</span><span class="n">grp</span>  <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): No MPC group&quot;</span><span class="p">,</span>
				<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;enter %s: ch=0x%p id=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_TRACE</span><span class="p">,</span> <span class="n">CTC_DBF_NOTICE</span><span class="p">,</span>
		<span class="s">&quot;%s: %i / Grp:%s total_channels=%i, active_channels: &quot;</span>
		<span class="s">&quot;read=%i, write=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
		<span class="n">fsm_getstate_str</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">),</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">num_channel_paths</span><span class="p">,</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">],</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">CTCM_WRITE</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">action</span> <span class="o">==</span> <span class="n">MPC_CHANNEL_ADD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">in_mpcgroup</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">num_channel_paths</span><span class="o">++</span><span class="p">;</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid2</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">in_mpcgroup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">);</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">MPC_BUFSIZE_DEFAULT</span><span class="p">,</span>
					<span class="n">GFP_ATOMIC</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): Couldn&#39;t alloc ch xid_skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb_data</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_th</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">th_header</span> <span class="o">*</span><span class="p">)</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xid2</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">,</span> <span class="n">XID2_LENGTH</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_id</span> <span class="o">=</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb_data</span><span class="p">;</span>
		<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_dlc_type</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">CHANNEL_DIRECTION</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="n">CTCM_READ</span><span class="p">)</span>
				<span class="o">?</span> <span class="n">XID2_READ_SIDE</span> <span class="o">:</span> <span class="n">XID2_WRITE_SIDE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHANNEL_DIRECTION</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="n">CTCM_WRITE</span><span class="p">)</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_buf_len</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb_data</span><span class="p">;</span>
		<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CH_XID0_PENDING</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">CTCM_WRITE</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MPCG_STATE_XID2INITW</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_XID2INITW</span><span class="p">);</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_SETUP</span><span class="p">,</span> <span class="n">CTC_DBF_NOTICE</span><span class="p">,</span>
				<span class="s">&quot;%s: %s: MPC GROUP CHANNELS ACTIVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">action</span> <span class="o">==</span> <span class="n">MPC_CHANNEL_REMOVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">in_mpcgroup</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">in_mpcgroup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">num_channel_paths</span><span class="o">--</span><span class="p">;</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">channels_terminating</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">CTCM_WRITE</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="o">||</span> <span class="p">((</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">CTCM_WRITE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)))</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_TRACE</span><span class="p">,</span> <span class="n">CTC_DBF_DEBUG</span><span class="p">,</span>
		<span class="s">&quot;exit %s: %i / Grp:%s total_channels=%i, active_channels: &quot;</span>
		<span class="s">&quot;read=%i, write=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
		<span class="n">fsm_getstate_str</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">),</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">num_channel_paths</span><span class="p">,</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">],</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">active_channels</span><span class="p">[</span><span class="n">CTCM_WRITE</span><span class="p">]);</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;exit %s: ch=0x%p id=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Unpack a just received skb and hand it over to</span>
<span class="cm"> * upper layers.</span>
<span class="cm"> * special MPC version of unpack_skb.</span>
<span class="cm"> *</span>
<span class="cm"> * ch		The channel where this skb has been received.</span>
<span class="cm"> * pskb		The received skb.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ctcmpc_unpack_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pskb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pdu</span> <span class="o">*</span><span class="n">curr_pdu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpcg_info</span> <span class="o">*</span><span class="n">mpcginfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">th_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">th_sweep</span> <span class="o">*</span><span class="n">sweep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pdu_last_seen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">new_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skblen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sendrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;ctcmpc enter: %s() %s cp:%i ch:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">th_header</span> <span class="o">*</span><span class="p">)</span><span class="n">pskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_seg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_ch_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_blk_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_seq_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="cm">/* nothing for us */</span>	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">CTCM_PR_DBGDATA</span><span class="p">(</span><span class="s">&quot;%s: th_header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">CTCM_D3_DUMP</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>
	<span class="n">CTCM_PR_DBGDATA</span><span class="p">(</span><span class="s">&quot;%s: pskb len: %04x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">pskb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">pskb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">pskb</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_ch_flag</span> <span class="o">==</span> <span class="n">TH_HAS_PDU</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">CTCM_PR_DBGDATA</span><span class="p">(</span><span class="s">&quot;%s: came into th_has_pdu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPCG_STATE_FLOWC</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPCG_STATE_READY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_seq_num</span> <span class="o">!=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">th_seq_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">th_seq_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* This is NOT the next segment		*</span>
<span class="cm">			 * we are not the correct race winner	*</span>
<span class="cm">			 * go away and let someone else win	*</span>
<span class="cm">			 * BUT..this only applies if xid negot	*</span>
<span class="cm">			 * is done				*</span>
<span class="cm">			*/</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">out_of_sequence</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">__skb_push</span><span class="p">(</span><span class="n">pskb</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">io_queue</span><span class="p">,</span> <span class="n">pskb</span><span class="p">);</span>
			<span class="n">CTCM_PR_DBGDATA</span><span class="p">(</span><span class="s">&quot;%s: th_seq_num expect:%08x &quot;</span>
					<span class="s">&quot;got:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">th_seq_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">th_seq_num</span><span class="p">);</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">out_of_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">th_seq_num</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">th_seq_num</span><span class="p">;</span>

		<span class="n">CTCM_PR_DBGDATA</span><span class="p">(</span><span class="s">&quot;ctcmpc: %s() FromVTAM_th_seq=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">th_seq_num</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPCG_STATE_READY</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">pskb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pdu_last_seen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">curr_pdu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pdu</span> <span class="o">*</span><span class="p">)</span><span class="n">pskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

			<span class="n">CTCM_PR_DBGDATA</span><span class="p">(</span><span class="s">&quot;%s: pdu_header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">CTCM_D3_DUMP</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">PDU_HEADER_LENGTH</span><span class="p">);</span>
			<span class="n">CTCM_PR_DBGDATA</span><span class="p">(</span><span class="s">&quot;%s: pskb len: %04x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

			<span class="n">skb_pull</span><span class="p">(</span><span class="n">pskb</span><span class="p">,</span> <span class="n">PDU_HEADER_LENGTH</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">curr_pdu</span><span class="o">-&gt;</span><span class="n">pdu_flag</span> <span class="o">&amp;</span> <span class="n">PDU_LAST</span><span class="p">)</span>
				<span class="n">pdu_last_seen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curr_pdu</span><span class="o">-&gt;</span><span class="n">pdu_flag</span> <span class="o">&amp;</span> <span class="n">PDU_CNTL</span><span class="p">)</span>
				<span class="n">pskb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_SNAP</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">pskb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_SNA_DIX</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">pskb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pskb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">max_bufsize</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
					<span class="s">&quot;%s(%s): Dropping packet with &quot;</span>
					<span class="s">&quot;illegal siize %d&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">pskb</span><span class="p">);</span>
			<span class="n">new_len</span> <span class="o">=</span> <span class="n">curr_pdu</span><span class="o">-&gt;</span><span class="n">pdu_offset</span><span class="p">;</span>
			<span class="n">CTCM_PR_DBGDATA</span><span class="p">(</span><span class="s">&quot;%s: new_len: %04x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">new_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">new_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_len</span> <span class="o">&gt;</span> <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* should never happen		    */</span>
				<span class="cm">/* pskb len must be hosed...bail out */</span>
				<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
					<span class="s">&quot;%s(%s): non valid pdu_offset: %04x&quot;</span><span class="p">,</span>
					<span class="cm">/* &quot;data may be lost&quot;, */</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_len</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">new_len</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
					<span class="s">&quot;%s(%s): MEMORY allocation error&quot;</span><span class="p">,</span>
						<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
						<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">new_len</span><span class="p">),</span> <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">new_len</span><span class="p">);</span>

			<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
			<span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">pdu_seq</span><span class="p">;</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">pdu_seq</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">do_debug_data</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;%s: ToDCM_pdu_seq= %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">pdu_seq</span><span class="p">);</span>
				<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;%s: skb:%0lx &quot;</span>
					<span class="s">&quot;skb len: %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">ctcm_pr_debug</span><span class="p">(</span><span class="s">&quot;%s: up to 32 bytes &quot;</span>
					<span class="s">&quot;of pdu_data sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">ctcmpc_dump32</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">skblen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">sendrc</span> <span class="o">=</span> <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skblen</span><span class="p">;</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">pskb</span><span class="p">,</span> <span class="n">new_len</span><span class="p">);</span> <span class="cm">/* point to next PDU */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mpcginfo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpcg_info</span><span class="p">),</span> <span class="n">gfp_type</span><span class="p">());</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpcginfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">th</span> <span class="o">=</span> <span class="n">header</span><span class="p">;</span>
		<span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">pskb</span><span class="p">;</span>
		<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;%s: Not PDU - may be control pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/*  it&#39;s a sweep?   */</span>
		<span class="n">sweep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">th_sweep</span> <span class="o">*</span><span class="p">)</span><span class="n">pskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">sweep</span> <span class="o">=</span> <span class="n">sweep</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_ch_flag</span> <span class="o">==</span> <span class="n">TH_SWEEP_REQ</span><span class="p">)</span>
			<span class="n">mpc_rcvd_sweep_req</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_ch_flag</span> <span class="o">==</span> <span class="n">TH_SWEEP_RESP</span><span class="p">)</span>
			<span class="n">mpc_rcvd_sweep_resp</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_blk_flag</span> <span class="o">==</span> <span class="n">TH_DATA_IS_XID</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">xid2</span> <span class="o">*</span><span class="n">thisxid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xid2</span> <span class="o">*</span><span class="p">)</span><span class="n">pskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">pskb</span><span class="p">,</span> <span class="n">XID2_LENGTH</span><span class="p">);</span>
			<span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="n">thisxid</span><span class="p">;</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_XID2</span><span class="p">,</span> <span class="n">mpcginfo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_blk_flag</span> <span class="o">==</span> <span class="n">TH_DISCONTACT</span><span class="p">)</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_DISCONC</span><span class="p">,</span> <span class="n">mpcginfo</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">th_seq_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): control pkt expected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* mpcginfo only used for non-data transfers */</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_debug_data</span><span class="p">)</span>
				<span class="n">ctcmpc_dump_skb</span><span class="p">(</span><span class="n">pskb</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">done:</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">pskb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sendrc</span> <span class="o">==</span> <span class="n">NET_RX_DROP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The network backlog for %s is exceeded, &quot;</span>
			<span class="s">&quot;package dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;exit %s: %s: ch=0x%p id=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tasklet helper for mpc&#39;s skb unpacking.</span>
<span class="cm"> *</span>
<span class="cm"> * ch		The channel to work on.</span>
<span class="cm"> * Allow flow control back pressure to occur here.</span>
<span class="cm"> * Throttling back channel can result in excessive</span>
<span class="cm"> * channel inactivity and system deact of channel</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ctcmpc_bh</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">thischan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">channel</span>	  <span class="o">*</span><span class="n">ch</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="p">)</span><span class="n">thischan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	  <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span>  <span class="o">*</span><span class="n">priv</span>	<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span>  <span class="o">*</span><span class="n">grp</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;%s cp:%i enter:  %s() %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="cm">/* caller has requested driver to throttle back */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPCG_STATE_FLOWC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">io_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ctcmpc_unpack_skb</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">out_of_sequence</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* assume data loss has occurred if */</span>
			<span class="cm">/* missing seq_num for extended     */</span>
			<span class="cm">/* period of time		    */</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">out_of_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">io_queue</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;exit %s: %s: ch=0x%p id=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  MPC Group Initializations</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="nf">ctcmpc_init_mpc_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctcm_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>

	<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_SETUP</span><span class="p">,</span> <span class="n">CTC_DBF_INFO</span><span class="p">,</span>
			<span class="s">&quot;Enter %s(%p)&quot;</span><span class="p">,</span> <span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="n">grp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_group</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span> <span class="o">=</span> <span class="n">init_fsm</span><span class="p">(</span><span class="s">&quot;mpcg&quot;</span><span class="p">,</span> <span class="n">mpcg_state_names</span><span class="p">,</span> <span class="n">mpcg_event_names</span><span class="p">,</span>
			<span class="n">MPCG_NR_STATES</span><span class="p">,</span> <span class="n">MPCG_NR_EVENTS</span><span class="p">,</span> <span class="n">mpcg_fsm</span><span class="p">,</span>
			<span class="n">mpcg_fsm_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">grp</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_RESET</span><span class="p">);</span>
	<span class="n">fsm_settimer</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span> <span class="o">=</span>
		 <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">MPC_BUFSIZE_DEFAULT</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_fsm</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">grp</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  base xid for all channels in group  */</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb_data</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_th</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">th_header</span> <span class="o">*</span><span class="p">)</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">thnorm</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xid2</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">,</span> <span class="n">XID2_LENGTH</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">init_xid</span><span class="p">,</span> <span class="n">XID2_LENGTH</span><span class="p">);</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_adj_id</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">|</span> <span class="mh">0xfff00000</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_sender_id</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_id</span> <span class="o">=</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s">&quot;VTAM&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span> <span class="o">=</span>
		<span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">MPC_BUFSIZE_DEFAULT</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_fsm</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">grp</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_data</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_th</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">th_header</span> <span class="o">*</span><span class="p">)</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">thnorm</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_xid2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span> <span class="o">=</span> <span class="n">grp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">grp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The MPC Group Station FSM</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * MPC Group Station FSM actions</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * NOP action for statemachines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_action_nop</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * invoked when the device transitions to dev_stopped</span>
<span class="cm"> * MPC will stop each individual channel if a single XID failure</span>
<span class="cm"> * occurs, or will intitiate all channels be stopped if a GROUP</span>
<span class="cm"> * level failure occurs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_action_go_inop</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span>    <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">wch</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;Enter %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">priv</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">grp</span> <span class="o">=</span>  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">flow_off_called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">channels_terminating</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">channels_terminating</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_state</span> <span class="o">=</span> <span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">);</span>
	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_INOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_state</span> <span class="o">&gt;</span> <span class="n">MPCG_STATE_XID7INITF</span><span class="p">)</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_TRACE</span><span class="p">,</span> <span class="n">CTC_DBF_NOTICE</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): MPC GROUP INOPERATIVE&quot;</span><span class="p">,</span>
				<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_state</span> <span class="o">!=</span> <span class="n">MPCG_STATE_RESET</span><span class="p">)</span> <span class="o">||</span>
		<span class="cm">/* dealloc_channel has been called */</span>
		<span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_persist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">restart_timer</span><span class="p">);</span>

	<span class="n">wch</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_WRITE</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_RESET</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_INOP</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID2INITW</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID0IOWAIT</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID2INITX</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITW</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITX</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID0IOWAIX</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITI</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITZ</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITF</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_FLOWC</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_READY</span>:
	<span class="nl">default:</span>
		<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wch</span><span class="o">-&gt;</span><span class="n">ch_disc_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">xid2_tgnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">group_max_buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/*min of all received */</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7_p2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_xid2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">xidnogood</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">changed_side</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_data</span><span class="p">;</span>
	<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="p">);</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_th</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">th_header</span> <span class="o">*</span><span class="p">)</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">thnorm</span><span class="p">,</span>
	       <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">send_qllc_disc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">send_qllc_disc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mpc_send_qllc_discontact</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* DO NOT issue DEV_EVENT_STOP directly out of this code */</span>
	<span class="cm">/* This can result in INOP of VTAM PU due to halting of  */</span>
	<span class="cm">/* outstanding IO which causes a sense to be returned	 */</span>
	<span class="cm">/* Only about 3 senses are allowed and then IOS/VTAM will*/</span>
	<span class="cm">/* become unreachable without manual intervention	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_persist</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">alloc_called</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">alloc_called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">restart_timer</span><span class="p">);</span>
		<span class="n">fsm_addtimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">restart_timer</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">DEV_EVENT_RESTART</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_RESET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_state</span> <span class="o">&gt;</span> <span class="n">MPCG_STATE_XID7INITF</span><span class="p">)</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_TRACE</span><span class="p">,</span> <span class="n">CTC_DBF_ALWAYS</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): MPC GROUP RECOVERY SCHEDULED&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">restart_timer</span><span class="p">);</span>
		<span class="n">fsm_addtimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">restart_timer</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">DEV_EVENT_STOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_RESET</span><span class="p">);</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_TRACE</span><span class="p">,</span> <span class="n">CTC_DBF_ALWAYS</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): NO MPC GROUP RECOVERY ATTEMPTED&quot;</span><span class="p">,</span>
						<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Handle mpc group  action timeout.</span>
<span class="cm"> * MPC Group Station FSM action</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> *</span>
<span class="cm"> * fi		An instance of an mpc_group fsm.</span>
<span class="cm"> * event	The event, just happened.</span>
<span class="cm"> * arg		Generic pointer, casted from net_device * upon call.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_action_timeout</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">wch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">rch</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>
	<span class="n">wch</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_WRITE</span><span class="p">];</span>
	<span class="n">rch</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID2INITW</span>:
		<span class="cm">/* Unless there is outstanding IO on the  */</span>
		<span class="cm">/* channel just return and wait for ATTN  */</span>
		<span class="cm">/* interrupt to begin XID negotiations	  */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">rch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">==</span> <span class="n">CH_XID0_PENDING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">wch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">==</span> <span class="n">CH_XID0_PENDING</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_TRACE</span><span class="p">,</span> <span class="n">CTC_DBF_DEBUG</span><span class="p">,</span>
			<span class="s">&quot;%s: dev=%s exit&quot;</span><span class="p">,</span>
			<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MPC Group Station FSM action</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mpc_action_discontact</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpcg_info</span>   <span class="o">*</span><span class="n">mpcginfo</span>   <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span>	   <span class="o">*</span><span class="n">ch</span>	       <span class="o">=</span> <span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span>   <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span>   <span class="o">*</span><span class="n">grp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_TRACE</span><span class="p">,</span> <span class="n">CTC_DBF_NOTICE</span><span class="p">,</span>
					<span class="s">&quot;%s: %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">send_qllc_disc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_INOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MPC Group Station - not part of FSM</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> * called from add_channel in ctcm_main.c</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mpc_action_send_discontact</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">thischan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span>	<span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="p">)</span><span class="n">thischan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">saveflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_start</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ch</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctcm_ccw_check_rc</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * helper function of mpc FSM</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> * mpc_action_rcvd_xid7</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc_validate_xid</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpcg_info</span> <span class="o">*</span><span class="n">mpcginfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">channel</span>	   <span class="o">*</span><span class="n">ch</span>	 <span class="o">=</span> <span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span>   <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span>   <span class="o">*</span><span class="n">grp</span>  <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xid2</span>	   <span class="o">*</span><span class="n">xid</span>  <span class="o">=</span> <span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">rc</span>	 <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u64</span>	<span class="n">our_id</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u64</span>   <span class="n">their_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">len</span> <span class="o">=</span> <span class="n">TH_HEADER_LENGTH</span> <span class="o">+</span> <span class="n">PDU_HEADER_LENGTH</span><span class="p">;</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;Enter %s: xid=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">xid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* XID REJECTED: xid == NULL */</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): xid = NULL&quot;</span><span class="p">,</span>
				<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CTCM_D3_DUMP</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xid</span><span class="p">,</span> <span class="n">XID2_LENGTH</span><span class="p">);</span>

	<span class="cm">/*the received direction should be the opposite of ours  */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">CHANNEL_DIRECTION</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="n">CTCM_READ</span><span class="p">)</span> <span class="o">?</span> <span class="n">XID2_WRITE_SIDE</span> <span class="o">:</span>
				<span class="n">XID2_READ_SIDE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_dlc_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* XID REJECTED: r/w channel pairing mismatch */</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): r/w channel pairing mismatch&quot;</span><span class="p">,</span>
				<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_dlc_type</span> <span class="o">==</span> <span class="n">XID2_READ_SIDE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;%s: grpmaxbuf:%d xid2buflen:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">group_max_buflen</span><span class="p">,</span> <span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_buf_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">group_max_buflen</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">group_max_buflen</span> <span class="o">&gt;</span>
						<span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">)</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">group_max_buflen</span> <span class="o">=</span> <span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_buf_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_xid2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_xid2</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">xid2</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="p">,</span>
					<span class="n">XID2_LENGTH</span><span class="p">),</span> <span class="n">xid</span><span class="p">,</span> <span class="n">XID2_LENGTH</span><span class="p">);</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_data</span><span class="p">;</span>

		<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="p">);</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">rcvd_xid_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* convert two 32 bit numbers into 1 64 bit for id compare */</span>
		<span class="n">our_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_adj_id</span><span class="p">;</span>
		<span class="n">our_id</span> <span class="o">=</span> <span class="n">our_id</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">our_id</span> <span class="o">=</span> <span class="n">our_id</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_sender_id</span><span class="p">;</span>
		<span class="n">their_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_adj_id</span><span class="p">;</span>
		<span class="n">their_id</span> <span class="o">=</span> <span class="n">their_id</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">their_id</span> <span class="o">=</span> <span class="n">their_id</span> <span class="o">+</span> <span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_sender_id</span><span class="p">;</span>
		<span class="cm">/* lower id assume the xside role */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">our_id</span> <span class="o">&lt;</span> <span class="n">their_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">roll</span> <span class="o">=</span> <span class="n">XSIDE</span><span class="p">;</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_TRACE</span><span class="p">,</span> <span class="n">CTC_DBF_NOTICE</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): WE HAVE LOW ID - TAKE XSIDE&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">roll</span> <span class="o">=</span> <span class="n">YSIDE</span><span class="p">;</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_TRACE</span><span class="p">,</span> <span class="n">CTC_DBF_NOTICE</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): WE HAVE HIGH ID - TAKE YSIDE&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_flag4</span> <span class="o">!=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_xid2</span><span class="o">-&gt;</span><span class="n">xid2_flag4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="cm">/* XID REJECTED: xid flag byte4 mismatch */</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): xid flag byte4 mismatch&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_flag2</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="cm">/* XID REJECTED - xid NOGOOD */</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): xid NOGOOD&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_adj_id</span> <span class="o">!=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_xid2</span><span class="o">-&gt;</span><span class="n">xid2_adj_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="cm">/* XID REJECTED - Adjacent Station ID Mismatch */</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): Adjacent Station ID Mismatch&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_sender_id</span> <span class="o">!=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_xid2</span><span class="o">-&gt;</span><span class="n">xid2_sender_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="cm">/* XID REJECTED - Sender Address Mismatch */</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): Sender Address Mismatch&quot;</span><span class="p">,</span>
					<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The XID used in the MPC protocol is not valid, &quot;</span>
			<span class="s">&quot;rc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_flag2</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_xid2</span><span class="o">-&gt;</span><span class="n">xid2_flag2</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MPC Group Station FSM action</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_action_side_xid</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">side</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gotlock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saveflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* avoids compiler warning with</span>
<span class="cm">					   spin_unlock_irqrestore */</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;Enter %s: cp=%i ch=0x%p id=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctcm_checkalloc_buffer</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * skb data-buffer referencing:</span>
<span class="cm">	 */</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb_data</span><span class="p">;</span>
	<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb</span><span class="p">);</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* result of the previous 3 statements is NOT always</span>
<span class="cm">	 * already set after ctcm_checkalloc_buffer</span>
<span class="cm">	 * because of possible reuse of the trans_skb</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">rcvd_xid_th</span> <span class="o">=</span>  <span class="p">(</span><span class="k">struct</span> <span class="n">th_header</span> <span class="o">*</span><span class="p">)</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb_data</span><span class="p">;</span>
	<span class="cm">/* check is main purpose here: */</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">rcvd_xid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xid2</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb</span><span class="p">);</span>
	<span class="cm">/* check is main purpose here: */</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb</span><span class="p">,</span> <span class="n">XID2_LENGTH</span><span class="p">);</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">rcvd_xid_id</span> <span class="o">=</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb</span><span class="p">);</span>
	<span class="cm">/* cleanup back to startpoint */</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb_data</span><span class="p">;</span>
	<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb</span><span class="p">);</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">trans_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* non-checking rewrite of above skb data-buffer referencing: */</span>
	<span class="cm">/*</span>
<span class="cm">	memset(ch-&gt;trans_skb-&gt;data, 0, 16);</span>
<span class="cm">	ch-&gt;rcvd_xid_th =  (struct th_header *)ch-&gt;trans_skb_data;</span>
<span class="cm">	ch-&gt;rcvd_xid = (struct xid2 *)(ch-&gt;trans_skb_data + TH_HEADER_LENGTH);</span>
<span class="cm">	ch-&gt;rcvd_xid_id = ch-&gt;trans_skb_data + TH_HEADER_LENGTH + XID2_LENGTH;</span>
<span class="cm">	 */</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">count</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">cda</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_th</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_id</span><span class="p">))</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_TRACE</span><span class="p">,</span> <span class="n">CTC_DBF_INFO</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): xid_th=%p, xid=%p, xid_id=%p&quot;</span><span class="p">,</span>
			<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_th</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">side</span> <span class="o">==</span> <span class="n">XSIDE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mpc_action_xside_xid */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_th</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_WRITE</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">count</span>	<span class="o">=</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">cda</span>		<span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_th</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_WRITE</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">count</span>	<span class="o">=</span> <span class="n">XID2_LENGTH</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">cda</span>		<span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_READ</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">count</span>	<span class="o">=</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">cda</span>		<span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rcvd_xid_th</span><span class="p">);</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_READ</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">count</span>	<span class="o">=</span> <span class="n">XID2_LENGTH</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">cda</span>		<span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rcvd_xid</span><span class="p">);</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_READ</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">cda</span>		<span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rcvd_xid_id</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* side == YSIDE : mpc_action_yside_xid */</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_READ</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">count</span>	<span class="o">=</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">cda</span>		<span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rcvd_xid_th</span><span class="p">);</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_READ</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">count</span>	<span class="o">=</span> <span class="n">XID2_LENGTH</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">cda</span>		<span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">rcvd_xid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_th</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_WRITE</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">count</span>	<span class="o">=</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">cda</span>		<span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_th</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_WRITE</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">count</span>	<span class="o">=</span> <span class="n">XID2_LENGTH</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">cda</span>		<span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_id</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_WRITE</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">cda</span>		<span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_id</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">count</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_NOOP</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="n">count</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="n">cda</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CTCM_CCW_DUMP</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">CTCM_D3_DUMP</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_th</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>
	<span class="n">CTCM_D3_DUMP</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">XID2_LENGTH</span><span class="p">);</span>
	<span class="n">CTCM_D3_DUMP</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_id</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_irq</span><span class="p">())</span> <span class="p">{</span>
			 <span class="cm">/* Such conditional locking is a known problem for</span>
<span class="cm">			  * sparse because its static undeterministic.</span>
<span class="cm">			  * Warnings should be ignored here. */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>
		<span class="n">gotlock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fsm_addtimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="mi">5000</span> <span class="p">,</span> <span class="n">CTC_EVENT_TIMER</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_start</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ch</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gotlock</span><span class="p">)</span>	<span class="cm">/* see remark above about conditional locking */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctcm_ccw_check_rc</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span>
				<span class="p">(</span><span class="n">side</span> <span class="o">==</span> <span class="n">XSIDE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;x-side XID&quot;</span> <span class="o">:</span> <span class="s">&quot;y-side XID&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;Exit %s: ch=0x%p id=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MPC Group Station FSM action</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_action_xside_xid</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mpc_action_side_xid</span><span class="p">(</span><span class="n">fsm</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">XSIDE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MPC Group Station FSM action</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_action_yside_xid</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mpc_action_side_xid</span><span class="p">(</span><span class="n">fsm</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">YSIDE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MPC Group Station FSM action</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_action_doxid0</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">channel</span>	   <span class="o">*</span><span class="n">ch</span>   <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span>   <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span>   <span class="o">*</span><span class="n">grp</span>  <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;Enter %s: cp=%i ch=0x%p id=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
			<span class="s">&quot;%s(%s): ch-&gt;xid == NULL&quot;</span><span class="p">,</span>
				<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CH_XID0_INPROGRESS</span><span class="p">);</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">-&gt;</span><span class="n">xid2_option</span> <span class="o">=</span>	<span class="n">XID2_0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID2INITW</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID2INITX</span>:
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_SENSE_CMD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID0IOWAIT</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID0IOWAIX</span>:
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_WRITE_CTL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_DOIO</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MPC Group Station FSM action</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_action_doxid7</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span>  <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span>  <span class="o">*</span><span class="n">grp</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">send</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">)</span>
		<span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">direction</span> <span class="o">=</span> <span class="n">CTCM_READ</span><span class="p">;</span> <span class="n">direction</span> <span class="o">&lt;=</span> <span class="n">CTCM_WRITE</span><span class="p">;</span> <span class="n">direction</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">channel</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">direction</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">xid2</span> <span class="o">*</span><span class="n">thisxid</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb_data</span><span class="p">;</span>
		<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">thisxid</span><span class="o">-&gt;</span><span class="n">xid2_option</span> <span class="o">=</span> <span class="n">XID2_7</span><span class="p">;</span>
		<span class="n">send</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* xid7 phase 1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7_p2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">roll</span> <span class="o">==</span> <span class="n">YSIDE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">==</span> <span class="n">CH_XID7_PENDING1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CH_XID7_PENDING2</span><span class="p">);</span>
					<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_SENSE_CMD</span><span class="p">;</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">,</span>
							<span class="n">TH_HEADER_LENGTH</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="n">thdummy</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>
					<span class="n">send</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CH_XID7_PENDING2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CH_XID7_PENDING2</span><span class="p">);</span>
					<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_WRITE_CTL</span><span class="p">;</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">,</span>
						       <span class="n">TH_HEADER_LENGTH</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="n">thnorm</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>
					<span class="n">send</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* xid7 phase 2 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">roll</span> <span class="o">==</span> <span class="n">YSIDE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CH_XID7_PENDING4</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CH_XID7_PENDING4</span><span class="p">);</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">,</span>
						       <span class="n">TH_HEADER_LENGTH</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="n">thnorm</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>
					<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_WRITE_CTL</span><span class="p">;</span>
					<span class="n">send</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">==</span> <span class="n">CH_XID7_PENDING3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CH_XID7_PENDING4</span><span class="p">);</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_SENSE_CMD</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">thdummy</span><span class="p">,</span> <span class="n">TH_HEADER_LENGTH</span><span class="p">);</span>
				<span class="n">send</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">send</span><span class="p">)</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_DOIO</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MPC Group Station FSM action</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_action_rcvd_xid0</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">mpcg_info</span>   <span class="o">*</span><span class="n">mpcginfo</span>  <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span>	   <span class="o">*</span><span class="n">ch</span>   <span class="o">=</span> <span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span>   <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span>   <span class="o">*</span><span class="n">grp</span>  <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;%s: ch-id:%s xid2:%i xid7:%i xidt_p2:%i </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid2</span><span class="p">,</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7_p2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CH_XID7_PENDING</span><span class="p">)</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CH_XID7_PENDING</span><span class="p">);</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid2</span><span class="o">--</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7</span><span class="o">++</span><span class="p">;</span>
	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7_p2</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* must change state before validating xid to */</span>
	<span class="cm">/* properly handle interim interrupts received*/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID2INITW</span>:
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_XID2INITX</span><span class="p">);</span>
		<span class="n">mpc_validate_xid</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID0IOWAIT</span>:
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_XID0IOWAIX</span><span class="p">);</span>
		<span class="n">mpc_validate_xid</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID2INITX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_XID7INITW</span><span class="p">);</span>
			<span class="n">mpc_validate_xid</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_XID2DONE</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID0IOWAIX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_XID7INITI</span><span class="p">);</span>
			<span class="n">mpc_validate_xid</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_XID2DONE</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;ctcmpc:%s() %s xid2:%i xid7:%i xidt_p2:%i </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid2</span><span class="p">,</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7_p2</span><span class="p">);</span>
	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;ctcmpc:%s() %s grpstate: %s chanstate: %s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		<span class="n">fsm_getstate_str</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">),</span> <span class="n">fsm_getstate_str</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * MPC Group Station FSM action</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_action_rcvd_xid7</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fsm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpcg_info</span>   <span class="o">*</span><span class="n">mpcginfo</span>   <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel</span>	   <span class="o">*</span><span class="n">ch</span>	       <span class="o">=</span> <span class="n">mpcginfo</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span>        <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span>   <span class="o">*</span><span class="n">priv</span>    <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span>   <span class="o">*</span><span class="n">grp</span>     <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;Enter %s: cp=%i ch=0x%p id=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;%s: outstanding_xid7: %i, outstanding_xid7_p2: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7_p2</span><span class="p">);</span>

	<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb_data</span><span class="p">;</span>
	<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="p">);</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">xid_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITI</span>:
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_XID7INITZ</span><span class="p">);</span>
		<span class="n">mpc_validate_xid</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITW</span>:
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_XID7INITX</span><span class="p">);</span>
		<span class="n">mpc_validate_xid</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITZ</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7_p2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7</span> <span class="o">=</span>
					<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7_p2</span><span class="p">;</span>
				<span class="n">grp</span><span class="o">-&gt;</span><span class="n">outstanding_xid7_p2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_STATE_XID7INITF</span><span class="p">);</span>

			<span class="n">mpc_validate_xid</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
			<span class="n">fsm_event</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">MPCG_EVENT_XID7DONE</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mpc_validate_xid</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mpcginfo</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mpc_action helper of an MPC Group Station FSM action</span>
<span class="cm"> * CTCM_PROTO_MPC only</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc_send_qllc_discontact</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span>	<span class="n">new_len</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>   <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qllc</span>      <span class="o">*</span><span class="n">qllcptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctcm_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_group</span> <span class="o">*</span><span class="n">grp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpcg</span><span class="p">;</span>

	<span class="n">CTCM_PR_DEBUG</span><span class="p">(</span><span class="s">&quot;%s: GROUP STATE: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">mpcg_state_names</span><span class="p">[</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_state</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">saved_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * establish conn callback function is</span>
<span class="cm">	 * preferred method to report failure</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_XID0IOWAIT</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID0IOWAIX</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITI</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITZ</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID2INITW</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID2INITX</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITW</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_XID7INITX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">grp</span><span class="o">-&gt;</span><span class="n">estconnfunc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPCG_STATE_FLOWC</span>:
	<span class="k">case</span> <span class="n">MPCG_STATE_READY</span>:
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">send_qllc_disc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">new_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qllc</span><span class="p">);</span>
		<span class="n">qllcptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">new_len</span><span class="p">,</span> <span class="n">gfp_type</span><span class="p">()</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qllcptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): qllcptr allocation error&quot;</span><span class="p">,</span>
						<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">qllcptr</span><span class="o">-&gt;</span><span class="n">qllc_address</span> <span class="o">=</span> <span class="mh">0xcc</span><span class="p">;</span>
		<span class="n">qllcptr</span><span class="o">-&gt;</span><span class="n">qllc_commands</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">new_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): skb allocation error&quot;</span><span class="p">,</span>
						<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">qllcptr</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">new_len</span><span class="p">),</span> <span class="n">qllcptr</span><span class="p">,</span> <span class="n">new_len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qllcptr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CTCM_DBF_TEXT_</span><span class="p">(</span><span class="n">MPC_ERROR</span><span class="p">,</span> <span class="n">CTC_DBF_ERROR</span><span class="p">,</span>
				<span class="s">&quot;%s(%s): skb_headroom error&quot;</span><span class="p">,</span>
						<span class="n">CTCM_FUNTAIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pdu_seq</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pdu_seq</span><span class="o">++</span><span class="p">;</span>
		<span class="n">CTCM_PR_DBGDATA</span><span class="p">(</span><span class="s">&quot;ctcmpc: %s ToDCM_pdu_seq= %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pdu_seq</span><span class="p">);</span>

		<span class="cm">/* receipt of CC03 resets anticipated sequence number on</span>
<span class="cm">		      receiving side */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">CTCM_READ</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pdu_seq</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_SNAP</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>

		<span class="n">CTCM_D3_DUMP</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qllc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>

		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* --- This is the END my friend --- */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
