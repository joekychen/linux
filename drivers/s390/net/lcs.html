<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › net › lcs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lcs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Linux for S/390 Lan Channel Station Network Driver</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright IBM Corp. 1999, 2009</span>
<span class="cm"> *  Author(s): Original Code written by</span>
<span class="cm"> *			DJ Barrow &lt;djbarrow@de.ibm.com,barrow_dj@yahoo.com&gt;</span>
<span class="cm"> *	       Rewritten by</span>
<span class="cm"> *			Frank Pavlic &lt;fpavlic@de.ibm.com&gt; and</span>
<span class="cm"> *			Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT		&quot;lcs&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/fddidevice.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/igmp.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/arp.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>

<span class="cp">#include &lt;asm/debug.h&gt;</span>
<span class="cp">#include &lt;asm/idals.h&gt;</span>
<span class="cp">#include &lt;asm/timex.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;asm/ccwgroup.h&gt;</span>

<span class="cp">#include &quot;lcs.h&quot;</span>


<span class="cp">#if !defined(CONFIG_ETHERNET) &amp;&amp; !defined(CONFIG_FDDI)</span>
<span class="cp">#error Cannot compile lcs.c without some net devices switched on.</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * initialization string for output</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="s">&quot;LCS driver&quot;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm">  * the root device for lcs group devices</span>
<span class="cm">  */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">lcs_root_dev</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Some prototypes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">lcs_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">lcs_start_kernel_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">lcs_get_frames_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lcs_send_delipm</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_ipm_list</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IP_MULTICAST */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lcs_recovery</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Debug Facility Stuff</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">debug_buffer</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
<span class="k">static</span> <span class="n">debug_info_t</span> <span class="o">*</span><span class="n">lcs_dbf_setup</span><span class="p">;</span>
<span class="k">static</span> <span class="n">debug_info_t</span> <span class="o">*</span><span class="n">lcs_dbf_trace</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> *  LCS Debug Facility functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_unregister_debug_facility</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcs_dbf_setup</span><span class="p">)</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">lcs_dbf_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcs_dbf_trace</span><span class="p">)</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">lcs_dbf_trace</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_register_debug_facility</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lcs_dbf_setup</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="s">&quot;lcs_setup&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">lcs_dbf_trace</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="s">&quot;lcs_trace&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcs_dbf_setup</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">lcs_dbf_trace</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Not enough memory for debug facility.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lcs_unregister_debug_facility</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">lcs_dbf_setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">lcs_dbf_setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">lcs_dbf_trace</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">lcs_dbf_trace</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Allocate io buffers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_alloc_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;ichalloc&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">LCS_NUM_BUFFS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* alloc memory fo iobuffer */</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span>
			<span class="n">kzalloc</span><span class="p">(</span><span class="n">LCS_IOBUFFERSIZE</span><span class="p">,</span> <span class="n">GFP_DMA</span> <span class="o">|</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_BUF_STATE_EMPTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">LCS_NUM_BUFFS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Not all io buffers could be allocated. */</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;echalloc&quot;</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Free io buffers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_free_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;ichfree&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">LCS_NUM_BUFFS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cleanup channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_cleanup_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;cleanch&quot;</span><span class="p">);</span>
	<span class="cm">/* Kill write channel tasklets. */</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">);</span>
	<span class="cm">/* Free channel buffers. */</span>
	<span class="n">lcs_free_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * LCS free memory for card and channels.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_free_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;remcard&quot;</span><span class="p">);</span>
	<span class="n">LCS_DBF_HEX</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * LCS alloc memory for card and channels</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span>
<span class="nf">lcs_alloc_card</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;alloclcs&quot;</span><span class="p">);</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span><span class="p">),</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">LCS_FRAME_TYPE_AUTO</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">pkt_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lancmd_timeout</span> <span class="o">=</span> <span class="n">LCS_LANCMD_TIMEOUT_DEFAULT</span><span class="p">;</span>
	<span class="cm">/* Allocate io buffers for the read channel. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_alloc_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">){</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;iccwerr&quot;</span><span class="p">);</span>
		<span class="n">lcs_free_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Allocate io buffers for the write channel. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_alloc_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;iccwerr&quot;</span><span class="p">);</span>
		<span class="n">lcs_cleanup_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
		<span class="n">lcs_free_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_list</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">LCS_DBF_HEX</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">card</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup read channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_setup_read_ccws</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;ireadccw&quot;</span><span class="p">);</span>
	<span class="cm">/* Setup read ccws. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccws</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">LCS_NUM_BUFFS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">LCS_NUM_BUFFS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">LCS_CCW_READ</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">LCS_IOBUFFERSIZE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span>
			<span class="n">CCW_FLAG_CC</span> <span class="o">|</span> <span class="n">CCW_FLAG_SLI</span> <span class="o">|</span> <span class="n">CCW_FLAG_PCI</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Note: we have allocated the buffer with GFP_DMA, so</span>
<span class="cm">		 * we do not need to do set_normalized_cda.</span>
<span class="cm">		 */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">cda</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
		<span class="p">((</span><span class="k">struct</span> <span class="n">lcs_header</span> <span class="o">*</span><span class="p">)</span>
		 <span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">LCS_ILLEGAL_OFFSET</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">callback</span> <span class="o">=</span> <span class="n">lcs_get_frames_cb</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_BUF_STATE_READY</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">LCS_IOBUFFERSIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CCW_FLAG_PCI</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">LCS_NUM_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CCW_FLAG_PCI</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">LCS_NUM_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_SUSPEND</span><span class="p">;</span>
	<span class="cm">/* Last ccw is a tic (transfer in channel). */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">LCS_NUM_BUFFS</span><span class="p">].</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">LCS_CCW_TRANSFER</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">LCS_NUM_BUFFS</span><span class="p">].</span><span class="n">cda</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccws</span><span class="p">);</span>
	<span class="cm">/* Setg initial state of the read channel. */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_CH_STATE_INIT</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">io_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">buf_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_setup_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;initread&quot;</span><span class="p">);</span>

	<span class="n">lcs_setup_read_ccws</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="cm">/* Initialize read channel tasklet. */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">irq_tasklet</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">irq_tasklet</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">lcs_tasklet</span><span class="p">;</span>
	<span class="cm">/* Initialize waitqueue. */</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup write channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_setup_write_ccws</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;iwritccw&quot;</span><span class="p">);</span>
	<span class="cm">/* Setup write ccws. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccws</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">)</span> <span class="o">*</span> <span class="n">LCS_NUM_BUFFS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">LCS_NUM_BUFFS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">LCS_CCW_WRITE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span>
			<span class="n">CCW_FLAG_SUSPEND</span> <span class="o">|</span> <span class="n">CCW_FLAG_CC</span> <span class="o">|</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Note: we have allocated the buffer with GFP_DMA, so</span>
<span class="cm">		 * we do not need to do set_normalized_cda.</span>
<span class="cm">		 */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">cda</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Last ccw is a tic (transfer in channel). */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">LCS_NUM_BUFFS</span><span class="p">].</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">LCS_CCW_TRANSFER</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccws</span><span class="p">[</span><span class="n">LCS_NUM_BUFFS</span><span class="p">].</span><span class="n">cda</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccws</span><span class="p">);</span>
	<span class="cm">/* Set initial state of the write channel. */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_CH_STATE_INIT</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">io_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">buf_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_setup_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;initwrit&quot;</span><span class="p">);</span>

	<span class="n">lcs_setup_write_ccws</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="cm">/* Initialize write channel tasklet. */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">irq_tasklet</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">irq_tasklet</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">lcs_tasklet</span><span class="p">;</span>
	<span class="cm">/* Initialize waitqueue. */</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_set_allowed_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">threads</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_allowed_mask</span> <span class="o">=</span> <span class="n">threads</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">lcs_threads_running</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">threads</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_running_mask</span> <span class="o">&amp;</span> <span class="n">threads</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_wait_for_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">threads</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
                        <span class="n">lcs_threads_running</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">threads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">lcs_set_thread_start_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_allowed_mask</span> <span class="o">&amp;</span> <span class="kr">thread</span><span class="p">)</span> <span class="o">||</span>
              <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">&amp;</span> <span class="kr">thread</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">|=</span> <span class="kr">thread</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_clear_thread_running_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_running_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="kr">thread</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">__lcs_do_run_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">&amp;</span> <span class="kr">thread</span><span class="p">){</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_allowed_mask</span> <span class="o">&amp;</span> <span class="kr">thread</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_running_mask</span> <span class="o">&amp;</span> <span class="kr">thread</span><span class="p">)){</span>
                        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="kr">thread</span><span class="p">;</span>
                        <span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_running_mask</span> <span class="o">|=</span> <span class="kr">thread</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span>
                        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_do_run_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">wait_event</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
                   <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">__lcs_do_run_thread</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="kr">thread</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_do_start_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;  %02x%02x%02x&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_allowed_mask</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_running_mask</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">&amp;</span> <span class="kr">thread</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Initialize channels,card and state machines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_setup_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;initcard&quot;</span><span class="p">);</span>
	<span class="n">LCS_DBF_HEX</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">));</span>

	<span class="n">lcs_setup_read</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">lcs_setup_write</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="cm">/* Set cards initial state. */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_DOWN</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_emitted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mask_lock</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_list</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lancmd_waiters</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lcs_clear_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef	CONFIG_IP_MULTICAST</span>
	<span class="k">struct</span> <span class="n">lcs_ipm_list</span> <span class="o">*</span><span class="n">ipm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Free multicast list. */</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;clmclist&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_list</span><span class="p">)){</span>
		<span class="n">ipm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">lcs_ipm_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">ipm_state</span> <span class="o">!=</span> <span class="n">LCS_IPM_STATE_SET_REQUIRED</span><span class="p">){</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">lcs_send_delipm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipm</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ipm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * Cleanup channels,card and state machines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_cleanup_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;cleancrd&quot;</span><span class="p">);</span>
	<span class="n">LCS_DBF_HEX</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">setup</span><span class="p">,</span><span class="o">&amp;</span><span class="n">card</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Cleanup channels. */</span>
	<span class="n">lcs_cleanup_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="n">lcs_cleanup_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Start channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_start_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span><span class="s">&quot;ssch%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_start</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">,</span>
			      <span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccws</span> <span class="o">+</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="n">DOIO_DENY_PREFETCH</span> <span class="o">|</span> <span class="n">DOIO_ALLOW_SUSPEND</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_CH_STATE_RUNNING</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">trace</span><span class="p">,</span><span class="s">&quot;essh%s&quot;</span><span class="p">,</span>
			      <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Starting an LCS device resulted in an error,&quot;</span>
			<span class="s">&quot; rc=%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_clear_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">trace</span><span class="p">,</span><span class="s">&quot;clearch&quot;</span><span class="p">);</span>
	<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_clear</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">,</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;ecsc%s&quot;</span><span class="p">,</span>
			      <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LCS_CH_STATE_CLEARED</span><span class="p">));</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_CH_STATE_STOPPED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Stop channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_stop_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LCS_CH_STATE_STOPPED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">trace</span><span class="p">,</span><span class="s">&quot;haltsch&quot;</span><span class="p">);</span>
	<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_CH_STATE_INIT</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_halt</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">,</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;ehsc%s&quot;</span><span class="p">,</span>
			      <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Asynchronous halt initialted. Wait for its completion. */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LCS_CH_STATE_HALTED</span><span class="p">));</span>
	<span class="n">lcs_clear_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * start read and write channel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_start_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;chstart&quot;</span><span class="p">);</span>
	<span class="cm">/* start read channel */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_start_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* start write channel */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_start_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">lcs_stop_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * stop read and write channel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_stop_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;chhalt&quot;</span><span class="p">);</span>
	<span class="n">lcs_stop_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
	<span class="n">lcs_stop_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get empty buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span>
<span class="nf">__lcs_get_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;_getbuff&quot;</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_idx</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">LCS_BUF_STATE_EMPTY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_BUF_STATE_LOCKED</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LCS_NUM_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span>
<span class="nf">lcs_get_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;getbuff&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">__lcs_get_buffer</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Resume channel program if the channel is suspended.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__lcs_resume_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_CH_STATE_SUSPENDED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccws</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_idx</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CCW_FLAG_SUSPEND</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;rsch%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_resume</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;ersc%s&quot;</span><span class="p">,</span>
			      <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Sending data from the LCS device to the LAN failed&quot;</span>
			<span class="s">&quot; with rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_CH_STATE_RUNNING</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Make a buffer ready for processing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">__lcs_ready_buffer_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">prev</span><span class="p">,</span> <span class="n">next</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;rdybits&quot;</span><span class="p">);</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LCS_NUM_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LCS_NUM_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Check if we may clear the suspend bit of this buffer. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccws</span><span class="p">[</span><span class="n">next</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CCW_FLAG_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if we have to set the PCI bit. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccws</span><span class="p">[</span><span class="n">prev</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CCW_FLAG_SUSPEND</span><span class="p">))</span>
			<span class="cm">/* Suspend bit of the previous buffer is not set. */</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccws</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_PCI</span><span class="p">;</span>
		<span class="cm">/* Suspend bit of the next buffer is set. */</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccws</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CCW_FLAG_SUSPEND</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_ready_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;rdybuff&quot;</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_BUF_STATE_LOCKED</span> <span class="o">&amp;&amp;</span>
	       <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_BUF_STATE_PROCESSED</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_BUF_STATE_READY</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">-</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">;</span>
	<span class="cm">/* Set length. */</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccws</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="cm">/* Check relevant PCI/suspend bits. */</span>
	<span class="n">__lcs_ready_buffer_bits</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__lcs_resume_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Mark the buffer as processed. Take care of the suspend bit</span>
<span class="cm"> * of the previous buffer. This function is called from</span>
<span class="cm"> * interrupt context, so the lock must not be taken.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__lcs_processed_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">next</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;prcsbuff&quot;</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_BUF_STATE_READY</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_BUF_STATE_PROCESSED</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">-</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">;</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LCS_NUM_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LCS_NUM_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Set the suspend bit and clear the PCI bit of this buffer. */</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccws</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_SUSPEND</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccws</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CCW_FLAG_PCI</span><span class="p">;</span>
	<span class="cm">/* Check the suspend bit of the previous buffer. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">prev</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">LCS_BUF_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Previous buffer is in state ready. It might have</span>
<span class="cm">		 * happened in lcs_ready_buffer that the suspend bit</span>
<span class="cm">		 * has not been cleared to avoid an endless loop.</span>
<span class="cm">		 * Do it now.</span>
<span class="cm">		 */</span>
		<span class="n">__lcs_ready_buffer_bits</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Clear PCI bit of next buffer. */</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccws</span><span class="p">[</span><span class="n">next</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CCW_FLAG_PCI</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__lcs_resume_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Put a processed buffer back to state empty.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_release_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;relbuff&quot;</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_BUF_STATE_LOCKED</span> <span class="o">&amp;&amp;</span>
	       <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_BUF_STATE_PROCESSED</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_BUF_STATE_EMPTY</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get buffer for a lan command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span>
<span class="nf">lcs_get_lancmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;getlncmd&quot;</span><span class="p">);</span>
	<span class="cm">/* Get buffer and wait if none is available. */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">wait_q</span><span class="p">,</span>
		   <span class="p">((</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">lcs_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>
	<span class="n">count</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_header</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u16</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">lcs_release_buffer</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">LCS_FRAME_TYPE_CONTROL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_get_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_put_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">WARN_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lcs_reply</span> <span class="o">*</span>
<span class="nf">lcs_alloc_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;getreply&quot;</span><span class="p">);</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_reply</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">sequence_no</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sequence_no</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">reply</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Notifier function for lancmd replies. Called from read irq.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_notify_lancmd_waiters</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;notiwait&quot;</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lancmd_waiters</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reply</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_reply</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">sequence_no</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sequence_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lcs_get_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">reply</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="n">reply</span><span class="o">-&gt;</span><span class="n">received</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">reply</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">return_code</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
			<span class="n">lcs_put_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Emit buffer of a lan command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_lancmd_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="o">*</span><span class="n">list_reply</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;timeout&quot;</span><span class="p">);</span>
	<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_reply</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">list_reply</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lancmd_waiters</span><span class="p">,</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reply</span> <span class="o">==</span> <span class="n">list_reply</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lcs_get_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">reply</span><span class="o">-&gt;</span><span class="n">received</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">reply</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
			<span class="n">lcs_put_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_send_lancmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">reply_callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;sendcmd&quot;</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">return_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sequence_no</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sequence_no</span><span class="o">++</span><span class="p">;</span>
	<span class="n">reply</span> <span class="o">=</span> <span class="n">lcs_alloc_reply</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">reply_callback</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lancmd_waiters</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">lcs_release_buffer</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_ready_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">init_timer_on_stack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">lcs_lancmd_timeout</span><span class="p">;</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">reply</span><span class="p">;</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">*</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lancmd_timeout</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">received</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;rc:%d&quot;</span><span class="p">,</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>
	<span class="n">lcs_put_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * LCS startup command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_send_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">initiator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;startup&quot;</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">lcs_get_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_STD_CMD_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">LCS_CMD_STARTUP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">initiator</span> <span class="o">=</span> <span class="n">initiator</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_startup</span><span class="p">.</span><span class="n">buff_size</span> <span class="o">=</span> <span class="n">LCS_IOBUFFERSIZE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lcs_send_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * LCS shutdown command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_send_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;shutdown&quot;</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">lcs_get_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_STD_CMD_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">LCS_CMD_SHUTDOWN</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">initiator</span> <span class="o">=</span> <span class="n">LCS_INITIATOR_TCPIP</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lcs_send_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * LCS lanstat command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__lcs_lanstat_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;statcb&quot;</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_lanstat_cmd</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">LCS_MAC_LENGTH</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_send_lanstat</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">trace</span><span class="p">,</span> <span class="s">&quot;cmdstat&quot;</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">lcs_get_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_STD_CMD_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="cm">/* Setup lanstat command. */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">LCS_CMD_LANSTAT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">initiator</span> <span class="o">=</span> <span class="n">LCS_INITIATOR_TCPIP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_std_cmd</span><span class="p">.</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_std_cmd</span><span class="p">.</span><span class="n">portno</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">portno</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lcs_send_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">__lcs_lanstat_cb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * send stoplan command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_send_stoplan</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">initiator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;cmdstpln&quot;</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">lcs_get_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_STD_CMD_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">LCS_CMD_STOPLAN</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">initiator</span> <span class="o">=</span> <span class="n">initiator</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_std_cmd</span><span class="p">.</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_std_cmd</span><span class="p">.</span><span class="n">portno</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">portno</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lcs_send_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * send startlan command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__lcs_send_startlan_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;srtlancb&quot;</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_std_cmd</span><span class="p">.</span><span class="n">lan_type</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">portno</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_std_cmd</span><span class="p">.</span><span class="n">portno</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_send_startlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">initiator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;cmdstaln&quot;</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">lcs_get_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_STD_CMD_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">LCS_CMD_STARTLAN</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">initiator</span> <span class="o">=</span> <span class="n">initiator</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_std_cmd</span><span class="p">.</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_std_cmd</span><span class="p">.</span><span class="n">portno</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">portno</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lcs_send_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">__lcs_send_startlan_cb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
<span class="cm">/**</span>
<span class="cm"> * send setipm command (Multicast)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_send_setipm</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span><span class="k">struct</span> <span class="n">lcs_ipm_list</span> <span class="o">*</span><span class="n">ipm_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;cmdsetim&quot;</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">lcs_get_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_MULTICAST_CMD_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">LCS_CMD_SETIPM</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">initiator</span> <span class="o">=</span> <span class="n">LCS_INITIATOR_TCPIP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">portno</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">portno</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">num_ip_pairs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">lcs_ipass_ctlmsg</span><span class="p">.</span><span class="n">ip_mac_pair</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">ipm_list</span><span class="o">-&gt;</span><span class="n">ipm</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_ip_mac_pair</span><span class="p">));</span>
	<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span><span class="n">ipm_list</span><span class="o">-&gt;</span><span class="n">ipm</span><span class="p">.</span><span class="n">ip_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lcs_send_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * send delipm command (Multicast)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_send_delipm</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span><span class="k">struct</span> <span class="n">lcs_ipm_list</span> <span class="o">*</span><span class="n">ipm_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;cmddelim&quot;</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">lcs_get_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_MULTICAST_CMD_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">LCS_CMD_DELIPM</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">initiator</span> <span class="o">=</span> <span class="n">LCS_INITIATOR_TCPIP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">portno</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">portno</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">num_ip_pairs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">lcs_ipass_ctlmsg</span><span class="p">.</span><span class="n">ip_mac_pair</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">ipm_list</span><span class="o">-&gt;</span><span class="n">ipm</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_ip_mac_pair</span><span class="p">));</span>
	<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span><span class="n">ipm_list</span><span class="o">-&gt;</span><span class="n">ipm</span><span class="p">.</span><span class="n">ip_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lcs_send_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * check if multicast is supported by LCS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__lcs_check_multicast_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;chkmccb&quot;</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_assists_supported</span> <span class="o">=</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">ip_assists_supported</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_assists_enabled</span> <span class="o">=</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">ip_assists_enabled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_check_multicast_support</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;cmdqipa&quot;</span><span class="p">);</span>
	<span class="cm">/* Send query ipassist. */</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">lcs_get_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_STD_CMD_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">LCS_CMD_QIPASSIST</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">initiator</span> <span class="o">=</span> <span class="n">LCS_INITIATOR_TCPIP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">portno</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">portno</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lcs_qipassist</span><span class="p">.</span><span class="n">num_ip_pairs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_send_lancmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">__lcs_check_multicast_cb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Query IPAssist failed. Assuming unsupported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_assists_supported</span> <span class="o">&amp;</span> <span class="n">LCS_IPASS_MULTICAST_SUPPORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * set or del multicast address on LCS card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_fix_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">failed_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_ipm_list</span> <span class="o">*</span><span class="n">ipm</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">trace</span><span class="p">,</span> <span class="s">&quot;fixipm&quot;</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">failed_list</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">list_modified:</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ipm</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_list</span><span class="p">,</span> <span class="n">list</span><span class="p">){</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">ipm_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LCS_IPM_STATE_SET_REQUIRED</span>:
			<span class="cm">/* del from ipm_list so no one else can tamper with</span>
<span class="cm">			 * this entry */</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_send_setipm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipm</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Adding multicast address failed.&quot;</span>
					<span class="s">&quot; Table possibly full!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="cm">/* store ipm in failed list -&gt; will be added</span>
<span class="cm">				 * to ipm_list again, so a retry will be done</span>
<span class="cm">				 * during the next call of this function */</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">failed_list</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ipm</span><span class="o">-&gt;</span><span class="n">ipm_state</span> <span class="o">=</span> <span class="n">LCS_IPM_STATE_ON_CARD</span><span class="p">;</span>
				<span class="cm">/* re-insert into ipm_list */</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_list</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">list_modified</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LCS_IPM_STATE_DEL_REQUIRED</span>:
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">lcs_send_delipm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ipm</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ipm</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">list_modified</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LCS_IPM_STATE_ON_CARD</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* re-insert all entries from the failed_list into ipm_list */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ipm</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">failed_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_list</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * get mac address for the relevant Multicast address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_get_mac_for_ipm</span><span class="p">(</span><span class="n">__be32</span> <span class="n">ipm</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">trace</span><span class="p">,</span> <span class="s">&quot;getmac&quot;</span><span class="p">);</span>
	<span class="n">ip_eth_mc_map</span><span class="p">(</span><span class="n">ipm</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * function called by net device to handle multicast address relevant things</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lcs_remove_mc_addresses</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in4_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_ipm_list</span> <span class="o">*</span><span class="n">ipm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;remmclst&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_ipm_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">im4</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">in4_dev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">);</span>
		     <span class="n">im4</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">im4</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">im4</span><span class="o">-&gt;</span><span class="n">next_rcu</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lcs_get_mac_for_ipm</span><span class="p">(</span><span class="n">im4</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">ipm</span><span class="p">.</span><span class="n">ip_addr</span> <span class="o">==</span> <span class="n">im4</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">ipm</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span>
				     <span class="n">LCS_MAC_LENGTH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">im4</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">ipm</span><span class="o">-&gt;</span><span class="n">ipm_state</span> <span class="o">=</span> <span class="n">LCS_IPM_STATE_DEL_REQUIRED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">lcs_ipm_list</span> <span class="o">*</span>
<span class="nf">lcs_check_addr_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im4</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_ipm_list</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">ipm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;chkmcent&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_ipm_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ipm</span><span class="p">.</span><span class="n">ip_addr</span> <span class="o">==</span> <span class="n">im4</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ipm</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span>
			     <span class="n">LCS_MAC_LENGTH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">ipm</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ipm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lcs_set_mc_addresses</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in4_dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ip_mc_list</span> <span class="o">*</span><span class="n">im4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_ipm_list</span> <span class="o">*</span><span class="n">ipm</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;setmclst&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">im4</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">in4_dev</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">);</span> <span class="n">im4</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">im4</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">im4</span><span class="o">-&gt;</span><span class="n">next_rcu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lcs_get_mac_for_ipm</span><span class="p">(</span><span class="n">im4</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ipm</span> <span class="o">=</span> <span class="n">lcs_check_addr_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">im4</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipm</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* Address already in list. */</span>
		<span class="n">ipm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_ipm_list</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Not enough memory to add&quot;</span>
				<span class="s">&quot; new multicast entry!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">ipm</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">LCS_MAC_LENGTH</span><span class="p">);</span>
		<span class="n">ipm</span><span class="o">-&gt;</span><span class="n">ipm</span><span class="p">.</span><span class="n">ip_addr</span> <span class="o">=</span> <span class="n">im4</span><span class="o">-&gt;</span><span class="n">multiaddr</span><span class="p">;</span>
		<span class="n">ipm</span><span class="o">-&gt;</span><span class="n">ipm_state</span> <span class="o">=</span> <span class="n">LCS_IPM_STATE_SET_REQUIRED</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">LCS_DBF_HEX</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">trace</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">ipm</span><span class="p">.</span><span class="n">ip_addr</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipm</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_register_mc_addresses</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in4_dev</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lcs_do_run_thread</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_SET_MC_THREAD</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;regmulti&quot;</span><span class="p">);</span>

	<span class="n">in4_dev</span> <span class="o">=</span> <span class="n">in_dev_get</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in4_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">lcs_remove_mc_addresses</span><span class="p">(</span><span class="n">card</span><span class="p">,</span><span class="n">in4_dev</span><span class="p">);</span>
	<span class="n">lcs_set_mc_addresses</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">in4_dev</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">in_dev_put</span><span class="p">(</span><span class="n">in4_dev</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">wait_q</span><span class="p">,</span>
			<span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_CH_STATE_RUNNING</span><span class="p">));</span>
	<span class="n">lcs_fix_multicast_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DEV_STATE_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">lcs_clear_thread_running_bit</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_SET_MC_THREAD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IP_MULTICAST */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * function called by net device to</span>
<span class="cm"> * handle multicast address relevant things</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
        <span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

        <span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;setmulti&quot;</span><span class="p">);</span>
        <span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lcs_set_thread_start_bit</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_SET_MC_THREAD</span><span class="p">))</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">kernel_thread_starter</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IP_MULTICAST */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">lcs_check_irb_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">irb</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">irb</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;An I/O-error occurred on the LCS device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;ckirberr&quot;</span><span class="p">);</span>
		<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;  rc%d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIMEDOUT</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;A command timed out on the LCS device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;ckirberr&quot;</span><span class="p">);</span>
		<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;  rc%d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;An error occurred on the LCS device, rc=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">irb</span><span class="p">));</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;ckirberr&quot;</span><span class="p">);</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;  rc???&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">irb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_get_problem</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dstat</span><span class="p">,</span> <span class="n">cstat</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">;</span>
	<span class="n">cstat</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span><span class="p">;</span>
	<span class="n">dstat</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCHN_STAT_CHN_CTRL_CHK</span> <span class="o">|</span> <span class="n">SCHN_STAT_INTF_CTRL_CHK</span> <span class="o">|</span>
		     <span class="n">SCHN_STAT_CHN_DATA_CHK</span> <span class="o">|</span> <span class="n">SCHN_STAT_CHAIN_CHECK</span> <span class="o">|</span>
		     <span class="n">SCHN_STAT_PROT_CHECK</span>   <span class="o">|</span> <span class="n">SCHN_STAT_PROG_CHECK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;CGENCHK&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="n">LCS_SENSE_BYTE_1</span><span class="p">]</span> <span class="o">&amp;</span>
		    <span class="n">LCS_SENSE_RESETTING_EVENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;REVIND&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="n">LCS_SENSE_BYTE_0</span><span class="p">]</span> <span class="o">&amp;</span>
		    <span class="n">LCS_SENSE_CMD_REJECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;CMDREJ&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">sense</span><span class="p">[</span><span class="n">LCS_SENSE_BYTE_0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">sense</span><span class="p">[</span><span class="n">LCS_SENSE_BYTE_1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">sense</span><span class="p">[</span><span class="n">LCS_SENSE_BYTE_2</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">sense</span><span class="p">[</span><span class="n">LCS_SENSE_BYTE_3</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;ZEROSEN&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;DGENCHK&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_schedule_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;startrec&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lcs_set_thread_start_bit</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_RECOVERY_THREAD</span><span class="p">))</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">kernel_thread_starter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IRQ Handler for LCS channels</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">intparm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cstat</span><span class="p">,</span> <span class="n">dstat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcs_check_irb_error</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">CARD_FROM_DEV</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccwdev</span> <span class="o">==</span> <span class="n">cdev</span><span class="p">)</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>

	<span class="n">cstat</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span><span class="p">;</span>
	<span class="n">dstat</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span><span class="p">;</span>
	<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;Rint%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;%4x%4x&quot;</span><span class="p">,</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span><span class="p">,</span>
		      <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span><span class="p">);</span>
	<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;%4x%4x&quot;</span><span class="p">,</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">fctl</span><span class="p">,</span>
		      <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span><span class="p">);</span>

	<span class="cm">/* Check for channel and device errors presented */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_get_problem</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="p">(</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_EXCEP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The LCS device stopped because of an error,&quot;</span>
			<span class="s">&quot; dstat=0x%X, cstat=0x%X </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">dstat</span><span class="p">,</span> <span class="n">cstat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_CH_STATE_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LCS_CH_STATE_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lcs_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* How far in the ccw chain have we processed? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_CH_STATE_INIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">fctl</span> <span class="o">&amp;</span> <span class="n">SCSW_FCTL_START_FUNC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="p">)</span> <span class="n">__va</span><span class="p">((</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span><span class="p">)</span>
			<span class="o">-</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccws</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span> <span class="o">&amp;</span> <span class="n">SCSW_ACTL_SUSPENDED</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span> <span class="o">&amp;</span> <span class="n">SCHN_STAT_PCI</span><span class="p">))</span>
			<span class="cm">/* Bloody io subsystem tells us lies about cpa... */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LCS_NUM_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_idx</span> <span class="o">!=</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__lcs_processed_buffer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span>
					       <span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span> <span class="o">+</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_idx</span><span class="p">);</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_idx</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LCS_NUM_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_DEV_END</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_CHN_END</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">))</span>
		<span class="cm">/* Mark channel as stopped. */</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_CH_STATE_STOPPED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span> <span class="o">&amp;</span> <span class="n">SCSW_ACTL_SUSPENDED</span><span class="p">)</span>
		<span class="cm">/* CCW execution stopped on a suspend bit. */</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_CH_STATE_SUSPENDED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">fctl</span> <span class="o">&amp;</span> <span class="n">SCSW_FCTL_HALT_FUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccw_device_halt</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">,</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* The channel has been stopped by halt_IO. */</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_CH_STATE_HALTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">fctl</span> <span class="o">&amp;</span> <span class="n">SCSW_FCTL_CLEAR_FUNC</span><span class="p">)</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_CH_STATE_CLEARED</span><span class="p">;</span>
	<span class="cm">/* Do the rest in the tasklet. */</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Tasklet for IRQ handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_idx</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;tlet%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="cm">/* Check for processed buffers. */</span>
	<span class="n">iob</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">;</span>
	<span class="n">buf_idx</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">buf_idx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">iob</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">LCS_BUF_STATE_PROCESSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Do the callback thing. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iob</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">callback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">iob</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">callback</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">iob</span> <span class="o">+</span> <span class="n">buf_idx</span><span class="p">);</span>
		<span class="n">buf_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LCS_NUM_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buf_idx</span> <span class="o">=</span> <span class="n">buf_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LCS_CH_STATE_STOPPED</span><span class="p">)</span>
		<span class="n">lcs_start_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LCS_CH_STATE_SUSPENDED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_idx</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">LCS_BUF_STATE_READY</span><span class="p">)</span>
		<span class="n">__lcs_resume_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Something happened on the channel. Wake up waiters. */</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Finish current tx buffer and make it ready for transmit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__lcs_emit_txbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;emittx&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">lcs_ready_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_emitted</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Callback for finished tx buffers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_txbuffer_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;txbuffcb&quot;</span><span class="p">);</span>
	<span class="cm">/* Put buffer back to pool. */</span>
	<span class="n">lcs_release_buffer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_card</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_emitted</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_emitted</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Last running tx buffer has finished. Submit partially</span>
<span class="cm">		 * filled current buffer.</span>
<span class="cm">		 */</span>
		<span class="n">__lcs_emit_txbuffer</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Packet transmit function called by network stack</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__lcs_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_header</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;hardxmit&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DEV_STATE_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_header</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">LCS_IOBUFFERSIZE</span><span class="p">)</span>
		<span class="cm">/* skb too big for current tx buffer. */</span>
		<span class="n">__lcs_emit_txbuffer</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get new tx buffer */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span> <span class="o">=</span> <span class="n">lcs_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">lcs_txbuffer_cb</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_header</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_header</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">portno</span><span class="p">;</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">header</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_emitted</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="cm">/* If this is the first tx buffer emit it immediately. */</span>
		<span class="n">__lcs_emit_txbuffer</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;pktxmit&quot;</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__lcs_start_xmit</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * send startlan and lanstat command to make LCS device ready</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_startlan_auto</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;strtauto&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ETHERNET</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">LCS_FRAME_TYPE_ENET</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_send_startlan</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_INITIATOR_TCPIP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FDDI</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">LCS_FRAME_TYPE_FDDI</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_send_startlan</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_INITIATOR_TCPIP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_startlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;startlan&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">portno</span> <span class="o">!=</span> <span class="n">LCS_INVALID_PORT_NO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">LCS_FRAME_TYPE_AUTO</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_startlan_auto</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_send_startlan</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_INITIATOR_TCPIP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">card</span><span class="o">-&gt;</span><span class="n">portno</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">!=</span> <span class="n">LCS_FRAME_TYPE_AUTO</span><span class="p">)</span>
                                <span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_send_startlan</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
                                                       <span class="n">LCS_INITIATOR_TCPIP</span><span class="p">);</span>
                        <span class="k">else</span>
                                <span class="cm">/* autodetecting lan type */</span>
                                <span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_startlan_auto</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">lcs_send_lanstat</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * LCS detect function</span>
<span class="cm"> * setup channels and make them I/O ready</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;lcsdetct&quot;</span><span class="p">);</span>
	<span class="cm">/* start/reset card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_stop_channels</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_start_channels</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_send_startup</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_INITIATOR_TCPIP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_startlan</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_UP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_DOWN</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LCS_CH_STATE_INIT</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span>  <span class="n">LCS_CH_STATE_INIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * LCS Stop card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_stopcard</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;stopcard&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_CH_STATE_STOPPED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_CH_STATE_STOPPED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_CH_STATE_ERROR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_CH_STATE_ERROR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DEV_STATE_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lcs_clear_multicast_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_send_stoplan</span><span class="p">(</span><span class="n">card</span><span class="p">,</span><span class="n">LCS_INITIATOR_TCPIP</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_send_shutdown</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_stop_channels</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_DOWN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Kernel Thread helper functions for LGW initiated commands</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_start_kernel_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_card</span><span class="p">,</span> <span class="n">kernel_thread_starter</span><span class="p">);</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;krnthrd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcs_do_start_thread</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_RECOVERY_THREAD</span><span class="p">))</span>
		<span class="n">kthread_run</span><span class="p">(</span><span class="n">lcs_recovery</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="s">&quot;lcs_recover&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcs_do_start_thread</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_SET_MC_THREAD</span><span class="p">))</span>
		<span class="n">kthread_run</span><span class="p">(</span><span class="n">lcs_register_mc_addresses</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="s">&quot;regipm&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Process control frames.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_get_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;getctrl&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">initiator</span> <span class="o">==</span> <span class="n">LCS_INITIATOR_LGW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LCS_CMD_STARTUP</span>:
		<span class="k">case</span> <span class="n">LCS_CMD_STARTLAN</span>:
			<span class="n">lcs_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LCS_CMD_STOPLAN</span>:
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Stoplan for %s initiated by LGW.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
				<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;noLGWcmd&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">lcs_notify_lancmd_waiters</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Unpack network packet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_get_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">skb_data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skb_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;getskb&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DEV_STATE_UP</span><span class="p">)</span>
		<span class="cm">/* The card isn&#39;t up. Ignore the packet. */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">skb_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot; Allocating a socket buffer to interface %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_len</span><span class="p">),</span> <span class="n">skb_data</span><span class="p">,</span> <span class="n">skb_len</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span>	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb_len</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">))</span>
		<span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span> <span class="o">=</span> <span class="o">++</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pkt_seq</span><span class="p">;</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * LCS main routine to get packets and lancmd replies from the buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_get_frames_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcs_header</span> <span class="o">*</span><span class="n">lcs_hdr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;lcsgtpkt&quot;</span><span class="p">);</span>
	<span class="n">lcs_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcs_hdr</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="n">LCS_ILLEGAL_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;-eiogpkt&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lcs_card</span><span class="p">,</span> <span class="n">read</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lcs_hdr</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lcs_hdr</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">lcs_hdr</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">LCS_IOBUFFERSIZE</span> <span class="o">||</span>
		    <span class="n">lcs_hdr</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Offset invalid. */</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* What kind of frame is it? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lcs_hdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LCS_FRAME_TYPE_CONTROL</span><span class="p">)</span>
			<span class="cm">/* Control frame. */</span>
			<span class="n">lcs_get_control</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">lcs_hdr</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lcs_hdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LCS_FRAME_TYPE_ENET</span> <span class="o">||</span>
			 <span class="n">lcs_hdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LCS_FRAME_TYPE_TR</span> <span class="o">||</span>
			 <span class="n">lcs_hdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LCS_FRAME_TYPE_FDDI</span><span class="p">)</span>
			<span class="cm">/* Normal network packet. */</span>
			<span class="n">lcs_get_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">lcs_hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				    <span class="n">lcs_hdr</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">-</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_header</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="cm">/* Unknown frame type. */</span>
			<span class="p">;</span> <span class="c1">// FIXME: error message ?</span>
		<span class="cm">/* Proceed to next frame. */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">lcs_hdr</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">lcs_hdr</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">LCS_ILLEGAL_OFFSET</span><span class="p">;</span>
		<span class="n">lcs_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_header</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* The buffer is now empty. Make it ready again. */</span>
	<span class="n">lcs_ready_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * get network statistics for ifconfig and other user programs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span>
<span class="nf">lcs_getstats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;netstats&quot;</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * stop lcs device</span>
<span class="cm"> * This function will be called by user doing ifconfig xxx down</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_stop_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;stopdev&quot;</span><span class="p">);</span>
	<span class="n">card</span>   <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFF_UP</span><span class="p">;</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">wait_q</span><span class="p">,</span>
		<span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LCS_CH_STATE_RUNNING</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_stopcard</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot; Shutting down the LCS device failed</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * start lcs device and make it runnable</span>
<span class="cm"> * This function will be called by user doing ifconfig xxx up</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_open_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;opendev&quot;</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="cm">/* initialize statistics */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_detect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error in opening device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_UP</span><span class="p">;</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_UP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * show function for portno called by cat or similar things</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lcs_portno_show</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">portno</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * store the value which is piped to file portno</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lcs_portno_store</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
        <span class="cm">/* TODO: sanity checks */</span>
        <span class="n">card</span><span class="o">-&gt;</span><span class="n">portno</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">portno</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">lcs_portno_show</span><span class="p">,</span> <span class="n">lcs_portno_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lcs_type</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;not a channel&quot;</span><span class="p">,</span>
	<span class="s">&quot;2216 parallel&quot;</span><span class="p">,</span>
	<span class="s">&quot;2216 channel&quot;</span><span class="p">,</span>
	<span class="s">&quot;OSA LCS card&quot;</span><span class="p">,</span>
	<span class="s">&quot;unknown channel type&quot;</span><span class="p">,</span>
	<span class="s">&quot;unsupported channel type&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lcs_type_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">cgdev</span><span class="p">;</span>

	<span class="n">cgdev</span> <span class="o">=</span> <span class="n">to_ccwgroupdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cgdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lcs_type</span><span class="p">[</span><span class="n">cgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">driver_info</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">lcs_type_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lcs_timeout_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">card</span> <span class="o">?</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lancmd_timeout</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lcs_timeout_store</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
        <span class="cm">/* TODO: sanity checks */</span>
        <span class="n">card</span><span class="o">-&gt;</span><span class="n">lancmd_timeout</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lancmd_timeout</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">lcs_timeout_show</span><span class="p">,</span> <span class="n">lcs_timeout_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lcs_dev_recover_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DEV_STATE_UP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">lcs_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">recover</span><span class="p">,</span> <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">lcs_dev_recover_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span> <span class="n">lcs_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_portno</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_type</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lancmd_timeout</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_recover</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lcs_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lcs_attrs</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">lcs_attr_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">lcs_attr_group</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">device_type</span> <span class="n">lcs_devtype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lcs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">lcs_attr_groups</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * lcs_probe_device is called on establishing a new ccwgroup_device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_probe_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">ccwgdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;add_dev&quot;</span><span class="p">);</span>
        <span class="n">card</span> <span class="o">=</span> <span class="n">lcs_alloc_card</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;  rc%d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">lcs_irq</span><span class="p">;</span>
	<span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">lcs_irq</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span> <span class="o">=</span> <span class="n">ccwgdev</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">kernel_thread_starter</span><span class="p">,</span> <span class="n">lcs_start_kernel_thread</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_allowed_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_running_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lcs_devtype</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_register_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">ccwgdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;regnetdv&quot;</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_state</span> <span class="o">!=</span> <span class="n">NETREG_UNINITIALIZED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lcs_new_device will be called by setting the group device online.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">lcs_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">lcs_open_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">lcs_stop_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">lcs_getstats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">lcs_start_xmit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">lcs_mc_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">lcs_open_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">lcs_stop_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">lcs_getstats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">lcs_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">lcs_set_multicast_list</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_new_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">ccwgdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>  <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">lcs_dev_states</span> <span class="n">recover_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;newdev&quot;</span><span class="p">);</span>
	<span class="n">LCS_DBF_HEX</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">));</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccwdev</span>  <span class="o">=</span> <span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span> <span class="o">=</span> <span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">recover_state</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_set_online</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_set_online</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_werr</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;lcsnewdv&quot;</span><span class="p">);</span>

	<span class="n">lcs_setup_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_detect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;dtctfail&quot;</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Detecting a network adapter for LCS devices&quot;</span>
			<span class="s">&quot; failed with rc=%d (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">lcs_stopcard</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;samedev&quot;</span><span class="p">);</span>
		<span class="n">LCS_DBF_HEX</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">netdev_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ETHERNET</span>
	<span class="k">case</span> <span class="n">LCS_FRAME_TYPE_ENET</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type_trans</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FDDI</span>
	<span class="k">case</span> <span class="n">LCS_FRAME_TYPE_FDDI</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_type_trans</span> <span class="o">=</span> <span class="n">fddi_type_trans</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_fddidev</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;errinit&quot;</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; Initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lcs_netdev_ops</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">LCS_MAC_LENGTH</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IP_MULTICAST</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lcs_check_multicast_support</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lcs_mc_netdev_ops</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="nl">netdev_out:</span>
	<span class="n">lcs_set_allowed_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span><span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recover_state</span> <span class="o">==</span> <span class="n">DEV_STATE_RECOVER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lcs_set_multicast_list</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_UP</span><span class="p">;</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_UP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lcs_stopcard</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcs_register_netdev</span><span class="p">(</span><span class="n">ccwgdev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Print out supported assists: IPv6 */</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;LCS device %s %s IPv6 support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_assists_supported</span> <span class="o">&amp;</span> <span class="n">LCS_IPASS_IPV6_SUPPORT</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;with&quot;</span> <span class="o">:</span> <span class="s">&quot;without&quot;</span><span class="p">);</span>
	<span class="cm">/* Print out supported assist: Multicast */</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;LCS device %s %s Multicast support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_assists_supported</span> <span class="o">&amp;</span> <span class="n">LCS_IPASS_MULTICAST_SUPPORT</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;with&quot;</span> <span class="o">:</span> <span class="s">&quot;without&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>

	<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">);</span>
<span class="nl">out_werr:</span>
	<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lcs_shutdown_device, called when setting the group device offline.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__lcs_shutdown_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">ccwgdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">recovery_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">lcs_dev_states</span> <span class="n">recover_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;shtdndev&quot;</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recovery_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lcs_set_allowed_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lcs_wait_for_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_SET_MC_THREAD</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">LCS_DBF_HEX</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">));</span>
	<span class="n">recover_state</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lcs_stop_device</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ret2</span> <span class="o">=</span> <span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">);</span>
	<span class="n">ret3</span> <span class="o">=</span> <span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret2</span><span class="p">)</span> <span class="o">?</span> <span class="n">ret2</span> <span class="o">:</span> <span class="n">ret3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">LCS_DBF_TEXT_</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;1err:%d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recover_state</span> <span class="o">==</span> <span class="n">DEV_STATE_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_RECOVER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_shutdown_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">ccwgdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__lcs_shutdown_device</span><span class="p">(</span><span class="n">ccwgdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drive lcs recovery after startup and startlan initiated by Lan Gateway</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lcs_recovery</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;recover1&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lcs_do_run_thread</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_RECOVERY_THREAD</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;recover2&quot;</span><span class="p">);</span>
	<span class="n">gdev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="p">;</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;A recovery process has been started for the LCS device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__lcs_shutdown_device</span><span class="p">(</span><span class="n">gdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_new_device</span><span class="p">(</span><span class="n">gdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Device %s successfully recovered!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Device %s could not be recovered!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">lcs_clear_thread_running_bit</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">LCS_RECOVERY_THREAD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lcs_remove_device, free buffers and card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lcs_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">ccwgdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;remdev&quot;</span><span class="p">);</span>
	<span class="n">LCS_DBF_HEX</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CCWGROUP_ONLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lcs_shutdown_device</span><span class="p">(</span><span class="n">ccwgdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lcs_cleanup_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">lcs_free_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccwgdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lcs_pm_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lcs_set_allowed_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lcs_wait_for_threads</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DEV_STATE_DOWN</span><span class="p">)</span>
		<span class="n">__lcs_shutdown_device</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lcs_pm_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DEV_STATE_RECOVER</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_new_device</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The lcs device driver &quot;</span>
			<span class="s">&quot;failed to recover the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lcs_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lcs_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lcs_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lcs_pm_suspend</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lcs_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lcs_pm_resume</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lcs_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcs_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lcs_pm_resume</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_device_id</span> <span class="n">lcs_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">CCW_DEVICE</span><span class="p">(</span><span class="mh">0x3088</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">lcs_channel_type_parallel</span><span class="p">},</span>
	<span class="p">{</span><span class="n">CCW_DEVICE</span><span class="p">(</span><span class="mh">0x3088</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">lcs_channel_type_2216</span><span class="p">},</span>
	<span class="p">{</span><span class="n">CCW_DEVICE</span><span class="p">(</span><span class="mh">0x3088</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">lcs_channel_type_osa2</span><span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">lcs_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_driver</span> <span class="n">lcs_ccw_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;lcs&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ids</span>	<span class="o">=</span> <span class="n">lcs_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">ccwgroup_probe_ccwdev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">ccwgroup_remove_ccwdev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">int_class</span> <span class="o">=</span> <span class="n">IOINT_LCS</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * LCS ccwgroup driver registration</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ccwgroup_driver</span> <span class="n">lcs_group_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;lcs&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">setup</span>	     <span class="o">=</span> <span class="n">lcs_probe_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>      <span class="o">=</span> <span class="n">lcs_remove_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_online</span>  <span class="o">=</span> <span class="n">lcs_new_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_offline</span> <span class="o">=</span> <span class="n">lcs_shutdown_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>     <span class="o">=</span> <span class="n">lcs_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">complete</span>    <span class="o">=</span> <span class="n">lcs_complete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span>	     <span class="o">=</span> <span class="n">lcs_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span>	     <span class="o">=</span> <span class="n">lcs_thaw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span>     <span class="o">=</span> <span class="n">lcs_restore</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">lcs_driver_group_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddrv</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ccwgroup_create_dev</span><span class="p">(</span><span class="n">lcs_root_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcs_group_driver</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">lcs_driver_group_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lcs_drv_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">driver_attr_group</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lcs_drv_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lcs_drv_attrs</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">lcs_drv_attr_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">lcs_drv_attr_group</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *  LCS Module/Kernel initialization function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="n">__init</span> <span class="nf">lcs_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Loading %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lcs_register_debug_facility</span><span class="p">();</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="s">&quot;lcsinit&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="n">lcs_root_dev</span> <span class="o">=</span> <span class="n">root_device_register</span><span class="p">(</span><span class="s">&quot;lcs&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">lcs_root_dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">lcs_root_dev</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">register_err</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lcs_ccw_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ccw_err</span><span class="p">;</span>
	<span class="n">lcs_group_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">lcs_drv_attr_groups</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccwgroup_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lcs_group_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ccwgroup_err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">ccwgroup_err:</span>
	<span class="n">ccw_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lcs_ccw_driver</span><span class="p">);</span>
<span class="nl">ccw_err:</span>
	<span class="n">root_device_unregister</span><span class="p">(</span><span class="n">lcs_root_dev</span><span class="p">);</span>
<span class="nl">register_err:</span>
	<span class="n">lcs_unregister_debug_facility</span><span class="p">();</span>
<span class="nl">out_err:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Initializing the lcs device driver failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *  LCS module cleanup function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">__exit</span> <span class="nf">lcs_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Terminating lcs module.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">LCS_DBF_TEXT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="s">&quot;cleanup&quot;</span><span class="p">);</span>
	<span class="n">ccwgroup_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lcs_group_driver</span><span class="p">);</span>
	<span class="n">ccw_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lcs_ccw_driver</span><span class="p">);</span>
	<span class="n">root_device_unregister</span><span class="p">(</span><span class="n">lcs_root_dev</span><span class="p">);</span>
	<span class="n">lcs_unregister_debug_facility</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">lcs_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">lcs_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Frank Pavlic &lt;fpavlic@de.ibm.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
