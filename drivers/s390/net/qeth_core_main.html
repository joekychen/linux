<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › net › qeth_core_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qeth_core_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/s390/net/qeth_core_main.c</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright IBM Corp. 2007, 2009</span>
<span class="cm"> *    Author(s): Utz Bacher &lt;utz.bacher@de.ibm.com&gt;,</span>
<span class="cm"> *		 Frank Pavlic &lt;fpavlic@de.ibm.com&gt;,</span>
<span class="cm"> *		 Thomas Spatzier &lt;tspat@de.ibm.com&gt;,</span>
<span class="cm"> *		 Frank Blaschka &lt;frank.blaschka@de.ibm.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;qeth&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/iucv/af_iucv.h&gt;</span>

<span class="cp">#include &lt;asm/ebcdic.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/sysinfo.h&gt;</span>
<span class="cp">#include &lt;asm/compat.h&gt;</span>

<span class="cp">#include &quot;qeth_core.h&quot;</span>

<span class="k">struct</span> <span class="n">qeth_dbf_info</span> <span class="n">qeth_dbf</span><span class="p">[</span><span class="n">QETH_DBF_INFOS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* define dbf - Name, Pages, Areas, Maxlen, Level, View, Handle */</span>
	<span class="cm">/*                   N  P  A    M  L  V                      H  */</span>
	<span class="p">[</span><span class="n">QETH_DBF_SETUP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;qeth_setup&quot;</span><span class="p">,</span>
				<span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
	<span class="p">[</span><span class="n">QETH_DBF_MSG</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{</span><span class="s">&quot;qeth_msg&quot;</span><span class="p">,</span>
				<span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_sprintf_view</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">},</span>
	<span class="p">[</span><span class="n">QETH_DBF_CTRL</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span><span class="s">&quot;qeth_control&quot;</span><span class="p">,</span>
		<span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">QETH_DBF_CTRL_LEN</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_dbf</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">qeth_card_list_struct</span> <span class="n">qeth_core_card_list</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_core_card_list</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">qeth_core_header_cache</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_core_header_cache</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">qeth_qdio_outbuf_cache</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">qeth_core_root_dev</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">known_devices</span><span class="p">[][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">QETH_MODELLIST_ARRAY</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lock_class_key</span> <span class="n">qdio_out_skb_queue_key</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">qeth_mod_mutex</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">qeth_send_control_data_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qeth_issue_next_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">qeth_get_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qeth_setup_ccw</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="n">__u32</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qeth_free_buffer_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qeth_qdio_establish</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qeth_free_qdio_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qeth_notify_skbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">iucv_tx_notify</span> <span class="n">notification</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qeth_release_skbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qeth_clear_output_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">qeth_qdio_buffer_states</span> <span class="n">newbufstate</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qeth_init_qdio_out_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">qeth_get_cardname</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSD</span>:
			<span class="k">return</span> <span class="s">&quot; Guest LAN QDIO&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_IQD</span>:
			<span class="k">return</span> <span class="s">&quot; Guest LAN Hiper&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSM</span>:
			<span class="k">return</span> <span class="s">&quot; Guest LAN QDIO - OSM&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSX</span>:
			<span class="k">return</span> <span class="s">&quot; Guest LAN QDIO - OSX&quot;</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="s">&quot; unknown&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSD</span>:
			<span class="k">return</span> <span class="s">&quot; OSD Express&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_IQD</span>:
			<span class="k">return</span> <span class="s">&quot; HiperSockets&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSN</span>:
			<span class="k">return</span> <span class="s">&quot; OSN QDIO&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSM</span>:
			<span class="k">return</span> <span class="s">&quot; OSM QDIO&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSX</span>:
			<span class="k">return</span> <span class="s">&quot; OSX QDIO&quot;</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="s">&quot; unknown&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot; n/a&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* max length to be returned: 14 */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">qeth_get_cardname_short</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSD</span>:
			<span class="k">return</span> <span class="s">&quot;GuestLAN QDIO&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_IQD</span>:
			<span class="k">return</span> <span class="s">&quot;GuestLAN Hiper&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSM</span>:
			<span class="k">return</span> <span class="s">&quot;GuestLAN OSM&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSX</span>:
			<span class="k">return</span> <span class="s">&quot;GuestLAN OSX&quot;</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSD</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">QETH_LINK_TYPE_FAST_ETH</span>:
				<span class="k">return</span> <span class="s">&quot;OSD_100&quot;</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">QETH_LINK_TYPE_HSTR</span>:
				<span class="k">return</span> <span class="s">&quot;HSTR&quot;</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">QETH_LINK_TYPE_GBIT_ETH</span>:
				<span class="k">return</span> <span class="s">&quot;OSD_1000&quot;</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">QETH_LINK_TYPE_10GBIT_ETH</span>:
				<span class="k">return</span> <span class="s">&quot;OSD_10GIG&quot;</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">QETH_LINK_TYPE_LANE_ETH100</span>:
				<span class="k">return</span> <span class="s">&quot;OSD_FE_LANE&quot;</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">QETH_LINK_TYPE_LANE_TR</span>:
				<span class="k">return</span> <span class="s">&quot;OSD_TR_LANE&quot;</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">QETH_LINK_TYPE_LANE_ETH1000</span>:
				<span class="k">return</span> <span class="s">&quot;OSD_GbE_LANE&quot;</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">QETH_LINK_TYPE_LANE</span>:
				<span class="k">return</span> <span class="s">&quot;OSD_ATM_LANE&quot;</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">return</span> <span class="s">&quot;OSD_Express&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_IQD</span>:
			<span class="k">return</span> <span class="s">&quot;HiperSockets&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSN</span>:
			<span class="k">return</span> <span class="s">&quot;OSN&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSM</span>:
			<span class="k">return</span> <span class="s">&quot;OSM_1000&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSX</span>:
			<span class="k">return</span> <span class="s">&quot;OSX_10GIG&quot;</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;n/a&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_set_allowed_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">threads</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">clear_start_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_allowed_mask</span> <span class="o">=</span> <span class="n">threads</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear_start_mask</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">&amp;=</span> <span class="n">threads</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_set_allowed_threads</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_threads_running</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">threads</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_running_mask</span> <span class="o">&amp;</span> <span class="n">threads</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_threads_running</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_wait_for_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">threads</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
			<span class="n">qeth_threads_running</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">threads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_wait_for_threads</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">qeth_clear_working_pool_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_buffer_pool_entry</span> <span class="o">*</span><span class="n">pool_entry</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;clwrklst&quot;</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pool_entry</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">entry_list</span><span class="p">,</span> <span class="n">list</span><span class="p">){</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_clear_working_pool_list</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_alloc_buffer_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_buffer_pool_entry</span> <span class="o">*</span><span class="n">pool_entry</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;alocpool&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">init_pool</span><span class="p">.</span><span class="n">buf_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pool_entry</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pool_entry</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pool_entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qeth_free_buffer_pool</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">QETH_MAX_BUFFER_ELEMENTS</span><span class="p">(</span><span class="n">card</span><span class="p">);</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
						  <span class="n">pool_entry</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="o">--</span><span class="n">j</span><span class="p">]);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pool_entry</span><span class="p">);</span>
				<span class="n">qeth_free_buffer_pool</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pool_entry</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool_entry</span><span class="o">-&gt;</span><span class="n">init_list</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">init_pool</span><span class="p">.</span><span class="n">entry_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_realloc_buffer_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufcnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;realcbp&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_STATE_DOWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_STATE_RECOVER</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* TODO: steel/add buffers from/to a running card&#39;s buffer pool (?) */</span>
	<span class="n">qeth_clear_working_pool_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">qeth_free_buffer_pool</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">=</span> <span class="n">bufcnt</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">init_pool</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">=</span> <span class="n">bufcnt</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">qeth_alloc_buffer_pool</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_realloc_buffer_pool</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qeth_cq_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">==</span> <span class="n">QETH_CQ_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;cqinit&quot;</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="o">-&gt;</span><span class="n">qdio_bufs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">QDIO_MAX_BUFFERS_PER_Q</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_buffer</span><span class="p">));</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_QDIO</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="n">QDIO_FLAG_SYNC_INPUT</span><span class="p">,</span>
			     <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="mi">127</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;1err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qeth_alloc_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">==</span> <span class="n">QETH_CQ_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">qdio_outbuf_state</span> <span class="o">*</span><span class="n">outbuf_states</span><span class="p">;</span>

		<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;cqon&quot;</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_q</span><span class="p">),</span>
					 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">kmsg_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="o">-&gt;</span><span class="n">qdio_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_bufstates</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qdio_outbuf_state</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">kzalloc</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span> <span class="o">*</span>
				<span class="n">QDIO_MAX_BUFFERS_PER_Q</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_outbuf_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">outbuf_states</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_bufstates</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">outbuf_states</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_cq_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bufstates</span> <span class="o">=</span> <span class="n">outbuf_states</span><span class="p">;</span>
			<span class="n">outbuf_states</span> <span class="o">+=</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;nocq&quot;</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;iqc%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">free_cq_out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">kmsg_out:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create completion queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qeth_free_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">--</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_bufstates</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_bufstates</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">enum</span> <span class="n">iucv_tx_notify</span> <span class="nf">qeth_compute_cq_notification</span><span class="p">(</span><span class="kt">int</span> <span class="n">sbalf15</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">delayed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">iucv_tx_notify</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sbalf15</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="n">delayed</span> <span class="o">?</span> <span class="n">TX_NOTIFY_DELAYED_OK</span> <span class="o">:</span> <span class="n">TX_NOTIFY_OK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">16</span>:
	<span class="k">case</span> <span class="mi">17</span>:
	<span class="k">case</span> <span class="mi">18</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="n">delayed</span> <span class="o">?</span> <span class="n">TX_NOTIFY_DELAYED_UNREACHABLE</span> <span class="o">:</span>
			<span class="n">TX_NOTIFY_UNREACHABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">delayed</span> <span class="o">?</span> <span class="n">TX_NOTIFY_DELAYED_GENERALERROR</span> <span class="o">:</span>
			<span class="n">TX_NOTIFY_GENERALERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qeth_cleanup_handled_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">bidx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">forced_cleanup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">!=</span> <span class="n">QETH_CQ_ENABLED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">next_pending</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">bidx</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">next_pending</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">forced_cleanup</span> <span class="o">||</span>
			    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span>
			      <span class="n">QETH_QDIO_BUF_HANDLED_DELAYED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
				<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;fp&quot;</span><span class="p">);</span>
				<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;%lx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">f</span><span class="p">);</span>
				<span class="cm">/* release here to avoid interleaving between</span>
<span class="cm">				   outbound tasklet and inbound tasklet</span>
<span class="cm">				   regarding notifications and lifecycle */</span>
				<span class="n">qeth_release_skbs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

				<span class="n">c</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">next_pending</span><span class="p">;</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next_pending</span> <span class="o">!=</span> <span class="n">f</span><span class="p">);</span>
				<span class="n">head</span><span class="o">-&gt;</span><span class="n">next_pending</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
				<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">qeth_qdio_outbuf_cache</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">head</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next_pending</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">forced_cleanup</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="o">==</span>
					<span class="n">QETH_QDIO_BUF_HANDLED_DELAYED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* for recovery situations */</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">aob</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bufstates</span><span class="p">[</span><span class="n">bidx</span><span class="p">].</span><span class="n">aob</span><span class="p">;</span>
		<span class="n">qeth_init_qdio_out_buf</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bidx</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;clprecov&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qeth_qdio_handle_aob</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_aob_addr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">qaob</span> <span class="o">*</span><span class="n">aob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">iucv_tx_notify</span> <span class="n">notification</span><span class="p">;</span>

	<span class="n">aob</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qaob</span> <span class="o">*</span><span class="p">)</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">phys_aob_addr</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;haob&quot;</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;%lx&quot;</span><span class="p">,</span> <span class="n">phys_aob_addr</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="p">)</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">user1</span><span class="p">;</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;%lx&quot;</span><span class="p">,</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">user1</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_BUF_PRIMED</span><span class="p">,</span>
			   <span class="n">QETH_QDIO_BUF_IN_CQ</span><span class="p">)</span> <span class="o">==</span> <span class="n">QETH_QDIO_BUF_PRIMED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">notification</span> <span class="o">=</span> <span class="n">TX_NOTIFY_OK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QETH_QDIO_BUF_PENDING</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_BUF_IN_CQ</span><span class="p">);</span>
		<span class="n">notification</span> <span class="o">=</span> <span class="n">TX_NOTIFY_DELAYED_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aob</span><span class="o">-&gt;</span><span class="n">aorc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;aorc%02X&quot;</span><span class="p">,</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">aorc</span><span class="p">);</span>
		<span class="n">notification</span> <span class="o">=</span> <span class="n">qeth_compute_cq_notification</span><span class="p">(</span><span class="n">aob</span><span class="o">-&gt;</span><span class="n">aorc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qeth_notify_skbs</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">notification</span><span class="p">);</span>

	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aob</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">qeth_clear_output_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
				 <span class="n">QETH_QDIO_BUF_HANDLED_DELAYED</span><span class="p">);</span>

	<span class="cm">/* from here on: do not touch buffer anymore */</span>
	<span class="n">qdio_release_aob</span><span class="p">(</span><span class="n">aob</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qeth_is_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">==</span> <span class="n">QETH_CQ_ENABLED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">queue</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">queue</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_issue_next_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;issnxrd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CH_STATE_UP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iob</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The qeth device driver &quot;</span>
			<span class="s">&quot;failed to recover an error on the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s issue_next_read failed: no iob &quot;</span>
			<span class="s">&quot;available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qeth_setup_ccw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">,</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">QETH_BUFSIZE</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;noirqpnd&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_start</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccw</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">iob</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s error in starting next read ccw! &quot;</span>
			<span class="s">&quot;rc=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">irq_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">read_or_write_problem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qeth_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="nf">qeth_alloc_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_reply</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">received</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">reply</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_get_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_put_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_issue_ipa_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ipa_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">com</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>
	<span class="n">ipa_name</span> <span class="o">=</span> <span class="n">qeth_get_ipa_cmd_name</span><span class="p">(</span><span class="n">com</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;IPA: %s(x%X) for %s/%s returned &quot;</span>
				<span class="s">&quot;x%X </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ipa_name</span><span class="p">,</span> <span class="n">com</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
				<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="n">rc</span><span class="p">,</span>
				<span class="n">qeth_get_ipa_msg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;IPA: %s(x%X) for %s/%s succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ipa_name</span><span class="p">,</span> <span class="n">com</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
				<span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="nf">qeth_check_ipa_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;chkipad&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IPA</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">PDU_ENCAPSULATION</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_IPA_REPLY</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">command</span> <span class="o">!=</span> <span class="n">IPA_CMD_SETCCID</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">command</span> <span class="o">!=</span> <span class="n">IPA_CMD_DELCCID</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">command</span> <span class="o">!=</span> <span class="n">IPA_CMD_MODCCID</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">command</span> <span class="o">!=</span> <span class="n">IPA_CMD_SET_DIAG_ASS</span><span class="p">)</span>
				<span class="n">qeth_issue_ipa_msg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
						<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IPA_CMD_STOPLAN</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;The link for interface %s on CHPID&quot;</span>
					   <span class="s">&quot; 0x%X failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
					   <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">chpid</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
					<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IPA_CMD_STARTLAN</span>:
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;The link for %s on CHPID 0x%X has&quot;</span>
					   <span class="s">&quot; been restored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
					   <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">chpid</span><span class="p">);</span>
				<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">hwtrap</span><span class="p">)</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">hwtrap</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">qeth_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IPA_CMD_MODCCID</span>:
				<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IPA_CMD_REGISTER_LOCAL_ADDR</span>:
				<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;irla&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IPA_CMD_UNREGISTER_LOCAL_ADDR</span>:
				<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;urla&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Received data is IPA &quot;</span>
					   <span class="s">&quot;but not a reply!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_clear_ipacmd_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;clipalst&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_waiter_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qeth_get_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">received</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
		<span class="n">qeth_put_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">irq_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_clear_ipacmd_list</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_check_idx_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">CTRL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">QETH_DBF_CTRL_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;received an IDX TERMINATE &quot;</span>
			   <span class="s">&quot;with cause code 0x%02x%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			   <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x22</span><span class="p">)</span> <span class="o">?</span>
			    <span class="s">&quot; -- try another portname&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ckidxres&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot; idxterm&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  rc%d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The qeth device is not configured &quot;</span>
			<span class="s">&quot;for the OSI layer required by z/VM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_setup_ccw</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iob</span><span class="p">,</span>
		<span class="n">__u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setupccw&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span> <span class="n">READ_CCW</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span> <span class="n">WRITE_CCW</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">iob</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="nf">__qeth_get_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;getbuff&quot;</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_buf_no</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">BUF_STATE_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUF_STATE_LOCKED</span><span class="p">;</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_buf_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_buf_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
				<span class="n">QETH_CMD_BUFFER_NO</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QETH_BUFSIZE</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">QETH_CMD_BUFFER_NO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_buf_no</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_release_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;relbuff&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QETH_BUFSIZE</span><span class="p">);</span>
	<span class="n">iob</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUF_STATE_FREE</span><span class="p">;</span>
	<span class="n">iob</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">qeth_send_control_data_cb</span><span class="p">;</span>
	<span class="n">iob</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_release_buffer</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="nf">qeth_get_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">__qeth_get_buffer</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="nf">qeth_wait_for_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
		   <span class="p">((</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">qeth_get_buffer</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_wait_for_buffer</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">qeth_clear_cmd_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">QETH_CMD_BUFFER_NO</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qeth_release_buffer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buf_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_buf_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_clear_cmd_buffers</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_send_control_data_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keep_reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;sndctlcb&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_check_idx_response</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>:
		<span class="n">qeth_clear_ipacmd_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">qeth_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">qeth_check_ipa_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_STATE_DOWN</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/*in case of OSN : check if cmd is set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">command</span> <span class="o">!=</span> <span class="n">IPA_CMD_STARTLAN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">osn_info</span><span class="p">.</span><span class="n">assist_cb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">osn_info</span><span class="p">.</span><span class="n">assist_cb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_waiter_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">seqno</span> <span class="o">==</span> <span class="n">QETH_IDX_COMMAND_SEQNO</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">seqno</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seqno</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">qeth_get_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">keep_reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">reply</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span> <span class="o">-</span>
							<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
					<span class="n">keep_reply</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
							<span class="n">reply</span><span class="p">,</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">keep_reply</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
							<span class="n">reply</span><span class="p">,</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">iob</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
				<span class="n">reply</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">)</span>
				<span class="n">reply</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">keep_reply</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_waiter_list</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">received</span><span class="p">);</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">qeth_put_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">.</span><span class="n">pdu_hdr_ack</span><span class="p">,</span>
		<span class="n">QETH_PDU_HEADER_SEQ_NO</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
		<span class="n">QETH_SEQ_NO_LENGTH</span><span class="p">);</span>
	<span class="n">qeth_release_buffer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">iob</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_setup_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;setupch&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">QETH_CMD_BUFFER_NO</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span>
			<span class="n">kzalloc</span><span class="p">(</span><span class="n">QETH_BUFSIZE</span><span class="p">,</span> <span class="n">GFP_DMA</span><span class="o">|</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUF_STATE_FREE</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">callback</span> <span class="o">=</span> <span class="n">qeth_send_control_data_cb</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">QETH_CMD_BUFFER_NO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buf_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">io_buf_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">irq_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob_lock</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_set_thread_start_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_allowed_mask</span> <span class="o">&amp;</span> <span class="kr">thread</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">&amp;</span> <span class="kr">thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">|=</span> <span class="kr">thread</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_clear_thread_start_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="kr">thread</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_clear_thread_start_bit</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">qeth_clear_thread_running_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_running_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="kr">thread</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_clear_thread_running_bit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qeth_do_run_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">&amp;</span> <span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_allowed_mask</span> <span class="o">&amp;</span> <span class="kr">thread</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_running_mask</span> <span class="o">&amp;</span> <span class="kr">thread</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="kr">thread</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_running_mask</span> <span class="o">|=</span> <span class="kr">thread</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_do_run_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">__qeth_do_run_thread</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="kr">thread</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_do_run_thread</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">qeth_schedule_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;startrec&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_set_thread_start_bit</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_RECOVER_THREAD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">kernel_thread_starter</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_schedule_recovery</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_get_problem</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dstat</span><span class="p">,</span> <span class="n">cstat</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">;</span>
	<span class="n">cstat</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span><span class="p">;</span>
	<span class="n">dstat</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span><span class="p">;</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCHN_STAT_CHN_CTRL_CHK</span> <span class="o">|</span> <span class="n">SCHN_STAT_INTF_CTRL_CHK</span> <span class="o">|</span>
		     <span class="n">SCHN_STAT_CHN_DATA_CHK</span> <span class="o">|</span> <span class="n">SCHN_STAT_CHAIN_CHECK</span> <span class="o">|</span>
		     <span class="n">SCHN_STAT_PROT_CHECK</span> <span class="o">|</span> <span class="n">SCHN_STAT_PROG_CHECK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;CGENCHK&quot;</span><span class="p">);</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The qeth device driver &quot;</span>
			<span class="s">&quot;failed to recover an error on the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s check on device dstat=x%x, cstat=x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">dstat</span><span class="p">,</span> <span class="n">cstat</span><span class="p">);</span>
		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;qeth: irb &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
				<span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="n">SENSE_RESETTING_EVENT_BYTE</span><span class="p">]</span> <span class="o">&amp;</span>
		    <span class="n">SENSE_RESETTING_EVENT_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;REVIND&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="n">SENSE_COMMAND_REJECT_BYTE</span><span class="p">]</span> <span class="o">&amp;</span>
		    <span class="n">SENSE_COMMAND_REJECT_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;CMDREJi&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xaf</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;AFFE&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ZEROSEN&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;DGENCHK&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">__qeth_check_irb_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">intparm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">irb</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">irb</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>:
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s i/o-error on device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ckirberr&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  rc%d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIMEDOUT</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A hardware operation timed out&quot;</span>
			<span class="s">&quot; on the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ckirberr&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  rc%d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intparm</span> <span class="o">==</span> <span class="n">QETH_RCD_PARM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ccwdev</span> <span class="o">==</span> <span class="n">cdev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_DOWN</span><span class="p">;</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s unknown error %ld on device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">irb</span><span class="p">));</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ckirberr&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  rc???&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">irb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">intparm</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cstat</span><span class="p">,</span> <span class="n">dstat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__qeth_check_irb_error</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">intparm</span><span class="p">,</span> <span class="n">irb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cstat</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span><span class="p">;</span>
	<span class="n">dstat</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;irq&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccwdev</span> <span class="o">==</span> <span class="n">cdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">;</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span> <span class="o">==</span> <span class="n">cdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;data&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">irq_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">fctl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCSW_FCTL_CLEAR_FUNC</span><span class="p">))</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_STOPPED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">fctl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCSW_FCTL_HALT_FUNC</span><span class="p">))</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_HALTED</span><span class="p">;</span>

	<span class="cm">/*let&#39;s wake up immediately on data channel*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">intparm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">intparm</span> <span class="o">!=</span> <span class="n">QETH_RCD_PARM</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intparm</span> <span class="o">==</span> <span class="n">QETH_CLEAR_CHANNEL_PARM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;clrchpar&quot;</span><span class="p">);</span>
		<span class="cm">/* we don&#39;t have to handle this further */</span>
		<span class="n">intparm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intparm</span> <span class="o">==</span> <span class="n">QETH_HALT_CHANNEL_PARM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;hltchpar&quot;</span><span class="p">);</span>
		<span class="cm">/* we don&#39;t have to handle this further */</span>
		<span class="n">intparm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_EXCEP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cstat</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cons</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;The qeth device driver failed to recover &quot;</span>
				<span class="s">&quot;an error on the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s sense data available. cstat &quot;</span>
				<span class="s">&quot;0x%X dstat 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">cstat</span><span class="p">,</span> <span class="n">dstat</span><span class="p">);</span>
			<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;qeth: irb &quot;</span><span class="p">,</span>
				<span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;qeth: sense data &quot;</span><span class="p">,</span>
				<span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intparm</span> <span class="o">==</span> <span class="n">QETH_RCD_PARM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_DOWN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_get_problem</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qeth_clear_ipacmd_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="n">qeth_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intparm</span> <span class="o">==</span> <span class="n">QETH_RCD_PARM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_RCD_DONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intparm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="p">)</span> <span class="n">__va</span><span class="p">((</span><span class="n">addr_t</span><span class="p">)</span><span class="n">intparm</span><span class="p">);</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUF_STATE_PROCESSED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">&amp;&amp;</span>
	    <span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CH_STATE_UP</span><span class="p">)</span>
		<span class="n">qeth_issue_next_read</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">buf_no</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">iob</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">BUF_STATE_PROCESSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iob</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">callback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">iob</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">callback</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">iob</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>

		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">QETH_CMD_BUFFER_NO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">buf_no</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_notify_skbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">iucv_tx_notify</span> <span class="n">notification</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;skbn%d&quot;</span><span class="p">,</span> <span class="n">notification</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;%lx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_AF_IUCV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">iucv_sock</span> <span class="o">*</span><span class="n">iucv</span> <span class="o">=</span> <span class="n">iucv_sk</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
				<span class="n">iucv</span><span class="o">-&gt;</span><span class="n">sk_txnotify</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">notification</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_queue_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_release_skbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_sock</span> <span class="o">*</span><span class="n">iucv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">notify_general_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">QETH_QDIO_BUF_PENDING</span><span class="p">)</span>
		<span class="n">notify_general_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* release may never happen from within CQ tasklet scope */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">QETH_QDIO_BUF_IN_CQ</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;skbr&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;%lx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">notify_general_error</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_AF_IUCV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">iucv</span> <span class="o">=</span> <span class="n">iucv_sk</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
				<span class="n">iucv</span><span class="o">-&gt;</span><span class="n">sk_txnotify</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TX_NOTIFY_GENERALERROR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_clear_output_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">qeth_qdio_buffer_states</span> <span class="n">newbufstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* is PCI flag set on buffer? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sflags</span> <span class="o">&amp;</span> <span class="n">SBAL_SFLAGS0_PCI_REQ</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">set_pci_flags_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newbufstate</span> <span class="o">==</span> <span class="n">QETH_QDIO_BUF_EMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qeth_release_skbs</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QETH_MAX_BUFFER_ELEMENTS</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">is_header</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">qeth_core_header_cache</span><span class="p">,</span>
				<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">is_header</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">sflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">next_element_to_fill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">newbufstate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_clear_outq_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">free</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">qeth_cleanup_handled_pending</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">qeth_clear_output_buffer</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">QETH_QDIO_BUF_EMPTY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">free</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">qeth_qdio_outbuf_cache</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_clear_qdio_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;clearqdbf&quot;</span><span class="p">);</span>
	<span class="cm">/* clear outbound buffers to free skbs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">qeth_clear_outq_buffers</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_clear_qdio_buffers</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_free_buffer_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_buffer_pool_entry</span> <span class="o">*</span><span class="n">pool_entry</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pool_entry</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">init_pool</span><span class="p">.</span><span class="n">entry_list</span><span class="p">,</span> <span class="n">init_list</span><span class="p">){</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QETH_MAX_BUFFER_ELEMENTS</span><span class="p">(</span><span class="n">card</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pool_entry</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool_entry</span><span class="o">-&gt;</span><span class="n">init_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pool_entry</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_free_qdio_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_UNINITIALIZED</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">QETH_QDIO_UNINITIALIZED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">qeth_free_cq</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">buffer_reclaim_work</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rx_skb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* inbound buffer pool */</span>
	<span class="n">qeth_free_buffer_pool</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="cm">/* free outbound qdio_qs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qeth_clear_outq_buffers</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_clean_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;freech&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">QETH_CMD_BUFFER_NO</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">iob</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_get_channel_path_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">ccwdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channelPath_dsc</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">lsn</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">desc</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">chpid</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">swla</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">zeroes</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">chla</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">chpp</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">chp_dsc</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;chp_desc&quot;</span><span class="p">);</span>

	<span class="n">ccwdev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">;</span>
	<span class="n">chp_dsc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">channelPath_dsc</span> <span class="o">*</span><span class="p">)</span><span class="n">ccw_device_get_chp_desc</span><span class="p">(</span><span class="n">ccwdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chp_dsc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* CHPP field bit 6 == 1 -&gt; single queue */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chp_dsc</span><span class="o">-&gt;</span><span class="n">chpp</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span>
					<span class="n">QETH_QDIO_UNINITIALIZED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
					<span class="cm">/* change from 4 to 1 outbound queues */</span>
					<span class="n">qeth_free_qdio_buffers</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">default_out_queue</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Priority Queueing not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">default_out_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span>
					<span class="n">QETH_QDIO_UNINITIALIZED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* change from 1 to 4 outbound queues */</span>
					<span class="n">qeth_free_qdio_buffers</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">default_out_queue</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">func_level</span> <span class="o">=</span> <span class="mh">0x4100</span> <span class="o">+</span> <span class="n">chp_dsc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chp_dsc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;nr:%x&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;lvl:%02x&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">func_level</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_init_qdio_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;intqdinf&quot;</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_UNINITIALIZED</span><span class="p">);</span>
	<span class="cm">/* inbound */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_size</span> <span class="o">=</span> <span class="n">QETH_IN_BUF_SIZE_DEFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">init_pool</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">=</span> <span class="n">QETH_IN_BUF_COUNT_HSDEFAULT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">init_pool</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">=</span> <span class="n">QETH_IN_BUF_COUNT_DEFAULT</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">init_pool</span><span class="p">.</span><span class="n">buf_count</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">entry_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">init_pool</span><span class="p">.</span><span class="n">entry_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_set_intial_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">route4</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NO_ROUTER</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">route6</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NO_ROUTER</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">fake_broadcast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">add_hhlen</span> <span class="o">=</span> <span class="n">DEFAULT_ADD_HHLEN</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">rx_sg_cb</span> <span class="o">=</span> <span class="n">QETH_RX_SG_CB</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">ISOLATION_MODE_NONE</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">=</span> <span class="n">QETH_CQ_DISABLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_do_start_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  %02x%02x%02x&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_allowed_mask</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_running_mask</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">&amp;</span> <span class="kr">thread</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_start_kernel_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_card</span><span class="p">,</span>
					<span class="n">kernel_thread_starter</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span> <span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;strthrd&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CH_STATE_UP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CH_STATE_UP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_do_start_thread</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_RECOVER_THREAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ts</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">recover</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">card</span><span class="p">,</span>
				<span class="s">&quot;qeth_recover&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qeth_clear_thread_start_bit</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_RECOVER_THREAD</span><span class="p">);</span>
			<span class="n">qeth_clear_thread_running_bit</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				<span class="n">QETH_RECOVER_THREAD</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_setup_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;setupcrd&quot;</span><span class="p">);</span>
	<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">state</span>  <span class="o">=</span> <span class="n">CH_STATE_DOWN</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_DOWN</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">state</span>  <span class="o">=</span> <span class="n">CH_STATE_DOWN</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_DOWN</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lan_online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read_or_write_problem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vlanlock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mclock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_mask_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline_mutex</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_start_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_allowed_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">thread_running_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">kernel_thread_starter</span><span class="p">,</span> <span class="n">qeth_start_kernel_thread</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_waiter_list</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
	<span class="cm">/* initial options */</span>
	<span class="n">qeth_set_intial_options</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="cm">/* IP address takeover */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ipato</span><span class="p">.</span><span class="n">entries</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">ipato</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">ipato</span><span class="p">.</span><span class="n">invert4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">ipato</span><span class="p">.</span><span class="n">invert6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* init QDIO stuff */</span>
	<span class="n">qeth_init_qdio_info</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">buffer_reclaim_work</span><span class="p">,</span> <span class="n">qeth_buffer_reclaim_work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_core_sl_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">service_level</span> <span class="o">*</span><span class="n">slr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">slr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_card</span><span class="p">,</span>
					<span class="n">qeth_service_level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;qeth: %s firmware level %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">CARD_BUS_ID</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="nf">qeth_alloc_card</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;alloccrd&quot;</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span><span class="p">),</span> <span class="n">GFP_DMA</span><span class="o">|</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;iptbdnom&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_card</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_setup_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_ip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_setup_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_channel</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">layer2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qeth_service_level</span><span class="p">.</span><span class="n">seq_print</span> <span class="o">=</span> <span class="n">qeth_core_sl_print</span><span class="p">;</span>
	<span class="n">register_service_level</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qeth_service_level</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">card</span><span class="p">;</span>

<span class="nl">out_channel:</span>
	<span class="n">qeth_clean_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
<span class="nl">out_ip:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">);</span>
<span class="nl">out_card:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_determine_card_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;detcdtyp&quot;</span><span class="p">);</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">do_prio_queueing</span> <span class="o">=</span> <span class="n">QETH_PRIOQ_DEFAULT</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">default_out_queue</span> <span class="o">=</span> <span class="n">QETH_DEFAULT_QUEUE</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">known_devices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">QETH_DEV_MODEL_IND</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">CARD_RDEV</span><span class="p">(</span><span class="n">card</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">dev_type</span> <span class="o">==</span>
				<span class="n">known_devices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">QETH_DEV_TYPE_IND</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">CARD_RDEV</span><span class="p">(</span><span class="n">card</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">dev_model</span> <span class="o">==</span>
				<span class="n">known_devices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">QETH_DEV_MODEL_IND</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">known_devices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">QETH_DEV_MODEL_IND</span><span class="p">];</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span> <span class="o">=</span>
				<span class="n">known_devices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">QETH_QUEUE_NO_IND</span><span class="p">];</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">is_multicast_different</span> <span class="o">=</span>
				<span class="n">known_devices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">QETH_MULTICAST_IND</span><span class="p">];</span>
			<span class="n">qeth_get_channel_path_desc</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">QETH_CARD_TYPE_UNKNOWN</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The adapter hardware is of an &quot;</span>
		<span class="s">&quot;unknown type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_clear_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;clearch&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_clear</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">,</span> <span class="n">QETH_CLEAR_CHANNEL_PARM</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CH_STATE_STOPPED</span><span class="p">,</span> <span class="n">QETH_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CH_STATE_STOPPED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_DOWN</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_halt_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;haltch&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_halt</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">,</span> <span class="n">QETH_HALT_CHANNEL_PARM</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CH_STATE_HALTED</span><span class="p">,</span> <span class="n">QETH_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CH_STATE_HALTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_halt_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;haltchs&quot;</span><span class="p">);</span>
	<span class="n">rc1</span> <span class="o">=</span> <span class="n">qeth_halt_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
	<span class="n">rc2</span> <span class="o">=</span> <span class="n">qeth_halt_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="n">rc3</span> <span class="o">=</span> <span class="n">qeth_halt_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_clear_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;clearchs&quot;</span><span class="p">);</span>
	<span class="n">rc1</span> <span class="o">=</span> <span class="n">qeth_clear_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
	<span class="n">rc2</span> <span class="o">=</span> <span class="n">qeth_clear_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="n">rc3</span> <span class="o">=</span> <span class="n">qeth_clear_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_clear_halt_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">halt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;clhacrd&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">halt</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_halt_channels</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">qeth_clear_channels</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_qdio_clear_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">use_halt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qdioclr&quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_ESTABLISHED</span><span class="p">,</span>
		<span class="n">QETH_QDIO_CLEANING</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_QDIO_ESTABLISHED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_shutdown</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
				<span class="n">QDIO_FLAG_CLEANUP_USING_HALT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_shutdown</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
				<span class="n">QDIO_FLAG_CLEANUP_USING_CLEAR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;1err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">qdio_free</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_ALLOCATED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_QDIO_CLEANING</span>:
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_clear_halt_card</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">use_halt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;2err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_DOWN</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_qdio_clear_card</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_read_conf_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">buffer</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ciw</span> <span class="o">*</span><span class="n">ciw</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rcd_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * scan for RCD command in extended SenseID data</span>
<span class="cm">	 */</span>
	<span class="n">ciw</span> <span class="o">=</span> <span class="n">ccw_device_get_ciw</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">,</span> <span class="n">CIW_TYPE_RCD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ciw</span> <span class="o">||</span> <span class="n">ciw</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="n">rcd_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ciw</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rcd_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">ciw</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">rcd_buf</span><span class="p">);</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ciw</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_RCD</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccw_device_start_timeout</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span>
				       <span class="n">QETH_RCD_PARM</span><span class="p">,</span> <span class="n">LPM_ANYPATH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">QETH_RCD_TIMEOUT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CH_STATE_RCD_DONE</span> <span class="o">||</span>
			    <span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CH_STATE_DOWN</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CH_STATE_DOWN</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_DOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rcd_buf</span><span class="p">);</span>
		<span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">ciw</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		<span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">rcd_buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_configure_unitaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;cfgunit&quot;</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">chpid</span> <span class="o">=</span> <span class="n">prcd</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">unit_addr2</span> <span class="o">=</span> <span class="n">prcd</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">cula</span> <span class="o">=</span> <span class="n">prcd</span><span class="p">[</span><span class="mi">63</span><span class="p">];</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span> <span class="o">=</span> <span class="p">((</span><span class="n">prcd</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">==</span> <span class="n">_ascebc</span><span class="p">[</span><span class="sc">&#39;V&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">prcd</span><span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">==</span> <span class="n">_ascebc</span><span class="p">[</span><span class="sc">&#39;M&#39;</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_configure_blkt_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;cfgblkt&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prcd</span><span class="p">[</span><span class="mi">74</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xF0</span> <span class="o">&amp;&amp;</span> <span class="n">prcd</span><span class="p">[</span><span class="mi">75</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xF0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">prcd</span><span class="p">[</span><span class="mi">76</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xF5</span> <span class="o">||</span> <span class="n">prcd</span><span class="p">[</span><span class="mi">76</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xF6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">blkt</span><span class="p">.</span><span class="n">time_total</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">blkt</span><span class="p">.</span><span class="n">inter_packet</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">blkt</span><span class="p">.</span><span class="n">inter_packet_jumbo</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">blkt</span><span class="p">.</span><span class="n">time_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">blkt</span><span class="p">.</span><span class="n">inter_packet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">blkt</span><span class="p">.</span><span class="n">inter_packet_jumbo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_init_tokens</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">issuer_rm_w</span> <span class="o">=</span> <span class="mh">0x00010103UL</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">cm_filter_w</span> <span class="o">=</span> <span class="mh">0x00010108UL</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">cm_connection_w</span> <span class="o">=</span> <span class="mh">0x0001010aUL</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">ulp_filter_w</span> <span class="o">=</span> <span class="mh">0x0001010bUL</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">ulp_connection_w</span> <span class="o">=</span> <span class="mh">0x0001010dUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_init_func_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_IQD</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">func_level</span> <span class="o">=</span>	<span class="n">QETH_IDX_FUNC_LEVEL_IQD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSD</span>:
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSN</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">func_level</span> <span class="o">=</span> <span class="n">QETH_IDX_FUNC_LEVEL_OSD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_idx_activate_get_answer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">idx_reply_cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;idxanswr&quot;</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">);</span>
	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_buffer</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">iob</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">idx_reply_cb</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span> <span class="n">READ_CCW</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">QETH_BUFSIZE</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
		   <span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">irq_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;noirqpnd&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_start</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">iob</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Error2 in activating channel rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;2err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">irq_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
			 <span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CH_STATE_UP</span><span class="p">,</span> <span class="n">QETH_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CH_STATE_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;3err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">qeth_clear_cmd_buffers</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_idx_activate_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">idx_reply_cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="n">temp_devid</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">);</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;idxactch&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_buffer</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">iob</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">idx_reply_cb</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span> <span class="n">WRITE_CCW</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">IDX_ACTIVATE_SIZE</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">IDX_ACTIVATE_WRITE</span><span class="p">,</span> <span class="n">IDX_ACTIVATE_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_TRANSPORT_HEADER_SEQ_NO</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">.</span><span class="n">trans_hdr</span><span class="p">,</span> <span class="n">QETH_SEQ_NO_LENGTH</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">.</span><span class="n">trans_hdr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">IDX_ACTIVATE_READ</span><span class="p">,</span> <span class="n">IDX_ACTIVATE_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_TRANSPORT_HEADER_SEQ_NO</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">.</span><span class="n">trans_hdr</span><span class="p">,</span> <span class="n">QETH_SEQ_NO_LENGTH</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">__u8</span><span class="p">)</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">portno</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IDX_ACT_PNO</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IDX_ACT_ISSUER_RM_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">issuer_rm_w</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IDX_ACT_FUNC_LEVEL</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">func_level</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u16</span><span class="p">));</span>
	<span class="n">ccw_device_get_id</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">temp_devid</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IDX_ACT_QDIO_DEV_CUA</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">temp_devid</span><span class="p">.</span><span class="n">devno</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">cula</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">unit_addr2</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IDX_ACT_QDIO_DEV_REALADDR</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
		   <span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">irq_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;noirqpnd&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_start</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">iob</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Error1 in activating channel. rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">);</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;1err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">irq_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CH_STATE_ACTIVATING</span><span class="p">,</span> <span class="n">QETH_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CH_STATE_ACTIVATING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The qeth device driver&quot;</span>
			<span class="s">&quot; failed to recover an error on the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s IDX activate timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;2err%d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">);</span>
		<span class="n">qeth_clear_cmd_buffers</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">qeth_idx_activate_get_answer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">idx_reply_cb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_peer_func_level</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">level</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">level</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x400</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">level</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">level</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">level</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_idx_write_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span> <span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;idxwrcb&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CH_STATE_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_ACTIVATING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">QETH_IS_IDX_ACT_POS_REPLY</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">QETH_IDX_ACT_CAUSE_CODE</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">QETH_IDX_ACT_ERR_EXCL</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;The adapter is used exclusively by another &quot;</span>
				<span class="s">&quot;host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s IDX_ACTIVATE on write channel:&quot;</span>
				<span class="s">&quot; negative reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="n">QETH_IDX_ACT_FUNC_LEVEL</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0100</span><span class="p">)</span> <span class="o">!=</span> <span class="n">qeth_peer_func_level</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">func_level</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s IDX_ACTIVATE on write channel: &quot;</span>
			<span class="s">&quot;function level mismatch (sent: 0x%x, received: &quot;</span>
			<span class="s">&quot;0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">func_level</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_UP</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">qeth_release_buffer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">iob</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_idx_read_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span> <span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;idxrdcb&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CH_STATE_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_ACTIVATING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">CARD_FROM_CDEV</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ccwdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_check_idx_response</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">QETH_IS_IDX_ACT_POS_REPLY</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">QETH_IDX_ACT_CAUSE_CODE</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QETH_IDX_ACT_ERR_EXCL</span>:
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;The adapter is used exclusively by another &quot;</span>
				<span class="s">&quot;host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QETH_IDX_ACT_ERR_AUTH</span>:
		<span class="k">case</span> <span class="n">QETH_IDX_ACT_ERR_AUTH_USER</span>:
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Setting the device online failed because of &quot;</span>
				<span class="s">&quot;insufficient authorization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s IDX_ACTIVATE on read channel:&quot;</span>
				<span class="s">&quot; negative reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;idxread%c&quot;</span><span class="p">,</span>
			<span class="n">QETH_IDX_ACT_CAUSE_CODE</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  * temporary fix for microcode bug</span>
<span class="cm"> *   * to revert it,replace OR by AND</span>
<span class="cm"> *    */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">QETH_IDX_NO_PORTNAME_REQUIRED</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSD</span><span class="p">))</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">portname_required</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="n">QETH_IDX_ACT_FUNC_LEVEL</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">qeth_peer_func_level</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">func_level</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s IDX_ACTIVATE on read channel: function &quot;</span>
			<span class="s">&quot;level mismatch (sent: 0x%x, received: 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">func_level</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">issuer_rm_r</span><span class="p">,</span>
	       <span class="n">QETH_IDX_ACT_ISSUER_RM_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="n">QETH_IDX_REPLY_LEVEL</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">QETH_MCL_LENGTH</span><span class="p">);</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CH_STATE_UP</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">qeth_release_buffer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">iob</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_prepare_control_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qeth_setup_ccw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">,</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">iob</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">qeth_release_buffer</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_TRANSPORT_HEADER_SEQ_NO</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">.</span><span class="n">trans_hdr</span><span class="p">,</span> <span class="n">QETH_SEQ_NO_LENGTH</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">.</span><span class="n">trans_hdr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_PDU_HEADER_SEQ_NO</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">.</span><span class="n">pdu_hdr</span><span class="p">,</span> <span class="n">QETH_SEQ_NO_LENGTH</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">.</span><span class="n">pdu_hdr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_PDU_HEADER_ACK_SEQ_NO</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">.</span><span class="n">pdu_hdr_ack</span><span class="p">,</span> <span class="n">QETH_SEQ_NO_LENGTH</span><span class="p">);</span>
	<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">CTRL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">QETH_DBF_CTRL_LEN</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_prepare_control_data</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_send_control_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">reply_cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">reply_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">event_timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;sendctl&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read_or_write_problem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qeth_release_buffer</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">iob</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reply</span> <span class="o">=</span> <span class="n">qeth_alloc_reply</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">reply_cb</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">param</span> <span class="o">=</span> <span class="n">reply_param</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_STATE_DOWN</span><span class="p">)</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">QETH_IDX_COMMAND_SEQNO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">.</span><span class="n">ipa</span><span class="o">++</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_waiter_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">CTRL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">QETH_DBF_CTRL_LEN</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">irq_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">qeth_prepare_control_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">iob</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IPA</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
		<span class="n">event_timeout</span> <span class="o">=</span> <span class="n">QETH_IPA_TIMEOUT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">event_timeout</span> <span class="o">=</span> <span class="n">QETH_TIMEOUT</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">event_timeout</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;noirqpnd&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_start</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccw</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">iob</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s qeth_send_control_data: &quot;</span>
			<span class="s">&quot;ccw_device_start rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot; err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">qeth_put_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">qeth_release_buffer</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">iob</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">irq_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we have only one long running ipassist, since we can ensure</span>
<span class="cm">	   process context of this command we can sleep */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">IPA_CMD_SETIP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">prot_version</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">received</span><span class="p">),</span> <span class="n">event_timeout</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">time_err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">received</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">time_err</span><span class="p">;</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="p">};</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>
	<span class="n">qeth_put_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">time_err:</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">received</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">irq_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qeth_release_buffer</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">iob</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">buf_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">buf_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">QETH_CMD_BUFFER_NO</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>
	<span class="n">qeth_put_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_send_control_data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_cm_enable_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;cmenblcb&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">cm_filter_r</span><span class="p">,</span>
	       <span class="n">QETH_CM_ENABLE_RESP_FILTER_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  rc%d&quot;</span><span class="p">,</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_cm_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;cmenable&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_wait_for_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">CM_ENABLE</span><span class="p">,</span> <span class="n">CM_ENABLE_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_CM_ENABLE_ISSUER_RM_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">issuer_rm_r</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_CM_ENABLE_FILTER_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">cm_filter_w</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_control_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">CM_ENABLE_SIZE</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span>
				    <span class="n">qeth_cm_enable_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_cm_setup_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;cmsetpcb&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">cm_connection_r</span><span class="p">,</span>
	       <span class="n">QETH_CM_SETUP_RESP_DEST_ADDR</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  rc%d&quot;</span><span class="p">,</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_cm_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;cmsetup&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_wait_for_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">CM_SETUP</span><span class="p">,</span> <span class="n">CM_SETUP_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_CM_SETUP_DEST_ADDR</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">issuer_rm_r</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_CM_SETUP_CONNECTION_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">cm_connection_w</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_CM_SETUP_FILTER_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">cm_filter_r</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_control_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">CM_SETUP_SIZE</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span>
				    <span class="n">qeth_cm_setup_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qeth_get_initial_mtu_for_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_UNKNOWN</span>:
		<span class="k">return</span> <span class="mi">1500</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_IQD</span>:
		<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">max_mtu</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSD</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QETH_LINK_TYPE_HSTR</span>:
		<span class="k">case</span> <span class="n">QETH_LINK_TYPE_LANE_TR</span>:
			<span class="k">return</span> <span class="mi">2000</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">1492</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSM</span>:
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSX</span>:
		<span class="k">return</span> <span class="mi">1492</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1500</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qeth_get_mtu_outof_framesize</span><span class="p">(</span><span class="kt">int</span> <span class="n">framesize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">framesize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x4000</span>:
		<span class="k">return</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x6000</span>:
		<span class="k">return</span> <span class="mi">16384</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xa000</span>:
		<span class="k">return</span> <span class="mi">32768</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xffff</span>:
		<span class="k">return</span> <span class="mi">57344</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qeth_mtu_is_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSD</span>:
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSM</span>:
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSX</span>:
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_IQD</span>:
		<span class="k">return</span> <span class="p">((</span><span class="n">mtu</span> <span class="o">&gt;=</span> <span class="mi">576</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">mtu</span> <span class="o">&lt;=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">max_mtu</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSN</span>:
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_UNKNOWN</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_ulp_enable_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">__u16</span> <span class="n">mtu</span><span class="p">,</span> <span class="n">framesize</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">link_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ulpenacb&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">ulp_filter_r</span><span class="p">,</span>
	       <span class="n">QETH_ULP_ENABLE_RESP_FILTER_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">framesize</span><span class="p">,</span> <span class="n">QETH_ULP_ENABLE_RESP_MAX_MTU</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">mtu</span> <span class="o">=</span> <span class="n">qeth_get_mtu_outof_framesize</span><span class="p">(</span><span class="n">framesize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iob</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  rc%d&quot;</span><span class="p">,</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">initial_mtu</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">initial_mtu</span> <span class="o">!=</span> <span class="n">mtu</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* frame size has changed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">initial_mtu</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">mtu</span><span class="p">)))</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
			<span class="n">qeth_free_qdio_buffers</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">initial_mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">max_mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_size</span> <span class="o">=</span> <span class="n">mtu</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">initial_mtu</span> <span class="o">=</span> <span class="n">qeth_get_initial_mtu_for_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">max_mtu</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span><span class="n">QETH_ULP_ENABLE_RESP_MAX_MTU</span><span class="p">(</span>
			<span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_size</span> <span class="o">=</span> <span class="n">QETH_IN_BUF_SIZE_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">QETH_ULP_ENABLE_RESP_DIFINFO_LEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">QETH_MPC_DIFINFO_LEN_INDICATES_LINK_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link_type</span><span class="p">,</span>
		       <span class="n">QETH_ULP_ENABLE_RESP_LINK_TYPE</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span> <span class="o">=</span> <span class="n">link_type</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;link%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  rc%d&quot;</span><span class="p">,</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_ulp_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">prot_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="cm">/*FIXME: trace view callbacks*/</span>
	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ulpenabl&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_wait_for_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ULP_ENABLE</span><span class="p">,</span> <span class="n">ULP_ENABLE_SIZE</span><span class="p">);</span>

	<span class="o">*</span><span class="p">(</span><span class="n">QETH_ULP_ENABLE_LINKNUM</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">portno</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">layer2</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSN</span><span class="p">)</span>
			<span class="n">prot_type</span> <span class="o">=</span> <span class="n">QETH_PROT_OSN2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">prot_type</span> <span class="o">=</span> <span class="n">QETH_PROT_LAYER2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">prot_type</span> <span class="o">=</span> <span class="n">QETH_PROT_TCPIP</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_ULP_ENABLE_PROT_TYPE</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">prot_type</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_ULP_ENABLE_DEST_ADDR</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">cm_connection_r</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_ULP_ENABLE_FILTER_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">ulp_filter_w</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_ULP_ENABLE_PORTNAME_AND_LL</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">portname</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_control_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ULP_ENABLE_SIZE</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span>
				    <span class="n">qeth_ulp_enable_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_ulp_setup_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ulpstpcb&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">ulp_connection_r</span><span class="p">,</span>
	       <span class="n">QETH_ULP_SETUP_RESP_CONNECTION_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;00S&quot;</span><span class="p">,</span> <span class="n">QETH_ULP_SETUP_RESP_CONNECTION_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
		     <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;olmlimit&quot;</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A connection could not be &quot;</span>
			<span class="s">&quot;established because of an OLM limit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">iob</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMLINK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  rc%d&quot;</span><span class="p">,</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_ulp_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ulpsetup&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_wait_for_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ULP_SETUP</span><span class="p">,</span> <span class="n">ULP_SETUP_SIZE</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_ULP_SETUP_DEST_ADDR</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">cm_connection_r</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_ULP_SETUP_CONNECTION_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">ulp_connection_w</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_ULP_SETUP_FILTER_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">ulp_filter_r</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>

	<span class="n">ccw_device_get_id</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_ULP_SETUP_CUA</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">cula</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">unit_addr2</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_ULP_SETUP_REAL_DEVADDR</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_control_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ULP_SETUP_SIZE</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span>
				    <span class="n">qeth_ulp_setup_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_init_qdio_out_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">newbuf</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newbuf</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">qeth_qdio_outbuf_cache</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">newbuf</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">qdio_bufs</span><span class="p">[</span><span class="n">bidx</span><span class="p">];</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newbuf</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">);</span>
	<span class="n">lockdep_set_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newbuf</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdio_out_skb_queue_key</span><span class="p">);</span>
	<span class="n">newbuf</span><span class="o">-&gt;</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">newbuf</span><span class="o">-&gt;</span><span class="n">aob</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">newbuf</span><span class="o">-&gt;</span><span class="n">next_pending</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">bidx</span><span class="p">];</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newbuf</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_BUF_EMPTY</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">newbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">bufstates</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">bufstates</span><span class="p">[</span><span class="n">bidx</span><span class="p">].</span><span class="n">user</span> <span class="o">=</span> <span class="n">newbuf</span><span class="p">;</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;nbs%d&quot;</span><span class="p">,</span> <span class="n">bidx</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%lx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">newbuf</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%lx&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">newbuf</span><span class="o">-&gt;</span><span class="n">next_pending</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_alloc_qdio_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;allcqdbf&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_UNINITIALIZED</span><span class="p">,</span>
		<span class="n">QETH_QDIO_ALLOCATED</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QETH_QDIO_UNINITIALIZED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_q</span><span class="p">),</span>
				   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;inq&quot;</span><span class="p">);</span>
	<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_q</span><span class="p">));</span>
	<span class="cm">/* give inbound qeth_qdio_buffers their qdio_buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="o">-&gt;</span><span class="n">qdio_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* inbound buffer pool */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_alloc_buffer_pool</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_freeinq</span><span class="p">;</span>

	<span class="cm">/* outbound */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_freepool</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span><span class="p">),</span>
					       <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out_freeoutq</span><span class="p">;</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;outq %i&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue_no</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="cm">/* give outbound qeth_qdio_buffers their qdio_buffers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qeth_init_qdio_out_buf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">j</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_freeoutqbufs</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_alloc_cq</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_freeoutq</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_freeoutqbufs:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">--</span><span class="n">j</span><span class="p">;</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">qeth_qdio_outbuf_cache</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out_freeoutq:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="o">--</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">qeth_clear_outq_buffers</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out_freepool:</span>
	<span class="n">qeth_free_buffer_pool</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="nl">out_freeinq:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out_nomem:</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_UNINITIALIZED</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_create_qib_param_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">param_field</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">param_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ascebc</span><span class="p">[</span><span class="sc">&#39;P&#39;</span><span class="p">];</span>
	<span class="n">param_field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ascebc</span><span class="p">[</span><span class="sc">&#39;C&#39;</span><span class="p">];</span>
	<span class="n">param_field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ascebc</span><span class="p">[</span><span class="sc">&#39;I&#39;</span><span class="p">];</span>
	<span class="n">param_field</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ascebc</span><span class="p">[</span><span class="sc">&#39;T&#39;</span><span class="p">];</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">param_field</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> <span class="o">=</span> <span class="n">QETH_PCI_THRESHOLD_A</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">param_field</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span> <span class="o">=</span> <span class="n">QETH_PCI_THRESHOLD_B</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">param_field</span><span class="p">[</span><span class="mi">12</span><span class="p">]))</span> <span class="o">=</span> <span class="n">QETH_PCI_TIMER_VALUE</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_create_qib_param_field_blkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">param_field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">param_field</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ascebc</span><span class="p">[</span><span class="sc">&#39;B&#39;</span><span class="p">];</span>
	<span class="n">param_field</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ascebc</span><span class="p">[</span><span class="sc">&#39;L&#39;</span><span class="p">];</span>
	<span class="n">param_field</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ascebc</span><span class="p">[</span><span class="sc">&#39;K&#39;</span><span class="p">];</span>
	<span class="n">param_field</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ascebc</span><span class="p">[</span><span class="sc">&#39;T&#39;</span><span class="p">];</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">param_field</span><span class="p">[</span><span class="mi">20</span><span class="p">]))</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">blkt</span><span class="p">.</span><span class="n">time_total</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">param_field</span><span class="p">[</span><span class="mi">24</span><span class="p">]))</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">blkt</span><span class="p">.</span><span class="n">inter_packet</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">param_field</span><span class="p">[</span><span class="mi">28</span><span class="p">]))</span> <span class="o">=</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">blkt</span><span class="p">.</span><span class="n">inter_packet_jumbo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_qdio_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qdioact&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">qdio_activate</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_dm_act</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;dmact&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_wait_for_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">DM_ACT</span><span class="p">,</span> <span class="n">DM_ACT_SIZE</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_DM_ACT_DEST_ADDR</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">cm_connection_r</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_DM_ACT_CONNECTION_TOKEN</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">ulp_connection_r</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_control_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">DM_ACT_SIZE</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_mpc_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;mpcinit&quot;</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_issue_next_read</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;1err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_cm_enable</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;2err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_qdio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_cm_setup</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;3err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_qdio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_ulp_enable</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;4err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_qdio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_ulp_setup</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;5err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_qdio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_alloc_qdio_buffers</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;5err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_qdio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_qdio_establish</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;6err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">qeth_free_qdio_buffers</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_qdio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_qdio_activate</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;7err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_qdio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_dm_act</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;8err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_qdio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_qdio:</span>
	<span class="n">qeth_qdio_clear_card</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_print_status_with_portname</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">dbf_text</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">dbf_text</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">portname</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dbf_text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">_ebcasc</span><span class="p">[(</span><span class="n">__u8</span><span class="p">)</span> <span class="n">dbf_text</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
	<span class="n">dbf_text</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device is a%s card%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;with link type %s (portname: %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">qeth_get_cardname</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
	       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="s">&quot; (level: &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="s">&quot;)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="n">qeth_get_cardname_short</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
	       <span class="n">dbf_text</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_print_status_no_portname</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">portname</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device is a%s &quot;</span>
		       <span class="s">&quot;card%s%s%s</span><span class="se">\n</span><span class="s">with link type %s &quot;</span>
		       <span class="s">&quot;(no portname needed by interface).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qeth_get_cardname</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
		       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="s">&quot; (level: &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="s">&quot;)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">qeth_get_cardname_short</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device is a%s &quot;</span>
		       <span class="s">&quot;card%s%s%s</span><span class="se">\n</span><span class="s">with link type %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qeth_get_cardname</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
		       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="s">&quot; (level: &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="s">&quot;)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">qeth_get_cardname_short</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_print_status_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSD</span>:
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSM</span>:
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSX</span>:
		<span class="cm">/* VM will use a non-zero first character</span>
<span class="cm">		 * to indicate a HiperSockets like reporting</span>
<span class="cm">		 * of the level OSA sets the first character to zero</span>
<span class="cm">		 * */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">,</span> <span class="s">&quot;%02x%02x&quot;</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="n">QETH_MCL_LENGTH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_IQD</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">_ebcasc</span><span class="p">[(</span><span class="n">__u8</span><span class="p">)</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">_ebcasc</span><span class="p">[(</span><span class="n">__u8</span><span class="p">)</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">_ebcasc</span><span class="p">[(</span><span class="n">__u8</span><span class="p">)</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">2</span><span class="p">]];</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">_ebcasc</span><span class="p">[(</span><span class="n">__u8</span><span class="p">)</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">3</span><span class="p">]];</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="n">QETH_MCL_LENGTH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QETH_MCL_LENGTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">portname_required</span><span class="p">)</span>
		<span class="n">qeth_print_status_with_portname</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">qeth_print_status_no_portname</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_print_status_message</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_initialize_working_pool_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_buffer_pool_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;inwrklst&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">init_pool</span><span class="p">.</span><span class="n">entry_list</span><span class="p">,</span> <span class="n">init_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qeth_put_buffer_pool_entry</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">qeth_buffer_pool_entry</span> <span class="o">*</span><span class="nf">qeth_find_free_buffer_pool_entry</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">plh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_buffer_pool_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">free</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">entry_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">plh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">entry_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">plh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_buffer_pool_entry</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">free</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QETH_MAX_BUFFER_ELEMENTS</span><span class="p">(</span><span class="n">card</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">page_count</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">free</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* no free buffer in pool so take first one and swap pages */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">entry_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qeth_buffer_pool_entry</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QETH_MAX_BUFFER_ELEMENTS</span><span class="p">(</span><span class="n">card</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page_count</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">entry</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sg_alloc_page_rx</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_init_input_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_qdio_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_buffer_pool_entry</span> <span class="o">*</span><span class="n">pool_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">==</span> <span class="n">QETH_CQ_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">QETH_RX_PULL_LEN</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pool_entry</span> <span class="o">=</span> <span class="n">qeth_find_free_buffer_pool_entry</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pool_entry</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * since the buffer is accessed only from the input_tasklet</span>
<span class="cm">	 * there shouldn&#39;t be a need to synchronize; also, since we use</span>
<span class="cm">	 * the QETH_IN_BUF_REQUEUE_THRESHOLD we should never run  out off</span>
<span class="cm">	 * buffers</span>
<span class="cm">	 */</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">pool_entry</span> <span class="o">=</span> <span class="n">pool_entry</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QETH_MAX_BUFFER_ELEMENTS</span><span class="p">(</span><span class="n">card</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span>  <span class="n">pool_entry</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">QETH_MAX_BUFFER_ELEMENTS</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">SBAL_EFLAGS_LAST_ENTRY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_init_qdio_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;initqdqs&quot;</span><span class="p">);</span>

	<span class="cm">/* inbound queue */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="o">-&gt;</span><span class="n">qdio_bufs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">QDIO_MAX_BUFFERS_PER_Q</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_buffer</span><span class="p">));</span>
	<span class="n">qeth_initialize_working_pool_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="cm">/*give only as many buffers to hardware as we have buffer pool entries*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">qeth_init_input_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span> <span class="o">=</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">do_QDIO</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="n">QDIO_FLAG_SYNC_INPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;1err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* completion */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_cq_init</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* outbound queue */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">qdio_bufs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">QDIO_MAX_BUFFERS_PER_Q</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_buffer</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qeth_clear_output_buffer</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
					<span class="n">QETH_QDIO_BUF_EMPTY</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">do_pack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">used_buffers</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">set_pci_flags_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
			   <span class="n">QETH_OUT_Q_UNLOCKED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_init_qdio_queues</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u8</span> <span class="nf">qeth_get_ipa_adp_type</span><span class="p">(</span><span class="k">enum</span> <span class="n">qeth_link_types</span> <span class="n">link_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">link_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_LINK_TYPE_HSTR</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_fill_ipacmd_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">command</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">initiator</span> <span class="o">=</span> <span class="n">IPA_CMD_INITIATOR_HOST</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">.</span><span class="n">ipa</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">adapter_type</span> <span class="o">=</span> <span class="n">qeth_get_ipa_adp_type</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">rel_adapter_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">portno</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">layer2</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">prim_version_no</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">prim_version_no</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">param_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">prot_version</span> <span class="o">=</span> <span class="n">prot</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ipa_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ipa_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="nf">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">qeth_ipa_cmds</span> <span class="n">ipacmd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_wait_for_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">qeth_fill_ipacmd_header</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ipacmd</span><span class="p">,</span> <span class="n">prot</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">iob</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_get_ipacmd_buffer</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">qeth_prepare_ipa_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">,</span>
		<span class="kt">char</span> <span class="n">prot_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">IPA_PDU_HEADER</span><span class="p">,</span> <span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IPA_CMD_PROT_TYPE</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">prot_type</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IPA_CMD_DEST_ADDR</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">ulp_connection_r</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_prepare_ipa_cmd</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_send_ipa_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">reply_cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_reply</span><span class="o">*</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">reply_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">prot_type</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;sendipa&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">layer2</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSN</span><span class="p">)</span>
			<span class="n">prot_type</span> <span class="o">=</span> <span class="n">QETH_PROT_OSN2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">prot_type</span> <span class="o">=</span> <span class="n">QETH_PROT_LAYER2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">prot_type</span> <span class="o">=</span> <span class="n">QETH_PROT_TCPIP</span><span class="p">;</span>
	<span class="n">qeth_prepare_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">prot_type</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_control_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_CMD_LENGTH</span><span class="p">,</span>
						<span class="n">iob</span><span class="p">,</span> <span class="n">reply_cb</span><span class="p">,</span> <span class="n">reply_param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qeth_clear_ipacmd_list</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">qeth_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_send_ipa_cmd</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_send_startlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;strtlan&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_CMD_STARTLAN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_send_startlan</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_default_setadapterparms_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;defadpcb&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span> <span class="o">=</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_default_setadapterparms_cb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_query_setadapterparms_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;quyadpcb&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">query_cmds_supp</span><span class="p">.</span><span class="n">lan_type</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span> <span class="o">=</span>
		      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">query_cmds_supp</span><span class="p">.</span><span class="n">lan_type</span><span class="p">;</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;lnk %d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">adp</span><span class="p">.</span><span class="n">supported_funcs</span> <span class="o">=</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">query_cmds_supp</span><span class="p">.</span><span class="n">supported_cmds</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">qeth_default_setadapterparms_cb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="nf">qeth_get_adapter_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="n">__u32</span> <span class="n">command</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">cmdlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_CMD_SETADAPTERPARMS</span><span class="p">,</span>
				     <span class="n">QETH_PROT_IPV4</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmdlength</span> <span class="o">=</span> <span class="n">cmdlen</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">command_code</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">used_total</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq_no</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">iob</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_get_adapter_cmd</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_query_setadapterparms</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;queryadp&quot;</span><span class="p">);</span>
	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_adapter_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_QUERY_COMMANDS_SUPPORTED</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipacmd_setadpparms</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">qeth_query_setadapterparms_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_query_setadapterparms</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_query_ipassists_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qipasscb&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">prot_version</span> <span class="o">==</span> <span class="n">QETH_PROT_IPV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">ipa4</span><span class="p">.</span><span class="n">supported_funcs</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ipa_supported</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">ipa4</span><span class="p">.</span><span class="n">enabled_funcs</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ipa_enabled</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">ipa6</span><span class="p">.</span><span class="n">supported_funcs</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ipa_supported</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">ipa6</span><span class="p">.</span><span class="n">enabled_funcs</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ipa_enabled</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;suppenbl&quot;</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%08x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ipa_supported</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%08x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ipa_enabled</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_query_ipassists</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_prot_versions</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qipassi%i&quot;</span><span class="p">,</span> <span class="n">prot</span><span class="p">);</span>
	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_CMD_QIPASSIST</span><span class="p">,</span> <span class="n">prot</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">qeth_query_ipassists_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_query_ipassists</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_query_setdiagass_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;diagq:%x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">diagass_support</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">ext</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_query_setdiagass</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span>    <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qdiagass&quot;</span><span class="p">);</span>
	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_CMD_SET_DIAG_ASS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">subcmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">=</span> <span class="n">QETH_DIAGS_CMD_QUERY</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">qeth_query_setdiagass_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_get_trap_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_trap_id</span> <span class="o">*</span><span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">info</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sysinfo_2_2_2</span> <span class="o">*</span><span class="n">info222</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sysinfo_2_2_2</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sysinfo_3_2_2</span> <span class="o">*</span><span class="n">info322</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sysinfo_3_2_2</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="n">ccwid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">tid</span><span class="o">-&gt;</span><span class="n">chpid</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">chpid</span><span class="p">;</span>
	<span class="n">ccw_device_get_id</span><span class="p">(</span><span class="n">CARD_RDEV</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ccwid</span><span class="p">);</span>
	<span class="n">tid</span><span class="o">-&gt;</span><span class="n">ssid</span> <span class="o">=</span> <span class="n">ccwid</span><span class="p">.</span><span class="n">ssid</span><span class="p">;</span>
	<span class="n">tid</span><span class="o">-&gt;</span><span class="n">devno</span> <span class="o">=</span> <span class="n">ccwid</span><span class="p">.</span><span class="n">devno</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">stsi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">)</span>
		<span class="n">level</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">level</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">rc</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stsi</span><span class="p">(</span><span class="n">info222</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">))</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">lparnr</span> <span class="o">=</span> <span class="n">info222</span><span class="o">-&gt;</span><span class="n">lpar_number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stsi</span><span class="p">(</span><span class="n">info322</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EBCASC</span><span class="p">(</span><span class="n">info322</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info322</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">vmname</span><span class="p">,</span> <span class="n">info322</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">vmname</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">free_page</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_hw_trap_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;trapc:%x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_hw_trap</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_diags_trap_action</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;diagtrap&quot;</span><span class="p">);</span>
	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_ipacmd_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_CMD_SET_DIAG_ASS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">subcmd_len</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">=</span> <span class="n">QETH_DIAGS_CMD_TRAP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_DIAGS_TRAP_ARM</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="mh">0x0003</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">ext</span> <span class="o">=</span> <span class="mh">0x00010000</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_trap_id</span><span class="p">);</span>
		<span class="n">qeth_get_trap_id</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">qeth_trap_id</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">cdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_DIAGS_TRAP_DISARM</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">diagass</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_DIAGS_TRAP_CAPTURE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">qeth_hw_trap_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_hw_trap</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_check_qdio_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qdio_error</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dbftext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdio_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dbftext</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot; F15=%02X&quot;</span><span class="p">,</span>
			       <span class="n">buf</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">sflags</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot; F14=%02X&quot;</span><span class="p">,</span>
			       <span class="n">buf</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="n">sflags</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot; qerr=%X&quot;</span><span class="p">,</span> <span class="n">qdio_error</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">sflags</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x12</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_check_qdio_errors</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">qeth_buffer_reclaim_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_card</span><span class="p">,</span>
		<span class="n">buffer_reclaim_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;brw:%x&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">reclaim_index</span><span class="p">);</span>
	<span class="n">qeth_queue_input_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">reclaim_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_queue_input_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_q</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">lh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span><span class="p">)</span><span class="o">?</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">-</span>
		<span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span> <span class="o">-</span> <span class="n">index</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">-</span>
		<span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span> <span class="o">+</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span> <span class="o">-</span> <span class="n">index</span><span class="p">);</span>
	<span class="cm">/* only requeue at a certain threshold to avoid SIGAs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">QETH_IN_BUF_REQUEUE_THRESHOLD</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qeth_init_input_buffer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">]))</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">newcount</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">newcount</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we are in memory shortage so we switch back to</span>
<span class="cm">			   traditional skb allocation and drop packages */</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">force_alloc_skb</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">newcount</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">atomic_add_unless</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">force_alloc_skb</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">list_for_each</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">entry_list</span><span class="p">)</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_buf_pool</span><span class="p">.</span><span class="n">buf_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qsarbw&quot;</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">reclaim_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
				<span class="n">schedule_delayed_work</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">buffer_reclaim_work</span><span class="p">,</span>
					<span class="n">QETH_RECLAIM_WORK_TIME</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * according to old code it should be avoided to requeue all</span>
<span class="cm">		 * 128 buffers in order to benefit from PCI avoidance.</span>
<span class="cm">		 * this function keeps at least one buffer (the buffer at</span>
<span class="cm">		 * &#39;index&#39;) un-requeued -&gt; this buffer is the first buffer that</span>
<span class="cm">		 * will be requeued the next time</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">inbound_do_qdio_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">inbound_do_qdio_start_time</span> <span class="o">=</span>
				<span class="n">qeth_get_micros</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_QDIO</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="n">QDIO_FLAG_SYNC_INPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">inbound_do_qdio_time</span> <span class="o">+=</span>
				<span class="n">qeth_get_micros</span><span class="p">()</span> <span class="o">-</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">inbound_do_qdio_start_time</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qinberr&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span> <span class="o">=</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">%</span>
					  <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_queue_input_buffer</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_handle_send_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qdio_err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sbalf15</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">sflags</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;hdsnderr&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbalf15</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qdio_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">qdio_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">qeth_check_qdio_errors</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">qdio_err</span><span class="p">,</span> <span class="s">&quot;qouterr&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdio_err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QETH_SEND_ERROR_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sbalf15</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sbalf15</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QETH_SEND_ERROR_RETRY</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;lnkfail&quot;</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%04x %02x&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">qdio_err</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">sbalf15</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">QETH_SEND_ERROR_LINK_FAILURE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switched to packing state if the number of used buffers on a queue</span>
<span class="cm"> * reaches a certain limit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_switch_to_packing_if_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">do_pack</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">used_buffers</span><span class="p">)</span>
		    <span class="o">&gt;=</span> <span class="n">QETH_HIGH_WATERMARK_PACK</span><span class="p">){</span>
			<span class="cm">/* switch non-PACKING -&gt; PACKING */</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;np-&gt;pack&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
				<span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sc_dp_p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">do_pack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switches from packing to non-packing mode. If there is a packing</span>
<span class="cm"> * buffer on the queue this buffer will be prepared to be flushed.</span>
<span class="cm"> * In that case 1 is returned to inform the caller. If no buffer</span>
<span class="cm"> * has to be flushed, zero is returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_switch_to_nonpacking_if_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flush_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">do_pack</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">used_buffers</span><span class="p">)</span>
		    <span class="o">&lt;=</span> <span class="n">QETH_LOW_WATERMARK_PACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* switch PACKING -&gt; non-PACKING */</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;pack-&gt;np&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
				<span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sc_p_dp</span><span class="o">++</span><span class="p">;</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">do_pack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* flush packing buffers */</span>
			<span class="n">buffer</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span>
						<span class="n">QETH_QDIO_BUF_EMPTY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">next_element_to_fill</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
					   <span class="n">QETH_QDIO_BUF_PRIMED</span><span class="p">);</span>
				<span class="n">flush_count</span><span class="o">++</span><span class="p">;</span>
				<span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
					<span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">flush_count</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Called to flush a packing buffer if no more pci flags are on the queue.</span>
<span class="cm"> * Checks if there is a packing buffer and prepares it to be flushed.</span>
<span class="cm"> * In that case returns 1, otherwise zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_flush_buffers_on_no_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">QETH_QDIO_BUF_EMPTY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">next_element_to_fill</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* it&#39;s a packing buffer */</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_BUF_PRIMED</span><span class="p">);</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_flush_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qdio_flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">index</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bidx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">bidx</span><span class="p">];</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">next_element_to_fill</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">eflags</span> <span class="o">|=</span>
				<span class="n">SBAL_EFLAGS_LAST_ENTRY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufstates</span><span class="p">)</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufstates</span><span class="p">[</span><span class="n">bidx</span><span class="p">].</span><span class="n">user</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">do_pack</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">used_buffers</span><span class="p">)</span> <span class="o">&gt;=</span>
				<span class="p">(</span><span class="n">QETH_HIGH_WATERMARK_PACK</span> <span class="o">-</span>
				 <span class="n">QETH_WATERMARK_PACK_FUZZ</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">set_pci_flags_count</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* it&#39;s likely that we&#39;ll go to packing</span>
<span class="cm">				 * mode soon */</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">set_pci_flags_count</span><span class="p">);</span>
				<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sflags</span> <span class="o">|=</span> <span class="n">SBAL_SFLAGS0_PCI_REQ</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">set_pci_flags_count</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * there&#39;s no outstanding PCI any more, so we</span>
<span class="cm">				 * have to request a PCI to be sure the the PCI</span>
<span class="cm">				 * will wake at some time in the future then we</span>
<span class="cm">				 * can flush packed buffers that might still be</span>
<span class="cm">				 * hanging around, which can happen if no</span>
<span class="cm">				 * further send was requested by the stack</span>
<span class="cm">				 */</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">set_pci_flags_count</span><span class="p">);</span>
				<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sflags</span> <span class="o">|=</span> <span class="n">SBAL_SFLAGS0_PCI_REQ</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_do_qdio_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_do_qdio_start_time</span> <span class="o">=</span>
			<span class="n">qeth_get_micros</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">qdio_flags</span> <span class="o">=</span> <span class="n">QDIO_FLAG_SYNC_OUTPUT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">set_pci_flags_count</span><span class="p">))</span>
		<span class="n">qdio_flags</span> <span class="o">|=</span> <span class="n">QDIO_FLAG_PCI_OUT</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">do_QDIO</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">),</span> <span class="n">qdio_flags</span><span class="p">,</span>
		     <span class="n">queue</span><span class="o">-&gt;</span><span class="n">queue_no</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_do_qdio_time</span> <span class="o">+=</span>
			<span class="n">qeth_get_micros</span><span class="p">()</span> <span class="o">-</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_do_qdio_start_time</span><span class="p">;</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">used_buffers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="cm">/* ignore temporary SIGA errors without busy condition */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;flushbuf&quot;</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot; q%d&quot;</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">queue_no</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot; idx%d&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot; c%d&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot; err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

		<span class="cm">/* this must not happen under normal circumstances. if it</span>
<span class="cm">		 * happens something is really wrong -&gt; recover */</span>
		<span class="n">qeth_schedule_recovery</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">bufs_sent</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_check_outbound_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flush_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">q_was_packing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check if weed have to switch to non-packing mode or if</span>
<span class="cm">	 * we have to get a pci flag out on the queue</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">used_buffers</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">QETH_LOW_WATERMARK_PACK</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">set_pci_flags_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_OUT_Q_LOCKED_FLUSH</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">QETH_OUT_Q_UNLOCKED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we get in here, there was no action in</span>
<span class="cm">			 * do_send_packet. So, we check if there is a</span>
<span class="cm">			 * packing buffer to be flushed here.</span>
<span class="cm">			 */</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span><span class="p">;</span>
			<span class="n">q_was_packing</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">do_pack</span><span class="p">;</span>
			<span class="cm">/* queue-&gt;do_pack may change */</span>
			<span class="n">barrier</span><span class="p">();</span>
			<span class="n">flush_cnt</span> <span class="o">+=</span> <span class="n">qeth_switch_to_nonpacking_if_needed</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flush_cnt</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">set_pci_flags_count</span><span class="p">))</span>
				<span class="n">flush_cnt</span> <span class="o">+=</span>
					<span class="n">qeth_flush_buffers_on_no_pci</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span> <span class="o">&amp;&amp;</span>
			    <span class="n">q_was_packing</span><span class="p">)</span>
				<span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">bufs_sent_pack</span> <span class="o">+=</span>
					<span class="n">flush_cnt</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flush_cnt</span><span class="p">)</span>
				<span class="n">qeth_flush_buffers</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">flush_cnt</span><span class="p">);</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_OUT_Q_UNLOCKED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_qdio_start_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">ccwdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">card_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">)</span><span class="n">card_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_qdio_start_poll</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_configure_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">enum</span> <span class="n">qeth_cq</span> <span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">==</span>  <span class="n">QETH_CQ_NOTAVAILABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">==</span> <span class="n">cq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_STATE_DOWN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_STATE_RECOVER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">qeth_free_qdio_buffers</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">=</span> <span class="n">cq</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_configure_cq</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_qdio_cq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qdio_err</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first_element</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_q</span> <span class="o">*</span><span class="n">cq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_is_cq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">queue</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qcqhe%d&quot;</span><span class="p">,</span> <span class="n">first_element</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qcqhc%d&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qcqherr%d&quot;</span><span class="p">,</span> <span class="n">qdio_err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdio_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">qeth_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">cq_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">cq_start_time</span> <span class="o">=</span> <span class="n">qeth_get_micros</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first_element</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">first_element</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bidx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">qdio_bufs</span><span class="p">[</span><span class="n">bidx</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">e</span><span class="p">;</span>

		<span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_aob_addr</span><span class="p">;</span>

			<span class="n">phys_aob_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">qeth_qdio_handle_aob</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">phys_aob_addr</span><span class="p">);</span>
			<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">sflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="o">++</span><span class="n">e</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">sflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">do_QDIO</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="n">QDIO_FLAG_SYNC_INPUT</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span>
		    <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span><span class="p">,</span>
		    <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;QDIO reported an error, rc=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qcqherr&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="o">-&gt;</span><span class="n">next_buf_to_init</span>
				   <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">%</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">delta_t</span> <span class="o">=</span> <span class="n">qeth_get_micros</span><span class="p">();</span>
		<span class="n">delta_t</span> <span class="o">-=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">cq_start_time</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">cq_time</span> <span class="o">+=</span> <span class="n">delta_t</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_qdio_input_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">ccwdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qdio_err</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first_elem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">card_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">)</span><span class="n">card_ptr</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qihq%d&quot;</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qiec%d&quot;</span><span class="p">,</span> <span class="n">qdio_err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_is_cq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">queue</span><span class="p">))</span>
		<span class="n">qeth_qdio_cq_handler</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">qdio_err</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">first_elem</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qdio_err</span><span class="p">)</span>
		<span class="n">qeth_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>


<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_qdio_input_handler</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">qeth_qdio_output_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">ccwdev</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qdio_error</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first_element</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">card_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span>        <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">card_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">__queue</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;qdouhdl&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdio_error</span> <span class="o">&amp;</span> <span class="n">QDIO_ERROR_FATAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;achkcond&quot;</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">qeth_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_handler_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_handler_start_time</span> <span class="o">=</span>
			<span class="n">qeth_get_micros</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first_element</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">first_element</span> <span class="o">+</span> <span class="n">count</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bidx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">bidx</span><span class="p">];</span>
		<span class="n">qeth_handle_send_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">qdio_error</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufstates</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufstates</span><span class="p">[</span><span class="n">bidx</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span>
		     <span class="n">QDIO_OUTBUF_STATE_FLAG_PENDING</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">!=</span> <span class="n">QETH_CQ_ENABLED</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
					   <span class="n">QETH_QDIO_BUF_PRIMED</span><span class="p">,</span>
					   <span class="n">QETH_QDIO_BUF_PENDING</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">QETH_QDIO_BUF_PRIMED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qeth_notify_skbs</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
						 <span class="n">TX_NOTIFY_PENDING</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aob</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufstates</span><span class="p">[</span><span class="n">bidx</span><span class="p">].</span><span class="n">aob</span><span class="p">;</span>
			<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;pel%d&quot;</span><span class="p">,</span> <span class="n">bidx</span><span class="p">);</span>
			<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;aob&quot;</span><span class="p">);</span>
			<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;%lx&quot;</span><span class="p">,</span>
					<span class="n">virt_to_phys</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">aob</span><span class="p">));</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bidx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bidx</span> <span class="o">&gt;=</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qeth_init_qdio_out_buf</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">bidx</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;outofbuf&quot;</span><span class="p">);</span>
				<span class="n">qeth_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">==</span> <span class="n">QETH_CQ_ENABLED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">enum</span> <span class="n">iucv_tx_notify</span> <span class="n">n</span><span class="p">;</span>

				<span class="n">n</span> <span class="o">=</span> <span class="n">qeth_compute_cq_notification</span><span class="p">(</span>
					<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">sflags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">qeth_notify_skbs</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">qeth_clear_output_buffer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
						<span class="n">QETH_QDIO_BUF_EMPTY</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">qeth_cleanup_handled_pending</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">bidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atomic_sub</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">used_buffers</span><span class="p">);</span>
	<span class="cm">/* check if we need to do something on this outbound queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span>
		<span class="n">qeth_check_outbound_queue</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_handler_time</span> <span class="o">+=</span> <span class="n">qeth_get_micros</span><span class="p">()</span> <span class="o">-</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_handler_start_time</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_qdio_output_handler</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_get_priority_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">ipv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cast_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSD</span> <span class="o">||</span>
		     <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSX</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">default_out_queue</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cast_type</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">is_multicast_different</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">is_multicast_different</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">do_prio_queueing</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ipv</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="n">tos</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">do_prio_queueing</span> <span class="o">==</span>
				<span class="n">QETH_PRIO_Q_ING_TOS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tos</span> <span class="o">&amp;</span> <span class="n">IP_TOS_NOTIMPORTANT</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tos</span> <span class="o">&amp;</span> <span class="n">IP_TOS_HIGHRELIABILITY</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tos</span> <span class="o">&amp;</span> <span class="n">IP_TOS_HIGHTHROUGHPUT</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tos</span> <span class="o">&amp;</span> <span class="n">IP_TOS_LOWDELAY</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">do_prio_queueing</span> <span class="o">==</span>
				<span class="n">QETH_PRIO_Q_ING_PREC</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">3</span> <span class="o">-</span> <span class="p">(</span><span class="n">tos</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">do_prio_queueing</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ipv</span> <span class="o">==</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* TODO: IPv6!!! */</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">default_out_queue</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* fallthrough for single-out-queue 1920-device */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">default_out_queue</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_get_priority_queue</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_get_elements_no</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">elems</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">elements_needed</span> <span class="o">=</span> <span class="n">PFN_UP</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">dlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
		<span class="n">PFN_DOWN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">elements_needed</span> <span class="o">+=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">elements_needed</span> <span class="o">+</span> <span class="n">elems</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">QETH_MAX_BUFFER_ELEMENTS</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Invalid size of IP packet &quot;</span>
			<span class="s">&quot;(Number=%d / Length=%d). Discarded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">elements_needed</span><span class="o">+</span><span class="n">elems</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">elements_needed</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_get_elements_no</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_hdr_chk_and_bounce</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hroom</span><span class="p">,</span> <span class="n">inpage</span><span class="p">,</span> <span class="n">rest</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hroom</span> <span class="o">=</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">inpage</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">rest</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">inpage</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&gt;</span> <span class="n">hroom</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">rest</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-=</span> <span class="n">rest</span><span class="p">;</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;skb bounce len: %d rest: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rest</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_hdr_chk_and_bounce</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__qeth_fill_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_tso</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">next_element_to_fill</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length_here</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">element</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_lap</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_frag_struct</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>

	<span class="n">element</span> <span class="o">=</span> <span class="o">*</span><span class="n">next_element_to_fill</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">first_lap</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_tso</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">first_lap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* length_here is the remaining amount of data in this page */</span>
		<span class="n">length_here</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">data</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">length_here</span><span class="p">)</span>
			<span class="n">length_here</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">length_here</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">length_here</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first_lap</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span>
					<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span>
						<span class="n">SBAL_EFLAGS_FIRST_FRAG</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span>
				    <span class="n">SBAL_EFLAGS_MIDDLE_FRAG</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first_lap</span><span class="p">)</span>
				<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span>
				    <span class="n">SBAL_EFLAGS_FIRST_FRAG</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span>
				    <span class="n">SBAL_EFLAGS_MIDDLE_FRAG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">length_here</span><span class="p">;</span>
		<span class="n">element</span><span class="o">++</span><span class="p">;</span>
		<span class="n">first_lap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">page_to_phys</span><span class="p">(</span><span class="n">skb_frag_page</span><span class="p">(</span><span class="n">frag</span><span class="p">))</span>
			<span class="o">+</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">;</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">SBAL_EFLAGS_MIDDLE_FRAG</span><span class="p">;</span>
		<span class="n">element</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">eflags</span><span class="p">)</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">SBAL_EFLAGS_LAST_FRAG</span><span class="p">;</span>
	<span class="o">*</span><span class="n">next_element_to_fill</span> <span class="o">=</span> <span class="n">element</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qeth_fill_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hd_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flush_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">large_send</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">skb_list</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="cm">/*check first on TSO ....*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">QETH_HEADER_TYPE_TSO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">element</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next_element_to_fill</span><span class="p">;</span>

		<span class="n">hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr_tso</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">qeth_hdr_tso</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">dg_hdr_len</span><span class="p">;</span>
		<span class="cm">/*fill first buffer entry only with header information */</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">hdr_len</span><span class="p">;</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">SBAL_EFLAGS_FIRST_FRAG</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">next_element_to_fill</span><span class="o">++</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+=</span> <span class="n">hdr_len</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span>  <span class="o">-=</span> <span class="n">hdr_len</span><span class="p">;</span>
		<span class="n">large_send</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">element</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next_element_to_fill</span><span class="p">;</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">;</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span><span class="p">)</span> <span class="o">+</span>
							<span class="n">hd_len</span><span class="p">;</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">element</span><span class="p">].</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">SBAL_EFLAGS_FIRST_FRAG</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">is_header</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">next_element_to_fill</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__qeth_fill_buffer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">large_send</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">next_element_to_fill</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">do_pack</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;fillbfnp&quot;</span><span class="p">);</span>
		<span class="cm">/* set state to PRIMED -&gt; will be flushed */</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_BUF_PRIMED</span><span class="p">);</span>
		<span class="n">flush_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;fillbfpa&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">skbs_sent_pack</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">next_element_to_fill</span> <span class="o">&gt;=</span>
				<span class="n">QETH_MAX_BUFFER_ELEMENTS</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * packed buffer if full -&gt; set state PRIMED</span>
<span class="cm">			 * -&gt; will be flushed</span>
<span class="cm">			 */</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_BUF_PRIMED</span><span class="p">);</span>
			<span class="n">flush_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">flush_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_do_send_packet_fast</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">elements_needed</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hd_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/* spin until we get the queue ... */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_OUT_Q_UNLOCKED</span><span class="p">,</span>
			      <span class="n">QETH_OUT_Q_LOCKED</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QETH_OUT_Q_UNLOCKED</span><span class="p">);</span>
	<span class="cm">/* ... now we&#39;ve got the queue */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span><span class="p">;</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * check if buffer is empty to make sure that we do not &#39;overtake&#39;</span>
<span class="cm">	 * ourselves and try to fill a buffer that is already primed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QETH_QDIO_BUF_EMPTY</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span> <span class="o">=</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
					  <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_OUT_Q_UNLOCKED</span><span class="p">);</span>
	<span class="n">qeth_fill_buffer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">hd_len</span><span class="p">);</span>
	<span class="n">qeth_flush_buffers</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_OUT_Q_UNLOCKED</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_do_send_packet_fast</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_do_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_qdio_out_q</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">elements_needed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flush_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_pack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* spin until we get the queue ... */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_OUT_Q_UNLOCKED</span><span class="p">,</span>
			      <span class="n">QETH_OUT_Q_LOCKED</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QETH_OUT_Q_UNLOCKED</span><span class="p">);</span>
	<span class="n">start_index</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span><span class="p">;</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * check if buffer is empty to make sure that we do not &#39;overtake&#39;</span>
<span class="cm">	 * ourselves and try to fill a buffer that is already primed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QETH_QDIO_BUF_EMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_OUT_Q_UNLOCKED</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* check if we need to switch packing state of this queue */</span>
	<span class="n">qeth_switch_to_packing_if_needed</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">do_pack</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_pack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* does packet fit in current buffer? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">QETH_MAX_BUFFER_ELEMENTS</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">-</span>
		    <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">next_element_to_fill</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">elements_needed</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* ... no -&gt; set state PRIMED */</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_BUF_PRIMED</span><span class="p">);</span>
			<span class="n">flush_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
				<span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span>
			<span class="n">buffer</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span><span class="p">];</span>
			<span class="cm">/* we did a step forward, so check buffer state</span>
<span class="cm">			 * again */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="n">QETH_QDIO_BUF_EMPTY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qeth_flush_buffers</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span>
							   <span class="n">flush_count</span><span class="p">);</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
						<span class="n">QETH_OUT_Q_UNLOCKED</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">qeth_fill_buffer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span> <span class="o">=</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">%</span>
				  <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span>
	<span class="n">flush_count</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flush_count</span><span class="p">)</span>
		<span class="n">qeth_flush_buffers</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">flush_count</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">set_pci_flags_count</span><span class="p">))</span>
		<span class="n">atomic_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_OUT_Q_LOCKED_FLUSH</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * queue-&gt;state will go from LOCKED -&gt; UNLOCKED or from</span>
<span class="cm">	 * LOCKED_FLUSH -&gt; LOCKED if output_handler wanted to &#39;notify&#39; us</span>
<span class="cm">	 * (switch packing state or flush buffer to get another pci flag out).</span>
<span class="cm">	 * In that case we will enter this loop</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_dec_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flush_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">start_index</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">next_buf_to_fill</span><span class="p">;</span>
		<span class="cm">/* check if we can go back to non-packing state */</span>
		<span class="n">flush_count</span> <span class="o">+=</span> <span class="n">qeth_switch_to_nonpacking_if_needed</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * check if we need to flush a packing buffer to get a pci</span>
<span class="cm">		 * flag out on the queue</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flush_count</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">set_pci_flags_count</span><span class="p">))</span>
			<span class="n">flush_count</span> <span class="o">+=</span> <span class="n">qeth_flush_buffers_on_no_pci</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flush_count</span><span class="p">)</span>
			<span class="n">qeth_flush_buffers</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">flush_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* at this point the queue is UNLOCKED again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span> <span class="o">&amp;&amp;</span> <span class="n">do_pack</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">bufs_sent_pack</span> <span class="o">+=</span> <span class="n">flush_count</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_do_send_packet</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_setadp_promisc_mode_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipacmd_setadpparms</span> <span class="o">*</span><span class="n">setparms</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;prmadpcb&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">setparms</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">);</span>

	<span class="n">qeth_default_setadapterparms_cb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;prmrc%2.2x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">);</span>
		<span class="n">setparms</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">SET_PROMISC_MODE_OFF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">promisc_mode</span> <span class="o">=</span> <span class="n">setparms</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_setadp_promisc_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">qeth_ipa_promisc_modes</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setprom&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">promisc_mode</span> <span class="o">==</span> <span class="n">SET_PROMISC_MODE_ON</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">promisc_mode</span> <span class="o">==</span> <span class="n">SET_PROMISC_MODE_OFF</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">SET_PROMISC_MODE_OFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">SET_PROMISC_MODE_ON</span><span class="p">;</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;mode:%x&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_adapter_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_SET_PROMISC_MODE</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipacmd_setadpparms</span><span class="p">));</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">qeth_setadp_promisc_mode_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_setadp_promisc_mode</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">dbf_text</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;chgmtu&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">dbf_text</span><span class="p">,</span> <span class="s">&quot;%8x&quot;</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dbf_text</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_IP_FRAGMENTATION</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">qeth_mtu_is_valid</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_change_mtu</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">qeth_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;getstat&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_get_stats</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_setadpparms_change_macaddr_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;chgmaccb&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">layer2</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mac_bits</span> <span class="o">&amp;</span> <span class="n">QETH_LAYER2_MAC_READ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">change_addr</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
		       <span class="n">OSA_ADDR_LEN</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mac_bits</span> <span class="o">|=</span> <span class="n">QETH_LAYER2_MAC_READ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qeth_default_setadapterparms_cb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_setadpparms_change_macaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;chgmac&quot;</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_adapter_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_ALTER_MAC_ADDRESS</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipacmd_setadpparms</span><span class="p">));</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">change_addr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CHANGE_ADDR_READ_MAC</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">change_addr</span><span class="p">.</span><span class="n">addr_size</span> <span class="o">=</span> <span class="n">OSA_ADDR_LEN</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">change_addr</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">OSA_ADDR_LEN</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">qeth_setadpparms_change_macaddr_cb</span><span class="p">,</span>
			       <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_setadpparms_change_macaddr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_setadpparms_set_access_ctrl_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_set_access_ctrl</span> <span class="o">*</span><span class="n">access_ctrl_req</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setaccb&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">access_ctrl_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">set_access_ctrl</span><span class="p">;</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;setaccb&quot;</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;rc=%d&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_ACCESS_CTRL_RC_SUCCESS</span>:
	<span class="k">case</span> <span class="n">SET_ACCESS_CTRL_RC_ALREADY_NOT_ISOLATED</span>:
	<span class="k">case</span> <span class="n">SET_ACCESS_CTRL_RC_ALREADY_ISOLATED</span>:
	<span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">access_ctrl_req</span><span class="o">-&gt;</span><span class="n">subcmd_code</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">isolation</span> <span class="o">==</span> <span class="n">ISOLATION_MODE_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;QDIO data connection isolation is deactivated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;QDIO data connection isolation is activated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;OK:SET_ACCESS_CTRL(%s, %d)==%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">access_ctrl_req</span><span class="o">-&gt;</span><span class="n">subcmd_code</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SET_ACCESS_CTRL_RC_NOT_SUPPORTED</span>:
	<span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;ERR:SET_ACCESS_CTRL(%s,%d)==%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">access_ctrl_req</span><span class="o">-&gt;</span><span class="n">subcmd_code</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Adapter does not &quot;</span>
			<span class="s">&quot;support QDIO data connection isolation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* ensure isolation mode is &quot;none&quot; */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">ISOLATION_MODE_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SET_ACCESS_CTRL_RC_NONE_SHARED_ADAPTER</span>:
	<span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;ERR:SET_ACCESS_MODE(%s,%d)==%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">access_ctrl_req</span><span class="o">-&gt;</span><span class="n">subcmd_code</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Adapter is dedicated. &quot;</span>
			<span class="s">&quot;QDIO data connection isolation not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* ensure isolation mode is &quot;none&quot; */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">ISOLATION_MODE_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SET_ACCESS_CTRL_RC_ACTIVE_CHECKSUM_OFF</span>:
	<span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;ERR:SET_ACCESS_MODE(%s,%d)==%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">access_ctrl_req</span><span class="o">-&gt;</span><span class="n">subcmd_code</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;TSO does not permit QDIO data connection isolation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* ensure isolation mode is &quot;none&quot; */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">ISOLATION_MODE_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
	<span class="p">{</span>
		<span class="cm">/* this should never happen */</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;ERR:SET_ACCESS_MODE(%s,%d)==%d&quot;</span>
			<span class="s">&quot;==UNKNOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">access_ctrl_req</span><span class="o">-&gt;</span><span class="n">subcmd_code</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">);</span>

		<span class="cm">/* ensure isolation mode is &quot;none&quot; */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">ISOLATION_MODE_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">qeth_default_setadapterparms_cb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_setadpparms_set_access_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">qeth_ipa_isolation_modes</span> <span class="n">isolation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_set_access_ctrl</span> <span class="o">*</span><span class="n">access_ctrl_req</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setacctl&quot;</span><span class="p">);</span>

	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;setacctl&quot;</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_adapter_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_SET_ACCESS_CONTROL</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipacmd_setadpparms_hdr</span><span class="p">)</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_set_access_ctrl</span><span class="p">));</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">access_ctrl_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">set_access_ctrl</span><span class="p">;</span>
	<span class="n">access_ctrl_req</span><span class="o">-&gt;</span><span class="n">subcmd_code</span> <span class="o">=</span> <span class="n">isolation</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">qeth_setadpparms_set_access_ctrl_cb</span><span class="p">,</span>
			       <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;rc=%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_set_access_ctrl_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setactlo&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSD</span> <span class="o">||</span>
	     <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">qeth_adp_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_SET_ACCESS_CONTROL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_setadpparms_set_access_ctrl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">isolation</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>
				<span class="s">&quot;IPA(SET_ACCESS_CTRL,%s,%d) sent failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				<span class="n">rc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">isolation</span> <span class="o">!=</span> <span class="n">ISOLATION_MODE_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">ISOLATION_MODE_NONE</span><span class="p">;</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Adapter does not &quot;</span>
			<span class="s">&quot;support QDIO data connection isolation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_set_access_ctrl_online</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">qeth_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;txtimeo&quot;</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">qeth_schedule_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_tx_timeout</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">regnum</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MII_BMCR</span>: <span class="cm">/* Basic mode control register */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span> <span class="o">!=</span> <span class="n">QETH_LINK_TYPE_GBIT_ETH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span> <span class="o">!=</span> <span class="n">QETH_LINK_TYPE_OSN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span> <span class="o">!=</span> <span class="n">QETH_LINK_TYPE_10GBIT_ETH</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_BMSR</span>: <span class="cm">/* Basic mode status register */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BMSR_ERCAP</span> <span class="o">|</span> <span class="n">BMSR_ANEGCOMPLETE</span> <span class="o">|</span> <span class="n">BMSR_LSTATUS</span> <span class="o">|</span>
		     <span class="n">BMSR_10HALF</span> <span class="o">|</span> <span class="n">BMSR_10FULL</span> <span class="o">|</span> <span class="n">BMSR_100HALF</span> <span class="o">|</span> <span class="n">BMSR_100FULL</span> <span class="o">|</span>
		     <span class="n">BMSR_100BASE4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_PHYSID1</span>: <span class="cm">/* PHYS ID 1 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_PHYSID2</span>: <span class="cm">/* PHYS ID 2 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_ADVERTISE</span>: <span class="cm">/* Advertisement control reg */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ADVERTISE_ALL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_LPA</span>: <span class="cm">/* Link partner ability reg */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">LPA_10HALF</span> <span class="o">|</span> <span class="n">LPA_10FULL</span> <span class="o">|</span> <span class="n">LPA_100HALF</span> <span class="o">|</span> <span class="n">LPA_100FULL</span> <span class="o">|</span>
		     <span class="n">LPA_100BASE4</span> <span class="o">|</span> <span class="n">LPA_LPACK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_EXPANSION</span>: <span class="cm">/* Expansion register */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_DCOUNTER</span>: <span class="cm">/* disconnect counter */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_FCSCOUNTER</span>: <span class="cm">/* false carrier counter */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_NWAYTEST</span>: <span class="cm">/* N-way auto-neg test register */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_RERRCOUNTER</span>: <span class="cm">/* rx error counter */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_SREVISION</span>: <span class="cm">/* silicon revision */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_RESV1</span>: <span class="cm">/* reserved 1 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_LBRERROR</span>: <span class="cm">/* loopback, rx, bypass error */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_PHYADDR</span>: <span class="cm">/* physical address */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_RESV2</span>: <span class="cm">/* reserved 2 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_TPISTATUS</span>: <span class="cm">/* TPI status for 10mbps */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MII_NCONFIG</span>: <span class="cm">/* network interface config */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_mdio_read</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_send_ipa_snmp_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">reply_cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">reply_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;sendsnmp&quot;</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">IPA_PDU_HEADER</span><span class="p">,</span> <span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IPA_CMD_DEST_ADDR</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">ulp_connection_r</span><span class="p">,</span> <span class="n">QETH_MPC_TOKEN_LENGTH</span><span class="p">);</span>
	<span class="cm">/* adjust PDU length fields in IPA_PDU_HEADER */</span>
	<span class="n">s1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">IPA_PDU_HEADER_SIZE</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">s2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IPA_PDU_LEN_TOTAL</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">s1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IPA_PDU_LEN_PDU1</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">s2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IPA_PDU_LEN_PDU2</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">s2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">QETH_IPA_PDU_LEN_PDU3</span><span class="p">(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">s2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">qeth_send_control_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_PDU_HEADER_SIZE</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span>
				      <span class="n">reply_cb</span><span class="p">,</span> <span class="n">reply_param</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_snmp_command_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_arp_query_info</span> <span class="o">*</span><span class="n">qinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_snmp_cmd</span> <span class="o">*</span><span class="n">snmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">data_len</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;snpcmdcb&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">sdata</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span> <span class="o">-</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">qinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_arp_query_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="n">snmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">snmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;scer1%i&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span> <span class="o">=</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">;</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;scer2%i&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data_len</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span><span class="n">QETH_IPA_PDU_LEN_PDU1</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq_no</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">data_len</span> <span class="o">-=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">snmp</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">data_len</span> <span class="o">-=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">snmp</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* check if there is enough room in userspace */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata_len</span> <span class="o">-</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata_offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;scer3%i&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span> <span class="o">=</span> <span class="n">IPA_RC_ENOMEM</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;snore%i&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">used_total</span><span class="p">);</span>
	<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;sseqn%i&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq_no</span><span class="p">);</span>
	<span class="cm">/*copy entries to user buffer*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq_no</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata</span> <span class="o">+</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata_offset</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">snmp</span><span class="p">,</span>
		       <span class="n">data_len</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_snmp_cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">));</span>
		<span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata_offset</span> <span class="o">+=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_snmp_cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata</span> <span class="o">+</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata_offset</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">snmp</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">udata_offset</span> <span class="o">+=</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="cm">/* check if all replies received ... */</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;srtot%i&quot;</span><span class="p">,</span>
			       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">used_total</span><span class="p">);</span>
		<span class="n">QETH_CARD_TEXT_</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;srseq%i&quot;</span><span class="p">,</span>
			       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq_no</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq_no</span> <span class="o">&lt;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">used_total</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_snmp_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_snmp_ureq</span> <span class="o">*</span><span class="n">ureq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">req_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_arp_query_info</span> <span class="n">qinfo</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;snmpcmd&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">qeth_adp_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_SET_SNMP_CONTROL</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">layer2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* skip 4 bytes (data_len struct member) to get req_len */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req_len</span><span class="p">,</span> <span class="n">udata</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">ureq</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="n">req_len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_snmp_ureq_hdr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ureq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;snmpnome&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ureq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qinfo</span><span class="p">.</span><span class="n">udata_len</span> <span class="o">=</span> <span class="n">ureq</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_len</span><span class="p">;</span>
	<span class="n">qinfo</span><span class="p">.</span><span class="n">udata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">qinfo</span><span class="p">.</span><span class="n">udata_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qinfo</span><span class="p">.</span><span class="n">udata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ureq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qinfo</span><span class="p">.</span><span class="n">udata_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_snmp_ureq_hdr</span><span class="p">);</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_adapter_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_SET_SNMP_CONTROL</span><span class="p">,</span>
				   <span class="n">QETH_SNMP_SETADP_CMDLENGTH</span> <span class="o">+</span> <span class="n">req_len</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">snmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ureq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">req_len</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_snmp_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">QETH_SETADP_BASE_LEN</span> <span class="o">+</span> <span class="n">req_len</span><span class="p">,</span>
				    <span class="n">qeth_snmp_command_cb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">qinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;SNMP command failed on %s: (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">QETH_CARD_IFNAME</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="n">qinfo</span><span class="p">.</span><span class="n">udata</span><span class="p">,</span> <span class="n">qinfo</span><span class="p">.</span><span class="n">udata_len</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ureq</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">qinfo</span><span class="p">.</span><span class="n">udata</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_snmp_command</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_setadpparms_query_oat_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_reply</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_qoat_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">resdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resdatalen</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qoatcb&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qoat_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="n">resdatalen</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmdlength</span><span class="p">;</span>
	<span class="n">resdata</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">+</span> <span class="mi">28</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resdatalen</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">buffer_len</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">response_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">return_code</span> <span class="o">=</span> <span class="n">IPA_RC_FFFF</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">response_len</span><span class="p">),</span> <span class="n">resdata</span><span class="p">,</span>
		<span class="n">resdatalen</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">response_len</span> <span class="o">+=</span> <span class="n">resdatalen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq_no</span> <span class="o">&lt;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">used_total</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_query_oat_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_cmd_buffer</span> <span class="o">*</span><span class="n">iob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_query_oat</span> <span class="o">*</span><span class="n">oat_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_query_oat_data</span> <span class="n">oat_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_qoat_priv</span> <span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qoatcmd&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_adp_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_QUERY_OAT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oat_data</span><span class="p">,</span> <span class="n">udata</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_query_oat_data</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="p">.</span><span class="n">buffer_len</span> <span class="o">=</span> <span class="n">oat_data</span><span class="p">.</span><span class="n">buffer_len</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">.</span><span class="n">response_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span>  <span class="n">kzalloc</span><span class="p">(</span><span class="n">oat_data</span><span class="p">.</span><span class="n">buffer_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">.</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iob</span> <span class="o">=</span> <span class="n">qeth_get_adapter_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_QUERY_OAT</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipacmd_setadpparms_hdr</span><span class="p">)</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_query_oat</span><span class="p">));</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qeth_ipa_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">iob</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">IPA_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">oat_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">setadapterparms</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">query_oat</span><span class="p">;</span>
	<span class="n">oat_req</span><span class="o">-&gt;</span><span class="n">subcmd_code</span> <span class="o">=</span> <span class="n">oat_data</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_send_ipa_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iob</span><span class="p">,</span> <span class="n">qeth_setadpparms_query_oat_cb</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_compat_task</span><span class="p">())</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">oat_data</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">oat_data</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">priv</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span>
		    <span class="n">priv</span><span class="p">.</span><span class="n">response_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">oat_data</span><span class="p">.</span><span class="n">response_len</span> <span class="o">=</span> <span class="n">priv</span><span class="p">.</span><span class="n">response_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oat_data</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_query_oat_data</span><span class="p">)))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IPA_RC_FFFF</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_query_oat_command</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qeth_get_qdio_q_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_IQD</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_determine_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">prcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">ddev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ddev_offline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;detcapab&quot;</span><span class="p">);</span>
	<span class="n">ddev</span> <span class="o">=</span> <span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ddev_offline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_set_online</span><span class="p">(</span><span class="n">ddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;3err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_read_conf_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">prcd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s qeth_read_conf_data returned %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;5err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_offline</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qeth_configure_unitaddr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">prcd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ddev_offline</span><span class="p">)</span>
		<span class="n">qeth_configure_blkt_default</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">prcd</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">prcd</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_get_ssqd_desc</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ssqd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;6err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qfmt%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ssqd</span><span class="p">.</span><span class="n">qfmt</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ssqd</span><span class="p">.</span><span class="n">qdioac1</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ssqd</span><span class="p">.</span><span class="n">qdioac3</span><span class="p">);</span>
	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;icnt%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ssqd</span><span class="p">.</span><span class="n">icnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ssqd</span><span class="p">.</span><span class="n">qfmt</span> <span class="o">!=</span> <span class="n">QDIO_IQDIO_QFMT</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ssqd</span><span class="p">.</span><span class="n">qdioac1</span> <span class="o">&amp;</span> <span class="n">CHSC_AC1_INITIATE_INPUTQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ssqd</span><span class="p">.</span><span class="n">qdioac3</span> <span class="o">&amp;</span> <span class="n">CHSC_AC3_FORMAT2_CQ_AVAILABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Completion Queueing supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">=</span> <span class="n">QETH_CQ_NOTAVAILABLE</span><span class="p">;</span>
	<span class="p">}</span>


<span class="nl">out_offline:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ddev_offline</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">ddev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qeth_qdio_establish_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">**</span><span class="n">in_sbal_ptrs</span><span class="p">,</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">**</span><span class="n">queue_start_poll</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">==</span> <span class="n">QETH_CQ_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span> <span class="o">*</span>
			     <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span> <span class="o">*</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">in_sbal_ptrs</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">virt_to_phys</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">c_q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">queue_start_poll</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_qdio_establish</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_initialize</span> <span class="n">init_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">qib_param_field</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">**</span><span class="n">in_sbal_ptrs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">**</span><span class="n">queue_start_poll</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">**</span><span class="n">out_sbal_ptrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qdioest&quot;</span><span class="p">);</span>

	<span class="n">qib_param_field</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">QDIO_MAX_BUFFERS_PER_Q</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qib_param_field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span>  <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_nothing</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qeth_create_qib_param_field</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">qib_param_field</span><span class="p">);</span>
	<span class="n">qeth_create_qib_param_field_blkt</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">qib_param_field</span><span class="p">);</span>

	<span class="n">in_sbal_ptrs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span> <span class="o">*</span>
			       <span class="n">QDIO_MAX_BUFFERS_PER_Q</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
			       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_sbal_ptrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_qib_param</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in_sbal_ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">virt_to_phys</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">in_q</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">queue_start_poll</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span><span class="p">,</span>
				   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_start_poll</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_in_sbals</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">queue_start_poll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">start_poll</span><span class="p">;</span>

	<span class="n">qeth_qdio_establish_cq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">in_sbal_ptrs</span><span class="p">,</span> <span class="n">queue_start_poll</span><span class="p">);</span>

	<span class="n">out_sbal_ptrs</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span> <span class="o">*</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out_sbal_ptrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_queue_start_poll</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">,</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_sbal_ptrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_initialize</span><span class="p">));</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">cdev</span>                   <span class="o">=</span> <span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">q_format</span>               <span class="o">=</span> <span class="n">qeth_get_qdio_q_format</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">qib_param_field_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">qib_param_field</span>        <span class="o">=</span> <span class="n">qib_param_field</span><span class="p">;</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">no_input_qs</span>            <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_in_queues</span><span class="p">;</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">no_output_qs</span>           <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span><span class="p">;</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">input_handler</span> 	 <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">input_handler</span><span class="p">;</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">output_handler</span>	 <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">output_handler</span><span class="p">;</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">queue_start_poll_array</span> <span class="o">=</span> <span class="n">queue_start_poll</span><span class="p">;</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">int_parm</span>               <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">input_sbal_addr_array</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="n">in_sbal_ptrs</span><span class="p">;</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">output_sbal_addr_array</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="n">out_sbal_ptrs</span><span class="p">;</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">output_sbal_state_array</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_bufstates</span><span class="p">;</span>
	<span class="n">init_data</span><span class="p">.</span><span class="n">scan_threshold</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_ALLOCATED</span><span class="p">,</span>
		<span class="n">QETH_QDIO_ESTABLISHED</span><span class="p">)</span> <span class="o">==</span> <span class="n">QETH_QDIO_ALLOCATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_allocate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_ALLOCATED</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_establish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">QETH_QDIO_ALLOCATED</span><span class="p">);</span>
			<span class="n">qdio_free</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_CQ_ENABLED</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Completion Queue support enabled&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_CQ_DISABLED</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Completion Queue support disabled&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">out_sbal_ptrs</span><span class="p">);</span>
<span class="nl">out_free_queue_start_poll:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">queue_start_poll</span><span class="p">);</span>
<span class="nl">out_free_in_sbals:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">in_sbal_ptrs</span><span class="p">);</span>
<span class="nl">out_free_qib_param:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">qib_param_field</span><span class="p">);</span>
<span class="nl">out_free_nothing:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_core_free_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;freecrd&quot;</span><span class="p">);</span>
	<span class="n">QETH_DBF_HEX</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">qeth_clean_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
	<span class="n">qeth_clean_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ip_tbd_list</span><span class="p">);</span>
	<span class="n">qeth_free_qdio_buffers</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">unregister_service_level</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qeth_service_level</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_device_id</span> <span class="n">qeth_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">CCW_DEVICE_DEVTYPE</span><span class="p">(</span><span class="mh">0x1731</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x1732</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">),</span>
					<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">QETH_CARD_TYPE_OSD</span><span class="p">},</span>
	<span class="p">{</span><span class="n">CCW_DEVICE_DEVTYPE</span><span class="p">(</span><span class="mh">0x1731</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x1732</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">),</span>
					<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">},</span>
	<span class="p">{</span><span class="n">CCW_DEVICE_DEVTYPE</span><span class="p">(</span><span class="mh">0x1731</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x1732</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">),</span>
					<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">QETH_CARD_TYPE_OSN</span><span class="p">},</span>
	<span class="p">{</span><span class="n">CCW_DEVICE_DEVTYPE</span><span class="p">(</span><span class="mh">0x1731</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x1732</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">),</span>
					<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">QETH_CARD_TYPE_OSM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">CCW_DEVICE_DEVTYPE</span><span class="p">(</span><span class="mh">0x1731</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x1732</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">),</span>
					<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">QETH_CARD_TYPE_OSX</span><span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">qeth_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_driver</span> <span class="n">qeth_ccw_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;qeth&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">qeth_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ccwgroup_probe_ccwdev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">ccwgroup_remove_ccwdev</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">qeth_core_hardsetup_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;hrdsetup&quot;</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">force_alloc_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qeth_get_channel_path_desc</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="nl">retry:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retries</span><span class="p">)</span>
		<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s Retrying to do IDX activates.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">CARD_WDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="n">ccw_device_set_offline</span><span class="p">(</span><span class="n">CARD_RDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_set_online</span><span class="p">(</span><span class="n">CARD_RDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">retriable</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_set_online</span><span class="p">(</span><span class="n">CARD_WDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">retriable</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_set_online</span><span class="p">(</span><span class="n">CARD_DDEV</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">retriable</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_qdio_clear_card</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">);</span>
<span class="nl">retriable:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;break1&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;1err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qeth_determine_capabilities</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">qeth_init_tokens</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">qeth_init_func_level</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_idx_activate_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">,</span> <span class="n">qeth_idx_read_cb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;break2&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;3err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_idx_activate_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">,</span> <span class="n">qeth_idx_write_cb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;break3&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;4err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read_or_write_problem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_mpc_initialize</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;5err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">ipa4</span><span class="p">.</span><span class="n">supported_funcs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">adp</span><span class="p">.</span><span class="n">supported_funcs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">diagass_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qeth_query_ipassists</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_PROT_IPV4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_is_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADAPTERPARMS</span><span class="p">))</span>
		<span class="n">qeth_query_setadapterparms</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qeth_adp_supported</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">IPA_SETADP_SET_DIAG_ASSIST</span><span class="p">))</span>
		<span class="n">qeth_query_setdiagass</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The qeth device driver failed to recover &quot;</span>
		<span class="s">&quot;an error on the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">QETH_DBF_MESSAGE</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s Initialization in hardsetup failed! rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_core_hardsetup_card</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qeth_create_skb_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_buffer</span> <span class="o">*</span><span class="n">qethbuffer</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qdio_buffer_element</span> <span class="o">*</span><span class="n">element</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">pskb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pfrag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pskb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qethbuffer</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* only if qeth_card.options.cq == QETH_CQ_ENABLED */</span>
			<span class="o">*</span><span class="n">pskb</span> <span class="o">=</span> <span class="n">qethbuffer</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">;</span>
			<span class="n">qethbuffer</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">pskb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">QETH_RX_PULL_LEN</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">pskb</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb_reserve</span><span class="p">(</span><span class="o">*</span><span class="n">pskb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;=</span> <span class="n">QETH_RX_PULL_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="o">*</span><span class="n">pskb</span><span class="p">,</span> <span class="n">data_len</span><span class="p">),</span> <span class="n">element</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
				<span class="n">data_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">get_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="o">*</span><span class="n">pskb</span><span class="p">,</span> <span class="n">QETH_RX_PULL_LEN</span><span class="p">),</span>
			       <span class="n">element</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">QETH_RX_PULL_LEN</span><span class="p">);</span>
			<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="o">*</span><span class="n">pskb</span><span class="p">,</span> <span class="o">*</span><span class="n">pfrag</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span>
				<span class="n">offset</span> <span class="o">+</span> <span class="n">QETH_RX_PULL_LEN</span><span class="p">,</span>
				<span class="n">data_len</span> <span class="o">-</span> <span class="n">QETH_RX_PULL_LEN</span><span class="p">);</span>
			<span class="p">(</span><span class="o">*</span><span class="n">pskb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">data_len</span> <span class="o">-</span> <span class="n">QETH_RX_PULL_LEN</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">pskb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span>      <span class="o">+=</span> <span class="n">data_len</span> <span class="o">-</span> <span class="n">QETH_RX_PULL_LEN</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">pskb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">data_len</span> <span class="o">-</span> <span class="n">QETH_RX_PULL_LEN</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">pfrag</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">get_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="o">*</span><span class="n">pskb</span><span class="p">,</span> <span class="o">*</span><span class="n">pfrag</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pskb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">data_len</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pskb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span>      <span class="o">+=</span> <span class="n">data_len</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pskb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">data_len</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pfrag</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">qeth_core_get_next_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_qdio_buffer</span> <span class="o">*</span><span class="n">qethbuffer</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qdio_buffer_element</span> <span class="o">**</span><span class="n">__element</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">__offset</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qeth_hdr</span> <span class="o">**</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_buffer_element</span> <span class="o">*</span><span class="n">element</span> <span class="o">=</span> <span class="o">*</span><span class="n">__element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">qethbuffer</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="o">*</span><span class="n">__offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skb_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">headroom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">use_rx_sg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* qeth_hdr must not cross element boundaries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">offset</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qeth_is_last_sbale</span><span class="p">(</span><span class="n">element</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">element</span><span class="o">++</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">element</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">((</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l2</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_HEADER_TYPE_LAYER2</span>:
		<span class="n">skb_len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l2</span><span class="p">.</span><span class="n">pkt_length</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_HEADER_TYPE_LAYER3</span>:
		<span class="n">skb_len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">l3</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">headroom</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_HEADER_TYPE_OSN</span>:
		<span class="n">skb_len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">osn</span><span class="p">.</span><span class="n">pdu_length</span><span class="p">;</span>
		<span class="n">headroom</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">skb_len</span> <span class="o">&gt;=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">rx_sg_cb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSN</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">force_alloc_skb</span><span class="p">)))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">cq</span> <span class="o">==</span> <span class="n">QETH_CQ_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">use_rx_sg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">skb_len</span> <span class="o">+</span> <span class="n">headroom</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_mem</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">headroom</span><span class="p">)</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">headroom</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data_ptr</span> <span class="o">=</span> <span class="n">element</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">skb_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">skb_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">offset</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">use_rx_sg</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qeth_create_skb_frag</span><span class="p">(</span><span class="n">qethbuffer</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frag</span><span class="p">,</span> <span class="n">data_len</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">no_mem</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">data_len</span><span class="p">),</span> <span class="n">data_ptr</span><span class="p">,</span>
					<span class="n">data_len</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">skb_len</span> <span class="o">-=</span> <span class="n">data_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qeth_is_last_sbale</span><span class="p">(</span><span class="n">element</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;unexeob&quot;</span><span class="p">);</span>
				<span class="n">QETH_CARD_HEX</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">element</span><span class="o">++</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">data_ptr</span> <span class="o">=</span> <span class="n">element</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">data_len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">__element</span> <span class="o">=</span> <span class="n">element</span><span class="p">;</span>
	<span class="o">*</span><span class="n">__offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_rx_sg</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">performance_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sg_skbs_rx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sg_frags_rx</span> <span class="o">+=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="nl">no_mem:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">QETH_CARD_TEXT</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;noskbmem&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_core_get_next_skb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_unregister_dbf_views</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">QETH_DBF_INFOS</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">qeth_dbf</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">id</span><span class="p">);</span>
		<span class="n">qeth_dbf</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_dbf_longtext</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">dbf_txt_buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vsnprintf</span><span class="p">(</span><span class="n">dbf_txt_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dbf_txt_buf</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="n">debug_text_event</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">dbf_txt_buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_dbf_longtext</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_register_dbf_views</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">QETH_DBF_INFOS</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* register the areas */</span>
		<span class="n">qeth_dbf</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="n">qeth_dbf</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
						<span class="n">qeth_dbf</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">pages</span><span class="p">,</span>
						<span class="n">qeth_dbf</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">areas</span><span class="p">,</span>
						<span class="n">qeth_dbf</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qeth_dbf</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qeth_unregister_dbf_views</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* register a view */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">debug_register_view</span><span class="p">(</span><span class="n">qeth_dbf</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">id</span><span class="p">,</span> <span class="n">qeth_dbf</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">view</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qeth_unregister_dbf_views</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* set a passing level */</span>
		<span class="n">debug_set_level</span><span class="p">(</span><span class="n">qeth_dbf</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">id</span><span class="p">,</span> <span class="n">qeth_dbf</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">level</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qeth_core_load_discipline</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">qeth_discipline_id</span> <span class="n">discipline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_mod_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">discipline</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_DISCIPLINE_LAYER3</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span> <span class="o">=</span> <span class="n">try_then_request_module</span><span class="p">(</span>
			<span class="n">symbol_get</span><span class="p">(</span><span class="n">qeth_l3_discipline</span><span class="p">),</span> <span class="s">&quot;qeth_l3&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_DISCIPLINE_LAYER2</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span> <span class="o">=</span> <span class="n">try_then_request_module</span><span class="p">(</span>
			<span class="n">symbol_get</span><span class="p">(</span><span class="n">qeth_l2_discipline</span><span class="p">),</span> <span class="s">&quot;qeth_l2&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;There is no kernel module to &quot;</span>
			<span class="s">&quot;support discipline %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">discipline</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_mod_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qeth_core_free_discipline</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">layer2</span><span class="p">)</span>
		<span class="n">symbol_put</span><span class="p">(</span><span class="n">qeth_l2_discipline</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">symbol_put</span><span class="p">(</span><span class="n">qeth_l3_discipline</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">device_type</span> <span class="n">qeth_generic_devtype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;qeth_generic&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">qeth_generic_attr_groups</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">device_type</span> <span class="n">qeth_osn_devtype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;qeth_osn&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">qeth_osn_attr_groups</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_core_probe_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">dbf_name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;probedev&quot;</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">qeth_alloc_card</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;1err%d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">dbf_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dbf_name</span><span class="p">),</span> <span class="s">&quot;qeth_card_%s&quot;</span><span class="p">,</span>
		<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="n">dbf_name</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;qcdbf&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_card</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">.</span><span class="n">ccwdev</span>  <span class="o">=</span> <span class="n">gdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">ccwdev</span> <span class="o">=</span> <span class="n">gdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ccwdev</span>  <span class="o">=</span> <span class="n">gdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span> <span class="o">=</span> <span class="n">gdev</span><span class="p">;</span>
	<span class="n">gdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">qeth_irq</span><span class="p">;</span>
	<span class="n">gdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">qeth_irq</span><span class="p">;</span>
	<span class="n">gdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">qeth_irq</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_determine_card_type</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;3err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dbf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_setup_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QETH_DBF_TEXT_</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;2err%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dbf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_OSN</span><span class="p">)</span>
		<span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qeth_osn_devtype</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qeth_generic_devtype</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSN</span>:
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSM</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_core_load_discipline</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">QETH_DISCIPLINE_LAYER2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_dbf</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_disc</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSD</span>:
	<span class="k">case</span> <span class="n">QETH_CARD_TYPE_OSX</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_core_card_list</span><span class="p">.</span><span class="n">rwlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qeth_core_card_list</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_core_card_list</span><span class="p">.</span><span class="n">rwlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">qeth_determine_capabilities</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_disc:</span>
	<span class="n">qeth_core_free_discipline</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="nl">err_dbf:</span>
	<span class="n">debug_unregister</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">);</span>
<span class="nl">err_card:</span>
	<span class="n">qeth_core_free_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="nl">err_dev:</span>
	<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_core_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">QETH_DBF_TEXT</span><span class="p">(</span><span class="n">SETUP</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;removedv&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">gdev</span><span class="p">);</span>
		<span class="n">qeth_core_free_discipline</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">debug_unregister</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">);</span>
	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_core_card_list</span><span class="p">.</span><span class="n">rwlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_core_card_list</span><span class="p">.</span><span class="n">rwlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qeth_core_free_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_core_set_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">def_discipline</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span>
			<span class="n">def_discipline</span> <span class="o">=</span> <span class="n">QETH_DISCIPLINE_LAYER3</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">def_discipline</span> <span class="o">=</span> <span class="n">QETH_DISCIPLINE_LAYER2</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_core_load_discipline</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">def_discipline</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">gdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">set_online</span><span class="p">(</span><span class="n">gdev</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_core_set_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">set_offline</span><span class="p">(</span><span class="n">gdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_core_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">gdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_core_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">gdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qeth_core_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">(</span><span class="n">gdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_core_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">freeze</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">freeze</span><span class="p">(</span><span class="n">gdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_core_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">thaw</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">thaw</span><span class="p">(</span><span class="n">gdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qeth_core_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccwgroup_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">restore</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">restore</span><span class="p">(</span><span class="n">gdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccwgroup_driver</span> <span class="n">qeth_core_ccwgroup_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;qeth&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">qeth_core_probe_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">qeth_core_remove_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_online</span> <span class="o">=</span> <span class="n">qeth_core_set_online</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_offline</span> <span class="o">=</span> <span class="n">qeth_core_set_offline</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">qeth_core_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">qeth_core_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">complete</span> <span class="o">=</span> <span class="n">qeth_core_complete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">qeth_core_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span> <span class="o">=</span> <span class="n">qeth_core_thaw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">qeth_core_restore</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">qeth_core_driver_group_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddrv</span><span class="p">,</span>
					    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ccwgroup_create_dev</span><span class="p">(</span><span class="n">qeth_core_root_dev</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">qeth_core_ccwgroup_driver</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">qeth_core_driver_group_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">qeth_drv_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">driver_attr_group</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">qeth_drv_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">qeth_drv_attrs</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">qeth_drv_attr_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">qeth_drv_attr_group</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">qeth_ethtool_stats_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/*  0 */</span><span class="p">{</span><span class="s">&quot;rx skbs&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx buffers&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx skbs&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx buffers&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx skbs no packing&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx buffers no packing&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx skbs packing&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx buffers packing&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx sg skbs&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx sg frags&quot;</span><span class="p">},</span>
<span class="cm">/* 10 */</span><span class="p">{</span><span class="s">&quot;rx sg skbs&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx sg frags&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx sg page allocs&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx large kbytes&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx large count&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx pk state ch n-&gt;p&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx pk state ch p-&gt;n&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx pk watermark low&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx pk watermark high&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;queue 0 buffer usage&quot;</span><span class="p">},</span>
<span class="cm">/* 20 */</span><span class="p">{</span><span class="s">&quot;queue 1 buffer usage&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;queue 2 buffer usage&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;queue 3 buffer usage&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx poll time&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx poll count&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx do_QDIO time&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx do_QDIO count&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx handler time&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx handler count&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx time&quot;</span><span class="p">},</span>
<span class="cm">/* 30 */</span><span class="p">{</span><span class="s">&quot;tx count&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx do_QDIO time&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx do_QDIO count&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx csum&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx lin&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;cq handler count&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;cq handler time&quot;</span><span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">qeth_core_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stringset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">qeth_ethtool_stats_keys</span><span class="p">)</span> <span class="o">/</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_core_get_sset_count</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">qeth_core_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">-</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">initial_rx_packets</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">bufs_rec</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">-</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">initial_tx_packets</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">bufs_sent</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">initial_tx_packets</span>
			<span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">skbs_sent_pack</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">bufs_sent</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">bufs_sent_pack</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">skbs_sent_pack</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">bufs_sent_pack</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sg_skbs_sent</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sg_frags_sent</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sg_skbs_rx</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sg_frags_rx</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sg_alloc_page_rx</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">large_send_bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">large_send_cnt</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sc_dp_p</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">sc_p_dp</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">QETH_LOW_WATERMARK_PACK</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">QETH_HIGH_WATERMARK_PACK</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">used_buffers</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">used_buffers</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">used_buffers</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">no_out_queues</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">.</span><span class="n">out_qs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">used_buffers</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">inbound_time</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">inbound_cnt</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">inbound_do_qdio_time</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">inbound_do_qdio_cnt</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_handler_time</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_handler_cnt</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_time</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_cnt</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_do_qdio_time</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">outbound_do_qdio_cnt</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">tx_csum</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">tx_lin</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">cq_cnt</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">perf_stats</span><span class="p">.</span><span class="n">cq_time</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_core_get_ethtool_stats</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">qeth_core_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qeth_ethtool_stats_keys</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">qeth_ethtool_stats_keys</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_core_get_strings</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">qeth_core_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">layer2</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;qeth_l2&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;qeth_l3&quot;</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="s">&quot;1.0&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mcl_level</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;%s/%s/%s&quot;</span><span class="p">,</span>
			<span class="n">CARD_RDEV_ID</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
			<span class="n">CARD_WDEV_ID</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
			<span class="n">CARD_DDEV_ID</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_core_get_drvinfo</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">qeth_core_ethtool_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qeth_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">qeth_link_types</span> <span class="n">link_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QETH_CARD_TYPE_IQD</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">guestlan</span><span class="p">))</span>
		<span class="n">link_type</span> <span class="o">=</span> <span class="n">QETH_LINK_TYPE_10GBIT_ETH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">link_type</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">link_type</span><span class="p">;</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">link_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QETH_LINK_TYPE_FAST_ETH</span>:
	<span class="k">case</span> <span class="n">QETH_LINK_TYPE_LANE_ETH100</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
					<span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
					<span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
					<span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
					<span class="n">SUPPORTED_TP</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
					<span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
					<span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
					<span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span>
					<span class="n">ADVERTISED_TP</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QETH_LINK_TYPE_GBIT_ETH</span>:
	<span class="k">case</span> <span class="n">QETH_LINK_TYPE_LANE_ETH1000</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
					<span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
					<span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
					<span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
					<span class="n">SUPPORTED_1000baseT_Half</span> <span class="o">|</span>
					<span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
					<span class="n">SUPPORTED_FIBRE</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
					<span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
					<span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
					<span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span>
					<span class="n">ADVERTISED_1000baseT_Half</span> <span class="o">|</span>
					<span class="n">ADVERTISED_1000baseT_Full</span> <span class="o">|</span>
					<span class="n">ADVERTISED_FIBRE</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QETH_LINK_TYPE_10GBIT_ETH</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
					<span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
					<span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
					<span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
					<span class="n">SUPPORTED_1000baseT_Half</span> <span class="o">|</span>
					<span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
					<span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
					<span class="n">SUPPORTED_FIBRE</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
					<span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
					<span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
					<span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span>
					<span class="n">ADVERTISED_1000baseT_Half</span> <span class="o">|</span>
					<span class="n">ADVERTISED_1000baseT_Full</span> <span class="o">|</span>
					<span class="n">ADVERTISED_10000baseT_Full</span> <span class="o">|</span>
					<span class="n">ADVERTISED_FIBRE</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
					<span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
					<span class="n">SUPPORTED_TP</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
					<span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
					<span class="n">ADVERTISED_TP</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qeth_core_ethtool_get_settings</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">qeth_core_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;loading core functions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_core_card_list</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_core_card_list</span><span class="p">.</span><span class="n">rwlock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_mod_mutex</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qeth_register_dbf_views</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="n">qeth_core_root_dev</span> <span class="o">=</span> <span class="n">root_device_register</span><span class="p">(</span><span class="s">&quot;qeth&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">qeth_core_root_dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">qeth_core_root_dev</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">register_err</span><span class="p">;</span>
	<span class="n">qeth_core_header_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;qeth_hdr&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_core_header_cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">slab_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qeth_qdio_outbuf_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;qeth_buf&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qeth_qdio_out_buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qeth_qdio_outbuf_cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cqslab_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_ccw_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ccw_err</span><span class="p">;</span>
	<span class="n">qeth_core_ccwgroup_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">qeth_drv_attr_groups</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccwgroup_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_core_ccwgroup_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ccwgroup_err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">ccwgroup_err:</span>
	<span class="n">ccw_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_ccw_driver</span><span class="p">);</span>
<span class="nl">ccw_err:</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">qeth_qdio_outbuf_cache</span><span class="p">);</span>
<span class="nl">cqslab_err:</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">qeth_core_header_cache</span><span class="p">);</span>
<span class="nl">slab_err:</span>
	<span class="n">root_device_unregister</span><span class="p">(</span><span class="n">qeth_core_root_dev</span><span class="p">);</span>
<span class="nl">register_err:</span>
	<span class="n">qeth_unregister_dbf_views</span><span class="p">();</span>
<span class="nl">out_err:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Initializing the qeth device driver failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">qeth_core_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccwgroup_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_core_ccwgroup_driver</span><span class="p">);</span>
	<span class="n">ccw_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qeth_ccw_driver</span><span class="p">);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">qeth_qdio_outbuf_cache</span><span class="p">);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">qeth_core_header_cache</span><span class="p">);</span>
	<span class="n">root_device_unregister</span><span class="p">(</span><span class="n">qeth_core_root_dev</span><span class="p">);</span>
	<span class="n">qeth_unregister_dbf_views</span><span class="p">();</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;core functions removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">qeth_core_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">qeth_core_exit</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Frank Blaschka &lt;frank.blaschka@de.ibm.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;qeth core functions&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
