<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › net › netiucv.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>netiucv.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * IUCV network driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright IBM Corp. 2001, 2009</span>
<span class="cm"> *</span>
<span class="cm"> * Author(s):</span>
<span class="cm"> *	Original netiucv driver:</span>
<span class="cm"> *		Fritz Elfert (elfert@de.ibm.com, felfert@millenux.com)</span>
<span class="cm"> *	Sysfs integration and all bugs therein:</span>
<span class="cm"> *		Cornelia Huck (cornelia.huck@de.ibm.com)</span>
<span class="cm"> *	PM functions:</span>
<span class="cm"> *		Ursula Braun (ursula.braun@de.ibm.com)</span>
<span class="cm"> *</span>
<span class="cm"> * Documentation used:</span>
<span class="cm"> *  the source of the original IUCV driver by:</span>
<span class="cm"> *    Stefan Hegewald &lt;hegewald@de.ibm.com&gt;</span>
<span class="cm"> *    Hartmut Penner &lt;hpenner@de.ibm.com&gt;</span>
<span class="cm"> *    Denis Joseph Barrow (djbarrow@de.ibm.com,barrow_dj@yahoo.com)</span>
<span class="cm"> *    Martin Schwidefsky (schwidefsky@de.ibm.com)</span>
<span class="cm"> *    Alan Altmark (Alan_Altmark@us.ibm.com)  Sept. 2000</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;netiucv&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>

<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;net/dst.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/ebcdic.h&gt;</span>

<span class="cp">#include &lt;net/iucv/iucv.h&gt;</span>
<span class="cp">#include &quot;fsm.h&quot;</span>

<span class="n">MODULE_AUTHOR</span>
    <span class="p">(</span><span class="s">&quot;(C) 2001 IBM Corporation by Fritz Elfert (felfert@millenux.com)&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span> <span class="p">(</span><span class="s">&quot;Linux for S/390 IUCV network driver&quot;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Debug Facility stuff</span>
<span class="cm"> */</span>
<span class="cp">#define IUCV_DBF_SETUP_NAME &quot;iucv_setup&quot;</span>
<span class="cp">#define IUCV_DBF_SETUP_LEN 64</span>
<span class="cp">#define IUCV_DBF_SETUP_PAGES 2</span>
<span class="cp">#define IUCV_DBF_SETUP_NR_AREAS 1</span>
<span class="cp">#define IUCV_DBF_SETUP_LEVEL 3</span>

<span class="cp">#define IUCV_DBF_DATA_NAME &quot;iucv_data&quot;</span>
<span class="cp">#define IUCV_DBF_DATA_LEN 128</span>
<span class="cp">#define IUCV_DBF_DATA_PAGES 2</span>
<span class="cp">#define IUCV_DBF_DATA_NR_AREAS 1</span>
<span class="cp">#define IUCV_DBF_DATA_LEVEL 2</span>

<span class="cp">#define IUCV_DBF_TRACE_NAME &quot;iucv_trace&quot;</span>
<span class="cp">#define IUCV_DBF_TRACE_LEN 16</span>
<span class="cp">#define IUCV_DBF_TRACE_PAGES 4</span>
<span class="cp">#define IUCV_DBF_TRACE_NR_AREAS 1</span>
<span class="cp">#define IUCV_DBF_TRACE_LEVEL 3</span>

<span class="cp">#define IUCV_DBF_TEXT(name,level,text) \</span>
<span class="cp">	do { \</span>
<span class="cp">		debug_text_event(iucv_dbf_##name,level,text); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define IUCV_DBF_HEX(name,level,addr,len) \</span>
<span class="cp">	do { \</span>
<span class="cp">		debug_event(iucv_dbf_##name,level,(void*)(addr),len); \</span>
<span class="cp">	} while (0)</span>

<span class="n">DECLARE_PER_CPU</span><span class="p">(</span><span class="kt">char</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">iucv_dbf_txt_buf</span><span class="p">);</span>

<span class="cm">/* Allow to sort out low debug levels early to avoid wasted sprints */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">iucv_dbf_passes</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span><span class="n">dbf_grp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;=</span> <span class="n">dbf_grp</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define IUCV_DBF_TEXT_(name, level, text...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (iucv_dbf_passes(iucv_dbf_##name, level)) { \</span>
<span class="cp">			char* __buf = get_cpu_var(iucv_dbf_txt_buf); \</span>
<span class="cp">			sprintf(__buf, text); \</span>
<span class="cp">			debug_text_event(iucv_dbf_##name, level, __buf); \</span>
<span class="cp">			put_cpu_var(iucv_dbf_txt_buf); \</span>
<span class="cp">		} \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define IUCV_DBF_SPRINTF(name,level,text...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		debug_sprintf_event(iucv_dbf_trace, level, ##text ); \</span>
<span class="cp">		debug_sprintf_event(iucv_dbf_trace, level, text ); \</span>
<span class="cp">	} while (0)</span>

<span class="cm">/**</span>
<span class="cm"> * some more debug stuff</span>
<span class="cm"> */</span>
<span class="cp">#define IUCV_HEXDUMP16(importance,header,ptr) \</span>
<span class="cp">PRINT_##importance(header &quot;%02x %02x %02x %02x  %02x %02x %02x %02x  &quot; \</span>
<span class="cp">		   &quot;%02x %02x %02x %02x  %02x %02x %02x %02x\n&quot;, \</span>
<span class="cp">		   *(((char*)ptr)),*(((char*)ptr)+1),*(((char*)ptr)+2), \</span>
<span class="cp">		   *(((char*)ptr)+3),*(((char*)ptr)+4),*(((char*)ptr)+5), \</span>
<span class="cp">		   *(((char*)ptr)+6),*(((char*)ptr)+7),*(((char*)ptr)+8), \</span>
<span class="cp">		   *(((char*)ptr)+9),*(((char*)ptr)+10),*(((char*)ptr)+11), \</span>
<span class="cp">		   *(((char*)ptr)+12),*(((char*)ptr)+13), \</span>
<span class="cp">		   *(((char*)ptr)+14),*(((char*)ptr)+15)); \</span>
<span class="cp">PRINT_##importance(header &quot;%02x %02x %02x %02x  %02x %02x %02x %02x  &quot; \</span>
<span class="cp">		   &quot;%02x %02x %02x %02x  %02x %02x %02x %02x\n&quot;, \</span>
<span class="cp">		   *(((char*)ptr)+16),*(((char*)ptr)+17), \</span>
<span class="cp">		   *(((char*)ptr)+18),*(((char*)ptr)+19), \</span>
<span class="cp">		   *(((char*)ptr)+20),*(((char*)ptr)+21), \</span>
<span class="cp">		   *(((char*)ptr)+22),*(((char*)ptr)+23), \</span>
<span class="cp">		   *(((char*)ptr)+24),*(((char*)ptr)+25), \</span>
<span class="cp">		   *(((char*)ptr)+26),*(((char*)ptr)+27), \</span>
<span class="cp">		   *(((char*)ptr)+28),*(((char*)ptr)+29), \</span>
<span class="cp">		   *(((char*)ptr)+30),*(((char*)ptr)+31));</span>

<span class="cp">#define PRINTK_HEADER &quot; iucv: &quot;       </span><span class="cm">/* for debugging */</span><span class="cp"></span>

<span class="cm">/* dummy device to make sure netiucv_pm functions are called */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">netiucv_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">netiucv_pm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netiucv_pm_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netiucv_pm_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netiucv_pm_restore_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">netiucv_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">netiucv_pm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">complete</span> <span class="o">=</span> <span class="n">netiucv_pm_complete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">netiucv_pm_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span> <span class="o">=</span> <span class="n">netiucv_pm_restore_thaw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">netiucv_pm_restore_thaw</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="n">netiucv_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;netiucv&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">iucv_bus</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netiucv_pm_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">netiucv_callback_connreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="n">ipvmid</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">u8</span> <span class="n">ipuser</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netiucv_callback_connack</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ipuser</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netiucv_callback_connrej</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ipuser</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netiucv_callback_connsusp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ipuser</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netiucv_callback_connres</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ipuser</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netiucv_callback_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iucv_message</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netiucv_callback_txdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iucv_message</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iucv_handler</span> <span class="n">netiucv_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">path_pending</span>	  <span class="o">=</span> <span class="n">netiucv_callback_connreq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">path_complete</span>	  <span class="o">=</span> <span class="n">netiucv_callback_connack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">path_severed</span>	  <span class="o">=</span> <span class="n">netiucv_callback_connrej</span><span class="p">,</span>
	<span class="p">.</span><span class="n">path_quiesced</span>	  <span class="o">=</span> <span class="n">netiucv_callback_connsusp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">path_resumed</span>	  <span class="o">=</span> <span class="n">netiucv_callback_connres</span><span class="p">,</span>
	<span class="p">.</span><span class="n">message_pending</span>  <span class="o">=</span> <span class="n">netiucv_callback_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">message_complete</span> <span class="o">=</span> <span class="n">netiucv_callback_txdone</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Per connection profiling data</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">connection_profile</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maxmulti</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maxcqueue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">doios_single</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">doios_multi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">txlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">send_stamp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_pending</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_max_pending</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Representation of one iucv connection</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	  <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_path</span>	  <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>            <span class="o">*</span><span class="n">rx_buff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>            <span class="o">*</span><span class="n">tx_buff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span>       <span class="n">collect_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span>	  <span class="n">commit_queue</span><span class="p">;</span>
	<span class="n">spinlock_t</span>                <span class="n">collect_lock</span><span class="p">;</span>
	<span class="kt">int</span>                       <span class="n">collect_len</span><span class="p">;</span>
	<span class="kt">int</span>                       <span class="n">max_buffsize</span><span class="p">;</span>
	<span class="n">fsm_timer</span>                 <span class="n">timer</span><span class="p">;</span>
	<span class="n">fsm_instance</span>              <span class="o">*</span><span class="n">fsm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>         <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">connection_profile</span> <span class="n">prof</span><span class="p">;</span>
	<span class="kt">char</span>                      <span class="n">userid</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="kt">char</span>			  <span class="n">userdata</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Linked list of all connection structs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">iucv_connection_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Representation of event-data for the</span>
<span class="cm"> * connection state machine.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">iucv_event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">void</span>                   <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Private part of the network device structure</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>           <span class="n">tbusy</span><span class="p">;</span>
	<span class="n">fsm_instance</span>            <span class="o">*</span><span class="n">fsm</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">iucv_connection</span>  <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>           <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">pm_state</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Link level header for a packet.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ll_header</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define NETIUCV_HDRLEN		 (sizeof(struct ll_header))</span>
<span class="cp">#define NETIUCV_BUFSIZE_MAX	 65537</span>
<span class="cp">#define NETIUCV_BUFSIZE_DEFAULT  NETIUCV_BUFSIZE_MAX</span>
<span class="cp">#define NETIUCV_MTU_MAX          (NETIUCV_BUFSIZE_MAX - NETIUCV_HDRLEN)</span>
<span class="cp">#define NETIUCV_MTU_DEFAULT      9216</span>
<span class="cp">#define NETIUCV_QUEUELEN_DEFAULT 50</span>
<span class="cp">#define NETIUCV_TIMEOUT_5SEC     5000</span>

<span class="cm">/**</span>
<span class="cm"> * Compatibility macros for busy handling</span>
<span class="cm"> * of network devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">netiucv_clear_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tbusy</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">netiucv_test_and_set_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tbusy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">iucvMagic_ascii</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">iucvMagic_ebcdic</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Convert an iucv userId to its printable</span>
<span class="cm"> * form (strip whitespace at end).</span>
<span class="cm"> *</span>
<span class="cm"> * @param An iucv userId</span>
<span class="cm"> *</span>
<span class="cm"> * @returns The printable string (static data!!)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">netiucv_printname</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">tmp</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)))</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">netiucv_printuser</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">tmp_uid</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">tmp_udat</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">,</span> <span class="n">iucvMagic_ebcdic</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp_uid</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">tmp_udat</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_uid</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_uid</span><span class="p">,</span> <span class="n">netiucv_printname</span><span class="p">(</span><span class="n">tmp_uid</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_udat</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">EBCASC</span><span class="p">(</span><span class="n">tmp_udat</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_udat</span><span class="p">,</span> <span class="n">netiucv_printname</span><span class="p">(</span><span class="n">tmp_udat</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s.%s&quot;</span><span class="p">,</span> <span class="n">tmp_uid</span><span class="p">,</span> <span class="n">tmp_udat</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">netiucv_printname</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * States of the interface statemachine.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">dev_states</span> <span class="p">{</span>
	<span class="n">DEV_STATE_STOPPED</span><span class="p">,</span>
	<span class="n">DEV_STATE_STARTWAIT</span><span class="p">,</span>
	<span class="n">DEV_STATE_STOPWAIT</span><span class="p">,</span>
	<span class="n">DEV_STATE_RUNNING</span><span class="p">,</span>
	<span class="cm">/**</span>
<span class="cm">	 * MUST be always the last element!!</span>
<span class="cm">	 */</span>
	<span class="n">NR_DEV_STATES</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_state_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Stopped&quot;</span><span class="p">,</span>
	<span class="s">&quot;StartWait&quot;</span><span class="p">,</span>
	<span class="s">&quot;StopWait&quot;</span><span class="p">,</span>
	<span class="s">&quot;Running&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Events of the interface statemachine.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">dev_events</span> <span class="p">{</span>
	<span class="n">DEV_EVENT_START</span><span class="p">,</span>
	<span class="n">DEV_EVENT_STOP</span><span class="p">,</span>
	<span class="n">DEV_EVENT_CONUP</span><span class="p">,</span>
	<span class="n">DEV_EVENT_CONDOWN</span><span class="p">,</span>
	<span class="cm">/**</span>
<span class="cm">	 * MUST be always the last element!!</span>
<span class="cm">	 */</span>
	<span class="n">NR_DEV_EVENTS</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_event_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Start&quot;</span><span class="p">,</span>
	<span class="s">&quot;Stop&quot;</span><span class="p">,</span>
	<span class="s">&quot;Connection up&quot;</span><span class="p">,</span>
	<span class="s">&quot;Connection down&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Events of the connection statemachine</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">conn_events</span> <span class="p">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * Events, representing callbacks from</span>
<span class="cm">	 * lowlevel iucv layer)</span>
<span class="cm">	 */</span>
	<span class="n">CONN_EVENT_CONN_REQ</span><span class="p">,</span>
	<span class="n">CONN_EVENT_CONN_ACK</span><span class="p">,</span>
	<span class="n">CONN_EVENT_CONN_REJ</span><span class="p">,</span>
	<span class="n">CONN_EVENT_CONN_SUS</span><span class="p">,</span>
	<span class="n">CONN_EVENT_CONN_RES</span><span class="p">,</span>
	<span class="n">CONN_EVENT_RX</span><span class="p">,</span>
	<span class="n">CONN_EVENT_TXDONE</span><span class="p">,</span>

	<span class="cm">/**</span>
<span class="cm">	 * Events, representing errors return codes from</span>
<span class="cm">	 * calls to lowlevel iucv layer</span>
<span class="cm">	 */</span>

	<span class="cm">/**</span>
<span class="cm">	 * Event, representing timer expiry.</span>
<span class="cm">	 */</span>
	<span class="n">CONN_EVENT_TIMER</span><span class="p">,</span>

	<span class="cm">/**</span>
<span class="cm">	 * Events, representing commands from upper levels.</span>
<span class="cm">	 */</span>
	<span class="n">CONN_EVENT_START</span><span class="p">,</span>
	<span class="n">CONN_EVENT_STOP</span><span class="p">,</span>

	<span class="cm">/**</span>
<span class="cm">	 * MUST be always the last element!!</span>
<span class="cm">	 */</span>
	<span class="n">NR_CONN_EVENTS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">conn_event_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Remote connection request&quot;</span><span class="p">,</span>
	<span class="s">&quot;Remote connection acknowledge&quot;</span><span class="p">,</span>
	<span class="s">&quot;Remote connection reject&quot;</span><span class="p">,</span>
	<span class="s">&quot;Connection suspended&quot;</span><span class="p">,</span>
	<span class="s">&quot;Connection resumed&quot;</span><span class="p">,</span>
	<span class="s">&quot;Data received&quot;</span><span class="p">,</span>
	<span class="s">&quot;Data sent&quot;</span><span class="p">,</span>

	<span class="s">&quot;Timer&quot;</span><span class="p">,</span>

	<span class="s">&quot;Start&quot;</span><span class="p">,</span>
	<span class="s">&quot;Stop&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * States of the connection statemachine.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">conn_states</span> <span class="p">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * Connection not assigned to any device,</span>
<span class="cm">	 * initial state, invalid</span>
<span class="cm">	 */</span>
	<span class="n">CONN_STATE_INVALID</span><span class="p">,</span>

	<span class="cm">/**</span>
<span class="cm">	 * Userid assigned but not operating</span>
<span class="cm">	 */</span>
	<span class="n">CONN_STATE_STOPPED</span><span class="p">,</span>

	<span class="cm">/**</span>
<span class="cm">	 * Connection registered,</span>
<span class="cm">	 * no connection request sent yet,</span>
<span class="cm">	 * no connection request received</span>
<span class="cm">	 */</span>
	<span class="n">CONN_STATE_STARTWAIT</span><span class="p">,</span>

	<span class="cm">/**</span>
<span class="cm">	 * Connection registered and connection request sent,</span>
<span class="cm">	 * no acknowledge and no connection request received yet.</span>
<span class="cm">	 */</span>
	<span class="n">CONN_STATE_SETUPWAIT</span><span class="p">,</span>

	<span class="cm">/**</span>
<span class="cm">	 * Connection up and running idle</span>
<span class="cm">	 */</span>
	<span class="n">CONN_STATE_IDLE</span><span class="p">,</span>

	<span class="cm">/**</span>
<span class="cm">	 * Data sent, awaiting CONN_EVENT_TXDONE</span>
<span class="cm">	 */</span>
	<span class="n">CONN_STATE_TX</span><span class="p">,</span>

	<span class="cm">/**</span>
<span class="cm">	 * Error during registration.</span>
<span class="cm">	 */</span>
	<span class="n">CONN_STATE_REGERR</span><span class="p">,</span>

	<span class="cm">/**</span>
<span class="cm">	 * Error during registration.</span>
<span class="cm">	 */</span>
	<span class="n">CONN_STATE_CONNERR</span><span class="p">,</span>

	<span class="cm">/**</span>
<span class="cm">	 * MUST be always the last element!!</span>
<span class="cm">	 */</span>
	<span class="n">NR_CONN_STATES</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">conn_state_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Invalid&quot;</span><span class="p">,</span>
	<span class="s">&quot;Stopped&quot;</span><span class="p">,</span>
	<span class="s">&quot;StartWait&quot;</span><span class="p">,</span>
	<span class="s">&quot;SetupWait&quot;</span><span class="p">,</span>
	<span class="s">&quot;Idle&quot;</span><span class="p">,</span>
	<span class="s">&quot;TX&quot;</span><span class="p">,</span>
	<span class="s">&quot;Terminating&quot;</span><span class="p">,</span>
	<span class="s">&quot;Registration error&quot;</span><span class="p">,</span>
	<span class="s">&quot;Connect error&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * Debug Facility Stuff</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">debug_info_t</span> <span class="o">*</span><span class="n">iucv_dbf_setup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">debug_info_t</span> <span class="o">*</span><span class="n">iucv_dbf_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">debug_info_t</span> <span class="o">*</span><span class="n">iucv_dbf_trace</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="kt">char</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">iucv_dbf_txt_buf</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iucv_unregister_dbf_views</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iucv_dbf_setup</span><span class="p">)</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">iucv_dbf_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iucv_dbf_data</span><span class="p">)</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">iucv_dbf_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iucv_dbf_trace</span><span class="p">)</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">iucv_dbf_trace</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iucv_register_dbf_views</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iucv_dbf_setup</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="n">IUCV_DBF_SETUP_NAME</span><span class="p">,</span>
					<span class="n">IUCV_DBF_SETUP_PAGES</span><span class="p">,</span>
					<span class="n">IUCV_DBF_SETUP_NR_AREAS</span><span class="p">,</span>
					<span class="n">IUCV_DBF_SETUP_LEN</span><span class="p">);</span>
	<span class="n">iucv_dbf_data</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="n">IUCV_DBF_DATA_NAME</span><span class="p">,</span>
				       <span class="n">IUCV_DBF_DATA_PAGES</span><span class="p">,</span>
				       <span class="n">IUCV_DBF_DATA_NR_AREAS</span><span class="p">,</span>
				       <span class="n">IUCV_DBF_DATA_LEN</span><span class="p">);</span>
	<span class="n">iucv_dbf_trace</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="n">IUCV_DBF_TRACE_NAME</span><span class="p">,</span>
					<span class="n">IUCV_DBF_TRACE_PAGES</span><span class="p">,</span>
					<span class="n">IUCV_DBF_TRACE_NR_AREAS</span><span class="p">,</span>
					<span class="n">IUCV_DBF_TRACE_LEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">iucv_dbf_setup</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">iucv_dbf_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">iucv_dbf_trace</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">iucv_unregister_dbf_views</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">iucv_dbf_setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">iucv_dbf_setup</span><span class="p">,</span> <span class="n">IUCV_DBF_SETUP_LEVEL</span><span class="p">);</span>

	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">iucv_dbf_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">iucv_dbf_data</span><span class="p">,</span> <span class="n">IUCV_DBF_DATA_LEVEL</span><span class="p">);</span>

	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">iucv_dbf_trace</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">iucv_dbf_trace</span><span class="p">,</span> <span class="n">IUCV_DBF_TRACE_LEVEL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Callback-wrappers, called from lowlevel iucv layer.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_callback_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iucv_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_event</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">ev</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">fsm_event</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_EVENT_RX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_callback_txdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iucv_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_event</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">ev</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
	<span class="n">ev</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">fsm_event</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_EVENT_TXDONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_callback_connack</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ipuser</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">fsm_event</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_EVENT_CONN_ACK</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netiucv_callback_connreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="n">ipvmid</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">u8</span> <span class="n">ipuser</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_event</span> <span class="n">ev</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">tmp_user</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">tmp_udat</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_user</span><span class="p">,</span> <span class="n">netiucv_printname</span><span class="p">(</span><span class="n">ipvmid</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_udat</span><span class="p">,</span> <span class="n">ipuser</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">EBCASC</span><span class="p">(</span><span class="n">tmp_udat</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iucv_connection_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ipvmid</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">strncmp</span><span class="p">(</span><span class="n">ipuser</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Found a matching connection for this path. */</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
		<span class="n">fsm_event</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_EVENT_CONN_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Connection requested for %s.%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">tmp_user</span><span class="p">,</span> <span class="n">netiucv_printname</span><span class="p">(</span><span class="n">tmp_udat</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_callback_connrej</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ipuser</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">fsm_event</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_EVENT_CONN_REJ</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_callback_connsusp</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ipuser</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">fsm_event</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_EVENT_CONN_SUS</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_callback_connres</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ipuser</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">fsm_event</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_EVENT_CONN_RES</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * NOP action for statemachines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_action_nop</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Actions of the connection statemachine</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * netiucv_unpack_skb</span>
<span class="cm"> * @conn: The connection where this skb has been received.</span>
<span class="cm"> * @pskb: The received skb.</span>
<span class="cm"> *</span>
<span class="cm"> * Unpack a just received skb and hand it over to upper layers.</span>
<span class="cm"> * Helper function for conn_action_rx.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_unpack_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pskb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>     <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span>   <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">pskb</span><span class="p">,</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">);</span>
	<span class="n">pskb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">pskb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
	<span class="n">pskb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ll_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ll_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">skb_pull</span><span class="p">(</span><span class="n">pskb</span><span class="p">,</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">);</span>
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">-=</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">pskb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Illegal next field: %d &gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">header</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">pskb</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">pskb</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">pskb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">pskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				<span class="s">&quot;Out of memory in netiucv_unpack_skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">pskb</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
					  <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">pskb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
		<span class="n">pskb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Since receiving is always initiated from a tasklet (in iucv.c),</span>
<span class="cm">		 * we must use netif_rx_ni() instead of netif_rx()</span>
<span class="cm">		 */</span>
		<span class="n">netif_rx_ni</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">pskb</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">pskb</span><span class="p">,</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conn_action_rx</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_event</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iucv_message_reject</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			      <span class="s">&quot;Received data for unlinked connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_buffsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iucv_message_reject</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;msglen %d &gt; max_buffsize %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_buffsize</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">iucv_message_receive</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;rc %d from iucv_receive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netiucv_unpack_skb</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conn_action_txdone</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_event</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_message</span> <span class="n">txmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">single_flag</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txpackets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat_maxcq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saveflags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ll_header</span> <span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)</span>
		<span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_pending</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">single_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">commit_queue</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span>
					<span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">NETIUCV_HDRLEN</span>
						  <span class="o">-</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_lock</span><span class="p">,</span> <span class="n">saveflags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">header</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">,</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span>
		       <span class="n">NETIUCV_HDRLEN</span><span class="p">);</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					  <span class="n">skb_put</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
					  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">txbytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">txpackets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">stat_maxcq</span><span class="o">++</span><span class="p">;</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_len</span> <span class="o">&gt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">maxmulti</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">maxmulti</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_len</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_lock</span><span class="p">,</span> <span class="n">saveflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_IDLE</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">header</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">,</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">send_stamp</span> <span class="o">=</span> <span class="n">current_kernel_time</span><span class="p">();</span>
	<span class="n">txmsg</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txmsg</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">iucv_message_send</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txmsg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">doios_multi</span><span class="o">++</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">txlen</span> <span class="o">+=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_pending</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_max_pending</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_pending</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_pending</span><span class="o">--</span><span class="p">;</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_IDLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="p">)</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="n">txpackets</span><span class="p">;</span>
		<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;rc %d from iucv_send</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">txpackets</span><span class="p">;</span>
			<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">txbytes</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat_maxcq</span> <span class="o">&gt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">maxcqueue</span><span class="p">)</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">maxcqueue</span> <span class="o">=</span> <span class="n">stat_maxcq</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conn_action_connaccept</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_event</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">msglim</span> <span class="o">=</span> <span class="n">NETIUCV_QUEUELEN_DEFAULT</span><span class="p">;</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">iucv_path_accept</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netiucv_handler</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">userdata</span> <span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;rc %d from iucv_accept&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_IDLE</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">msglim</span><span class="p">;</span>
	<span class="n">fsm_event</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">DEV_EVENT_CONUP</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conn_action_connreject</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_event</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_path</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">iucv_path_sever</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conn_action_connack</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_IDLE</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">msglim</span><span class="p">;</span>
	<span class="n">fsm_event</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">DEV_EVENT_CONUP</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conn_action_conntimsev</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">iucv_path_sever</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">);</span>
	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_STARTWAIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conn_action_connsever</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">iucv_path_sever</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The peer z/VM guest %s has closed the &quot;</span>
			       <span class="s">&quot;connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netiucv_printuser</span><span class="p">(</span><span class="n">conn</span><span class="p">));</span>
	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		      <span class="s">&quot;conn_action_connsever: Remote dropped connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_STARTWAIT</span><span class="p">);</span>
	<span class="n">fsm_event</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">DEV_EVENT_CONDOWN</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conn_action_start</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_STARTWAIT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must set the state before calling iucv_connect because the</span>
<span class="cm">	 * callback handler could be called at any point after the connection</span>
<span class="cm">	 * request is sent</span>
<span class="cm">	 */</span>

	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_SETUPWAIT</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="n">iucv_path_alloc</span><span class="p">(</span><span class="n">NETIUCV_QUEUELEN_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: connecting to %s ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">netiucv_printuser</span><span class="p">(</span><span class="n">conn</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">iucv_path_connect</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netiucv_handler</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">,</span>
			       <span class="nb">NULL</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">msglim</span><span class="p">;</span>
		<span class="n">fsm_addtimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">NETIUCV_TIMEOUT_5SEC</span><span class="p">,</span>
			     <span class="n">CONN_EVENT_TIMER</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The IUCV device failed to connect to z/VM guest %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">netiucv_printname</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_STARTWAIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The IUCV device failed to connect to the peer on z/VM&quot;</span>
			<span class="s">&quot; guest %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netiucv_printname</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_STARTWAIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Connecting the IUCV device would exceed the maximum&quot;</span>
			<span class="s">&quot; number of IUCV connections</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_CONNERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;z/VM guest %s has too many IUCV connections&quot;</span>
			<span class="s">&quot; to connect with the IUCV device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">netiucv_printname</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_CONNERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The IUCV device cannot connect to a z/VM guest with no&quot;</span>
			<span class="s">&quot; IUCV authorization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_CONNERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Connecting the IUCV device failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">);</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_CONNERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;iucv_connect rc is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_purge_skb_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conn_action_stop</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_event</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">CONN_STATE_STOPPED</span><span class="p">);</span>
	<span class="n">netiucv_purge_skb_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;calling iucv_path_sever</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">iucv_path_sever</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netiucv_purge_skb_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">commit_queue</span><span class="p">);</span>
	<span class="n">fsm_event</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">DEV_EVENT_CONDOWN</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">conn_action_inval</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(&#39;%s&#39;): conn_action_inval called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">fsm_node</span> <span class="n">conn_fsm</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">CONN_STATE_INVALID</span><span class="p">,</span>   <span class="n">CONN_EVENT_START</span><span class="p">,</span>    <span class="n">conn_action_inval</span>      <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_STOPPED</span><span class="p">,</span>   <span class="n">CONN_EVENT_START</span><span class="p">,</span>    <span class="n">conn_action_start</span>      <span class="p">},</span>

	<span class="p">{</span> <span class="n">CONN_STATE_STOPPED</span><span class="p">,</span>   <span class="n">CONN_EVENT_STOP</span><span class="p">,</span>     <span class="n">conn_action_stop</span>       <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_STARTWAIT</span><span class="p">,</span> <span class="n">CONN_EVENT_STOP</span><span class="p">,</span>     <span class="n">conn_action_stop</span>       <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_SETUPWAIT</span><span class="p">,</span> <span class="n">CONN_EVENT_STOP</span><span class="p">,</span>     <span class="n">conn_action_stop</span>       <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_IDLE</span><span class="p">,</span>      <span class="n">CONN_EVENT_STOP</span><span class="p">,</span>     <span class="n">conn_action_stop</span>       <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_TX</span><span class="p">,</span>        <span class="n">CONN_EVENT_STOP</span><span class="p">,</span>     <span class="n">conn_action_stop</span>       <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_REGERR</span><span class="p">,</span>    <span class="n">CONN_EVENT_STOP</span><span class="p">,</span>     <span class="n">conn_action_stop</span>       <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_CONNERR</span><span class="p">,</span>   <span class="n">CONN_EVENT_STOP</span><span class="p">,</span>     <span class="n">conn_action_stop</span>       <span class="p">},</span>

	<span class="p">{</span> <span class="n">CONN_STATE_STOPPED</span><span class="p">,</span>   <span class="n">CONN_EVENT_CONN_REQ</span><span class="p">,</span> <span class="n">conn_action_connreject</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">CONN_STATE_STARTWAIT</span><span class="p">,</span> <span class="n">CONN_EVENT_CONN_REQ</span><span class="p">,</span> <span class="n">conn_action_connaccept</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_SETUPWAIT</span><span class="p">,</span> <span class="n">CONN_EVENT_CONN_REQ</span><span class="p">,</span> <span class="n">conn_action_connaccept</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_IDLE</span><span class="p">,</span>      <span class="n">CONN_EVENT_CONN_REQ</span><span class="p">,</span> <span class="n">conn_action_connreject</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_TX</span><span class="p">,</span>        <span class="n">CONN_EVENT_CONN_REQ</span><span class="p">,</span> <span class="n">conn_action_connreject</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">CONN_STATE_SETUPWAIT</span><span class="p">,</span> <span class="n">CONN_EVENT_CONN_ACK</span><span class="p">,</span> <span class="n">conn_action_connack</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_SETUPWAIT</span><span class="p">,</span> <span class="n">CONN_EVENT_TIMER</span><span class="p">,</span>    <span class="n">conn_action_conntimsev</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">CONN_STATE_SETUPWAIT</span><span class="p">,</span> <span class="n">CONN_EVENT_CONN_REJ</span><span class="p">,</span> <span class="n">conn_action_connsever</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_IDLE</span><span class="p">,</span>      <span class="n">CONN_EVENT_CONN_REJ</span><span class="p">,</span> <span class="n">conn_action_connsever</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_TX</span><span class="p">,</span>        <span class="n">CONN_EVENT_CONN_REJ</span><span class="p">,</span> <span class="n">conn_action_connsever</span>  <span class="p">},</span>

	<span class="p">{</span> <span class="n">CONN_STATE_IDLE</span><span class="p">,</span>      <span class="n">CONN_EVENT_RX</span><span class="p">,</span>       <span class="n">conn_action_rx</span>         <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_TX</span><span class="p">,</span>        <span class="n">CONN_EVENT_RX</span><span class="p">,</span>       <span class="n">conn_action_rx</span>         <span class="p">},</span>

	<span class="p">{</span> <span class="n">CONN_STATE_TX</span><span class="p">,</span>        <span class="n">CONN_EVENT_TXDONE</span><span class="p">,</span>   <span class="n">conn_action_txdone</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">CONN_STATE_IDLE</span><span class="p">,</span>      <span class="n">CONN_EVENT_TXDONE</span><span class="p">,</span>   <span class="n">conn_action_txdone</span>     <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">CONN_FSM_LEN</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">conn_fsm</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fsm_node</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Actions for interface - statemachine.</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * dev_action_start</span>
<span class="cm"> * @fi: An instance of an interface statemachine.</span>
<span class="cm"> * @event: The event, just happened.</span>
<span class="cm"> * @arg: Generic pointer, casted from struct net_device * upon call.</span>
<span class="cm"> *</span>
<span class="cm"> * Startup connection by sending CONN_EVENT_START to it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dev_action_start</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>   <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">DEV_STATE_STARTWAIT</span><span class="p">);</span>
	<span class="n">fsm_event</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_EVENT_START</span><span class="p">,</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Shutdown connection by sending CONN_EVENT_STOP to it.</span>
<span class="cm"> *</span>
<span class="cm"> * @param fi    An instance of an interface statemachine.</span>
<span class="cm"> * @param event The event, just happened.</span>
<span class="cm"> * @param arg   Generic pointer, casted from struct net_device * upon call.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dev_action_stop</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>   <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iucv_event</span>   <span class="n">ev</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ev</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">DEV_STATE_STOPWAIT</span><span class="p">);</span>
	<span class="n">fsm_event</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_EVENT_STOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Called from connection statemachine</span>
<span class="cm"> * when a connection is up and running.</span>
<span class="cm"> *</span>
<span class="cm"> * @param fi    An instance of an interface statemachine.</span>
<span class="cm"> * @param event The event, just happened.</span>
<span class="cm"> * @param arg   Generic pointer, casted from struct net_device * upon call.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dev_action_connup</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>   <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">fi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DEV_STATE_STARTWAIT</span>:
			<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">DEV_STATE_RUNNING</span><span class="p">);</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;The IUCV device has been connected&quot;</span>
				<span class="s">&quot; successfully to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">netiucv_printuser</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">));</span>
			<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				<span class="s">&quot;connection is up and running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DEV_STATE_STOPWAIT</span>:
			<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				<span class="s">&quot;dev_action_connup: in DEV_STATE_STOPWAIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Called from connection statemachine</span>
<span class="cm"> * when a connection has been shutdown.</span>
<span class="cm"> *</span>
<span class="cm"> * @param fi    An instance of an interface statemachine.</span>
<span class="cm"> * @param event The event, just happened.</span>
<span class="cm"> * @param arg   Generic pointer, casted from struct net_device * upon call.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dev_action_conndown</span><span class="p">(</span><span class="n">fsm_instance</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">fi</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DEV_STATE_RUNNING</span>:
			<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">DEV_STATE_STARTWAIT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DEV_STATE_STOPWAIT</span>:
			<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">DEV_STATE_STOPPED</span><span class="p">);</span>
			<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;connection is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">fsm_node</span> <span class="n">dev_fsm</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">DEV_STATE_STOPPED</span><span class="p">,</span>    <span class="n">DEV_EVENT_START</span><span class="p">,</span>   <span class="n">dev_action_start</span>    <span class="p">},</span>

	<span class="p">{</span> <span class="n">DEV_STATE_STOPWAIT</span><span class="p">,</span>   <span class="n">DEV_EVENT_START</span><span class="p">,</span>   <span class="n">dev_action_start</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">DEV_STATE_STOPWAIT</span><span class="p">,</span>   <span class="n">DEV_EVENT_CONDOWN</span><span class="p">,</span> <span class="n">dev_action_conndown</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">DEV_STATE_STARTWAIT</span><span class="p">,</span>  <span class="n">DEV_EVENT_STOP</span><span class="p">,</span>    <span class="n">dev_action_stop</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">DEV_STATE_STARTWAIT</span><span class="p">,</span>  <span class="n">DEV_EVENT_CONUP</span><span class="p">,</span>   <span class="n">dev_action_connup</span>   <span class="p">},</span>

	<span class="p">{</span> <span class="n">DEV_STATE_RUNNING</span><span class="p">,</span>    <span class="n">DEV_EVENT_STOP</span><span class="p">,</span>    <span class="n">dev_action_stop</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">DEV_STATE_RUNNING</span><span class="p">,</span>    <span class="n">DEV_EVENT_CONDOWN</span><span class="p">,</span> <span class="n">dev_action_conndown</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DEV_STATE_RUNNING</span><span class="p">,</span>    <span class="n">DEV_EVENT_CONUP</span><span class="p">,</span>   <span class="n">netiucv_action_nop</span>  <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">DEV_FSM_LEN</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev_fsm</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fsm_node</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Transmit a packet.</span>
<span class="cm"> * This is a helper function for netiucv_tx().</span>
<span class="cm"> *</span>
<span class="cm"> * @param conn Connection to be used for sending.</span>
<span class="cm"> * @param skb Pointer to struct sk_buff of packet to send.</span>
<span class="cm"> *            The linklevel header has already been set up</span>
<span class="cm"> *            by netiucv_tx().</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, -ERRNO on failure. (Never fails.)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netiucv_transmit_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_message</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saveflags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ll_header</span> <span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CONN_STATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_lock</span><span class="p">,</span> <span class="n">saveflags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_len</span> <span class="o">+</span> <span class="n">l</span> <span class="o">&gt;</span>
		    <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_buffsize</span> <span class="o">-</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				      <span class="s">&quot;EBUSY from netiucv_transmit_skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_len</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_lock</span><span class="p">,</span> <span class="n">saveflags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="cm">/**</span>
<span class="cm">		 * Copy the skb to a new allocated skb in lowmem only if the</span>
<span class="cm">		 * data is located above 2G in memory or tailroom is &lt; 2.</span>
<span class="cm">		 */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hi</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span>
				    <span class="n">NETIUCV_HDRLEN</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hi</span> <span class="o">||</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nskb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">NETIUCV_HDRLEN</span> <span class="o">+</span>
					 <span class="n">NETIUCV_HDRLEN</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;alloc_skb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
				       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">copied</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/**</span>
<span class="cm">		 * skb now is below 2G and has enough room. Add headers.</span>
<span class="cm">		 */</span>
		<span class="n">header</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">nskb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">);</span>
		<span class="n">header</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span>  <span class="n">NETIUCV_HDRLEN</span><span class="p">);</span>

		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_STATE_TX</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">send_stamp</span> <span class="o">=</span> <span class="n">current_kernel_time</span><span class="p">();</span>

		<span class="n">msg</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">iucv_message_send</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">nskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">nskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">doios_single</span><span class="o">++</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">txlen</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_pending</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_max_pending</span><span class="p">)</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_pending</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
			<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_STATE_IDLE</span><span class="p">);</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_pending</span><span class="o">--</span><span class="p">;</span>
			<span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="p">)</span>
				<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copied</span><span class="p">)</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/**</span>
<span class="cm">				 * Remove our headers. They get added</span>
<span class="cm">				 * again on retransmit.</span>
<span class="cm">				 */</span>
				<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">);</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;rc %d from iucv_send</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copied</span><span class="p">)</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nskb</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">commit_queue</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interface API for upper network layers</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * Open an interface.</span>
<span class="cm"> * Called from generic network layer when ifconfig up is run.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev Pointer to interface struct.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, -ERRNO on failure. (Never fails.)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netiucv_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">fsm_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">DEV_EVENT_START</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Close an interface.</span>
<span class="cm"> * Called from generic network layer when ifconfig down is run.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev Pointer to interface struct.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, -ERRNO on failure. (Never fails.)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netiucv_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">fsm_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">DEV_EVENT_STOP</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netiucv_pm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_pm_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * netiucv_pm_freeze() - Freeze PM callback</span>
<span class="cm"> * @dev:	netiucv device</span>
<span class="cm"> *</span>
<span class="cm"> * close open netiucv interfaces</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netiucv_pm_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span>
		<span class="n">ndev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_state</span> <span class="o">=</span> <span class="n">fsm_getstate</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">netiucv_close</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * netiucv_pm_restore_thaw() - Thaw and restore PM callback</span>
<span class="cm"> * @dev:	netiucv device</span>
<span class="cm"> *</span>
<span class="cm"> * re-open netiucv interfaces closed during freeze</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netiucv_pm_restore_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span>
		<span class="n">ndev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEV_STATE_RUNNING</span>:
	<span class="k">case</span> <span class="n">DEV_STATE_STARTWAIT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">netiucv_open</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Start transmission of a packet.</span>
<span class="cm"> * Called from generic network device layer.</span>
<span class="cm"> *</span>
<span class="cm"> * @param skb Pointer to buffer containing the packet.</span>
<span class="cm"> * @param dev Pointer to interface struct.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 if packet consumed, !0 if packet rejected.</span>
<span class="cm"> *         Note: If we return !0, then the packet is free&#39;d by</span>
<span class="cm"> *               the generic network layer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netiucv_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/**</span>
<span class="cm">	 * Some sanity checks ...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;netiucv_tx: skb is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			<span class="s">&quot;netiucv_tx: skb_headroom &lt; NETIUCV_HDRLEN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * If connection is not running, try to restart it</span>
<span class="cm">	 * and throw away packet.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsm_getstate</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DEV_STATE_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netiucv_test_and_set_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;EBUSY from netiucv_tx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">netiucv_transmit_skb</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">netiucv_clear_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="n">NETDEV_TX_BUSY</span> <span class="o">:</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * netiucv_stats</span>
<span class="cm"> * @dev: Pointer to interface struct.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns interface statistics of a device.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to stats struct of this interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">netiucv_stats</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * netiucv_change_mtu</span>
<span class="cm"> * @dev: Pointer to interface struct.</span>
<span class="cm"> * @new_mtu: The new MTU to use for this interface.</span>
<span class="cm"> *</span>
<span class="cm"> * Sets MTU of an interface.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, -EINVAL if MTU is out of valid range.</span>
<span class="cm"> *         (valid range is 576 .. NETIUCV_MTU_MAX).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netiucv_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">576</span> <span class="o">||</span> <span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">NETIUCV_MTU_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;given MTU out of valid range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * attributes in sysfs</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">user_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netiucv_printuser</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netiucv_check_user</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">username</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">userdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="n">buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">)))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;conn_write: too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isalnum</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">username</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="cm">/* trailing lf, grr */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="s">&quot;conn_write: invalid character %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">username</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="n">username</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">userdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">userdata</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">userdata</span><span class="p">,</span> <span class="n">iucvMagic_ascii</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">userdata</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ASCEBC</span><span class="p">(</span><span class="n">userdata</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">user_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">username</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="kt">char</span>	<span class="n">userdata</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="kt">int</span>	<span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">netiucv_check_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">userdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IFF_UP</span> <span class="o">|</span> <span class="n">IFF_RUNNING</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* username changed while the interface is active. */</span>
		<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;user_write: device active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iucv_connection_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">userdata</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">!=</span> <span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
			<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;user_write: Connection to %s &quot;</span>
				<span class="s">&quot;already exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netiucv_printuser</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">user_show</span><span class="p">,</span> <span class="n">user_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">buffer_show</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_buffsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">buffer_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">char</span>         <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span>          <span class="n">bs1</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">39</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">bs1</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;buffer_write: invalid char %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">*</span><span class="n">e</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bs1</span> <span class="o">&gt;</span> <span class="n">NETIUCV_BUFSIZE_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			<span class="s">&quot;buffer_write: buffer size %d too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bs1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_RUNNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bs1</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">NETIUCV_HDRLEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			<span class="s">&quot;buffer_write: buffer size %d too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bs1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bs1</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">576</span> <span class="o">+</span> <span class="n">NETIUCV_HDRLEN</span> <span class="o">+</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			<span class="s">&quot;buffer_write: buffer size %d too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bs1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_buffsize</span> <span class="o">=</span> <span class="n">bs1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_RUNNING</span><span class="p">))</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">bs1</span> <span class="o">-</span> <span class="n">NETIUCV_HDRLEN</span> <span class="o">-</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">buffer_show</span><span class="p">,</span> <span class="n">buffer_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dev_fsm_show</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fsm_getstate_str</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">device_fsm_state</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dev_fsm_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">conn_fsm_show</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fsm_getstate_str</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">connection_fsm_state</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">conn_fsm_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">maxmulti_show</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">maxmulti</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">maxmulti_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">maxmulti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">max_tx_buffer_used</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">maxmulti_show</span><span class="p">,</span> <span class="n">maxmulti_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">maxcq_show</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">maxcqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">maxcq_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">maxcqueue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">max_chained_skbs</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">maxcq_show</span><span class="p">,</span> <span class="n">maxcq_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdoio_show</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">doios_single</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdoio_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">doios_single</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">tx_single_write_ops</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">sdoio_show</span><span class="p">,</span> <span class="n">sdoio_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mdoio_show</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">doios_multi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mdoio_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">doios_multi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">tx_multi_write_ops</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">mdoio_show</span><span class="p">,</span> <span class="n">mdoio_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">txlen_show</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">txlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">txlen_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">txlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">netto_bytes</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">txlen_show</span><span class="p">,</span> <span class="n">txlen_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">txtime_show</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_time</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">txtime_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">max_tx_io_time</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">txtime_show</span><span class="p">,</span> <span class="n">txtime_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">txpend_show</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_pending</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">txpend_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">tx_pending</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">txpend_show</span><span class="p">,</span> <span class="n">txpend_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">txmpnd_show</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_max_pending</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">txmpnd_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">prof</span><span class="p">.</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">tx_max_pending</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">txmpnd_show</span><span class="p">,</span> <span class="n">txmpnd_write</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">netiucv_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_buffer</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_user</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">netiucv_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">netiucv_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">netiucv_stat_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_device_fsm_state</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_connection_fsm_state</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_max_tx_buffer_used</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_max_chained_skbs</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_single_write_ops</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_multi_write_ops</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_netto_bytes</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_max_tx_io_time</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_pending</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_max_pending</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">netiucv_stat_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;stats&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">netiucv_stat_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netiucv_add_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netiucv_attr_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netiucv_stat_attr_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netiucv_attr_group</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_remove_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netiucv_stat_attr_group</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netiucv_attr_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netiucv_register_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_set_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;net%s&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iucv_bus</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">iucv_root</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * The release function could be called after the</span>
<span class="cm">		 * module has been unloaded. It&#39;s _only_ task is to</span>
<span class="cm">		 * free the struct. Therefore, we specify kfree()</span>
<span class="cm">		 * directly here. (Probably a little bit obfuscating</span>
<span class="cm">		 * but legitime ...).</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">))</span><span class="n">kfree</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netiucv_driver</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">netiucv_add_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unreg</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unreg:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_unregister_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">netiucv_remove_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Allocate and initialize a new connection structure.</span>
<span class="cm"> * Add it to the list of netiucv connections;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="nf">netiucv_new_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						      <span class="kt">char</span> <span class="o">*</span><span class="n">username</span><span class="p">,</span>
						      <span class="kt">char</span> <span class="o">*</span><span class="n">userdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">conn</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">commit_queue</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_lock</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_buffsize</span> <span class="o">=</span> <span class="n">NETIUCV_BUFSIZE_DEFAULT</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_buff</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_buffsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_conn</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_buffsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_rx</span><span class="p">;</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span> <span class="o">=</span> <span class="n">init_fsm</span><span class="p">(</span><span class="s">&quot;netiucvconn&quot;</span><span class="p">,</span> <span class="n">conn_state_names</span><span class="p">,</span>
			     <span class="n">conn_event_names</span><span class="p">,</span> <span class="n">NR_CONN_STATES</span><span class="p">,</span>
			     <span class="n">NR_CONN_EVENTS</span><span class="p">,</span> <span class="n">conn_fsm</span><span class="p">,</span> <span class="n">CONN_FSM_LEN</span><span class="p">,</span>
			     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_tx</span><span class="p">;</span>

	<span class="n">fsm_settimer</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_STATE_INVALID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">userdata</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">CONN_STATE_STOPPED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iucv_connection_list</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">conn</span><span class="p">;</span>

<span class="nl">out_tx:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">);</span>
<span class="nl">out_rx:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">);</span>
<span class="nl">out_conn:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Release a connection structure and remove it from the</span>
<span class="cm"> * list of netiucv connections.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_remove_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
	<span class="n">fsm_deltimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">netiucv_purge_skb_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">collect_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iucv_path_sever</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netiucv_purge_skb_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">commit_queue</span><span class="p">);</span>
	<span class="n">kfree_fsm</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Release everything of a net device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_free_netdevice</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span>
			<span class="n">netiucv_remove_connection</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span>
			<span class="n">kfree_fsm</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">);</span>
		<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">privptr</span><span class="o">-&gt;</span><span class="n">fsm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/* privptr gets freed by free_netdev() */</span>
	<span class="p">}</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Initialize a net device. (Called from kernel in alloc_netdev())</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">netiucv_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">netiucv_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">netiucv_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">netiucv_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">netiucv_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>	   	<span class="o">=</span> <span class="n">netiucv_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_setup_netdevice</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span>	         <span class="o">=</span> <span class="n">NETIUCV_MTU_DEFAULT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">destructor</span>          <span class="o">=</span> <span class="n">netiucv_free_netdevice</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span>     <span class="o">=</span> <span class="n">NETIUCV_HDRLEN</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span>            <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span>                <span class="o">=</span> <span class="n">ARPHRD_SLIP</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span>        <span class="o">=</span> <span class="n">NETIUCV_QUEUELEN_DEFAULT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span>	         <span class="o">=</span> <span class="n">IFF_POINTOPOINT</span> <span class="o">|</span> <span class="n">IFF_NOARP</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		 <span class="o">=</span> <span class="o">&amp;</span><span class="n">netiucv_netdev_ops</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Allocate and initialize everything of a net device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">netiucv_init_netdevice</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">username</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">userdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">privptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">netiucv_priv</span><span class="p">),</span> <span class="s">&quot;iucv%d&quot;</span><span class="p">,</span>
			   <span class="n">netiucv_setup_netdevice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_netdev</span><span class="p">;</span>

	<span class="n">privptr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">fsm</span> <span class="o">=</span> <span class="n">init_fsm</span><span class="p">(</span><span class="s">&quot;netiucvdev&quot;</span><span class="p">,</span> <span class="n">dev_state_names</span><span class="p">,</span>
				<span class="n">dev_event_names</span><span class="p">,</span> <span class="n">NR_DEV_STATES</span><span class="p">,</span> <span class="n">NR_DEV_EVENTS</span><span class="p">,</span>
				<span class="n">dev_fsm</span><span class="p">,</span> <span class="n">DEV_FSM_LEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_netdev</span><span class="p">;</span>

	<span class="n">privptr</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="n">netiucv_new_connection</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">userdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;NULL from netiucv_new_connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_fsm</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fsm_newstate</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">,</span> <span class="n">DEV_STATE_STOPPED</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

<span class="nl">out_fsm:</span>
	<span class="n">kfree_fsm</span><span class="p">(</span><span class="n">privptr</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">);</span>
<span class="nl">out_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">conn_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">username</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">userdata</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">netiucv_check_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">userdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iucv_connection_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">userdata</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
			<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;conn_write: Connection to %s &quot;</span>
				<span class="s">&quot;already exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netiucv_printuser</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">netiucv_init_netdevice</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">userdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;NULL from netiucv_init_netdevice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">netiucv_register_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			<span class="s">&quot;ret %d from netiucv_register_device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_ndev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sysfs magic */</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unreg</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The IUCV interface to %s has been established &quot;</span>
			    <span class="s">&quot;successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">netiucv_printuser</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">out_unreg:</span>
	<span class="n">netiucv_unregister_device</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out_free_ndev:</span>
	<span class="n">netiucv_free_netdevice</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">conn_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">remove_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">IFNAMSIZ</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">IFNAMSIZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
                        <span class="cm">/* trailing lf, grr */</span>
                        <span class="k">break</span><span class="p">;</span>
		<span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iucv_connection_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndev</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
                <span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IFF_UP</span> <span class="o">|</span> <span class="n">IFF_RUNNING</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The IUCV device is connected&quot;</span>
				<span class="s">&quot; to %s and cannot be removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">userid</span><span class="p">);</span>
			<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;remove_write: still active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
                <span class="n">netiucv_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_rwlock</span><span class="p">);</span>
	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;remove_write: unknown device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">remove</span><span class="p">,</span> <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">remove_write</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span> <span class="n">netiucv_drv_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">driver_attr_connection</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">driver_attr_remove</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">netiucv_drv_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">netiucv_drv_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">netiucv_drv_attr_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">netiucv_drv_attr_group</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netiucv_banner</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;driver initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">netiucv_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iucv_connection</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netiucv_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iucv_connection_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iucv_connection_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iucv_connection</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">ndev</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">netiucv_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">device_unregister</span><span class="p">(</span><span class="n">netiucv_dev</span><span class="p">);</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netiucv_driver</span><span class="p">);</span>
	<span class="n">iucv_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netiucv_handler</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">iucv_unregister_dbf_views</span><span class="p">();</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;driver unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">netiucv_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">iucv_register_dbf_views</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">iucv_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netiucv_handler</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_dbf</span><span class="p">;</span>
	<span class="n">IUCV_DBF_TEXT</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">netiucv_driver</span><span class="p">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">netiucv_drv_attr_groups</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netiucv_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IUCV_DBF_TEXT_</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ret %d from driver_register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_iucv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* establish dummy device */</span>
	<span class="n">netiucv_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netiucv_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_driver</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="n">netiucv_dev</span><span class="p">,</span> <span class="s">&quot;netiucv&quot;</span><span class="p">);</span>
	<span class="n">netiucv_dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iucv_bus</span><span class="p">;</span>
	<span class="n">netiucv_dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">iucv_root</span><span class="p">;</span>
	<span class="n">netiucv_dev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">))</span><span class="n">kfree</span><span class="p">;</span>
	<span class="n">netiucv_dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netiucv_driver</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="n">netiucv_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">netiucv_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_driver</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netiucv_banner</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">out_driver:</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netiucv_driver</span><span class="p">);</span>
<span class="nl">out_iucv:</span>
	<span class="n">iucv_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netiucv_handler</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">out_dbf:</span>
	<span class="n">iucv_unregister_dbf_views</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">netiucv_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">netiucv_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
