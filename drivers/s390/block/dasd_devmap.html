<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › block › dasd_devmap.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dasd_devmap.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * File...........: linux/drivers/s390/block/dasd_devmap.c</span>
<span class="cm"> * Author(s)......: Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;</span>
<span class="cm"> *		    Horst Hummel &lt;Horst.Hummel@de.ibm.com&gt;</span>
<span class="cm"> *		    Carsten Otte &lt;Cotte@de.ibm.com&gt;</span>
<span class="cm"> *		    Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;</span>
<span class="cm"> * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;</span>
<span class="cm"> * (C) IBM Corporation, IBM Deutschland Entwicklung GmbH, 1999-2001</span>
<span class="cm"> *</span>
<span class="cm"> * Device mapping and dasd= parameter parsing functions. All devmap</span>
<span class="cm"> * functions may not be called from interrupt context. In particular</span>
<span class="cm"> * dasd_get_device is a no-no from interrupt context.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;dasd&quot;</span>

<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/debug.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/ipl.h&gt;</span>

<span class="cm">/* This is ugly... */</span>
<span class="cp">#define PRINTK_HEADER &quot;dasd_devmap:&quot;</span>
<span class="cp">#define DASD_BUS_ID_SIZE 20</span>

<span class="cp">#include &quot;dasd_int.h&quot;</span>

<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">dasd_page_cache</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dasd_page_cache</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * dasd_devmap_t is used to store the features and the relation</span>
<span class="cm"> * between device number and device index. To find a dasd_devmap_t</span>
<span class="cm"> * that corresponds to a device number of a device index each</span>
<span class="cm"> * dasd_devmap_t is added to two linked lists, one to search by</span>
<span class="cm"> * the device number and one to search by the device index. As</span>
<span class="cm"> * soon as big minor numbers are available the device index list</span>
<span class="cm"> * can be removed since the device number will then be identical</span>
<span class="cm"> * to the device index.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">bus_id</span><span class="p">[</span><span class="n">DASD_BUS_ID_SIZE</span><span class="p">];</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devindex</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">features</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Parameter parsing functions for dasd= parameter. The syntax is:</span>
<span class="cm"> *   &lt;devno&gt;		: (0x)?[0-9a-fA-F]+</span>
<span class="cm"> *   &lt;busid&gt;		: [0-0a-f]\.[0-9a-f]\.(0x)?[0-9a-fA-F]+</span>
<span class="cm"> *   &lt;feature&gt;		: ro</span>
<span class="cm"> *   &lt;feature_list&gt;	: \(&lt;feature&gt;(:&lt;feature&gt;)*\)</span>
<span class="cm"> *   &lt;devno-range&gt;	: &lt;devno&gt;(-&lt;devno&gt;)?&lt;feature_list&gt;?</span>
<span class="cm"> *   &lt;busid-range&gt;	: &lt;busid&gt;(-&lt;busid&gt;)?&lt;feature_list&gt;?</span>
<span class="cm"> *   &lt;devices&gt;		: &lt;devno-range&gt;|&lt;busid-range&gt;</span>
<span class="cm"> *   &lt;dasd_module&gt;	: dasd_diag_mod|dasd_eckd_mod|dasd_fba_mod</span>
<span class="cm"> *</span>
<span class="cm"> *   &lt;dasd&gt;		: autodetect|probeonly|&lt;devices&gt;(,&lt;devices&gt;)*</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">dasd_probeonly</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* is true, when probeonly mode is active */</span>
<span class="kt">int</span> <span class="n">dasd_autodetect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* is true, when autodetection is active */</span>
<span class="kt">int</span> <span class="n">dasd_nopav</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* is true, when PAV is disabled */</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dasd_nopav</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">dasd_nofcx</span><span class="p">;</span>			<span class="cm">/* disable High Performance Ficon */</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dasd_nofcx</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * char *dasd[] is intended to hold the ranges supplied by the dasd= statement</span>
<span class="cm"> * it is named &#39;dasd&#39; to directly be filled by insmod with the comma separated</span>
<span class="cm"> * strings when running as a module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dasd</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">dasd</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Single spinlock to protect devmap and servermap structures and lists.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Hash lists for devmap structures.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">dasd_hashlists</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">dasd_max_devindex</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">dasd_add_busid</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">dasd_hash_busid</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bus_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hash</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">DASD_BUS_ID_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">bus_id</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">bus_id</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hash</span> <span class="o">+=</span> <span class="o">*</span><span class="n">bus_id</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hash</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="cm">/*</span>
<span class="cm"> * The parameter parsing functions for builtin-drivers are called</span>
<span class="cm"> * before kmalloc works. Store the pointers to the parameters strings</span>
<span class="cm"> * into dasd[] for later processing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">dasd_call_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">dasd</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span> <span class="p">(</span><span class="s">&quot;dasd=&quot;</span><span class="p">,</span> <span class="n">dasd_call_setup</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* #ifndef MODULE */</span><span class="cp"></span>

<span class="cp">#define	DASD_IPLDEV	&quot;ipldev&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Read a device busid/devno from a string.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>

<span class="nf">dasd_busid</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">id0</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">id1</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">devno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">old_style</span><span class="p">;</span>

	<span class="cm">/* Interpret ipldev busid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">DASD_IPLDEV</span><span class="p">,</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DASD_IPLDEV</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipl_info</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">IPL_TYPE_CCW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;The IPL device is not a CCW device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">id0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">id1</span> <span class="o">=</span> <span class="n">ipl_info</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ccw</span><span class="p">.</span><span class="n">dev_id</span><span class="p">.</span><span class="n">ssid</span><span class="p">;</span>
		<span class="o">*</span><span class="n">devno</span> <span class="o">=</span> <span class="n">ipl_info</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ccw</span><span class="p">.</span><span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">;</span>
		<span class="o">*</span><span class="n">str</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DASD_IPLDEV</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* check for leading &#39;0x&#39; */</span>
	<span class="n">old_style</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">str</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">str</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">old_style</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isxdigit</span><span class="p">((</span><span class="o">*</span><span class="n">str</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>	<span class="cm">/* We require at least one hex digit */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_style</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">id0</span> <span class="o">=</span> <span class="o">*</span><span class="n">id1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">devno</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* New style x.y.z busid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">id0</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isxdigit</span><span class="p">((</span><span class="o">*</span><span class="n">str</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>	<span class="cm">/* We require at least one hex digit */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span><span class="o">++</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">id1</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isxdigit</span><span class="p">((</span><span class="o">*</span><span class="n">str</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>	<span class="cm">/* We require at least one hex digit */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">devno</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read colon separated list of dasd features. Currently there is</span>
<span class="cm"> * only one: &quot;ro&quot; for read-only devices. The default feature set</span>
<span class="cm"> * is empty (value 0).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_feature_list</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">features</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">!=</span> <span class="sc">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">endp</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">DASD_FEATURE_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">str</span><span class="o">++</span><span class="p">;</span>
	<span class="n">features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">str</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">str</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">str</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;)&#39;</span><span class="p">;</span> <span class="n">len</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;ro&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">features</span> <span class="o">|=</span> <span class="n">DASD_FEATURE_READONLY</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;diag&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">features</span> <span class="o">|=</span> <span class="n">DASD_FEATURE_USEDIAG</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">features</span> <span class="o">|=</span> <span class="n">DASD_FEATURE_USERAW</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;erplog&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">features</span> <span class="o">|=</span> <span class="n">DASD_FEATURE_ERPLOG</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;failfast&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">features</span> <span class="o">|=</span> <span class="n">DASD_FEATURE_FAILFAST</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%*s is not a supported device option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">len</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">str</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">str</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">!=</span> <span class="sc">&#39;)&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;A closing parenthesis &#39;)&#39; is missing in the &quot;</span>
			   <span class="s">&quot;dasd= parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">str</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">endp</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to match the first element on the comma separated parse string</span>
<span class="cm"> * with one of the known keywords. If a keyword is found, take the approprate</span>
<span class="cm"> * action and return a pointer to the residual string. If the first element</span>
<span class="cm"> * could not be matched to any keyword then return an error code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">dasd_parse_keyword</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">parsestring</span> <span class="p">)</span> <span class="p">{</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">nextcomma</span><span class="p">,</span> <span class="o">*</span><span class="n">residual_str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">nextcomma</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">parsestring</span><span class="p">,</span><span class="sc">&#39;,&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextcomma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">nextcomma</span> <span class="o">-</span> <span class="n">parsestring</span><span class="p">;</span>
		<span class="n">residual_str</span> <span class="o">=</span> <span class="n">nextcomma</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">parsestring</span><span class="p">);</span>
		<span class="n">residual_str</span> <span class="o">=</span> <span class="n">parsestring</span> <span class="o">+</span> <span class="n">length</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;autodetect&quot;</span><span class="p">,</span> <span class="n">parsestring</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dasd_autodetect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;The autodetection mode has been activated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">residual_str</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;probeonly&quot;</span><span class="p">,</span> <span class="n">parsestring</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dasd_probeonly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;The probeonly mode has been activated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">residual_str</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;nopav&quot;</span><span class="p">,</span> <span class="n">parsestring</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_IS_VM</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;&#39;nopav&#39; is not supported on z/VM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dasd_nopav</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PAV support has be deactivated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">residual_str</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;nofcx&quot;</span><span class="p">,</span> <span class="n">parsestring</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dasd_nofcx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;High Performance FICON support has been &quot;</span>
			<span class="s">&quot;deactivated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">residual_str</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;fixedbuffers&quot;</span><span class="p">,</span> <span class="n">parsestring</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dasd_page_cache</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">residual_str</span><span class="p">;</span>
		<span class="n">dasd_page_cache</span> <span class="o">=</span>
			<span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;dasd_page_cache&quot;</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
					  <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">SLAB_CACHE_DMA</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dasd_page_cache</span><span class="p">)</span>
			<span class="n">DBF_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Failed to create slab, &quot;</span>
				<span class="s">&quot;fixed buffer mode disabled.&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">DBF_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
				 <span class="s">&quot;turning on fixed buffer mode&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">residual_str</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to interprete the first element on the comma separated parse string</span>
<span class="cm"> * as a device number or a range of devices. If the interpretation is</span>
<span class="cm"> * successful, create the matching dasd_devmap entries and return a pointer</span>
<span class="cm"> * to the residual string.</span>
<span class="cm"> * If interpretation fails or in case of an error, return an error code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">dasd_parse_range</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">parsestring</span> <span class="p">)</span> <span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="n">from_id0</span><span class="p">,</span> <span class="n">from_id1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to</span><span class="p">,</span> <span class="n">to_id0</span><span class="p">,</span> <span class="n">to_id1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">features</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">bus_id</span><span class="p">[</span><span class="n">DASD_BUS_ID_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">parsestring</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_busid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">from_id0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">from_id1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">from</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">to</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
		<span class="n">to_id0</span> <span class="o">=</span> <span class="n">from_id0</span><span class="p">;</span>
		<span class="n">to_id1</span> <span class="o">=</span> <span class="n">from_id1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">str</span><span class="o">++</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_busid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_id0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_id1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">from_id0</span> <span class="o">!=</span> <span class="n">to_id0</span> <span class="o">||</span> <span class="n">from_id1</span> <span class="o">!=</span> <span class="n">to_id1</span> <span class="o">||</span> <span class="n">from</span> <span class="o">&gt;</span> <span class="n">to</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s is not a valid device range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">parsestring</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">features</span> <span class="o">=</span> <span class="n">dasd_feature_list</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="cm">/* each device in dasd= parameter should be set initially online */</span>
	<span class="n">features</span> <span class="o">|=</span> <span class="n">DASD_FEATURE_INITIAL_ONLINE</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">from</span> <span class="o">&lt;=</span> <span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">bus_id</span><span class="p">,</span> <span class="s">&quot;%01x.%01x.%04x&quot;</span><span class="p">,</span>
			<span class="n">from_id0</span><span class="p">,</span> <span class="n">from_id1</span><span class="p">,</span> <span class="n">from</span><span class="o">++</span><span class="p">);</span>
		<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_add_busid</span><span class="p">(</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">devmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">str</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
	<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;The dasd= parameter value %s has an invalid ending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">str</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">dasd_parse_next_element</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">parsestring</span> <span class="p">)</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">residual_str</span><span class="p">;</span>
	<span class="n">residual_str</span> <span class="o">=</span> <span class="n">dasd_parse_keyword</span><span class="p">(</span><span class="n">parsestring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">residual_str</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">residual_str</span><span class="p">;</span>
	<span class="n">residual_str</span> <span class="o">=</span> <span class="n">dasd_parse_range</span><span class="p">(</span><span class="n">parsestring</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">residual_str</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse parameters stored in dasd[]</span>
<span class="cm"> * The &#39;dasd=...&#39; parameter allows to specify a comma separated list of</span>
<span class="cm"> * keywords and device ranges. When the dasd driver is build into the kernel,</span>
<span class="cm"> * the complete list will be stored as one element of the dasd[] array.</span>
<span class="cm"> * When the dasd driver is build as a module, then the list is broken into</span>
<span class="cm"> * it&#39;s elements and each dasd[] entry contains one element.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">dasd_parse</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">parsestring</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dasd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">parsestring</span> <span class="o">=</span> <span class="n">dasd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/* loop over the comma separated list in the parsestring */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">parsestring</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">parsestring</span> <span class="o">=</span> <span class="n">dasd_parse_next_element</span><span class="p">(</span><span class="n">parsestring</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">parsestring</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">parsestring</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBF_EVENT</span><span class="p">(</span><span class="n">DBF_ALERT</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;invalid range found&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add a devmap for the device specified by busid. It is possible that</span>
<span class="cm"> * the devmap already exists (dasd= parameter). The order of the devices</span>
<span class="cm"> * added through this function will define the kdevs for the individual</span>
<span class="cm"> * devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span>
<span class="nf">dasd_add_busid</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bus_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>

	<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_devmap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="n">devmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hash</span> <span class="o">=</span> <span class="n">dasd_hash_busid</span><span class="p">(</span><span class="n">bus_id</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dasd_hashlists</span><span class="p">[</span><span class="n">hash</span><span class="p">],</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">bus_id</span><span class="p">,</span> <span class="n">DASD_BUS_ID_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devmap</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This bus_id is new. */</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">devindex</span> <span class="o">=</span> <span class="n">dasd_max_devindex</span><span class="o">++</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">bus_id</span><span class="p">,</span> <span class="n">DASD_BUS_ID_SIZE</span><span class="p">);</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">;</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dasd_hashlists</span><span class="p">[</span><span class="n">hash</span><span class="p">]);</span>
		<span class="n">devmap</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="n">new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">devmap</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find devmap for device with given bus_id.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span>
<span class="nf">dasd_find_busid</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bus_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="n">devmap</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="n">hash</span> <span class="o">=</span> <span class="n">dasd_hash_busid</span><span class="p">(</span><span class="n">bus_id</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dasd_hashlists</span><span class="p">[</span><span class="n">hash</span><span class="p">],</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">bus_id</span><span class="p">,</span> <span class="n">DASD_BUS_ID_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devmap</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">devmap</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if busid has been added to the list of dasd ranges.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">dasd_busid_known</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bus_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">bus_id</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Forget all about the device numbers added so far.</span>
<span class="cm"> * This may only be called at module unload or system shutdown.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dasd_forget_ranges</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">devmap</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dasd_hashlists</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">devmap</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find the device struct by its device index.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span>
<span class="nf">dasd_device_from_devindex</span><span class="p">(</span><span class="kt">int</span> <span class="n">devindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="n">devmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">devmap</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dasd_hashlists</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">list</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">devindex</span> <span class="o">==</span> <span class="n">devindex</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Found the devmap for the device. */</span>
				<span class="n">devmap</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devmap</span> <span class="o">&amp;&amp;</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span> <span class="o">=</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
		<span class="n">dasd_get_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">device</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">device</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return devmap for cdev. If no devmap exists yet, create one and</span>
<span class="cm"> * connect it to the cdev.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span>
<span class="nf">dasd_devmap_from_cdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_add_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
					<span class="n">DASD_FEATURE_DEFAULT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">devmap</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create a dasd device structure for cdev.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span>
<span class="nf">dasd_create_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_devmap_from_cdev</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">devmap</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">dasd_alloc_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">devindex</span> <span class="o">=</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">devindex</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
		<span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* Someone else was faster. */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dasd_free_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">device</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait queue for dasd_delete_device waits.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">dasd_delete_wq</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Remove a dasd device structure. The passed referenced</span>
<span class="cm"> * is destroyed.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">dasd_delete_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* First remove device pointer from devmap. */</span>
	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">));</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
		<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>

	<span class="cm">/* Disconnect dasd_device structure from ccw_device structure. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Drop ref_count by 3, one for the devmap reference, one for</span>
<span class="cm">	 * the cdev reference and one for the passed reference.</span>
<span class="cm">	 */</span>
	<span class="n">atomic_sub</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>

	<span class="cm">/* Wait for reference counter to drop to zero. */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">dasd_delete_wq</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disconnect dasd_device structure from ccw_device structure. */</span>
	<span class="n">cdev</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Put ccw_device structure. */</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Now the device structure can be freed. */</span>
	<span class="n">dasd_free_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reference counter dropped to zero. Wake up waiter</span>
<span class="cm"> * in dasd_delete_device.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">dasd_put_device_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_delete_wq</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dasd_put_device_wake</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Return dasd_device structure associated with cdev.</span>
<span class="cm"> * This function needs to be called with the ccw device</span>
<span class="cm"> * lock held. It can be used from interrupt context.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span>
<span class="nf">dasd_device_from_cdev_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="n">dasd_get_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">device</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return dasd_device structure associated with cdev.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span>
<span class="nf">dasd_device_from_cdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">device</span> <span class="o">=</span> <span class="n">dasd_device_from_cdev_locked</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">device</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dasd_add_link_to_gendisk</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">gdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="n">gdp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">devmap</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="nf">dasd_device_from_gendisk</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">gdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="n">devmap</span> <span class="o">=</span> <span class="n">gdp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devmap</span> <span class="o">&amp;&amp;</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span> <span class="o">=</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
		<span class="n">dasd_get_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">device</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SECTION: files in sysfs</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * failfast controls the behaviour, if no path is available</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dasd_ff_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ff_flag</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="n">ff_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_FAILFAST</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ff_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">DASD_FEATURE_DEFAULT</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_FAILFAST</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">ff_flag</span> <span class="o">?</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dasd_ff_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_devmap_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">endp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">DASD_FEATURE_FAILFAST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DASD_FEATURE_FAILFAST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">failfast</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">dasd_ff_show</span><span class="p">,</span> <span class="n">dasd_ff_store</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * readonly controls the readonly status of a dasd</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_ro_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ro_flag</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="n">ro_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_READONLY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ro_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">DASD_FEATURE_DEFAULT</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_READONLY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">ro_flag</span> <span class="o">?</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_ro_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_devmap_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">endp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">DASD_FEATURE_READONLY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DASD_FEATURE_READONLY</span><span class="p">;</span>
	<span class="n">device</span> <span class="o">=</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">DASD_FLAG_DEVICE_RO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">&amp;&amp;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">&amp;&amp;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">gdp</span><span class="p">)</span>
		<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">gdp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">readonly</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">dasd_ro_show</span><span class="p">,</span> <span class="n">dasd_ro_store</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * erplog controls the logging of ERP related data</span>
<span class="cm"> * (e.g. failing channel programs).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_erplog_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">erplog</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="n">erplog</span> <span class="o">=</span> <span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_ERPLOG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">erplog</span> <span class="o">=</span> <span class="p">(</span><span class="n">DASD_FEATURE_DEFAULT</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_ERPLOG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">erplog</span> <span class="o">?</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_erplog_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_devmap_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">endp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">DASD_FEATURE_ERPLOG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DASD_FEATURE_ERPLOG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">erplog</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">dasd_erplog_show</span><span class="p">,</span> <span class="n">dasd_erplog_store</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * use_diag controls whether the driver should use diag rather than ssch</span>
<span class="cm"> * to talk to the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_use_diag_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">use_diag</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="n">use_diag</span> <span class="o">=</span> <span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_USEDIAG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">use_diag</span> <span class="o">=</span> <span class="p">(</span><span class="n">DASD_FEATURE_DEFAULT</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_USEDIAG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">use_diag</span> <span class="o">?</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_use_diag_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_devmap_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">endp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="cm">/* Changing diag discipline flag is only allowed in offline state. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_USERAW</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">DASD_FEATURE_USEDIAG</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DASD_FEATURE_USEDIAG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">use_diag</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">dasd_use_diag_show</span><span class="p">,</span> <span class="n">dasd_use_diag_store</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * use_raw controls whether the driver should give access to raw eckd data or</span>
<span class="cm"> * operate in standard mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_use_raw_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">use_raw</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="n">use_raw</span> <span class="o">=</span> <span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_USERAW</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">use_raw</span> <span class="o">=</span> <span class="p">(</span><span class="n">DASD_FEATURE_DEFAULT</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_USERAW</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">use_raw</span> <span class="o">?</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_use_raw_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_devmap_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="cm">/* Changing diag discipline flag is only allowed in offline state. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_USEDIAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">DASD_FEATURE_USERAW</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DASD_FEATURE_USERAW</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">raw_track_access</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">dasd_use_raw_show</span><span class="p">,</span>
		   <span class="n">dasd_use_raw_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_discipline_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">dasd_device_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">device</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">discipline</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dasd_discipline_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_device_status_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">dasd_device_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DASD_STATE_NEW</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;new</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DASD_STATE_KNOWN</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DASD_STATE_BASIC</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;basic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DASD_STATE_UNFMT</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;unformatted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DASD_STATE_READY</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DASD_STATE_ONLINE</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;online</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;no stat</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dasd_device_status_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dasd_alias_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_uid</span> <span class="n">uid</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">dasd_device_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">discipline</span> <span class="o">&amp;&amp;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">get_uid</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">get_uid</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uid</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uid</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UA_BASE_PAV_ALIAS</span> <span class="o">||</span>
		    <span class="n">uid</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UA_HYPER_PAV_ALIAS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dasd_alias_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dasd_vendor_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_uid</span> <span class="n">uid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">dasd_device_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">vendor</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vendor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">discipline</span> <span class="o">&amp;&amp;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">get_uid</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">get_uid</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uid</span><span class="p">))</span>
			<span class="n">vendor</span> <span class="o">=</span> <span class="n">uid</span><span class="p">.</span><span class="n">vendor</span><span class="p">;</span>

	<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vendor</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">vendor</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dasd_vendor_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#define UID_STRLEN ( </span><span class="cm">/* vendor */</span><span class="cp"> 3 + 1 + </span><span class="cm">/* serial    */</span><span class="cp"> 14 + 1 +\</span>
<span class="cp">		     </span><span class="cm">/* SSID   */</span><span class="cp"> 4 + 1 + </span><span class="cm">/* unit addr */</span><span class="cp"> 2 + 1 +\</span>
<span class="cp">		     </span><span class="cm">/* vduit */</span><span class="cp"> 32 + 1)</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_uid_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_uid</span> <span class="n">uid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">uid_string</span><span class="p">[</span><span class="n">UID_STRLEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">ua_string</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">dasd_device_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">uid_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uid_string</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">discipline</span> <span class="o">&amp;&amp;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">get_uid</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">discipline</span><span class="o">-&gt;</span><span class="n">get_uid</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uid</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">uid</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UA_BASE_DEVICE</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">ua_string</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ua_string</span><span class="p">),</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span>
				 <span class="n">uid</span><span class="p">.</span><span class="n">real_unit_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UA_BASE_PAV_ALIAS</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">ua_string</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ua_string</span><span class="p">),</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span>
				 <span class="n">uid</span><span class="p">.</span><span class="n">base_unit_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UA_HYPER_PAV_ALIAS</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">ua_string</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ua_string</span><span class="p">),</span> <span class="s">&quot;xx&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* should not happen, treat like base device */</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">ua_string</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ua_string</span><span class="p">),</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span>
				 <span class="n">uid</span><span class="p">.</span><span class="n">real_unit_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">uid</span><span class="p">.</span><span class="n">vduit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">uid_string</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uid_string</span><span class="p">),</span>
				 <span class="s">&quot;%s.%s.%04x.%s.%s&quot;</span><span class="p">,</span>
				 <span class="n">uid</span><span class="p">.</span><span class="n">vendor</span><span class="p">,</span> <span class="n">uid</span><span class="p">.</span><span class="n">serial</span><span class="p">,</span> <span class="n">uid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ua_string</span><span class="p">,</span>
				 <span class="n">uid</span><span class="p">.</span><span class="n">vduit</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">uid_string</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uid_string</span><span class="p">),</span>
				 <span class="s">&quot;%s.%s.%04x.%s&quot;</span><span class="p">,</span>
				 <span class="n">uid</span><span class="p">.</span><span class="n">vendor</span><span class="p">,</span> <span class="n">uid</span><span class="p">.</span><span class="n">serial</span><span class="p">,</span> <span class="n">uid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ua_string</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uid_string</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dasd_uid_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * extended error-reporting</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_eer_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eer_flag</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
		<span class="n">eer_flag</span> <span class="o">=</span> <span class="n">dasd_eer_enabled</span><span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">eer_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">eer_flag</span> <span class="o">?</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_eer_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_devmap_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">endp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eer_enable</span><span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dasd_eer_disable</span><span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">eer_enabled</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">dasd_eer_show</span><span class="p">,</span> <span class="n">dasd_eer_store</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * expiration time for default requests</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_expires_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">dasd_device_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">default_expires</span><span class="p">);</span>
	<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dasd_expires_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">dasd_device_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">DASD_EXPIRES_MAX</span><span class="p">)</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">default_expires</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">expires</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">dasd_expires_show</span><span class="p">,</span> <span class="n">dasd_expires_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dasd_reservation_policy_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;ignore</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_FAILONSLCK</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;ignore</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dasd_reservation_policy_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_devmap_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_streq</span><span class="p">(</span><span class="s">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DASD_FEATURE_FAILONSLCK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sysfs_streq</span><span class="p">(</span><span class="s">&quot;fail&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">DASD_FEATURE_FAILONSLCK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">reservation_policy</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span>
		   <span class="n">dasd_reservation_policy_show</span><span class="p">,</span> <span class="n">dasd_reservation_policy_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dasd_reservation_state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">dasd_device_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DASD_FLAG_IS_RESERVED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DASD_FLAG_LOCK_STOLEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dasd_reservation_state_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">dasd_device_from_cdev</span><span class="p">(</span><span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_streq</span><span class="p">(</span><span class="s">&quot;reset&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">DASD_FLAG_LOCK_STOLEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">last_known_reservation_state</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span>
		   <span class="n">dasd_reservation_state_show</span><span class="p">,</span> <span class="n">dasd_reservation_state_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span> <span class="n">dasd_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_readonly</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_discipline</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_alias</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_vendor</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_uid</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_use_diag</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_raw_track_access</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_eer_enabled</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_erplog</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_failfast</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_expires</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_reservation_policy</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_last_known_reservation_state</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dasd_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dasd_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Return value of the specified feature.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">dasd_get_feature</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">feature</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">feature</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set / reset given feature.</span>
<span class="cm"> * Flag indicates wether to set (!=0) or the reset (=0) the feature.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">dasd_set_feature</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">feature</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_devmap</span> <span class="o">*</span><span class="n">devmap</span><span class="p">;</span>

	<span class="n">devmap</span> <span class="o">=</span> <span class="n">dasd_find_busid</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devmap</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">feature</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">feature</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
		<span class="n">devmap</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">devmap</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_devmap_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="nf">dasd_add_sysfs_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dasd_attr_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">dasd_remove_sysfs_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dasd_attr_group</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="nf">dasd_devmap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Initialize devmap structures. */</span>
	<span class="n">dasd_max_devindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_hashlists</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">dasd_devmap_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dasd_forget_ranges</span><span class="p">();</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
