<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › block › dasd_3990_erp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dasd_3990_erp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * File...........: linux/drivers/s390/block/dasd_3990_erp.c</span>
<span class="cm"> * Author(s)......: Horst  Hummel    &lt;Horst.Hummel@de.ibm.com&gt;</span>
<span class="cm"> *		    Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;</span>
<span class="cm"> * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;</span>
<span class="cm"> * (C) IBM Corporation, IBM Deutschland Entwicklung GmbH, 2000, 2001</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;dasd-eckd&quot;</span>

<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;asm/idals.h&gt;</span>

<span class="cp">#define PRINTK_HEADER &quot;dasd_erp(3990): &quot;</span>

<span class="cp">#include &quot;dasd_int.h&quot;</span>
<span class="cp">#include &quot;dasd_eckd.h&quot;</span>


<span class="k">struct</span> <span class="n">DCTL_data</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">subcommand</span><span class="p">;</span>  <span class="cm">/* e.g Inhibit Write, Enable Write,... */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">modifier</span><span class="p">;</span>	   <span class="cm">/* Subcommand modifier */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">res</span><span class="p">;</span>	   <span class="cm">/* reserved */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> * SECTION ERP HANDLING</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> * 24 and 32 byte sense ERP functions</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_CLEANUP</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Removes the already build but not necessary ERP request and sets</span>
<span class="cm"> *   the status of the original cqr / erp to the given (final) status</span>
<span class="cm"> *</span>
<span class="cm"> *  PARAMETER</span>
<span class="cm"> *   erp		request to be blocked</span>
<span class="cm"> *   final_status	either DASD_CQR_DONE or DASD_CQR_FAILED</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   cqr		original cqr</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">final_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">;</span>

	<span class="n">dasd_free_erp_request</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">final_status</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_cleanup */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_BLOCK_QUEUE</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Block the given device request queue to prevent from further</span>
<span class="cm"> *   processing until the started timer has expired or an related</span>
<span class="cm"> *   interrupt was received.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_3990_erp_block_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">expires</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
		    <span class="s">&quot;blocking request queue for %is&quot;</span><span class="p">,</span> <span class="n">expires</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dasd_device_set_stop_bits</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">DASD_STOPPED_PENDING</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">)</span>
		<span class="n">dasd_block_set_timer</span><span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">,</span> <span class="n">expires</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dasd_device_set_timer</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">expires</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_INT_REQ</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles &#39;Intervention Required&#39; error.</span>
<span class="cm"> *   This means either device offline or not installed.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		current erp</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		modified erp</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_int_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="cm">/* first time set initial retry counter and erp_function */</span>
	<span class="cm">/* and retry once without blocking queue		 */</span>
	<span class="cm">/* (this enables easier enqueing of the cqr)		 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">!=</span> <span class="n">dasd_3990_erp_int_req</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_int_req</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* issue a message and wait for &#39;device ready&#39; interrupt */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;is offline or not installed - &quot;</span>
			    <span class="s">&quot;INTERVENTION REQUIRED!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">dasd_3990_erp_block_queue</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="mi">60</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_int_req */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_ALTERNATE_PATH</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Repeat the operation on a different channel path.</span>
<span class="cm"> *   If all alternate paths have been tried, the request is posted with a</span>
<span class="cm"> *   permanent error.</span>
<span class="cm"> *</span>
<span class="cm"> *  PARAMETER</span>
<span class="cm"> *   erp		pointer to the current ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		modified pointer to the ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dasd_3990_erp_alternate_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">opm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* try alternate valid path */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">opm</span> <span class="o">=</span> <span class="n">ccw_device_get_path_mask</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">opm</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">sublog</span><span class="p">.</span><span class="n">lpum</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">sublog</span><span class="p">.</span><span class="n">lpum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">&amp;</span> <span class="n">opm</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
			    <span class="s">&quot;try alternate lpm=%x (lpum=%x / opm=%x)&quot;</span><span class="p">,</span>
			    <span class="n">erp</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">,</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">sublog</span><span class="p">.</span><span class="n">lpum</span><span class="p">,</span> <span class="n">opm</span><span class="p">);</span>

		<span class="cm">/* reset status to submit the request again... */</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The DASD cannot be reached on any path (lpum=%x&quot;</span>
			<span class="s">&quot;/opm=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">sublog</span><span class="p">.</span><span class="n">lpum</span><span class="p">,</span> <span class="n">opm</span><span class="p">);</span>

		<span class="cm">/* post request with permanent error */</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_alternate_path */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_DCTL</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Setup cqr to do the Diagnostic Control (DCTL) command with an</span>
<span class="cm"> *   Inhibit Write subcommand (0x20) and the given modifier.</span>
<span class="cm"> *</span>
<span class="cm"> *  PARAMETER</span>
<span class="cm"> *   erp		pointer to the current (failed) ERP</span>
<span class="cm"> *   modifier		subcommand modifier</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   dctl_cqr		pointer to NEW dctl_cqr</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_DCTL</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">modifier</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DCTL_data</span> <span class="o">*</span><span class="n">DCTL_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">dctl_cqr</span><span class="p">;</span>

	<span class="n">dctl_cqr</span> <span class="o">=</span> <span class="n">dasd_alloc_erp_request</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DCTL_data</span><span class="p">),</span>
					  <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dctl_cqr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;Unable to allocate DCTL-CQR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FAILED</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DCTL_data</span> <span class="o">=</span> <span class="n">dctl_cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">DCTL_data</span><span class="o">-&gt;</span><span class="n">subcommand</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>	<span class="cm">/* Inhibit Write */</span>
	<span class="n">DCTL_data</span><span class="o">-&gt;</span><span class="n">modifier</span> <span class="o">=</span> <span class="n">modifier</span><span class="p">;</span>

	<span class="n">ccw</span> <span class="o">=</span> <span class="n">dctl_cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_DCTL</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">DCTL_data</span><span class="p">;</span>
	<span class="n">dctl_cqr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">dctl_cqr</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_DCTL</span><span class="p">;</span>
	<span class="n">dctl_cqr</span><span class="o">-&gt;</span><span class="n">refers</span> <span class="o">=</span> <span class="n">erp</span><span class="p">;</span>
	<span class="n">dctl_cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">dctl_cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">dctl_cqr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">;</span>
	<span class="n">dctl_cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">dctl_cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">dctl_cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>

	<span class="n">dctl_cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dctl_cqr</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_DCTL */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_ACTION_1</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Setup ERP to do the ERP action 1 (see Reference manual).</span>
<span class="cm"> *   Repeat the operation on a different channel path.</span>
<span class="cm"> *   As deviation from the recommended recovery action, we reset the path mask</span>
<span class="cm"> *   after we have tried each path and go through all paths a second time.</span>
<span class="cm"> *   This will cover situations where only one path at a time is actually down,</span>
<span class="cm"> *   but all paths fail and recover just with the same sequence and timing as</span>
<span class="cm"> *   we try to use them (flapping links).</span>
<span class="cm"> *   If all alternate paths have been tried twice, the request is posted with</span>
<span class="cm"> *   a permanent error.</span>
<span class="cm"> *</span>
<span class="cm"> *  PARAMETER</span>
<span class="cm"> *   erp		pointer to the current ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		pointer to the ERP</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="nf">dasd_3990_erp_action_1_sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_1_sec</span><span class="p">;</span>
	<span class="n">dasd_3990_erp_alternate_path</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="nf">dasd_3990_erp_action_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_1</span><span class="p">;</span>
	<span class="n">dasd_3990_erp_alternate_path</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DASD_CQR_FAILED</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DASD_CQR_VERIFY_PATH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">opm</span><span class="p">;</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_1_sec</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_action_1(b) */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_ACTION_4</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Setup ERP to do the ERP action 4 (see Reference manual).</span>
<span class="cm"> *   Set the current request to PENDING to block the CQR queue for that device</span>
<span class="cm"> *   until the state change interrupt appears.</span>
<span class="cm"> *   Use a timer (20 seconds) to retry the cqr if the interrupt is still</span>
<span class="cm"> *   missing.</span>
<span class="cm"> *</span>
<span class="cm"> *  PARAMETER</span>
<span class="cm"> *   sense		sense data of the actual error</span>
<span class="cm"> *   erp		pointer to the current ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		pointer to the ERP</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_action_4</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="cm">/* first time set initial retry counter and erp_function    */</span>
	<span class="cm">/* and retry once without waiting for state change pending  */</span>
	<span class="cm">/* interrupt (this enables easier enqueing of the cqr)	    */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">!=</span> <span class="n">dasd_3990_erp_action_4</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;dasd_3990_erp_action_4: first time retry&quot;</span><span class="p">);</span>

		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_4</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1D</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* state change pending */</span>

			<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
				    <span class="s">&quot;waiting for state change pending &quot;</span>
				    <span class="s">&quot;interrupt, %d retries left&quot;</span><span class="p">,</span>
				    <span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">);</span>

			<span class="n">dasd_3990_erp_block_queue</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1E</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* busy */</span>
			<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
				    <span class="s">&quot;busy - redriving request later, &quot;</span>
				    <span class="s">&quot;%d retries left&quot;</span><span class="p">,</span>
				    <span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">);</span>
                        <span class="n">dasd_3990_erp_block_queue</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* no state change pending - retry */</span>
			<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
				     <span class="s">&quot;redriving request immediately, &quot;</span>
				     <span class="s">&quot;%d retries left&quot;</span><span class="p">,</span>
				     <span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">);</span>
			<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_action_4 */</span>

<span class="cm">/*</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> * 24 byte sense ERP functions (only)</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_ACTION_5</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Setup ERP to do the ERP action 5 (see Reference manual).</span>
<span class="cm"> *   NOTE: Further handling is done in xxx_further_erp after the retries.</span>
<span class="cm"> *</span>
<span class="cm"> *  PARAMETER</span>
<span class="cm"> *   erp		pointer to the current ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		pointer to the ERP</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_action_5</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* first of all retry */</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_5</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_action_5 */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_HANDLE_ENV_DATA</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 24 byte &#39;Environmental data present&#39;.</span>
<span class="cm"> *   Does a analysis of the sense data (message Format)</span>
<span class="cm"> *   and prints the error messages.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   sense		current sense data</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   void</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dasd_3990_handle_env_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">msg_format</span> <span class="o">=</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">msg_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">errorstring</span><span class="p">[</span><span class="n">ERRORLENGTH</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg_format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:		<span class="cm">/* Format 0 - Program or System Checks */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* check message to operator bit */</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">msg_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x00</span>:	<span class="cm">/* No Message */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x01</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Invalid Command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x02</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Invalid Command &quot;</span>
					    <span class="s">&quot;Sequence</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x03</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - CCW Count less than &quot;</span>
					    <span class="s">&quot;required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x04</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Invalid Parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x05</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Diagnostic of Special&quot;</span>
					    <span class="s">&quot; Command Violates File Mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x07</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Channel Returned with &quot;</span>
					    <span class="s">&quot;Incorrect retry CCW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x08</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Reset Notification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x09</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;FORMAT 0 - Storage Path Restart</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x0A</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Channel requested &quot;</span>
					    <span class="s">&quot;... %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x0B</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Invalid Defective/&quot;</span>
					    <span class="s">&quot;Alternate Track Pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x0C</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - DPS Installation &quot;</span>
					    <span class="s">&quot;Check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x0E</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Command Invalid on &quot;</span>
					    <span class="s">&quot;Secondary Address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x0F</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Status Not As &quot;</span>
					    <span class="s">&quot;Required: reason %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">sense</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">msg_no</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x00</span>:	<span class="cm">/* No Message */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x01</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;FORMAT 0 - Device Error &quot;</span>
					 <span class="s">&quot;Source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x02</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x03</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Device Fenced - &quot;</span>
					    <span class="s">&quot;device = %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x04</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Data Pinned for &quot;</span>
					    <span class="s">&quot;Device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;FORMAT 0 - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x10</span>:		<span class="cm">/* Format 1 - Device Equipment Checks */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msg_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:	<span class="cm">/* No Message */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Device Status 1 not as &quot;</span>
				    <span class="s">&quot;expected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Index missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;FORMAT 1 - Interruption cannot be &quot;</span>
				 <span class="s">&quot;reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x05</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Device did not respond to &quot;</span>
				    <span class="s">&quot;selection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Device check-2 error or Set &quot;</span>
				    <span class="s">&quot;Sector is not complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x07</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Head address does not &quot;</span>
				    <span class="s">&quot;compare</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Device status 1 not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x09</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Device not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0A</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Track physical address did &quot;</span>
				    <span class="s">&quot;not compare</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0B</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Missing device address bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0C</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Drive motor switch is off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0D</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Seek incomplete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0E</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Cylinder address did not &quot;</span>
				    <span class="s">&quot;compare</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0F</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Offset active cannot be &quot;</span>
				    <span class="s">&quot;reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 1 - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x20</span>:		<span class="cm">/* Format 2 - 3990 Equipment Checks */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msg_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 2 - 3990 check-2 error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0E</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 2 - Support facility errors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0F</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;FORMAT 2 - Microcode detected error &quot;</span>
				 <span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">sense</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 2 - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x30</span>:		<span class="cm">/* Format 3 - 3990 Control Checks */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msg_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0F</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 3 - Allegiance terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 3 - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x40</span>:		<span class="cm">/* Format 4 - Data Checks */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msg_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - Home address area error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - Count area error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - Key area error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - Data area error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - No sync byte in home address &quot;</span>
				    <span class="s">&quot;area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x05</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - No sync byte in count address &quot;</span>
				    <span class="s">&quot;area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - No sync byte in key area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x07</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - No sync byte in data area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - Home address area error; &quot;</span>
				    <span class="s">&quot;offset active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x09</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - Count area error; offset &quot;</span>
				    <span class="s">&quot;active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0A</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - Key area error; offset &quot;</span>
				    <span class="s">&quot;active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0B</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - Data area error; &quot;</span>
				    <span class="s">&quot;offset active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0C</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - No sync byte in home &quot;</span>
				    <span class="s">&quot;address area; offset active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0D</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - No syn byte in count &quot;</span>
				    <span class="s">&quot;address area; offset active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0E</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - No sync byte in key area; &quot;</span>
				    <span class="s">&quot;offset active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0F</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - No syn byte in data area; &quot;</span>
				    <span class="s">&quot;offset active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 4 - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x50</span>:  <span class="cm">/* Format 5 - Data Check with displacement information */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msg_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 5 - Data Check in the &quot;</span>
				    <span class="s">&quot;home address area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;FORMAT 5 - Data Check in the count &quot;</span>
				 <span class="s">&quot;area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 5 - Data Check in the key area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;FORMAT 5 - Data Check in the data &quot;</span>
				 <span class="s">&quot;area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 5 - Data Check in the &quot;</span>
				    <span class="s">&quot;home address area; offset active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x09</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 5 - Data Check in the count area; &quot;</span>
				    <span class="s">&quot;offset active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0A</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 5 - Data Check in the key area; &quot;</span>
				    <span class="s">&quot;offset active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0B</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 5 - Data Check in the data area; &quot;</span>
				    <span class="s">&quot;offset active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 5 - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x60</span>:  <span class="cm">/* Format 6 - Usage Statistics/Overrun Errors */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msg_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 6 - Overrun on channel A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 6 - Overrun on channel B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 6 - Overrun on channel C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 6 - Overrun on channel D</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 6 - Overrun on channel E</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x05</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 6 - Overrun on channel F</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 6 - Overrun on channel G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x07</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 6 - Overrun on channel H</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 6 - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x70</span>:  <span class="cm">/* Format 7 - Device Connection Control Checks */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msg_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - RCC initiated by a connection &quot;</span>
				    <span class="s">&quot;check alert</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - RCC 1 sequence not &quot;</span>
				    <span class="s">&quot;successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - RCC 1 and RCC 2 sequences not &quot;</span>
				    <span class="s">&quot;successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - Invalid tag-in during &quot;</span>
				    <span class="s">&quot;selection sequence</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - extra RCC required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x05</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - Invalid DCC selection &quot;</span>
				    <span class="s">&quot;response or timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - Missing end operation; device &quot;</span>
				    <span class="s">&quot;transfer complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x07</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - Missing end operation; device &quot;</span>
				    <span class="s">&quot;transfer incomplete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - Invalid tag-in for an &quot;</span>
				    <span class="s">&quot;immediate command sequence</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x09</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - Invalid tag-in for an &quot;</span>
				    <span class="s">&quot;extended command sequence</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0A</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - 3990 microcode time out when &quot;</span>
				    <span class="s">&quot;stopping selection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0B</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - No response to selection &quot;</span>
				    <span class="s">&quot;after a poll interruption</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0C</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - Permanent path error (DASD &quot;</span>
				    <span class="s">&quot;controller not available)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0D</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - DASD controller not available&quot;</span>
				    <span class="s">&quot; on disconnected command chain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 7 - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x80</span>:  <span class="cm">/* Format 8 - Additional Device Equipment Checks */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msg_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:	<span class="cm">/* No Message */</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 8 - Error correction code &quot;</span>
				    <span class="s">&quot;hardware fault</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 8 - Unexpected end operation &quot;</span>
				    <span class="s">&quot;response code</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 8 - End operation with transfer &quot;</span>
				    <span class="s">&quot;count not zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x05</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 8 - End operation with transfer &quot;</span>
				    <span class="s">&quot;count zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 8 - DPS checks after a system &quot;</span>
				    <span class="s">&quot;reset or selective reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x07</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 8 - DPS cannot be filled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 8 - Short busy time-out during &quot;</span>
				    <span class="s">&quot;device selection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x09</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 8 - DASD controller failed to &quot;</span>
				    <span class="s">&quot;set or reset the long busy latch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0A</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 8 - No interruption from device &quot;</span>
				    <span class="s">&quot;during a command chain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 8 - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x90</span>:  <span class="cm">/* Format 9 - Device Read, Write, and Seek Checks */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msg_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* No Message */</span>
		<span class="k">case</span> <span class="mh">0x06</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 9 - Device check-2 error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x07</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;FORMAT 9 - Head address did not &quot;</span>
				 <span class="s">&quot;compare</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0A</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 9 - Track physical address did &quot;</span>
				    <span class="s">&quot;not compare while oriented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0E</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 9 - Cylinder address did not &quot;</span>
				    <span class="s">&quot;compare</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT 9 - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0xF0</span>:		<span class="cm">/* Format F - Cache Storage Checks */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msg_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT F - Operation Terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT F - Subsystem Processing Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT F - Cache or nonvolatile storage &quot;</span>
				    <span class="s">&quot;equipment failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT F - Caching terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT F - Cache fast write access not &quot;</span>
				    <span class="s">&quot;authorized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x07</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT F - Track format incorrect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x09</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT F - Caching reinitiated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0A</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT F - Nonvolatile storage &quot;</span>
				    <span class="s">&quot;terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0B</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT F - Volume is suspended duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* call extended error reporting (EER) */</span>
			<span class="n">dasd_eer_write</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">,</span>
				       <span class="n">DASD_EER_PPRCSUSPEND</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0C</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT F - Subsystem status cannot be &quot;</span>
				    <span class="s">&quot;determined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0D</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT F - Caching status reset to &quot;</span>
				    <span class="s">&quot;default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0E</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT F - DASD Fast Write inhibited</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;FORMAT D - Reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>	<span class="cm">/* unknown message format - should not happen</span>
<span class="cm">			   internal error 03 - unknown message format */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">errorstring</span><span class="p">,</span> <span class="n">ERRORLENGTH</span><span class="p">,</span> <span class="s">&quot;03 %x02&quot;</span><span class="p">,</span> <span class="n">msg_format</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;An error occurred in the DASD device driver, &quot;</span>
			 <span class="s">&quot;reason=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">errorstring</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>			<span class="cm">/* end switch message format */</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_handle_env_data */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_COM_REJ</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 24 byte &#39;Command Reject&#39; error.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		current erp_head</span>
<span class="cm"> *   sense		current sense data</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		&#39;new&#39; erp_head - pointer to new ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_com_rej</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_com_rej</span><span class="p">;</span>

	<span class="cm">/* env data present (ACTION 10 - retry should work) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS2_ENV_DATA_PRESENT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Command Reject - environmental data present&quot;</span><span class="p">);</span>

		<span class="n">dasd_3990_handle_env_data</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS1_WRITE_INHIBITED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;An I/O request was rejected&quot;</span>
			<span class="s">&quot; because writing is inhibited</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">DASD_CQR_FAILED</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* fatal error -  set status to FAILED</span>
<span class="cm">		   internal error 09 - Command Reject */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;An error occurred in the DASD &quot;</span>
			<span class="s">&quot;device driver, reason=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;09&quot;</span><span class="p">);</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">DASD_CQR_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_com_rej */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_BUS_OUT</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 24 byte &#39;Bus Out Parity Check&#39; error.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		current erp_head</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		new erp_head - pointer to new ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_bus_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="cm">/* first time set initial retry counter and erp_function */</span>
	<span class="cm">/* and retry once without blocking queue		 */</span>
	<span class="cm">/* (this enables easier enqueing of the cqr)		 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">!=</span> <span class="n">dasd_3990_erp_bus_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_bus_out</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* issue a message and wait for &#39;device ready&#39; interrupt */</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;bus out parity error or BOPC requested by &quot;</span>
			    <span class="s">&quot;channel&quot;</span><span class="p">);</span>

		<span class="n">dasd_3990_erp_block_queue</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="mi">60</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_bus_out */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_EQUIP_CHECK</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 24 byte &#39;Equipment Check&#39; error.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		current erp_head</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		new erp_head - pointer to new ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_equip_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_equip_check</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS1_WRITE_INHIBITED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;Write inhibited path encountered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* vary path offline</span>
<span class="cm">		   internal error 04 - Path should be varied off-line.*/</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;An error occurred in the DASD &quot;</span>
			<span class="s">&quot;device driver, reason=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;04&quot;</span><span class="p">);</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_1</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS2_ENV_DATA_PRESENT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Equipment Check - &quot;</span> <span class="s">&quot;environmental data present&quot;</span><span class="p">);</span>

		<span class="n">dasd_3990_handle_env_data</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_4</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS1_PERM_ERR</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Equipment Check - retry exhausted or &quot;</span>
			    <span class="s">&quot;undesirable&quot;</span><span class="p">);</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_1</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* all other equipment checks - Action 5 */</span>
		<span class="cm">/* rest is done when retries == 0 */</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Equipment check or processing error&quot;</span><span class="p">);</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_5</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_equip_check */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_DATA_CHECK</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 24 byte &#39;Data Check&#39; error.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		current erp_head</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		new erp_head - pointer to new ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_data_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_data_check</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS2_CORRECTABLE</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* correctable data check */</span>

		<span class="cm">/* issue message that the data has been corrected */</span>
		<span class="n">dev_emerg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;Data recovered during retry with PCI &quot;</span>
			    <span class="s">&quot;fetch mode active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* not possible to handle this situation in Linux */</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;No way to inform application about the possibly &quot;</span>
		      <span class="s">&quot;incorrect data&quot;</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS2_ENV_DATA_PRESENT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Uncorrectable data check recovered secondary &quot;</span>
			    <span class="s">&quot;addr of duplex pair&quot;</span><span class="p">);</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_4</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS1_PERM_ERR</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Uncorrectable data check with internal &quot;</span>
			    <span class="s">&quot;retry exhausted&quot;</span><span class="p">);</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_1</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* all other data checks */</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Uncorrectable data check with retry count &quot;</span>
			    <span class="s">&quot;exhausted...&quot;</span><span class="p">);</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_5</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_data_check */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_OVERRUN</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 24 byte &#39;Overrun&#39; error.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		current erp_head</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		new erp_head - pointer to new ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_overrun</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_overrun</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
		    <span class="s">&quot;Overrun - service overrun or overrun&quot;</span>
		    <span class="s">&quot; error requested by channel&quot;</span><span class="p">);</span>

	<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_5</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_overrun */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_INV_FORMAT</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 24 byte &#39;Invalid Track Format&#39; error.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		current erp_head</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		new erp_head - pointer to new ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_inv_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_inv_format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS2_ENV_DATA_PRESENT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Track format error when destaging or &quot;</span>
			    <span class="s">&quot;staging data&quot;</span><span class="p">);</span>

		<span class="n">dasd_3990_handle_env_data</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_4</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* internal error 06 - The track format is not valid*/</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;An error occurred in the DASD device driver, &quot;</span>
			<span class="s">&quot;reason=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;06&quot;</span><span class="p">);</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">DASD_CQR_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_inv_format */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_EOC</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 24 byte &#39;End-of-Cylinder&#39; error.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		already added default erp</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		pointer to original (failed) cqr.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_EOC</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">default_erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">default_erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;The cylinder data for accessing the DASD is inconsistent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* implement action 7 - BUG */</span>
	<span class="k">return</span> <span class="n">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="n">default_erp</span><span class="p">,</span> <span class="n">DASD_CQR_FAILED</span><span class="p">);</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_EOC */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_ENV_DATA</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 24 byte &#39;Environmental-Data Present&#39; error.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		current erp_head</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		new erp_head - pointer to new ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_env_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_env_data</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Environmental data present&quot;</span><span class="p">);</span>

	<span class="n">dasd_3990_handle_env_data</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

	<span class="cm">/* don&#39;t retry on disabled interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_4</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_env_data */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_NO_REC</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 24 byte &#39;No Record Found&#39; error.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		already added default ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		new erp_head - pointer to new ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_no_rec</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">default_erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">default_erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="s">&quot;The specified record was not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="n">default_erp</span><span class="p">,</span> <span class="n">DASD_CQR_FAILED</span><span class="p">);</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_no_rec */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_FILE_PROT</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 24 byte &#39;File Protected&#39; error.</span>
<span class="cm"> *   Note: Seek related recovery is not implemented because</span>
<span class="cm"> *	   wee don&#39;t use the seek command yet.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		current erp_head</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		new erp_head - pointer to new ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_file_prot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Accessing the DASD failed because of &quot;</span>
		<span class="s">&quot;a hardware error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">DASD_CQR_FAILED</span><span class="p">);</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_file_prot */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_INSPECT_ALIAS</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Checks if the original request was started on an alias device.</span>
<span class="cm"> *   If yes, it modifies the original and the erp request so that</span>
<span class="cm"> *   the erp request can be started on a base device.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		pointer to the currently created default ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		pointer to the modified ERP, or NULL</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="nf">dasd_3990_erp_inspect_alias</span><span class="p">(</span>
						<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">!=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">sense</span> <span class="o">=</span> <span class="n">dasd_get_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * dynamic pav may have changed base alias mapping</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DASD_FLAG_OFFLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sense</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0F</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x67</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * remove device from alias handling to prevent new</span>
<span class="cm">			 * requests from being scheduled on the</span>
<span class="cm">			 * wrong alias device</span>
<span class="cm">			 */</span>
			<span class="n">dasd_alias_remove_device</span><span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">);</span>

			<span class="cm">/* schedule worker to reload device */</span>
			<span class="n">dasd_reload_device</span><span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_ERPLOG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_ERR</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">,</span>
				    <span class="s">&quot;ERP on alias device for request %p,&quot;</span>
				    <span class="s">&quot; recover on base device %s&quot;</span><span class="p">,</span> <span class="n">cqr</span><span class="p">,</span>
				    <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">dasd_eckd_reset_ccw_to_base_io</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_inspect_alias</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_INSPECT_24</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Does a detailed inspection of the 24 byte sense data</span>
<span class="cm"> *   and sets up a related error recovery action.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   sense		sense data of the actual error</span>
<span class="cm"> *   erp		pointer to the currently created default ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		pointer to the (addtitional) ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_inspect_24</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp_filled</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Check sense for ....	   */</span>
	<span class="cm">/* &#39;Command Reject&#39;	   */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">erp_filled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS0_CMD_REJECT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp_filled</span> <span class="o">=</span> <span class="n">dasd_3990_erp_com_rej</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* &#39;Intervention Required&#39; */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">erp_filled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS0_INTERVENTION_REQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp_filled</span> <span class="o">=</span> <span class="n">dasd_3990_erp_int_req</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* &#39;Bus Out Parity Check&#39;  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">erp_filled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS0_BUS_OUT_CHECK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp_filled</span> <span class="o">=</span> <span class="n">dasd_3990_erp_bus_out</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* &#39;Equipment Check&#39;	   */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">erp_filled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS0_EQUIPMENT_CHECK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp_filled</span> <span class="o">=</span> <span class="n">dasd_3990_erp_equip_check</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* &#39;Data Check&#39;		   */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">erp_filled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS0_DATA_CHECK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp_filled</span> <span class="o">=</span> <span class="n">dasd_3990_erp_data_check</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* &#39;Overrun&#39;		   */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">erp_filled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS0_OVERRUN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp_filled</span> <span class="o">=</span> <span class="n">dasd_3990_erp_overrun</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* &#39;Invalid Track Format&#39;  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">erp_filled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS1_INV_TRACK_FORMAT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp_filled</span> <span class="o">=</span> <span class="n">dasd_3990_erp_inv_format</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* &#39;End-of-Cylinder&#39;	   */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">erp_filled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS1_EOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp_filled</span> <span class="o">=</span> <span class="n">dasd_3990_erp_EOC</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* &#39;Environmental Data&#39;	   */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">erp_filled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS2_ENV_DATA_PRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp_filled</span> <span class="o">=</span> <span class="n">dasd_3990_erp_env_data</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* &#39;No Record Found&#39;	   */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">erp_filled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS1_NO_REC_FOUND</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp_filled</span> <span class="o">=</span> <span class="n">dasd_3990_erp_no_rec</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* &#39;File Protected&#39;	   */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">erp_filled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS1_FILE_PROTECTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp_filled</span> <span class="o">=</span> <span class="n">dasd_3990_erp_file_prot</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* other (unknown) error - do default ERP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erp_filled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">erp_filled</span> <span class="o">=</span> <span class="n">erp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp_filled</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* END dasd_3990_erp_inspect_24 */</span>

<span class="cm">/*</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> * 32 byte sense ERP functions (only)</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERPACTION_10_32</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 32 byte &#39;Action 10&#39; of Single Program Action Codes.</span>
<span class="cm"> *   Just retry and if retry doesn&#39;t work, return with error.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		current erp_head</span>
<span class="cm"> *   sense		current sense data</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		modified erp_head</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_action_10_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_10_32</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Perform logging requested&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_action_10_32 */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_ACTION_1B_32</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles 32 byte &#39;Action 1B&#39; of Single Program Action Codes.</span>
<span class="cm"> *   A write operation could not be finished because of an unexpected</span>
<span class="cm"> *   condition.</span>
<span class="cm"> *   The already created &#39;default erp&#39; is used to get the link to</span>
<span class="cm"> *   the erp chain, but it can not be used for this recovery</span>
<span class="cm"> *   action because it contains no DE/LO data space.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   default_erp	already added default erp.</span>
<span class="cm"> *   sense		current sense data</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		new erp or</span>
<span class="cm"> *			default_erp in case of imprecise ending or error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_action_1B_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">default_erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">default_erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">cpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DE_eckd_data</span> <span class="o">*</span><span class="n">DE_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">PFX_eckd_data</span> <span class="o">*</span><span class="n">PFX_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">LO_data</span><span class="p">;</span>		<span class="cm">/* LO_eckd_data_t */</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">,</span> <span class="o">*</span><span class="n">oldccw</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
		    <span class="s">&quot;Write not finished because of unexpected condition&quot;</span><span class="p">);</span>

	<span class="n">default_erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_1B_32</span><span class="p">;</span>

	<span class="cm">/* determine the original cqr */</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">default_erp</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">refers</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsw_is_tm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			      <span class="s">&quot;32 bit sense, action 1B is not defined&quot;</span>
			      <span class="s">&quot; in transport mode - just retry&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">default_erp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for imprecise ending just do default erp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Imprecise ending is set - just retry&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">default_erp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* determine the address of the CCW to be restarted */</span>
	<span class="cm">/* Imprecise ending is not set -&gt; addr from IRB-SCSW */</span>
	<span class="n">cpa</span> <span class="o">=</span> <span class="n">default_erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Unable to determine address of the CCW &quot;</span>
			    <span class="s">&quot;to be restarted&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="n">default_erp</span><span class="p">,</span> <span class="n">DASD_CQR_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Build new ERP request including DE/LO */</span>
	<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_alloc_erp_request</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span>
				     <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="cm">/* DE/LO + TIC */</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">)</span> <span class="o">+</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span><span class="p">),</span> <span class="n">device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">erp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* internal error 01 - Unable to allocate ERP */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;An error occurred in the DASD &quot;</span>
			<span class="s">&quot;device driver, reason=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;01&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="n">default_erp</span><span class="p">,</span> <span class="n">DASD_CQR_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* use original DE */</span>
	<span class="n">DE_data</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">oldccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oldccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">==</span> <span class="n">DASD_ECKD_CCW_PFX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PFX_data</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">DE_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PFX_data</span><span class="o">-&gt;</span><span class="n">define_extent</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">DE_data</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">));</span>

	<span class="cm">/* create LO */</span>
	<span class="n">LO_data</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">LO_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* should not */</span>
		<span class="k">return</span> <span class="n">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="n">default_erp</span><span class="p">,</span> <span class="n">DASD_CQR_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* operation code is WRITE DATA -&gt; data area orientation */</span>
		<span class="n">LO_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* operation code is FORMAT WRITE -&gt; index orientation */</span>
		<span class="n">LO_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC3</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">LO_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>	<span class="cm">/* operation */</span>
	<span class="p">}</span>

	<span class="n">LO_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* auxiliary */</span>
	<span class="n">LO_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">LO_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* count */</span>
	<span class="n">LO_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">29</span><span class="p">];</span>	<span class="cm">/* seek_addr.cyl */</span>
	<span class="n">LO_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>	<span class="cm">/* seek_addr.cyl 2nd byte */</span>
	<span class="n">LO_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>	<span class="cm">/* seek_addr.head 2nd byte */</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">LO_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">11</span><span class="p">]),</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* create DE ccw */</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_DEFINE_EXTENT</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">DE_data</span><span class="p">;</span>

	<span class="cm">/* create LO ccw */</span>
	<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">));</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_LOCATE_RECORD</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">LO_data</span><span class="p">;</span>

	<span class="cm">/* TIC to the failed ccw */</span>
	<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_TIC</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="n">cpa</span><span class="p">;</span>

	<span class="cm">/* fill erp related fields */</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">default_erp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_1B_32</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">refers</span> <span class="o">=</span> <span class="n">default_erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">default_erp</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">default_erp</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>

	<span class="cm">/* remove the default erp */</span>
	<span class="n">dasd_free_erp_request</span><span class="p">(</span><span class="n">default_erp</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_action_1B_32 */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_UPDATE_1B</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles the update to the 32 byte &#39;Action 1B&#39; of Single Program</span>
<span class="cm"> *   Action Codes in case the first action was not successful.</span>
<span class="cm"> *   The already created &#39;previous_erp&#39; is the currently not successful</span>
<span class="cm"> *   ERP.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   previous_erp	already created previous erp.</span>
<span class="cm"> *   sense		current sense data</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		modified erp</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_update_1B</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">previous_erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">previous_erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">cpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">LO_data</span><span class="p">;</span>		<span class="cm">/* struct LO_eckd_data */</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
		    <span class="s">&quot;Write not finished because of unexpected condition&quot;</span>
		    <span class="s">&quot; - follow on&quot;</span><span class="p">);</span>

	<span class="cm">/* determine the original cqr */</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">previous_erp</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">refers</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsw_is_tm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			      <span class="s">&quot;32 bit sense, action 1B, update,&quot;</span>
			      <span class="s">&quot; in transport mode - just retry&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">previous_erp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for imprecise ending just do default erp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Imprecise ending is set - just retry&quot;</span><span class="p">);</span>

		<span class="n">previous_erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">previous_erp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* determine the address of the CCW to be restarted */</span>
	<span class="cm">/* Imprecise ending is not set -&gt; addr from IRB-SCSW */</span>
	<span class="n">cpa</span> <span class="o">=</span> <span class="n">previous_erp</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* internal error 02 -</span>
<span class="cm">		   Unable to determine address of the CCW to be restarted */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;An error occurred in the DASD &quot;</span>
			<span class="s">&quot;device driver, reason=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;02&quot;</span><span class="p">);</span>

		<span class="n">previous_erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FAILED</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">previous_erp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">erp</span> <span class="o">=</span> <span class="n">previous_erp</span><span class="p">;</span>

	<span class="cm">/* update the LO with the new returned sense data  */</span>
	<span class="n">LO_data</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">LO_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* should not happen */</span>
		<span class="n">previous_erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FAILED</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">previous_erp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* operation code is WRITE DATA -&gt; data area orientation */</span>
		<span class="n">LO_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* operation code is FORMAT WRITE -&gt; index orientation */</span>
		<span class="n">LO_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC3</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">LO_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>	<span class="cm">/* operation */</span>
	<span class="p">}</span>

	<span class="n">LO_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* auxiliary */</span>
	<span class="n">LO_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">LO_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* count */</span>
	<span class="n">LO_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">29</span><span class="p">];</span>	<span class="cm">/* seek_addr.cyl */</span>
	<span class="n">LO_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>	<span class="cm">/* seek_addr.cyl 2nd byte */</span>
	<span class="n">LO_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>	<span class="cm">/* seek_addr.head 2nd byte */</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">LO_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">11</span><span class="p">]),</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* TIC to the failed ccw */</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>	<span class="cm">/* addr of DE ccw */</span>
	<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>			<span class="cm">/* addr of LE ccw */</span>
	<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>			<span class="cm">/* addr of TIC ccw */</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="n">cpa</span><span class="p">;</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_update_1B */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_COMPOUND_RETRY</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles the compound ERP action retry code.</span>
<span class="cm"> *   NOTE: At least one retry is done even if zero is specified</span>
<span class="cm"> *	   by the sense data. This makes enqueueing of the request</span>
<span class="cm"> *	   easier.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   sense		sense data of the actual error</span>
<span class="cm"> *   erp		pointer to the currently created ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		modified ERP pointer</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dasd_3990_erp_compound_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:		<span class="cm">/* no not retry */</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x01</span>:		<span class="cm">/* retry 2 times */</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x02</span>:		<span class="cm">/* retry 10 times */</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x03</span>:		<span class="cm">/* retry 256 times */</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_compound_retry</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_compound_retry */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_COMPOUND_PATH</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles the compound ERP action for retry on alternate</span>
<span class="cm"> *   channel path.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   sense		sense data of the actual error</span>
<span class="cm"> *   erp		pointer to the currently created ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		modified ERP pointer</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dasd_3990_erp_compound_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SENSE_BIT_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dasd_3990_erp_alternate_path</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DASD_CQR_FAILED</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DASD_CQR_VERIFY_PATH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* reset the lpm and the status to be able to</span>
<span class="cm">			 * try further actions. */</span>
			<span class="n">erp</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">opm</span><span class="p">;</span>
			<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_NEED_ERP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_compound_path</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_compound_path */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_COMPOUND_CODE</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles the compound ERP action for retry code.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   sense		sense data of the actual error</span>
<span class="cm"> *   erp		pointer to the currently created ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		NEW ERP pointer</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_compound_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SENSE_BIT_2</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">28</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x17</span>:
			<span class="cm">/* issue a Diagnostic Control command with an</span>
<span class="cm">			 * Inhibit Write subcommand and controller modifier */</span>
			<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_DCTL</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x25</span>:
			<span class="cm">/* wait for 5 seconds and retry again */</span>
			<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">dasd_3990_erp_block_queue</span> <span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="cm">/* should not happen - continue */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_compound_code</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_compound_code */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_COMPOUND_CONFIG</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Handles the compound ERP action for configruation</span>
<span class="cm"> *   dependent error.</span>
<span class="cm"> *   Note: duplex handling is not implemented (yet).</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   sense		sense data of the actual error</span>
<span class="cm"> *   erp		pointer to the currently created ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		modified ERP pointer</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dasd_3990_erp_compound_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SENSE_BIT_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SENSE_BIT_2</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* set to suspended duplex state then restart</span>
<span class="cm">		   internal error 05 - Set device to suspended duplex state</span>
<span class="cm">		   should be done */</span>
		<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;An error occurred in the DASD device driver, &quot;</span>
			<span class="s">&quot;reason=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;05&quot;</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_compound_config</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_compound_config */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_COMPOUND</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Does the further compound program action if</span>
<span class="cm"> *   compound retry was not successful.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   sense		sense data of the actual error</span>
<span class="cm"> *   erp		pointer to the current (failed) ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		(additional) ERP pointer</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_compound</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_compound_retry</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DASD_CQR_NEED_ERP</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">dasd_3990_erp_compound_path</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_compound_path</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DASD_CQR_NEED_ERP</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_compound_code</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_compound_code</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DASD_CQR_NEED_ERP</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">dasd_3990_erp_compound_config</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* if no compound action ERP specified, the request failed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DASD_CQR_NEED_ERP</span><span class="p">)</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FAILED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_compound */</span>

<span class="cm">/*</span>
<span class="cm"> *DASD_3990_ERP_HANDLE_SIM</span>
<span class="cm"> *</span>
<span class="cm"> *DESCRIPTION</span>
<span class="cm"> *  inspects the SIM SENSE data and starts an appropriate action</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   sense	   sense data of the actual error</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   none</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">dasd_3990_erp_handle_sim</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* print message according to log or message to operator mode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SIM_MSG_TO_OP</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* print SIM SRC from RefCode */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SIM - SRC: &quot;</span>
			    <span class="s">&quot;%02x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span>
			    <span class="n">sense</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span> <span class="n">sense</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SIM_LOG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* print SIM SRC Refcode */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;log SIM - SRC: &quot;</span>
			    <span class="s">&quot;%02x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span>
			    <span class="n">sense</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span> <span class="n">sense</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">sense</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_INSPECT_32</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Does a detailed inspection of the 32 byte sense data</span>
<span class="cm"> *   and sets up a related error recovery action.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   sense		sense data of the actual error</span>
<span class="cm"> *   erp		pointer to the currently created default ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp_filled		pointer to the ERP</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_inspect_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">erp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_inspect_32</span><span class="p">;</span>

	<span class="cm">/* check for SIM sense data */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SIM_SENSE</span><span class="p">)</span> <span class="o">==</span> <span class="n">DASD_SIM_SENSE</span><span class="p">)</span>
		<span class="n">dasd_3990_erp_handle_sim</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SENSE_BIT_0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* compound program action codes (byte25 bit 0 == &#39;1&#39;) */</span>
		<span class="n">dasd_3990_erp_compound_retry</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* single program action codes (byte25 bit 0 == &#39;0&#39;) */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">25</span><span class="p">])</span> <span class="p">{</span>

		<span class="k">case</span> <span class="mh">0x00</span>:	<span class="cm">/* success - use default ERP for retries */</span>
			<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_DEBUG</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
				    <span class="s">&quot;ERP called for successful request&quot;</span>
				    <span class="s">&quot; - just retry&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x01</span>:	<span class="cm">/* fatal error */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;ERP failed for the DASD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">DASD_CQR_FAILED</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x02</span>:	<span class="cm">/* intervention required */</span>
		<span class="k">case</span> <span class="mh">0x03</span>:	<span class="cm">/* intervention required during dual copy */</span>
			<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_int_req</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x0F</span>:  <span class="cm">/* length mismatch during update write command</span>
<span class="cm">			       internal error 08 - update write command error*/</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;An error occurred in the &quot;</span>
				<span class="s">&quot;DASD device driver, reason=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;08&quot;</span><span class="p">);</span>

			<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">DASD_CQR_FAILED</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x10</span>:  <span class="cm">/* logging required for other channel program */</span>
			<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_10_32</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x15</span>:	<span class="cm">/* next track outside defined extend</span>
<span class="cm">				   internal error 07 - The next track is not</span>
<span class="cm">				   within the defined storage extent */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;An error occurred in the DASD device driver, &quot;</span>
				<span class="s">&quot;reason=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;07&quot;</span><span class="p">);</span>

			<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_cleanup</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">DASD_CQR_FAILED</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x1B</span>:	<span class="cm">/* unexpected condition during write */</span>

			<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_1B_32</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x1C</span>:	<span class="cm">/* invalid data */</span>
			<span class="n">dev_emerg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;Data recovered during retry with PCI &quot;</span>
				    <span class="s">&quot;fetch mode active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* not possible to handle this situation in Linux */</span>
			<span class="n">panic</span>
			    <span class="p">(</span><span class="s">&quot;Invalid data - No way to inform application &quot;</span>
			     <span class="s">&quot;about the possibly incorrect data&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x1D</span>:	<span class="cm">/* state-change pending */</span>
			<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
				    <span class="s">&quot;A State change pending condition exists &quot;</span>
				    <span class="s">&quot;for the subsystem or device&quot;</span><span class="p">);</span>

			<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_4</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x1E</span>:	<span class="cm">/* busy */</span>
			<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
				    <span class="s">&quot;Busy condition exists &quot;</span>
				    <span class="s">&quot;for the subsystem or device&quot;</span><span class="p">);</span>
                        <span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_4</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>	<span class="cm">/* all others errors - default erp  */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_inspect_32 */</span>

<span class="cm">/*</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> * main ERP control functions (24 and 32 byte sense)</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_CONTROL_CHECK</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Does a generic inspection if a control check occurred and sets up</span>
<span class="cm"> *   the related error recovery procedure</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		pointer to the currently created default ERP</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp_filled		pointer to the erp</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_control_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsw_cstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCHN_STAT_INTF_CTRL_CHK</span>
					   <span class="o">|</span> <span class="n">SCHN_STAT_CHN_CTRL_CHK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;channel or interface control check&quot;</span><span class="p">);</span>
		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_4</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_INSPECT</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Does a detailed inspection for sense data by calling either</span>
<span class="cm"> *   the 24-byte or the 32-byte inspection routine.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		pointer to the currently created default ERP</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp_new		contens was possibly modified</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_inspect</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp_new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>

	<span class="cm">/* if this problem occurred on an alias retry on base */</span>
	<span class="n">erp_new</span> <span class="o">=</span> <span class="n">dasd_3990_erp_inspect_alias</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erp_new</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">erp_new</span><span class="p">;</span>

	<span class="cm">/* sense data are located in the refers record of the</span>
<span class="cm">	 * already set up new ERP !</span>
<span class="cm">	 * check if concurrent sens is available</span>
<span class="cm">	 */</span>
	<span class="n">sense</span> <span class="o">=</span> <span class="n">dasd_get_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sense</span><span class="p">)</span>
		<span class="n">erp_new</span> <span class="o">=</span> <span class="n">dasd_3990_erp_control_check</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
	<span class="cm">/* distinguish between 24 and 32 byte sense data */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SENSE_BIT_0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* inspect the 24 byte sense data */</span>
		<span class="n">erp_new</span> <span class="o">=</span> <span class="n">dasd_3990_erp_inspect_24</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* inspect the 32 byte sense data */</span>
		<span class="n">erp_new</span> <span class="o">=</span> <span class="n">dasd_3990_erp_inspect_32</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

	<span class="p">}</span>	<span class="cm">/* end distinguish between 24 and 32 byte sense data */</span>

	<span class="k">return</span> <span class="n">erp_new</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_ADD_ERP</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   This function adds an additional request block (ERP) to the head of</span>
<span class="cm"> *   the given cqr (or erp).</span>
<span class="cm"> *   For a command mode cqr the erp is initialized as an default erp</span>
<span class="cm"> *   (retry TIC).</span>
<span class="cm"> *   For transport mode we make a copy of the original TCW (points to</span>
<span class="cm"> *   the original TCCB, TIDALs, etc.) but give it a fresh</span>
<span class="cm"> *   TSB so the original sense data will not be changed.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   cqr		head of the current ERP-chain (or single cqr if</span>
<span class="cm"> *			first error)</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		pointer to new ERP-chain head</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="nf">dasd_3990_erp_add_erp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcw</span> <span class="o">*</span><span class="n">tcw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsb</span> <span class="o">*</span><span class="n">tsb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpmode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cplength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* TCW needs to be 64 byte aligned, so leave enough room */</span>
		<span class="n">datasize</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcw</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cplength</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">datasize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate additional request block */</span>
	<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_alloc_erp_request</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span>
				     <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">erp</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_ERR</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
				    <span class="s">&quot;Unable to allocate ERP request&quot;</span><span class="p">);</span>
			<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FAILED</span><span class="p">;</span>
                        <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">stopclk</span> <span class="o">=</span> <span class="n">get_clock</span> <span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_ERR</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
                                     <span class="s">&quot;Unable to allocate ERP request &quot;</span>
				     <span class="s">&quot;(%i retries left)&quot;</span><span class="p">,</span>
                                     <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">);</span>
			<span class="n">dasd_block_set_timer</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">,</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
                <span class="p">}</span>
		<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpmode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* make a shallow copy of the original tcw but set new tsb */</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">cpmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">tcw</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
		<span class="n">tsb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tsb</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tcw</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="o">*</span><span class="n">tcw</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">tcw</span> <span class="o">*</span><span class="p">)</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">);</span>
		<span class="n">tcw</span><span class="o">-&gt;</span><span class="n">tsb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">tsb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">==</span> <span class="n">DASD_ECKD_CCW_PSF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PSF cannot be chained from NOOP/TIC */</span>
		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* initialize request with default TIC to current ERP/CQR */</span>
		<span class="n">ccw</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_NOOP</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_TIC</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span>      <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">dasd_3990_erp_add_erp</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">refers</span>   <span class="o">=</span> <span class="n">cqr</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">memdev</span>   <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">block</span>    <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">magic</span>    <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">expires</span>  <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span>  <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_ADDITIONAL_ERP</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   An additional ERP is needed to handle the current error.</span>
<span class="cm"> *   Add ERP to the head of the ERP-chain containing the ERP processing</span>
<span class="cm"> *   determined based on the sense data.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   cqr		head of the current ERP-chain (or single cqr if</span>
<span class="cm"> *			first error)</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		pointer to new ERP-chain head</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_additional_erp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">cqr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* add erp and initialize with default TIC */</span>
	<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_add_erp</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">erp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

	<span class="cm">/* inspect sense, determine specific ERP if possible */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erp</span> <span class="o">!=</span> <span class="n">cqr</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_inspect</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_additional_erp */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_ERROR_MATCH</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   Check if the device status of the given cqr is the same.</span>
<span class="cm"> *   This means that the failed CCW and the relevant sense data</span>
<span class="cm"> *   must match.</span>
<span class="cm"> *   I don&#39;t distinguish between 24 and 32 byte sense because in case of</span>
<span class="cm"> *   24 byte sense byte 25 and 27 is set as well.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   cqr1		first cqr, which will be compared with the</span>
<span class="cm"> *   cqr2		second cqr.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   match		&#39;boolean&#39; for match found</span>
<span class="cm"> *			returns 1 if match found, otherwise 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_3990_erp_error_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr1</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sense1</span><span class="p">,</span> <span class="o">*</span><span class="n">sense2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cqr1</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">!=</span> <span class="n">cqr2</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sense1</span> <span class="o">=</span> <span class="n">dasd_get_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqr1</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">);</span>
	<span class="n">sense2</span> <span class="o">=</span> <span class="n">dasd_get_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqr2</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">);</span>

	<span class="cm">/* one request has sense data, the other not -&gt; no match, return 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sense1</span> <span class="o">!=</span> <span class="o">!</span><span class="n">sense2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* no sense data in both cases -&gt; check cstat for IFCC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sense1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sense2</span><span class="p">)</span>	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scsw_cstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqr1</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCHN_STAT_INTF_CTRL_CHK</span> <span class="o">|</span>
						    <span class="n">SCHN_STAT_CHN_CTRL_CHK</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">scsw_cstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqr2</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCHN_STAT_INTF_CTRL_CHK</span> <span class="o">|</span>
						    <span class="n">SCHN_STAT_CHN_CTRL_CHK</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* match with ifcc*/</span>
	<span class="p">}</span>
	<span class="cm">/* check sense data; byte 0-2,25,27 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sense1</span> <span class="o">&amp;&amp;</span> <span class="n">sense2</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">sense1</span><span class="p">,</span> <span class="n">sense2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">sense1</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">==</span> <span class="n">sense2</span><span class="p">[</span><span class="mi">27</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">sense1</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">==</span> <span class="n">sense2</span><span class="p">[</span><span class="mi">25</span><span class="p">])))</span> <span class="p">{</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* sense doesn&#39;t match */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* match */</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_error_match */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_IN_ERP</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   check if the current error already happened before.</span>
<span class="cm"> *   quick exit if current cqr is not an ERP (cqr-&gt;refers=NULL)</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   cqr		failed cqr (either original cqr or already an erp)</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		erp-pointer to the already defined error</span>
<span class="cm"> *			recovery procedure OR</span>
<span class="cm"> *			NULL if a &#39;new&#39; error occurred.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_in_erp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp_head</span> <span class="o">=</span> <span class="n">cqr</span><span class="p">,</span>	<span class="cm">/* save erp chain head */</span>
	<span class="o">*</span><span class="n">erp_match</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* save erp chain head */</span>
	<span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* &#39;boolean&#39; for matching error found */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">refers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* return if not in erp */</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check the erp/cqr chain for current error */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">match</span> <span class="o">=</span> <span class="n">dasd_3990_erp_error_match</span><span class="p">(</span><span class="n">erp_head</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">);</span>
		<span class="n">erp_match</span> <span class="o">=</span> <span class="n">cqr</span><span class="p">;</span>	<span class="cm">/* save possible matching erp  */</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">;</span>	<span class="cm">/* check next erp/cqr in queue */</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">refers</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* no match was found */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp_match</span><span class="p">;</span>	<span class="cm">/* return address of matching erp */</span>

<span class="p">}</span>				<span class="cm">/* END dasd_3990_erp_in_erp */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_FURTHER_ERP (24 &amp; 32 byte sense)</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   No retry is left for the current ERP. Check what has to be done</span>
<span class="cm"> *   with the ERP.</span>
<span class="cm"> *     - do further defined ERP action or</span>
<span class="cm"> *     - wait for interrupt or</span>
<span class="cm"> *     - exit with permanent error</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp		ERP which is in progress with no retry left</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		modified/additional ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_further_erp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sense</span> <span class="o">=</span> <span class="n">dasd_get_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">);</span>

	<span class="cm">/* check for 24 byte sense ERP */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_bus_out</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_action_1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_action_4</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_1</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_action_1_sec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_1_sec</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_action_5</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* retries have not been successful */</span>
		<span class="cm">/* prepare erp for retry on different channel path */</span>
		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_1</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SENSE_BIT_0</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* issue a Diagnostic Control command with an</span>
<span class="cm">			 * Inhibit Write subcommand */</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">25</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x17</span>:
			<span class="k">case</span> <span class="mh">0x57</span>:<span class="p">{</span>	<span class="cm">/* controller */</span>
					<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_DCTL</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mh">0x18</span>:
			<span class="k">case</span> <span class="mh">0x58</span>:<span class="p">{</span>	<span class="cm">/* channel path */</span>
					<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_DCTL</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mh">0x19</span>:
			<span class="k">case</span> <span class="mh">0x59</span>:<span class="p">{</span>	<span class="cm">/* storage director */</span>
					<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_DCTL</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="nl">default:</span>
				<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
					    <span class="s">&quot;invalid subcommand modifier 0x%x &quot;</span>
					    <span class="s">&quot;for Diagnostic Control Command&quot;</span><span class="p">,</span>
					    <span class="n">sense</span><span class="p">[</span><span class="mi">25</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* check for 32 byte sense ERP */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;&amp;</span>
		   <span class="p">((</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_compound_retry</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_compound_path</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_compound_code</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_compound_config</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_compound</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No retry left and no additional special handling</span>
<span class="cm">		 * necessary</span>
<span class="cm">		 */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;ERP %p has run out of retries and failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">erp</span><span class="p">);</span>

		<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_further_erp */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_HANDLE_MATCH_ERP</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   An error occurred again and an ERP has been detected which is already</span>
<span class="cm"> *   used to handle this error (e.g. retries).</span>
<span class="cm"> *   All prior ERP&#39;s are asumed to be successful and therefore removed</span>
<span class="cm"> *   from queue.</span>
<span class="cm"> *   If retry counter of matching erp is already 0, it is checked if further</span>
<span class="cm"> *   action is needed (besides retry) or if the ERP has failed.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   erp_head		first ERP in ERP-chain</span>
<span class="cm"> *   erp		ERP that handles the actual error.</span>
<span class="cm"> *			(matching erp)</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		modified/additional ERP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_handle_match_erp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp_head</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">erp_head</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp_done</span> <span class="o">=</span> <span class="n">erp_head</span><span class="p">;</span>	<span class="cm">/* finished req */</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp_free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* req to be freed */</span>

	<span class="cm">/* loop over successful ERPs and remove them from chanq */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">erp_done</span> <span class="o">!=</span> <span class="n">erp</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">erp_done</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>	<span class="cm">/* end of chain reached */</span>
			<span class="n">panic</span><span class="p">(</span><span class="n">PRINTK_HEADER</span> <span class="s">&quot;Programming error in ERP! The &quot;</span>
			      <span class="s">&quot;original request was lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* remove the request from the device queue */</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erp_done</span><span class="o">-&gt;</span><span class="n">blocklist</span><span class="p">);</span>

		<span class="n">erp_free</span> <span class="o">=</span> <span class="n">erp_done</span><span class="p">;</span>
		<span class="n">erp_done</span> <span class="o">=</span> <span class="n">erp_done</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">;</span>

		<span class="cm">/* free the finished erp request */</span>
		<span class="n">dasd_free_erp_request</span><span class="p">(</span><span class="n">erp_free</span><span class="p">,</span> <span class="n">erp_free</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>

	<span class="p">}</span>			<span class="cm">/* end while */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="kt">char</span> <span class="o">*</span><span class="n">sense</span> <span class="o">=</span> <span class="n">dasd_get_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">);</span>

		<span class="cm">/* check for special retries */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;&amp;</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_action_4</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_action_4</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;&amp;</span>
			   <span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_action_1B_32</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_update_1B</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;&amp;</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_3990_erp_int_req</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_int_req</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* simple retry	  */</span>
			<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_DEBUG</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
				    <span class="s">&quot;%i retries left for erp %p&quot;</span><span class="p">,</span>
				    <span class="n">erp</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">,</span> <span class="n">erp</span><span class="p">);</span>

			<span class="cm">/* handle the request again... */</span>
			<span class="n">erp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* no retry left - check for further necessary action	 */</span>
		<span class="cm">/* if no further actions, handle rest as permanent error */</span>
		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_further_erp</span><span class="p">(</span><span class="n">erp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_handle_match_erp */</span>

<span class="cm">/*</span>
<span class="cm"> * DASD_3990_ERP_ACTION</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION</span>
<span class="cm"> *   control routine for 3990 erp actions.</span>
<span class="cm"> *   Has to be called with the queue lock (namely the s390_irq_lock) acquired.</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER</span>
<span class="cm"> *   cqr		failed cqr (either original cqr or already an erp)</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN VALUES</span>
<span class="cm"> *   erp		erp-pointer to the head of the ERP action chain.</span>
<span class="cm"> *			This means:</span>
<span class="cm"> *			 - either a ptr to an additional ERP cqr or</span>
<span class="cm"> *			 - the original given cqr (which&#39;s status might</span>
<span class="cm"> *			   be modified)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_3990_erp_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">cqr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">erp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">temp_erp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_ERPLOG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* print current erp_chain */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;ERP chain at BEGINNING of ERP-ACTION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">temp_erp</span> <span class="o">=</span> <span class="n">cqr</span><span class="p">;</span>
		     <span class="n">temp_erp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">temp_erp</span> <span class="o">=</span> <span class="n">temp_erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;ERP %p (%02x) refers to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">temp_erp</span><span class="p">,</span> <span class="n">temp_erp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
				    <span class="n">temp_erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* double-check if current erp/cqr was successful */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scsw_cstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">scsw_dstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">)</span> <span class="o">==</span>
	     <span class="p">(</span><span class="n">DEV_STAT_CHN_END</span> <span class="o">|</span> <span class="n">DEV_STAT_DEV_END</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_DEBUG</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
			    <span class="s">&quot;ERP called for successful request %p&quot;</span>
			    <span class="s">&quot; - NO ERP necessary&quot;</span><span class="p">,</span> <span class="n">cqr</span><span class="p">);</span>

		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_DONE</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if error happened before */</span>
	<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_in_erp</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no matching erp found - set up erp */</span>
		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_additional_erp</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">erp</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* matching erp found - set all leading erp&#39;s to DONE */</span>
		<span class="n">erp</span> <span class="o">=</span> <span class="n">dasd_3990_erp_handle_match_erp</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">erp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_ERPLOG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* print current erp_chain */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;ERP chain at END of ERP-ACTION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">temp_erp</span> <span class="o">=</span> <span class="n">erp</span><span class="p">;</span>
		     <span class="n">temp_erp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">temp_erp</span> <span class="o">=</span> <span class="n">temp_erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;ERP %p (%02x) refers to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">temp_erp</span><span class="p">,</span> <span class="n">temp_erp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
				    <span class="n">temp_erp</span><span class="o">-&gt;</span><span class="n">refers</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* enqueue ERP request if it&#39;s a new one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">blocklist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_IN_ERP</span><span class="p">;</span>
		<span class="cm">/* add erp request before the cqr */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">blocklist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">blocklist</span><span class="p">);</span>
	<span class="p">}</span>



	<span class="k">return</span> <span class="n">erp</span><span class="p">;</span>

<span class="p">}</span>				<span class="cm">/* end dasd_3990_erp_action */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
