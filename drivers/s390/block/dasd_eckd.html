<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › block › dasd_eckd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dasd_eckd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * File...........: linux/drivers/s390/block/dasd_eckd.c</span>
<span class="cm"> * Author(s)......: Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;</span>
<span class="cm"> *		    Horst Hummel &lt;Horst.Hummel@de.ibm.com&gt;</span>
<span class="cm"> *		    Carsten Otte &lt;Cotte@de.ibm.com&gt;</span>
<span class="cm"> *		    Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;</span>
<span class="cm"> * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;</span>
<span class="cm"> * Copyright IBM Corp. 1999, 2009</span>
<span class="cm"> * EMC Symmetrix ioctl Copyright EMC Corporation, 2008</span>
<span class="cm"> * Author.........: Nigel Hislop &lt;hislop_nigel@emc.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;dasd-eckd&quot;</span>

<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;	</span><span class="cm">/* HDIO_GETGEO			    */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cp">#include &lt;asm/debug.h&gt;</span>
<span class="cp">#include &lt;asm/idals.h&gt;</span>
<span class="cp">#include &lt;asm/ebcdic.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/cio.h&gt;</span>
<span class="cp">#include &lt;asm/ccwdev.h&gt;</span>
<span class="cp">#include &lt;asm/itcw.h&gt;</span>

<span class="cp">#include &quot;dasd_int.h&quot;</span>
<span class="cp">#include &quot;dasd_eckd.h&quot;</span>
<span class="cp">#include &quot;../cio/chsc.h&quot;</span>


<span class="cp">#ifdef PRINTK_HEADER</span>
<span class="cp">#undef PRINTK_HEADER</span>
<span class="cp">#endif				</span><span class="cm">/* PRINTK_HEADER */</span><span class="cp"></span>
<span class="cp">#define PRINTK_HEADER &quot;dasd(eckd):&quot;</span>

<span class="cp">#define ECKD_C0(i) (i-&gt;home_bytes)</span>
<span class="cp">#define ECKD_F(i) (i-&gt;formula)</span>
<span class="cp">#define ECKD_F1(i) (ECKD_F(i)==0x01?(i-&gt;factors.f_0x01.f1):\</span>
<span class="cp">		    (i-&gt;factors.f_0x02.f1))</span>
<span class="cp">#define ECKD_F2(i) (ECKD_F(i)==0x01?(i-&gt;factors.f_0x01.f2):\</span>
<span class="cp">		    (i-&gt;factors.f_0x02.f2))</span>
<span class="cp">#define ECKD_F3(i) (ECKD_F(i)==0x01?(i-&gt;factors.f_0x01.f3):\</span>
<span class="cp">		    (i-&gt;factors.f_0x02.f3))</span>
<span class="cp">#define ECKD_F4(i) (ECKD_F(i)==0x02?(i-&gt;factors.f_0x02.f4):0)</span>
<span class="cp">#define ECKD_F5(i) (ECKD_F(i)==0x02?(i-&gt;factors.f_0x02.f5):0)</span>
<span class="cp">#define ECKD_F6(i) (i-&gt;factor6)</span>
<span class="cp">#define ECKD_F7(i) (i-&gt;factor7)</span>
<span class="cp">#define ECKD_F8(i) (i-&gt;factor8)</span>

<span class="cm">/*</span>
<span class="cm"> * raw track access always map to 64k in memory</span>
<span class="cm"> * so it maps to 16 blocks of 4k per track</span>
<span class="cm"> */</span>
<span class="cp">#define DASD_RAW_BLOCK_PER_TRACK 16</span>
<span class="cp">#define DASD_RAW_BLOCKSIZE 4096</span>
<span class="cm">/* 64k are 128 x 512 byte sectors  */</span>
<span class="cp">#define DASD_RAW_SECTORS_PER_TRACK 128</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_discipline</span> <span class="n">dasd_eckd_discipline</span><span class="p">;</span>

<span class="cm">/* The ccw bus type uses this table to find devices that it sends to</span>
<span class="cm"> * dasd_eckd_probe */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_device_id</span> <span class="n">dasd_eckd_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span> <span class="p">(</span><span class="mh">0x3990</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3390</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span> <span class="p">(</span><span class="mh">0x2105</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3390</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span> <span class="p">(</span><span class="mh">0x3880</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3380</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span> <span class="p">(</span><span class="mh">0x3990</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3380</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span> <span class="p">(</span><span class="mh">0x2105</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3380</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span> <span class="p">(</span><span class="mh">0x9343</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x9345</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span> <span class="p">(</span><span class="mh">0x2107</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3390</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span> <span class="p">(</span><span class="mh">0x2107</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3380</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span> <span class="p">(</span><span class="mh">0x1750</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3390</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span> <span class="p">(</span><span class="mh">0x1750</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3380</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* end of list */</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">dasd_eckd_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_driver</span> <span class="n">dasd_eckd_driver</span><span class="p">;</span> <span class="cm">/* see below */</span>

<span class="cp">#define INIT_CQR_OK 0</span>
<span class="cp">#define INIT_CQR_UNFORMATTED 1</span>
<span class="cp">#define INIT_CQR_ERROR 2</span>

<span class="cm">/* emergency request for reserve/release */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="n">ccw</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">}</span> <span class="o">*</span><span class="n">dasd_reserve_req</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">dasd_reserve_mutex</span><span class="p">);</span>

<span class="cm">/* definitions for the path verification worker */</span>
<span class="k">struct</span> <span class="n">path_verification_work_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">worker</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="n">ccw</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">rcd_buffer</span><span class="p">[</span><span class="n">DASD_ECKD_RCD_DATA_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">isglobal</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">tbvpm</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">path_verification_work_data</span> <span class="o">*</span><span class="n">path_verification_worker</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">dasd_path_verification_mutex</span><span class="p">);</span>

<span class="cm">/* initial attempt at a probe function. this can be simplified once</span>
<span class="cm"> * the other detection code is gone */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_probe</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set ECKD specific ccw-device options */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccw_device_set_options</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CCWDEV_ALLOW_FORCE</span> <span class="o">|</span>
				     <span class="n">CCWDEV_DO_PATHGROUP</span> <span class="o">|</span> <span class="n">CCWDEV_DO_MULTIPATH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
				<span class="s">&quot;dasd_eckd_probe: could not set &quot;</span>
				<span class="s">&quot;ccw-device options&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dasd_generic_probe</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dasd_eckd_discipline</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_set_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dasd_generic_set_online</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dasd_eckd_discipline</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">sizes_trk0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">84</span> <span class="p">};</span>
<span class="cp">#define LABEL_SIZE 140</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">round_up_multiple</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">no</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mult</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rem</span> <span class="o">=</span> <span class="n">no</span> <span class="o">%</span> <span class="n">mult</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rem</span> <span class="o">?</span> <span class="n">no</span> <span class="o">-</span> <span class="n">rem</span> <span class="o">+</span> <span class="n">mult</span> <span class="o">:</span> <span class="n">no</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">ceil_quot</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">d1</span> <span class="o">+</span> <span class="p">(</span><span class="n">d2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">recs_per_track</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_characteristics</span> <span class="o">*</span> <span class="n">rdc</span><span class="p">,</span>
	       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">kl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dn</span><span class="p">,</span> <span class="n">kn</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rdc</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x3380</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">kl</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1499</span> <span class="o">/</span> <span class="p">(</span><span class="mi">15</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">kl</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span>
				       <span class="n">ceil_quot</span><span class="p">(</span><span class="n">dl</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1499</span> <span class="o">/</span> <span class="p">(</span><span class="mi">15</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">dl</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
	<span class="k">case</span> <span class="mh">0x3390</span>:
		<span class="n">dn</span> <span class="o">=</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">dl</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">232</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kn</span> <span class="o">=</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">kl</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">232</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1729</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="mi">9</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">kl</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">kn</span><span class="p">,</span> <span class="mi">34</span><span class="p">)</span> <span class="o">+</span>
				       <span class="mi">9</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">dl</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">dn</span><span class="p">,</span> <span class="mi">34</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">1729</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="mi">9</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">dl</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">dn</span><span class="p">,</span> <span class="mi">34</span><span class="p">));</span>
	<span class="k">case</span> <span class="mh">0x9345</span>:
		<span class="n">dn</span> <span class="o">=</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">dl</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">232</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kn</span> <span class="o">=</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">kl</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">232</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1420</span> <span class="o">/</span> <span class="p">(</span><span class="mi">18</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">kl</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">kn</span><span class="p">,</span> <span class="mi">34</span><span class="p">)</span> <span class="o">+</span>
				       <span class="n">ceil_quot</span><span class="p">(</span><span class="n">dl</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">dn</span><span class="p">,</span> <span class="mi">34</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">1420</span> <span class="o">/</span> <span class="p">(</span><span class="mi">18</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">dl</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">dn</span><span class="p">,</span> <span class="mi">34</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_ch_t</span><span class="p">(</span><span class="k">struct</span> <span class="n">ch_t</span> <span class="o">*</span><span class="n">geo</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">cyl</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cyl</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">cyl</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">cyl</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">|=</span> <span class="n">head</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">check_XRC</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span>         <span class="o">*</span><span class="n">de_ccw</span><span class="p">,</span>
           <span class="k">struct</span> <span class="n">DE_eckd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
           <span class="k">struct</span> <span class="n">dasd_device</span>  <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

        <span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">facilities</span><span class="p">.</span><span class="n">XRC_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/* switch on System Time Stamp - needed for XRC Support */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">ga_extended</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="cm">/* switch on &#39;Time Stamp Valid&#39;   */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">ga_extended</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* switch on &#39;Extended Parameter&#39; */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">get_sync_clock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ep_sys_time</span><span class="p">);</span>
	<span class="cm">/* Ignore return code if sync clock is switched off. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSYS</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">de_ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">);</span>
	<span class="n">de_ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">define_extent</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DE_eckd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trk</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">totrk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">begcyl</span><span class="p">,</span> <span class="n">endcyl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">heads</span><span class="p">,</span> <span class="n">beghead</span><span class="p">,</span> <span class="n">endhead</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_DEFINE_EXTENT</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_HOME_ADDRESS</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_RECORD_ZERO</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_MT</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_CKD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_CKD_MT</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_KD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_KD_MT</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_COUNT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">operation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_MT</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_KD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_KD_MT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">operation</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">check_XRC</span> <span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_CKD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_CKD_MT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">DASD_BYPASS_CACHE</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">check_XRC</span> <span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_ERASE</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_HOME_ADDRESS</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_RECORD_ZERO</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">auth</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">DASD_BYPASS_CACHE</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">check_XRC</span> <span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;0x%x is not a known command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>	<span class="cm">/* ECKD */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">cu_type</span> <span class="o">==</span> <span class="mh">0x2105</span> <span class="o">||</span>
	     <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">cu_type</span> <span class="o">==</span> <span class="mh">0x2107</span> <span class="o">||</span>
	     <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">cu_type</span> <span class="o">==</span> <span class="mh">0x1750</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">&amp;&amp;</span> <span class="n">trk</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">ga_extended</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="cm">/* Regular Data Format Mode */</span>

	<span class="n">heads</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span><span class="p">;</span>
	<span class="n">begcyl</span> <span class="o">=</span> <span class="n">trk</span> <span class="o">/</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">beghead</span> <span class="o">=</span> <span class="n">trk</span> <span class="o">%</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">endcyl</span> <span class="o">=</span> <span class="n">totrk</span> <span class="o">/</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">endhead</span> <span class="o">=</span> <span class="n">totrk</span> <span class="o">%</span> <span class="n">heads</span><span class="p">;</span>

	<span class="cm">/* check for sequential prestage - enhance cylinder range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">==</span> <span class="n">DASD_SEQ_PRESTAGE</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">==</span> <span class="n">DASD_SEQ_ACCESS</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">endcyl</span> <span class="o">+</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">nr_cyl</span> <span class="o">&lt;</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">real_cyl</span><span class="p">)</span>
			<span class="n">endcyl</span> <span class="o">+=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">nr_cyl</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">endcyl</span> <span class="o">=</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">real_cyl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_ch_t</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">beg_ext</span><span class="p">,</span> <span class="n">begcyl</span><span class="p">,</span> <span class="n">beghead</span><span class="p">);</span>
	<span class="n">set_ch_t</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">end_ext</span><span class="p">,</span> <span class="n">endcyl</span><span class="p">,</span> <span class="n">endhead</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_XRC_on_prefix</span><span class="p">(</span><span class="k">struct</span> <span class="n">PFX_eckd_data</span> <span class="o">*</span><span class="n">pfxdata</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">dasd_device</span>  <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">facilities</span><span class="p">.</span><span class="n">XRC_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* switch on System Time Stamp - needed for XRC Support */</span>
	<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">define_extent</span><span class="p">.</span><span class="n">ga_extended</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="cm">/* &#39;Time Stamp Valid&#39;   */</span>
	<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">define_extent</span><span class="p">.</span><span class="n">ga_extended</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* &#39;Extended Parameter&#39; */</span>
	<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">validity</span><span class="p">.</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* &#39;Time Stamp Valid&#39;   */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">get_sync_clock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">define_extent</span><span class="p">.</span><span class="n">ep_sys_time</span><span class="p">);</span>
	<span class="cm">/* Ignore return code if sync clock is switched off. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSYS</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_LRE_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">LRE_eckd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trk</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rec_on_trk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reclen</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tlf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dn</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span>
	<span class="n">sector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec_on_trk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">dev_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x3390</span>:
			<span class="n">dn</span> <span class="o">=</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">reclen</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">232</span><span class="p">);</span>
			<span class="n">d</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">reclen</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="n">dn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">34</span><span class="p">);</span>
			<span class="n">sector</span> <span class="o">=</span> <span class="p">(</span><span class="mi">49</span> <span class="o">+</span> <span class="p">(</span><span class="n">rec_on_trk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="n">d</span><span class="p">))</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x3380</span>:
			<span class="n">d</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">reclen</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">sector</span> <span class="o">=</span> <span class="p">(</span><span class="mi">39</span> <span class="o">+</span> <span class="p">(</span><span class="n">rec_on_trk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">d</span><span class="p">))</span> <span class="o">/</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
	<span class="cm">/* note: meaning of count depends on the operation</span>
<span class="cm">	 *	 for record based I/O it&#39;s the number of records, but for</span>
<span class="cm">	 *	 track based I/O it&#39;s the number of tracks</span>
<span class="cm">	 */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_HOME_ADDRESS</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_HOME_ADDRESS</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_RECORD_ZERO</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_RECORD_ZERO</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_MT</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_KD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_KD_MT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">length_valid</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">reclen</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_CKD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_CKD_MT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">length_valid</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">reclen</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_FULL_TRACK</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x3F</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">extended_operation</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">extended_parameter_length</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">extended_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">extended_parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">extended_parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">count</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">extended_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">extended_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">count</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">extended_parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_TRACK_DATA</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">length_valid</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">reclen</span><span class="p">;</span>	<span class="cm">/* not tlf, as one might think */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x3F</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">extended_operation</span> <span class="o">=</span> <span class="mh">0x23</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_MT</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_KD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_KD_MT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">length_valid</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">reclen</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_CKD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_CKD_MT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">length_valid</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">reclen</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_COUNT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_TRACK</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x0C</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">extended_parameter_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_TRACK_DATA</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">length_valid</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">tlf</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x0C</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_ERASE</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">reclen</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">length_valid</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_ERR</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
			    <span class="s">&quot;fill LRE unknown opcode 0x%x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">set_ch_t</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">seek_addr</span><span class="p">,</span>
		 <span class="n">trk</span> <span class="o">/</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span><span class="p">,</span>
		 <span class="n">trk</span> <span class="o">%</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">search_arg</span><span class="p">.</span><span class="n">cyl</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">seek_addr</span><span class="p">.</span><span class="n">cyl</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">search_arg</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">seek_addr</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">search_arg</span><span class="p">.</span><span class="n">record</span> <span class="o">=</span> <span class="n">rec_on_trk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prefix_LRE</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">PFX_eckd_data</span> <span class="o">*</span><span class="n">pfxdata</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">totrk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">basedev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">startdev</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">format</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rec_on_trk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tlf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">basepriv</span><span class="p">,</span> <span class="o">*</span><span class="n">startpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DE_eckd_data</span> <span class="o">*</span><span class="n">dedata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">LRE_eckd_data</span> <span class="o">*</span><span class="n">lredata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">begcyl</span><span class="p">,</span> <span class="n">endcyl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">heads</span><span class="p">,</span> <span class="n">beghead</span><span class="p">,</span> <span class="n">endhead</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">basepriv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">basedev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">startpriv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">startdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">dedata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">define_extent</span><span class="p">;</span>
	<span class="n">lredata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">locate_record</span><span class="p">;</span>

	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_PFX</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">DASD_ECKD_CCW_WRITE_FULL_TRACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pfxdata</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">pfxdata</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pfxdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pfxdata</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pfxdata</span><span class="p">);</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">pfxdata</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pfxdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pfxdata</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* prefix data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_ERR</span><span class="p">,</span> <span class="n">basedev</span><span class="p">,</span>
			      <span class="s">&quot;PFX LRE unknown format 0x%x&quot;</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">base_address</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">ned</span><span class="o">-&gt;</span><span class="n">unit_addr</span><span class="p">;</span>
	<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">base_lss</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">ned</span><span class="o">-&gt;</span><span class="n">ID</span><span class="p">;</span>
	<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">validity</span><span class="p">.</span><span class="n">define_extent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* private uid is kept up to date, conf_data may be outdated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">startpriv</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">UA_BASE_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">validity</span><span class="p">.</span><span class="n">verify_base</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">startpriv</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UA_HYPER_PAV_ALIAS</span><span class="p">)</span>
			<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">validity</span><span class="p">.</span><span class="n">hyper_pav</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* define extend data (mostly)*/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_HOME_ADDRESS</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_RECORD_ZERO</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_MT</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_CKD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_CKD_MT</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_KD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_KD_MT</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_COUNT</span>:
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">operation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_TRACK</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_TRACK_DATA</span>:
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">operation</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">blk_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_MT</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_KD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_KD_MT</span>:
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">operation</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">check_XRC_on_prefix</span><span class="p">(</span><span class="n">pfxdata</span><span class="p">,</span> <span class="n">basedev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_CKD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_CKD_MT</span>:
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">DASD_BYPASS_CACHE</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">check_XRC_on_prefix</span><span class="p">(</span><span class="n">pfxdata</span><span class="p">,</span> <span class="n">basedev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_ERASE</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_HOME_ADDRESS</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_RECORD_ZERO</span>:
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">auth</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">DASD_BYPASS_CACHE</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">check_XRC_on_prefix</span><span class="p">(</span><span class="n">pfxdata</span><span class="p">,</span> <span class="n">basedev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_FULL_TRACK</span>:
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">operation</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">blk_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_TRACK_DATA</span>:
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">operation</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">blk_size</span> <span class="o">=</span> <span class="n">blksize</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">check_XRC_on_prefix</span><span class="p">(</span><span class="n">pfxdata</span><span class="p">,</span> <span class="n">basedev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_ERR</span><span class="p">,</span> <span class="n">basedev</span><span class="p">,</span>
			    <span class="s">&quot;PFX LRE unknown opcode 0x%x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>	<span class="cm">/* ECKD */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">cu_type</span> <span class="o">==</span> <span class="mh">0x2105</span> <span class="o">||</span>
	     <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">cu_type</span> <span class="o">==</span> <span class="mh">0x2107</span> <span class="o">||</span>
	     <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">cu_type</span> <span class="o">==</span> <span class="mh">0x1750</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">&amp;&amp;</span> <span class="n">trk</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">ga_extended</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="cm">/* Regular Data Format Mode */</span>

	<span class="n">heads</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span><span class="p">;</span>
	<span class="n">begcyl</span> <span class="o">=</span> <span class="n">trk</span> <span class="o">/</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">beghead</span> <span class="o">=</span> <span class="n">trk</span> <span class="o">%</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">endcyl</span> <span class="o">=</span> <span class="n">totrk</span> <span class="o">/</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">endhead</span> <span class="o">=</span> <span class="n">totrk</span> <span class="o">%</span> <span class="n">heads</span><span class="p">;</span>

	<span class="cm">/* check for sequential prestage - enhance cylinder range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">==</span> <span class="n">DASD_SEQ_PRESTAGE</span> <span class="o">||</span>
	    <span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">==</span> <span class="n">DASD_SEQ_ACCESS</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">endcyl</span> <span class="o">+</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">nr_cyl</span> <span class="o">&lt;</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">real_cyl</span><span class="p">)</span>
			<span class="n">endcyl</span> <span class="o">+=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">nr_cyl</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">endcyl</span> <span class="o">=</span> <span class="p">(</span><span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">real_cyl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_ch_t</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dedata</span><span class="o">-&gt;</span><span class="n">beg_ext</span><span class="p">,</span> <span class="n">begcyl</span><span class="p">,</span> <span class="n">beghead</span><span class="p">);</span>
	<span class="n">set_ch_t</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dedata</span><span class="o">-&gt;</span><span class="n">end_ext</span><span class="p">,</span> <span class="n">endcyl</span><span class="p">,</span> <span class="n">endhead</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fill_LRE_data</span><span class="p">(</span><span class="n">lredata</span><span class="p">,</span> <span class="n">trk</span><span class="p">,</span> <span class="n">rec_on_trk</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			      <span class="n">basedev</span><span class="p">,</span> <span class="n">blksize</span><span class="p">,</span> <span class="n">tlf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prefix</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">PFX_eckd_data</span> <span class="o">*</span><span class="n">pfxdata</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">totrk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">basedev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">startdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">prefix_LRE</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">pfxdata</span><span class="p">,</span> <span class="n">trk</span><span class="p">,</span> <span class="n">totrk</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">basedev</span><span class="p">,</span> <span class="n">startdev</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">locate_record</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">LO_eckd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trk</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rec_on_trk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no_rec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span> <span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reclen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dn</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
		  <span class="s">&quot;Locate: trk %d, rec %d, no_rec %d, cmd %d, reclen %d&quot;</span><span class="p">,</span>
		  <span class="n">trk</span><span class="p">,</span> <span class="n">rec_on_trk</span><span class="p">,</span> <span class="n">no_rec</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">reclen</span><span class="p">);</span>

	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_LOCATE_RECORD</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span><span class="p">));</span>
	<span class="n">sector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec_on_trk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">dev_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x3390</span>:
			<span class="n">dn</span> <span class="o">=</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">reclen</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">232</span><span class="p">);</span>
			<span class="n">d</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">reclen</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="n">dn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">34</span><span class="p">);</span>
			<span class="n">sector</span> <span class="o">=</span> <span class="p">(</span><span class="mi">49</span> <span class="o">+</span> <span class="p">(</span><span class="n">rec_on_trk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="n">d</span><span class="p">))</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x3380</span>:
			<span class="n">d</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">reclen</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">sector</span> <span class="o">=</span> <span class="p">(</span><span class="mi">39</span> <span class="o">+</span> <span class="p">(</span><span class="n">rec_on_trk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">d</span><span class="p">))</span> <span class="o">/</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">no_rec</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_HOME_ADDRESS</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_HOME_ADDRESS</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_RECORD_ZERO</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_RECORD_ZERO</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_MT</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_KD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_KD_MT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">last_bytes_used</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">reclen</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_CKD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_CKD_MT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">last_bytes_used</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">reclen</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_MT</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_KD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_KD_MT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">last_bytes_used</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">reclen</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_CKD</span>:
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_CKD_MT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">last_bytes_used</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">reclen</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_COUNT</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_ERASE</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">reclen</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">last_bytes_used</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_ERR</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;unknown locate record &quot;</span>
			      <span class="s">&quot;opcode 0x%x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_ch_t</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">seek_addr</span><span class="p">,</span>
		 <span class="n">trk</span> <span class="o">/</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span><span class="p">,</span>
		 <span class="n">trk</span> <span class="o">%</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">search_arg</span><span class="p">.</span><span class="n">cyl</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">seek_addr</span><span class="p">.</span><span class="n">cyl</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">search_arg</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">seek_addr</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">search_arg</span><span class="p">.</span><span class="n">record</span> <span class="o">=</span> <span class="n">rec_on_trk</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns 1 if the block is one of the special blocks that needs</span>
<span class="cm"> * to get read/written with the KD variant of the command.</span>
<span class="cm"> * That is DASD_ECKD_READ_KD_MT instead of DASD_ECKD_READ_MT and</span>
<span class="cm"> * DASD_ECKD_WRITE_KD_MT instead of DASD_ECKD_WRITE_MT.</span>
<span class="cm"> * Luckily the KD variants differ only by one bit (0x08) from the</span>
<span class="cm"> * normal variant. So don&#39;t wonder about code like:</span>
<span class="cm"> * if (dasd_eckd_cdl_special(blk_per_trk, recid))</span>
<span class="cm"> *         ccw-&gt;cmd_code |= 0x8;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_cdl_special</span><span class="p">(</span><span class="kt">int</span> <span class="n">blk_per_trk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">recid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recid</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recid</span> <span class="o">&lt;</span> <span class="n">blk_per_trk</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recid</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">blk_per_trk</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the record size for the special blocks of the cdl format.</span>
<span class="cm"> * Only returns something useful if dasd_eckd_cdl_special is true</span>
<span class="cm"> * for the recid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_cdl_reclen</span><span class="p">(</span><span class="kt">int</span> <span class="n">recid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recid</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sizes_trk0</span><span class="p">[</span><span class="n">recid</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">LABEL_SIZE</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* create unique id from private structure. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">create_uid</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_uid</span> <span class="o">*</span><span class="n">uid</span><span class="p">;</span>

	<span class="n">uid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_uid</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">ned</span><span class="o">-&gt;</span><span class="n">HDA_manufacturer</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">EBCASC</span><span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">ned</span><span class="o">-&gt;</span><span class="n">HDA_location</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">EBCASC</span><span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">uid</span><span class="o">-&gt;</span><span class="n">ssid</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">gneq</span><span class="o">-&gt;</span><span class="n">subsystemID</span><span class="p">;</span>
	<span class="n">uid</span><span class="o">-&gt;</span><span class="n">real_unit_addr</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">ned</span><span class="o">-&gt;</span><span class="n">unit_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">sneq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uid</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">sneq</span><span class="o">-&gt;</span><span class="n">sua_flags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">UA_BASE_PAV_ALIAS</span><span class="p">)</span>
			<span class="n">uid</span><span class="o">-&gt;</span><span class="n">base_unit_addr</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">sneq</span><span class="o">-&gt;</span><span class="n">base_unit_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">uid</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">UA_BASE_DEVICE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">vdsneq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">vduit</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span>
				<span class="n">private</span><span class="o">-&gt;</span><span class="n">vdsneq</span><span class="o">-&gt;</span><span class="n">uit</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generate device unique id that specifies the physical device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_generate_uid</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">private</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">ned</span> <span class="o">||</span> <span class="o">!</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">gneq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">create_uid</span><span class="p">(</span><span class="n">private</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_get_uid</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dasd_uid</span> <span class="o">*</span><span class="n">uid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
		<span class="o">*</span><span class="n">uid</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * compare device UID with data of a given dasd_eckd_private structure</span>
<span class="cm"> * return 0 for match</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_compare_path_uid</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_uid</span> <span class="n">device_uid</span><span class="p">;</span>

	<span class="n">create_uid</span><span class="p">(</span><span class="n">private</span><span class="p">);</span>
	<span class="n">dasd_eckd_get_uid</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_uid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_uid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_uid</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_eckd_fill_rcd_cqr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">,</span>
				   <span class="n">__u8</span> <span class="o">*</span><span class="n">rcd_buffer</span><span class="p">,</span>
				   <span class="n">__u8</span> <span class="n">lpm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * buffer has to start with EBCDIC &quot;V1.0&quot; to show</span>
<span class="cm">	 * support for virtual device SNEQ</span>
<span class="cm">	 */</span>
	<span class="n">rcd_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xE5</span><span class="p">;</span>
	<span class="n">rcd_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF1</span><span class="p">;</span>
	<span class="n">rcd_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4B</span><span class="p">;</span>
	<span class="n">rcd_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF0</span><span class="p">;</span>

	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_RCD</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span><span class="n">rcd_buffer</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">DASD_ECKD_RCD_DATA_SIZE</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">DASD_ECKD_MAGIC</span><span class="p">;</span>

	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">lpm</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_CQR_VERIFY_PATH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wakeup helper for read_conf</span>
<span class="cm"> * if the cqr is not done and needs some error recovery</span>
<span class="cm"> * the buffer has to be re-initialized with the EBCDIC &quot;V1.0&quot;</span>
<span class="cm"> * to show support for virtual device SNEQ</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_conf_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">rcd_buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span>  <span class="n">DASD_CQR_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
		<span class="n">rcd_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)((</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rcd_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rcd_buffer</span><span class="p">));</span>

		<span class="n">rcd_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xE5</span><span class="p">;</span>
		<span class="n">rcd_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF1</span><span class="p">;</span>
		<span class="n">rcd_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4B</span><span class="p">;</span>
		<span class="n">rcd_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dasd_wakeup_cb</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_read_conf_immediately</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">,</span>
					   <span class="n">__u8</span> <span class="o">*</span><span class="n">rcd_buffer</span><span class="p">,</span>
					   <span class="n">__u8</span> <span class="n">lpm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ciw</span> <span class="o">*</span><span class="n">ciw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * sanity check: scan for RCD command in extended SenseID data</span>
<span class="cm">	 * some devices do not support RCD</span>
<span class="cm">	 */</span>
	<span class="n">ciw</span> <span class="o">=</span> <span class="n">ccw_device_get_ciw</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CIW_TYPE_RCD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ciw</span> <span class="o">||</span> <span class="n">ciw</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">DASD_ECKD_CCW_RCD</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">dasd_eckd_fill_rcd_cqr</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">cqr</span><span class="p">,</span> <span class="n">rcd_buffer</span><span class="p">,</span> <span class="n">lpm</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_USE_ERP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_CQR_ALLOW_SLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">read_conf_cb</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_sleep_on_immediatly</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_read_conf_lpm</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">**</span><span class="n">rcd_buffer</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="o">*</span><span class="n">rcd_buffer_size</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">lpm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ciw</span> <span class="o">*</span><span class="n">ciw</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rcd_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * sanity check: scan for RCD command in extended SenseID data</span>
<span class="cm">	 * some devices do not support RCD</span>
<span class="cm">	 */</span>
	<span class="n">ciw</span> <span class="o">=</span> <span class="n">ccw_device_get_ciw</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CIW_TYPE_RCD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ciw</span> <span class="o">||</span> <span class="n">ciw</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">DASD_ECKD_CCW_RCD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcd_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">DASD_ECKD_RCD_DATA_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rcd_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* RCD */</span><span class="p">,</span>
				   <span class="mi">0</span><span class="p">,</span> <span class="cm">/* use rcd_buf as data ara */</span>
				   <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			      <span class="s">&quot;Could not allocate RCD request&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dasd_eckd_fill_rcd_cqr</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">cqr</span><span class="p">,</span> <span class="n">rcd_buf</span><span class="p">,</span> <span class="n">lpm</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">read_conf_cb</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dasd_sleep_on</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * on success we update the user input parms</span>
<span class="cm">	 */</span>
	<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rcd_buffer_size</span> <span class="o">=</span> <span class="n">DASD_ECKD_RCD_DATA_SIZE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rcd_buffer</span> <span class="o">=</span> <span class="n">rcd_buf</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rcd_buf</span><span class="p">);</span>
	<span class="o">*</span><span class="n">rcd_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rcd_buffer_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_identify_conf_parts</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">dasd_sneq</span> <span class="o">*</span><span class="n">sneq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">private</span><span class="o">-&gt;</span><span class="n">ned</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">sneq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">vdsneq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">gneq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_sneq</span><span class="p">);</span>
	<span class="n">sneq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_sneq</span> <span class="o">*</span><span class="p">)</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sneq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">sneq</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">private</span><span class="o">-&gt;</span><span class="n">sneq</span> <span class="o">=</span> <span class="n">sneq</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sneq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">sneq</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">private</span><span class="o">-&gt;</span><span class="n">vdsneq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vd_sneq</span> <span class="o">*</span><span class="p">)</span><span class="n">sneq</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sneq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">private</span><span class="o">-&gt;</span><span class="n">gneq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_gneq</span> <span class="o">*</span><span class="p">)</span><span class="n">sneq</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sneq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">sneq</span><span class="o">-&gt;</span><span class="n">res1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">private</span><span class="o">-&gt;</span><span class="n">ned</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ned</span> <span class="o">*</span><span class="p">)</span><span class="n">sneq</span><span class="p">;</span>
		<span class="n">sneq</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">ned</span> <span class="o">||</span> <span class="o">!</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">gneq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">private</span><span class="o">-&gt;</span><span class="n">ned</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">private</span><span class="o">-&gt;</span><span class="n">sneq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">private</span><span class="o">-&gt;</span><span class="n">vdsneq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">private</span><span class="o">-&gt;</span><span class="n">gneq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">dasd_eckd_path_access</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">conf_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">conf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_gneq</span> <span class="o">*</span><span class="n">gneq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">found</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">conf_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gneq</span><span class="p">);</span>
	<span class="n">gneq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_gneq</span> <span class="o">*</span><span class="p">)</span><span class="n">conf_data</span><span class="p">;</span>
	<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gneq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gneq</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">gneq</span><span class="p">)[</span><span class="mi">18</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_read_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">conf_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">conf_len</span><span class="p">,</span> <span class="n">conf_data_saved</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">lpm</span><span class="p">,</span> <span class="n">opm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">,</span> <span class="n">path_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_path</span> <span class="o">*</span><span class="n">path_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_uid</span> <span class="o">*</span><span class="n">uid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">print_path_uid</span><span class="p">[</span><span class="mi">60</span><span class="p">],</span> <span class="n">print_device_uid</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">path_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">;</span>
	<span class="n">opm</span> <span class="o">=</span> <span class="n">ccw_device_get_path_mask</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">conf_data_saved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* get configuration data per operational path */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">lpm</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">lpm</span><span class="p">;</span> <span class="n">lpm</span><span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lpm</span> <span class="o">&amp;</span> <span class="n">opm</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eckd_read_conf_lpm</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_data</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">conf_len</span><span class="p">,</span> <span class="n">lpm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* -EOPNOTSUPP is ok */</span>
			<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span>
					<span class="s">&quot;Read configuration data returned &quot;</span>
					<span class="s">&quot;error %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
					<span class="s">&quot;No configuration data &quot;</span>
					<span class="s">&quot;retrieved&quot;</span><span class="p">);</span>
			<span class="cm">/* no further analysis possible */</span>
			<span class="n">path_data</span><span class="o">-&gt;</span><span class="n">opm</span> <span class="o">|=</span> <span class="n">lpm</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* no error */</span>
		<span class="p">}</span>
		<span class="cm">/* save first valid configuration data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf_data_saved</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_data</span><span class="p">);</span>
			<span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_data</span> <span class="o">=</span> <span class="n">conf_data</span><span class="p">;</span>
			<span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_len</span> <span class="o">=</span> <span class="n">conf_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dasd_eckd_identify_conf_parts</span><span class="p">(</span><span class="n">private</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">conf_data</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * build device UID that other path data</span>
<span class="cm">			 * can be compared to it</span>
<span class="cm">			 */</span>
			<span class="n">dasd_eckd_generate_uid</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
			<span class="n">conf_data_saved</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">path_private</span><span class="p">.</span><span class="n">conf_data</span> <span class="o">=</span> <span class="n">conf_data</span><span class="p">;</span>
			<span class="n">path_private</span><span class="p">.</span><span class="n">conf_len</span> <span class="o">=</span> <span class="n">DASD_ECKD_RCD_DATA_SIZE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dasd_eckd_identify_conf_parts</span><span class="p">(</span>
				    <span class="o">&amp;</span><span class="n">path_private</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">path_private</span><span class="p">.</span><span class="n">conf_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">path_private</span><span class="p">.</span><span class="n">conf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">conf_data</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dasd_eckd_compare_path_uid</span><span class="p">(</span>
				    <span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path_private</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">uid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">path_private</span><span class="p">.</span><span class="n">uid</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">vduit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">snprintf</span><span class="p">(</span><span class="n">print_path_uid</span><span class="p">,</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="n">print_path_uid</span><span class="p">),</span>
						 <span class="s">&quot;%s.%s.%04x.%02x.%s&quot;</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">uid</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">uid</span><span class="o">-&gt;</span><span class="n">real_unit_addr</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">vduit</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">snprintf</span><span class="p">(</span><span class="n">print_path_uid</span><span class="p">,</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="n">print_path_uid</span><span class="p">),</span>
						 <span class="s">&quot;%s.%s.%04x.%02x&quot;</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">uid</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">real_unit_addr</span><span class="p">);</span>
				<span class="n">uid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">vduit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">snprintf</span><span class="p">(</span><span class="n">print_device_uid</span><span class="p">,</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="n">print_device_uid</span><span class="p">),</span>
						 <span class="s">&quot;%s.%s.%04x.%02x.%s&quot;</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">uid</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">uid</span><span class="o">-&gt;</span><span class="n">real_unit_addr</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">vduit</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">snprintf</span><span class="p">(</span><span class="n">print_device_uid</span><span class="p">,</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="n">print_device_uid</span><span class="p">),</span>
						 <span class="s">&quot;%s.%s.%04x.%02x&quot;</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">uid</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">real_unit_addr</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Not all channel paths lead to &quot;</span>
					<span class="s">&quot;the same device, path %02X leads to &quot;</span>
					<span class="s">&quot;device %s instead of %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lpm</span><span class="p">,</span>
					<span class="n">print_path_uid</span><span class="p">,</span> <span class="n">print_device_uid</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">path_private</span><span class="p">.</span><span class="n">conf_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">path_private</span><span class="p">.</span><span class="n">conf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dasd_eckd_path_access</span><span class="p">(</span><span class="n">conf_data</span><span class="p">,</span> <span class="n">conf_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">path_data</span><span class="o">-&gt;</span><span class="n">npm</span> <span class="o">|=</span> <span class="n">lpm</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>:
			<span class="n">path_data</span><span class="o">-&gt;</span><span class="n">ppm</span> <span class="o">|=</span> <span class="n">lpm</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">path_data</span><span class="o">-&gt;</span><span class="n">opm</span> <span class="o">|=</span> <span class="n">lpm</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conf_data</span> <span class="o">!=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_data</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">conf_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_fcx_max_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">lpm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mdc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fcx_max_data</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">fcx_max_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdc</span> <span class="o">=</span> <span class="n">ccw_device_get_mdc</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">lpm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mdc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Detecting the maximum data size for zHPF &quot;</span>
				 <span class="s">&quot;requests failed (rc=%d) for a new path %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">mdc</span><span class="p">,</span> <span class="n">lpm</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">mdc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fcx_max_data</span> <span class="o">=</span> <span class="n">mdc</span> <span class="o">*</span> <span class="n">FCX_MAX_DATA_FACTOR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcx_max_data</span> <span class="o">&lt;</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">fcx_max_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;The maximum data size for zHPF requests %u &quot;</span>
				 <span class="s">&quot;on a new path %x is below the active maximum &quot;</span>
				 <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fcx_max_data</span><span class="p">,</span> <span class="n">lpm</span><span class="p">,</span>
				 <span class="n">private</span><span class="o">-&gt;</span><span class="n">fcx_max_data</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rebuild_device_uid</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">path_verification_work_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_path</span> <span class="o">*</span><span class="n">path_data</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">lpm</span><span class="p">,</span> <span class="n">opm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">path_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">;</span>
	<span class="n">opm</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">opm</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">lpm</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">lpm</span><span class="p">;</span> <span class="n">lpm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lpm</span> <span class="o">&amp;</span> <span class="n">opm</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rcd_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rcd_buffer</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cqr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cqr</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">cqr</span><span class="p">.</span><span class="n">cpaddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eckd_read_conf_immediately</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cqr</span><span class="p">,</span>
						     <span class="n">data</span><span class="o">-&gt;</span><span class="n">rcd_buffer</span><span class="p">,</span>
						     <span class="n">lpm</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span> <span class="cm">/* -EOPNOTSUPP is ok */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span>
					<span class="s">&quot;Read configuration data &quot;</span>
					<span class="s">&quot;returned error %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rcd_buffer</span><span class="p">,</span>
		       <span class="n">DASD_ECKD_RCD_DATA_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dasd_eckd_identify_conf_parts</span><span class="p">(</span><span class="n">private</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* first valid path is enough */</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eckd_generate_uid</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_path_verification_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">path_verification_work_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="n">path_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_uid</span> <span class="o">*</span><span class="n">uid</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">path_rcd_buf</span><span class="p">[</span><span class="n">DASD_ECKD_RCD_DATA_SIZE</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">lpm</span><span class="p">,</span> <span class="n">opm</span><span class="p">,</span> <span class="n">npm</span><span class="p">,</span> <span class="n">ppm</span><span class="p">,</span> <span class="n">epm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">print_uid</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">path_verification_work_data</span><span class="p">,</span> <span class="n">worker</span><span class="p">);</span>
	<span class="n">device</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="cm">/* delay path verification until device was resumed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DASD_FLAG_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">opm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">npm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ppm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">epm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">lpm</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">lpm</span><span class="p">;</span> <span class="n">lpm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lpm</span> <span class="o">&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tbvpm</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rcd_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rcd_buffer</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cqr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cqr</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">cqr</span><span class="p">.</span><span class="n">cpaddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eckd_read_conf_immediately</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cqr</span><span class="p">,</span>
						     <span class="n">data</span><span class="o">-&gt;</span><span class="n">rcd_buffer</span><span class="p">,</span>
						     <span class="n">lpm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">dasd_eckd_path_access</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rcd_buffer</span><span class="p">,</span>
						      <span class="n">DASD_ECKD_RCD_DATA_SIZE</span><span class="p">)</span>
				<span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x02</span>:
				<span class="n">npm</span> <span class="o">|=</span> <span class="n">lpm</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x03</span>:
				<span class="n">ppm</span> <span class="o">|=</span> <span class="n">lpm</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">opm</span> <span class="o">|=</span> <span class="n">lpm</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
					<span class="s">&quot;path verification: No configuration &quot;</span>
					<span class="s">&quot;data retrieved&quot;</span><span class="p">);</span>
			<span class="n">opm</span> <span class="o">|=</span> <span class="n">lpm</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
					<span class="s">&quot;path verification: device is stopped,&quot;</span>
					<span class="s">&quot; try again later&quot;</span><span class="p">);</span>
			<span class="n">epm</span> <span class="o">|=</span> <span class="n">lpm</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Reading device feature codes failed &quot;</span>
				 <span class="s">&quot;(rc=%d) for new path %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">lpm</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">verify_fcx_max_data</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">lpm</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">opm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">lpm</span><span class="p">;</span>
			<span class="n">npm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">lpm</span><span class="p">;</span>
			<span class="n">ppm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">lpm</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * save conf_data for comparison after</span>
<span class="cm">		 * rebuild_device_uid may have changed</span>
<span class="cm">		 * the original data</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path_rcd_buf</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rcd_buffer</span><span class="p">,</span>
		       <span class="n">DASD_ECKD_RCD_DATA_SIZE</span><span class="p">);</span>
		<span class="n">path_private</span><span class="p">.</span><span class="n">conf_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">path_rcd_buf</span><span class="p">;</span>
		<span class="n">path_private</span><span class="p">.</span><span class="n">conf_len</span> <span class="o">=</span> <span class="n">DASD_ECKD_RCD_DATA_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dasd_eckd_identify_conf_parts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path_private</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">path_private</span><span class="p">.</span><span class="n">conf_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">path_private</span><span class="p">.</span><span class="n">conf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * compare path UID with device UID only if at least</span>
<span class="cm">		 * one valid path is left</span>
<span class="cm">		 * in other case the device UID may have changed and</span>
<span class="cm">		 * the first working path UID will be used as device UID</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">opm</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dasd_eckd_compare_path_uid</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path_private</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * the comparison was not successful</span>
<span class="cm">			 * rebuild the device UID with at least one</span>
<span class="cm">			 * known path in case a z/VM hyperswap command</span>
<span class="cm">			 * has changed the device</span>
<span class="cm">			 *</span>
<span class="cm">			 * after this compare again</span>
<span class="cm">			 *</span>
<span class="cm">			 * if either the rebuild or the recompare fails</span>
<span class="cm">			 * the path can not be used</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rebuild_device_uid</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">dasd_eckd_compare_path_uid</span><span class="p">(</span>
				    <span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path_private</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">uid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">path_private</span><span class="p">.</span><span class="n">uid</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">uid</span><span class="o">-&gt;</span><span class="n">vduit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">snprintf</span><span class="p">(</span><span class="n">print_uid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">print_uid</span><span class="p">),</span>
						 <span class="s">&quot;%s.%s.%04x.%02x.%s&quot;</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">uid</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">uid</span><span class="o">-&gt;</span><span class="n">real_unit_addr</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">vduit</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">snprintf</span><span class="p">(</span><span class="n">print_uid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">print_uid</span><span class="p">),</span>
						 <span class="s">&quot;%s.%s.%04x.%02x&quot;</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">uid</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
						 <span class="n">uid</span><span class="o">-&gt;</span><span class="n">real_unit_addr</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;The newly added channel path %02X &quot;</span>
					<span class="s">&quot;will not be used because it leads &quot;</span>
					<span class="s">&quot;to a different device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">lpm</span><span class="p">,</span> <span class="n">print_uid</span><span class="p">);</span>
				<span class="n">opm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">lpm</span><span class="p">;</span>
				<span class="n">npm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">lpm</span><span class="p">;</span>
				<span class="n">ppm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">lpm</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * There is a small chance that a path is lost again between</span>
<span class="cm">		 * above path verification and the following modification of</span>
<span class="cm">		 * the device opm mask. We could avoid that race here by using</span>
<span class="cm">		 * yet another path mask, but we rather deal with this unlikely</span>
<span class="cm">		 * situation in dasd_start_IO.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">opm</span> <span class="o">&amp;&amp;</span> <span class="n">opm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">opm</span> <span class="o">=</span> <span class="n">opm</span><span class="p">;</span>
			<span class="n">dasd_generic_path_operational</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">opm</span> <span class="o">|=</span> <span class="n">opm</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">npm</span> <span class="o">|=</span> <span class="n">npm</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">ppm</span> <span class="o">|=</span> <span class="n">ppm</span><span class="p">;</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">tbvpm</span> <span class="o">|=</span> <span class="n">epm</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">isglobal</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_path_verification_mutex</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_verify_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">lpm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">path_verification_work_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_path_verification_mutex</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">path_verification_worker</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">isglobal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">isglobal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">,</span> <span class="n">do_path_verification_work</span><span class="p">);</span>
	<span class="n">dasd_get_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">tbvpm</span> <span class="o">=</span> <span class="n">lpm</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_read_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_psf_prssd_data</span> <span class="o">*</span><span class="n">prssdp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_rssd_features</span> <span class="o">*</span><span class="n">features</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_features</span><span class="p">));</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* PSF */</span>	<span class="o">+</span> <span class="mi">1</span> <span class="cm">/* RSSD */</span><span class="p">,</span>
				   <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_psf_prssd_data</span><span class="p">)</span> <span class="o">+</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_features</span><span class="p">)),</span>
				   <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Could not &quot;</span>
				<span class="s">&quot;allocate initialization request&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="cm">/* Prepare for Read Subsystem Data */</span>
	<span class="n">prssdp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_psf_prssd_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">prssdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_psf_prssd_data</span><span class="p">));</span>
	<span class="n">prssdp</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">=</span> <span class="n">PSF_ORDER_PRSSD</span><span class="p">;</span>
	<span class="n">prssdp</span><span class="o">-&gt;</span><span class="n">suborder</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">;</span>	<span class="cm">/* Read Feature Codes */</span>
	<span class="cm">/* all other bytes of prssdp must be zero */</span>

	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_PSF</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_psf_prssd_data</span><span class="p">);</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">prssdp</span><span class="p">;</span>

	<span class="cm">/* Read Subsystem Data - feature codes */</span>
	<span class="n">features</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_features</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">prssdp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_features</span><span class="p">));</span>

	<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_RSSD</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_features</span><span class="p">);</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">features</span><span class="p">;</span>

	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_sleep_on</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prssdp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_psf_prssd_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">features</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_features</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">prssdp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_features</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reading device feature codes&quot;</span>
			 <span class="s">&quot; failed with rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Build CP for Perform Subsystem Function - SSC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="nf">dasd_eckd_build_psf_ssc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
						    <span class="kt">int</span> <span class="n">enable_pav</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_psf_ssc_data</span> <span class="o">*</span><span class="n">psf_ssc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>

	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* PSF */</span> <span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_psf_ssc_data</span><span class="p">),</span>
				  <span class="n">device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			   <span class="s">&quot;Could not allocate PSF-SSC request&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">psf_ssc_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_psf_ssc_data</span> <span class="o">*</span><span class="p">)</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">psf_ssc_data</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">=</span> <span class="n">PSF_ORDER_SSC</span><span class="p">;</span>
	<span class="n">psf_ssc_data</span><span class="o">-&gt;</span><span class="n">suborder</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_pav</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psf_ssc_data</span><span class="o">-&gt;</span><span class="n">suborder</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">psf_ssc_data</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_PSF</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span><span class="n">psf_ssc_data</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">66</span><span class="p">;</span>

	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform Subsystem Function.</span>
<span class="cm"> * It is necessary to trigger CIO for channel revalidation since this</span>
<span class="cm"> * call might change behaviour of DASD devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_psf_ssc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable_pav</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_eckd_build_psf_ssc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">enable_pav</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_sleep_on</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="cm">/* trigger CIO to reprobe devices */</span>
		<span class="n">css_schedule_reprobe</span><span class="p">();</span>
	<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Valide storage server of current device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_eckd_validate_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable_pav</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UA_BASE_PAV_ALIAS</span> <span class="o">||</span>
	    <span class="n">private</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UA_HYPER_PAV_ALIAS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dasd_nopav</span> <span class="o">||</span> <span class="n">MACHINE_IS_VM</span><span class="p">)</span>
		<span class="n">enable_pav</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">enable_pav</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eckd_psf_ssc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">enable_pav</span><span class="p">);</span>

	<span class="cm">/* may be requested feature is not available on server,</span>
<span class="cm">	 * therefore just report error and go ahead */</span>
	<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;PSF-SSC for SSID %04x &quot;</span>
			<span class="s">&quot;returned rc=%d&quot;</span><span class="p">,</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * worker to do a validate server in case of a lost pathgroup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_eckd_do_validate_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dasd_device</span><span class="p">,</span>
						  <span class="n">kick_validate</span><span class="p">);</span>
	<span class="n">dasd_eckd_validate_server</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_eckd_kick_validate_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dasd_get_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="cm">/* exit if device not online or in offline processing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DASD_FLAG_OFFLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	   <span class="n">device</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">DASD_STATE_ONLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dasd_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* queue call to do_validate_server to the kernel event daemon. */</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">kick_validate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_fcx_max_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_64BIT)</span>
	<span class="kt">int</span> <span class="n">tpm</span><span class="p">,</span> <span class="n">mdc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fcx_in_css</span><span class="p">,</span> <span class="n">fcx_in_gneq</span><span class="p">,</span> <span class="n">fcx_in_features</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dasd_nofcx</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* is transport mode supported? */</span>
	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">fcx_in_css</span> <span class="o">=</span> <span class="n">css_general_characteristics</span><span class="p">.</span><span class="n">fcx</span><span class="p">;</span>
	<span class="n">fcx_in_gneq</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">gneq</span><span class="o">-&gt;</span><span class="n">reserved2</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">fcx_in_features</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">feature</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">tpm</span> <span class="o">=</span> <span class="n">fcx_in_css</span> <span class="o">&amp;&amp;</span> <span class="n">fcx_in_gneq</span> <span class="o">&amp;&amp;</span> <span class="n">fcx_in_features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpm</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mdc</span> <span class="o">=</span> <span class="n">ccw_device_get_mdc</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Detecting the maximum supported&quot;</span>
			 <span class="s">&quot; data size for zHPF requests failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">mdc</span> <span class="o">*</span> <span class="n">FCX_MAX_DATA_FACTOR</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check device characteristics.</span>
<span class="cm"> * If the device is accessible using ECKD discipline, the device is enabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_check_characteristics</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_uid</span> <span class="n">temp_uid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">readonly</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* setup work queue for validate server*/</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">kick_validate</span><span class="p">,</span> <span class="n">dasd_eckd_do_validate_server</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccw_device_is_pathgroup</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;A channel path group could not be established</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccw_device_is_multipath</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The DASD is not operating in multipath mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">private</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">private</span><span class="p">),</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Allocating memory for private DASD data &quot;</span>
				 <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">private</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">private</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">private</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* Invalidate status of initial analysis. */</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">init_cqr_status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Set default cache operations. */</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">DASD_NORMAL_CACHE</span><span class="p">;</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">nr_cyl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Read Configuration Data */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eckd_read_conf</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err1</span><span class="p">;</span>

	<span class="cm">/* set default timeout */</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">default_expires</span> <span class="o">=</span> <span class="n">DASD_EXPIRES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">gneq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">gneq</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">value</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">gneq</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">number</span><span class="p">;</span>
		<span class="cm">/* do not accept useless values */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">DASD_EXPIRES_MAX</span><span class="p">)</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">default_expires</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dasd_eckd_get_uid</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_uid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp_uid</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UA_BASE_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">dasd_alloc_block</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">block</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
					<span class="s">&quot;could not allocate dasd &quot;</span>
					<span class="s">&quot;block structure&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_err1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
		<span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* register lcu with alias handling, enable PAV */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_alias_make_device_known_to_lcu</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err2</span><span class="p">;</span>

	<span class="n">dasd_eckd_validate_server</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="cm">/* device may report different configuration data after LCU setup */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eckd_read_conf</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err3</span><span class="p">;</span>

	<span class="cm">/* Read Feature Codes */</span>
	<span class="n">dasd_eckd_read_features</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="cm">/* Read Device Characteristics */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_generic_read_dev_chars</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span>
				<span class="s">&quot;Read device characteristic failed, rc=%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_USERAW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">facilities</span><span class="p">.</span><span class="n">RT_in_LR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The storage server does not &quot;</span>
			<span class="s">&quot;support raw-track access</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* find the valid cylinder size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">no_cyl</span> <span class="o">==</span> <span class="n">LV_COMPAT_CYL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">long_no_cyl</span><span class="p">)</span>
		<span class="n">private</span><span class="o">-&gt;</span><span class="n">real_cyl</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">long_no_cyl</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">private</span><span class="o">-&gt;</span><span class="n">real_cyl</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">no_cyl</span><span class="p">;</span>

	<span class="n">private</span><span class="o">-&gt;</span><span class="n">fcx_max_data</span> <span class="o">=</span> <span class="n">get_fcx_max_data</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="n">readonly</span> <span class="o">=</span> <span class="n">dasd_device_is_ro</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readonly</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_FLAG_DEVICE_RO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;New DASD %04X/%02X (CU %04X/%02X) &quot;</span>
		 <span class="s">&quot;with %d cylinders, %d heads, %d sectors%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">dev_type</span><span class="p">,</span>
		 <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">dev_model</span><span class="p">,</span>
		 <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">cu_type</span><span class="p">,</span>
		 <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">cu_model</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
		 <span class="n">private</span><span class="o">-&gt;</span><span class="n">real_cyl</span><span class="p">,</span>
		 <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span><span class="p">,</span>
		 <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">sec_per_trk</span><span class="p">,</span>
		 <span class="n">readonly</span> <span class="o">?</span> <span class="s">&quot;, read-only device&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err3:</span>
	<span class="n">dasd_alias_disconnect_device_from_lcu</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="nl">out_err2:</span>
	<span class="n">dasd_free_block</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out_err1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_eckd_uncheck_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">dasd_alias_disconnect_device_from_lcu</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">ned</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">sneq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">vdsneq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">gneq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_data</span><span class="p">);</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_eckd_analysis_ccw</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eckd_count</span> <span class="o">*</span><span class="n">count_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">LO_eckd_data</span> <span class="o">*</span><span class="n">LO_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">cplength</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">datasize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span><span class="p">);</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="cm">/* Define extent for the first 3 tracks. */</span>
	<span class="n">define_extent</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		      <span class="n">DASD_ECKD_CCW_READ_COUNT</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="n">LO_data</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">);</span>
	<span class="cm">/* Locate record for the first 4 records on track 0. */</span>
	<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
	<span class="n">locate_record</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="n">LO_data</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		      <span class="n">DASD_ECKD_CCW_READ_COUNT</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">count_data</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">count_area</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_READ_COUNT</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">count_data</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count_data</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Locate record for the first record on track 2. */</span>
	<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
	<span class="n">locate_record</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="n">LO_data</span><span class="o">++</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		      <span class="n">DASD_ECKD_CCW_READ_COUNT</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Read count ccw. */</span>
	<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_READ_COUNT</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">count_data</span><span class="p">;</span>

	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* differentiate between &#39;no record found&#39; and any other error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_analysis_evaluation</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">init_cqr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DASD_CQR_DONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">INIT_CQR_OK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">init_cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DASD_CQR_NEED_ERP</span> <span class="o">||</span>
		 <span class="n">init_cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DASD_CQR_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sense</span> <span class="o">=</span> <span class="n">dasd_get_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_cqr</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNS1_NO_REC_FOUND</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">INIT_CQR_UNFORMATTED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">INIT_CQR_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">INIT_CQR_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the callback function for the init_analysis cqr. It saves</span>
<span class="cm"> * the status of the initial analysis ccw before it frees it and kicks</span>
<span class="cm"> * the device to continue the startup sequence. This will call</span>
<span class="cm"> * dasd_eckd_do_analysis again (if the devices has not been marked</span>
<span class="cm"> * for deletion in the meantime).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_eckd_analysis_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">init_cqr</span><span class="p">,</span>
					<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">init_cqr</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">init_cqr_status</span> <span class="o">=</span> <span class="n">dasd_eckd_analysis_evaluation</span><span class="p">(</span><span class="n">init_cqr</span><span class="p">);</span>
	<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">init_cqr</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="n">dasd_kick_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_start_analysis</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">init_cqr</span><span class="p">;</span>

	<span class="n">init_cqr</span> <span class="o">=</span> <span class="n">dasd_eckd_analysis_ccw</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">init_cqr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">init_cqr</span><span class="p">);</span>
	<span class="n">init_cqr</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dasd_eckd_analysis_callback</span><span class="p">;</span>
	<span class="n">init_cqr</span><span class="o">-&gt;</span><span class="n">callback_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">init_cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="cm">/* first try without ERP, so we can later handle unformatted</span>
<span class="cm">	 * devices as special case</span>
<span class="cm">	 */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_USE_ERP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">init_cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dasd_add_request_head</span><span class="p">(</span><span class="n">init_cqr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_end_analysis</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eckd_count</span> <span class="o">*</span><span class="n">count_area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sb</span><span class="p">,</span> <span class="n">blk_per_trk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">init_cqr</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">init_cqr_status</span><span class="p">;</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">init_cqr_status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">INIT_CQR_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* try again, this time with full ERP */</span>
		<span class="n">init_cqr</span> <span class="o">=</span> <span class="n">dasd_eckd_analysis_ccw</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="n">dasd_sleep_on</span><span class="p">(</span><span class="n">init_cqr</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dasd_eckd_analysis_evaluation</span><span class="p">(</span><span class="n">init_cqr</span><span class="p">);</span>
		<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">init_cqr</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_USERAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span> <span class="o">=</span> <span class="n">DASD_RAW_BLOCKSIZE</span><span class="p">;</span>
		<span class="n">blk_per_trk</span> <span class="o">=</span> <span class="n">DASD_RAW_BLOCK_PER_TRACK</span><span class="p">;</span>
		<span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">raw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">INIT_CQR_UNFORMATTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The DASD is not formatted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMEDIUMTYPE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">INIT_CQR_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Detecting the DASD disk layout failed because &quot;</span>
			<span class="s">&quot;of an I/O error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Check Track 0 for Compatible Disk Layout */</span>
	<span class="n">count_area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">count_area</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kl</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">||</span>
		    <span class="n">private</span><span class="o">-&gt;</span><span class="n">count_area</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dl</span> <span class="o">!=</span> <span class="n">dasd_eckd_cdl_reclen</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">count_area</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">count_area</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">count_area</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kl</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">count_area</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dl</span> <span class="o">!=</span>
			     <span class="n">private</span><span class="o">-&gt;</span><span class="n">count_area</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dl</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">count_area</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">count_area</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">count_area</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">record</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Track 0 has no records following the VTOC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count_area</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">count_area</span><span class="o">-&gt;</span><span class="n">kl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we found notthing violating our disk layout */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dasd_check_blocksize</span><span class="p">(</span><span class="n">count_area</span><span class="o">-&gt;</span><span class="n">dl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span> <span class="o">=</span> <span class="n">count_area</span><span class="o">-&gt;</span><span class="n">dl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The disk layout of the DASD is not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMEDIUMTYPE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* bits to shift 512 to get a block */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">sb</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="n">sb</span> <span class="o">&lt;</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">;</span> <span class="n">sb</span> <span class="o">=</span> <span class="n">sb</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span><span class="o">++</span><span class="p">;</span>

	<span class="n">blk_per_trk</span> <span class="o">=</span> <span class="n">recs_per_track</span><span class="p">(</span><span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">);</span>

<span class="nl">raw:</span>
	<span class="n">block</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">real_cyl</span> <span class="o">*</span>
			  <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span> <span class="o">*</span>
			  <span class="n">blk_per_trk</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;DASD with %d KB/block, %d KB total size, %d KB/track, &quot;</span>
		 <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">),</span>
		 <span class="p">((</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">real_cyl</span> <span class="o">*</span>
		   <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span> <span class="o">*</span>
		   <span class="n">blk_per_trk</span> <span class="o">*</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span>
		 <span class="p">((</span><span class="n">blk_per_trk</span> <span class="o">*</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">),</span>
		 <span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">?</span>
		 <span class="s">&quot;compatible disk layout&quot;</span> <span class="o">:</span> <span class="s">&quot;linux disk layout&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_do_analysis</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">init_cqr_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dasd_eckd_start_analysis</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">dasd_eckd_end_analysis</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_ready_to_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dasd_alias_add_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_online_to_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">reload_device</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">kick_validate</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dasd_alias_remove_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_fill_geometry</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dasd_check_blocksize</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">recs_per_track</span><span class="p">(</span><span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">,</span>
					      <span class="mi">0</span><span class="p">,</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">no_cyl</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span>
<span class="nf">dasd_eckd_format_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span> <span class="n">device</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">format_data_t</span> <span class="o">*</span> <span class="n">fdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">fcp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eckd_count</span> <span class="o">*</span><span class="n">ect</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rpt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ch_t</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intensity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r0_perm</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">rpt</span> <span class="o">=</span> <span class="n">recs_per_track</span><span class="p">(</span><span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">);</span>
	<span class="n">set_ch_t</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span>
		 <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span> <span class="o">/</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span><span class="p">,</span>
		 <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span> <span class="o">%</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span><span class="p">);</span>

	<span class="cm">/* Sanity checks. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span> <span class="o">&gt;=</span>
	    <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">real_cyl</span> <span class="o">*</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Start track number %d used in &quot;</span>
			 <span class="s">&quot;formatting is too big</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span> <span class="o">&gt;</span> <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">stop_unit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Start track %d used in &quot;</span>
			 <span class="s">&quot;formatting exceeds end track</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dasd_check_blocksize</span><span class="p">(</span><span class="n">fdata</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The DASD cannot be formatted with block size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * fdata-&gt;intensity is a bit string that tells us what to do:</span>
<span class="cm">	 *   Bit 0: write record zero</span>
<span class="cm">	 *   Bit 1: write home address, currently not supported</span>
<span class="cm">	 *   Bit 2: invalidate tracks</span>
<span class="cm">	 *   Bit 3: use OS/390 compatible disk layout (cdl)</span>
<span class="cm">	 *   Bit 4: do not allow storage subsystem to modify record zero</span>
<span class="cm">	 * Only some bit combinations do make sense.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdata</span><span class="o">-&gt;</span><span class="n">intensity</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r0_perm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">intensity</span> <span class="o">=</span> <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">intensity</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r0_perm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">intensity</span> <span class="o">=</span> <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">intensity</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">intensity</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:	<span class="cm">/* Normal format */</span>
	<span class="k">case</span> <span class="mh">0x08</span>:	<span class="cm">/* Normal format, use cdl. */</span>
		<span class="n">cplength</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">rpt</span><span class="p">;</span>
		<span class="n">datasize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">rpt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eckd_count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x01</span>:	<span class="cm">/* Write record zero and format track. */</span>
	<span class="k">case</span> <span class="mh">0x09</span>:	<span class="cm">/* Write record zero and format track, use cdl. */</span>
		<span class="n">cplength</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">rpt</span><span class="p">;</span>
		<span class="n">datasize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eckd_count</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">rpt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eckd_count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>:	<span class="cm">/* Invalidate track. */</span>
	<span class="k">case</span> <span class="mh">0x0c</span>:	<span class="cm">/* Invalidate track, use cdl. */</span>
		<span class="n">cplength</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">datasize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eckd_count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;An I/O control call used &quot;</span>
			 <span class="s">&quot;incorrect flags 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">intensity</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Allocate the format ccw request. */</span>
	<span class="n">fcp</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fcp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">fcp</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">fcp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">fcp</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">intensity</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>: <span class="cm">/* Normal format. */</span>
		<span class="n">define_extent</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span>
			      <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span><span class="p">,</span> <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span><span class="p">,</span>
			      <span class="n">DASD_ECKD_CCW_WRITE_CKD</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="cm">/* grant subsystem permission to format R0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r0_perm</span><span class="p">)</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">DE_eckd_data</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ga_extended</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">);</span>
		<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">locate_record</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span>
			      <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rpt</span><span class="p">,</span>
			      <span class="n">DASD_ECKD_CCW_WRITE_CKD</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
			      <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x01</span>: <span class="cm">/* Write record zero + format track. */</span>
		<span class="n">define_extent</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span>
			      <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span><span class="p">,</span> <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span><span class="p">,</span>
			      <span class="n">DASD_ECKD_CCW_WRITE_RECORD_ZERO</span><span class="p">,</span>
			      <span class="n">device</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">);</span>
		<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">locate_record</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span>
			      <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rpt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="n">DASD_ECKD_CCW_WRITE_RECORD_ZERO</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
			      <span class="n">device</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>: <span class="cm">/* Invalidate track. */</span>
		<span class="n">define_extent</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span>
			      <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span><span class="p">,</span> <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span><span class="p">,</span>
			      <span class="n">DASD_ECKD_CCW_WRITE_CKD</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">);</span>
		<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">locate_record</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span>
			      <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="n">DASD_ECKD_CCW_WRITE_CKD</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intensity</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* write record zero */</span>
		<span class="n">ect</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">eckd_count</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eckd_count</span><span class="p">);</span>
		<span class="n">ect</span><span class="o">-&gt;</span><span class="n">cyl</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">cyl</span><span class="p">;</span>
		<span class="n">ect</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
		<span class="n">ect</span><span class="o">-&gt;</span><span class="n">record</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ect</span><span class="o">-&gt;</span><span class="n">kl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ect</span><span class="o">-&gt;</span><span class="n">dl</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_WRITE_RECORD_ZERO</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">ect</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">intensity</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* erase track */</span>
		<span class="n">ect</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">eckd_count</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eckd_count</span><span class="p">);</span>
		<span class="n">ect</span><span class="o">-&gt;</span><span class="n">cyl</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">cyl</span><span class="p">;</span>
		<span class="n">ect</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
		<span class="n">ect</span><span class="o">-&gt;</span><span class="n">record</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ect</span><span class="o">-&gt;</span><span class="n">kl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ect</span><span class="o">-&gt;</span><span class="n">dl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_WRITE_CKD</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">ect</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* write remaining records */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rpt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ect</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">eckd_count</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eckd_count</span><span class="p">);</span>
			<span class="n">ect</span><span class="o">-&gt;</span><span class="n">cyl</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">cyl</span><span class="p">;</span>
			<span class="n">ect</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
			<span class="n">ect</span><span class="o">-&gt;</span><span class="n">record</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ect</span><span class="o">-&gt;</span><span class="n">kl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ect</span><span class="o">-&gt;</span><span class="n">dl</span> <span class="o">=</span> <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">;</span>
			<span class="cm">/* Check for special tracks 0-1 when formatting CDL */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">intensity</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ect</span><span class="o">-&gt;</span><span class="n">kl</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">ect</span><span class="o">-&gt;</span><span class="n">dl</span> <span class="o">=</span> <span class="n">sizes_trk0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">intensity</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">fdata</span><span class="o">-&gt;</span><span class="n">start_unit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ect</span><span class="o">-&gt;</span><span class="n">kl</span> <span class="o">=</span> <span class="mi">44</span><span class="p">;</span>
				<span class="n">ect</span><span class="o">-&gt;</span><span class="n">dl</span> <span class="o">=</span> <span class="n">LABEL_SIZE</span> <span class="o">-</span> <span class="mi">44</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_WRITE_CKD</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">ect</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">fcp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fcp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_eckd_handle_terminated_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">!=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dasd_eckd_reset_ccw_to_base_io</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">opm</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">dasd_erp_fn_t</span>
<span class="nf">dasd_eckd_erp_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">cqr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">cu_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x3990</span>:
	<span class="k">case</span> <span class="mh">0x2105</span>:
	<span class="k">case</span> <span class="mh">0x2107</span>:
	<span class="k">case</span> <span class="mh">0x1750</span>:
		<span class="k">return</span> <span class="n">dasd_3990_erp_action</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x9343</span>:
	<span class="k">case</span> <span class="mh">0x3880</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">dasd_default_erp_action</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dasd_erp_fn_t</span>
<span class="nf">dasd_eckd_erp_postaction</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">cqr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dasd_default_erp_postaction</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_eckd_check_for_device_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sense</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="cm">/* first of all check for state change pending interrupt */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">DEV_STAT_ATTENTION</span> <span class="o">|</span> <span class="n">DEV_STAT_DEV_END</span> <span class="o">|</span> <span class="n">DEV_STAT_UNIT_EXCEP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scsw_dstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * for alias only, not in offline processing</span>
<span class="cm">		 * and only if not suspended</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">&amp;&amp;</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">lcu</span> <span class="o">&amp;&amp;</span>
		    <span class="n">device</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DASD_STATE_ONLINE</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DASD_FLAG_OFFLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DASD_FLAG_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * the state change could be caused by an alias</span>
<span class="cm">			 * reassignment remove device from alias handling</span>
<span class="cm">			 * to prevent new requests from being scheduled on</span>
<span class="cm">			 * the wrong alias device</span>
<span class="cm">			 */</span>
			<span class="n">dasd_alias_remove_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

			<span class="cm">/* schedule worker to reload device */</span>
			<span class="n">dasd_reload_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dasd_generic_handle_state_change</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="n">dasd_get_sense</span><span class="p">(</span><span class="n">irb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sense</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* summary unit check */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SENSE_BIT_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0D</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">scsw_dstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dasd_alias_handle_summary_unit_check</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* service information message SIM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cqr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SENSE_BIT_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SIM_SENSE</span><span class="p">)</span> <span class="o">==</span> <span class="n">DASD_SIM_SENSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dasd_3990_erp_handle_sim</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">sense</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* loss of device reservation is handled via base devices only</span>
<span class="cm">	 * as alias devices may be used with several bases</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SENSE_BIT_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">scsw_dstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DASD_FLAG_IS_RESERVED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_FAILONSLCK</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_FLAG_LOCK_STOLEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">DASD_FLAG_IS_RESERVED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The device reservation was lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="nf">dasd_eckd_build_cp_cmd_single</span><span class="p">(</span>
					       <span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">startdev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					       <span class="n">sector_t</span> <span class="n">first_rec</span><span class="p">,</span>
					       <span class="n">sector_t</span> <span class="n">last_rec</span><span class="p">,</span>
					       <span class="n">sector_t</span> <span class="n">first_trk</span><span class="p">,</span>
					       <span class="n">sector_t</span> <span class="n">last_trk</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first_offs</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_offs</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blk_per_trk</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">idaws</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">LO_eckd_data</span> <span class="o">*</span><span class="n">LO_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_iterator</span> <span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">cidaw</span><span class="p">,</span> <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">recid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">rcmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">use_prefix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">basedev</span><span class="p">;</span>

	<span class="n">basedev</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">basedev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_READ_MT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_WRITE_MT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="cm">/* Check struct bio and count the number of blocks for the request. */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cidaw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">blksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="cm">/* Eckd can only do full blocks. */</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_64BIT)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idal_is_needed</span> <span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">),</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">))</span>
			<span class="n">cidaw</span> <span class="o">+=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="cm">/* Paranoia. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">last_rec</span> <span class="o">-</span> <span class="n">first_rec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="cm">/* use the prefix command if available */</span>
	<span class="n">use_prefix</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">feature</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_prefix</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 1x prefix + number of blocks */</span>
		<span class="n">cplength</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
		<span class="cm">/* 1x prefix + cidaws*sizeof(long) */</span>
		<span class="n">datasize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PFX_eckd_data</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">cidaw</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* 1x define extent + 1x locate record + number of blocks */</span>
		<span class="n">cplength</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
		<span class="cm">/* 1x define extent + 1x locate record + cidaws*sizeof(long) */</span>
		<span class="n">datasize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">cidaw</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Find out the number of additional locate record ccws for cdl. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">&amp;&amp;</span> <span class="n">first_rec</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">blk_per_trk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_rec</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">blk_per_trk</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">blk_per_trk</span> <span class="o">-</span> <span class="n">first_rec</span><span class="p">;</span>
		<span class="n">cplength</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">datasize</span> <span class="o">+=</span> <span class="n">count</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Allocate the ccw request. */</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">,</span>
				   <span class="n">startdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="cm">/* First ccw is define extent or prefix. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_prefix</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">first_trk</span><span class="p">,</span>
			   <span class="n">last_trk</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">basedev</span><span class="p">,</span> <span class="n">startdev</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Clock not in sync and XRC is enabled.</span>
<span class="cm">			 * Try again later.</span>
<span class="cm">			 */</span>
			<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">startdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">idaws</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PFX_eckd_data</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">define_extent</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">first_trk</span><span class="p">,</span>
				  <span class="n">last_trk</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">basedev</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Clock not in sync and XRC is enabled.</span>
<span class="cm">			 * Try again later.</span>
<span class="cm">			 */</span>
			<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">startdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">idaws</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_eckd_data</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* Build locate_record+read/write/ccws. */</span>
	<span class="n">LO_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">LO_eckd_data</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">idaws</span> <span class="o">+</span> <span class="n">cidaw</span><span class="p">);</span>
	<span class="n">recid</span> <span class="o">=</span> <span class="n">first_rec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">recid</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">blk_per_trk</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Only standard blocks so there is just one locate record. */</span>
		<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">locate_record</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="n">LO_data</span><span class="o">++</span><span class="p">,</span> <span class="n">first_trk</span><span class="p">,</span> <span class="n">first_offs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="n">last_rec</span> <span class="o">-</span> <span class="n">recid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">basedev</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dasd_page_cache</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">copy</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">dasd_page_cache</span><span class="p">,</span>
						      <span class="n">GFP_DMA</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&amp;&amp;</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">copy</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy</span><span class="p">)</span>
				<span class="n">dst</span> <span class="o">=</span> <span class="n">copy</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span> <span class="n">off</span> <span class="o">+=</span> <span class="n">blksize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sector_t</span> <span class="n">trkid</span> <span class="o">=</span> <span class="n">recid</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recoffs</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">trkid</span><span class="p">,</span> <span class="n">blk_per_trk</span><span class="p">);</span>
			<span class="n">rcmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">blksize</span><span class="p">;</span>
			<span class="cm">/* Locate record for cdl special block ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">&amp;&amp;</span> <span class="n">recid</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">blk_per_trk</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dasd_eckd_cdl_special</span><span class="p">(</span><span class="n">blk_per_trk</span><span class="p">,</span> <span class="n">recid</span><span class="p">)){</span>
					<span class="n">rcmd</span> <span class="o">|=</span> <span class="mh">0x8</span><span class="p">;</span>
					<span class="n">count</span> <span class="o">=</span> <span class="n">dasd_eckd_cdl_reclen</span><span class="p">(</span><span class="n">recid</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">blksize</span> <span class="o">&amp;&amp;</span>
					    <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
						<span class="n">memset</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
						       <span class="n">blksize</span> <span class="o">-</span> <span class="n">count</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
				<span class="n">locate_record</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="n">LO_data</span><span class="o">++</span><span class="p">,</span>
					      <span class="n">trkid</span><span class="p">,</span> <span class="n">recoffs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					      <span class="mi">1</span><span class="p">,</span> <span class="n">rcmd</span><span class="p">,</span> <span class="n">basedev</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Locate record for standard blocks ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">&amp;&amp;</span> <span class="n">recid</span> <span class="o">==</span> <span class="mi">2</span><span class="o">*</span><span class="n">blk_per_trk</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
				<span class="n">locate_record</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="n">LO_data</span><span class="o">++</span><span class="p">,</span>
					      <span class="n">trkid</span><span class="p">,</span> <span class="n">recoffs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					      <span class="n">last_rec</span> <span class="o">-</span> <span class="n">recid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					      <span class="n">cmd</span><span class="p">,</span> <span class="n">basedev</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Read/write ccw. */</span>
			<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">rcmd</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idal_is_needed</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">blksize</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">idaws</span><span class="p">;</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_IDA</span><span class="p">;</span>
				<span class="n">idaws</span> <span class="o">=</span> <span class="n">idal_create_words</span><span class="p">(</span><span class="n">idaws</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dst</span> <span class="o">+=</span> <span class="n">blksize</span><span class="p">;</span>
			<span class="n">recid</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk_noretry_request</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_FAILFAST</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_FAILFAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">startdev</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">startdev</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">startdev</span><span class="o">-&gt;</span><span class="n">default_expires</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>	<span class="cm">/* default 5 minutes */</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">startdev</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">ppm</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="nf">dasd_eckd_build_cp_cmd_track</span><span class="p">(</span>
					       <span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">startdev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					       <span class="n">sector_t</span> <span class="n">first_rec</span><span class="p">,</span>
					       <span class="n">sector_t</span> <span class="n">last_rec</span><span class="p">,</span>
					       <span class="n">sector_t</span> <span class="n">first_trk</span><span class="p">,</span>
					       <span class="n">sector_t</span> <span class="n">last_trk</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first_offs</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_offs</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blk_per_trk</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">idaws</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_iterator</span> <span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">idaw_dst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cidaw</span><span class="p">,</span> <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tlf</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">recid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">basedev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trkcount</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">count_to_trk_end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idaw_len</span><span class="p">,</span> <span class="n">seg_len</span><span class="p">,</span> <span class="n">part_len</span><span class="p">,</span> <span class="n">len_to_track_end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">new_track</span><span class="p">,</span> <span class="n">end_idaw</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">trkid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recoffs</span><span class="p">;</span>

	<span class="n">basedev</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_READ_TRACK_DATA</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_WRITE_TRACK_DATA</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="cm">/* Track based I/O needs IDAWs for each page, and not just for</span>
<span class="cm">	 * 64 bit addresses. We need additional idals for pages</span>
<span class="cm">	 * that get filled from two tracks, so we use the number</span>
<span class="cm">	 * of records as upper limit.</span>
<span class="cm">	 */</span>
	<span class="n">cidaw</span> <span class="o">=</span> <span class="n">last_rec</span> <span class="o">-</span> <span class="n">first_rec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">trkcount</span> <span class="o">=</span> <span class="n">last_trk</span> <span class="o">-</span> <span class="n">first_trk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* 1x prefix + one read/write ccw per track */</span>
	<span class="n">cplength</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">trkcount</span><span class="p">;</span>

	<span class="cm">/* on 31-bit we need space for two 32 bit addresses per page</span>
<span class="cm">	 * on 64-bit one 64 bit address</span>
<span class="cm">	 */</span>
	<span class="n">datasize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PFX_eckd_data</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">cidaw</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">);</span>

	<span class="cm">/* Allocate the ccw request. */</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">,</span>
				   <span class="n">startdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="cm">/* transfer length factor: how many bytes to read from the last track */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first_trk</span> <span class="o">==</span> <span class="n">last_trk</span><span class="p">)</span>
		<span class="n">tlf</span> <span class="o">=</span> <span class="n">last_offs</span> <span class="o">-</span> <span class="n">first_offs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tlf</span> <span class="o">=</span> <span class="n">last_offs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tlf</span> <span class="o">*=</span> <span class="n">blksize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prefix_LRE</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">first_trk</span><span class="p">,</span>
		       <span class="n">last_trk</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">basedev</span><span class="p">,</span> <span class="n">startdev</span><span class="p">,</span>
		       <span class="mi">1</span> <span class="cm">/* format */</span><span class="p">,</span> <span class="n">first_offs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">trkcount</span><span class="p">,</span> <span class="n">blksize</span><span class="p">,</span>
		       <span class="n">tlf</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clock not in sync and XRC is enabled.</span>
<span class="cm">		 * Try again later.</span>
<span class="cm">		 */</span>
		<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">startdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The translation of request into ccw programs must meet the</span>
<span class="cm">	 * following conditions:</span>
<span class="cm">	 * - all idaws but the first and the last must address full pages</span>
<span class="cm">	 *   (or 2K blocks on 31-bit)</span>
<span class="cm">	 * - the scope of a ccw and it&#39;s idal ends with the track boundaries</span>
<span class="cm">	 */</span>
	<span class="n">idaws</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PFX_eckd_data</span><span class="p">));</span>
	<span class="n">recid</span> <span class="o">=</span> <span class="n">first_rec</span><span class="p">;</span>
	<span class="n">new_track</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">end_idaw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len_to_track_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">idaw_dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">idaw_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
		<span class="n">seg_len</span> <span class="o">=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">seg_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_track</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">trkid</span> <span class="o">=</span> <span class="n">recid</span><span class="p">;</span>
				<span class="n">recoffs</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">trkid</span><span class="p">,</span> <span class="n">blk_per_trk</span><span class="p">);</span>
				<span class="n">count_to_trk_end</span> <span class="o">=</span> <span class="n">blk_per_trk</span> <span class="o">-</span> <span class="n">recoffs</span><span class="p">;</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="n">last_rec</span> <span class="o">-</span> <span class="n">recid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
					    <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="n">count_to_trk_end</span><span class="p">);</span>
				<span class="n">len_to_track_end</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">blksize</span><span class="p">;</span>
				<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">len_to_track_end</span><span class="p">;</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span><span class="n">idaws</span><span class="p">;</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_IDA</span><span class="p">;</span>
				<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
				<span class="n">recid</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
				<span class="n">new_track</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* first idaw for a ccw may start anywhere */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idaw_dst</span><span class="p">)</span>
					<span class="n">idaw_dst</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* If we start a new idaw, we must make sure that it</span>
<span class="cm">			 * starts on an IDA_BLOCK_SIZE boundary.</span>
<span class="cm">			 * If we continue an idaw, we must make sure that the</span>
<span class="cm">			 * current segment begins where the so far accumulated</span>
<span class="cm">			 * idaw ends</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idaw_dst</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IDA_BLOCK_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">startdev</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ERANGE</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">idaw_dst</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">idaw_dst</span> <span class="o">+</span> <span class="n">idaw_len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dst</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">startdev</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ERANGE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">part_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">seg_len</span><span class="p">,</span> <span class="n">len_to_track_end</span><span class="p">);</span>
			<span class="n">seg_len</span> <span class="o">-=</span> <span class="n">part_len</span><span class="p">;</span>
			<span class="n">dst</span> <span class="o">+=</span> <span class="n">part_len</span><span class="p">;</span>
			<span class="n">idaw_len</span> <span class="o">+=</span> <span class="n">part_len</span><span class="p">;</span>
			<span class="n">len_to_track_end</span> <span class="o">-=</span> <span class="n">part_len</span><span class="p">;</span>
			<span class="cm">/* collected memory area ends on an IDA_BLOCK border,</span>
<span class="cm">			 * -&gt; create an idaw</span>
<span class="cm">			 * idal_create_words will handle cases where idaw_len</span>
<span class="cm">			 * is larger then IDA_BLOCK_SIZE</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">idaw_dst</span> <span class="o">+</span> <span class="n">idaw_len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IDA_BLOCK_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
				<span class="n">end_idaw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* We also need to end the idaw at track end */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len_to_track_end</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">new_track</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">end_idaw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">end_idaw</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">idaws</span> <span class="o">=</span> <span class="n">idal_create_words</span><span class="p">(</span><span class="n">idaws</span><span class="p">,</span> <span class="n">idaw_dst</span><span class="p">,</span>
							  <span class="n">idaw_len</span><span class="p">);</span>
				<span class="n">idaw_dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">idaw_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">end_idaw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blk_noretry_request</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_FAILFAST</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_FAILFAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">startdev</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">startdev</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">startdev</span><span class="o">-&gt;</span><span class="n">default_expires</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>	<span class="cm">/* default 5 minutes */</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">startdev</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">ppm</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prepare_itcw</span><span class="p">(</span><span class="k">struct</span> <span class="n">itcw</span> <span class="o">*</span><span class="n">itcw</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">totrk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">basedev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">startdev</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rec_on_trk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total_data_size</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tlf</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blk_per_trk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PFX_eckd_data</span> <span class="n">pfxdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">basepriv</span><span class="p">,</span> <span class="o">*</span><span class="n">startpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DE_eckd_data</span> <span class="o">*</span><span class="n">dedata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">LRE_eckd_data</span> <span class="o">*</span><span class="n">lredata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcw</span> <span class="o">*</span><span class="n">dcw</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">begcyl</span><span class="p">,</span> <span class="n">endcyl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">heads</span><span class="p">,</span> <span class="n">beghead</span><span class="p">,</span> <span class="n">endhead</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pfx_cmd</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dn</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>


	<span class="cm">/* setup prefix data */</span>
	<span class="n">basepriv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">basedev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">startpriv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">startdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">dedata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pfxdata</span><span class="p">.</span><span class="n">define_extent</span><span class="p">;</span>
	<span class="n">lredata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pfxdata</span><span class="p">.</span><span class="n">locate_record</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfxdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pfxdata</span><span class="p">));</span>
	<span class="n">pfxdata</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* PFX with LRE */</span>
	<span class="n">pfxdata</span><span class="p">.</span><span class="n">base_address</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">ned</span><span class="o">-&gt;</span><span class="n">unit_addr</span><span class="p">;</span>
	<span class="n">pfxdata</span><span class="p">.</span><span class="n">base_lss</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">ned</span><span class="o">-&gt;</span><span class="n">ID</span><span class="p">;</span>
	<span class="n">pfxdata</span><span class="p">.</span><span class="n">validity</span><span class="p">.</span><span class="n">define_extent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* private uid is kept up to date, conf_data may be outdated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">startpriv</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">UA_BASE_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pfxdata</span><span class="p">.</span><span class="n">validity</span><span class="p">.</span><span class="n">verify_base</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">startpriv</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UA_HYPER_PAV_ALIAS</span><span class="p">)</span>
			<span class="n">pfxdata</span><span class="p">.</span><span class="n">validity</span><span class="p">.</span><span class="n">hyper_pav</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_READ_TRACK_DATA</span>:
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">operation</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">blk_size</span> <span class="o">=</span> <span class="n">blksize</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">ga_extended</span> <span class="o">|=</span> <span class="mh">0x42</span><span class="p">;</span>
		<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x0C</span><span class="p">;</span>
		<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">check_bytes</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">pfx_cmd</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_PFX_READ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DASD_ECKD_CCW_WRITE_TRACK_DATA</span>:
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">operation</span><span class="p">;</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">blk_size</span> <span class="o">=</span> <span class="n">blksize</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">check_XRC_on_prefix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfxdata</span><span class="p">,</span> <span class="n">basedev</span><span class="p">);</span>
		<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">ga_extended</span> <span class="o">|=</span> <span class="mh">0x42</span><span class="p">;</span>
		<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="mh">0x3F</span><span class="p">;</span>
		<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">extended_operation</span> <span class="o">=</span> <span class="mh">0x23</span><span class="p">;</span>
		<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">check_bytes</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="n">pfx_cmd</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_PFX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_ERR</span><span class="p">,</span> <span class="n">basedev</span><span class="p">,</span>
			      <span class="s">&quot;prepare itcw, unknown opcode 0x%x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>	<span class="cm">/* ECKD */</span>

	<span class="n">heads</span> <span class="o">=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">trk_per_cyl</span><span class="p">;</span>
	<span class="n">begcyl</span> <span class="o">=</span> <span class="n">trk</span> <span class="o">/</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">beghead</span> <span class="o">=</span> <span class="n">trk</span> <span class="o">%</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">endcyl</span> <span class="o">=</span> <span class="n">totrk</span> <span class="o">/</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">endhead</span> <span class="o">=</span> <span class="n">totrk</span> <span class="o">%</span> <span class="n">heads</span><span class="p">;</span>

	<span class="cm">/* check for sequential prestage - enhance cylinder range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">==</span> <span class="n">DASD_SEQ_PRESTAGE</span> <span class="o">||</span>
	    <span class="n">dedata</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">.</span><span class="n">operation</span> <span class="o">==</span> <span class="n">DASD_SEQ_ACCESS</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">endcyl</span> <span class="o">+</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">nr_cyl</span> <span class="o">&lt;</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">real_cyl</span><span class="p">)</span>
			<span class="n">endcyl</span> <span class="o">+=</span> <span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">nr_cyl</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">endcyl</span> <span class="o">=</span> <span class="p">(</span><span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">real_cyl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_ch_t</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dedata</span><span class="o">-&gt;</span><span class="n">beg_ext</span><span class="p">,</span> <span class="n">begcyl</span><span class="p">,</span> <span class="n">beghead</span><span class="p">);</span>
	<span class="n">set_ch_t</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dedata</span><span class="o">-&gt;</span><span class="n">end_ext</span><span class="p">,</span> <span class="n">endcyl</span><span class="p">,</span> <span class="n">endhead</span><span class="p">);</span>

	<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">ep_format</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* records per track is valid */</span>
	<span class="n">dedata</span><span class="o">-&gt;</span><span class="n">ep_rec_per_track</span> <span class="o">=</span> <span class="n">blk_per_trk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rec_on_trk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">basepriv</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">dev_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x3390</span>:
			<span class="n">dn</span> <span class="o">=</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">blksize</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">232</span><span class="p">);</span>
			<span class="n">d</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">blksize</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="n">dn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">34</span><span class="p">);</span>
			<span class="n">sector</span> <span class="o">=</span> <span class="p">(</span><span class="mi">49</span> <span class="o">+</span> <span class="p">(</span><span class="n">rec_on_trk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="n">d</span><span class="p">))</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x3380</span>:
			<span class="n">d</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">ceil_quot</span><span class="p">(</span><span class="n">blksize</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">sector</span> <span class="o">=</span> <span class="p">(</span><span class="mi">39</span> <span class="o">+</span> <span class="p">(</span><span class="n">rec_on_trk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">d</span><span class="p">))</span> <span class="o">/</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">length_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">length_scope</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">auxiliary</span><span class="p">.</span><span class="n">imbedded_ccw_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">tlf</span><span class="p">;</span>
	<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">imbedded_ccw</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
	<span class="n">set_ch_t</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lredata</span><span class="o">-&gt;</span><span class="n">seek_addr</span><span class="p">,</span> <span class="n">begcyl</span><span class="p">,</span> <span class="n">beghead</span><span class="p">);</span>
	<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">search_arg</span><span class="p">.</span><span class="n">cyl</span> <span class="o">=</span> <span class="n">lredata</span><span class="o">-&gt;</span><span class="n">seek_addr</span><span class="p">.</span><span class="n">cyl</span><span class="p">;</span>
	<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">search_arg</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">lredata</span><span class="o">-&gt;</span><span class="n">seek_addr</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">lredata</span><span class="o">-&gt;</span><span class="n">search_arg</span><span class="p">.</span><span class="n">record</span> <span class="o">=</span> <span class="n">rec_on_trk</span><span class="p">;</span>

	<span class="n">dcw</span> <span class="o">=</span> <span class="n">itcw_add_dcw</span><span class="p">(</span><span class="n">itcw</span><span class="p">,</span> <span class="n">pfx_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">pfxdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pfxdata</span><span class="p">),</span> <span class="n">total_data_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">dcw</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dcw</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="nf">dasd_eckd_build_cp_tpm_track</span><span class="p">(</span>
					       <span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">startdev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					       <span class="n">sector_t</span> <span class="n">first_rec</span><span class="p">,</span>
					       <span class="n">sector_t</span> <span class="n">last_rec</span><span class="p">,</span>
					       <span class="n">sector_t</span> <span class="n">first_trk</span><span class="p">,</span>
					       <span class="n">sector_t</span> <span class="n">last_trk</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first_offs</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_offs</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blk_per_trk</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_iterator</span> <span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trkcount</span><span class="p">,</span> <span class="n">ctidaw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">basedev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tlf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">itcw</span> <span class="o">*</span><span class="n">itcw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tidaw</span> <span class="o">*</span><span class="n">last_tidaw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">itcw_op</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">itcw_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tidaw_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seg_len</span><span class="p">,</span> <span class="n">part_len</span><span class="p">,</span> <span class="n">len_to_track_end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">new_track</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">recid</span><span class="p">,</span> <span class="n">trkid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">count_to_trk_end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">basedev</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_READ_TRACK_DATA</span><span class="p">;</span>
		<span class="n">itcw_op</span> <span class="o">=</span> <span class="n">ITCW_OP_READ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_WRITE_TRACK_DATA</span><span class="p">;</span>
		<span class="n">itcw_op</span> <span class="o">=</span> <span class="n">ITCW_OP_WRITE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="cm">/* trackbased I/O needs address all memory via TIDAWs,</span>
<span class="cm">	 * not just for 64 bit addresses. This allows us to map</span>
<span class="cm">	 * each segment directly to one tidaw.</span>
<span class="cm">	 * In the case of write requests, additional tidaws may</span>
<span class="cm">	 * be needed when a segment crosses a track boundary.</span>
<span class="cm">	 */</span>
	<span class="n">trkcount</span> <span class="o">=</span> <span class="n">last_trk</span> <span class="o">-</span> <span class="n">first_trk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ctidaw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">ctidaw</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="n">ctidaw</span> <span class="o">+=</span> <span class="p">(</span><span class="n">last_trk</span> <span class="o">-</span> <span class="n">first_trk</span><span class="p">);</span>

	<span class="cm">/* Allocate the ccw request. */</span>
	<span class="n">itcw_size</span> <span class="o">=</span> <span class="n">itcw_calc_size</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ctidaw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">itcw_size</span><span class="p">,</span> <span class="n">startdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>

	<span class="cm">/* transfer length factor: how many bytes to read from the last track */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first_trk</span> <span class="o">==</span> <span class="n">last_trk</span><span class="p">)</span>
		<span class="n">tlf</span> <span class="o">=</span> <span class="n">last_offs</span> <span class="o">-</span> <span class="n">first_offs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tlf</span> <span class="o">=</span> <span class="n">last_offs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tlf</span> <span class="o">*=</span> <span class="n">blksize</span><span class="p">;</span>

	<span class="n">itcw</span> <span class="o">=</span> <span class="n">itcw_init</span><span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">itcw_size</span><span class="p">,</span> <span class="n">itcw_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctidaw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">itcw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">=</span> <span class="n">itcw_get_tcw</span><span class="p">(</span><span class="n">itcw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prepare_itcw</span><span class="p">(</span><span class="n">itcw</span><span class="p">,</span> <span class="n">first_trk</span><span class="p">,</span> <span class="n">last_trk</span><span class="p">,</span>
			 <span class="n">cmd</span><span class="p">,</span> <span class="n">basedev</span><span class="p">,</span> <span class="n">startdev</span><span class="p">,</span>
			 <span class="n">first_offs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="n">trkcount</span><span class="p">,</span> <span class="n">blksize</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">last_rec</span> <span class="o">-</span> <span class="n">first_rec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">blksize</span><span class="p">,</span>
			 <span class="n">tlf</span><span class="p">,</span> <span class="n">blk_per_trk</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clock not in sync and XRC is enabled.</span>
<span class="cm">		 * Try again later.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len_to_track_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * A tidaw can address 4k of memory, but must not cross page boundaries</span>
<span class="cm">	 * We can let the block layer handle this by setting</span>
<span class="cm">	 * blk_queue_segment_boundary to page boundaries and</span>
<span class="cm">	 * blk_max_segment_size to page size when setting up the request queue.</span>
<span class="cm">	 * For write requests, a TIDAW must not cross track boundaries, because</span>
<span class="cm">	 * we have to set the CBC flag on the last tidaw for each track.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_track</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">recid</span> <span class="o">=</span> <span class="n">first_rec</span><span class="p">;</span>
		<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
			<span class="n">seg_len</span> <span class="o">=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">seg_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">new_track</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">trkid</span> <span class="o">=</span> <span class="n">recid</span><span class="p">;</span>
					<span class="n">offs</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">trkid</span><span class="p">,</span> <span class="n">blk_per_trk</span><span class="p">);</span>
					<span class="n">count_to_trk_end</span> <span class="o">=</span> <span class="n">blk_per_trk</span> <span class="o">-</span> <span class="n">offs</span><span class="p">;</span>
					<span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="n">last_rec</span> <span class="o">-</span> <span class="n">recid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
						    <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="n">count_to_trk_end</span><span class="p">);</span>
					<span class="n">len_to_track_end</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">blksize</span><span class="p">;</span>
					<span class="n">recid</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
					<span class="n">new_track</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">part_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">seg_len</span><span class="p">,</span> <span class="n">len_to_track_end</span><span class="p">);</span>
				<span class="n">seg_len</span> <span class="o">-=</span> <span class="n">part_len</span><span class="p">;</span>
				<span class="n">len_to_track_end</span> <span class="o">-=</span> <span class="n">part_len</span><span class="p">;</span>
				<span class="cm">/* We need to end the tidaw at track end */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len_to_track_end</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">new_track</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">tidaw_flags</span> <span class="o">=</span> <span class="n">TIDAW_FLAGS_INSERT_CBC</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">tidaw_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">last_tidaw</span> <span class="o">=</span> <span class="n">itcw_add_tidaw</span><span class="p">(</span><span class="n">itcw</span><span class="p">,</span> <span class="n">tidaw_flags</span><span class="p">,</span>
							    <span class="n">dst</span><span class="p">,</span> <span class="n">part_len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">last_tidaw</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dst</span> <span class="o">+=</span> <span class="n">part_len</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
			<span class="n">last_tidaw</span> <span class="o">=</span> <span class="n">itcw_add_tidaw</span><span class="p">(</span><span class="n">itcw</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
						    <span class="n">dst</span><span class="p">,</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">last_tidaw</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">last_tidaw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TIDAW_FLAGS_LAST</span><span class="p">;</span>
	<span class="n">last_tidaw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIDAW_FLAGS_INSERT_CBC</span><span class="p">;</span>
	<span class="n">itcw_finalize</span><span class="p">(</span><span class="n">itcw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blk_noretry_request</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_FAILFAST</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_FAILFAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">startdev</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">startdev</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">startdev</span><span class="o">-&gt;</span><span class="n">default_expires</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>	<span class="cm">/* default 5 minutes */</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">startdev</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">ppm</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
<span class="nl">out_error:</span>
	<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">startdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="nf">dasd_eckd_build_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">startdev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmdrtd</span><span class="p">,</span> <span class="n">cmdwtd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">use_prefix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fcx_multitrack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">basedev</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">first_rec</span><span class="p">,</span> <span class="n">last_rec</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">first_trk</span><span class="p">,</span> <span class="n">last_trk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first_offs</span><span class="p">,</span> <span class="n">last_offs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blk_per_trk</span><span class="p">,</span> <span class="n">blksize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cdlspecial</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>

	<span class="n">basedev</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">basedev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="cm">/* Calculate number of blocks/records per track. */</span>
	<span class="n">blksize</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">;</span>
	<span class="n">blk_per_trk</span> <span class="o">=</span> <span class="n">recs_per_track</span><span class="p">(</span><span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk_per_trk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="cm">/* Calculate record id of first and last block. */</span>
	<span class="n">first_rec</span> <span class="o">=</span> <span class="n">first_trk</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span><span class="p">;</span>
	<span class="n">first_offs</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">first_trk</span><span class="p">,</span> <span class="n">blk_per_trk</span><span class="p">);</span>
	<span class="n">last_rec</span> <span class="o">=</span> <span class="n">last_trk</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span><span class="p">;</span>
	<span class="n">last_offs</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">last_trk</span><span class="p">,</span> <span class="n">blk_per_trk</span><span class="p">);</span>
	<span class="n">cdlspecial</span> <span class="o">=</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">&amp;&amp;</span> <span class="n">first_rec</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">blk_per_trk</span><span class="p">);</span>

	<span class="n">fcx_multitrack</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">feature</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">data_size</span> <span class="o">=</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="cm">/* tpm write request add CBC data on each track boundary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="n">data_size</span> <span class="o">+=</span> <span class="p">(</span><span class="n">last_trk</span> <span class="o">-</span> <span class="n">first_trk</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* is read track data and write track data in command mode supported? */</span>
	<span class="n">cmdrtd</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">feature</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">cmdwtd</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">feature</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">use_prefix</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">feature</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="n">cqr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdlspecial</span> <span class="o">||</span> <span class="n">dasd_page_cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* do nothing, just fall through to the cmd mode single case */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">data_size</span> <span class="o">&lt;=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">fcx_max_data</span><span class="p">)</span>
		   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fcx_multitrack</span> <span class="o">||</span> <span class="p">(</span><span class="n">first_trk</span> <span class="o">==</span> <span class="n">last_trk</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_eckd_build_cp_tpm_track</span><span class="p">(</span><span class="n">startdev</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
						    <span class="n">first_rec</span><span class="p">,</span> <span class="n">last_rec</span><span class="p">,</span>
						    <span class="n">first_trk</span><span class="p">,</span> <span class="n">last_trk</span><span class="p">,</span>
						    <span class="n">first_offs</span><span class="p">,</span> <span class="n">last_offs</span><span class="p">,</span>
						    <span class="n">blk_per_trk</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">))</span>
			<span class="n">cqr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">use_prefix</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(((</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmdrtd</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmdwtd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_eckd_build_cp_cmd_track</span><span class="p">(</span><span class="n">startdev</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
						   <span class="n">first_rec</span><span class="p">,</span> <span class="n">last_rec</span><span class="p">,</span>
						   <span class="n">first_trk</span><span class="p">,</span> <span class="n">last_trk</span><span class="p">,</span>
						   <span class="n">first_offs</span><span class="p">,</span> <span class="n">last_offs</span><span class="p">,</span>
						   <span class="n">blk_per_trk</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">))</span>
			<span class="n">cqr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cqr</span><span class="p">)</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_eckd_build_cp_cmd_single</span><span class="p">(</span><span class="n">startdev</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
						    <span class="n">first_rec</span><span class="p">,</span> <span class="n">last_rec</span><span class="p">,</span>
						    <span class="n">first_trk</span><span class="p">,</span> <span class="n">last_trk</span><span class="p">,</span>
						    <span class="n">first_offs</span><span class="p">,</span> <span class="n">last_offs</span><span class="p">,</span>
						    <span class="n">blk_per_trk</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="nf">dasd_raw_build_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">startdev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">idaws</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">basedev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_iterator</span> <span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trkcount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seg_len</span><span class="p">,</span> <span class="n">len_to_track_end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first_offs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cidaw</span><span class="p">,</span> <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">first_trk</span><span class="p">,</span> <span class="n">last_trk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pfx_datasize</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * raw track access needs to be mutiple of 64k and on 64k boundary</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">%</span> <span class="n">DASD_RAW_SECTORS_PER_TRACK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="o">%</span>
	     <span class="n">DASD_RAW_SECTORS_PER_TRACK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">first_trk</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">/</span> <span class="n">DASD_RAW_SECTORS_PER_TRACK</span><span class="p">;</span>
	<span class="n">last_trk</span> <span class="o">=</span> <span class="p">(</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span>
		<span class="n">DASD_RAW_SECTORS_PER_TRACK</span><span class="p">;</span>
	<span class="n">trkcount</span> <span class="o">=</span> <span class="n">last_trk</span> <span class="o">-</span> <span class="n">first_trk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">first_offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">basedev</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_READ_TRACK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_WRITE_FULL_TRACK</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Raw track based I/O needs IDAWs for each page,</span>
<span class="cm">	 * and not just for 64 bit addresses.</span>
<span class="cm">	 */</span>
	<span class="n">cidaw</span> <span class="o">=</span> <span class="n">trkcount</span> <span class="o">*</span> <span class="n">DASD_RAW_BLOCK_PER_TRACK</span><span class="p">;</span>

	<span class="cm">/* 1x prefix + one read/write ccw per track */</span>
	<span class="n">cplength</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">trkcount</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * struct PFX_eckd_data has up to 2 byte as extended parameter</span>
<span class="cm">	 * this is needed for write full track and has to be mentioned</span>
<span class="cm">	 * separately</span>
<span class="cm">	 * add 8 instead of 2 to keep 8 byte boundary</span>
<span class="cm">	 */</span>
	<span class="n">pfx_datasize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PFX_eckd_data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">datasize</span> <span class="o">=</span> <span class="n">pfx_datasize</span> <span class="o">+</span> <span class="n">cidaw</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">);</span>

	<span class="cm">/* Allocate the ccw request. */</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="n">cplength</span><span class="p">,</span>
				   <span class="n">datasize</span><span class="p">,</span> <span class="n">startdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prefix_LRE</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">first_trk</span><span class="p">,</span> <span class="n">last_trk</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
		       <span class="n">basedev</span><span class="p">,</span> <span class="n">startdev</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* format */</span><span class="p">,</span> <span class="n">first_offs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">trkcount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clock not in sync and XRC is enabled.</span>
<span class="cm">		 * Try again later.</span>
<span class="cm">		 */</span>
		<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">startdev</span><span class="p">);</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">idaws</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">pfx_datasize</span><span class="p">);</span>

	<span class="n">len_to_track_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
		<span class="n">seg_len</span> <span class="o">=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len_to_track_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="cm">/* maximum 3390 track size */</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">57326</span><span class="p">;</span>
			<span class="cm">/* 64k map to one track */</span>
			<span class="n">len_to_track_end</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span><span class="n">idaws</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_IDA</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len_to_track_end</span> <span class="o">-=</span> <span class="n">seg_len</span><span class="p">;</span>
		<span class="n">idaws</span> <span class="o">=</span> <span class="n">idal_create_words</span><span class="p">(</span><span class="n">idaws</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">seg_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blk_noretry_request</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_FAILFAST</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_FAILFAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">startdev</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">startdev</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">startdev</span><span class="o">-&gt;</span><span class="n">default_expires</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">startdev</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">ppm</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_free_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_iterator</span> <span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">cda</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">,</span> <span class="n">blk_per_trk</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">recid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dasd_page_cache</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">blksize</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">;</span>
	<span class="n">blk_per_trk</span> <span class="o">=</span> <span class="n">recs_per_track</span><span class="p">(</span><span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>
	<span class="n">recid</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span><span class="p">;</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="cm">/* Skip over define extent &amp; locate record. */</span>
	<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">recid</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">blk_per_trk</span><span class="p">)</span>
		<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span> <span class="n">off</span> <span class="o">+=</span> <span class="n">blksize</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Skip locate record. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">&amp;&amp;</span> <span class="n">recid</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">blk_per_trk</span><span class="p">)</span>
				<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CCW_FLAG_IDA</span><span class="p">)</span>
					<span class="n">cda</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">**</span><span class="p">)((</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span><span class="p">));</span>
				<span class="k">else</span>
					<span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)((</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dst</span> <span class="o">!=</span> <span class="n">cda</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
						<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">cda</span><span class="p">,</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">);</span>
					<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">dasd_page_cache</span><span class="p">,</span>
					    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="n">addr_t</span><span class="p">)</span><span class="n">cda</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
			<span class="n">recid</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DASD_CQR_DONE</span><span class="p">;</span>
	<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Modify ccw/tcw in cqr so it can be started on a base device.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that this is not enough to restart the cqr!</span>
<span class="cm"> * Either reset cqr-&gt;startdev as well (summary unit check handling)</span>
<span class="cm"> * or restart via separate cqr (as in ERP handling).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dasd_eckd_reset_ccw_to_base_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">PFX_eckd_data</span> <span class="o">*</span><span class="n">pfxdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcw</span> <span class="o">*</span><span class="n">tcw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tccb</span> <span class="o">*</span><span class="n">tccb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcw</span> <span class="o">*</span><span class="n">dcw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpmode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tcw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
		<span class="n">tccb</span> <span class="o">=</span> <span class="n">tcw_get_tccb</span><span class="p">(</span><span class="n">tcw</span><span class="p">);</span>
		<span class="n">dcw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dcw</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tccb</span><span class="o">-&gt;</span><span class="n">tca</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">pfxdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">PFX_eckd_data</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dcw</span><span class="o">-&gt;</span><span class="n">cd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">validity</span><span class="p">.</span><span class="n">verify_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">validity</span><span class="p">.</span><span class="n">hyper_pav</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
		<span class="n">pfxdata</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">==</span> <span class="n">DASD_ECKD_CCW_PFX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">validity</span><span class="p">.</span><span class="n">verify_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pfxdata</span><span class="o">-&gt;</span><span class="n">validity</span><span class="p">.</span><span class="n">hyper_pav</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define DASD_ECKD_CHANQ_MAX_SIZE 4</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="nf">dasd_eckd_build_alias_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">startdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>

	<span class="n">startdev</span> <span class="o">=</span> <span class="n">dasd_alias_get_start_dev</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">startdev</span><span class="p">)</span>
		<span class="n">startdev</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">startdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">DASD_ECKD_CHANQ_MAX_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">startdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_USERAW</span><span class="p">))</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_raw_build_cp</span><span class="p">(</span><span class="n">startdev</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_eckd_build_cp</span><span class="p">(</span><span class="n">startdev</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span>
		<span class="n">private</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">startdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_free_alias_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dasd_eckd_free_cp</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_fill_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span> <span class="n">device</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">dasd_information2_t</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">label_block</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">FBA_layout</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">uses_cdl</span> <span class="o">?</span> <span class="n">DASD_FORMAT_CDL</span> <span class="o">:</span> <span class="n">DASD_FORMAT_LDL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">characteristics_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_characteristics</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">characteristics</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_characteristics</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">confdata_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_len</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">configuration_data</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">configuration_data</span><span class="p">,</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">conf_data</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">confdata_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SECTION: ioctl functions for eckd devices.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Release device ioctl.</span>
<span class="cm"> * Buils a channel programm to releases a prior reserved</span>
<span class="cm"> * (see dasd_eckd_reserve) device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">useglobal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">useglobal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_reserve_mutex</span><span class="p">);</span>
		<span class="n">useglobal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">cqr</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cqr</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">));</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">;</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">DASD_ECKD_MAGIC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_RELEASE</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_USE_ERP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_FAILFAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* set retry counter to enable basic ERP */</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_sleep_on_immediatly</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">DASD_FLAG_IS_RESERVED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">useglobal</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_reserve_mutex</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reserve device ioctl.</span>
<span class="cm"> * Options are set to &#39;synchronous wait for interrupt&#39; and</span>
<span class="cm"> * &#39;timeout the request&#39;. This leads to a terminate IO if</span>
<span class="cm"> * the interrupt is outstanding for a certain time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">useglobal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">useglobal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_reserve_mutex</span><span class="p">);</span>
		<span class="n">useglobal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">cqr</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cqr</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">));</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">;</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">DASD_ECKD_MAGIC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_RESERVE</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_USE_ERP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_FAILFAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* set retry counter to enable basic ERP */</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_sleep_on_immediatly</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_FLAG_IS_RESERVED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">useglobal</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_reserve_mutex</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Steal lock ioctl - unconditional reserve device.</span>
<span class="cm"> * Buils a channel programm to break a device&#39;s reservation.</span>
<span class="cm"> * (unconditional reserve)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_steal_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">useglobal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">useglobal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_reserve_mutex</span><span class="p">);</span>
		<span class="n">useglobal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">cqr</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cqr</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">));</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">;</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">DASD_ECKD_MAGIC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_SLCK</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_USE_ERP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_FAILFAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* set retry counter to enable basic ERP */</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_sleep_on_immediatly</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_FLAG_IS_RESERVED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">useglobal</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_reserve_mutex</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SNID - Sense Path Group ID</span>
<span class="cm"> * This ioctl may be used in situations where I/O is stalled due to</span>
<span class="cm"> * a reserve, so if the normal dasd_smalloc_request fails, we use the</span>
<span class="cm"> * preallocated dasd_reserve_req.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_snid</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">useglobal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_snid_ioctl_data</span> <span class="n">usrparm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrparm</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">usrparm</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">useglobal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_snid_data</span><span class="p">),</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_reserve_mutex</span><span class="p">);</span>
		<span class="n">useglobal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cqr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">cqr</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cqr</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">));</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">;</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dasd_reserve_req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">DASD_ECKD_MAGIC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_SNID</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_USE_ERP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_FAILFAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_CQR_ALLOW_SLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">usrparm</span><span class="p">.</span><span class="n">path_mask</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_sleep_on_immediatly</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
	<span class="cm">/* verify that I/O processing didn&#39;t modify the path mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">usrparm</span><span class="p">.</span><span class="n">path_mask</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">!=</span> <span class="n">usrparm</span><span class="p">.</span><span class="n">path_mask</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usrparm</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">dasd_snid_data</span> <span class="o">*</span><span class="p">)</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usrparm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">usrparm</span><span class="p">)))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">useglobal</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_reserve_mutex</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read performance statistics</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_performance</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_psf_prssd_data</span> <span class="o">*</span><span class="n">prssdp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_rssd_perf_stats_t</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* PSF */</span>  <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* RSSD */</span><span class="p">,</span>
				   <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_psf_prssd_data</span><span class="p">)</span> <span class="o">+</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_perf_stats_t</span><span class="p">)),</span>
				   <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;Could not allocate initialization request&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_USE_ERP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="cm">/* Prepare for Read Subsystem Data */</span>
	<span class="n">prssdp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_psf_prssd_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">prssdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_psf_prssd_data</span><span class="p">));</span>
	<span class="n">prssdp</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">=</span> <span class="n">PSF_ORDER_PRSSD</span><span class="p">;</span>
	<span class="n">prssdp</span><span class="o">-&gt;</span><span class="n">suborder</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* Performance Statistics */</span>
	<span class="n">prssdp</span><span class="o">-&gt;</span><span class="n">varies</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* Perf Statistics for the Subsystem */</span>

	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_PSF</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_psf_prssd_data</span><span class="p">);</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">prssdp</span><span class="p">;</span>

	<span class="cm">/* Read Subsystem Data - Performance Statistics */</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_perf_stats_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">prssdp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_perf_stats_t</span><span class="p">));</span>

	<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_RSSD</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_perf_stats_t</span><span class="p">);</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">stats</span><span class="p">;</span>

	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_sleep_on</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prssdp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_psf_prssd_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_perf_stats_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">prssdp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_rssd_perf_stats_t</span><span class="p">)))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get attributes (cache operations)</span>
<span class="cm"> * Returnes the cache attributes used in Define Extend (DE).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_get_attrib</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attrib_data_t</span> <span class="n">attrib</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">attrib</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">attrib_data_t</span><span class="p">)))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set attributes (cache operations)</span>
<span class="cm"> * Stores the attributes for cache operation to be used in Define Extend (DE).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_set_attrib</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attrib_data_t</span> <span class="n">attrib</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attrib</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">attrib_data_t</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">private</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;The DASD cache mode was set to %x (%i cylinder prestage)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">private</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">nr_cyl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Issue syscall I/O to EMC Symmetrix array.</span>
<span class="cm"> * CCWs are PSF and RSSD</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_symm_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_symmio_parms</span> <span class="n">usrparm</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psf_data</span><span class="p">,</span> <span class="o">*</span><span class="n">rssd_result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">psf0</span><span class="p">,</span> <span class="n">psf1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="n">psf0</span> <span class="o">=</span> <span class="n">psf1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Copy parms from caller */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usrparm</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">usrparm</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_compat_task</span><span class="p">()</span> <span class="o">||</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure pointers are sane even on 31 bit. */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">usrparm</span><span class="p">.</span><span class="n">psf_data</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">usrparm</span><span class="p">.</span><span class="n">rssd_result</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">usrparm</span><span class="p">.</span><span class="n">psf_data</span> <span class="o">&amp;=</span> <span class="mh">0x7fffffffULL</span><span class="p">;</span>
		<span class="n">usrparm</span><span class="p">.</span><span class="n">rssd_result</span> <span class="o">&amp;=</span> <span class="mh">0x7fffffffULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* alloc I/O data area */</span>
	<span class="n">psf_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">usrparm</span><span class="p">.</span><span class="n">psf_data_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="n">rssd_result</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">usrparm</span><span class="p">.</span><span class="n">rssd_result_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psf_data</span> <span class="o">||</span> <span class="o">!</span><span class="n">rssd_result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get syscall header from user space */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">psf_data</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">usrparm</span><span class="p">.</span><span class="n">psf_data</span><span class="p">,</span>
			   <span class="n">usrparm</span><span class="p">.</span><span class="n">psf_data_len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="n">psf0</span> <span class="o">=</span> <span class="n">psf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">psf1</span> <span class="o">=</span> <span class="n">psf_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* setup CCWs for PSF + RSSD */</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span> <span class="mi">2</span> <span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			<span class="s">&quot;Could not allocate initialization request&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>

	<span class="cm">/* Build the ccws */</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>

	<span class="cm">/* PSF ccw */</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_PSF</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">usrparm</span><span class="p">.</span><span class="n">psf_data_len</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">psf_data</span><span class="p">;</span>

	<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* RSSD ccw  */</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_ECKD_CCW_RSSD</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">usrparm</span><span class="p">.</span><span class="n">rssd_result_len</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span> <span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">rssd_result</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_sleep_on</span><span class="p">(</span><span class="n">cqr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sfree</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">usrparm</span><span class="p">.</span><span class="n">rssd_result</span><span class="p">,</span>
			   <span class="n">rssd_result</span><span class="p">,</span> <span class="n">usrparm</span><span class="p">.</span><span class="n">rssd_result_len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_sfree</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_sfree:</span>
	<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rssd_result</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psf_data</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
		      <span class="s">&quot;Symmetrix ioctl (0x%02x 0x%02x): rc=%d&quot;</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">psf0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">psf1</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BIODASDGATTR</span>:
		<span class="k">return</span> <span class="n">dasd_eckd_get_attrib</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BIODASDSATTR</span>:
		<span class="k">return</span> <span class="n">dasd_eckd_set_attrib</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BIODASDPSRD</span>:
		<span class="k">return</span> <span class="n">dasd_eckd_performance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BIODASDRLSE</span>:
		<span class="k">return</span> <span class="n">dasd_eckd_release</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BIODASDRSRV</span>:
		<span class="k">return</span> <span class="n">dasd_eckd_reserve</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BIODASDSLCK</span>:
		<span class="k">return</span> <span class="n">dasd_eckd_steal_lock</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BIODASDSNID</span>:
		<span class="k">return</span> <span class="n">dasd_eckd_snid</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BIODASDSYMMIO</span>:
		<span class="k">return</span> <span class="n">dasd_symm_io</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dump the range of CCWs into &#39;page&#39; buffer</span>
<span class="cm"> * and return number of printed chars.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_eckd_dump_ccw_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">datap</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">from</span> <span class="o">&lt;=</span> <span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; CCW %p: %08X %08X DAT:&quot;</span><span class="p">,</span>
			       <span class="n">from</span><span class="p">,</span> <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">from</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">from</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="cm">/* get pointer to data (consider IDALs) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CCW_FLAG_IDA</span><span class="p">)</span>
			<span class="n">datap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span><span class="p">((</span><span class="n">addr_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">cda</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">datap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">cda</span><span class="p">);</span>

		<span class="cm">/* dump data (max 32 bytes) */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">datap</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">from</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dasd_eckd_dump_sense_dbf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">stat</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">dasd_get_sense</span><span class="p">(</span><span class="n">irb</span><span class="p">);</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_EMERG</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s: %016llx %08x : &quot;</span>
			      <span class="s">&quot;%016llx %016llx %016llx %016llx&quot;</span><span class="p">,</span>
			      <span class="n">reason</span><span class="p">,</span> <span class="o">*</span><span class="n">stat</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">stat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
			      <span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_EMERG</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s: %016llx %08x : %s&quot;</span><span class="p">,</span>
			      <span class="n">reason</span><span class="p">,</span> <span class="o">*</span><span class="n">stat</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">stat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
			      <span class="s">&quot;NO VALID SENSE&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print sense data and related channel program.</span>
<span class="cm"> * Parts are printed because printk buffer is only 1024 bytes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_eckd_dump_sense_ccw</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="n">last</span><span class="p">,</span> <span class="o">*</span><span class="n">fail</span><span class="p">,</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="o">*</span><span class="n">to</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">sct</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			      <span class="s">&quot;No memory to dump sense data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* dump the sense data */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span>  <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
		      <span class="s">&quot; I/O status report for device %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
		       <span class="s">&quot; in req: %p CC:%02X FC:%02X AC:%02X SC:%02X DS:%02X &quot;</span>
		       <span class="s">&quot;CS:%02X RC:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">req</span><span class="p">,</span> <span class="n">scsw_cc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span> <span class="n">scsw_fctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span>
		       <span class="n">scsw_actl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span> <span class="n">scsw_stctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span>
		       <span class="n">scsw_dstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span> <span class="n">scsw_cstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span>
		       <span class="n">req</span> <span class="o">?</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">intrc</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
		       <span class="s">&quot; device %s: Failing CCW: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cons</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">sl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sl</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">sl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
				       <span class="s">&quot; Sense(hex) %2d-%2d:&quot;</span><span class="p">,</span>
				       <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">sl</span><span class="p">),</span> <span class="p">((</span><span class="mi">8</span> <span class="o">*</span> <span class="n">sl</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">sct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sct</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">sct</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span>
					       <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">8</span> <span class="o">*</span> <span class="n">sl</span> <span class="o">+</span> <span class="n">sct</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SENSE_BIT_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 24 Byte Sense Data */</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
				<span class="s">&quot; 24 Byte: %x MSG %x, &quot;</span>
				<span class="s">&quot;%s MSGb to SYSOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>
				<span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* 32 Byte Sense Data */</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
				<span class="s">&quot; 32 Byte: Format: %x &quot;</span>
				<span class="s">&quot;Exception class %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			<span class="s">&quot; SORRY - NO VALID SENSE AVAILABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* req == NULL for unsolicited interrupts */</span>
		<span class="cm">/* dump the Channel Program (max 140 Bytes per line) */</span>
		<span class="cm">/* Count CCW and print first CCWs (maximum 1024 % 140 = 7) */</span>
		<span class="n">first</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">last</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">last</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CCW_FLAG_CC</span> <span class="o">|</span> <span class="n">CCW_FLAG_DC</span><span class="p">);</span> <span class="n">last</span><span class="o">++</span><span class="p">);</span>
		<span class="n">to</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span>  <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			      <span class="s">&quot; Related CP in req: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">dasd_eckd_dump_ccw_range</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

		<span class="cm">/* print failing CCW area (maximum 4) */</span>
		<span class="cm">/* scsw-&gt;cda is either valid or zero  */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">from</span> <span class="o">=</span> <span class="o">++</span><span class="n">to</span><span class="p">;</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span>
				<span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span><span class="p">;</span> <span class="cm">/* failing CCW */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">&lt;</span>  <span class="n">fail</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">from</span> <span class="o">=</span> <span class="n">fail</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>     <span class="cm">/* there is a gap - print header */</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span> <span class="s">&quot;......</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">to</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">fail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">dasd_eckd_dump_ccw_range</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>

		<span class="cm">/* print last CCWs (maximum 2) */</span>
		<span class="n">from</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="o">++</span><span class="n">to</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">&lt;</span> <span class="n">last</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">from</span> <span class="o">=</span> <span class="n">last</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>     <span class="cm">/* there is a gap - print header */</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span> <span class="s">&quot;......</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">dasd_eckd_dump_ccw_range</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Print sense data from a tcw.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_eckd_dump_sense_tcw</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">sct</span><span class="p">,</span> <span class="n">residual</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsb</span> <span class="o">*</span><span class="n">tsb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">sense</span><span class="p">,</span> <span class="o">*</span><span class="n">rcq</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;No memory to dump sense data&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* dump the sense data */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span>  <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
		      <span class="s">&quot; I/O status report for device %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
		       <span class="s">&quot; in req: %p CC:%02X FC:%02X AC:%02X SC:%02X DS:%02X &quot;</span>
		       <span class="s">&quot;CS:%02X fcxs:%02X schxs:%02X RC:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">req</span><span class="p">,</span> <span class="n">scsw_cc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span> <span class="n">scsw_fctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span>
		       <span class="n">scsw_actl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span> <span class="n">scsw_stctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span>
		       <span class="n">scsw_dstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span> <span class="n">scsw_cstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span>
		       <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">tm</span><span class="p">.</span><span class="n">fcxs</span><span class="p">,</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">tm</span><span class="p">.</span><span class="n">schxs</span><span class="p">,</span>
		       <span class="n">req</span> <span class="o">?</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">intrc</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
		       <span class="s">&quot; device %s: Failing TCW: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">tm</span><span class="p">.</span><span class="n">tcw</span><span class="p">);</span>

	<span class="n">tsb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sense</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">tm</span><span class="p">.</span><span class="n">tcw</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">tm</span><span class="p">.</span><span class="n">fcxs</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="n">tsb</span> <span class="o">=</span> <span class="n">tcw_get_tsb</span><span class="p">(</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">tcw</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">tm</span><span class="p">.</span><span class="n">tcw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tsb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; tsb-&gt;length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; tsb-&gt;flags %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; tsb-&gt;dcw_offset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">dcw_offset</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; tsb-&gt;count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">residual</span> <span class="o">=</span> <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="mi">28</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; residual %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">residual</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">tsb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* tsa_iostat */</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; tsb-&gt;tsa.iostat.dev_time %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">tsa</span><span class="p">.</span><span class="n">iostat</span><span class="p">.</span><span class="n">dev_time</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; tsb-&gt;tsa.iostat.def_time %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">tsa</span><span class="p">.</span><span class="n">iostat</span><span class="p">.</span><span class="n">def_time</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; tsb-&gt;tsa.iostat.queue_time %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">tsa</span><span class="p">.</span><span class="n">iostat</span><span class="p">.</span><span class="n">queue_time</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; tsb-&gt;tsa.iostat.dev_busy_time %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">tsa</span><span class="p">.</span><span class="n">iostat</span><span class="p">.</span><span class="n">dev_busy_time</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; tsb-&gt;tsa.iostat.dev_act_time %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">tsa</span><span class="p">.</span><span class="n">iostat</span><span class="p">.</span><span class="n">dev_act_time</span><span class="p">);</span>
			<span class="n">sense</span> <span class="o">=</span> <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">tsa</span><span class="p">.</span><span class="n">iostat</span><span class="p">.</span><span class="n">sense</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* ts_ddpc */</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; tsb-&gt;tsa.ddpc.rc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">tsa</span><span class="p">.</span><span class="n">ddpc</span><span class="p">.</span><span class="n">rc</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">sl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sl</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">sl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
					       <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
					       <span class="s">&quot; tsb-&gt;tsa.ddpc.rcq %2d-%2d: &quot;</span><span class="p">,</span>
					       <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">sl</span><span class="p">),</span> <span class="p">((</span><span class="mi">8</span> <span class="o">*</span> <span class="n">sl</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">));</span>
				<span class="n">rcq</span> <span class="o">=</span> <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">tsa</span><span class="p">.</span><span class="n">ddpc</span><span class="p">.</span><span class="n">rcq</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">sct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sct</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">sct</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span>
						       <span class="n">rcq</span><span class="p">[</span><span class="mi">8</span> <span class="o">*</span> <span class="n">sl</span> <span class="o">+</span> <span class="n">sct</span><span class="p">]);</span>
				<span class="p">}</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">sense</span> <span class="o">=</span> <span class="n">tsb</span><span class="o">-&gt;</span><span class="n">tsa</span><span class="p">.</span><span class="n">ddpc</span><span class="p">.</span><span class="n">sense</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* tsa_intrg */</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
				      <span class="s">&quot; tsb-&gt;tsa.intrg.: not supportet yet </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">sl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sl</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">sl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
					       <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
					       <span class="s">&quot; Sense(hex) %2d-%2d:&quot;</span><span class="p">,</span>
					       <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">sl</span><span class="p">),</span> <span class="p">((</span><span class="mi">8</span> <span class="o">*</span> <span class="n">sl</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">));</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">sct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sct</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">sct</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span>
						       <span class="n">sense</span><span class="p">[</span><span class="mi">8</span> <span class="o">*</span> <span class="n">sl</span> <span class="o">+</span> <span class="n">sct</span><span class="p">]);</span>
				<span class="p">}</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DASD_SENSE_BIT_0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* 24 Byte Sense Data */</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
					<span class="s">&quot; 24 Byte: %x MSG %x, &quot;</span>
					<span class="s">&quot;%s MSGb to SYSOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>
					<span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* 32 Byte Sense Data */</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
					<span class="s">&quot; 32 Byte: Format: %x &quot;</span>
					<span class="s">&quot;Exception class %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">sense</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
				<span class="s">&quot; SORRY - NO VALID SENSE AVAILABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			<span class="s">&quot; SORRY - NO TSB DATA AVAILABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_eckd_dump_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsw_is_tm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">))</span>
		<span class="n">dasd_eckd_dump_sense_tcw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dasd_eckd_dump_sense_ccw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_pm_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * the device should be disconnected from our LCU structure</span>
<span class="cm">	 * on restore we will reconnect it and reread LCU specific</span>
<span class="cm">	 * information like PAV support that might have changed</span>
<span class="cm">	 */</span>
	<span class="n">dasd_alias_remove_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">dasd_alias_disconnect_device_from_lcu</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_restore_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_characteristics</span> <span class="n">temp_rdc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_uid</span> <span class="n">temp_uid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="cm">/* Read Configuration Data */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eckd_read_conf</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">dasd_eckd_get_uid</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_uid</span><span class="p">);</span>
	<span class="cm">/* Generate device unique id */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eckd_generate_uid</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_uid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_uid</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The UID of the DASD has &quot;</span>
			<span class="s">&quot;changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="cm">/* register lcu with alias handling, enable PAV if this is a new lcu */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_alias_make_device_known_to_lcu</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">dasd_eckd_validate_server</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="cm">/* RE-Read Configuration Data */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eckd_read_conf</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="cm">/* Read Feature Codes */</span>
	<span class="n">dasd_eckd_read_features</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="cm">/* Read Device Characteristics */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_generic_read_dev_chars</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">DASD_ECKD_MAGIC</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">temp_rdc_data</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span>
				<span class="s">&quot;Read device characteristic failed, rc=%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_rdc_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp_rdc_data</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* add device to alias management */</span>
	<span class="n">dasd_alias_add_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_eckd_reload_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">old_base</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">print_uid</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dasd_uid</span> <span class="n">uid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_eckd_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">old_base</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">.</span><span class="n">base_unit_addr</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Read Configuration Data */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eckd_read_conf</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_eckd_generate_uid</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * update unit address configuration and</span>
<span class="cm">	 * add device to alias management</span>
<span class="cm">	 */</span>
	<span class="n">dasd_alias_update_add_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="n">dasd_eckd_get_uid</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_base</span> <span class="o">!=</span> <span class="n">uid</span><span class="p">.</span><span class="n">base_unit_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">uid</span><span class="p">.</span><span class="n">vduit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">print_uid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">print_uid</span><span class="p">),</span>
				 <span class="s">&quot;%s.%s.%04x.%02x.%s&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="p">.</span><span class="n">vendor</span><span class="p">,</span> <span class="n">uid</span><span class="p">.</span><span class="n">serial</span><span class="p">,</span>
				 <span class="n">uid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">uid</span><span class="p">.</span><span class="n">base_unit_addr</span><span class="p">,</span> <span class="n">uid</span><span class="p">.</span><span class="n">vduit</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">print_uid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">print_uid</span><span class="p">),</span>
				 <span class="s">&quot;%s.%s.%04x.%02x&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="p">.</span><span class="n">vendor</span><span class="p">,</span> <span class="n">uid</span><span class="p">.</span><span class="n">serial</span><span class="p">,</span>
				 <span class="n">uid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">uid</span><span class="p">.</span><span class="n">base_unit_addr</span><span class="p">);</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;An Alias device was reassigned to a new base device &quot;</span>
			 <span class="s">&quot;with UID: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">print_uid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_driver</span> <span class="n">dasd_eckd_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;dasd-eckd&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ids</span>	     <span class="o">=</span> <span class="n">dasd_eckd_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>	     <span class="o">=</span> <span class="n">dasd_eckd_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>      <span class="o">=</span> <span class="n">dasd_generic_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_offline</span> <span class="o">=</span> <span class="n">dasd_generic_set_offline</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_online</span>  <span class="o">=</span> <span class="n">dasd_eckd_set_online</span><span class="p">,</span>
	<span class="p">.</span><span class="n">notify</span>      <span class="o">=</span> <span class="n">dasd_generic_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">path_event</span>  <span class="o">=</span> <span class="n">dasd_generic_path_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span>      <span class="o">=</span> <span class="n">dasd_generic_pm_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span>	     <span class="o">=</span> <span class="n">dasd_generic_restore_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span>     <span class="o">=</span> <span class="n">dasd_generic_restore_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uc_handler</span>  <span class="o">=</span> <span class="n">dasd_generic_uc_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">int_class</span>   <span class="o">=</span> <span class="n">IOINT_DAS</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * max_blocks is dependent on the amount of storage that is available</span>
<span class="cm"> * in the static io buffer for each device. Currently each device has</span>
<span class="cm"> * 8192 bytes (=2 pages). For 64 bit one dasd_mchunkt_t structure has</span>
<span class="cm"> * 24 bytes, the struct dasd_ccw_req has 136 bytes and each block can use</span>
<span class="cm"> * up to 16 bytes (8 for the ccw and 8 for the idal pointer). In</span>
<span class="cm"> * addition we have one define extent ccw + 16 bytes of data and one</span>
<span class="cm"> * locate record ccw + 16 bytes of data. That makes:</span>
<span class="cm"> * (8192 - 24 - 136 - 8 - 16 - 8 - 16) / 16 = 499 blocks at maximum.</span>
<span class="cm"> * We want to fit two into the available memory so that we can immediately</span>
<span class="cm"> * start the next request if one finishes off. That makes 249.5 blocks</span>
<span class="cm"> * for one request. Give a little safety and the result is 240.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_discipline</span> <span class="n">dasd_eckd_discipline</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ECKD&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ebcname</span> <span class="o">=</span> <span class="s">&quot;ECKD&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_blocks</span> <span class="o">=</span> <span class="mi">190</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_device</span> <span class="o">=</span> <span class="n">dasd_eckd_check_characteristics</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uncheck_device</span> <span class="o">=</span> <span class="n">dasd_eckd_uncheck_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">do_analysis</span> <span class="o">=</span> <span class="n">dasd_eckd_do_analysis</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_path</span> <span class="o">=</span> <span class="n">dasd_eckd_verify_path</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ready_to_online</span> <span class="o">=</span> <span class="n">dasd_eckd_ready_to_online</span><span class="p">,</span>
	<span class="p">.</span><span class="n">online_to_ready</span> <span class="o">=</span> <span class="n">dasd_eckd_online_to_ready</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fill_geometry</span> <span class="o">=</span> <span class="n">dasd_eckd_fill_geometry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_IO</span> <span class="o">=</span> <span class="n">dasd_start_IO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">term_IO</span> <span class="o">=</span> <span class="n">dasd_term_IO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_terminated_request</span> <span class="o">=</span> <span class="n">dasd_eckd_handle_terminated_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_device</span> <span class="o">=</span> <span class="n">dasd_eckd_format_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">erp_action</span> <span class="o">=</span> <span class="n">dasd_eckd_erp_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">erp_postaction</span> <span class="o">=</span> <span class="n">dasd_eckd_erp_postaction</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_for_device_change</span> <span class="o">=</span> <span class="n">dasd_eckd_check_for_device_change</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_cp</span> <span class="o">=</span> <span class="n">dasd_eckd_build_alias_cp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_cp</span> <span class="o">=</span> <span class="n">dasd_eckd_free_alias_cp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_sense</span> <span class="o">=</span> <span class="n">dasd_eckd_dump_sense</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_sense_dbf</span> <span class="o">=</span> <span class="n">dasd_eckd_dump_sense_dbf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fill_info</span> <span class="o">=</span> <span class="n">dasd_eckd_fill_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">dasd_eckd_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">dasd_eckd_pm_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">dasd_eckd_restore_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reload</span> <span class="o">=</span> <span class="n">dasd_eckd_reload_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_uid</span> <span class="o">=</span> <span class="n">dasd_eckd_get_uid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kick_validate</span> <span class="o">=</span> <span class="n">dasd_eckd_kick_validate_server</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">dasd_eckd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ASCEBC</span><span class="p">(</span><span class="n">dasd_eckd_discipline</span><span class="p">.</span><span class="n">ebcname</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">dasd_reserve_req</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dasd_reserve_req</span><span class="p">),</span>
				   <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dasd_reserve_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">path_verification_worker</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">path_verification_worker</span><span class="p">),</span>
				   <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path_verification_worker</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dasd_reserve_req</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccw_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_eckd_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">wait_for_device_probe</span><span class="p">();</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">path_verification_worker</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dasd_reserve_req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">dasd_eckd_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccw_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_eckd_driver</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">path_verification_worker</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dasd_reserve_req</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dasd_eckd_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dasd_eckd_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
