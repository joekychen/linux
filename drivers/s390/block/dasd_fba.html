<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › block › dasd_fba.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dasd_fba.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * File...........: linux/drivers/s390/block/dasd_fba.c</span>
<span class="cm"> * Author(s)......: Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;</span>
<span class="cm"> * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;</span>
<span class="cm"> * Copyright IBM Corp. 1999, 2009</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;dasd-fba&quot;</span>

<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;asm/debug.h&gt;</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;	</span><span class="cm">/* HDIO_GETGEO			    */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cp">#include &lt;asm/idals.h&gt;</span>
<span class="cp">#include &lt;asm/ebcdic.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/ccwdev.h&gt;</span>

<span class="cp">#include &quot;dasd_int.h&quot;</span>
<span class="cp">#include &quot;dasd_fba.h&quot;</span>

<span class="cp">#ifdef PRINTK_HEADER</span>
<span class="cp">#undef PRINTK_HEADER</span>
<span class="cp">#endif				</span><span class="cm">/* PRINTK_HEADER */</span><span class="cp"></span>
<span class="cp">#define PRINTK_HEADER &quot;dasd(fba):&quot;</span>

<span class="cp">#define DASD_FBA_CCW_WRITE 0x41</span>
<span class="cp">#define DASD_FBA_CCW_READ 0x42</span>
<span class="cp">#define DASD_FBA_CCW_LOCATE 0x43</span>
<span class="cp">#define DASD_FBA_CCW_DEFINE_EXTENT 0x63</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_discipline</span> <span class="n">dasd_fba_discipline</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dasd_fba_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_fba_characteristics</span> <span class="n">rdc_data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_device_id</span> <span class="n">dasd_fba_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span> <span class="p">(</span><span class="mh">0x6310</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x9336</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span> <span class="p">(</span><span class="mh">0x3880</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3370</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* end of list */</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">dasd_fba_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_driver</span> <span class="n">dasd_fba_driver</span><span class="p">;</span> <span class="cm">/* see below */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_fba_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dasd_generic_probe</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dasd_fba_discipline</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_fba_set_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dasd_generic_set_online</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dasd_fba_discipline</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_driver</span> <span class="n">dasd_fba_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;dasd-fba&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ids</span>         <span class="o">=</span> <span class="n">dasd_fba_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>       <span class="o">=</span> <span class="n">dasd_fba_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>      <span class="o">=</span> <span class="n">dasd_generic_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_offline</span> <span class="o">=</span> <span class="n">dasd_generic_set_offline</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_online</span>  <span class="o">=</span> <span class="n">dasd_fba_set_online</span><span class="p">,</span>
	<span class="p">.</span><span class="n">notify</span>      <span class="o">=</span> <span class="n">dasd_generic_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">path_event</span>  <span class="o">=</span> <span class="n">dasd_generic_path_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span>      <span class="o">=</span> <span class="n">dasd_generic_pm_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span>	     <span class="o">=</span> <span class="n">dasd_generic_restore_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span>     <span class="o">=</span> <span class="n">dasd_generic_restore_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">int_class</span>   <span class="o">=</span> <span class="n">IOINT_DAS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">define_extent</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span> <span class="n">ccw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DE_fba_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">,</span>
	      <span class="kt">int</span> <span class="n">blksize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">beg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_FBA_CCW_DEFINE_EXTENT</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">DE_fba_data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">).</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
		<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">).</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">.</span><span class="n">perm</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">blk_size</span> <span class="o">=</span> <span class="n">blksize</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">ext_loc</span> <span class="o">=</span> <span class="n">beg</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">ext_end</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">locate_record</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span> <span class="n">ccw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">LO_fba_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">,</span>
	      <span class="kt">int</span> <span class="n">block_nr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block_ct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">DASD_FBA_CCW_LOCATE</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">LO_fba_data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">blk_nr</span> <span class="o">=</span> <span class="n">block_nr</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">blk_ct</span> <span class="o">=</span> <span class="n">block_ct</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_fba_check_characteristics</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_fba_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">readonly</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_fba_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">private</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">private</span><span class="p">),</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Allocating memory for private DASD &quot;</span>
				 <span class="s">&quot;data failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">private</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">private</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">private</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">dasd_alloc_block</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">block</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;could not allocate &quot;</span>
				<span class="s">&quot;dasd block structure&quot;</span><span class="p">);</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">private</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
	<span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>

	<span class="cm">/* Read Device Characteristics */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_generic_read_dev_chars</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">DASD_FBA_MAGIC</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EVENT_DEVID</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;Read device &quot;</span>
				<span class="s">&quot;characteristics returned error %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dasd_free_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">private</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">default_expires</span> <span class="o">=</span> <span class="n">DASD_EXPIRES</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">path_data</span><span class="p">.</span><span class="n">opm</span> <span class="o">=</span> <span class="n">LPM_ANYPATH</span><span class="p">;</span>

	<span class="n">readonly</span> <span class="o">=</span> <span class="n">dasd_device_is_ro</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readonly</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_FLAG_DEVICE_RO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;New FBA DASD %04X/%02X (CU %04X/%02X) with %d MB &quot;</span>
		 <span class="s">&quot;and %d B/blk%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">dev_type</span><span class="p">,</span>
		 <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">dev_model</span><span class="p">,</span>
		 <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">cu_type</span><span class="p">,</span>
		 <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">cu_model</span><span class="p">,</span>
		 <span class="p">((</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">blk_bdsa</span> <span class="o">*</span>
		   <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">blk_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">),</span>
		 <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">blk_size</span><span class="p">,</span>
		 <span class="n">readonly</span> <span class="o">?</span> <span class="s">&quot;, read-only device&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_fba_do_analysis</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_fba_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sb</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_fba_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dasd_check_blocksize</span><span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">blk_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="s">&quot;unknown blocksize %d&quot;</span><span class="p">,</span>
			    <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">blk_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">block</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">blk_bdsa</span><span class="p">;</span>
	<span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span> <span class="o">=</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">blk_size</span><span class="p">;</span>
	<span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* bits to shift 512 to get a block */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">sb</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="n">sb</span> <span class="o">&lt;</span> <span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">blk_size</span><span class="p">;</span> <span class="n">sb</span> <span class="o">=</span> <span class="n">sb</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasd_fba_fill_geometry</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dasd_check_blocksize</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">&lt;&lt;</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">&gt;&gt;</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dasd_erp_fn_t</span>
<span class="nf">dasd_fba_erp_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">cqr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dasd_default_erp_action</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dasd_erp_fn_t</span>
<span class="nf">dasd_fba_erp_postaction</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">cqr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">dasd_default_erp_action</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dasd_default_erp_postaction</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span><span class="p">,</span> <span class="s">&quot;unknown ERP action %p&quot;</span><span class="p">,</span>
		    <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_fba_check_for_device_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* first of all check for state change pending interrupt */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">DEV_STAT_ATTENTION</span> <span class="o">|</span> <span class="n">DEV_STAT_DEV_END</span> <span class="o">|</span> <span class="n">DEV_STAT_UNIT_EXCEP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span>
		<span class="n">dasd_generic_handle_state_change</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="nf">dasd_fba_build_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span> <span class="n">memdev</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">dasd_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_fba_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">idaws</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">LO_fba_data</span> <span class="o">*</span><span class="n">LO_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_iterator</span> <span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">cidaw</span><span class="p">,</span> <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">recid</span><span class="p">,</span> <span class="n">first_rec</span><span class="p">,</span> <span class="n">last_rec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_fba_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DASD_FBA_CCW_READ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DASD_FBA_CCW_WRITE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="n">blksize</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">;</span>
	<span class="cm">/* Calculate record id of first and last block. */</span>
	<span class="n">first_rec</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span><span class="p">;</span>
	<span class="n">last_rec</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span><span class="p">;</span>
	<span class="cm">/* Check struct bio and count the number of blocks for the request. */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cidaw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">blksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="cm">/* Fba can only do full blocks. */</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">s2b_shift</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_64BIT)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idal_is_needed</span> <span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">),</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">))</span>
			<span class="n">cidaw</span> <span class="o">+=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">/</span> <span class="n">blksize</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="cm">/* Paranoia. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">last_rec</span> <span class="o">-</span> <span class="n">first_rec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="cm">/* 1x define extent + 1x locate record + number of blocks */</span>
	<span class="n">cplength</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="cm">/* 1x define extent + 1x locate record */</span>
	<span class="n">datasize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_fba_data</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_fba_data</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">cidaw</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Find out number of additional locate record ccws if the device</span>
<span class="cm">	 * can&#39;t do data chaining.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">mode</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data_chain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cplength</span> <span class="o">+=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">datasize</span> <span class="o">+=</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">LO_fba_data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Allocate the ccw request. */</span>
	<span class="n">cqr</span> <span class="o">=</span> <span class="n">dasd_smalloc_request</span><span class="p">(</span><span class="n">DASD_FBA_MAGIC</span><span class="p">,</span> <span class="n">cplength</span><span class="p">,</span> <span class="n">datasize</span><span class="p">,</span> <span class="n">memdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cqr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="cm">/* First ccw is define extent. */</span>
	<span class="n">define_extent</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
		      <span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">,</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
	<span class="cm">/* Build locate_record + read/write ccws. */</span>
	<span class="n">idaws</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DE_fba_data</span><span class="p">));</span>
	<span class="n">LO_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">LO_fba_data</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">idaws</span> <span class="o">+</span> <span class="n">cidaw</span><span class="p">);</span>
	<span class="cm">/* Locate record for all blocks for smart devices. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">mode</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data_chain</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
		<span class="n">locate_record</span><span class="p">(</span><span class="n">ccw</span><span class="o">++</span><span class="p">,</span> <span class="n">LO_data</span><span class="o">++</span><span class="p">,</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">recid</span> <span class="o">=</span> <span class="n">first_rec</span><span class="p">;</span>
	<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dasd_page_cache</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">copy</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">dasd_page_cache</span><span class="p">,</span>
						      <span class="n">GFP_DMA</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&amp;&amp;</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">copy</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy</span><span class="p">)</span>
				<span class="n">dst</span> <span class="o">=</span> <span class="n">copy</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span> <span class="n">off</span> <span class="o">+=</span> <span class="n">blksize</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Locate record for stupid devices. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">mode</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data_chain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
				<span class="n">locate_record</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">LO_data</span><span class="o">++</span><span class="p">,</span>
					      <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
					      <span class="n">recid</span> <span class="o">-</span> <span class="n">first_rec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
				<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">recid</span> <span class="o">&gt;</span> <span class="n">first_rec</span><span class="p">)</span>
					<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_DC</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ccw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idal_is_needed</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">blksize</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">idaws</span><span class="p">;</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_IDA</span><span class="p">;</span>
				<span class="n">idaws</span> <span class="o">=</span> <span class="n">idal_create_words</span><span class="p">(</span><span class="n">idaws</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>
				<span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dst</span> <span class="o">+=</span> <span class="n">blksize</span><span class="p">;</span>
			<span class="n">recid</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk_noretry_request</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DASD_FEATURE_FAILFAST</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DASD_CQR_FLAGS_FAILFAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">startdev</span> <span class="o">=</span> <span class="n">memdev</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span> <span class="o">=</span> <span class="n">memdev</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">memdev</span><span class="o">-&gt;</span><span class="n">default_expires</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>	<span class="cm">/* default 5 minutes */</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">buildclk</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cqr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_fba_free_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dasd_fba_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_iterator</span> <span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">cda</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dasd_page_cache</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_fba_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">blksize</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bp_block</span><span class="p">;</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
	<span class="cm">/* Skip over define extent &amp; locate record. */</span>
	<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">mode</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data_chain</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span> <span class="n">off</span> <span class="o">+=</span> <span class="n">blksize</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Skip locate record. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">.</span><span class="n">mode</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data_chain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CCW_FLAG_IDA</span><span class="p">)</span>
					<span class="n">cda</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">**</span><span class="p">)((</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span><span class="p">));</span>
				<span class="k">else</span>
					<span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)((</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">ccw</span><span class="o">-&gt;</span><span class="n">cda</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dst</span> <span class="o">!=</span> <span class="n">cda</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
						<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">cda</span><span class="p">,</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">);</span>
					<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">dasd_page_cache</span><span class="p">,</span>
					    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="n">addr_t</span><span class="p">)</span><span class="n">cda</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ccw</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DASD_CQR_DONE</span><span class="p">;</span>
	<span class="n">dasd_sfree_request</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span> <span class="n">cqr</span><span class="o">-&gt;</span><span class="n">memdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dasd_fba_handle_terminated_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span><span class="n">cqr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cqr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DASD_CQR_FILLED</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dasd_fba_fill_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span> <span class="n">device</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">dasd_information2_t</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">label_block</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">FBA_layout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">DASD_FORMAT_LDL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">characteristics_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_fba_characteristics</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">characteristics</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">dasd_fba_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rdc_data</span><span class="p">,</span>
	       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dasd_fba_characteristics</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">confdata_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dasd_fba_dump_sense_dbf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">dasd_get_sense</span><span class="p">(</span><span class="n">irb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_EMERG</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
			      <span class="s">&quot;%s: %s %02x%02x%02x %016llx %016llx %016llx &quot;</span>
			      <span class="s">&quot;%016llx&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span>
			      <span class="n">scsw_is_tm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;t&quot;</span> <span class="o">:</span> <span class="s">&quot;c&quot;</span><span class="p">,</span>
			      <span class="n">scsw_cc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span> <span class="n">scsw_cstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span>
			      <span class="n">scsw_dstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span> <span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			      <span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_EMERG</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			      <span class="s">&quot;SORRY - NO VALID SENSE AVAILABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dasd_fba_dump_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">dasd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dasd_ccw_req</span> <span class="o">*</span> <span class="n">req</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">act</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">sct</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARNING</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="s">&quot;No memory to dump sense data&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
		      <span class="s">&quot; I/O status report for device %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
		       <span class="s">&quot; in req: %p CS: 0x%02X DS: 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
		       <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span><span class="p">,</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
		       <span class="s">&quot; device %s: Failing CCW: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cons</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">sl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sl</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">sl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
				       <span class="s">&quot; Sense(hex) %2d-%2d:&quot;</span><span class="p">,</span>
				       <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">sl</span><span class="p">),</span> <span class="p">((</span><span class="mi">8</span> <span class="o">*</span> <span class="n">sl</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">sct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sct</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">sct</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span>
					       <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">8</span> <span class="o">*</span> <span class="n">sl</span> <span class="o">+</span> <span class="n">sct</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	        <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; SORRY - NO VALID SENSE AVAILABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="cm">/* dump the Channel Program */</span>
	<span class="cm">/* print first CCWs (maximum 8) */</span>
	<span class="n">act</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">last</span> <span class="o">=</span> <span class="n">act</span><span class="p">;</span> <span class="n">last</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CCW_FLAG_CC</span> <span class="o">|</span> <span class="n">CCW_FLAG_DC</span><span class="p">);</span> <span class="n">last</span><span class="o">++</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">act</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
		      <span class="s">&quot; Related CP in req: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">act</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; CCW %p: %08X %08X DAT:&quot;</span><span class="p">,</span>
			       <span class="n">act</span><span class="p">,</span> <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">act</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">act</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		     <span class="n">count</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; %08X&quot;</span><span class="p">,</span>
				       <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">cda</span><span class="p">)</span>
				       <span class="p">[(</span><span class="n">count</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)]);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">act</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>


	<span class="cm">/* print failing CCW area */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">&lt;</span>  <span class="p">((</span><span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">act</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span> <span class="s">&quot;......</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">act</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; CCW %p: %08X %08X DAT:&quot;</span><span class="p">,</span>
			       <span class="n">act</span><span class="p">,</span> <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">act</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">act</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		     <span class="n">count</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; %08X&quot;</span><span class="p">,</span>
				       <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">cda</span><span class="p">)</span>
				       <span class="p">[(</span><span class="n">count</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)]);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">act</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* print last CCWs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">&lt;</span>  <span class="n">last</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">act</span> <span class="o">=</span> <span class="n">last</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span> <span class="s">&quot;......</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">act</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="n">PRINTK_HEADER</span>
			       <span class="s">&quot; CCW %p: %08X %08X DAT:&quot;</span><span class="p">,</span>
			       <span class="n">act</span><span class="p">,</span> <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">act</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">act</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		     <span class="n">count</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; %08X&quot;</span><span class="p">,</span>
				       <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">cda</span><span class="p">)</span>
				       <span class="p">[(</span><span class="n">count</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)]);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">act</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * max_blocks is dependent on the amount of storage that is available</span>
<span class="cm"> * in the static io buffer for each device. Currently each device has</span>
<span class="cm"> * 8192 bytes (=2 pages). For 64 bit one dasd_mchunkt_t structure has</span>
<span class="cm"> * 24 bytes, the struct dasd_ccw_req has 136 bytes and each block can use</span>
<span class="cm"> * up to 16 bytes (8 for the ccw and 8 for the idal pointer). In</span>
<span class="cm"> * addition we have one define extent ccw + 16 bytes of data and a</span>
<span class="cm"> * locate record ccw for each block (stupid devices!) + 16 bytes of data.</span>
<span class="cm"> * That makes:</span>
<span class="cm"> * (8192 - 24 - 136 - 8 - 16) / 40 = 200.2 blocks at maximum.</span>
<span class="cm"> * We want to fit two into the available memory so that we can immediately</span>
<span class="cm"> * start the next request if one finishes off. That makes 100.1 blocks</span>
<span class="cm"> * for one request. Give a little safety and the result is 96.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dasd_discipline</span> <span class="n">dasd_fba_discipline</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;FBA &quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ebcname</span> <span class="o">=</span> <span class="s">&quot;FBA &quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_blocks</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_device</span> <span class="o">=</span> <span class="n">dasd_fba_check_characteristics</span><span class="p">,</span>
	<span class="p">.</span><span class="n">do_analysis</span> <span class="o">=</span> <span class="n">dasd_fba_do_analysis</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_path</span> <span class="o">=</span> <span class="n">dasd_generic_verify_path</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fill_geometry</span> <span class="o">=</span> <span class="n">dasd_fba_fill_geometry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_IO</span> <span class="o">=</span> <span class="n">dasd_start_IO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">term_IO</span> <span class="o">=</span> <span class="n">dasd_term_IO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_terminated_request</span> <span class="o">=</span> <span class="n">dasd_fba_handle_terminated_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">erp_action</span> <span class="o">=</span> <span class="n">dasd_fba_erp_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">erp_postaction</span> <span class="o">=</span> <span class="n">dasd_fba_erp_postaction</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_for_device_change</span> <span class="o">=</span> <span class="n">dasd_fba_check_for_device_change</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_cp</span> <span class="o">=</span> <span class="n">dasd_fba_build_cp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_cp</span> <span class="o">=</span> <span class="n">dasd_fba_free_cp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_sense</span> <span class="o">=</span> <span class="n">dasd_fba_dump_sense</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_sense_dbf</span> <span class="o">=</span> <span class="n">dasd_fba_dump_sense_dbf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fill_info</span> <span class="o">=</span> <span class="n">dasd_fba_fill_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">dasd_fba_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ASCEBC</span><span class="p">(</span><span class="n">dasd_fba_discipline</span><span class="p">.</span><span class="n">ebcname</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccw_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_fba_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">wait_for_device_probe</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">dasd_fba_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccw_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dasd_fba_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dasd_fba_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dasd_fba_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
