<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › cio › io_sch.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>io_sch.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef S390_IO_SCH_H</span>
<span class="cp">#define S390_IO_SCH_H</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;asm/schid.h&gt;</span>
<span class="cp">#include &lt;asm/ccwdev.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &quot;css.h&quot;</span>
<span class="cp">#include &quot;orb.h&quot;</span>

<span class="k">struct</span> <span class="n">io_subchannel_private</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">orb</span> <span class="n">orb</span><span class="p">;</span>		<span class="cm">/* operation request block */</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="n">sense_ccw</span><span class="p">;</span>	<span class="cm">/* static ccw for sense command */</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">;</span><span class="cm">/* pointer to the child ccw device */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">suspend</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* allow suspend */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">prefetch</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="cm">/* deny prefetch */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inter</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* suppress intermediate interrupts */</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="n">options</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>

<span class="cp">#define to_io_private(n) ((struct io_subchannel_private *) \</span>
<span class="cp">			  dev_get_drvdata(&amp;(n)-&gt;dev))</span>
<span class="cp">#define set_io_private(n, p) (dev_set_drvdata(&amp;(n)-&gt;dev, p))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="nf">sch_get_cdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_subchannel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_io_private</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">priv</span> <span class="o">?</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sch_set_cdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_subchannel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_io_private</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_CIWS 8</span>

<span class="cm">/*</span>
<span class="cm"> * Possible status values for a CCW request&#39;s I/O.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">io_status</span> <span class="p">{</span>
	<span class="n">IO_DONE</span><span class="p">,</span>
	<span class="n">IO_RUNNING</span><span class="p">,</span>
	<span class="n">IO_STATUS_ERROR</span><span class="p">,</span>
	<span class="n">IO_PATH_ERROR</span><span class="p">,</span>
	<span class="n">IO_REJECTED</span><span class="p">,</span>
	<span class="n">IO_KILLED</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ccw_request - Internal CCW request.</span>
<span class="cm"> * @cp: channel program to start</span>
<span class="cm"> * @timeout: maximum allowable time in jiffies between start I/O and interrupt</span>
<span class="cm"> * @maxretries: number of retries per I/O operation and path</span>
<span class="cm"> * @lpm: mask of paths to use</span>
<span class="cm"> * @check: optional callback that determines if results are final</span>
<span class="cm"> * @filter: optional callback to adjust request status based on IRB data</span>
<span class="cm"> * @callback: final callback</span>
<span class="cm"> * @data: user-defined pointer passed to all callbacks</span>
<span class="cm"> * @singlepath: if set, use only one path from @lpm per start I/O</span>
<span class="cm"> * @cancel: non-zero if request was cancelled</span>
<span class="cm"> * @done: non-zero if request was finished</span>
<span class="cm"> * @mask: current path mask</span>
<span class="cm"> * @retries: current number of retries</span>
<span class="cm"> * @drc: delayed return code</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ccw_request</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">maxretries</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lpm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">check</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">io_status</span> <span class="p">(</span><span class="o">*</span><span class="n">filter</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">io_status</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">singlepath</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* These fields are used internally. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cancel</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">done</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">retries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drc</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * sense-id response buffer layout</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">senseid</span> <span class="p">{</span>
	<span class="cm">/* common part */</span>
	<span class="n">u8</span>  <span class="n">reserved</span><span class="p">;</span>	<span class="cm">/* always 0x&#39;FF&#39; */</span>
	<span class="n">u16</span> <span class="n">cu_type</span><span class="p">;</span>	<span class="cm">/* control unit type */</span>
	<span class="n">u8</span>  <span class="n">cu_model</span><span class="p">;</span>	<span class="cm">/* control unit model */</span>
	<span class="n">u16</span> <span class="n">dev_type</span><span class="p">;</span>	<span class="cm">/* device type */</span>
	<span class="n">u8</span>  <span class="n">dev_model</span><span class="p">;</span>	<span class="cm">/* device model */</span>
	<span class="n">u8</span>  <span class="n">unused</span><span class="p">;</span>	<span class="cm">/* padding byte */</span>
	<span class="cm">/* extended part */</span>
	<span class="k">struct</span> <span class="n">ciw</span> <span class="n">ciw</span><span class="p">[</span><span class="n">MAX_CIWS</span><span class="p">];</span>	<span class="cm">/* variable # of CIWs */</span>
<span class="p">}</span>  <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">,</span> <span class="n">aligned</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>

<span class="k">enum</span> <span class="n">cdev_todo</span> <span class="p">{</span>
	<span class="n">CDEV_TODO_NOTHING</span><span class="p">,</span>
	<span class="n">CDEV_TODO_ENABLE_CMF</span><span class="p">,</span>
	<span class="n">CDEV_TODO_REBIND</span><span class="p">,</span>
	<span class="n">CDEV_TODO_REGISTER</span><span class="p">,</span>
	<span class="n">CDEV_TODO_UNREG</span><span class="p">,</span>
	<span class="n">CDEV_TODO_UNREG_EVAL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define FAKE_CMD_IRB	1</span>
<span class="cp">#define FAKE_TM_IRB	2</span>

<span class="k">struct</span> <span class="n">ccw_device_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>		<span class="cm">/* device state */</span>
	<span class="n">atomic_t</span> <span class="n">onoff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="n">dev_id</span><span class="p">;</span>	<span class="cm">/* device id */</span>
	<span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">;</span>	<span class="cm">/* subchannel number */</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="n">req</span><span class="p">;</span>		<span class="cm">/* internal I/O request */</span>
	<span class="kt">int</span> <span class="n">iretry</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pgid_valid_mask</span><span class="p">;</span>	<span class="cm">/* mask of valid PGIDs */</span>
	<span class="n">u8</span> <span class="n">pgid_todo_mask</span><span class="p">;</span>	<span class="cm">/* mask of PGIDs to be adjusted */</span>
	<span class="n">u8</span> <span class="n">pgid_reset_mask</span><span class="p">;</span>	<span class="cm">/* mask of PGIDs which were reset */</span>
	<span class="n">u8</span> <span class="n">path_gone_mask</span><span class="p">;</span>	<span class="cm">/* mask of paths, that became unavailable */</span>
	<span class="n">u8</span> <span class="n">path_new_mask</span><span class="p">;</span>	<span class="cm">/* mask of paths, that became available */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fast</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* post with &quot;channel end&quot; */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">repall</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* report every interrupt status */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pgroup</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* do path grouping */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">force</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* allow forced online */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mpath</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* do multipathing */</span>
	<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">options</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">esid</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Ext. SenseID supported by HW */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dosense</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* delayed SENSE required */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">doverify</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>    <span class="cm">/* delayed path verification */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">donotify</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>    <span class="cm">/* call notify function */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recog_done</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>  <span class="cm">/* dev. recog. complete */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fake_irb</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>    <span class="cm">/* deliver faked irb */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">resuming</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>    <span class="cm">/* recognition while resume */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pgroup</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* pathgroup is set up */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mpath</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* multipathing is set up */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">initialized</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* set if initial reference held */</span>
	<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">intparm</span><span class="p">;</span>	<span class="cm">/* user interruption parameter */</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">qdio_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irb</span> <span class="n">irb</span><span class="p">;</span>		<span class="cm">/* device status */</span>
	<span class="k">struct</span> <span class="n">senseid</span> <span class="n">senseid</span><span class="p">;</span>	<span class="cm">/* SenseID info */</span>
	<span class="k">struct</span> <span class="n">pgid</span> <span class="n">pgid</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* path group IDs per chpid*/</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="n">iccws</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* ccws for SNID/SID/SPGID commands */</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">todo_work</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">cdev_todo</span> <span class="n">todo</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cmb</span><span class="p">;</span>			<span class="cm">/* measurement information */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">cmb_list</span><span class="p">;</span>	<span class="cm">/* list of measured devices */</span>
	<span class="n">u64</span> <span class="n">cmb_start_time</span><span class="p">;</span>		<span class="cm">/* clock value of cmb reset */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cmb_wait</span><span class="p">;</span>			<span class="cm">/* deferred cmb enable/disable */</span>
	<span class="k">enum</span> <span class="n">interruption_class</span> <span class="n">int_class</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rsch</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">reg1</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">schid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccode</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	rsch</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	ipm	%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	srl	%0,28&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">ccode</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">reg1</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ccode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hsch</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">reg1</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">schid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccode</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	hsch</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	ipm	%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	srl	%0,28&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">ccode</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">reg1</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ccode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xsch</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">reg1</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">schid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccode</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	.insn	rre,0xb2760000,%1,0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	ipm	%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	srl	%0,28&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">ccode</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">reg1</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ccode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
