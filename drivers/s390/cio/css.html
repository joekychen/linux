<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › cio › css.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>css.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * driver for channel subsystem</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright IBM Corp. 2002, 2010</span>
<span class="cm"> *</span>
<span class="cm"> * Author(s): Arnd Bergmann (arndb@de.ibm.com)</span>
<span class="cm"> *	      Cornelia Huck (cornelia.huck@de.ibm.com)</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;cio&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/suspend.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;asm/isc.h&gt;</span>
<span class="cp">#include &lt;asm/crw.h&gt;</span>

<span class="cp">#include &quot;css.h&quot;</span>
<span class="cp">#include &quot;cio.h&quot;</span>
<span class="cp">#include &quot;cio_debug.h&quot;</span>
<span class="cp">#include &quot;ioasm.h&quot;</span>
<span class="cp">#include &quot;chsc.h&quot;</span>
<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;idset.h&quot;</span>
<span class="cp">#include &quot;chp.h&quot;</span>

<span class="kt">int</span> <span class="n">css_init_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">max_ssid</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">channel_subsystem</span> <span class="o">*</span><span class="n">channel_subsystems</span><span class="p">[</span><span class="n">__MAX_CSSID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">css_bus_type</span><span class="p">;</span>

<span class="kt">int</span>
<span class="nf">for_each_subchannel</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">subchannel_id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_subchannel_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schid</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">__MAX_SUBCHANNEL</span><span class="p">);</span>
		<span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">max_ssid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cb_data</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idset</span> <span class="o">*</span><span class="n">set</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn_known_sch</span><span class="p">)(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn_unknown_sch</span><span class="p">)(</span><span class="k">struct</span> <span class="n">subchannel_id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">call_fn_known_sch</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cb_data</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">idset_sch_del</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">fn_known_sch</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">fn_known_sch</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">call_fn_unknown_sch</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cb_data</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idset_sch_contains</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">,</span> <span class="n">schid</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">fn_unknown_sch</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">call_fn_all_sch</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cb_data</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">get_subchannel_by_schid</span><span class="p">(</span><span class="n">schid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">fn_known_sch</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">fn_known_sch</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">fn_unknown_sch</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">fn_unknown_sch</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">for_each_subchannel_staged</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn_known</span><span class="p">)(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
			       <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn_unknown</span><span class="p">)(</span><span class="k">struct</span> <span class="n">subchannel_id</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cb_data</span> <span class="n">cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cb</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">cb</span><span class="p">.</span><span class="n">fn_known_sch</span> <span class="o">=</span> <span class="n">fn_known</span><span class="p">;</span>
	<span class="n">cb</span><span class="p">.</span><span class="n">fn_unknown_sch</span> <span class="o">=</span> <span class="n">fn_unknown</span><span class="p">;</span>

	<span class="n">cb</span><span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">idset_sch_new</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb</span><span class="p">.</span><span class="n">set</span><span class="p">)</span>
		<span class="cm">/* fall back to brute force scanning in case of oom */</span>
		<span class="k">return</span> <span class="n">for_each_subchannel</span><span class="p">(</span><span class="n">call_fn_all_sch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cb</span><span class="p">);</span>

	<span class="n">idset_fill</span><span class="p">(</span><span class="n">cb</span><span class="p">.</span><span class="n">set</span><span class="p">);</span>

	<span class="cm">/* Process registered subchannels. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bus_for_each_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span> <span class="n">call_fn_known_sch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* Process unregistered subchannels. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fn_unknown</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">for_each_subchannel</span><span class="p">(</span><span class="n">call_fn_unknown_sch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">idset_free</span><span class="p">(</span><span class="n">cb</span><span class="p">.</span><span class="n">set</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">css_sch_todo</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span>
<span class="nf">css_alloc_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">sch</span><span class="p">),</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cio_validate_subchannel</span> <span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">schid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">todo_work</span><span class="p">,</span> <span class="n">css_sch_todo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sch</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">css_subchannel_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cio_is_console</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Reset intparm to zeroes. */</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intparm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cio_commit_config</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_sch_device_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;0.%x.%04x&quot;</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
		     <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * css_sch_device_unregister - unregister a subchannel</span>
<span class="cm"> * @sch: subchannel to be unregistered</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">css_sch_device_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_is_registered</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">css_sch_device_unregister</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssd_from_pmcw</span><span class="p">(</span><span class="k">struct</span> <span class="n">chsc_ssd_info</span> <span class="o">*</span><span class="n">ssd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmcw</span> <span class="o">*</span><span class="n">pmcw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ssd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chsc_ssd_info</span><span class="p">));</span>
	<span class="n">ssd</span><span class="o">-&gt;</span><span class="n">path_mask</span> <span class="o">=</span> <span class="n">pmcw</span><span class="o">-&gt;</span><span class="n">pim</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmcw</span><span class="o">-&gt;</span><span class="n">pim</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chp_id_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">chpid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">ssd</span><span class="o">-&gt;</span><span class="n">chpid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">pmcw</span><span class="o">-&gt;</span><span class="n">chpid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssd_register_chpids</span><span class="p">(</span><span class="k">struct</span> <span class="n">chsc_ssd_info</span> <span class="o">*</span><span class="n">ssd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">path_mask</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chp_is_registered</span><span class="p">(</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">chpid</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="n">chp_new</span><span class="p">(</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">chpid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">css_update_ssd_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cio_is_console</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Console is initialized too early for functions requiring</span>
<span class="cm">		 * memory allocation. */</span>
		<span class="n">ssd_from_pmcw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">ssd_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">chsc_get_ssd_info</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">ssd_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ssd_from_pmcw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">ssd_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">);</span>
		<span class="n">ssd_register_chpids</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">ssd_info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">type_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%01x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">type_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">modalias_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;css:t%01X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">modalias</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">modalias_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">subch_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_type</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_modalias</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">subch_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">subch_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">default_subch_attr_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">subch_attr_group</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_register_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Initialize the subchannel structure */</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">channel_subsystems</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">css_bus_type</span><span class="p">;</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">css_subchannel_release</span><span class="p">;</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">default_subch_attr_groups</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t want to generate uevents for I/O subchannels that don&#39;t</span>
<span class="cm">	 * have a working ccw device behind them since they will be</span>
<span class="cm">	 * unregistered before they can be used anyway, so we delay the add</span>
<span class="cm">	 * uevent until after device recognition was successful.</span>
<span class="cm">	 * Note that we suppress the uevent for all subchannel types;</span>
<span class="cm">	 * the subchannel driver can decide itself when it wants to inform</span>
<span class="cm">	 * userspace of its existence.</span>
<span class="cm">	 */</span>
	<span class="n">dev_set_uevent_suppress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">css_update_ssd_info</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="cm">/* make it known to the system */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">css_sch_device_register</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Could not register sch 0.%x.%04x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No driver matched. Generate the uevent now so that</span>
<span class="cm">		 * a fitting driver module may be loaded based on the</span>
<span class="cm">		 * modalias.</span>
<span class="cm">		 */</span>
		<span class="n">dev_set_uevent_suppress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">css_probe_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cio_is_console</span><span class="p">(</span><span class="n">schid</span><span class="p">))</span>
		<span class="n">sch</span> <span class="o">=</span> <span class="n">cio_get_console_subchannel</span><span class="p">();</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">sch</span> <span class="o">=</span> <span class="n">css_alloc_subchannel</span><span class="p">(</span><span class="n">schid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">css_register_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cio_is_console</span><span class="p">(</span><span class="n">schid</span><span class="p">))</span>
			<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">check_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">subchannel_id</span> <span class="o">*</span><span class="n">schid</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">schid_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="n">schid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span>
<span class="nf">get_subchannel_by_schid</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">bus_find_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">schid</span><span class="p">,</span> <span class="n">check_subchannel</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span> <span class="o">?</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * css_sch_is_valid() - check if a subchannel is valid</span>
<span class="cm"> * @schib: subchannel information block for the subchannel</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">css_sch_is_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">schib</span> <span class="o">*</span><span class="n">schib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">st</span> <span class="o">==</span> <span class="n">SUBCHANNEL_TYPE_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">dnv</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">st</span> <span class="o">==</span> <span class="n">SUBCHANNEL_TYPE_MSG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">css_sch_is_valid</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_evaluate_new_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">schib</span> <span class="n">schib</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slow</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Will be done on the slow path. */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stsch_err</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">css_sch_is_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schib</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Unusable - ignore. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;event: sch 0.%x.%04x, new</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
		      <span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">css_probe_device</span><span class="p">(</span><span class="n">schid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_evaluate_known_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">sch_event</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">sch_event</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">slow</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Got subchannel machine check but &quot;</span>
				<span class="s">&quot;no sch_event handler provided.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;eval: sch 0.%x.%04x, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">css_evaluate_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">get_subchannel_by_schid</span><span class="p">(</span><span class="n">schid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">css_evaluate_known_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">slow</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">css_evaluate_new_subchannel</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="n">slow</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">css_schedule_eval</span><span class="p">(</span><span class="n">schid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * css_sched_sch_todo - schedule a subchannel operation</span>
<span class="cm"> * @sch: subchannel</span>
<span class="cm"> * @todo: todo</span>
<span class="cm"> *</span>
<span class="cm"> * Schedule the operation identified by @todo to be performed on the slow path</span>
<span class="cm"> * workqueue. Do nothing if another operation with higher priority is already</span>
<span class="cm"> * scheduled. Needs to be called with subchannel lock held.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">css_sched_sch_todo</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="k">enum</span> <span class="n">sch_todo</span> <span class="n">todo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;sch_todo: sched sch=0.%x.%04x todo=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">,</span> <span class="n">todo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">todo</span> <span class="o">&gt;=</span> <span class="n">todo</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Get workqueue ref. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">todo</span> <span class="o">=</span> <span class="n">todo</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_work</span><span class="p">(</span><span class="n">cio_work_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">todo_work</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Already queued, release workqueue ref. */</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">css_sch_todo</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sch_todo</span> <span class="n">todo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">subchannel</span><span class="p">,</span> <span class="n">todo_work</span><span class="p">);</span>
	<span class="cm">/* Find out todo. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">todo</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">;</span>
	<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;sch_todo: sch=0.%x.%04x, todo=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
		      <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">,</span> <span class="n">todo</span><span class="p">);</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">todo</span> <span class="o">=</span> <span class="n">SCH_TODO_NOTHING</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* Perform todo. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">todo</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCH_TODO_NOTHING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCH_TODO_EVAL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">css_evaluate_known_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">css_sched_sch_todo</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">todo</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCH_TODO_UNREG</span>:
		<span class="n">css_sch_device_unregister</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Release workqueue ref. */</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">idset</span> <span class="o">*</span><span class="n">slow_subchannel_set</span><span class="p">;</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">slow_subchannel_lock</span><span class="p">;</span>
<span class="k">static</span> <span class="n">wait_queue_head_t</span> <span class="n">css_eval_wq</span><span class="p">;</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">css_eval_scheduled</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">slow_subchannel_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_eval_scheduled</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_eval_wq</span><span class="p">);</span>
	<span class="n">slow_subchannel_set</span> <span class="o">=</span> <span class="n">idset_sch_new</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slow_subchannel_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;could not allocate slow subchannel set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slow_eval_known_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">eval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">);</span>
	<span class="n">eval</span> <span class="o">=</span> <span class="n">idset_sch_contains</span><span class="p">(</span><span class="n">slow_subchannel_set</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>
	<span class="n">idset_sch_del</span><span class="p">(</span><span class="n">slow_subchannel_set</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">css_evaluate_known_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
			<span class="n">css_schedule_eval</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slow_eval_unknown_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">eval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">);</span>
	<span class="n">eval</span> <span class="o">=</span> <span class="n">idset_sch_contains</span><span class="p">(</span><span class="n">slow_subchannel_set</span><span class="p">,</span> <span class="n">schid</span><span class="p">);</span>
	<span class="n">idset_sch_del</span><span class="p">(</span><span class="n">slow_subchannel_set</span><span class="p">,</span> <span class="n">schid</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">css_evaluate_new_subchannel</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:
			<span class="n">css_schedule_eval</span><span class="p">(</span><span class="n">schid</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">ENXIO</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>:
			<span class="cm">/* These should abort looping */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">css_slow_path_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;slowpath&quot;</span><span class="p">);</span>
	<span class="n">for_each_subchannel_staged</span><span class="p">(</span><span class="n">slow_eval_known_fn</span><span class="p">,</span> <span class="n">slow_eval_unknown_fn</span><span class="p">,</span>
				   <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idset_is_empty</span><span class="p">(</span><span class="n">slow_subchannel_set</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_eval_scheduled</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_eval_wq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">slow_path_work</span><span class="p">,</span> <span class="n">css_slow_path_func</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">cio_work_q</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">css_schedule_eval</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">idset_sch_add</span><span class="p">(</span><span class="n">slow_subchannel_set</span><span class="p">,</span> <span class="n">schid</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_eval_scheduled</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">cio_work_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slow_path_work</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">css_schedule_eval_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">idset_fill</span><span class="p">(</span><span class="n">slow_subchannel_set</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_eval_scheduled</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">cio_work_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slow_path_work</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__unset_registered</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idset</span> <span class="o">*</span><span class="n">set</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">idset_sch_del</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">css_schedule_eval_all_unreg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idset</span> <span class="o">*</span><span class="n">unreg_set</span><span class="p">;</span>

	<span class="cm">/* Find unregistered subchannels. */</span>
	<span class="n">unreg_set</span> <span class="o">=</span> <span class="n">idset_sch_new</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unreg_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fallback. */</span>
		<span class="n">css_schedule_eval_all</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idset_fill</span><span class="p">(</span><span class="n">unreg_set</span><span class="p">);</span>
	<span class="n">bus_for_each_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">unreg_set</span><span class="p">,</span> <span class="n">__unset_registered</span><span class="p">);</span>
	<span class="cm">/* Apply to slow_subchannel_set. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">idset_add_set</span><span class="p">(</span><span class="n">slow_subchannel_set</span><span class="p">,</span> <span class="n">unreg_set</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_eval_scheduled</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">cio_work_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slow_path_work</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slow_subchannel_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">idset_free</span><span class="p">(</span><span class="n">unreg_set</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">css_wait_for_slow_path</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">cio_work_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Schedule reprobing of all unregistered subchannels. */</span>
<span class="kt">void</span> <span class="nf">css_schedule_reprobe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">css_schedule_eval_all_unreg</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">css_schedule_reprobe</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Called from the machine check handler for subchannel report words.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">css_process_crw</span><span class="p">(</span><span class="k">struct</span> <span class="n">crw</span> <span class="o">*</span><span class="n">crw0</span><span class="p">,</span> <span class="k">struct</span> <span class="n">crw</span> <span class="o">*</span><span class="n">crw1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">overflow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">mchk_schid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overflow</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">css_schedule_eval_all</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CIO_CRW_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;CRW0 reports slct=%d, oflw=%d, &quot;</span>
		      <span class="s">&quot;chn=%d, rsc=%X, anc=%d, erc=%X, rsid=%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">crw0</span><span class="o">-&gt;</span><span class="n">slct</span><span class="p">,</span> <span class="n">crw0</span><span class="o">-&gt;</span><span class="n">oflw</span><span class="p">,</span> <span class="n">crw0</span><span class="o">-&gt;</span><span class="n">chn</span><span class="p">,</span> <span class="n">crw0</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">,</span> <span class="n">crw0</span><span class="o">-&gt;</span><span class="n">anc</span><span class="p">,</span>
		      <span class="n">crw0</span><span class="o">-&gt;</span><span class="n">erc</span><span class="p">,</span> <span class="n">crw0</span><span class="o">-&gt;</span><span class="n">rsid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crw1</span><span class="p">)</span>
		<span class="n">CIO_CRW_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;CRW1 reports slct=%d, oflw=%d, &quot;</span>
			      <span class="s">&quot;chn=%d, rsc=%X, anc=%d, erc=%X, rsid=%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">crw1</span><span class="o">-&gt;</span><span class="n">slct</span><span class="p">,</span> <span class="n">crw1</span><span class="o">-&gt;</span><span class="n">oflw</span><span class="p">,</span> <span class="n">crw1</span><span class="o">-&gt;</span><span class="n">chn</span><span class="p">,</span> <span class="n">crw1</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">,</span>
			      <span class="n">crw1</span><span class="o">-&gt;</span><span class="n">anc</span><span class="p">,</span> <span class="n">crw1</span><span class="o">-&gt;</span><span class="n">erc</span><span class="p">,</span> <span class="n">crw1</span><span class="o">-&gt;</span><span class="n">rsid</span><span class="p">);</span>
	<span class="n">init_subchannel_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchk_schid</span><span class="p">);</span>
	<span class="n">mchk_schid</span><span class="p">.</span><span class="n">sch_no</span> <span class="o">=</span> <span class="n">crw0</span><span class="o">-&gt;</span><span class="n">rsid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crw1</span><span class="p">)</span>
		<span class="n">mchk_schid</span><span class="p">.</span><span class="n">ssid</span> <span class="o">=</span> <span class="p">(</span><span class="n">crw1</span><span class="o">-&gt;</span><span class="n">rsid</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crw0</span><span class="o">-&gt;</span><span class="n">erc</span> <span class="o">==</span> <span class="n">CRW_ERC_PMOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sch</span> <span class="o">=</span> <span class="n">get_subchannel_by_schid</span><span class="p">(</span><span class="n">mchk_schid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">css_update_ssd_info</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
			<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Since we are always presented with IPI in the CRW, we have to</span>
<span class="cm">	 * use stsch() to find out if the subchannel in question has come</span>
<span class="cm">	 * or gone.</span>
<span class="cm">	 */</span>
	<span class="n">css_evaluate_subchannel</span><span class="p">(</span><span class="n">mchk_schid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">css_generate_pgid</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel_subsystem</span> <span class="o">*</span><span class="n">css</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tod_high</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpuid</span> <span class="n">cpu_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">css_general_characteristics</span><span class="p">.</span><span class="n">mcss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">css</span><span class="o">-&gt;</span><span class="n">global_pgid</span><span class="p">.</span><span class="n">pgid_high</span><span class="p">.</span><span class="n">ext_cssid</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">css</span><span class="o">-&gt;</span><span class="n">global_pgid</span><span class="p">.</span><span class="n">pgid_high</span><span class="p">.</span><span class="n">ext_cssid</span><span class="p">.</span><span class="n">cssid</span> <span class="o">=</span> <span class="n">css</span><span class="o">-&gt;</span><span class="n">cssid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SMP</span>
		<span class="n">css</span><span class="o">-&gt;</span><span class="n">global_pgid</span><span class="p">.</span><span class="n">pgid_high</span><span class="p">.</span><span class="n">cpu_addr</span> <span class="o">=</span> <span class="n">stap</span><span class="p">();</span>
<span class="cp">#else</span>
		<span class="n">css</span><span class="o">-&gt;</span><span class="n">global_pgid</span><span class="p">.</span><span class="n">pgid_high</span><span class="p">.</span><span class="n">cpu_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">get_cpu_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_id</span><span class="p">);</span>
	<span class="n">css</span><span class="o">-&gt;</span><span class="n">global_pgid</span><span class="p">.</span><span class="n">cpu_id</span> <span class="o">=</span> <span class="n">cpu_id</span><span class="p">.</span><span class="n">ident</span><span class="p">;</span>
	<span class="n">css</span><span class="o">-&gt;</span><span class="n">global_pgid</span><span class="p">.</span><span class="n">cpu_model</span> <span class="o">=</span> <span class="n">cpu_id</span><span class="p">.</span><span class="n">machine</span><span class="p">;</span>
	<span class="n">css</span><span class="o">-&gt;</span><span class="n">global_pgid</span><span class="p">.</span><span class="n">tod_high</span> <span class="o">=</span> <span class="n">tod_high</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">channel_subsystem_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">channel_subsystem</span> <span class="o">*</span><span class="n">css</span><span class="p">;</span>

	<span class="n">css</span> <span class="o">=</span> <span class="n">to_css</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Implies that it has been generated but never registered. */</span>
		<span class="n">css_subchannel_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">css</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">css_cm_enable_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">channel_subsystem</span> <span class="o">*</span><span class="n">css</span> <span class="o">=</span> <span class="n">to_css</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">css</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">css</span><span class="o">-&gt;</span><span class="n">cm_enabled</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">css_cm_enable_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">channel_subsystem</span> <span class="o">*</span><span class="n">css</span> <span class="o">=</span> <span class="n">to_css</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">css</span><span class="o">-&gt;</span><span class="n">cm_enabled</span> <span class="o">?</span> <span class="n">chsc_secm</span><span class="p">(</span><span class="n">css</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">css</span><span class="o">-&gt;</span><span class="n">cm_enabled</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">chsc_secm</span><span class="p">(</span><span class="n">css</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">cm_enable</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">css_cm_enable_show</span><span class="p">,</span> <span class="n">css_cm_enable_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_css</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tod_high</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_subsystem</span> <span class="o">*</span><span class="n">css</span><span class="p">;</span>

	<span class="n">css</span> <span class="o">=</span> <span class="n">channel_subsystems</span><span class="p">[</span><span class="n">nr</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">css</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel_subsystem</span><span class="p">));</span>
	<span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">css_subchannel_release</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;defunct&quot;</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cio_create_sch_lock</span><span class="p">(</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">css</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">css</span><span class="o">-&gt;</span><span class="n">cssid</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;css%x&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="n">css</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">channel_subsystem_release</span><span class="p">;</span>
	<span class="n">tod_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">get_clock</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">css_generate_pgid</span><span class="p">(</span><span class="n">css</span><span class="p">,</span> <span class="n">tod_high</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_reboot_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">__MAX_CSSID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">channel_subsystem</span> <span class="o">*</span><span class="n">css</span><span class="p">;</span>

		<span class="n">css</span> <span class="o">=</span> <span class="n">channel_subsystems</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">cm_enabled</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chsc_secm</span><span class="p">(</span><span class="n">css</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_BAD</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">css_reboot_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">css_reboot_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Since the css devices are neither on a bus nor have a class</span>
<span class="cm"> * nor have a special device type, we cannot stop/restart channel</span>
<span class="cm"> * path measurements via the normal suspend/resume callbacks, but have</span>
<span class="cm"> * to use notifiers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_power_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_HIBERNATION_PREPARE</span>:
	<span class="k">case</span> <span class="n">PM_SUSPEND_PREPARE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">__MAX_CSSID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">channel_subsystem</span> <span class="o">*</span><span class="n">css</span><span class="p">;</span>

			<span class="n">css</span> <span class="o">=</span> <span class="n">channel_subsystems</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">cm_enabled</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__chsc_do_secm</span><span class="p">(</span><span class="n">css</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">notifier_from_errno</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_POST_HIBERNATION</span>:
	<span class="k">case</span> <span class="n">PM_POST_SUSPEND</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">__MAX_CSSID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">channel_subsystem</span> <span class="o">*</span><span class="n">css</span><span class="p">;</span>

			<span class="n">css</span> <span class="o">=</span> <span class="n">channel_subsystems</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">cm_enabled</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__chsc_do_secm</span><span class="p">(</span><span class="n">css</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">notifier_from_errno</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* search for subchannels, which appeared during hibernation */</span>
		<span class="n">css_schedule_reprobe</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">css_power_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">css_power_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Now that the driver core is running, we can setup our channel subsystem.</span>
<span class="cm"> * The struct subchannel&#39;s are created during probing (except for the</span>
<span class="cm"> * static console subchannel).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">css_bus_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">chsc_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">chsc_determine_css_characteristics</span><span class="p">();</span>
	<span class="cm">/* Try to enable MSS. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">chsc_enable_facility</span><span class="p">(</span><span class="n">CHSC_SDA_OC_MSS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">max_ssid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* Success. */</span>
		<span class="n">max_ssid</span> <span class="o">=</span> <span class="n">__MAX_SSID</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">slow_subchannel_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">crw_register_handler</span><span class="p">(</span><span class="n">CRW_RSC_SCH</span><span class="p">,</span> <span class="n">css_process_crw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_bus_type</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Setup css structure. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">__MAX_CSSID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">channel_subsystem</span> <span class="o">*</span><span class="n">css</span><span class="p">;</span>

		<span class="n">css</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel_subsystem</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">css</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">channel_subsystems</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">css</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_css</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">channel_subsystems</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">css_chsc_characteristics</span><span class="p">.</span><span class="n">secm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">dev_attr_cm_enable</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_device</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_file</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_reboot_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_pm_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_power_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_reboot_notifier</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">css_init_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Enable default isc for I/O subchannels. */</span>
	<span class="n">isc_register</span><span class="p">(</span><span class="n">IO_SCH_ISC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_file:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">css_chsc_characteristics</span><span class="p">.</span><span class="n">secm</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel_subsystems</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">dev_attr_cm_enable</span><span class="p">);</span>
<span class="nl">out_device:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel_subsystems</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
<span class="nl">out_unregister:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">channel_subsystem</span> <span class="o">*</span><span class="n">css</span><span class="p">;</span>

		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="n">css</span> <span class="o">=</span> <span class="n">channel_subsystems</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">css_chsc_characteristics</span><span class="p">.</span><span class="n">secm</span><span class="p">)</span>
			<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_attr_cm_enable</span><span class="p">);</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_bus_type</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">crw_unregister_handler</span><span class="p">(</span><span class="n">CRW_RSC_SCH</span><span class="p">);</span>
	<span class="n">idset_free</span><span class="p">(</span><span class="n">slow_subchannel_set</span><span class="p">);</span>
	<span class="n">chsc_init_cleanup</span><span class="p">();</span>
	<span class="n">pr_alert</span><span class="p">(</span><span class="s">&quot;The CSS device driver initialization failed with &quot;</span>
		 <span class="s">&quot;errno=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">css_bus_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">channel_subsystem</span> <span class="o">*</span><span class="n">css</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">__MAX_CSSID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">css</span> <span class="o">=</span> <span class="n">channel_subsystems</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">css</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">css_chsc_characteristics</span><span class="p">.</span><span class="n">secm</span><span class="p">)</span>
			<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_cm_enable</span><span class="p">);</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_bus_type</span><span class="p">);</span>
	<span class="n">crw_unregister_handler</span><span class="p">(</span><span class="n">CRW_RSC_SCH</span><span class="p">);</span>
	<span class="n">idset_free</span><span class="p">(</span><span class="n">slow_subchannel_set</span><span class="p">);</span>
	<span class="n">chsc_init_cleanup</span><span class="p">();</span>
	<span class="n">isc_unregister</span><span class="p">(</span><span class="n">IO_SCH_ISC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">channel_subsystem_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">css_bus_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">cio_work_q</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;cio&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cio_work_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_bus</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">io_subchannel_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_wq</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">out_wq:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">cio_work_q</span><span class="p">);</span>
<span class="nl">out_bus:</span>
	<span class="n">css_bus_cleanup</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">channel_subsystem_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_settle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">css_driver</span> <span class="o">*</span><span class="n">cssdrv</span> <span class="o">=</span> <span class="n">to_cssdriver</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cssdrv</span><span class="o">-&gt;</span><span class="n">settle</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cssdrv</span><span class="o">-&gt;</span><span class="n">settle</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">css_complete_work</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Wait for the evaluation of subchannels to finish. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">css_eval_wq</span><span class="p">,</span>
				       <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_eval_scheduled</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">cio_work_q</span><span class="p">);</span>
	<span class="cm">/* Wait for the subchannel type specific initialization to finish */</span>
	<span class="k">return</span> <span class="n">bus_for_each_drv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">css_settle</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Wait for the initialization of devices to finish, to make sure we are</span>
<span class="cm"> * done with our setup if the search for the root device starts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">channel_subsystem_init_sync</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Start initial subchannel evaluation. */</span>
	<span class="n">css_schedule_eval_all</span><span class="p">();</span>
	<span class="n">css_complete_work</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">subsys_initcall_sync</span><span class="p">(</span><span class="n">channel_subsystem_init_sync</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">channel_subsystem_reinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">channel_path</span> <span class="o">*</span><span class="n">chp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chp_id</span> <span class="n">chpid</span><span class="p">;</span>

	<span class="n">chsc_enable_facility</span><span class="p">(</span><span class="n">CHSC_SDA_OC_MSS</span><span class="p">);</span>
	<span class="n">chp_id_for_each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chpid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chp</span> <span class="o">=</span> <span class="n">chpid_to_chp</span><span class="p">(</span><span class="n">chpid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chp</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">chsc_determine_base_channel_path_desc</span><span class="p">(</span><span class="n">chpid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chp</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cio_settle_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Handle pending CRW&#39;s. */</span>
	<span class="n">crw_wait_for_channel_report</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">css_complete_work</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">cio_settle_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">nonseekable_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">cio_settle_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cio_settle_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;cio_settle&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">cio_settle_proc_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">device_initcall</span><span class="p">(</span><span class="n">cio_settle_init</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/*CONFIG_PROC_FS*/</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">sch_is_pseudo_sch</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sch</span> <span class="o">==</span> <span class="n">to_css</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pseudo_subchannel</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_bus_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">css_driver</span> <span class="o">*</span><span class="n">driver</span> <span class="o">=</span> <span class="n">to_cssdriver</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">css_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">subchannel_type</span><span class="p">;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">st</span> <span class="o">==</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">to_cssdriver</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe</span> <span class="o">?</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove</span> <span class="o">?</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">css_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;ST=%01X&quot;</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;MODALIAS=css:t%01X&quot;</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_pm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">css_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drv</span> <span class="o">=</span> <span class="n">to_cssdriver</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
	<span class="cm">/* Notify drivers that they may not register children. */</span>
	<span class="k">return</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">prepare</span> <span class="o">?</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">css_pm_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">css_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">drv</span> <span class="o">=</span> <span class="n">to_cssdriver</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">drv</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_pm_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">css_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drv</span> <span class="o">=</span> <span class="n">to_cssdriver</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">freeze</span> <span class="o">?</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">freeze</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_pm_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">css_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drv</span> <span class="o">=</span> <span class="n">to_cssdriver</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">thaw</span> <span class="o">?</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">thaw</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">css_pm_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">css_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>

	<span class="n">css_update_ssd_info</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drv</span> <span class="o">=</span> <span class="n">to_cssdriver</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">restore</span> <span class="o">?</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">restore</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">css_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">css_pm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">complete</span> <span class="o">=</span> <span class="n">css_pm_complete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">css_pm_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span> <span class="o">=</span> <span class="n">css_pm_thaw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">css_pm_restore</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">css_bus_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;css&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>    <span class="o">=</span> <span class="n">css_bus_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">css_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">css_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">css_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uevent</span>   <span class="o">=</span> <span class="n">css_uevent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">css_pm_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * css_driver_register - register a css driver</span>
<span class="cm"> * @cdrv: css driver to register</span>
<span class="cm"> *</span>
<span class="cm"> * This is mainly a wrapper around driver_register that sets name</span>
<span class="cm"> * and bus_type in the embedded struct device_driver correctly.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">css_driver_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">css_driver</span> <span class="o">*</span><span class="n">cdrv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdrv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">css_bus_type</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdrv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">css_driver_register</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * css_driver_unregister - unregister a css driver</span>
<span class="cm"> * @cdrv: css driver to unregister</span>
<span class="cm"> *</span>
<span class="cm"> * This is a wrapper around driver_unregister.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">css_driver_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">css_driver</span> <span class="o">*</span><span class="n">cdrv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdrv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">css_driver_unregister</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
