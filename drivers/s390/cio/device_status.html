<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › cio › device_status.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>device_status.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/s390/cio/device_status.c</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright (C) 2002 IBM Deutschland Entwicklung GmbH,</span>
<span class="cm"> *			 IBM Corporation</span>
<span class="cm"> *    Author(s): Cornelia Huck (cornelia.huck@de.ibm.com)</span>
<span class="cm"> *		 Martin Schwidefsky (schwidefsky@de.ibm.com)</span>
<span class="cm"> *</span>
<span class="cm"> * Status accumulation and basic sense functions.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cp">#include &lt;asm/ccwdev.h&gt;</span>
<span class="cp">#include &lt;asm/cio.h&gt;</span>

<span class="cp">#include &quot;cio.h&quot;</span>
<span class="cp">#include &quot;cio_debug.h&quot;</span>
<span class="cp">#include &quot;css.h&quot;</span>
<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;ioasm.h&quot;</span>
<span class="cp">#include &quot;io_sch.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Check for any kind of channel or interface control check but don&#39;t</span>
<span class="cm"> * issue the message for the console device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_msg_control_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">dbf_text</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsw_is_valid_cstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">scsw_cstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCHN_STAT_CHN_DATA_CHK</span> <span class="o">|</span>
	      <span class="n">SCHN_STAT_CHN_CTRL_CHK</span> <span class="o">|</span> <span class="n">SCHN_STAT_INTF_CTRL_CHK</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Channel-Check or Interface-Control-Check &quot;</span>
		      <span class="s">&quot;received&quot;</span>
		      <span class="s">&quot; ... device %04x on subchannel 0.%x.%04x, dev_stat &quot;</span>
		      <span class="s">&quot;: %02X sch_stat : %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
		      <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">,</span>
		      <span class="n">scsw_dstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">),</span> <span class="n">scsw_cstat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">));</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">dbf_text</span><span class="p">,</span> <span class="s">&quot;chk%x&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dbf_text</span><span class="p">);</span>
	<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irb</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Some paths became not operational (pno bit in scsw is set).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_path_notoper</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_update_schib</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">doverify</span><span class="p">;</span>

	<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(0.%x.%04x) - path(s) %02x are &quot;</span>
		      <span class="s">&quot;not operational </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		      <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">,</span>
		      <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">pnom</span><span class="p">);</span>

	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">pnom</span><span class="p">;</span>
<span class="nl">doverify:</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">doverify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy valid bits from the extended control word to device irb.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_accumulate_ecw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Copy extended control bit if it is valid... yes there</span>
<span class="cm">	 * are condition that have to be met for the extended control</span>
<span class="cm">	 * bit to have meaning. Sick.</span>
<span class="cm">	 */</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">ectl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">&amp;</span> <span class="n">SCSW_STCTL_ALERT_STATUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">&amp;</span> <span class="n">SCSW_STCTL_INTER_STATUS</span><span class="p">))</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">ectl</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">ectl</span><span class="p">;</span>
	<span class="cm">/* Check if extended control word is valid. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">ectl</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Copy concurrent sense / model dependent information. */</span>
	<span class="n">memcpy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">ecw</span><span class="p">,</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if extended status word is valid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ccw_device_accumulate_esw_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">eswf</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">==</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">==</span>
			<span class="p">(</span><span class="n">SCSW_STCTL_INTER_STATUS</span><span class="o">|</span><span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span> <span class="o">&amp;</span> <span class="n">SCSW_ACTL_SUSPENDED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy valid bits from the extended status word to device irb.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_accumulate_esw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">cdev_irb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sublog</span> <span class="o">*</span><span class="n">cdev_sublog</span><span class="p">,</span> <span class="o">*</span><span class="n">sublog</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccw_device_accumulate_esw_valid</span><span class="p">(</span><span class="n">irb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cdev_irb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">;</span>

	<span class="cm">/* Copy last path used mask. */</span>
	<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw1</span><span class="p">.</span><span class="n">lpum</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw1</span><span class="p">.</span><span class="n">lpum</span><span class="p">;</span>

	<span class="cm">/* Copy subchannel logout information if esw is of format 0. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">eswf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdev_sublog</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">sublog</span><span class="p">;</span>
		<span class="n">sublog</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">sublog</span><span class="p">;</span>
		<span class="cm">/* Copy extended status flags. */</span>
		<span class="n">cdev_sublog</span><span class="o">-&gt;</span><span class="n">esf</span> <span class="o">=</span> <span class="n">sublog</span><span class="o">-&gt;</span><span class="n">esf</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Copy fields that have a meaning for channel data check</span>
<span class="cm">		 * channel control check and interface control check.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCHN_STAT_CHN_DATA_CHK</span> <span class="o">|</span>
				       <span class="n">SCHN_STAT_CHN_CTRL_CHK</span> <span class="o">|</span>
				       <span class="n">SCHN_STAT_INTF_CTRL_CHK</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Copy ancillary report bit. */</span>
			<span class="n">cdev_sublog</span><span class="o">-&gt;</span><span class="n">arep</span> <span class="o">=</span> <span class="n">sublog</span><span class="o">-&gt;</span><span class="n">arep</span><span class="p">;</span>
			<span class="cm">/* Copy field-validity-flags. */</span>
			<span class="n">cdev_sublog</span><span class="o">-&gt;</span><span class="n">fvf</span> <span class="o">=</span> <span class="n">sublog</span><span class="o">-&gt;</span><span class="n">fvf</span><span class="p">;</span>
			<span class="cm">/* Copy storage access code. */</span>
			<span class="n">cdev_sublog</span><span class="o">-&gt;</span><span class="n">sacc</span> <span class="o">=</span> <span class="n">sublog</span><span class="o">-&gt;</span><span class="n">sacc</span><span class="p">;</span>
			<span class="cm">/* Copy termination code. */</span>
			<span class="n">cdev_sublog</span><span class="o">-&gt;</span><span class="n">termc</span> <span class="o">=</span> <span class="n">sublog</span><span class="o">-&gt;</span><span class="n">termc</span><span class="p">;</span>
			<span class="cm">/* Copy sequence code. */</span>
			<span class="n">cdev_sublog</span><span class="o">-&gt;</span><span class="n">seqc</span> <span class="o">=</span> <span class="n">sublog</span><span class="o">-&gt;</span><span class="n">seqc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Copy device status check. */</span>
		<span class="n">cdev_sublog</span><span class="o">-&gt;</span><span class="n">devsc</span> <span class="o">=</span> <span class="n">sublog</span><span class="o">-&gt;</span><span class="n">devsc</span><span class="p">;</span>
		<span class="cm">/* Copy secondary error. */</span>
		<span class="n">cdev_sublog</span><span class="o">-&gt;</span><span class="n">serr</span> <span class="o">=</span> <span class="n">sublog</span><span class="o">-&gt;</span><span class="n">serr</span><span class="p">;</span>
		<span class="cm">/* Copy i/o-error alert. */</span>
		<span class="n">cdev_sublog</span><span class="o">-&gt;</span><span class="n">ioerr</span> <span class="o">=</span> <span class="n">sublog</span><span class="o">-&gt;</span><span class="n">ioerr</span><span class="p">;</span>
		<span class="cm">/* Copy channel path timeout bit. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span> <span class="o">&amp;</span> <span class="n">SCHN_STAT_INTF_CTRL_CHK</span><span class="p">)</span>
			<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cpt</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cpt</span><span class="p">;</span>
		<span class="cm">/* Copy failing storage address validity flag. */</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">fsavf</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">fsavf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">fsavf</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* ... and copy the failing storage address. */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">faddr</span><span class="p">,</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">faddr</span><span class="p">,</span>
			       <span class="k">sizeof</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">faddr</span><span class="p">));</span>
			<span class="cm">/* ... and copy the failing storage address format. */</span>
			<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">fsaf</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">fsaf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Copy secondary ccw address validity bit. */</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">scavf</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">scavf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">scavf</span><span class="p">)</span>
			<span class="cm">/* ... and copy the secondary ccw address. */</span>
			<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">saddr</span><span class="p">;</span>
		
	<span class="p">}</span>
	<span class="cm">/* FIXME: DCTI for format 2? */</span>

	<span class="cm">/* Copy authorization bit. */</span>
	<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">auth</span><span class="p">;</span>
	<span class="cm">/* Copy path verification required flag. */</span>
	<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">pvrf</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">pvrf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">pvrf</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">doverify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Copy concurrent sense bit. */</span>
	<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cons</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cons</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cons</span><span class="p">)</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">scnt</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">scnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Accumulate status from irb to devstat.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ccw_device_accumulate_irb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">cdev_irb</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if the status pending bit is set in stctl.</span>
<span class="cm">	 * If not, the remaining bit have no meaning and we must ignore them.</span>
<span class="cm">	 * The esw is not meaningful as well...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scsw_stctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Check for channel checks and interface control checks. */</span>
	<span class="n">ccw_device_msg_control_check</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="cm">/* Check for path not operational. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsw_is_valid_pno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">scsw_pno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">))</span>
		<span class="n">ccw_device_path_notoper</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="cm">/* No irb accumulation for transport mode irbs. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsw_is_tm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irb</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t accumulate unsolicited interrupts.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsw_is_solicited</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cdev_irb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the clear function had been performed, all formerly pending</span>
<span class="cm">	 * status at the subchannel has been cleared and we must not pass</span>
<span class="cm">	 * intermediate accumulated status to the device driver.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">fctl</span> <span class="o">&amp;</span> <span class="n">SCSW_FCTL_CLEAR_FUNC</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irb</span><span class="p">));</span>

	<span class="cm">/* Copy bits which are valid only for the start function. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">fctl</span> <span class="o">&amp;</span> <span class="n">SCSW_FCTL_START_FUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Copy key. */</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">key</span><span class="p">;</span>
		<span class="cm">/* Copy suspend control bit. */</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">sctl</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">sctl</span><span class="p">;</span>
		<span class="cm">/* Accumulate deferred condition code. */</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cc</span> <span class="o">|=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cc</span><span class="p">;</span>
		<span class="cm">/* Copy ccw format bit. */</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">fmt</span><span class="p">;</span>
		<span class="cm">/* Copy prefetch bit. */</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">pfch</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">pfch</span><span class="p">;</span>
		<span class="cm">/* Copy initial-status-interruption-control. */</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">isic</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">isic</span><span class="p">;</span>
		<span class="cm">/* Copy address limit checking control. */</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">alcc</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">alcc</span><span class="p">;</span>
		<span class="cm">/* Copy suppress suspend bit. */</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">ssi</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">ssi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Take care of the extended control bit and extended control word. */</span>
	<span class="n">ccw_device_accumulate_ecw</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	    
	<span class="cm">/* Accumulate function control. */</span>
	<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">fctl</span> <span class="o">|=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">fctl</span><span class="p">;</span>
	<span class="cm">/* Copy activity control. */</span>
	<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span><span class="p">;</span>
	<span class="cm">/* Accumulate status control. */</span>
	<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">|=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Copy ccw address if it is valid. This is a bit simplified</span>
<span class="cm">	 * but should be close enough for all practical purposes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">&amp;</span> <span class="n">SCSW_STCTL_PRIM_STATUS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">==</span>
	      <span class="p">(</span><span class="n">SCSW_STCTL_INTER_STATUS</span><span class="o">|</span><span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span> <span class="o">&amp;</span> <span class="n">SCSW_ACTL_DEVACT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span> <span class="o">&amp;</span> <span class="n">SCSW_ACTL_SCHACT</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span> <span class="o">&amp;</span> <span class="n">SCSW_ACTL_SUSPENDED</span><span class="p">))</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span><span class="p">;</span>
	<span class="cm">/* Accumulate device status, but not the device busy flag. */</span>
	<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEV_STAT_BUSY</span><span class="p">;</span>
	<span class="cm">/* dstat is not always valid. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">SCSW_STCTL_PRIM_STATUS</span> <span class="o">|</span> <span class="n">SCSW_STCTL_SEC_STATUS</span>
	     <span class="o">|</span> <span class="n">SCSW_STCTL_INTER_STATUS</span> <span class="o">|</span> <span class="n">SCSW_STCTL_ALERT_STATUS</span><span class="p">))</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">|=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span><span class="p">;</span>
	<span class="cm">/* Accumulate subchannel status. */</span>
	<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span> <span class="o">|=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span><span class="p">;</span>
	<span class="cm">/* Copy residual count if it is valid. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">stctl</span> <span class="o">&amp;</span> <span class="n">SCSW_STCTL_PRIM_STATUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SCHN_STAT_PCI</span> <span class="o">|</span> <span class="n">SCHN_STAT_INCORR_LEN</span><span class="p">))</span>
	     <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>

	<span class="cm">/* Take care of bits in the extended status word. */</span>
	<span class="n">ccw_device_accumulate_esw</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check whether we must issue a SENSE CCW ourselves if there is no</span>
<span class="cm">	 * concurrent sense facility installed for the subchannel.</span>
<span class="cm">	 * No sense is required if no delayed sense is pending</span>
<span class="cm">	 * and we did not get a unit check without sense information.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: We should check for ioinfo[irq]-&gt;flags.consns but VM</span>
<span class="cm">	 *	 violates the ESA/390 architecture and doesn&#39;t present an</span>
<span class="cm">	 *	 operand exception for virtual devices without concurrent</span>
<span class="cm">	 *	 sense facility available/supported when enabling the</span>
<span class="cm">	 *	 concurrent sense facility.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">cdev_irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cons</span><span class="p">))</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">dosense</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do a basic sense.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ccw_device_do_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">sense_ccw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="cm">/* A sense is required, can we do it now ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsw_actl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCSW_ACTL_DEVACT</span> <span class="o">|</span> <span class="n">SCSW_ACTL_SCHACT</span><span class="p">))</span>
		<span class="cm">/*</span>
<span class="cm">		 * we received an Unit Check but we have no final</span>
<span class="cm">		 *  status yet, therefore we must delay the SENSE</span>
<span class="cm">		 *  processing. We must not report this intermediate</span>
<span class="cm">		 *  status to the device interrupt handler.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have ending status but no sense information. Do a basic sense.</span>
<span class="cm">	 */</span>
	<span class="n">sense_ccw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">to_io_private</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sense_ccw</span><span class="p">;</span>
	<span class="n">sense_ccw</span><span class="o">-&gt;</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_BASIC_SENSE</span><span class="p">;</span>
	<span class="n">sense_ccw</span><span class="o">-&gt;</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">ecw</span><span class="p">);</span>
	<span class="n">sense_ccw</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">SENSE_MAX_COUNT</span><span class="p">;</span>
	<span class="n">sense_ccw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cio_start</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">sense_ccw</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span>
		<span class="n">dev_fsm_event</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_EVENT_VERIFY</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add information from basic sense to devstat.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ccw_device_accumulate_basic_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if the status pending bit is set in stctl.</span>
<span class="cm">	 * If not, the remaining bit have no meaning and we must ignore them.</span>
<span class="cm">	 * The esw is not meaningful as well...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scsw_stctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Check for channel checks and interface control checks. */</span>
	<span class="n">ccw_device_msg_control_check</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="cm">/* Check for path not operational. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsw_is_valid_pno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">scsw_pno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">))</span>
		<span class="n">ccw_device_path_notoper</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_CHN_END</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cons</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">dosense</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check if path verification is required. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccw_device_accumulate_esw_valid</span><span class="p">(</span><span class="n">irb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">pvrf</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">doverify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function accumulates the status into the private devstat and</span>
<span class="cm"> * starts a basic sense if one is needed.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ccw_device_accumulate_and_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccw_device_accumulate_irb</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span>  <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCSW_ACTL_DEVACT</span> <span class="o">|</span> <span class="n">SCSW_ACTL_SCHACT</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="cm">/* Check for basic sense. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">dosense</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cons</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">dosense</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">dosense</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccw_device_do_sense</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
