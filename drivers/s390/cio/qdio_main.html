<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › cio › qdio_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qdio_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/s390/cio/qdio_main.c</span>
<span class="cm"> *</span>
<span class="cm"> * Linux for s390 qdio support, buffer handling, qdio API and module support.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2000,2008 IBM Corp.</span>
<span class="cm"> * Author(s): Utz Bacher &lt;utz.bacher@de.ibm.com&gt;</span>
<span class="cm"> *	      Jan Glauber &lt;jang@linux.vnet.ibm.com&gt;</span>
<span class="cm"> * 2.6 cio integration by Cornelia Huck &lt;cornelia.huck@de.ibm.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/debug.h&gt;</span>
<span class="cp">#include &lt;asm/qdio.h&gt;</span>
<span class="cp">#include &lt;asm/ipl.h&gt;</span>

<span class="cp">#include &quot;cio.h&quot;</span>
<span class="cp">#include &quot;css.h&quot;</span>
<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;qdio.h&quot;</span>
<span class="cp">#include &quot;qdio_debug.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Utz Bacher &lt;utz.bacher@de.ibm.com&gt;,&quot;</span>\
	<span class="s">&quot;Jan Glauber &lt;jang@linux.vnet.ibm.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;QDIO base support&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">do_siga_sync</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">schid</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">out_mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_mask</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__fc</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">fc</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__schid</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">schid</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">out</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">out_mask</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">in</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;3&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">in_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cc</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	siga	0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	ipm	%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	srl	%0,28</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">cc</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">__fc</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">__schid</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">do_siga_input</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">schid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__fc</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">fc</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__schid</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">schid</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__mask</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cc</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	siga	0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	ipm	%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	srl	%0,28</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">cc</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">__fc</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">__schid</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">__mask</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_siga_output - perform SIGA-w/wt function</span>
<span class="cm"> * @schid: subchannel id or in case of QEBSM the subchannel token</span>
<span class="cm"> * @mask: which output queues to process</span>
<span class="cm"> * @bb: busy bit indicator, set only if SIGA-w/wt could not access a buffer</span>
<span class="cm"> * @fc: function code to perform</span>
<span class="cm"> *</span>
<span class="cm"> * Returns condition code.</span>
<span class="cm"> * Note: For IQDC unicast queues only the highest priority queue is processed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">do_siga_output</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">schid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fc</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__fc</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">fc</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__schid</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">schid</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__mask</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__aob</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;3&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">aob</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cc</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	siga	0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	ipm	%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	srl	%0,28</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">cc</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">__fc</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">__aob</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">__schid</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">__mask</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bb</span> <span class="o">=</span> <span class="n">__fc</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qdio_check_ccq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ccq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* all done or next buffer state different */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccq</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ccq</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* no buffer processed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccq</span> <span class="o">==</span> <span class="mi">97</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* not all buffers processed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccq</span> <span class="o">==</span> <span class="mi">96</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* notify devices immediately */</span>
	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x ccq:%3d&quot;</span><span class="p">,</span> <span class="n">SCH_NO</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">ccq</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qdio_do_eqbs - extract buffer states for QEBSM</span>
<span class="cm"> * @q: queue to manipulate</span>
<span class="cm"> * @state: state of the extracted buffers</span>
<span class="cm"> * @start: buffer number to start at</span>
<span class="cm"> * @count: count of buffers to examine</span>
<span class="cm"> * @auto_ack: automatically acknowledge buffers</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the number of successfully extracted equal buffer states.</span>
<span class="cm"> * Stops processing if a state is different from the last buffers state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qdio_do_eqbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">auto_ack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">tmp_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">,</span> <span class="n">tmp_start</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">retried</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ccq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">sch_token</span><span class="p">);</span>
	<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">eqbs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">is_input_q</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">+=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">nr_input_qs</span><span class="p">;</span>
<span class="nl">again:</span>
	<span class="n">ccq</span> <span class="o">=</span> <span class="n">do_eqbs</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">sch_token</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_count</span><span class="p">,</span>
		      <span class="n">auto_ack</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_check_ccq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">ccq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">tmp_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARN</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;EQBS again:%2d&quot;</span><span class="p">,</span> <span class="n">ccq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tmp_count</span> <span class="o">==</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">eqbs_partial</span><span class="p">);</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARN</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;EQBS part:%02x&quot;</span><span class="p">,</span>
			<span class="n">tmp_count</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Retry once, if that fails bail out and process the</span>
<span class="cm">		 * extracted buffers before trying again.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retried</span><span class="o">++</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">tmp_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x EQBS ERROR&quot;</span><span class="p">,</span> <span class="n">SCH_NO</span><span class="p">(</span><span class="n">q</span><span class="p">));</span>
	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%3d%3d%2d&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tmp_count</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">QDIO_ERROR_GET_BUF_STATE</span><span class="p">,</span>
		   <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_kick</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">int_parm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qdio_do_sqbs - set buffer states for QEBSM</span>
<span class="cm"> * @q: queue to manipulate</span>
<span class="cm"> * @state: new state of the buffers</span>
<span class="cm"> * @start: first buffer number to change</span>
<span class="cm"> * @count: how many buffers to change</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the number of successfully changed buffers.</span>
<span class="cm"> * Does retrying until the specified count of buffer states is set or an</span>
<span class="cm"> * error occurs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qdio_do_sqbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ccq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">,</span> <span class="n">tmp_start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">sch_token</span><span class="p">);</span>
	<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">sqbs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">is_input_q</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">+=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">nr_input_qs</span><span class="p">;</span>
<span class="nl">again:</span>
	<span class="n">ccq</span> <span class="o">=</span> <span class="n">do_sqbs</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">sch_token</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_count</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_check_ccq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">ccq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">tmp_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">tmp_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;SQBS again:%2d&quot;</span><span class="p">,</span> <span class="n">ccq</span><span class="p">);</span>
		<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">sqbs_partial</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x SQBS ERROR&quot;</span><span class="p">,</span> <span class="n">SCH_NO</span><span class="p">(</span><span class="n">q</span><span class="p">));</span>
	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%3d%3d%2d&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tmp_count</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">QDIO_ERROR_SET_BUF_STATE</span><span class="p">,</span>
		   <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_kick</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">int_parm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns number of examined buffers and their common state in *state */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_buf_states</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufnr</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">auto_ack</span><span class="p">,</span> <span class="kt">int</span> <span class="n">merge_pending</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bufnr</span> <span class="o">&gt;</span> <span class="n">QDIO_MAX_BUFFERS_MASK</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qebsm</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">qdio_do_eqbs</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">auto_ack</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__state</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">slsb</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="n">bufnr</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">merge_pending</span> <span class="o">&amp;&amp;</span> <span class="n">__state</span> <span class="o">==</span> <span class="n">SLSB_P_OUTPUT_PENDING</span><span class="p">)</span>
				<span class="n">__state</span> <span class="o">=</span> <span class="n">SLSB_P_OUTPUT_EMPTY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">merge_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">slsb</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="n">bufnr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">__state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">__state</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">slsb</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="n">bufnr</span><span class="p">]</span> <span class="o">!=</span> <span class="n">__state</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">bufnr</span> <span class="o">=</span> <span class="n">next_buf</span><span class="p">(</span><span class="n">bufnr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">__state</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_buf_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufnr</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">auto_ack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">auto_ack</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* wrap-around safe setting of slsb states, returns number of changed buffers */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">set_buf_states</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufnr</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bufnr</span> <span class="o">&gt;</span> <span class="n">QDIO_MAX_BUFFERS_MASK</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qebsm</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">qdio_do_sqbs</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">slsb</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="n">bufnr</span><span class="p">],</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">bufnr</span> <span class="o">=</span> <span class="n">next_buf</span><span class="p">(</span><span class="n">bufnr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">set_buf_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufnr</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">set_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* set slsb states to initial state */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qdio_init_buf_states</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_input_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">set_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SLSB_P_INPUT_NOT_INIT</span><span class="p">,</span>
			       <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">);</span>
	<span class="n">for_each_output_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">set_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SLSB_P_OUTPUT_NOT_INIT</span><span class="p">,</span>
			       <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qdio_siga_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">output</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">schid</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">QDIO_SIGA_SYNC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cc</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;siga-s:%1d&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
	<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">siga_sync</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qebsm</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schid</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">sch_token</span><span class="p">;</span>
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">QDIO_SIGA_QEBSM_FLAG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cc</span> <span class="o">=</span> <span class="n">do_siga_sync</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">fc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span>
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x SIGA-S:%2d&quot;</span><span class="p">,</span> <span class="n">SCH_NO</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">cc</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qdio_siga_sync_q</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">is_input_q</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">qdio_siga_sync</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">qdio_siga_sync</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qdio_siga_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">busy_bit</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">schid</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">QDIO_SIGA_WRITE</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">laob</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">use_cq</span> <span class="o">&amp;&amp;</span> <span class="n">aob</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc</span> <span class="o">=</span> <span class="n">QDIO_SIGA_WRITEQ</span><span class="p">;</span>
		<span class="n">laob</span> <span class="o">=</span> <span class="n">aob</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qebsm</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schid</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">sch_token</span><span class="p">;</span>
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">QDIO_SIGA_QEBSM_FLAG</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">again:</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">((</span><span class="n">aob</span> <span class="o">&amp;&amp;</span> <span class="n">queue_type</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QDIO_IQDIO_QFMT</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">aob</span> <span class="o">&amp;&amp;</span> <span class="n">fc</span> <span class="o">!=</span> <span class="n">QDIO_SIGA_WRITEQ</span><span class="p">));</span>
	<span class="n">cc</span> <span class="o">=</span> <span class="n">do_siga_output</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">busy_bit</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">laob</span><span class="p">);</span>

	<span class="cm">/* hipersocket busy condition */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">busy_bit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">queue_type</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QDIO_IQDIO_QFMT</span> <span class="o">||</span> <span class="n">cc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">retries</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start_time</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">start_time</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">get_clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">QDIO_BUSY_BIT_PATIENCE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARN</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span>
			      <span class="s">&quot;%4x cc2 BB1:%1d&quot;</span><span class="p">,</span> <span class="n">SCH_NO</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_WARN</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;count:%u&quot;</span><span class="p">,</span> <span class="n">retries</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qdio_siga_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">schid</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">QDIO_SIGA_READ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cc</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;siga-r:%1d&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
	<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">siga_read</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qebsm</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schid</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">sch_token</span><span class="p">;</span>
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">QDIO_SIGA_QEBSM_FLAG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cc</span> <span class="o">=</span> <span class="n">do_siga_input</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">fc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span>
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x SIGA-R:%2d&quot;</span><span class="p">,</span> <span class="n">SCH_NO</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">cc</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define qdio_siga_sync_out(q) qdio_siga_sync(q, ~0U, 0)</span>
<span class="cp">#define qdio_siga_sync_all(q) qdio_siga_sync(q, ~0U, ~0U)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qdio_sync_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* PCI capable outbound queues will also be scanned so sync them too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_out_supported</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="n">qdio_siga_sync_all</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">qdio_siga_sync_q</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">debug_get_buf_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufnr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_siga_sync</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="n">qdio_siga_sync_q</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">get_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qdio_stop_polling</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">polling</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">stop_polling</span><span class="p">);</span>

	<span class="cm">/* show the card that we are not polling anymore */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qebsm</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_start</span><span class="p">,</span> <span class="n">SLSB_P_INPUT_NOT_INIT</span><span class="p">,</span>
			       <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_count</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">set_buf_state</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_start</span><span class="p">,</span> <span class="n">SLSB_P_INPUT_NOT_INIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">account_sbals</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">.</span><span class="n">nr_sbal_total</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">QDIO_MAX_BUFFERS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">.</span><span class="n">nr_sbals</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">.</span><span class="n">nr_sbals</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_buffer_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">is_input_q</span><span class="p">)</span> <span class="o">?</span> <span class="n">SLSB_P_INPUT_NOT_INIT</span> <span class="o">:</span>
					<span class="n">SLSB_P_OUTPUT_NOT_INIT</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">qdio_error</span> <span class="o">=</span> <span class="n">QDIO_ERROR_SLSB_STATE</span><span class="p">;</span>

	<span class="cm">/* special handling for no target buffer empty */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">is_input_q</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">sbal</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">sflags</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">target_full</span><span class="p">);</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;OUTFULL FTC:%02x&quot;</span><span class="p">,</span>
			      <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">set</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x BUF ERROR&quot;</span><span class="p">,</span> <span class="n">SCH_NO</span><span class="p">(</span><span class="n">q</span><span class="p">));</span>
	<span class="n">DBF_ERROR</span><span class="p">((</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">is_input_q</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;IN:%2d&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT:%2d&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;FTC:%3d C:%3d&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;F14:%2x F15:%2x&quot;</span><span class="p">,</span>
		  <span class="n">q</span><span class="o">-&gt;</span><span class="n">sbal</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="n">sflags</span><span class="p">,</span>
		  <span class="n">q</span><span class="o">-&gt;</span><span class="n">sbal</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">sflags</span><span class="p">);</span>

<span class="nl">set:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Interrupts may be avoided as long as the error is present</span>
<span class="cm">	 * so change the buffer state immediately to avoid starvation.</span>
<span class="cm">	 */</span>
	<span class="n">set_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">inbound_primed</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;in prim: %02x&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="cm">/* for QEBSM the ACK was already set by EQBS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qebsm</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">polling</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_start</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* delete the previous ACK&#39;s */</span>
		<span class="n">set_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_start</span><span class="p">,</span> <span class="n">SLSB_P_INPUT_NOT_INIT</span><span class="p">,</span>
			       <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_count</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_start</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * ACK the newest buffer. The ACK will be removed in qdio_stop_polling</span>
<span class="cm">	 * or by the next inbound run.</span>
<span class="cm">	 */</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">add_buf</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">polling</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reset the previous ACK but first set the new one */</span>
		<span class="n">set_buf_state</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">SLSB_P_INPUT_ACK</span><span class="p">);</span>
		<span class="n">set_buf_state</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_start</span><span class="p">,</span> <span class="n">SLSB_P_INPUT_NOT_INIT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_buf_state</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">SLSB_P_INPUT_ACK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_start</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* need to change ALL buffers to get more interrupts */</span>
	<span class="n">set_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="n">SLSB_P_INPUT_NOT_INIT</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_inbound_buffer_frontier</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">stop</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t check 128 buffers, as otherwise qdio_inbound_q_moved</span>
<span class="cm">	 * would return 0.</span>
<span class="cm">	 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_buf_used</span><span class="p">),</span> <span class="n">QDIO_MAX_BUFFERS_MASK</span><span class="p">);</span>
	<span class="n">stop</span> <span class="o">=</span> <span class="n">add_buf</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span> <span class="o">==</span> <span class="n">stop</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * No siga sync here, as a PCI or we after a thin interrupt</span>
<span class="cm">	 * already sync&#39;ed the queues.</span>
<span class="cm">	 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">get_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SLSB_P_INPUT_PRIMED</span>:
		<span class="n">inbound_primed</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span> <span class="o">=</span> <span class="n">add_buf</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_sub</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_buf_used</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">inbound_queue_full</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat_enabled</span><span class="p">)</span>
			<span class="n">account_sbals</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLSB_P_INPUT_ERROR</span>:
		<span class="n">process_buffer_error</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span> <span class="o">=</span> <span class="n">add_buf</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">atomic_sub</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_buf_used</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat_enabled</span><span class="p">)</span>
			<span class="n">account_sbals_error</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLSB_CU_INPUT_EMPTY</span>:
	<span class="k">case</span> <span class="n">SLSB_P_INPUT_NOT_INIT</span>:
	<span class="k">case</span> <span class="n">SLSB_P_INPUT_ACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat_enabled</span><span class="p">)</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">.</span><span class="n">nr_sbal_nop</span><span class="o">++</span><span class="p">;</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;in nop&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qdio_inbound_q_moved</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bufnr</span><span class="p">;</span>

	<span class="n">bufnr</span> <span class="o">=</span> <span class="n">get_inbound_buffer_frontier</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bufnr</span> <span class="o">!=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">last_move</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">last_move</span> <span class="o">=</span> <span class="n">bufnr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_thinint_irq</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">MACHINE_IS_LPAR</span><span class="p">)</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qdio_inbound_q_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_buf_used</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_siga_sync</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="n">qdio_siga_sync_q</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="n">get_buf_state</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">SLSB_P_INPUT_PRIMED</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">SLSB_P_INPUT_ERROR</span><span class="p">)</span>
		<span class="cm">/* more work coming */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_thinint_irq</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* don&#39;t poll under z/VM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_IS_VM</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point we know, that inbound first_to_check</span>
<span class="cm">	 * has (probably) not moved (see qdio_inbound_processing).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_clock</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="n">QDIO_INPUT_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;in done:%02x&quot;</span><span class="p">,</span>
			      <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">contains_aobs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">is_input_q</span> <span class="o">&amp;&amp;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">use_cq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qdio_trace_aob</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qaob</span> <span class="o">*</span><span class="n">aob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;AOB%d:%lx&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">aob</span><span class="p">));</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;RES00:%lx&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">res0</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;RES01:%lx&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">res0</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;RES02:%lx&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">res0</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;RES03:%lx&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">res0</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;RES04:%lx&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">res0</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;RES05:%lx&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">res0</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;RES1:%x&quot;</span><span class="p">,</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">res1</span><span class="p">);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;RES2:%x&quot;</span><span class="p">,</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">res2</span><span class="p">);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;RES3:%x&quot;</span><span class="p">,</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">res3</span><span class="p">);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;AORC:%u&quot;</span><span class="p">,</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">aorc</span><span class="p">);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;FLAGS:%u&quot;</span><span class="p">,</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;CBTBS:%u&quot;</span><span class="p">,</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">cbtbs</span><span class="p">);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;SBC:%u&quot;</span><span class="p">,</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">sb_count</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">QDIO_MAX_ELEMENTS_PER_BUFFER</span><span class="p">;</span> <span class="o">++</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;SBA%d:%lx&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">sba</span><span class="p">[</span><span class="n">tmp</span><span class="p">]);</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;rSBA%d:%lx&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">sbal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;DC%d:%u&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">dcount</span><span class="p">[</span><span class="n">tmp</span><span class="p">]);</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;rDC%d:%u&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">sbal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;USER0:%lx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">user0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;RES4%d:%lx&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">res4</span><span class="p">[</span><span class="n">tmp</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;USER1:%lx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">user1</span><span class="p">);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;USER2:%lx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aob</span><span class="o">-&gt;</span><span class="n">user2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qdio_handle_aobs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">contains_aobs</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_buf_state</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">SLSB_P_OUTPUT_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">qaob</span> <span class="o">*</span><span class="n">aob</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">aobs</span><span class="p">[</span><span class="n">b</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">aob</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">sbal_state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">sbal_state</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
				<span class="n">QDIO_OUTBUF_STATE_FLAG_PENDING</span><span class="p">;</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">aobs</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">SLSB_P_OUTPUT_EMPTY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">sbal_state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">sbal_state</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">aob</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">next_buf</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">qdio_aob_for_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_output_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">bufnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_aob</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">use_cq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">aobs</span><span class="p">[</span><span class="n">bufnr</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qaob</span> <span class="o">*</span><span class="n">aob</span> <span class="o">=</span> <span class="n">qdio_allocate_aob</span><span class="p">();</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">aobs</span><span class="p">[</span><span class="n">bufnr</span><span class="p">]</span> <span class="o">=</span> <span class="n">aob</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">aobs</span><span class="p">[</span><span class="n">bufnr</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">sbal_state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">sbal_state</span><span class="p">[</span><span class="n">bufnr</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">QDIO_OUTBUF_STATE_FLAG_NONE</span><span class="p">;</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">sbal_state</span><span class="p">[</span><span class="n">bufnr</span><span class="p">].</span><span class="n">aob</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">aobs</span><span class="p">[</span><span class="n">bufnr</span><span class="p">];</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">aobs</span><span class="p">[</span><span class="n">bufnr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">user1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">sbal_state</span><span class="p">[</span><span class="n">bufnr</span><span class="p">].</span><span class="n">user</span><span class="p">;</span>
		<span class="n">phys_aob</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">aobs</span><span class="p">[</span><span class="n">bufnr</span><span class="p">]);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">phys_aob</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">phys_aob</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qdio_kick_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_kick</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">QDIO_IRQ_STATE_ACTIVE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">sub_buf</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">is_input_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">inbound_handler</span><span class="p">);</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;kih s:%02x c:%02x&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">outbound_handler</span><span class="p">);</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;koh: s:%02x c:%02x&quot;</span><span class="p">,</span>
			      <span class="n">start</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qdio_handle_aobs</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qdio_error</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
		   <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">int_parm</span><span class="p">);</span>

	<span class="cm">/* for the next time */</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_kick</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">qdio_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__qdio_inbound_processing</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">tasklet_inbound</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdio_inbound_q_moved</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">qdio_kick_handler</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdio_inbound_q_done</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* means poll time is not yet over */</span>
		<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">tasklet_inbound_resched</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">QDIO_IRQ_STATE_STOPPED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">qdio_stop_polling</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to check again to not lose initiative after</span>
<span class="cm">	 * resetting the ACK state.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdio_inbound_q_done</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">tasklet_inbound_resched2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">QDIO_IRQ_STATE_STOPPED</span><span class="p">))</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qdio_inbound_processing</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__qdio_inbound_processing</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_outbound_buffer_frontier</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">stop</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_siga_sync</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">queue_type</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QDIO_IQDIO_QFMT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">pci_out_supported</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">queue_type</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="n">QDIO_IQDIO_QFMT</span> <span class="o">&amp;&amp;</span>
		    <span class="n">multicast_outbound</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>
			<span class="n">qdio_siga_sync_q</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t check 128 buffers, as otherwise qdio_inbound_q_moved</span>
<span class="cm">	 * would return 0.</span>
<span class="cm">	 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_buf_used</span><span class="p">),</span> <span class="n">QDIO_MAX_BUFFERS_MASK</span><span class="p">);</span>
	<span class="n">stop</span> <span class="o">=</span> <span class="n">add_buf</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span> <span class="o">==</span> <span class="n">stop</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">get_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SLSB_P_OUTPUT_PENDING</span>:
		<span class="n">BUG</span><span class="p">();</span>
	<span class="k">case</span> <span class="n">SLSB_P_OUTPUT_EMPTY</span>:
		<span class="cm">/* the adapter got it */</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span>
			<span class="s">&quot;out empty:%1d %02x&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="n">atomic_sub</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_buf_used</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span> <span class="o">=</span> <span class="n">add_buf</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat_enabled</span><span class="p">)</span>
			<span class="n">account_sbals</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLSB_P_OUTPUT_ERROR</span>:
		<span class="n">process_buffer_error</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span> <span class="o">=</span> <span class="n">add_buf</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">atomic_sub</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_buf_used</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat_enabled</span><span class="p">)</span>
			<span class="n">account_sbals_error</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLSB_CU_OUTPUT_PRIMED</span>:
		<span class="cm">/* the adapter has not fetched the output yet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat_enabled</span><span class="p">)</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">.</span><span class="n">nr_sbal_nop</span><span class="o">++</span><span class="p">;</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;out primed:%1d&quot;</span><span class="p">,</span>
			      <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLSB_P_OUTPUT_NOT_INIT</span>:
	<span class="k">case</span> <span class="n">SLSB_P_OUTPUT_HALTED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* all buffers processed? */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qdio_outbound_q_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_buf_used</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qdio_outbound_q_moved</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bufnr</span><span class="p">;</span>

	<span class="n">bufnr</span> <span class="o">=</span> <span class="n">get_outbound_buffer_frontier</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bufnr</span> <span class="o">!=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">last_move</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">last_move</span> <span class="o">=</span> <span class="n">bufnr</span><span class="p">;</span>
		<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;out moved:%1d&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qdio_kick_outbound_q</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">busy_bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">need_siga_out</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;siga-w:%1d&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
<span class="nl">retry:</span>
	<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">siga_write</span><span class="p">);</span>

	<span class="n">cc</span> <span class="o">=</span> <span class="n">qdio_siga_output</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">busy_bit</span><span class="p">,</span> <span class="n">aob</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">busy_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">retries</span> <span class="o">&lt;</span> <span class="n">QDIO_BUSY_BIT_RETRIES</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="n">QDIO_BUSY_BIT_RETRY_DELAY</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x cc2 BBC:%1d&quot;</span><span class="p">,</span> <span class="n">SCH_NO</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="n">cc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;siga-w cc2:%1d&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="n">cc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x SIGA-W:%1d&quot;</span><span class="p">,</span> <span class="n">SCH_NO</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">cc</span><span class="p">);</span>
		<span class="n">cc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x cc2 BB2:%1d&quot;</span><span class="p">,</span> <span class="n">SCH_NO</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;count:%u&quot;</span><span class="p">,</span> <span class="n">retries</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__qdio_outbound_processing</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">tasklet_outbound</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_buf_used</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdio_outbound_q_moved</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="n">qdio_kick_handler</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue_type</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="n">QDIO_ZFCP_QFMT</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_out_supported</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">qdio_outbound_q_done</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">sched</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">pci_out_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now we know that queue type is either qeth without pci enabled</span>
<span class="cm">	 * or HiperSockets. Make sure buffer switch from PRIMED to EMPTY</span>
<span class="cm">	 * is noticed and outbound_handler is called after some time.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdio_outbound_q_done</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">timer</span><span class="p">))</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">sched:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QDIO_IRQ_STATE_STOPPED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* outbound tasklet */</span>
<span class="kt">void</span> <span class="nf">qdio_outbound_processing</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__qdio_outbound_processing</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qdio_outbound_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QDIO_IRQ_STATE_STOPPED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qdio_check_outbound_after_thinint</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_out_supported</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_each_output_queue</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdio_outbound_q_done</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__tiqdio_inbound_processing</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">tasklet_inbound</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_siga_sync</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">need_siga_sync_after_ai</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="n">qdio_sync_queues</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The interrupt could be caused by a PCI request. Check the</span>
<span class="cm">	 * PCI capable outbound queues.</span>
<span class="cm">	 */</span>
	<span class="n">qdio_check_outbound_after_thinint</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdio_inbound_q_moved</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">qdio_kick_handler</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdio_inbound_q_done</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">tasklet_inbound_resched</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">QDIO_IRQ_STATE_STOPPED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">qdio_stop_polling</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to check again to not lose initiative after</span>
<span class="cm">	 * resetting the ACK state.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdio_inbound_q_done</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">tasklet_inbound_resched2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">QDIO_IRQ_STATE_STOPPED</span><span class="p">))</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tiqdio_inbound_processing</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__tiqdio_inbound_processing</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qdio_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">qdio_irq_states</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;newstate: %1d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qdio_irq_check_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cons</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x sense:&quot;</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
		<span class="n">DBF_ERROR_HEX</span><span class="p">(</span><span class="n">irb</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">DBF_ERROR_HEX</span><span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* PCI interrupt handler */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qdio_int_handler_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QDIO_IRQ_STATE_STOPPED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_each_input_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">queue_start_poll</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* skip if polling is enabled or already in work */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">QDIO_QUEUE_IRQS_DISABLED</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">queue_irq_state</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">int_discarded</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">queue_start_poll</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span>
						 <span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">int_parm</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_out_supported</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_each_output_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qdio_outbound_q_done</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_siga_sync</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">need_siga_sync_out_after_pci</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
			<span class="n">qdio_siga_sync_q</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qdio_handle_activate_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">intparm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cstat</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dstat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x ACT CHECK&quot;</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;intp :%lx&quot;</span><span class="p">,</span> <span class="n">intparm</span><span class="p">);</span>
	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;ds: %2x cs:%2x&quot;</span><span class="p">,</span> <span class="n">dstat</span><span class="p">,</span> <span class="n">cstat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">nr_input_qs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span> <span class="o">=</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">input_qs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">nr_output_qs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span> <span class="o">=</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">output_qs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dump_stack</span><span class="p">();</span>
		<span class="k">goto</span> <span class="n">no_handler</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">sub_buf</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_kick</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">QDIO_ERROR_ACTIVATE</span><span class="p">,</span>
		   <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_kick</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">int_parm</span><span class="p">);</span>
<span class="nl">no_handler:</span>
	<span class="n">qdio_set_state</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">QDIO_IRQ_STATE_STOPPED</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * In case of z/VM LGR (Live Guest Migration) QDIO recovery will happen.</span>
<span class="cm">	 * Therefore we call the LGR detection function here.</span>
<span class="cm">	 */</span>
	<span class="n">lgr_info_log</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qdio_establish_handle_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cstat</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">dstat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;qest irq&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cstat</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">DEV_STAT_DEV_END</span> <span class="o">|</span> <span class="n">DEV_STAT_CHN_END</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_DEV_END</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">qdio_set_state</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">QDIO_IRQ_STATE_ESTABLISHED</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x EQ:error&quot;</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;ds: %2x cs:%2x&quot;</span><span class="p">,</span> <span class="n">dstat</span><span class="p">,</span> <span class="n">cstat</span><span class="p">);</span>
	<span class="n">qdio_set_state</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">QDIO_IRQ_STATE_ERR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* qdio interrupt handler */</span>
<span class="kt">void</span> <span class="nf">qdio_int_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">intparm</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cstat</span><span class="p">,</span> <span class="n">dstat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intparm</span> <span class="o">||</span> <span class="o">!</span><span class="n">irq_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;qint:%4x&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat_enabled</span><span class="p">)</span>
		<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat</span><span class="p">.</span><span class="n">qdio_int</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">irb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">irb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>:
			<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x IO error&quot;</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
			<span class="n">qdio_set_state</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">QDIO_IRQ_STATE_ERR</span><span class="p">);</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">qdio_irq_check_sense</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="n">cstat</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span><span class="p">;</span>
	<span class="n">dstat</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QDIO_IRQ_STATE_INACTIVE</span>:
		<span class="n">qdio_establish_handle_irq</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">cstat</span><span class="p">,</span> <span class="n">dstat</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QDIO_IRQ_STATE_CLEANUP</span>:
		<span class="n">qdio_set_state</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">QDIO_IRQ_STATE_INACTIVE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QDIO_IRQ_STATE_ESTABLISHED</span>:
	<span class="k">case</span> <span class="n">QDIO_IRQ_STATE_ACTIVE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cstat</span> <span class="o">&amp;</span> <span class="n">SCHN_STAT_PCI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qdio_int_handler_pci</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cstat</span> <span class="o">||</span> <span class="n">dstat</span><span class="p">)</span>
			<span class="n">qdio_handle_activate_check</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">intparm</span><span class="p">,</span> <span class="n">cstat</span><span class="p">,</span>
						   <span class="n">dstat</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QDIO_IRQ_STATE_STOPPED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qdio_get_ssqd_desc - get qdio subchannel description</span>
<span class="cm"> * @cdev: ccw device to get description for</span>
<span class="cm"> * @data: where to store the ssqd</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 or an error code. The results of the chsc are stored in the</span>
<span class="cm"> * specified structure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qdio_get_ssqd_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">qdio_ssqd_desc</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span> <span class="o">||</span> <span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="s">&quot;get ssqd:%4x&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">qdio_setup_get_ssqd</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qdio_get_ssqd_desc</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qdio_shutdown_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_input_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="n">for_each_output_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qdio_shutdown - shut down a qdio subchannel</span>
<span class="cm"> * @cdev: associated ccw device</span>
<span class="cm"> * @how: use halt or clear to shutdown</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qdio_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">how</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">irqs_disabled</span><span class="p">());</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="s">&quot;qshutdown:%4x&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Subchannel was already shot down. We cannot prevent being called</span>
<span class="cm">	 * twice since cio may trigger a shutdown asynchronously.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QDIO_IRQ_STATE_INACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Indicate that the device is going down. Scheduling the queue</span>
<span class="cm">	 * tasklets is forbidden from here on.</span>
<span class="cm">	 */</span>
	<span class="n">qdio_set_state</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">QDIO_IRQ_STATE_STOPPED</span><span class="p">);</span>

	<span class="n">tiqdio_remove_input_queues</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">);</span>
	<span class="n">qdio_shutdown_queues</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">qdio_shutdown_debug_entries</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>

	<span class="cm">/* cleanup subchannel */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">how</span> <span class="o">&amp;</span> <span class="n">QDIO_FLAG_CLEANUP_USING_CLEAR</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_clear</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">QDIO_DOING_CLEANUP</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* default behaviour is halt */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_halt</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">QDIO_DOING_CLEANUP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x SHUTD ERR&quot;</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;rc:%4d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">no_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qdio_set_state</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">QDIO_IRQ_STATE_CLEANUP</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
		<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QDIO_IRQ_STATE_INACTIVE</span> <span class="o">||</span>
		<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QDIO_IRQ_STATE_ERR</span><span class="p">,</span>
		<span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">no_cleanup:</span>
	<span class="n">qdio_shutdown_thinint</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">);</span>

	<span class="cm">/* restore interrupt handler */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">qdio_int_handler</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">orig_handler</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">qdio_set_state</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">QDIO_IRQ_STATE_INACTIVE</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qdio_shutdown</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * qdio_free - free data structures for a qdio subchannel</span>
<span class="cm"> * @cdev: associated ccw device</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qdio_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="s">&quot;qfree:%4x&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debug_area</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debug_area</span><span class="p">);</span>
		<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debug_area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="n">qdio_release_memory</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qdio_free</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * qdio_allocate - allocate qdio queues and associated data</span>
<span class="cm"> * @init_data: initialization data</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qdio_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_initialize</span> <span class="o">*</span><span class="n">init_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="s">&quot;qallocate:%4x&quot;</span><span class="p">,</span> <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">no_input_qs</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">input_handler</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">no_output_qs</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">output_handler</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">no_input_qs</span> <span class="o">&gt;</span> <span class="n">QDIO_MAX_QUEUES_PER_IRQ</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">no_output_qs</span> <span class="o">&gt;</span> <span class="n">QDIO_MAX_QUEUES_PER_IRQ</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">input_sbal_addr_array</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">output_sbal_addr_array</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* irq_ptr must be in GFP_DMA since it contains ccw1.cda */</span>
	<span class="n">irq_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
	<span class="n">qdio_allocate_dbf</span><span class="p">(</span><span class="n">init_data</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate a page for the chsc calls in qdio_establish.</span>
<span class="cm">	 * Must be pre-allocated since a zfcp recovery will call</span>
<span class="cm">	 * qdio_establish. In case of low memory and swap on a zfcp disk</span>
<span class="cm">	 * we may not be able to allocate memory otherwise.</span>
<span class="cm">	 */</span>
	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">chsc_page</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">chsc_page</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_rel</span><span class="p">;</span>

	<span class="cm">/* qdr is used in ccw1.cda which is u32 */</span>
	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">qdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">qdr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_rel</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">qdr</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdio_allocate_qs</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">no_input_qs</span><span class="p">,</span>
			     <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">no_output_qs</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_rel</span><span class="p">;</span>

	<span class="n">init_data</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span> <span class="o">=</span> <span class="n">irq_ptr</span><span class="p">;</span>
	<span class="n">qdio_set_state</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">QDIO_IRQ_STATE_INACTIVE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_rel:</span>
	<span class="n">qdio_release_memory</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qdio_allocate</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qdio_detect_hsicq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">input_qs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">use_cq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">nr_input_qs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">queue_type</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="n">QDIO_IQDIO_QFMT</span><span class="p">)</span>
		<span class="n">use_cq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">for_each_output_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_cq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qdio_enable_async_operation</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">use_cq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">qdio_disable_async_operation</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="s">&quot;use_cq:%d&quot;</span><span class="p">,</span> <span class="n">use_cq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qdio_establish - establish queues on a qdio subchannel</span>
<span class="cm"> * @init_data: initialization data</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qdio_establish</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_initialize</span> <span class="o">*</span><span class="n">init_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saveflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="s">&quot;qestablish:%4x&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>

	<span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DEV_STATE_ONLINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
	<span class="n">qdio_setup_irq</span><span class="p">(</span><span class="n">init_data</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_establish_thinint</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
		<span class="n">qdio_shutdown</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">QDIO_FLAG_CLEANUP_USING_CLEAR</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* establish q */</span>
	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">equeue</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">equeue</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">addr_t</span><span class="p">)</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">qdr</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>
	<span class="n">ccw_device_set_options_mask</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span> <span class="n">QDIO_DOING_ESTABLISH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x est IO ERR&quot;</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;rc:%4x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
		<span class="n">qdio_shutdown</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">QDIO_FLAG_CLEANUP_USING_CLEAR</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
		<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QDIO_IRQ_STATE_ESTABLISHED</span> <span class="o">||</span>
		<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QDIO_IRQ_STATE_ERR</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">QDIO_IRQ_STATE_ESTABLISHED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
		<span class="n">qdio_shutdown</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">QDIO_FLAG_CLEANUP_USING_CLEAR</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qdio_setup_ssqd_info</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">);</span>

	<span class="n">qdio_detect_hsicq</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">);</span>

	<span class="cm">/* qebsm is now setup if available, initialize buffer states */</span>
	<span class="n">qdio_init_buf_states</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
	<span class="n">qdio_print_subchannel_info</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
	<span class="n">qdio_setup_debug_entries</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qdio_establish</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * qdio_activate - activate queues on a qdio subchannel</span>
<span class="cm"> * @cdev: associated cdev</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qdio_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saveflags</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="s">&quot;qactivate:%4x&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>

	<span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DEV_STATE_ONLINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QDIO_IRQ_STATE_INACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">aqueue</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">aqueue</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">.</span><span class="n">cda</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>
	<span class="n">ccw_device_set_options</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CCWDEV_REPORT_ALL</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_device_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">ccw</span><span class="p">,</span> <span class="n">QDIO_DOING_ACTIVATE</span><span class="p">,</span>
			      <span class="mi">0</span><span class="p">,</span> <span class="n">DOIO_DENY_PREFETCH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;%4x act IO ERR&quot;</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
		<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;rc:%4x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">get_ccwdev_lock</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">saveflags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_thinint_irq</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">))</span>
		<span class="n">tiqdio_add_input_queues</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">);</span>

	<span class="cm">/* wait for subchannel to become active */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QDIO_IRQ_STATE_STOPPED</span>:
	<span class="k">case</span> <span class="n">QDIO_IRQ_STATE_ERR</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">qdio_set_state</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">QDIO_IRQ_STATE_ACTIVE</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">qdio_activate</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">buf_in_between</span><span class="p">(</span><span class="kt">int</span> <span class="n">bufnr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">add_buf</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bufnr</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">bufnr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wrap-around case */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bufnr</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">bufnr</span> <span class="o">&lt;=</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bufnr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * handle_inbound - reset processed input buffers</span>
<span class="cm"> * @q: queue containing the buffers</span>
<span class="cm"> * @callflags: flags</span>
<span class="cm"> * @bufnr: first buffer to process</span>
<span class="cm"> * @count: how many buffers are emptied</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_inbound</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">callflags</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">bufnr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">used</span><span class="p">,</span> <span class="n">diff</span><span class="p">;</span>

	<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">inbound_call</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">polling</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">set</span><span class="p">;</span>

	<span class="cm">/* protect against stop polling setting an ACK for an emptied slsb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* overwriting everything, just delete polling status */</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">set</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf_in_between</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_start</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_qebsm</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* partial overwrite, just update ack_start */</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="n">add_buf</span><span class="p">(</span><span class="n">bufnr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="n">sub_buf</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_start</span><span class="p">);</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_count</span> <span class="o">-=</span> <span class="n">diff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">set</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_start</span> <span class="o">=</span> <span class="n">add_buf</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_start</span><span class="p">,</span> <span class="n">diff</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="cm">/* the only ACK will be deleted, so stop polling */</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">polling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">set:</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">set_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">,</span> <span class="n">SLSB_CU_INPUT_EMPTY</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">used</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_buf_used</span><span class="p">)</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">used</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_siga_in</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">qdio_siga_input</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * handle_outbound - process filled outbound buffers</span>
<span class="cm"> * @q: queue containing the buffers</span>
<span class="cm"> * @callflags: flags</span>
<span class="cm"> * @bufnr: first buffer to process</span>
<span class="cm"> * @count: how many buffers are filled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_outbound</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">callflags</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">bufnr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">used</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">outbound_call</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">set_buf_states</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">,</span> <span class="n">SLSB_CU_OUTPUT_PRIMED</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">used</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_buf_used</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">used</span> <span class="o">&gt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">used</span> <span class="o">==</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">)</span>
		<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">outbound_queue_full</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">callflags</span> <span class="o">&amp;</span> <span class="n">QDIO_FLAG_PCI_OUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">pci_out_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">pci_request_int</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">pci_out_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue_type</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="n">QDIO_IQDIO_QFMT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_aob</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* One SIGA-W per buffer required for unicast HSI */</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">multicast_outbound</span><span class="p">(</span><span class="n">q</span><span class="p">));</span>

		<span class="n">phys_aob</span> <span class="o">=</span> <span class="n">qdio_aob_for_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_kick_outbound_q</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">phys_aob</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">need_siga_sync</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_siga_sync_q</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* try to fast requeue buffers */</span>
		<span class="n">get_buf_state</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">prev_buf</span><span class="p">(</span><span class="n">bufnr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SLSB_CU_OUTPUT_PRIMED</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_kick_outbound_q</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">qperf_inc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">fast_requeue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* in case of SIGA errors we must process the error immediately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">used</span> <span class="o">&gt;=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">scan_threshold</span> <span class="o">||</span> <span class="n">rc</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* free the SBALs in case of no further traffic */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">timer</span><span class="p">))</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_QDIO - process input or output buffers</span>
<span class="cm"> * @cdev: associated ccw_device for the qdio subchannel</span>
<span class="cm"> * @callflags: input or output and special flags from the program</span>
<span class="cm"> * @q_nr: queue number</span>
<span class="cm"> * @bufnr: buffer number</span>
<span class="cm"> * @count: how many buffers to process</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">do_QDIO</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">callflags</span><span class="p">,</span>
	    <span class="kt">int</span> <span class="n">q_nr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufnr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">bufnr</span> <span class="o">&gt;=</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_INFO</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="p">,</span>
		      <span class="s">&quot;do%02x b:%02x c:%02x&quot;</span><span class="p">,</span> <span class="n">callflags</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">QDIO_IRQ_STATE_ACTIVE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">callflags</span> <span class="o">&amp;</span> <span class="n">QDIO_FLAG_SYNC_INPUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">handle_inbound</span><span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">input_qs</span><span class="p">[</span><span class="n">q_nr</span><span class="p">],</span>
				      <span class="n">callflags</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">callflags</span> <span class="o">&amp;</span> <span class="n">QDIO_FLAG_SYNC_OUTPUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">handle_outbound</span><span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">output_qs</span><span class="p">[</span><span class="n">q_nr</span><span class="p">],</span>
				       <span class="n">callflags</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">do_QDIO</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * qdio_start_irq - process input buffers</span>
<span class="cm"> * @cdev: associated ccw_device for the qdio subchannel</span>
<span class="cm"> * @nr: input queue number</span>
<span class="cm"> *</span>
<span class="cm"> * Return codes</span>
<span class="cm"> *   0 - success</span>
<span class="cm"> *   1 - irqs not started since new data is available</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qdio_start_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">input_qs</span><span class="p">[</span><span class="n">nr</span><span class="p">];</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">queue_irqs_enabled</span><span class="p">(</span><span class="n">q</span><span class="p">));</span>

	<span class="n">clear_nonshared_ind</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">);</span>
	<span class="n">qdio_stop_polling</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QDIO_QUEUE_IRQS_DISABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">queue_irq_state</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to check again to not lose initiative after</span>
<span class="cm">	 * resetting the ACK state.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_nonshared_ind</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rescan</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdio_inbound_q_done</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rescan</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">rescan:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">QDIO_QUEUE_IRQS_DISABLED</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">queue_irq_state</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qdio_start_irq</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * qdio_get_next_buffers - process input buffers</span>
<span class="cm"> * @cdev: associated ccw_device for the qdio subchannel</span>
<span class="cm"> * @nr: input queue number</span>
<span class="cm"> * @bufnr: first filled buffer number</span>
<span class="cm"> * @error: buffers are in error state</span>
<span class="cm"> *</span>
<span class="cm"> * Return codes</span>
<span class="cm"> *   &lt; 0 - error</span>
<span class="cm"> *   = 0 - no new buffers found</span>
<span class="cm"> *   &gt; 0 - number of processed buffers</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qdio_get_next_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bufnr</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">input_qs</span><span class="p">[</span><span class="n">nr</span><span class="p">];</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">queue_irqs_enabled</span><span class="p">(</span><span class="n">q</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Cannot rely on automatic sync after interrupt since queues may</span>
<span class="cm">	 * also be examined without interrupt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_siga_sync</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="n">qdio_sync_queues</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="cm">/* check the PCI capable outbound queues. */</span>
	<span class="n">qdio_check_outbound_after_thinint</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdio_inbound_q_moved</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Note: upper-layer MUST stop processing immediately here ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">QDIO_IRQ_STATE_ACTIVE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_kick</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bufnr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qdio_error</span><span class="p">;</span>

	<span class="cm">/* for the next time */</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_kick</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">qdio_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sub_buf</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qdio_get_next_buffers</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * qdio_stop_irq - disable interrupt processing for the device</span>
<span class="cm"> * @cdev: associated ccw_device for the qdio subchannel</span>
<span class="cm"> * @nr: input queue number</span>
<span class="cm"> *</span>
<span class="cm"> * Return codes</span>
<span class="cm"> *   0 - interrupts were already disabled</span>
<span class="cm"> *   1 - interrupts successfully disabled</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">qdio_stop_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">qdio_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">input_qs</span><span class="p">[</span><span class="n">nr</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">QDIO_QUEUE_IRQS_DISABLED</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">queue_irq_state</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">qdio_stop_irq</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_QDIO</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_debug_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qdio_setup_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_debug</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tiqdio_allocate_memory</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_cache</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tiqdio_register_thinints</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_ti</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_ti:</span>
	<span class="n">tiqdio_free_memory</span><span class="p">();</span>
<span class="nl">out_cache:</span>
	<span class="n">qdio_setup_exit</span><span class="p">();</span>
<span class="nl">out_debug:</span>
	<span class="n">qdio_debug_exit</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_QDIO</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tiqdio_unregister_thinints</span><span class="p">();</span>
	<span class="n">tiqdio_free_memory</span><span class="p">();</span>
	<span class="n">qdio_setup_exit</span><span class="p">();</span>
	<span class="n">qdio_debug_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_QDIO</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_QDIO</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
