<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › cio › device_pgid.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>device_pgid.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  CCW device PGID and path verification I/O handling.</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright IBM Corp. 2002,2009</span>
<span class="cm"> *    Author(s): Cornelia Huck &lt;cornelia.huck@de.ibm.com&gt;</span>
<span class="cm"> *		 Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;</span>
<span class="cm"> *		 Peter Oberparleiter &lt;peter.oberparleiter@de.ibm.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/ccwdev.h&gt;</span>
<span class="cp">#include &lt;asm/cio.h&gt;</span>

<span class="cp">#include &quot;cio.h&quot;</span>
<span class="cp">#include &quot;cio_debug.h&quot;</span>
<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;io_sch.h&quot;</span>

<span class="cp">#define PGID_RETRIES	256</span>
<span class="cp">#define PGID_TIMEOUT	(10 * HZ)</span>

<span class="cm">/*</span>
<span class="cm"> * Process path verification data and report result.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">verify_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mpath</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mpath</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pgroup</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pgroup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* Ensure consistent multipathing state at device and channel. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mp</span> <span class="o">!=</span> <span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mpath</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cio_commit_config</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;vrfy: device 0.%x.%04x: rc=%d pgroup=%d mpath=%d &quot;</span>
			 <span class="s">&quot;vpm=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">pgroup</span><span class="p">,</span> <span class="n">mpath</span><span class="p">,</span>
			 <span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span><span class="p">);</span>
	<span class="n">ccw_device_verify_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create channel program to perform a NOOP.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nop_build_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iccws</span><span class="p">;</span>

	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_NOOP</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cda</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">count</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cp</span>		<span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform NOOP on a single path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nop_do</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="cm">/* Adjust lpm. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">lpm_adjust</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">pam</span> <span class="o">&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">opm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nopath</span><span class="p">;</span>
	<span class="n">nop_build_cp</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">ccw_request_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_nopath:</span>
	<span class="n">verify_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Adjust NOOP I/O status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">io_status</span> <span class="nf">nop_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">,</span> <span class="k">enum</span> <span class="n">io_status</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Only subchannel status might indicate a path error. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">IO_STATUS_ERROR</span> <span class="o">&amp;&amp;</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cstat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IO_DONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process NOOP request result for a single path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nop_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span> <span class="o">|=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nop_do</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">verify_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create channel program to perform SET PGID on a single path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">spid_build_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iccws</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">ffs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pgid</span> <span class="o">*</span><span class="n">pgid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">pgid</span><span class="o">-&gt;</span><span class="n">inf</span><span class="p">.</span><span class="n">fc</span>	<span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_SET_PGID</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cda</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">pgid</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">count</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pgid</span><span class="p">);</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cp</span>		<span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform establish/resign SET PGID on a single path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">spid_do</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fn</span><span class="p">;</span>

	<span class="cm">/* Use next available path that is not already in correct state. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">lpm_adjust</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_todo_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nopath</span><span class="p">;</span>
	<span class="cm">/* Channel program setup. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">opm</span><span class="p">)</span>
		<span class="n">fn</span> <span class="o">=</span> <span class="n">SPID_FUNC_ESTABLISH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fn</span> <span class="o">=</span> <span class="n">SPID_FUNC_RESIGN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mpath</span><span class="p">)</span>
		<span class="n">fn</span> <span class="o">|=</span> <span class="n">SPID_FUNC_MULTI_PATH</span><span class="p">;</span>
	<span class="n">spid_build_cp</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="n">ccw_request_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_nopath:</span>
	<span class="n">verify_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">verify_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Process SET PGID request result for a single path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">spid_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span> <span class="o">|=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">opm</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EACCES</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Try without multipathing. */</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mpath</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_restart</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Try without pathgrouping. */</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pgroup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_restart</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spid_do</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_restart:</span>
	<span class="n">verify_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">verify_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">spid_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="cm">/* Initialize request data. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout</span>	<span class="o">=</span> <span class="n">PGID_TIMEOUT</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">maxretries</span>	<span class="o">=</span> <span class="n">PGID_RETRIES</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span>	<span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">singlepath</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">callback</span>	<span class="o">=</span> <span class="n">spid_callback</span><span class="p">;</span>
	<span class="n">spid_do</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pgid_is_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pgid</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pgid_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pgid</span> <span class="o">*</span><span class="n">p1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pgid</span> <span class="o">*</span><span class="n">p2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">memcmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pgid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Determine pathgroup state from PGID data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pgid_analyze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pgid</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="o">*</span><span class="n">mismatch</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">reserved</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pgid</span> <span class="o">*</span><span class="n">pgid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pgid</span> <span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lpm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="o">*</span><span class="n">mismatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpm</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">pgid</span><span class="o">++</span><span class="p">,</span> <span class="n">lpm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_valid_mask</span> <span class="o">&amp;</span> <span class="n">lpm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pgid</span><span class="o">-&gt;</span><span class="n">inf</span><span class="p">.</span><span class="n">ps</span><span class="p">.</span><span class="n">state2</span> <span class="o">==</span> <span class="n">SNID_STATE2_RESVD_ELSE</span><span class="p">)</span>
			<span class="o">*</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pgid_is_reset</span><span class="p">(</span><span class="n">pgid</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">reset</span> <span class="o">|=</span> <span class="n">lpm</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">first</span> <span class="o">=</span> <span class="n">pgid</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pgid_cmp</span><span class="p">(</span><span class="n">pgid</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">mismatch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
		<span class="n">first</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">channel_subsystems</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">global_pgid</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">pgid_to_donepm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pgid</span> <span class="o">*</span><span class="n">pgid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lpm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">donepm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set bits for paths which are already in the target state. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpm</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_valid_mask</span> <span class="o">&amp;</span> <span class="n">lpm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pgid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">opm</span> <span class="o">&amp;</span> <span class="n">lpm</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pgid</span><span class="o">-&gt;</span><span class="n">inf</span><span class="p">.</span><span class="n">ps</span><span class="p">.</span><span class="n">state1</span> <span class="o">!=</span> <span class="n">SNID_STATE1_GROUPED</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pgid</span><span class="o">-&gt;</span><span class="n">inf</span><span class="p">.</span><span class="n">ps</span><span class="p">.</span><span class="n">state1</span> <span class="o">!=</span> <span class="n">SNID_STATE1_UNGROUPED</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mpath</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pgid</span><span class="o">-&gt;</span><span class="n">inf</span><span class="p">.</span><span class="n">ps</span><span class="p">.</span><span class="n">state3</span> <span class="o">!=</span> <span class="n">SNID_STATE3_MULTI_PATH</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pgid</span><span class="o">-&gt;</span><span class="n">inf</span><span class="p">.</span><span class="n">ps</span><span class="p">.</span><span class="n">state3</span> <span class="o">!=</span> <span class="n">SNID_STATE3_SINGLE_PATH</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">donepm</span> <span class="o">|=</span> <span class="n">lpm</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">donepm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pgid_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pgid</span> <span class="o">*</span><span class="n">pgid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pgid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pgid</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process SENSE PGID data and report result.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snid_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pgid</span> <span class="o">*</span><span class="n">pgid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mismatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">donepm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">pgid_analyze</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mismatch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reserved</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reserved</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EUSERS</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mismatch</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">donepm</span> <span class="o">=</span> <span class="n">pgid_to_donepm</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span> <span class="o">=</span> <span class="n">donepm</span> <span class="o">&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">opm</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_todo_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">donepm</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_reset_mask</span> <span class="o">|=</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">pgid_fill</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">pgid</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;snid: device 0.%x.%04x: rc=%d pvm=%02x vpm=%02x &quot;</span>
		      <span class="s">&quot;todo=%02x mism=%d rsvd=%d reset=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
		      <span class="n">id</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_valid_mask</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span><span class="p">,</span>
		      <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_todo_mask</span><span class="p">,</span> <span class="n">mismatch</span><span class="p">,</span> <span class="n">reserved</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Anything left to do? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_todo_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">verify_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="n">EACCES</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Perform path-grouping. */</span>
		<span class="n">spid_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span>:
		<span class="cm">/* Path-grouping not supported. */</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pgroup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mpath</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">verify_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">verify_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create channel program to perform a SENSE PGID on a single path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snid_build_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iccws</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">ffs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">);</span>

	<span class="cm">/* Channel program setup. */</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cmd_code</span>	<span class="o">=</span> <span class="n">CCW_CMD_SENSE_PGID</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cda</span>		<span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">count</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pgid</span><span class="p">);</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CCW_FLAG_SLI</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cp</span>		<span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform SENSE PGID on a single path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snid_do</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="cm">/* Adjust lpm if paths are not set in pam. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">lpm_adjust</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">pam</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nopath</span><span class="p">;</span>
	<span class="n">snid_build_cp</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">ccw_request_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_nopath:</span>
	<span class="n">snid_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_valid_mask</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process SENSE PGID request result for single path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snid_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_valid_mask</span> <span class="o">|=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">snid_do</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">snid_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform path verification.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">verify_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="o">*</span><span class="n">devid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">;</span>

	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">pam</span><span class="p">;</span>
	<span class="cm">/* Initialize request data. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout</span>	<span class="o">=</span> <span class="n">PGID_TIMEOUT</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">maxretries</span>	<span class="o">=</span> <span class="n">PGID_RETRIES</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span>	<span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">singlepath</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pgroup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;snid&quot;</span><span class="p">);</span>
		<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">devid</span><span class="p">));</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">callback</span>	<span class="o">=</span> <span class="n">snid_callback</span><span class="p">;</span>
		<span class="n">snid_do</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;nop&quot;</span><span class="p">);</span>
		<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">devid</span><span class="p">));</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">filter</span>	<span class="o">=</span> <span class="n">nop_filter</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">callback</span>	<span class="o">=</span> <span class="n">nop_callback</span><span class="p">;</span>
		<span class="n">nop_do</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ccw_device_verify_start - perform path verification</span>
<span class="cm"> * @cdev: ccw device</span>
<span class="cm"> *</span>
<span class="cm"> * Perform an I/O on each available channel path to @cdev to determine which</span>
<span class="cm"> * paths are operational. The resulting path mask is stored in sch-&gt;vpm.</span>
<span class="cm"> * If device options specify pathgrouping, establish a pathgroup for the</span>
<span class="cm"> * operational paths. When finished, call ccw_device_verify_done with a</span>
<span class="cm"> * return code specifying the result.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ccw_device_verify_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;vrfy&quot;</span><span class="p">);</span>
	<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">));</span>
	<span class="cm">/* Initialize PGID data. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid</span><span class="p">));</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_valid_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_todo_mask</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">pam</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Initialize pathgroup and multipath state with target values.</span>
<span class="cm">	 * They may change in the course of path verification.</span>
<span class="cm">	 */</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pgroup</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">pgroup</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mpath</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">mpath</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">doverify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">verify_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process disband SET PGID request result.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">disband_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* Ensure consistent multipathing state at device and channel. */</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mpath</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cio_commit_config</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;disb: device 0.%x.%04x: rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">,</span>
		      <span class="n">rc</span><span class="p">);</span>
	<span class="n">ccw_device_disband_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ccw_device_disband_start - disband pathgroup</span>
<span class="cm"> * @cdev: ccw device</span>
<span class="cm"> *</span>
<span class="cm"> * Execute a SET PGID channel program on @cdev to disband a previously</span>
<span class="cm"> * established pathgroup. When finished, call ccw_device_disband_done with</span>
<span class="cm"> * a return code specifying the result.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ccw_device_disband_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fn</span><span class="p">;</span>

	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;disb&quot;</span><span class="p">);</span>
	<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">));</span>
	<span class="cm">/* Request setup. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout</span>	<span class="o">=</span> <span class="n">PGID_TIMEOUT</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">maxretries</span>	<span class="o">=</span> <span class="n">PGID_RETRIES</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span>	<span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">pam</span> <span class="o">&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">opm</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">singlepath</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">callback</span>	<span class="o">=</span> <span class="n">disband_callback</span><span class="p">;</span>
	<span class="n">fn</span> <span class="o">=</span> <span class="n">SPID_FUNC_DISBAND</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mpath</span><span class="p">)</span>
		<span class="n">fn</span> <span class="o">|=</span> <span class="n">SPID_FUNC_MULTI_PATH</span><span class="p">;</span>
	<span class="n">spid_build_cp</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="n">ccw_request_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stlck_build_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf1</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iccws</span><span class="p">;</span>

	<span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_STLCK</span><span class="p">;</span>
	<span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">buf1</span><span class="p">;</span>
	<span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CCW_FLAG_CC</span><span class="p">;</span>
	<span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cmd_code</span> <span class="o">=</span> <span class="n">CCW_CMD_RELEASE</span><span class="p">;</span>
	<span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cda</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">buf2</span><span class="p">;</span>
	<span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cp</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stlck_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccw_device_stlck_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ccw_device_stlck_start - perform unconditional release</span>
<span class="cm"> * @cdev: ccw device</span>
<span class="cm"> * @data: data pointer to be passed to ccw_device_stlck_done</span>
<span class="cm"> * @buf1: data pointer used in channel program</span>
<span class="cm"> * @buf2: data pointer used in channel program</span>
<span class="cm"> *</span>
<span class="cm"> * Execute a channel program on @cdev to release an existing PGID reservation.</span>
<span class="cm"> * When finished, call ccw_device_stlck_done with a return code specifying the</span>
<span class="cm"> * result.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ccw_device_stlck_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf1</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">buf2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccw_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;stlck&quot;</span><span class="p">);</span>
	<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">));</span>
	<span class="cm">/* Request setup. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout</span>	<span class="o">=</span> <span class="n">PGID_TIMEOUT</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">maxretries</span>	<span class="o">=</span> <span class="n">PGID_RETRIES</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">lpm</span>	<span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">pam</span> <span class="o">&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">opm</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span>	<span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">callback</span>	<span class="o">=</span> <span class="n">stlck_callback</span><span class="p">;</span>
	<span class="n">stlck_build_cp</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">buf1</span><span class="p">,</span> <span class="n">buf2</span><span class="p">);</span>
	<span class="n">ccw_request_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
