<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › cio › device_fsm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>device_fsm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/s390/cio/device_fsm.c</span>
<span class="cm"> * finite state machine for device handling</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright IBM Corp. 2002,2008</span>
<span class="cm"> *    Author(s): Cornelia Huck (cornelia.huck@de.ibm.com)</span>
<span class="cm"> *		 Martin Schwidefsky (schwidefsky@de.ibm.com)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>

<span class="cp">#include &lt;asm/ccwdev.h&gt;</span>
<span class="cp">#include &lt;asm/cio.h&gt;</span>
<span class="cp">#include &lt;asm/chpid.h&gt;</span>

<span class="cp">#include &quot;cio.h&quot;</span>
<span class="cp">#include &quot;cio_debug.h&quot;</span>
<span class="cp">#include &quot;css.h&quot;</span>
<span class="cp">#include &quot;device.h&quot;</span>
<span class="cp">#include &quot;chsc.h&quot;</span>
<span class="cp">#include &quot;ioasm.h&quot;</span>
<span class="cp">#include &quot;chp.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">timeout_log_enabled</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ccw_timeout_log_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timeout_log_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;ccw_timeout_log&quot;</span><span class="p">,</span> <span class="n">ccw_timeout_log_setup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccw_timeout_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">schib</span> <span class="n">schib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io_subchannel_private</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">orb</span> <span class="o">*</span><span class="n">orb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cc</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">private</span> <span class="o">=</span> <span class="n">to_io_private</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="n">orb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">orb</span><span class="p">;</span>
	<span class="n">cc</span> <span class="o">=</span> <span class="n">stsch_err</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: ccw device timeout occurred at %llx, &quot;</span>
	       <span class="s">&quot;device information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_clock</span><span class="p">());</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: orb:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;cio:  &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">orb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">orb</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: ccw device bus id: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: subchannel bus id: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: subchannel lpm: %02x, opm: %02x, &quot;</span>
	       <span class="s">&quot;vpm: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">opm</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orb</span><span class="o">-&gt;</span><span class="n">tm</span><span class="p">.</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: orb indicates transport mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: last tcw:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;cio:  &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span><span class="n">orb</span><span class="o">-&gt;</span><span class="n">tm</span><span class="p">.</span><span class="n">tcw</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcw</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: orb indicates command mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span><span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">sense_ccw</span> <span class="o">||</span>
		    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span><span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span> <span class="o">==</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iccws</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: last channel program &quot;</span>
			       <span class="s">&quot;(intern):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: last channel program:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;cio:  &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span><span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw1</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: ccw device state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: store subchannel returned: cc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: schib:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;cio:  &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">schib</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">schib</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cio: ccw device flags:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;cio:  &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Timeout function. It just triggers a DEV_EVENT_TIMEOUT.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">;</span>

	<span class="n">cdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ccwlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout_log_enabled</span><span class="p">)</span>
		<span class="n">ccw_timeout_log</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">dev_fsm_event</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_EVENT_TIMEOUT</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ccwlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set timeout</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ccw_device_set_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">expires</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expires</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">expires</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ccw_device_timeout</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cdev</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">expires</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cancel running i/o. This is called repeatedly since halt/clear are</span>
<span class="cm"> * asynchronous operations. We do one try with cio_cancel, two tries</span>
<span class="cm"> * with cio_halt, 255 tries with cio_clear. If everythings fails panic.</span>
<span class="cm"> * Returns 0 if device now idle, -ENODEV for device not operational and</span>
<span class="cm"> * -EBUSY if an interrupt is expected (either from halt/clear or from a</span>
<span class="cm"> * status pending).</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ccw_device_cancel_halt_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_update_schib</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span> 
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">ena</span><span class="p">)</span>
		<span class="cm">/* Not operational -&gt; done. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Stage 1: cancel io. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scsw_actl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSW_ACTL_HALT_PEND</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">scsw_actl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSW_ACTL_CLEAR_PEND</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsw_is_tm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">cio_cancel</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* cancel io unsuccessful or not applicable (transport mode).</span>
<span class="cm">		 * Continue with asynchronous instructions. */</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iretry</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* 3 halt retries. */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scsw_actl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSW_ACTL_CLEAR_PEND</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Stage 2: halt io. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iretry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iretry</span><span class="o">--</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">cio_halt</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* halt io unsuccessful. */</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iretry</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>	<span class="cm">/* 255 clear retries. */</span>
	<span class="p">}</span>
	<span class="cm">/* Stage 3: clear io. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iretry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iretry</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cio_clear</span> <span class="p">(</span><span class="n">sch</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Function was unsuccessful */</span>
	<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;0.%x.%04x: could not stop I/O</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ccw_device_update_sense_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">cu_type</span>   <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">senseid</span><span class="p">.</span><span class="n">cu_type</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">cu_model</span>  <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">senseid</span><span class="p">.</span><span class="n">cu_model</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">dev_type</span>  <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">senseid</span><span class="p">.</span><span class="n">dev_type</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">dev_model</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">senseid</span><span class="p">.</span><span class="n">dev_model</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ccw_device_test_sense_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">cu_type</span> <span class="o">==</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">senseid</span><span class="p">.</span><span class="n">cu_type</span> <span class="o">&amp;&amp;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">cu_model</span> <span class="o">==</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">senseid</span><span class="p">.</span><span class="n">cu_model</span> <span class="o">&amp;&amp;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">senseid</span><span class="p">.</span><span class="n">dev_type</span> <span class="o">&amp;&amp;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">dev_model</span> <span class="o">==</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">senseid</span><span class="p">.</span><span class="n">dev_model</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The machine won&#39;t give us any notification by machine check if a chpid has</span>
<span class="cm"> * been varied online on the SE so we have to find out by magic (i. e. driving</span>
<span class="cm"> * the channel subsystem to device selection and updating our path masks).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__recover_lost_chpids</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">old_lpm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chp_id</span> <span class="n">chpid</span><span class="p">;</span>

	<span class="n">chp_id_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chpid</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_lpm</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">chpid</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">chpid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chp_is_registered</span><span class="p">(</span><span class="n">chpid</span><span class="p">))</span>
			<span class="n">css_schedule_eval_all</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop device recognition.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_recog_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_lpm</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cio_disable_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_NOT_OPER</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now that we tried recognition, we have performed device selection</span>
<span class="cm">	 * through ssch() and the path information is up to date.</span>
<span class="cm">	 */</span>
	<span class="n">old_lpm</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">;</span>

	<span class="cm">/* Check since device may again have become not operational. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_update_schib</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_NOT_OPER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">pam</span> <span class="o">&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">opm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DEV_STATE_DISCONNECTED_SENSE_ID</span><span class="p">)</span>
		<span class="cm">/* Force reprobe on all chpids. */</span>
		<span class="n">old_lpm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">!=</span> <span class="n">old_lpm</span><span class="p">)</span>
		<span class="n">__recover_lost_chpids</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">old_lpm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DEV_STATE_DISCONNECTED_SENSE_ID</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">DEV_STATE_NOT_OPER</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">DEV_STATE_BOXED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">recog_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_DISCONNECTED</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">resuming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">recog_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEV_STATE_NOT_OPER</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEV_STATE_OFFLINE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccw_device_update_sense_data</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_OFFLINE</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">recog_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccw_device_test_sense_data</span><span class="p">(</span><span class="n">cdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">donotify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ccw_device_online</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ccw_device_update_sense_data</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
			<span class="n">ccw_device_sched_todo</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CDEV_TODO_REBIND</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEV_STATE_BOXED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">cu_type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* device was recognized before */</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">recog_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_BOXED</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">io_subchannel_recog_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function called from device_id.c after sense id has completed.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ccw_device_sense_id_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">ccw_device_recog_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_OFFLINE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIME</span>:		<span class="cm">/* Sense id stopped by timeout. */</span>
		<span class="n">ccw_device_recog_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_BOXED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ccw_device_recog_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_NOT_OPER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">  * ccw_device_notify() - inform the device&#39;s driver about an event</span>
<span class="cm">  * @cdev: device for which an event occurred</span>
<span class="cm">  * @event: event that occurred</span>
<span class="cm">  *</span>
<span class="cm">  * Returns:</span>
<span class="cm">  *   -%EINVAL if the device is offline or has no driver.</span>
<span class="cm">  *   -%EOPNOTSUPP if the device&#39;s driver has no notifier registered.</span>
<span class="cm">  *   %NOTIFY_OK if the driver wants to keep the device.</span>
<span class="cm">  *   %NOTIFY_BAD if the driver doesn&#39;t want to keep the device.</span>
<span class="cm">  */</span>
<span class="kt">int</span> <span class="nf">ccw_device_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;notify called for 0.%x.%04x, event=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">,</span>
		      <span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_BAD</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccw_device_oper_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccw_device_notify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CIO_OPER</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reenable channel measurements, if needed. */</span>
		<span class="n">ccw_device_sched_todo</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CDEV_TODO_ENABLE_CMF</span><span class="p">);</span>
		<span class="cm">/* Save indication for new paths. */</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">path_new_mask</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Driver doesn&#39;t want device back. */</span>
	<span class="n">ccw_device_set_notoper</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">ccw_device_sched_todo</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CDEV_TODO_REBIND</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Finished with online/offline processing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">ccw_device_set_timeout</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DEV_STATE_ONLINE</span><span class="p">)</span>
		<span class="n">cio_disable_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>

	<span class="cm">/* Reset device status. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irb</span><span class="p">));</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEV_STATE_BOXED</span>:
		<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Boxed device %04x on subchannel %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ccw_device_notify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CIO_BOXED</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NOTIFY_OK</span><span class="p">)</span>
			<span class="n">ccw_device_sched_todo</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CDEV_TODO_UNREG</span><span class="p">);</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">donotify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEV_STATE_NOT_OPER</span>:
		<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Device %04x gone on subchannel %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccw_device_notify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CIO_GONE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NOTIFY_OK</span><span class="p">)</span>
			<span class="n">ccw_device_sched_todo</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CDEV_TODO_UNREG</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ccw_device_set_disconnected</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">donotify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEV_STATE_DISCONNECTED</span>:
		<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Disconnected device %04x on subchannel &quot;</span>
			      <span class="s">&quot;%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">,</span>
			      <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccw_device_notify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CIO_NO_PATH</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NOTIFY_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_NOT_OPER</span><span class="p">;</span>
			<span class="n">ccw_device_sched_todo</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CDEV_TODO_UNREG</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ccw_device_set_disconnected</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">donotify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">donotify</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">donotify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccw_device_oper_notify</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start device recognition.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ccw_device_recognition</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We used to start here with a sense pgid to find out whether a device</span>
<span class="cm">	 * is locked by someone else. Unfortunately, the sense pgid command</span>
<span class="cm">	 * code has other meanings on devices predating the path grouping</span>
<span class="cm">	 * algorithm, so we start with sense id and box the device after an</span>
<span class="cm">	 * timeout (or if sense pgid during path verification detects the device</span>
<span class="cm">	 * is locked, as may happen on newer devices).</span>
<span class="cm">	 */</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">recog_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_SENSE_ID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_enable_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">sch</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ccw_device_recog_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_NOT_OPER</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccw_device_sense_id_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle events for states that use the ccw request infrastructure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccw_device_request_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEV_EVENT_NOTOPER</span>:
		<span class="n">ccw_request_notoper</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEV_EVENT_INTERRUPT</span>:
		<span class="n">ccw_request_handler</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEV_EVENT_TIMEOUT</span>:
		<span class="n">ccw_request_timeout</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccw_device_report_path_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">path_event</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">chp</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">chp</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">chp</span><span class="o">++</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">path_event</span><span class="p">[</span><span class="n">chp</span><span class="p">]</span> <span class="o">=</span> <span class="n">PE_NONE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">path_gone_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span><span class="p">))</span>
			<span class="n">path_event</span><span class="p">[</span><span class="n">chp</span><span class="p">]</span> <span class="o">|=</span> <span class="n">PE_PATH_GONE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">path_new_mask</span> <span class="o">&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span><span class="p">)</span>
			<span class="n">path_event</span><span class="p">[</span><span class="n">chp</span><span class="p">]</span> <span class="o">|=</span> <span class="n">PE_PATH_AVAILABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_reset_mask</span> <span class="o">&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span><span class="p">)</span>
			<span class="n">path_event</span><span class="p">[</span><span class="n">chp</span><span class="p">]</span> <span class="o">|=</span> <span class="n">PE_PATHGROUP_ESTABLISHED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">&amp;&amp;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">path_event</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">path_event</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">path_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccw_device_reset_path_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">path_gone_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">path_new_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">pgid_reset_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">create_fake_irb</span><span class="p">(</span><span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">irb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">irb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">FAKE_CMD_IRB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cmd_scsw</span> <span class="o">*</span><span class="n">scsw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>
		<span class="n">scsw</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scsw</span><span class="o">-&gt;</span><span class="n">fctl</span> <span class="o">=</span> <span class="n">SCSW_FCTL_START_FUNC</span><span class="p">;</span>
		<span class="n">scsw</span><span class="o">-&gt;</span><span class="n">actl</span> <span class="o">=</span> <span class="n">SCSW_ACTL_START_PEND</span><span class="p">;</span>
		<span class="n">scsw</span><span class="o">-&gt;</span><span class="n">stctl</span> <span class="o">=</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">FAKE_TM_IRB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tm_scsw</span> <span class="o">*</span><span class="n">scsw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">tm</span><span class="p">;</span>
		<span class="n">scsw</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scsw</span><span class="o">-&gt;</span><span class="n">cc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scsw</span><span class="o">-&gt;</span><span class="n">fctl</span> <span class="o">=</span> <span class="n">SCSW_FCTL_START_FUNC</span><span class="p">;</span>
		<span class="n">scsw</span><span class="o">-&gt;</span><span class="n">actl</span> <span class="o">=</span> <span class="n">SCSW_ACTL_START_PEND</span><span class="p">;</span>
		<span class="n">scsw</span><span class="o">-&gt;</span><span class="n">stctl</span> <span class="o">=</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ccw_device_verify_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="cm">/* Update schib - pom may have changed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_update_schib</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">callback</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Update lpm with verified path mask. */</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">vpm</span><span class="p">;</span>
	<span class="cm">/* Repeat path verification? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">doverify</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccw_device_verify_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">callback:</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">ccw_device_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_ONLINE</span><span class="p">);</span>
		<span class="cm">/* Deliver fake irb to device driver, if needed. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fake_irb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">create_fake_irb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">,</span>
					<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fake_irb</span><span class="p">);</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fake_irb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
				<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">intparm</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irb</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">ccw_device_report_path_events</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIME</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">EUSERS</span>:
		<span class="cm">/* Reset oper notify indication after verify error. */</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">donotify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccw_device_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_BOXED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EACCES</span>:
		<span class="cm">/* Reset oper notify indication after verify error. */</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">donotify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccw_device_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_DISCONNECTED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Reset oper notify indication after verify error. */</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">donotify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccw_device_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_NOT_OPER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccw_device_reset_path_events</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get device online.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ccw_device_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DEV_STATE_OFFLINE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DEV_STATE_BOXED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cio_enable_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Couldn&#39;t enable the subchannel for i/o. Sick device. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">dev_fsm_event</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_EVENT_NOTOPER</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Start initial path verification. */</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_VERIFY</span><span class="p">;</span>
	<span class="n">ccw_device_verify_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ccw_device_disband_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">ccw_device_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_OFFLINE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIME</span>:
		<span class="n">ccw_device_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_BOXED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">donotify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccw_device_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_NOT_OPER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Shutdown device.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ccw_device_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>

	<span class="cm">/* Allow ccw_device_offline while disconnected. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DEV_STATE_DISCONNECTED</span> <span class="o">||</span>
	    <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DEV_STATE_NOT_OPER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">donotify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccw_device_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_NOT_OPER</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DEV_STATE_BOXED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccw_device_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_BOXED</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccw_device_is_orphan</span><span class="p">(</span><span class="n">cdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ccw_device_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_OFFLINE</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_update_schib</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsw_actl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DEV_STATE_ONLINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* Are we doing path grouping? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">pgroup</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No, set state offline immediately. */</span>
		<span class="n">ccw_device_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_OFFLINE</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Start Set Path Group commands. */</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_DISBAND_PGID</span><span class="p">;</span>
	<span class="n">ccw_device_disband_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle not operational event in non-special state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccw_device_generic_notoper</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccw_device_notify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CIO_GONE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NOTIFY_OK</span><span class="p">)</span>
		<span class="n">ccw_device_sched_todo</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CDEV_TODO_UNREG</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ccw_device_set_disconnected</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle path verification event in offline state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccw_device_offline_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">css_schedule_eval</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle path verification event.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_online_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DEV_STATE_W4SENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">doverify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Since we might not just be coming from an interrupt from the</span>
<span class="cm">	 * subchannel we have to update the schib.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_update_schib</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ccw_device_verify_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsw_actl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">scsw_stctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">scsw_stctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">.</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSW_STCTL_STATUS_PEND</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No final status yet or final status not yet delivered</span>
<span class="cm">		 * to the device driver. Can&#39;t do path verification now,</span>
<span class="cm">		 * delay until final status was delivered.</span>
<span class="cm">		 */</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">doverify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Device is idle, we can do the path verification. */</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_VERIFY</span><span class="p">;</span>
	<span class="n">ccw_device_verify_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle path verification event in boxed state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccw_device_boxed_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cio_enable_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">sch</span><span class="p">))</span>
			<span class="n">ccw_device_done</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_STATE_NOT_OPER</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ccw_device_online_verify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">dev_event</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">css_schedule_eval</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Got an interrupt for a normal io (state online).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_cmd</span><span class="p">;</span>

	<span class="n">irb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">irb</span><span class="p">;</span>
	<span class="n">is_cmd</span> <span class="o">=</span> <span class="o">!</span><span class="n">scsw_is_tm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">);</span>
	<span class="cm">/* Check for unsolicited interrupt. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsw_is_solicited</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_cmd</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">esw</span><span class="p">.</span><span class="n">esw0</span><span class="p">.</span><span class="n">erw</span><span class="p">.</span><span class="n">cons</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Unit check but no sense data. Need basic sense. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccw_device_do_sense</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">call_handler_unsol</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irb</span><span class="p">));</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_W4SENSE</span><span class="p">;</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">intparm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">call_handler_unsol:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">doverify</span><span class="p">)</span>
			<span class="n">ccw_device_online_verify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Accumulate status and find out if a basic sense is needed. */</span>
	<span class="n">ccw_device_accumulate_irb</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_cmd</span> <span class="o">&amp;&amp;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">dosense</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccw_device_do_sense</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_W4SENSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Call the handler. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccw_device_call_handler</span><span class="p">(</span><span class="n">cdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">doverify</span><span class="p">)</span>
		<span class="cm">/* Start delayed path verification. */</span>
		<span class="n">ccw_device_online_verify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Got an timeout in online state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_online_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ccw_device_set_timeout</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iretry</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccw_device_cancel_halt_clear</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccw_device_set_timeout</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_TIMEOUT_KILL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_fsm_event</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">DEV_EVENT_NOTOPER</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">intparm</span><span class="p">,</span>
			      <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Got an interrupt for a basic sense.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_w4sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">;</span>

	<span class="n">irb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">irb</span><span class="p">;</span>
	<span class="cm">/* Check for unsolicited interrupt. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsw_stctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">==</span>
	    <span class="p">(</span><span class="n">SCSW_STCTL_STATUS_PEND</span> <span class="o">|</span> <span class="n">SCSW_STCTL_ALERT_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsw_cc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="cm">/* Basic sense hasn&#39;t started. Try again. */</span>
			<span class="n">ccw_device_do_sense</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;0.%x.%04x: unsolicited &quot;</span>
				      <span class="s">&quot;interrupt during w4sense...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
				      <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
				<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if a halt or clear has been issued in the meanwhile. If yes,</span>
<span class="cm">	 * only deliver the halt/clear interrupt to the device driver as if it</span>
<span class="cm">	 * had killed the original request.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsw_fctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">SCSW_FCTL_CLEAR_FUNC</span> <span class="o">|</span> <span class="n">SCSW_FCTL_HALT_FUNC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">dosense</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">irb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irb</span><span class="p">));</span>
		<span class="n">ccw_device_accumulate_irb</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">call_handler</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Add basic sense info to irb. */</span>
	<span class="n">ccw_device_accumulate_basic_sense</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">dosense</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Another basic sense is needed. */</span>
		<span class="n">ccw_device_do_sense</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">call_handler:</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_ONLINE</span><span class="p">;</span>
	<span class="cm">/* In case sensing interfered with setting the device online */</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
	<span class="cm">/* Call the handler. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccw_device_call_handler</span><span class="p">(</span><span class="n">cdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">doverify</span><span class="p">)</span>
		<span class="cm">/* Start delayed path verification. */</span>
		<span class="n">ccw_device_online_verify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_killing_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccw_device_set_timeout</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Start delayed path verification. */</span>
	<span class="n">ccw_device_online_verify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* OK, i/o is dead now. Call interrupt handler. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">intparm</span><span class="p">,</span>
			      <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_killing_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccw_device_cancel_halt_clear</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccw_device_set_timeout</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Start delayed path verification. */</span>
	<span class="n">ccw_device_online_verify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">intparm</span><span class="p">,</span>
			      <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ccw_device_kill_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">iretry</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccw_device_cancel_halt_clear</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccw_device_set_timeout</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_TIMEOUT_KILL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Start delayed path verification. */</span>
	<span class="n">ccw_device_online_verify</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">intparm</span><span class="p">,</span>
			      <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_delay_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Start verification after current task finished. */</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">doverify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_start_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_enable_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span><span class="n">sch</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* Couldn&#39;t enable the subchannel for i/o. Sick device. */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_DISCONNECTED_SENSE_ID</span><span class="p">;</span>
	<span class="n">ccw_device_sense_id_start</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ccw_device_trigger_reprobe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DEV_STATE_DISCONNECTED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="cm">/* Update some values. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_update_schib</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The pim, pam, pom values may not be accurate, but they are the best</span>
<span class="cm">	 * we have before performing device selection :/</span>
<span class="cm">	 */</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">pam</span> <span class="o">&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">opm</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Use the initial configuration since we can&#39;t be shure that the old</span>
<span class="cm">	 * paths are valid.</span>
<span class="cm">	 */</span>
	<span class="n">io_subchannel_init_config</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_commit_config</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We should also udate ssd info, but this has to wait. */</span>
	<span class="cm">/* Check if this is another device which appeared on the same sch. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">)</span>
		<span class="n">css_schedule_eval</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ccw_device_start_id</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccw_device_disabled_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>

	<span class="n">sch</span> <span class="o">=</span> <span class="n">to_subchannel</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * An interrupt in a disabled state means a previous disable was not</span>
<span class="cm">	 * successful - should not happen, but we try to disable again.</span>
<span class="cm">	 */</span>
	<span class="n">cio_disable_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_change_cmfstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">retry_set_schib</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_ONLINE</span><span class="p">;</span>
	<span class="n">dev_fsm_event</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">dev_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccw_device_update_cmfblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmf_retry_copy_block</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_ONLINE</span><span class="p">;</span>
	<span class="n">dev_fsm_event</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">dev_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_quiesce_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccw_device_set_timeout</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_NOT_OPER</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_quiesce_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccw_device_cancel_halt_clear</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccw_device_set_timeout</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DEV_STATE_NOT_OPER</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">private</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * No operation action. This is used e.g. to ignore a timeout event in</span>
<span class="cm"> * state offline.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccw_device_nop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dev_event</span> <span class="n">dev_event</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * device statemachine</span>
<span class="cm"> */</span>
<span class="n">fsm_func_t</span> <span class="o">*</span><span class="n">dev_jumptable</span><span class="p">[</span><span class="n">NR_DEV_STATES</span><span class="p">][</span><span class="n">NR_DEV_EVENTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DEV_STATE_NOT_OPER</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_disabled_irq</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_SENSE_PGID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_SENSE_ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_OFFLINE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_generic_notoper</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_disabled_irq</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_offline_verify</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_VERIFY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_delay_verify</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_ONLINE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_generic_notoper</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_irq</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_online_timeout</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_online_verify</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_W4SENSE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_generic_notoper</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_w4sense</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_online_verify</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_DISBAND_PGID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_BOXED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_generic_notoper</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_boxed_verify</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* states to wait for i/o completion before doing something */</span>
	<span class="p">[</span><span class="n">DEV_STATE_TIMEOUT_KILL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_generic_notoper</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_killing_irq</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_killing_timeout</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span> <span class="c1">//FIXME</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_QUIESCE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_quiesce_done</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_quiesce_done</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_quiesce_timeout</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* special states for devices gone not operational */</span>
	<span class="p">[</span><span class="n">DEV_STATE_DISCONNECTED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_start_id</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_start_id</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_DISCONNECTED_SENSE_ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_CMFCHANGE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_change_cmfstate</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_change_cmfstate</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_change_cmfstate</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_change_cmfstate</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_CMFUPDATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_update_cmfblock</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_update_cmfblock</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_update_cmfblock</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_update_cmfblock</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DEV_STATE_STEAL_LOCK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">DEV_EVENT_NOTOPER</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_INTERRUPT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_TIMEOUT</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_request_event</span><span class="p">,</span>
		<span class="p">[</span><span class="n">DEV_EVENT_VERIFY</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ccw_device_nop</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ccw_device_set_timeout</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
