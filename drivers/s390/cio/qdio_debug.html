<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › cio › qdio_debug.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qdio_debug.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/s390/cio/qdio_debug.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright IBM Corp. 2008,2009</span>
<span class="cm"> *</span>
<span class="cm"> *  Author: Jan Glauber (jang@linux.vnet.ibm.com)</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;asm/debug.h&gt;</span>
<span class="cp">#include &quot;qdio_debug.h&quot;</span>
<span class="cp">#include &quot;qdio.h&quot;</span>

<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">qdio_dbf_setup</span><span class="p">;</span>
<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">qdio_dbf_error</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfs_root</span><span class="p">;</span>
<span class="cp">#define QDIO_DEBUGFS_NAME_LEN	10</span>

<span class="kt">void</span> <span class="nf">qdio_allocate_dbf</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_initialize</span> <span class="o">*</span><span class="n">init_data</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">text</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="s">&quot;qfmt:%1d&quot;</span><span class="p">,</span> <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">q_format</span><span class="p">);</span>
	<span class="n">DBF_HEX</span><span class="p">(</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">adapter_name</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="s">&quot;qpff%4x&quot;</span><span class="p">,</span> <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">qib_param_field_format</span><span class="p">);</span>
	<span class="n">DBF_HEX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">qib_param_field</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">DBF_HEX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">input_slib_elements</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">DBF_HEX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">output_slib_elements</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="s">&quot;niq:%1d noq:%1d&quot;</span><span class="p">,</span> <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">no_input_qs</span><span class="p">,</span>
		  <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">no_output_qs</span><span class="p">);</span>
	<span class="n">DBF_HEX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">input_handler</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">DBF_HEX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">output_handler</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">DBF_HEX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">int_parm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
	<span class="n">DBF_HEX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">input_sbal_addr_array</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">DBF_HEX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">output_sbal_addr_array</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="s">&quot;irq:%8lx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">irq_ptr</span><span class="p">);</span>

	<span class="cm">/* allocate trace view for the interface */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&quot;qdio_%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debug_area</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debug_area</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debug_area</span><span class="p">,</span> <span class="n">DBF_WARN</span><span class="p">);</span>
	<span class="n">DBF_DEV_EVENT</span><span class="p">(</span><span class="n">DBF_ERR</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="p">,</span> <span class="s">&quot;dbf created&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qstat_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Timestamp: %Lx  Last AI: %Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">q</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">last_ai_time</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;nr_used: %d  ftc: %d  last_move: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nr_buf_used</span><span class="p">),</span>
		   <span class="n">q</span><span class="o">-&gt;</span><span class="n">first_to_check</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">last_move</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">is_input_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;polling: %d  ack start: %d  ack count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">polling</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_start</span><span class="p">,</span>
			   <span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">ack_count</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DSCI: %d   IRQs disabled: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">dsci</span><span class="p">,</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">QDIO_QUEUE_IRQS_DISABLED</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">queue_irq_state</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;SBAL states:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;|0      |8      |16     |24     |32     |40     |48     |56  63|</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QDIO_MAX_BUFFERS_PER_Q</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug_get_buf_state</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SLSB_P_INPUT_NOT_INIT</span>:
		<span class="k">case</span> <span class="n">SLSB_P_OUTPUT_NOT_INIT</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;N&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SLSB_P_OUTPUT_PENDING</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;P&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SLSB_P_INPUT_PRIMED</span>:
		<span class="k">case</span> <span class="n">SLSB_CU_OUTPUT_PRIMED</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;+&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SLSB_P_INPUT_ACK</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SLSB_P_INPUT_ERROR</span>:
		<span class="k">case</span> <span class="n">SLSB_P_OUTPUT_ERROR</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;x&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SLSB_CU_INPUT_EMPTY</span>:
		<span class="k">case</span> <span class="n">SLSB_P_OUTPUT_EMPTY</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SLSB_P_INPUT_HALTED</span>:
		<span class="k">case</span> <span class="n">SLSB_P_OUTPUT_HALTED</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;?&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">63</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;|64     |72     |80     |88     |96     |104    |112    |   127|</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">SBAL statistics:&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">1          2..        4..        8..        &quot;</span>
		   <span class="s">&quot;16..       32..       64..       127</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">.</span><span class="n">nr_sbals</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-10u &quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">.</span><span class="n">nr_sbals</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Error      NOP        Total</span><span class="se">\n</span><span class="s">%-10u %-10u %-10u</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">.</span><span class="n">nr_sbal_error</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">.</span><span class="n">nr_sbal_nop</span><span class="p">,</span>
		   <span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">.</span><span class="n">nr_sbal_total</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qstat_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">qstat_show</span><span class="p">,</span>
			   <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">debugfs_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">qstat_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">qperf_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Assumed adapter interrupts&quot;</span><span class="p">,</span>
	<span class="s">&quot;QDIO interrupts&quot;</span><span class="p">,</span>
	<span class="s">&quot;Requested PCIs&quot;</span><span class="p">,</span>
	<span class="s">&quot;Inbound tasklet runs&quot;</span><span class="p">,</span>
	<span class="s">&quot;Inbound tasklet resched&quot;</span><span class="p">,</span>
	<span class="s">&quot;Inbound tasklet resched2&quot;</span><span class="p">,</span>
	<span class="s">&quot;Outbound tasklet runs&quot;</span><span class="p">,</span>
	<span class="s">&quot;SIGA read&quot;</span><span class="p">,</span>
	<span class="s">&quot;SIGA write&quot;</span><span class="p">,</span>
	<span class="s">&quot;SIGA sync&quot;</span><span class="p">,</span>
	<span class="s">&quot;Inbound calls&quot;</span><span class="p">,</span>
	<span class="s">&quot;Inbound handler&quot;</span><span class="p">,</span>
	<span class="s">&quot;Inbound stop_polling&quot;</span><span class="p">,</span>
	<span class="s">&quot;Inbound queue full&quot;</span><span class="p">,</span>
	<span class="s">&quot;Outbound calls&quot;</span><span class="p">,</span>
	<span class="s">&quot;Outbound handler&quot;</span><span class="p">,</span>
	<span class="s">&quot;Outbound queue full&quot;</span><span class="p">,</span>
	<span class="s">&quot;Outbound fast_requeue&quot;</span><span class="p">,</span>
	<span class="s">&quot;Outbound target_full&quot;</span><span class="p">,</span>
	<span class="s">&quot;QEBSM eqbs&quot;</span><span class="p">,</span>
	<span class="s">&quot;QEBSM eqbs partial&quot;</span><span class="p">,</span>
	<span class="s">&quot;QEBSM sqbs&quot;</span><span class="p">,</span>
	<span class="s">&quot;QEBSM sqbs partial&quot;</span><span class="p">,</span>
	<span class="s">&quot;Discarded interrupts&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qperf_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">qperf_names</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%26s:</span><span class="se">\t</span><span class="s">%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">qperf_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">*</span><span class="p">(</span><span class="n">stat</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">qperf_seq_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul_from_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat</span><span class="p">));</span>
		<span class="n">for_each_input_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">));</span>
		<span class="n">for_each_output_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q_stats</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">perf_stat_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qperf_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">qperf_show</span><span class="p">,</span>
			   <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">debugfs_perf_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">qperf_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	 <span class="o">=</span> <span class="n">qperf_seq_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_debugfs_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">QDIO_DEBUGFS_NAME_LEN</span><span class="p">];</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">QDIO_DEBUGFS_NAME_LEN</span><span class="p">,</span> <span class="s">&quot;%s_%d&quot;</span><span class="p">,</span>
		 <span class="n">q</span><span class="o">-&gt;</span><span class="n">is_input_q</span> <span class="o">?</span> <span class="s">&quot;input&quot;</span> <span class="o">:</span> <span class="s">&quot;output&quot;</span><span class="p">,</span>
		 <span class="n">q</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">debugfs_q</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debugfs_dev</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debugfs_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">debugfs_q</span><span class="p">))</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">debugfs_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qdio_setup_debug_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debugfs_dev</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
						  <span class="n">debugfs_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debugfs_dev</span><span class="p">))</span>
		<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debugfs_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debugfs_perf</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;statistics&quot;</span><span class="p">,</span>
				<span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
				<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debugfs_dev</span><span class="p">,</span> <span class="n">irq_ptr</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">debugfs_perf_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debugfs_perf</span><span class="p">))</span>
		<span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debugfs_perf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">for_each_input_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">setup_debugfs_entry</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
	<span class="n">for_each_output_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">setup_debugfs_entry</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qdio_shutdown_debug_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qdio_irq</span> <span class="o">*</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_q</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_input_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">debugfs_q</span><span class="p">);</span>
	<span class="n">for_each_output_queue</span><span class="p">(</span><span class="n">irq_ptr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">debugfs_q</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debugfs_perf</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">irq_ptr</span><span class="o">-&gt;</span><span class="n">debugfs_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">qdio_debug_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;qdio&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">qdio_dbf_setup</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="s">&quot;qdio_setup&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">qdio_dbf_setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">qdio_dbf_setup</span><span class="p">,</span> <span class="n">DBF_INFO</span><span class="p">);</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="s">&quot;dbf created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">qdio_dbf_error</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="s">&quot;qdio_error&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">qdio_dbf_error</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">qdio_dbf_error</span><span class="p">,</span> <span class="n">DBF_INFO</span><span class="p">);</span>
	<span class="n">DBF_ERROR</span><span class="p">(</span><span class="s">&quot;dbf created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qdio_debug_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">debugfs_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdio_dbf_setup</span><span class="p">)</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">qdio_dbf_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdio_dbf_error</span><span class="p">)</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">qdio_dbf_error</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
