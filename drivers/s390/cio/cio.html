<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › cio › cio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/s390/cio/cio.c</span>
<span class="cm"> *   S/390 common I/O routines -- low level i/o calls</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright IBM Corp. 1999,2008</span>
<span class="cm"> *    Author(s): Ingo Adlung (adlung@de.ibm.com)</span>
<span class="cm"> *		 Cornelia Huck (cornelia.huck@de.ibm.com)</span>
<span class="cm"> *		 Arnd Bergmann (arndb@de.ibm.com)</span>
<span class="cm"> *		 Martin Schwidefsky (schwidefsky@de.ibm.com)</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;cio&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/ftrace.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/kernel_stat.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;asm/cio.h&gt;</span>
<span class="cp">#include &lt;asm/delay.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/irq_regs.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/reset.h&gt;</span>
<span class="cp">#include &lt;asm/ipl.h&gt;</span>
<span class="cp">#include &lt;asm/chpid.h&gt;</span>
<span class="cp">#include &lt;asm/airq.h&gt;</span>
<span class="cp">#include &lt;asm/isc.h&gt;</span>
<span class="cp">#include &lt;asm/cputime.h&gt;</span>
<span class="cp">#include &lt;asm/fcx.h&gt;</span>
<span class="cp">#include &lt;asm/nmi.h&gt;</span>
<span class="cp">#include &lt;asm/crw.h&gt;</span>
<span class="cp">#include &quot;cio.h&quot;</span>
<span class="cp">#include &quot;css.h&quot;</span>
<span class="cp">#include &quot;chsc.h&quot;</span>
<span class="cp">#include &quot;ioasm.h&quot;</span>
<span class="cp">#include &quot;io_sch.h&quot;</span>
<span class="cp">#include &quot;blacklist.h&quot;</span>
<span class="cp">#include &quot;cio_debug.h&quot;</span>
<span class="cp">#include &quot;chp.h&quot;</span>

<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">cio_debug_msg_id</span><span class="p">;</span>
<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">cio_debug_trace_id</span><span class="p">;</span>
<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">cio_debug_crw_id</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Function: cio_debug_init</span>
<span class="cm"> * Initializes three debug logs for common I/O:</span>
<span class="cm"> * - cio_msg logs generic cio messages</span>
<span class="cm"> * - cio_trace logs the calling of different functions</span>
<span class="cm"> * - cio_crw logs machine check related cio messages</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cio_debug_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cio_debug_msg_id</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="s">&quot;cio_msg&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cio_debug_msg_id</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">cio_debug_msg_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_sprintf_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">cio_debug_msg_id</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">cio_debug_trace_id</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="s">&quot;cio_trace&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cio_debug_trace_id</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">cio_debug_trace_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">cio_debug_trace_id</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">cio_debug_crw_id</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="s">&quot;cio_crw&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cio_debug_crw_id</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">cio_debug_crw_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_sprintf_view</span><span class="p">);</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">cio_debug_crw_id</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unregister:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_debug_msg_id</span><span class="p">)</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">cio_debug_msg_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_debug_trace_id</span><span class="p">)</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">cio_debug_trace_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_debug_crw_id</span><span class="p">)</span>
		<span class="n">debug_unregister</span><span class="p">(</span><span class="n">cio_debug_crw_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">arch_initcall</span> <span class="p">(</span><span class="n">cio_debug_init</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cio_set_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_subchannel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_io_private</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DOIO_ALLOW_SUSPEND</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">prefetch</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DOIO_DENY_PREFETCH</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">inter</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DOIO_SUPPRESS_INTER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cio_start_handle_notoper</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">lpm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">dbf_text</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">lpm</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;cio_start: &#39;not oper&#39; status for &quot;</span>
		      <span class="s">&quot;subchannel 0.%x.%04x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
		      <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cio_update_schib</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">dbf_text</span><span class="p">,</span> <span class="s">&quot;no%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dbf_text</span><span class="p">);</span>
	<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">schib</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span> <span class="o">?</span> <span class="o">-</span><span class="n">EACCES</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">cio_start_key</span> <span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span>	<span class="cm">/* subchannel structure */</span>
	       <span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span> <span class="n">cpa</span><span class="p">,</span>	<span class="cm">/* logical channel prog addr */</span>
	       <span class="n">__u8</span> <span class="n">lpm</span><span class="p">,</span>		<span class="cm">/* logical path mask */</span>
	       <span class="n">__u8</span> <span class="n">key</span><span class="p">)</span>                <span class="cm">/* storage key */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_subchannel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_io_private</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">orb</span> <span class="o">*</span><span class="n">orb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">orb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccode</span><span class="p">;</span>

	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;stIO&quot;</span><span class="p">);</span>
	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">orb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">orb</span><span class="p">));</span>
	<span class="cm">/* sch is always under 2G. */</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">intparm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span><span class="n">sch</span><span class="p">;</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">pfch</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">prefetch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">spnd</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">suspend</span><span class="p">;</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ssic</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">suspend</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">inter</span><span class="p">;</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">lpm</span> <span class="o">=</span> <span class="p">(</span><span class="n">lpm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">lpm</span> <span class="o">:</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="cm">/*</span>
<span class="cm">	 * for 64 bit we always support 64 bit IDAWs with 4k page size only</span>
<span class="cm">	 */</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">c64</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">i2k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="cm">/* issue &quot;Start Subchannel&quot; */</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cpa</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">cpa</span><span class="p">);</span>
	<span class="n">ccode</span> <span class="o">=</span> <span class="n">ssch</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="n">orb</span><span class="p">);</span>

	<span class="cm">/* process condition code */</span>
	<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ccode</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ccode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/*</span>
<span class="cm">		 * initialize device status information</span>
<span class="cm">		 */</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span> <span class="o">|=</span> <span class="n">SCSW_ACTL_START_PEND</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* status pending */</span>
	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* busy */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:		<span class="cm">/* device/path not operational */</span>
		<span class="k">return</span> <span class="n">cio_start_handle_notoper</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">lpm</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ccode</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">cio_start</span> <span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">cpa</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">lpm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cio_start_key</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">cpa</span><span class="p">,</span> <span class="n">lpm</span><span class="p">,</span> <span class="n">PAGE_DEFAULT_KEY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resume suspended I/O operation</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">cio_resume</span> <span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ccode</span><span class="p">;</span>

	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;resIO&quot;</span><span class="p">);</span>
	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">ccode</span> <span class="o">=</span> <span class="n">rsch</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>

	<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ccode</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ccode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span> <span class="o">|=</span> <span class="n">SCSW_ACTL_RESUME_PEND</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * useless to wait for request completion</span>
<span class="cm">		 *  as device is no longer operational !</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * halt I/O operation</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">cio_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ccode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;haltIO&quot;</span><span class="p">);</span>
	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Issue &quot;Halt subchannel&quot; and process condition code</span>
<span class="cm">	 */</span>
	<span class="n">ccode</span> <span class="o">=</span> <span class="n">hsch</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>

	<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ccode</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ccode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span> <span class="o">|=</span> <span class="n">SCSW_ACTL_HALT_PEND</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* status pending */</span>
	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* busy */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* device not operational */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clear I/O operation</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">cio_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ccode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;clearIO&quot;</span><span class="p">);</span>
	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Issue &quot;Clear subchannel&quot; and process condition code</span>
<span class="cm">	 */</span>
	<span class="n">ccode</span> <span class="o">=</span> <span class="n">csch</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>

	<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ccode</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ccode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span> <span class="o">|=</span> <span class="n">SCSW_ACTL_CLEAR_PEND</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* device not operational */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function: cio_cancel</span>
<span class="cm"> * Issues a &quot;Cancel Subchannel&quot; on the specified subchannel</span>
<span class="cm"> * Note: We don&#39;t need any fancy intparms and flags here</span>
<span class="cm"> *	 since xsch is executed synchronously.</span>
<span class="cm"> * Only for common I/O internal use as for now.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">cio_cancel</span> <span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ccode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;cancelIO&quot;</span><span class="p">);</span>
	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">ccode</span> <span class="o">=</span> <span class="n">xsch</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>

	<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ccode</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ccode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* success */</span>
		<span class="cm">/* Update information in scsw. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cio_update_schib</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* status pending */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* not applicable */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="cm">/* not oper */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cio_apply_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">schib</span> <span class="o">*</span><span class="n">schib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">intparm</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intparm</span><span class="p">;</span>
	<span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">mbi</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mbi</span><span class="p">;</span>
	<span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">isc</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">isc</span><span class="p">;</span>
	<span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">ena</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ena</span><span class="p">;</span>
	<span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">mme</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mme</span><span class="p">;</span>
	<span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">csense</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">csense</span><span class="p">;</span>
	<span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">mbfc</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mbfc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mbfc</span><span class="p">)</span>
		<span class="n">schib</span><span class="o">-&gt;</span><span class="n">mba</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mba</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cio_check_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">schib</span> <span class="o">*</span><span class="n">schib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">intparm</span> <span class="o">==</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intparm</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">mbi</span> <span class="o">==</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mbi</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">isc</span> <span class="o">==</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">isc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">ena</span> <span class="o">==</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ena</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">mme</span> <span class="o">==</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mme</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">mp</span> <span class="o">==</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">csense</span> <span class="o">==</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">csense</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">mbfc</span> <span class="o">==</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mbfc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mbfc</span> <span class="o">||</span> <span class="p">(</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">mba</span> <span class="o">==</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mba</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cio_commit_config - apply configuration to the subchannel</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cio_commit_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">schib</span> <span class="n">schib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccode</span><span class="p">,</span> <span class="n">retry</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stsch_err</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">css_sch_is_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schib</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* copy desired changes to local schib */</span>
		<span class="n">cio_apply_config</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">);</span>
		<span class="n">ccode</span> <span class="o">=</span> <span class="n">msch_err</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* -EIO if msch gets a program check. */</span>
			<span class="k">return</span> <span class="n">ccode</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ccode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* successful */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stsch_err</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">)</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">css_sch_is_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schib</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cio_check_config</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* commit changes from local schib */</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">schib</span><span class="p">));</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* status pending */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* busy */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="cm">/* allow for recovery */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* not operational */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cio_update_schib - Perform stsch and update schib if subchannel is valid.</span>
<span class="cm"> * @sch: subchannel on which to perform stsch</span>
<span class="cm"> * Return zero on success, -ENODEV otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cio_update_schib</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">schib</span> <span class="n">schib</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stsch_err</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">css_sch_is_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schib</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">schib</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cio_update_schib</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * cio_enable_subchannel - enable a subchannel.</span>
<span class="cm"> * @sch: subchannel to be enabled</span>
<span class="cm"> * @intparm: interruption parameter to set</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cio_enable_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="n">u32</span> <span class="n">intparm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ensch&quot;</span><span class="p">);</span>
	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sch_is_pseudo_sch</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_update_schib</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ena</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">isc</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">isc</span><span class="p">;</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intparm</span> <span class="o">=</span> <span class="n">intparm</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cio_commit_config</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Got a program check in msch. Try without</span>
<span class="cm">			 * the concurrent sense bit the next time.</span>
<span class="cm">			 */</span>
			<span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">csense</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">irb</span> <span class="n">irb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tsch</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irb</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cio_enable_subchannel</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * cio_disable_subchannel - disable a subchannel.</span>
<span class="cm"> * @sch: subchannel to disable</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cio_disable_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;dissch&quot;</span><span class="p">);</span>
	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sch_is_pseudo_sch</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_update_schib</span><span class="p">(</span><span class="n">sch</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ena</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cio_commit_config</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">irb</span> <span class="n">irb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tsch</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irb</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CIO_HEX_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cio_disable_subchannel</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cio_create_sch_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">spinlock_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cio_check_devno_blacklisted</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_blacklisted</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This device must not be known to Linux. So we simply</span>
<span class="cm">		 * say that there is no device and return ENODEV.</span>
<span class="cm">		 */</span>
		<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;Blacklisted device detected &quot;</span>
			      <span class="s">&quot;at devno %04X, subchannel set %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cio_validate_io_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Initialization for io subchannels. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">css_sch_is_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Devno is valid. */</span>
	<span class="k">return</span> <span class="n">cio_check_devno_blacklisted</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cio_validate_msg_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Initialization for message subchannels. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">css_sch_is_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Devno is valid. */</span>
	<span class="k">return</span> <span class="n">cio_check_devno_blacklisted</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cio_validate_subchannel - basic validation of subchannel</span>
<span class="cm"> * @sch: subchannel structure to be filled out</span>
<span class="cm"> * @schid: subchannel id</span>
<span class="cm"> *</span>
<span class="cm"> * Find out subchannel type and initialize struct subchannel.</span>
<span class="cm"> * Return codes:</span>
<span class="cm"> *   0 on success</span>
<span class="cm"> *   -ENXIO for non-defined subchannels</span>
<span class="cm"> *   -ENODEV for invalid subchannels or blacklisted devices</span>
<span class="cm"> *   -EIO for subchannels in an invalid subchannel set</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cio_validate_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">dbf_txt</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ccode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">dbf_txt</span><span class="p">,</span> <span class="s">&quot;valsch%x&quot;</span><span class="p">,</span> <span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">);</span>
	<span class="n">CIO_TRACE_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dbf_txt</span><span class="p">);</span>

	<span class="cm">/* Nuke all fields. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span><span class="p">));</span>

	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span> <span class="o">=</span> <span class="n">schid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cio_is_console</span><span class="p">(</span><span class="n">schid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="n">cio_get_console_lock</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cio_create_sch_lock</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">reg_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The first subchannel that is not-operational (ccode==3)</span>
<span class="cm">	 *  indicates that there aren&#39;t any more devices available.</span>
<span class="cm">	 * If stsch gets an exception, it means the current subchannel set</span>
<span class="cm">	 *  is not valid.</span>
<span class="cm">	 */</span>
	<span class="n">ccode</span> <span class="o">=</span> <span class="n">stsch_err</span> <span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">ccode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENXIO</span> <span class="o">:</span> <span class="n">ccode</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Copy subchannel type from path management control word. */</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">st</span> <span class="o">=</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">st</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SUBCHANNEL_TYPE_IO</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">cio_validate_io_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SUBCHANNEL_TYPE_MSG</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">cio_validate_msg_subchannel</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">CIO_MSG_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Subchannel 0.%x.%04x reports subchannel type %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">,</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cio_is_console</span><span class="p">(</span><span class="n">schid</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * do_IRQ() handles all normal I/O device IRQ&#39;s (the special</span>
<span class="cm"> *	    SMP cross-CPU interrupts have their own specific</span>
<span class="cm"> *	    handlers).</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__irq_entry</span> <span class="nf">do_IRQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpi_info</span> <span class="o">*</span><span class="n">tpi_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">old_regs</span><span class="p">;</span>

	<span class="n">old_regs</span> <span class="o">=</span> <span class="n">set_irq_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">irq_enter</span><span class="p">();</span>
	<span class="n">__this_cpu_write</span><span class="p">(</span><span class="n">s390_idle</span><span class="p">.</span><span class="n">nohz_delay</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">int_clock</span> <span class="o">&gt;=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">clock_comparator</span><span class="p">)</span>
		<span class="cm">/* Serve timer interrupts first. */</span>
		<span class="n">clock_comparator_work</span><span class="p">();</span>
	<span class="cm">/*</span>
<span class="cm">	 * Get interrupt information from lowcore</span>
<span class="cm">	 */</span>
	<span class="n">tpi_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tpi_info</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">subchannel_id</span><span class="p">;</span>
	<span class="n">irb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">irb</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">kstat_cpu</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">()).</span><span class="n">irqs</span><span class="p">[</span><span class="n">IO_INTERRUPT</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpi_info</span><span class="o">-&gt;</span><span class="n">adapter_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_adapter_IO</span><span class="p">(</span><span class="n">tpi_info</span><span class="o">-&gt;</span><span class="n">isc</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sch</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tpi_info</span><span class="o">-&gt;</span><span class="n">intparm</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sch</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Clear pending interrupt condition. */</span>
			<span class="n">kstat_cpu</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">()).</span><span class="n">irqs</span><span class="p">[</span><span class="n">IOINT_CIO</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tsch</span><span class="p">(</span><span class="n">tpi_info</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="cm">/* Store interrupt response block to lowcore. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tsch</span><span class="p">(</span><span class="n">tpi_info</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="n">irb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Keep subchannel information word up to date. */</span>
			<span class="n">memcpy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">,</span>
				<span class="k">sizeof</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">));</span>
			<span class="cm">/* Call interrupt handler if there is one. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
				<span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">kstat_cpu</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">()).</span><span class="n">irqs</span><span class="p">[</span><span class="n">IOINT_CIO</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">kstat_cpu</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">()).</span><span class="n">irqs</span><span class="p">[</span><span class="n">IOINT_CIO</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Are more interrupts pending?</span>
<span class="cm">		 * If so, the tpi instruction will update the lowcore</span>
<span class="cm">		 * to hold the info for the next interrupt.</span>
<span class="cm">		 * We don&#39;t do this for VM because a tpi drops the cpu</span>
<span class="cm">		 * out of the sie which costs more cycles than it saves.</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">MACHINE_IS_LPAR</span> <span class="o">&amp;&amp;</span> <span class="n">tpi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq_exit</span><span class="p">();</span>
	<span class="n">set_irq_regs</span><span class="p">(</span><span class="n">old_regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CCW_CONSOLE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">subchannel</span> <span class="n">console_subchannel</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">io_subchannel_private</span> <span class="n">console_priv</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">console_subchannel_in_use</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Use cio_tsch to update the subchannel status and call the interrupt handler</span>
<span class="cm"> * if status had been pending. Called with the console_subchannel lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cio_tsch</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_context</span><span class="p">;</span>

	<span class="n">irb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">irb</span><span class="p">;</span>
	<span class="cm">/* Store interrupt response block to lowcore. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tsch</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="n">irb</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* Not status pending or not operational. */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">scsw</span><span class="p">));</span>
	<span class="cm">/* Call interrupt handler with updated status. */</span>
	<span class="n">irq_context</span> <span class="o">=</span> <span class="n">in_interrupt</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_context</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_bh_disable</span><span class="p">();</span>
		<span class="n">irq_enter</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">sch</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">(</span><span class="n">sch</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kstat_cpu</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">()).</span><span class="n">irqs</span><span class="p">[</span><span class="n">IOINT_CIO</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_context</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_exit</span><span class="p">();</span>
		<span class="n">_local_bh_enable</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">cio_get_console_priv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">console_priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * busy wait for the next interrupt on the console</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">wait_cons_dev</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">console_subchannel_in_use</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cio_tsch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_subchannel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">console_subchannel</span><span class="p">.</span><span class="n">schib</span><span class="p">.</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">actl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay_simple</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cio_test_for_console</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stsch_err</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">console_subchannel</span><span class="p">.</span><span class="n">schib</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">console_subchannel</span><span class="p">.</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">st</span> <span class="o">==</span> <span class="n">SUBCHANNEL_TYPE_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">console_subchannel</span><span class="p">.</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">dnv</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">console_subchannel</span><span class="p">.</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="n">console_devno</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">console_irq</span> <span class="o">=</span> <span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* found */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cio_get_console_sch_no</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">;</span>
	
	<span class="n">init_subchannel_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">console_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* VM provided us with the irq number of the console. */</span>
		<span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span> <span class="o">=</span> <span class="n">console_irq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stsch_err</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">console_subchannel</span><span class="p">.</span><span class="n">schib</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">console_subchannel</span><span class="p">.</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">st</span> <span class="o">!=</span> <span class="n">SUBCHANNEL_TYPE_IO</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">console_subchannel</span><span class="p">.</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">dnv</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">console_devno</span> <span class="o">=</span> <span class="n">console_subchannel</span><span class="p">.</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">console_devno</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* At least the console device number is known. */</span>
		<span class="n">for_each_subchannel</span><span class="p">(</span><span class="n">cio_test_for_console</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">console_irq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* unlike in 2.4, we cannot autoprobe here, since</span>
<span class="cm">		 * the channel subsystem is not fully initialized.</span>
<span class="cm">		 * With some luck, the HWC console can take over */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">console_irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span>
<span class="nf">cio_probe_console</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sch_no</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_subchannel_in_use</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="n">sch_no</span> <span class="o">=</span> <span class="n">cio_get_console_sch_no</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sch_no</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">console_subchannel_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;No CCW console was found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_subchannel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span><span class="p">));</span>
	<span class="n">init_subchannel_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schid</span><span class="p">);</span>
	<span class="n">schid</span><span class="p">.</span><span class="n">sch_no</span> <span class="o">=</span> <span class="n">sch_no</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cio_validate_subchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_subchannel</span><span class="p">,</span> <span class="n">schid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">console_subchannel_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * enable console I/O-interrupt subclass</span>
<span class="cm">	 */</span>
	<span class="n">isc_register</span><span class="p">(</span><span class="n">CONSOLE_ISC</span><span class="p">);</span>
	<span class="n">console_subchannel</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">isc</span> <span class="o">=</span> <span class="n">CONSOLE_ISC</span><span class="p">;</span>
	<span class="n">console_subchannel</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">intparm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">console_subchannel</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cio_commit_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_subchannel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isc_unregister</span><span class="p">(</span><span class="n">CONSOLE_ISC</span><span class="p">);</span>
		<span class="n">console_subchannel_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">console_subchannel</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cio_release_console</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">console_subchannel</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">intparm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cio_commit_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_subchannel</span><span class="p">);</span>
	<span class="n">isc_unregister</span><span class="p">(</span><span class="n">CONSOLE_ISC</span><span class="p">);</span>
	<span class="n">console_subchannel_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Bah... hack to catch console special sausages. */</span>
<span class="kt">int</span>
<span class="nf">cio_is_console</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">console_subchannel_in_use</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">schid_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">console_subchannel</span><span class="p">.</span><span class="n">schid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span>
<span class="nf">cio_get_console_subchannel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">console_subchannel_in_use</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">console_subchannel</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__disable_subchannel_easy</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">schib</span> <span class="o">*</span><span class="n">schib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retry</span><span class="p">,</span> <span class="n">cc</span><span class="p">;</span>

	<span class="n">cc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">retry</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">ena</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cc</span> <span class="o">=</span> <span class="n">msch_err</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="n">schib</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">cc</span><span class="o">==</span><span class="mi">3</span><span class="o">?-</span><span class="n">ENODEV</span><span class="o">:-</span><span class="n">EBUSY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stsch_err</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="n">schib</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">css_sch_is_valid</span><span class="p">(</span><span class="n">schib</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schib</span><span class="o">-&gt;</span><span class="n">pmcw</span><span class="p">.</span><span class="n">ena</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span> <span class="cm">/* uhm... */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__clear_io_subchannel_easy</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csch</span><span class="p">(</span><span class="n">schid</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">retry</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">;</span><span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tpi_info</span> <span class="n">ti</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tpi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ti</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tsch</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">schid</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">irb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">schid_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ti</span><span class="p">.</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schid</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay_simple</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__clear_chsc_subchannel_easy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* It seems we can only wait for a bit here :/ */</span>
	<span class="n">udelay_simple</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pgm_check_occured</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cio_reset_pgm_check_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pgm_check_occured</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stsch_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">schib</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pgm_check_occured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s390_base_pgm_handler_fn</span> <span class="o">=</span> <span class="n">cio_reset_pgm_check_handler</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">stsch_err</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">s390_base_pgm_handler_fn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* The program check handler could have changed pgm_check_occured. */</span>
	<span class="n">barrier</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pgm_check_occured</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__shutdown_subchannel_easy</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">schib</span> <span class="n">schib</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stsch_reset</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">ena</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">__disable_subchannel_easy</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* -EBUSY */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">st</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SUBCHANNEL_TYPE_IO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">__clear_io_subchannel_easy</span><span class="p">(</span><span class="n">schid</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* give up... */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SUBCHANNEL_TYPE_CHSC</span>:
			<span class="n">__clear_chsc_subchannel_easy</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* No default clear strategy */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">stsch_err</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">);</span>
		<span class="n">__disable_subchannel_easy</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">chpid_reset_count</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s390_reset_chpids_mcck_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crw</span> <span class="n">crw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mci</span> <span class="o">*</span><span class="n">mci</span><span class="p">;</span>

	<span class="cm">/* Check for pending channel report word. */</span>
	<span class="n">mci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mci</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">mcck_interruption_code</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mci</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Process channel report words. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">stcrw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check for responses to RCHP. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crw</span><span class="p">.</span><span class="n">slct</span> <span class="o">&amp;&amp;</span> <span class="n">crw</span><span class="p">.</span><span class="n">rsc</span> <span class="o">==</span> <span class="n">CRW_RSC_CPATH</span><span class="p">)</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chpid_reset_count</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define RCHP_TIMEOUT (30 * USEC_PER_SEC)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">css_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chp_id</span> <span class="n">chpid</span><span class="p">;</span>

	<span class="cm">/* Reset subchannels. */</span>
	<span class="n">for_each_subchannel</span><span class="p">(</span><span class="n">__shutdown_subchannel_easy</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* Reset channel paths. */</span>
	<span class="n">s390_base_mcck_handler_fn</span> <span class="o">=</span> <span class="n">s390_reset_chpids_mcck_handler</span><span class="p">;</span>
	<span class="cm">/* Enable channel report machine checks. */</span>
	<span class="n">__ctl_set_bit</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>
	<span class="cm">/* Temporarily reenable machine checks. */</span>
	<span class="n">local_mcck_enable</span><span class="p">();</span>
	<span class="n">chp_id_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chpid</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">__MAX_CHPID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chpid</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rchp</span><span class="p">(</span><span class="n">chpid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
			<span class="cm">/*</span>
<span class="cm">			 * rchp either succeeded, or another rchp is already</span>
<span class="cm">			 * in progress. In either case, we&#39;ll get a crw.</span>
<span class="cm">			 */</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chpid_reset_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Wait for machine check for all channel paths. */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">RCHP_TIMEOUT</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chpid_reset_count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_clock</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* Disable machine checks again. */</span>
	<span class="n">local_mcck_disable</span><span class="p">();</span>
	<span class="cm">/* Disable channel report machine checks. */</span>
	<span class="n">__ctl_clear_bit</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">s390_base_mcck_handler_fn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">reset_call</span> <span class="n">css_reset_call</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">css_reset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_css_reset_call</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chpid_reset_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">register_reset_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">css_reset_call</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">arch_initcall</span><span class="p">(</span><span class="n">init_css_reset_call</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">sch_match_id</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="n">devid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__reipl_subchannel_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">schib</span> <span class="n">schib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sch_match_id</span> <span class="o">*</span><span class="n">match_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stsch_reset</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">st</span> <span class="o">==</span> <span class="n">SUBCHANNEL_TYPE_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">dnv</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="n">match_id</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">.</span><span class="n">devno</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">schid</span><span class="p">.</span><span class="n">ssid</span> <span class="o">==</span> <span class="n">match_id</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">.</span><span class="n">ssid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">match_id</span><span class="o">-&gt;</span><span class="n">schid</span> <span class="o">=</span> <span class="n">schid</span><span class="p">;</span>
		<span class="n">match_id</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reipl_find_schid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="o">*</span><span class="n">devid</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">subchannel_id</span> <span class="o">*</span><span class="n">schid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sch_match_id</span> <span class="n">match_id</span><span class="p">;</span>

	<span class="n">match_id</span><span class="p">.</span><span class="n">devid</span> <span class="o">=</span> <span class="o">*</span><span class="n">devid</span><span class="p">;</span>
	<span class="n">match_id</span><span class="p">.</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">for_each_subchannel</span><span class="p">(</span><span class="n">__reipl_subchannel_match</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match_id</span><span class="p">.</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">schid</span> <span class="o">=</span> <span class="n">match_id</span><span class="p">.</span><span class="n">schid</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">match_id</span><span class="p">.</span><span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">do_reipl_asm</span><span class="p">(</span><span class="n">__u32</span> <span class="n">schid</span><span class="p">);</span>

<span class="cm">/* Make sure all subchannels are quiet before we re-ipl an lpar. */</span>
<span class="kt">void</span> <span class="nf">reipl_ccw_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_dev_id</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">;</span>

	<span class="n">s390_reset_system</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reipl_find_schid</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schid</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;IPL Device not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">do_reipl_asm</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">__u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">schid</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">cio_get_iplinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">cio_iplinfo</span> <span class="o">*</span><span class="n">iplinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">subchannel_id</span> <span class="n">schid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">schib</span> <span class="n">schib</span><span class="p">;</span>

	<span class="n">schid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel_id</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">subchannel_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schid</span><span class="p">.</span><span class="n">one</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stsch_err</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schib</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">st</span> <span class="o">!=</span> <span class="n">SUBCHANNEL_TYPE_IO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">dnv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">iplinfo</span><span class="o">-&gt;</span><span class="n">devno</span> <span class="o">=</span> <span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">iplinfo</span><span class="o">-&gt;</span><span class="n">is_qdio</span> <span class="o">=</span> <span class="n">schib</span><span class="p">.</span><span class="n">pmcw</span><span class="p">.</span><span class="n">qf</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cio_tm_start_key - perform start function</span>
<span class="cm"> * @sch: subchannel on which to perform the start function</span>
<span class="cm"> * @tcw: transport-command word to be started</span>
<span class="cm"> * @lpm: mask of paths to use</span>
<span class="cm"> * @key: storage key to use for storage access</span>
<span class="cm"> *</span>
<span class="cm"> * Start the tcw on the given subchannel. Return zero on success, non-zero</span>
<span class="cm"> * otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cio_tm_start_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcw</span> <span class="o">*</span><span class="n">tcw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lpm</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cc</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">orb</span> <span class="o">*</span><span class="n">orb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">to_io_private</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">orb</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">orb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">orb</span><span class="p">));</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">tm</span><span class="p">.</span><span class="n">intparm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">sch</span><span class="p">;</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">tm</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">tm</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">tm</span><span class="p">.</span><span class="n">lpm</span> <span class="o">=</span> <span class="n">lpm</span> <span class="o">?</span> <span class="n">lpm</span> <span class="o">:</span> <span class="n">sch</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">;</span>
	<span class="n">orb</span><span class="o">-&gt;</span><span class="n">tm</span><span class="p">.</span><span class="n">tcw</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr_t</span><span class="p">)</span> <span class="n">tcw</span><span class="p">;</span>
	<span class="n">cc</span> <span class="o">=</span> <span class="n">ssch</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">,</span> <span class="n">orb</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">cio_start_handle_notoper</span><span class="p">(</span><span class="n">sch</span><span class="p">,</span> <span class="n">lpm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cio_tm_intrg - perform interrogate function</span>
<span class="cm"> * @sch - subchannel on which to perform the interrogate function</span>
<span class="cm"> *</span>
<span class="cm"> * If the specified subchannel is running in transport-mode, perform the</span>
<span class="cm"> * interrogate function. Return zero on success, non-zero otherwie.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cio_tm_intrg</span><span class="p">(</span><span class="k">struct</span> <span class="n">subchannel</span> <span class="o">*</span><span class="n">sch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to_io_private</span><span class="p">(</span><span class="n">sch</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">orb</span><span class="p">.</span><span class="n">tm</span><span class="p">.</span><span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">cc</span> <span class="o">=</span> <span class="n">xsch</span><span class="p">(</span><span class="n">sch</span><span class="o">-&gt;</span><span class="n">schid</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
