<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › scsi › zfcp_fsf.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>zfcp_fsf.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * zfcp device driver</span>
<span class="cm"> *</span>
<span class="cm"> * Implementation of FSF commands.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright IBM Corporation 2002, 2010</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;zfcp&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/blktrace_api.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_els.h&gt;</span>
<span class="cp">#include &quot;zfcp_ext.h&quot;</span>
<span class="cp">#include &quot;zfcp_fc.h&quot;</span>
<span class="cp">#include &quot;zfcp_dbf.h&quot;</span>
<span class="cp">#include &quot;zfcp_qdio.h&quot;</span>
<span class="cp">#include &quot;zfcp_reqlist.h&quot;</span>

<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">zfcp_fsf_qtcb_cache</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_request_timeout_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">zfcp_qdio_siosl</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span>
				<span class="s">&quot;fsrth_1&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_start_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">fsf_req</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fsf_req</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">zfcp_fsf_request_timeout_handler</span><span class="p">;</span>
	<span class="n">fsf_req</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fsf_req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">fsf_req</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsf_req</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_start_erp_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">fsf_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">fsf_req</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="n">fsf_req</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">zfcp_erp_timeout_handler</span><span class="p">;</span>
	<span class="n">fsf_req</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fsf_req</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">;</span>
	<span class="n">fsf_req</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsf_req</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* association between FSF command and FSF QTCB type */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">fsf_qtcb_type</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">FSF_QTCB_FCP_CMND</span><span class="p">]</span> <span class="o">=</span>             <span class="n">FSF_IO_COMMAND</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FSF_QTCB_ABORT_FCP_CMND</span><span class="p">]</span> <span class="o">=</span>       <span class="n">FSF_SUPPORT_COMMAND</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FSF_QTCB_OPEN_PORT_WITH_DID</span><span class="p">]</span> <span class="o">=</span>   <span class="n">FSF_SUPPORT_COMMAND</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FSF_QTCB_OPEN_LUN</span><span class="p">]</span> <span class="o">=</span>             <span class="n">FSF_SUPPORT_COMMAND</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FSF_QTCB_CLOSE_LUN</span><span class="p">]</span> <span class="o">=</span>            <span class="n">FSF_SUPPORT_COMMAND</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FSF_QTCB_CLOSE_PORT</span><span class="p">]</span> <span class="o">=</span>           <span class="n">FSF_SUPPORT_COMMAND</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FSF_QTCB_CLOSE_PHYSICAL_PORT</span><span class="p">]</span> <span class="o">=</span>  <span class="n">FSF_SUPPORT_COMMAND</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FSF_QTCB_SEND_ELS</span><span class="p">]</span> <span class="o">=</span>             <span class="n">FSF_SUPPORT_COMMAND</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FSF_QTCB_SEND_GENERIC</span><span class="p">]</span> <span class="o">=</span>         <span class="n">FSF_SUPPORT_COMMAND</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FSF_QTCB_EXCHANGE_CONFIG_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">FSF_CONFIG_COMMAND</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FSF_QTCB_EXCHANGE_PORT_DATA</span><span class="p">]</span> <span class="o">=</span>   <span class="n">FSF_PORT_COMMAND</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FSF_QTCB_DOWNLOAD_CONTROL_FILE</span><span class="p">]</span> <span class="o">=</span> <span class="n">FSF_SUPPORT_COMMAND</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FSF_QTCB_UPLOAD_CONTROL_FILE</span><span class="p">]</span> <span class="o">=</span>  <span class="n">FSF_SUPPORT_COMMAND</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_class_not_supp</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FCP device not &quot;</span>
		<span class="s">&quot;operational because of an unsupported FC class</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fscns_1&quot;</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_req_free - free memory used by fsf request</span>
<span class="cm"> * @fsf_req: pointer to struct zfcp_fsf_req</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_fsf_req_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="p">))</span>
			<span class="n">mempool_free</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">qtcb_pool</span><span class="p">);</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="p">))</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">zfcp_fsf_qtcb_cache</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_status_read_port_closed</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_status_read_buffer</span> <span class="o">*</span><span class="n">sr_buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">d_id</span> <span class="o">=</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">sr_buf</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>

	<span class="n">read_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">d_id</span> <span class="o">==</span> <span class="n">d_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fssrpc1&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_link_down_info_eval</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">fsf_link_down_info</span> <span class="o">*</span><span class="n">link_down</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">zfcp_scsi_schedule_rports_block</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_down</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">link_down</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_PSQ_LINK_NO_LIGHT</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;There is no light signal from the local &quot;</span>
			 <span class="s">&quot;fibre channel cable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PSQ_LINK_WRAP_PLUG</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;There is a wrap plug instead of a fibre &quot;</span>
			 <span class="s">&quot;channel cable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PSQ_LINK_NO_FCP</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The adjacent fibre channel node does not &quot;</span>
			 <span class="s">&quot;support FCP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PSQ_LINK_FIRMWARE_UPDATE</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The FCP device is suspended because of a &quot;</span>
			 <span class="s">&quot;firmware update</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PSQ_LINK_INVALID_WWPN</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The FCP device detected a WWPN that is &quot;</span>
			 <span class="s">&quot;duplicate or not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PSQ_LINK_NO_NPIV_SUPPORT</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The fibre channel fabric does not support NPIV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PSQ_LINK_NO_FCP_RESOURCES</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The FCP adapter cannot support more NPIV ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PSQ_LINK_NO_FABRIC_RESOURCES</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The adjacent switch cannot support &quot;</span>
			 <span class="s">&quot;more NPIV ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PSQ_LINK_FABRIC_LOGIN_UNABLE</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The FCP adapter could not log in to the &quot;</span>
			 <span class="s">&quot;fibre channel fabric</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PSQ_LINK_WWPN_ASSIGNMENT_CORRUPTED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The WWPN assignment file on the FCP adapter &quot;</span>
			 <span class="s">&quot;has been damaged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PSQ_LINK_MODE_TABLE_CURRUPTED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The mode table on the FCP adapter &quot;</span>
			 <span class="s">&quot;has been damaged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PSQ_LINK_NO_WWPN_ASSIGNMENT</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;All NPIV ports on the FCP adapter have &quot;</span>
			 <span class="s">&quot;been assigned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The link between the FCP adapter and &quot;</span>
			 <span class="s">&quot;the FC fabric is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">zfcp_erp_set_adapter_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_status_read_link_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsf_status_read_buffer</span> <span class="o">*</span><span class="n">sr_buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_link_down_info</span> <span class="o">*</span><span class="n">ldi</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">fsf_link_down_info</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">sr_buf</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sr_buf</span><span class="o">-&gt;</span><span class="n">status_subtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_STATUS_READ_SUB_NO_PHYSICAL_LINK</span>:
		<span class="n">zfcp_fsf_link_down_info_eval</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ldi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_STATUS_READ_SUB_FDISC_FAILED</span>:
		<span class="n">zfcp_fsf_link_down_info_eval</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ldi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_STATUS_READ_SUB_FIRMWARE_UPDATE</span>:
		<span class="n">zfcp_fsf_link_down_info_eval</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_status_read_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_status_read_buffer</span> <span class="o">*</span><span class="n">sr_buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_DISMISSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_dbf_hba_fsf_uss</span><span class="p">(</span><span class="s">&quot;fssrh_1&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">sr_buf</span><span class="p">),</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">sr_data</span><span class="p">);</span>
		<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zfcp_dbf_hba_fsf_uss</span><span class="p">(</span><span class="s">&quot;fssrh_2&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sr_buf</span><span class="o">-&gt;</span><span class="n">status_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_STATUS_READ_PORT_CLOSED</span>:
		<span class="n">zfcp_fsf_status_read_port_closed</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_STATUS_READ_INCOMING_ELS</span>:
		<span class="n">zfcp_fc_incoming_els</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_STATUS_READ_SENSE_DATA_AVAIL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_STATUS_READ_BIT_ERROR_THRESHOLD</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The error threshold for checksum statistics &quot;</span>
			 <span class="s">&quot;has been exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">zfcp_dbf_hba_bit_err</span><span class="p">(</span><span class="s">&quot;fssrh_3&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_STATUS_READ_LINK_DOWN</span>:
		<span class="n">zfcp_fsf_status_read_link_down</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">zfcp_fc_enqueue_event</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">FCH_EVT_LINKDOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_STATUS_READ_LINK_UP</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;The local link has been restored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* All ports should be marked as ready to run again */</span>
		<span class="n">zfcp_erp_set_adapter_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					    <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED</span> <span class="o">|</span>
					<span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span>
					<span class="s">&quot;fssrh_2&quot;</span><span class="p">);</span>
		<span class="n">zfcp_fc_enqueue_event</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">FCH_EVT_LINKUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_STATUS_READ_NOTIFICATION_LOST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sr_buf</span><span class="o">-&gt;</span><span class="n">status_subtype</span> <span class="o">&amp;</span> <span class="n">FSF_STATUS_READ_SUB_ACT_UPDATED</span><span class="p">)</span>
			<span class="n">zfcp_cfdc_adapter_access_changed</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sr_buf</span><span class="o">-&gt;</span><span class="n">status_subtype</span> <span class="o">&amp;</span> <span class="n">FSF_STATUS_READ_SUB_INCOMING_ELS</span><span class="p">)</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_STATUS_READ_CFDC_UPDATED</span>:
		<span class="n">zfcp_cfdc_adapter_access_changed</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_STATUS_READ_FEATURE_UPDATE_ALERT</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_features</span> <span class="o">=</span> <span class="n">sr_buf</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mempool_free</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">sr_buf</span><span class="p">),</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">sr_data</span><span class="p">);</span>
	<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stat_miss</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stat_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_fsfstatus_qual_eval</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status_qual</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_SQ_FCP_RSP_AVAILABLE</span>:
	<span class="k">case</span> <span class="n">FSF_SQ_INVOKE_LINK_TEST_PROCEDURE</span>:
	<span class="k">case</span> <span class="n">FSF_SQ_NO_RETRY_POSSIBLE</span>:
	<span class="k">case</span> <span class="n">FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_SQ_COMMAND_ABORTED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_SQ_NO_RECOM</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The FCP adapter reported a problem &quot;</span>
			<span class="s">&quot;that cannot be recovered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">zfcp_qdio_siosl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fsfsqe1&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* all non-return stats set FSFREQ_ERROR*/</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_fsfstatus_eval</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_UNKNOWN_COMMAND</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The FCP adapter does not recognize the command 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_command</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fsfse_1&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ADAPTER_STATUS_AVAILABLE</span>:
		<span class="n">zfcp_fsf_fsfstatus_qual_eval</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_protstatus_eval</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb</span> <span class="o">*</span><span class="n">qtcb</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">fsf_prot_status_qual</span> <span class="o">*</span><span class="n">psq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">.</span><span class="n">prot_status_qual</span><span class="p">;</span>

	<span class="n">zfcp_dbf_hba_fsf_response</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_DISMISSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">.</span><span class="n">prot_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_PROT_GOOD</span>:
	<span class="k">case</span> <span class="n">FSF_PROT_FSF_STATUS_PRESENTED</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PROT_QTCB_VERSION_ERROR</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;QTCB version 0x%x not supported by FCP adapter &quot;</span>
			<span class="s">&quot;(0x%x to 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FSF_QTCB_CURRENT_VERSION</span><span class="p">,</span>
			<span class="n">psq</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">psq</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fspse_1&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PROT_ERROR_STATE</span>:
	<span class="k">case</span> <span class="n">FSF_PROT_SEQ_NUMB_ERROR</span>:
		<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fspse_2&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PROT_UNSUPP_QTCB_TYPE</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The QTCB type is not supported by the FCP adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fspse_3&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PROT_HOST_CONNECTION_INITIALIZING</span>:
		<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_ADAPTER_HOST_CON_INIT</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PROT_DUPLICATE_REQUEST_ID</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;0x%Lx is an ambiguous request identifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">req_handle</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fspse_4&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PROT_LINK_DOWN</span>:
		<span class="n">zfcp_fsf_link_down_info_eval</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psq</span><span class="o">-&gt;</span><span class="n">link_down_info</span><span class="p">);</span>
		<span class="cm">/* go through reopen to flush pending requests */</span>
		<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fspse_6&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PROT_REEST_QUEUE</span>:
		<span class="cm">/* All ports should be marked as ready to run again */</span>
		<span class="n">zfcp_erp_set_adapter_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					    <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED</span> <span class="o">|</span>
					<span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span>
					<span class="s">&quot;fspse_8&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;0x%x is not a valid transfer protocol status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">.</span><span class="n">prot_status</span><span class="p">);</span>
		<span class="n">zfcp_qdio_siosl</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fspse_9&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_req_complete - process completion of a FSF request</span>
<span class="cm"> * @fsf_req: The FSF request that has been completed.</span>
<span class="cm"> *</span>
<span class="cm"> * When a request has been completed either from the FCP adapter,</span>
<span class="cm"> * or it has been dismissed due to a queue shutdown, this function</span>
<span class="cm"> * is called to process the completion status and trigger further</span>
<span class="cm"> * events related to the FSF request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_req_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">fsf_command</span> <span class="o">==</span> <span class="n">FSF_QTCB_UNSOLICITED_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">zfcp_fsf_status_read_handler</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">zfcp_fsf_protstatus_eval</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">zfcp_fsf_fsfstatus_eval</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">)</span>
		<span class="n">zfcp_erp_notify</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">))</span>
		<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_req_dismiss_all - dismiss all fsf requests</span>
<span class="cm"> * @adapter: pointer to struct zfcp_adapter</span>
<span class="cm"> *</span>
<span class="cm"> * Never ever call this without shutting down the adapter first.</span>
<span class="cm"> * Otherwise the adapter would continue using and corrupting s390 storage.</span>
<span class="cm"> * Included BUG_ON() call to ensure this is done.</span>
<span class="cm"> * ERP is supposed to be the only user of this function.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_fsf_req_dismiss_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">remove_queue</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ADAPTER_QDIOUP</span><span class="p">);</span>
	<span class="n">zfcp_reqlist_move</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">req_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remove_queue</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remove_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_DISMISSED</span><span class="p">;</span>
		<span class="n">zfcp_fsf_req_complete</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_fsf_exchange_config_evaluate</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_bottom_config</span> <span class="o">*</span><span class="n">bottom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">nsp</span><span class="p">,</span> <span class="o">*</span><span class="n">plogi</span><span class="p">;</span>

	<span class="cm">/* adjust pointers for missing command code */</span>
	<span class="n">nsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">nport_serv_param</span>
					<span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">plogi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">plogi_payload</span>
					<span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bottom</span><span class="p">));</span>

	<span class="n">fc_host_port_name</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">nsp</span><span class="o">-&gt;</span><span class="n">fl_wwpn</span><span class="p">;</span>
	<span class="n">fc_host_node_name</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">nsp</span><span class="o">-&gt;</span><span class="n">fl_wwnn</span><span class="p">;</span>
	<span class="n">fc_host_port_id</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">fc_link_speed</span><span class="p">;</span>
	<span class="n">fc_host_supported_classes</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_COS_CLASS2</span> <span class="o">|</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hydra_version</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">timer_interval</span> <span class="o">&amp;</span> <span class="n">ZFCP_FSF_TIMER_INT_MASK</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stat_read_buf_num</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">status_read_buf_num</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">FSF_STATUS_READS_RECOM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fc_host_permanent_port_name</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">fc_host_permanent_port_name</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">fc_host_port_name</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">fc_topology</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_TOPO_P2P</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_d_id</span> <span class="o">=</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">peer_d_id</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_wwpn</span> <span class="o">=</span> <span class="n">plogi</span><span class="o">-&gt;</span><span class="n">fl_wwpn</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_wwnn</span> <span class="o">=</span> <span class="n">plogi</span><span class="o">-&gt;</span><span class="n">fl_wwnn</span><span class="p">;</span>
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_PTP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_TOPO_FABRIC</span>:
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NPORT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_TOPO_AL</span>:
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NLPORT</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Unknown or unsupported arbitrated loop &quot;</span>
			<span class="s">&quot;fibre channel topology detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fsece_1&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zfcp_scsi_set_prot</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_exchange_config_data_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb</span> <span class="o">*</span><span class="n">qtcb</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_bottom_config</span> <span class="o">*</span><span class="n">bottom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fsf_lic_version</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">lic_version</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_features</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">adapter_features</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">connection_features</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">connection_features</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_wwpn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_wwnn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_d_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_GOOD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_fsf_exchange_config_evaluate</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">max_qtcb_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsf_qtcb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;FCP adapter maximum QTCB size (%d bytes) &quot;</span>
				<span class="s">&quot;is too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bottom</span><span class="o">-&gt;</span><span class="n">max_qtcb_size</span><span class="p">);</span>
			<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fsecdh1&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_ADAPTER_XCONFIG_OK</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_EXCHANGE_CONFIG_DATA_INCOMPLETE</span>:
		<span class="n">fc_host_node_name</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fc_host_port_name</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fc_host_port_id</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_UNKNOWN</span><span class="p">;</span>
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_UNKNOWN</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hydra_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">zfcp_fsf_link_down_info_eval</span><span class="p">(</span><span class="n">req</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status_qual</span><span class="p">.</span><span class="n">link_down_info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fsecdh3&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_features</span> <span class="o">&amp;</span> <span class="n">FSF_FEATURE_HBAAPI_MANAGEMENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hardware_version</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">hardware_version</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fc_host_serial_number</span><span class="p">(</span><span class="n">shost</span><span class="p">),</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">,</span>
		       <span class="n">min</span><span class="p">(</span><span class="n">FC_SERIAL_NUMBER_SIZE</span><span class="p">,</span> <span class="mi">17</span><span class="p">));</span>
		<span class="n">EBCASC</span><span class="p">(</span><span class="n">fc_host_serial_number</span><span class="p">(</span><span class="n">shost</span><span class="p">),</span>
		       <span class="n">min</span><span class="p">(</span><span class="n">FC_SERIAL_NUMBER_SIZE</span><span class="p">,</span> <span class="mi">17</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FSF_QTCB_CURRENT_VERSION</span> <span class="o">&lt;</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">low_qtcb_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The FCP adapter only supports newer &quot;</span>
			<span class="s">&quot;control block versions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fsecdh4&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FSF_QTCB_CURRENT_VERSION</span> <span class="o">&gt;</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">high_qtcb_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The FCP adapter only supports older &quot;</span>
			<span class="s">&quot;control block versions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fsecdh5&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_exchange_port_evaluate</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_bottom_port</span> <span class="o">*</span><span class="n">bottom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bottom</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">connection_features</span> <span class="o">&amp;</span> <span class="n">FSF_FEATURE_NPIV_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_host_permanent_port_name</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">;</span>
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NPIV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fc_host_permanent_port_name</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">fc_host_port_name</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">fc_host_maxframe_size</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">maximum_frame_size</span><span class="p">;</span>
	<span class="n">fc_host_supported_speeds</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">supported_speed</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fc_host_supported_fc4s</span><span class="p">(</span><span class="n">shost</span><span class="p">),</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">supported_fc4_types</span><span class="p">,</span>
	       <span class="n">FC_FC4_LIST_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fc_host_active_fc4s</span><span class="p">(</span><span class="n">shost</span><span class="p">),</span> <span class="n">bottom</span><span class="o">-&gt;</span><span class="n">active_fc4_types</span><span class="p">,</span>
	       <span class="n">FC_FC4_LIST_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_exchange_port_data_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb</span> <span class="o">*</span><span class="n">qtcb</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_GOOD</span>:
		<span class="n">zfcp_fsf_exchange_port_evaluate</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_EXCHANGE_CONFIG_DATA_INCOMPLETE</span>:
		<span class="n">zfcp_fsf_exchange_port_evaluate</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">zfcp_fsf_link_down_info_eval</span><span class="p">(</span><span class="n">req</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status_qual</span><span class="p">.</span><span class="n">link_down_info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="nf">zfcp_fsf_alloc</span><span class="p">(</span><span class="n">mempool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pool</span><span class="p">))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fsf_qtcb</span> <span class="o">*</span><span class="nf">zfcp_qtcb_alloc</span><span class="p">(</span><span class="n">mempool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb</span> <span class="o">*</span><span class="n">qtcb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pool</span><span class="p">))</span>
		<span class="n">qtcb</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">qtcb</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">zfcp_fsf_qtcb_cache</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">qtcb</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">qtcb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">qtcb</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">qtcb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="nf">zfcp_fsf_req_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">fsf_cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sbtype</span><span class="p">,</span>
						<span class="n">mempool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_alloc</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">req_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">req_no</span><span class="o">++</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">fsf_command</span> <span class="o">=</span> <span class="n">fsf_cmd</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">req_no</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">fsf_cmd</span> <span class="o">!=</span> <span class="n">FSF_QTCB_UNSOLICITED_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pool</span><span class="p">))</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span> <span class="o">=</span> <span class="n">zfcp_qtcb_alloc</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">qtcb_pool</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span> <span class="o">=</span> <span class="n">zfcp_qtcb_alloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">seq_no</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fsf_req_seq_no</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">.</span><span class="n">req_seq_no</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fsf_req_seq_no</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">.</span><span class="n">req_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">.</span><span class="n">ulp_info</span> <span class="o">=</span> <span class="mi">26</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">.</span><span class="n">qtcb_type</span> <span class="o">=</span> <span class="n">fsf_qtcb_type</span><span class="p">[</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">fsf_command</span><span class="p">];</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">.</span><span class="n">qtcb_version</span> <span class="o">=</span> <span class="n">FSF_QTCB_CURRENT_VERSION</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">req_handle</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_command</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">fsf_command</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zfcp_qdio_req_init</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">,</span> <span class="n">sbtype</span><span class="p">,</span>
			   <span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsf_qtcb</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_fsf_req_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">with_qtcb</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">req_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>

	<span class="n">zfcp_reqlist_add</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">req_list</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">.</span><span class="n">qdio_outb_usage</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_free</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">issued</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_send</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="cm">/* lookup request again, list might have changed */</span>
		<span class="n">zfcp_reqlist_find_rm</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">req_list</span><span class="p">,</span> <span class="n">req_id</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fsrs__1&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t increase for unsolicited status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">with_qtcb</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fsf_req_seq_no</span><span class="o">++</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">req_no</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_status_read - send status read request</span>
<span class="cm"> * @adapter: pointer to struct zfcp_adapter</span>
<span class="cm"> * @req_flags: request flags</span>
<span class="cm"> * Returns: 0 on success, ERROR otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_status_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_status_read_buffer</span> <span class="o">*</span><span class="n">sr_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_UNSOLICITED_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">status_read_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">sr_data</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sr_buf</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sr_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sr_buf</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">sr_buf</span><span class="p">;</span>

	<span class="n">zfcp_qdio_fill_next</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span> <span class="n">sr_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sr_buf</span><span class="p">));</span>
	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_req_send</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">failed_req_send:</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">sr_buf</span><span class="p">),</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">sr_data</span><span class="p">);</span>
<span class="nl">failed_buf:</span>
	<span class="n">zfcp_dbf_hba_fsf_uss</span><span class="p">(</span><span class="s">&quot;fssr__1&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_abort_fcp_command_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">fsf_status_qual</span> <span class="o">*</span><span class="n">fsq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status_qual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_PORT_HANDLE_NOT_VALID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fsq</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fsq</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="s">&quot;fsafch1&quot;</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_LUN_HANDLE_NOT_VALID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fsq</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fsq</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fsafch2&quot;</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_FCP_COMMAND_DOES_NOT_EXIST</span>:
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ABORTNOTNEEDED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PORT_BOXED</span>:
		<span class="n">zfcp_erp_set_port_status</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
					 <span class="n">ZFCP_STATUS_COMMON_ACCESS_BOXED</span><span class="p">);</span>
		<span class="n">zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
				     <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span> <span class="s">&quot;fsafch3&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_LUN_BOXED</span>:
		<span class="n">zfcp_erp_set_lun_status</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ACCESS_BOXED</span><span class="p">);</span>
		<span class="n">zfcp_erp_lun_reopen</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span>
				    <span class="s">&quot;fsafch4&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ADAPTER_STATUS_AVAILABLE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">fsq</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FSF_SQ_INVOKE_LINK_TEST_PROCEDURE</span>:
			<span class="n">zfcp_fc_test_link</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED</span>:
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_GOOD</span>:
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ABORTSUCCEEDED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_abort_fcp_cmnd - abort running SCSI command</span>
<span class="cm"> * @scmnd: The SCSI command to abort</span>
<span class="cm"> * Returns: pointer to struct zfcp_fsf_req</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="nf">zfcp_fsf_abort_fcp_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmnd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_req_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_ABORT_FCP_CMND</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">,</span>
				  <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">scsi_abort</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span>
		       <span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_error_free</span><span class="p">;</span>

	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">sdev</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_abort_fcp_command_handler</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">lun_handle</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">lun_handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">port_handle</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">req_handle</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">old_req_id</span><span class="p">;</span>

	<span class="n">zfcp_fsf_start_timer</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ZFCP_SCSI_ER_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out_error_free:</span>
	<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_send_ct_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_ct_els</span> <span class="o">*</span><span class="n">ct</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>

	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_fsfstatus</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">FSF_GOOD</span>:
		<span class="n">zfcp_dbf_san_res</span><span class="p">(</span><span class="s">&quot;fsscth1&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">FSF_SERVICE_CLASS_NOT_SUPPORTED</span>:
		<span class="n">zfcp_fsf_class_not_supp</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">FSF_ADAPTER_STATUS_AVAILABLE</span>:
                <span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status_qual</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]){</span>
                <span class="k">case</span> <span class="n">FSF_SQ_INVOKE_LINK_TEST_PROCEDURE</span>:
                <span class="k">case</span> <span class="n">FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED</span>:
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ACCESS_DENIED</span>:
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">FSF_PORT_BOXED</span>:
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PORT_HANDLE_NOT_VALID</span>:
		<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fsscth1&quot;</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FSF_GENERIC_COMMAND_REJECTED</span>:
	<span class="k">case</span> <span class="n">FSF_PAYLOAD_SIZE_MISMATCH</span>:
	<span class="k">case</span> <span class="n">FSF_REQUEST_SIZE_TOO_LARGE</span>:
	<span class="k">case</span> <span class="n">FSF_RESPONSE_SIZE_TOO_LARGE</span>:
	<span class="k">case</span> <span class="n">FSF_SBAL_MISMATCH</span>:
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">skip_fsfstatus:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">handler_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_setup_ct_els_unchained</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">zfcp_qdio_req</span> <span class="o">*</span><span class="n">q_req</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_req</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">zfcp_qdio_fill_next</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">q_req</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg_req</span><span class="p">),</span> <span class="n">sg_req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">zfcp_qdio_fill_next</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">q_req</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg_resp</span><span class="p">),</span> <span class="n">sg_resp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">q_req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_fsf_setup_ct_els_sbals</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_req</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb</span> <span class="o">*</span><span class="n">qtcb</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">feat</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_adapter_multi_buffer_active</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbals_from_sg</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span> <span class="n">sg_req</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbals_from_sg</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span> <span class="n">sg_resp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">zfcp_qdio_set_data_div</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span>
					<span class="n">zfcp_qdio_sbale_count</span><span class="p">(</span><span class="n">sg_req</span><span class="p">));</span>
		<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>
		<span class="n">zfcp_qdio_set_scount</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* use single, unchained SBAL if it can hold the request */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sg_one_sbale</span><span class="p">(</span><span class="n">sg_req</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">zfcp_qdio_sg_one_sbale</span><span class="p">(</span><span class="n">sg_resp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">zfcp_fsf_setup_ct_els_unchained</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span>
						<span class="n">sg_req</span><span class="p">,</span> <span class="n">sg_resp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">feat</span> <span class="o">&amp;</span> <span class="n">FSF_FEATURE_ELS_CT_CHAINED_SBALS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbals_from_sg</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span> <span class="n">sg_req</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">req_buf_length</span> <span class="o">=</span> <span class="n">zfcp_qdio_real_bytes</span><span class="p">(</span><span class="n">sg_req</span><span class="p">);</span>

	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>
	<span class="n">zfcp_qdio_skip_to_last_sbale</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbals_from_sg</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span> <span class="n">sg_resp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">resp_buf_length</span> <span class="o">=</span> <span class="n">zfcp_qdio_real_bytes</span><span class="p">(</span><span class="n">sg_resp</span><span class="p">);</span>

	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_fsf_setup_ct_els</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_req</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_resp</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">zfcp_fsf_setup_ct_els_sbals</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">sg_req</span><span class="p">,</span> <span class="n">sg_resp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* common settings for ct/gs and els requests */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="cm">/* max value accepted by hardware */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">service_class</span> <span class="o">=</span> <span class="n">FSF_CLASS_3</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">zfcp_fsf_start_timer</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_send_ct - initiate a Generic Service request (FC-GS)</span>
<span class="cm"> * @ct: pointer to struct zfcp_send_ct with data for request</span>
<span class="cm"> * @pool: if non-null this mempool is used to allocate struct zfcp_fsf_req</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_send_ct</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fc_wka_port</span> <span class="o">*</span><span class="n">wka_port</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">zfcp_fsf_ct_els</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span> <span class="n">mempool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_SEND_GENERIC</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_WRITE_READ</span><span class="p">,</span> <span class="n">pool</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">zfcp_fsf_setup_ct_els</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_send</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_send_ct_handler</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">port_handle</span> <span class="o">=</span> <span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ct</span><span class="p">;</span>

	<span class="n">zfcp_dbf_san_req</span><span class="p">(</span><span class="s">&quot;fssct_1&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_send</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">failed_send:</span>
	<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_send_els_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_ct_els</span> <span class="o">*</span><span class="n">send_els</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">send_els</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>

	<span class="n">send_els</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_fsfstatus</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_GOOD</span>:
		<span class="n">zfcp_dbf_san_res</span><span class="p">(</span><span class="s">&quot;fsselh1&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">send_els</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_SERVICE_CLASS_NOT_SUPPORTED</span>:
		<span class="n">zfcp_fsf_class_not_supp</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ADAPTER_STATUS_AVAILABLE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status_qual</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]){</span>
		<span class="k">case</span> <span class="n">FSF_SQ_INVOKE_LINK_TEST_PROCEDURE</span>:
		<span class="k">case</span> <span class="n">FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED</span>:
		<span class="k">case</span> <span class="n">FSF_SQ_RETRY_IF_POSSIBLE</span>:
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ELS_COMMAND_REJECTED</span>:
	<span class="k">case</span> <span class="n">FSF_PAYLOAD_SIZE_MISMATCH</span>:
	<span class="k">case</span> <span class="n">FSF_REQUEST_SIZE_TOO_LARGE</span>:
	<span class="k">case</span> <span class="n">FSF_RESPONSE_SIZE_TOO_LARGE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ACCESS_DENIED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zfcp_cfdc_port_denied</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status_qual</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_SBAL_MISMATCH</span>:
		<span class="cm">/* should never occur, avoided in zfcp_fsf_send_els */</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">skip_fsfstatus:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">send_els</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
		<span class="n">send_els</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">send_els</span><span class="o">-&gt;</span><span class="n">handler_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_send_els - initiate an ELS command (FC-FS)</span>
<span class="cm"> * @els: pointer to struct zfcp_send_els with data for the command</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_send_els</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">d_id</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">zfcp_fsf_ct_els</span> <span class="o">*</span><span class="n">els</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_SEND_ELS</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_WRITE_READ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zfcp_adapter_multi_buffer_active</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">zfcp_qdio_sbal_limit</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">zfcp_fsf_setup_ct_els</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">els</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">els</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_send</span><span class="p">;</span>

	<span class="n">hton24</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">d_id</span><span class="p">,</span> <span class="n">d_id</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_send_els_handler</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">els</span><span class="p">;</span>

	<span class="n">zfcp_dbf_san_req</span><span class="p">(</span><span class="s">&quot;fssels1&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">d_id</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_send</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">failed_send:</span>
	<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">zfcp_fsf_exchange_config_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_EXCHANGE_CONFIG_DATA</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">,</span>
				  <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">erp_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">;</span>
	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">feature_selection</span> <span class="o">=</span>
			<span class="n">FSF_FEATURE_CFDC</span> <span class="o">|</span>
			<span class="n">FSF_FEATURE_LUN_SHARING</span> <span class="o">|</span>
			<span class="n">FSF_FEATURE_NOTIFICATION_LOST</span> <span class="o">|</span>
			<span class="n">FSF_FEATURE_UPDATE_ALERT</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">erp_action</span> <span class="o">=</span> <span class="n">erp_action</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_exchange_config_data_handler</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>

	<span class="n">zfcp_fsf_start_erp_timer</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">zfcp_fsf_exchange_config_data_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">fsf_qtcb_bottom_config</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_EXCHANGE_CONFIG_DATA</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_exchange_config_data_handler</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">feature_selection</span> <span class="o">=</span>
			<span class="n">FSF_FEATURE_CFDC</span> <span class="o">|</span>
			<span class="n">FSF_FEATURE_LUN_SHARING</span> <span class="o">|</span>
			<span class="n">FSF_FEATURE_NOTIFICATION_LOST</span> <span class="o">|</span>
			<span class="n">FSF_FEATURE_UPDATE_ALERT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">zfcp_fsf_start_timer</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ZFCP_FSF_REQUEST_TIMEOUT</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>

	<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_exchange_port_data - request information about local port</span>
<span class="cm"> * @erp_action: ERP action for the adapter for which port data is requested</span>
<span class="cm"> * Returns: 0 on success, error otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_exchange_port_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_features</span> <span class="o">&amp;</span> <span class="n">FSF_FEATURE_HBAAPI_MANAGEMENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_EXCHANGE_PORT_DATA</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">,</span>
				  <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">erp_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">;</span>
	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_exchange_port_data_handler</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">erp_action</span> <span class="o">=</span> <span class="n">erp_action</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>

	<span class="n">zfcp_fsf_start_erp_timer</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_exchange_port_data_sync - request information about local port</span>
<span class="cm"> * @qdio: pointer to struct zfcp_qdio</span>
<span class="cm"> * @data: pointer to struct fsf_qtcb_bottom_port</span>
<span class="cm"> * Returns: 0 on success, error otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_exchange_port_data_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">fsf_qtcb_bottom_port</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_features</span> <span class="o">&amp;</span> <span class="n">FSF_FEATURE_HBAAPI_MANAGEMENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_EXCHANGE_PORT_DATA</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_exchange_port_data_handler</span><span class="p">;</span>
	<span class="n">zfcp_fsf_start_timer</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ZFCP_FSF_REQUEST_TIMEOUT</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>

	<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_open_port_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">plogi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_PORT_ALREADY_OPEN</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ACCESS_DENIED</span>:
		<span class="n">zfcp_cfdc_port_denied</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status_qual</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_MAXIMUM_NUMBER_OF_PORTS_EXCEEDED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Not enough FCP adapter resources to open &quot;</span>
			 <span class="s">&quot;remote port 0x%016Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">);</span>
		<span class="n">zfcp_erp_set_port_status</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
					 <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ADAPTER_STATUS_AVAILABLE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status_qual</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FSF_SQ_INVOKE_LINK_TEST_PROCEDURE</span>:
		<span class="k">case</span> <span class="n">FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED</span>:
		<span class="k">case</span> <span class="n">FSF_SQ_NO_RETRY_POSSIBLE</span>:
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_GOOD</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">port_handle</span><span class="p">;</span>
		<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_OPEN</span> <span class="o">|</span>
				<span class="n">ZFCP_STATUS_PORT_PHYS_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_ACCESS_DENIED</span> <span class="o">|</span>
		                  <span class="n">ZFCP_STATUS_COMMON_ACCESS_BOXED</span><span class="p">,</span>
		                  <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="cm">/* check whether D_ID has changed during open */</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: This check is not airtight, as the FCP channel does</span>
<span class="cm">		 * not monitor closures of target port connections caused on</span>
<span class="cm">		 * the remote side. Thus, they might miss out on invalidating</span>
<span class="cm">		 * locally cached WWPNs (and other N_Port parameters) of gone</span>
<span class="cm">		 * target ports. So, our heroic attempt to make things safe</span>
<span class="cm">		 * could be undermined by &#39;open port&#39; response data tagged with</span>
<span class="cm">		 * obsolete WWPNs. Another reason to monitor potential</span>
<span class="cm">		 * connection closures ourself at least (by interpreting</span>
<span class="cm">		 * incoming ELS&#39; and unsolicited status). It just crosses my</span>
<span class="cm">		 * mind that one should be able to cross-check by means of</span>
<span class="cm">		 * another GID_PN straight after a port has been opened.</span>
<span class="cm">		 * Alternately, an ADISC/PDISC ELS should suffice, as well.</span>
<span class="cm">		 */</span>
		<span class="n">plogi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">els</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">els1_length</span> <span class="o">&gt;=</span>
		    <span class="n">FSF_PLOGI_MIN_LEN</span><span class="p">)</span>
				<span class="n">zfcp_fc_plogi_evaluate</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">plogi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_UNKNOWN_OP_SUBTYPE</span>:
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_open_port - create and send open port request</span>
<span class="cm"> * @erp_action: pointer to struct zfcp_erp_action</span>
<span class="cm"> * Returns: 0 on success, error otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_open_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_OPEN_PORT_WITH_DID</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">,</span>
				  <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">erp_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">;</span>
	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_open_port_handler</span><span class="p">;</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">d_id</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">erp_action</span> <span class="o">=</span> <span class="n">erp_action</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>
	<span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">zfcp_fsf_start_erp_timer</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_close_port_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_PORT_HANDLE_NOT_VALID</span>:
		<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fscph_1&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ADAPTER_STATUS_AVAILABLE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_GOOD</span>:
		<span class="n">zfcp_erp_clear_port_status</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_close_port - create and send close port request</span>
<span class="cm"> * @erp_action: pointer to struct zfcp_erp_action</span>
<span class="cm"> * Returns: 0 on success, error otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_close_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_CLOSE_PORT</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">,</span>
				  <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">erp_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">;</span>
	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_close_port_handler</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">erp_action</span> <span class="o">=</span> <span class="n">erp_action</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">port_handle</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>

	<span class="n">zfcp_fsf_start_erp_timer</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_open_wka_port_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_fc_wka_port</span> <span class="o">*</span><span class="n">wka_port</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ZFCP_FC_WKA_PORT_OFFLINE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_MAXIMUM_NUMBER_OF_PORTS_EXCEEDED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Opening WKA port 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FSF_ADAPTER_STATUS_AVAILABLE</span>:
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FSF_ACCESS_DENIED</span>:
		<span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ZFCP_FC_WKA_PORT_OFFLINE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_GOOD</span>:
		<span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">port_handle</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FSF_PORT_ALREADY_OPEN</span>:
		<span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ZFCP_FC_WKA_PORT_ONLINE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">completion_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_open_wka_port - create and send open wka-port request</span>
<span class="cm"> * @wka_port: pointer to struct zfcp_fc_wka_port</span>
<span class="cm"> * Returns: 0 on success, error otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_open_wka_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fc_wka_port</span> <span class="o">*</span><span class="n">wka_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_OPEN_PORT_WITH_DID</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">,</span>
				  <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">erp_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">;</span>
	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_open_wka_port_handler</span><span class="p">;</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">d_id</span><span class="p">,</span> <span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">wka_port</span><span class="p">;</span>

	<span class="n">zfcp_fsf_start_timer</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ZFCP_FSF_REQUEST_TIMEOUT</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_close_wka_port_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_fc_wka_port</span> <span class="o">*</span><span class="n">wka_port</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status</span> <span class="o">==</span> <span class="n">FSF_PORT_HANDLE_NOT_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fscwph1&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ZFCP_FC_WKA_PORT_OFFLINE</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">completion_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_close_wka_port - create and send close wka port request</span>
<span class="cm"> * @wka_port: WKA port to open</span>
<span class="cm"> * Returns: 0 on success, error otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_close_wka_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fc_wka_port</span> <span class="o">*</span><span class="n">wka_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_CLOSE_PORT</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">,</span>
				  <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">erp_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">;</span>
	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_close_wka_port_handler</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">wka_port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">port_handle</span> <span class="o">=</span> <span class="n">wka_port</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">zfcp_fsf_start_timer</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ZFCP_FSF_REQUEST_TIMEOUT</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_close_physical_port_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_PORT_HANDLE_NOT_VALID</span>:
		<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fscpph1&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ACCESS_DENIED</span>:
		<span class="n">zfcp_cfdc_port_denied</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status_qual</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PORT_BOXED</span>:
		<span class="cm">/* can&#39;t use generic zfcp_erp_modify_port_status because</span>
<span class="cm">		 * ZFCP_STATUS_COMMON_OPEN must not be reset for the port */</span>
		<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_PORT_PHYS_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span>
				<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">zfcp_erp_set_port_status</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ACCESS_BOXED</span><span class="p">);</span>
		<span class="n">zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span>
				     <span class="s">&quot;fscpph2&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ADAPTER_STATUS_AVAILABLE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status_qual</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FSF_SQ_INVOKE_LINK_TEST_PROCEDURE</span>:
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED</span>:
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_GOOD</span>:
		<span class="cm">/* can&#39;t use generic zfcp_erp_modify_port_status because</span>
<span class="cm">		 * ZFCP_STATUS_COMMON_OPEN must not be reset for the port</span>
<span class="cm">		 */</span>
		<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_PORT_PHYS_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span>
				<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_close_physical_port - close physical port</span>
<span class="cm"> * @erp_action: pointer to struct zfcp_erp_action</span>
<span class="cm"> * Returns: 0 on success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_close_physical_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_CLOSE_PHYSICAL_PORT</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">,</span>
				  <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">erp_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">;</span>
	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">port_handle</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">erp_action</span> <span class="o">=</span> <span class="n">erp_action</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_close_physical_port_handler</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>

	<span class="n">zfcp_fsf_start_erp_timer</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_open_lun_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_bottom_support</span> <span class="o">*</span><span class="n">bottom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_ACCESS_DENIED</span> <span class="o">|</span>
			  <span class="n">ZFCP_STATUS_COMMON_ACCESS_BOXED</span> <span class="o">|</span>
			  <span class="n">ZFCP_STATUS_LUN_SHARED</span> <span class="o">|</span>
			  <span class="n">ZFCP_STATUS_LUN_READONLY</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">FSF_PORT_HANDLE_NOT_VALID</span>:
		<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fsouh_1&quot;</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FSF_LUN_ALREADY_OPEN</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ACCESS_DENIED</span>:
		<span class="n">zfcp_cfdc_lun_denied</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status_qual</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PORT_BOXED</span>:
		<span class="n">zfcp_erp_set_port_status</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
					 <span class="n">ZFCP_STATUS_COMMON_ACCESS_BOXED</span><span class="p">);</span>
		<span class="n">zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
				     <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span> <span class="s">&quot;fsouh_2&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_LUN_SHARING_VIOLATION</span>:
		<span class="n">zfcp_cfdc_lun_shrng_vltn</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status_qual</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_MAXIMUM_NUMBER_OF_LUNS_EXCEEDED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;No handle is available for LUN &quot;</span>
			 <span class="s">&quot;0x%016Lx on port 0x%016Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">zfcp_scsi_dev_lun</span><span class="p">(</span><span class="n">sdev</span><span class="p">),</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">);</span>
		<span class="n">zfcp_erp_set_lun_status</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FSF_INVALID_COMMAND_OPTION</span>:
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ADAPTER_STATUS_AVAILABLE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status_qual</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FSF_SQ_INVOKE_LINK_TEST_PROCEDURE</span>:
			<span class="n">zfcp_fc_test_link</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED</span>:
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FSF_GOOD</span>:
		<span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">lun_handle</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">lun_handle</span><span class="p">;</span>
		<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">zfcp_cfdc_open_lun_eval</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">bottom</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_open_lun - open LUN</span>
<span class="cm"> * @erp_action: pointer to struct zfcp_erp_action</span>
<span class="cm"> * Returns: 0 on success, error otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_open_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_OPEN_LUN</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">,</span>
				  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">erp_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">;</span>
	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">port_handle</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">fcp_lun</span> <span class="o">=</span> <span class="n">zfcp_scsi_dev_lun</span><span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_open_lun_handler</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">erp_action</span> <span class="o">=</span> <span class="n">erp_action</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">connection_features</span> <span class="o">&amp;</span> <span class="n">FSF_FEATURE_NPIV_MODE</span><span class="p">))</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">.</span><span class="n">option</span> <span class="o">=</span> <span class="n">FSF_OPEN_LUN_SUPPRESS_BOXING</span><span class="p">;</span>

	<span class="n">zfcp_fsf_start_erp_timer</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_close_lun_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_PORT_HANDLE_NOT_VALID</span>:
		<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fscuh_1&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_LUN_HANDLE_NOT_VALID</span>:
		<span class="n">zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fscuh_2&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PORT_BOXED</span>:
		<span class="n">zfcp_erp_set_port_status</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
					 <span class="n">ZFCP_STATUS_COMMON_ACCESS_BOXED</span><span class="p">);</span>
		<span class="n">zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
				     <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span> <span class="s">&quot;fscuh_3&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ADAPTER_STATUS_AVAILABLE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status_qual</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FSF_SQ_INVOKE_LINK_TEST_PROCEDURE</span>:
			<span class="n">zfcp_fc_test_link</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED</span>:
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_GOOD</span>:
		<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_close_LUN - close LUN</span>
<span class="cm"> * @erp_action: pointer to erp_action triggering the &quot;close LUN&quot;</span>
<span class="cm"> * Returns: 0 on success, error otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_close_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_CLOSE_LUN</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">,</span>
				  <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">erp_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">;</span>
	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">port_handle</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">lun_handle</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">lun_handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_close_lun_handler</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">erp_action</span> <span class="o">=</span> <span class="n">erp_action</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>

	<span class="n">zfcp_fsf_start_erp_timer</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_update_lat</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsf_latency_record</span> <span class="o">*</span><span class="n">lat_rec</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lat_rec</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">lat</span><span class="p">;</span>
	<span class="n">lat_rec</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">lat_rec</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">,</span> <span class="n">lat</span><span class="p">);</span>
	<span class="n">lat_rec</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">lat_rec</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">,</span> <span class="n">lat</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_req_trace</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsf_qual_latency_info</span> <span class="o">*</span><span class="n">lat_in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">latency_cont</span> <span class="o">*</span><span class="n">lat</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">scsi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_blk_drv_data</span> <span class="n">blktrc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ticks</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">timer_ticks</span><span class="p">;</span>

	<span class="n">lat_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">.</span><span class="n">prot_status_qual</span><span class="p">.</span><span class="n">latency_info</span><span class="p">;</span>

	<span class="n">blktrc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">blktrc</span><span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">ZFCP_BLK_DRV_DATA_MAGIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">)</span>
		<span class="n">blktrc</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ZFCP_BLK_REQ_ERROR</span><span class="p">;</span>
	<span class="n">blktrc</span><span class="p">.</span><span class="n">inb_usage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">blktrc</span><span class="p">.</span><span class="n">outb_usage</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">.</span><span class="n">qdio_outb_usage</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_features</span> <span class="o">&amp;</span> <span class="n">FSF_FEATURE_MEASUREMENT_DATA</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blktrc</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ZFCP_BLK_LAT_VALID</span><span class="p">;</span>
		<span class="n">blktrc</span><span class="p">.</span><span class="n">channel_lat</span> <span class="o">=</span> <span class="n">lat_in</span><span class="o">-&gt;</span><span class="n">channel_lat</span> <span class="o">*</span> <span class="n">ticks</span><span class="p">;</span>
		<span class="n">blktrc</span><span class="p">.</span><span class="n">fabric_lat</span> <span class="o">=</span> <span class="n">lat_in</span><span class="o">-&gt;</span><span class="n">fabric_lat</span> <span class="o">*</span> <span class="n">ticks</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">data_direction</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FSF_DATADIR_DIF_READ_STRIP</span>:
		<span class="k">case</span> <span class="n">FSF_DATADIR_DIF_READ_CONVERT</span>:
		<span class="k">case</span> <span class="n">FSF_DATADIR_READ</span>:
			<span class="n">lat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">latencies</span><span class="p">.</span><span class="n">read</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FSF_DATADIR_DIF_WRITE_INSERT</span>:
		<span class="k">case</span> <span class="n">FSF_DATADIR_DIF_WRITE_CONVERT</span>:
		<span class="k">case</span> <span class="n">FSF_DATADIR_WRITE</span>:
			<span class="n">lat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">latencies</span><span class="p">.</span><span class="n">write</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FSF_DATADIR_CMND</span>:
			<span class="n">lat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">latencies</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">latencies</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">zfcp_fsf_update_lat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lat</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">lat_in</span><span class="o">-&gt;</span><span class="n">channel_lat</span><span class="p">);</span>
			<span class="n">zfcp_fsf_update_lat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lat</span><span class="o">-&gt;</span><span class="n">fabric</span><span class="p">,</span> <span class="n">lat_in</span><span class="o">-&gt;</span><span class="n">fabric_lat</span><span class="p">);</span>
			<span class="n">lat</span><span class="o">-&gt;</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">latencies</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">blk_add_driver_data</span><span class="p">(</span><span class="n">scsi</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">scsi</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blktrc</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">blktrc</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_fcp_handler_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmnd</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_HANDLE_MISMATCH</span>:
	<span class="k">case</span> <span class="n">FSF_PORT_HANDLE_NOT_VALID</span>:
		<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fssfch1&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_FCPLUN_NOT_VALID</span>:
	<span class="k">case</span> <span class="n">FSF_LUN_HANDLE_NOT_VALID</span>:
		<span class="n">zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fssfch2&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_SERVICE_CLASS_NOT_SUPPORTED</span>:
		<span class="n">zfcp_fsf_class_not_supp</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ACCESS_DENIED</span>:
		<span class="n">zfcp_cfdc_lun_denied</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status_qual</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_DIRECTION_INDICATOR_NOT_VALID</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Incorrect direction %d, LUN 0x%016Lx on port &quot;</span>
			<span class="s">&quot;0x%016Lx closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">data_direction</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">zfcp_scsi_dev_lun</span><span class="p">(</span><span class="n">sdev</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="s">&quot;fssfch3&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_CMND_LENGTH_NOT_VALID</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Incorrect CDB length %d, LUN 0x%016Lx on &quot;</span>
			<span class="s">&quot;port 0x%016Lx closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">fcp_cmnd_length</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">zfcp_scsi_dev_lun</span><span class="p">(</span><span class="n">sdev</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="s">&quot;fssfch4&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_PORT_BOXED</span>:
		<span class="n">zfcp_erp_set_port_status</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
					 <span class="n">ZFCP_STATUS_COMMON_ACCESS_BOXED</span><span class="p">);</span>
		<span class="n">zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
				     <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span> <span class="s">&quot;fssfch5&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_LUN_BOXED</span>:
		<span class="n">zfcp_erp_set_lun_status</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ACCESS_BOXED</span><span class="p">);</span>
		<span class="n">zfcp_erp_lun_reopen</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span>
				    <span class="s">&quot;fssfch6&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_ADAPTER_STATUS_AVAILABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fsf_status_qual</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span>
		    <span class="n">FSF_SQ_INVOKE_LINK_TEST_PROCEDURE</span><span class="p">)</span>
			<span class="n">zfcp_fc_test_link</span><span class="p">(</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_fcp_cmnd_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcp_resp_with_ext</span> <span class="o">*</span><span class="n">fcp_rsp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">read_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">abort_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">scpnt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">scpnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">abort_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zfcp_fsf_fcp_handler_common</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_host_byte</span><span class="p">(</span><span class="n">scpnt</span><span class="p">,</span> <span class="n">DID_TRANSPORT_DISRUPTED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_fsfstatus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">fsf_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_INCONSISTENT_PROT_DATA</span>:
	<span class="k">case</span> <span class="n">FSF_INVALID_PROT_PARM</span>:
		<span class="n">set_host_byte</span><span class="p">(</span><span class="n">scpnt</span><span class="p">,</span> <span class="n">DID_ERROR</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_fsfstatus</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_BLOCK_GUARD_CHECK_FAILURE</span>:
		<span class="n">zfcp_scsi_dif_sense_error</span><span class="p">(</span><span class="n">scpnt</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_fsfstatus</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_APP_TAG_CHECK_FAILURE</span>:
		<span class="n">zfcp_scsi_dif_sense_error</span><span class="p">(</span><span class="n">scpnt</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_fsfstatus</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_REF_TAG_CHECK_FAILURE</span>:
		<span class="n">zfcp_scsi_dif_sense_error</span><span class="p">(</span><span class="n">scpnt</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_fsfstatus</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fcp_rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcp_resp_with_ext</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">fcp_rsp</span><span class="p">;</span>
	<span class="n">zfcp_fc_eval_fcp_rsp</span><span class="p">(</span><span class="n">fcp_rsp</span><span class="p">,</span> <span class="n">scpnt</span><span class="p">);</span>

<span class="nl">skip_fsfstatus:</span>
	<span class="n">zfcp_fsf_req_trace</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">scpnt</span><span class="p">);</span>
	<span class="n">zfcp_dbf_scsi_result</span><span class="p">(</span><span class="n">scpnt</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">scpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="n">scpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">)</span> <span class="p">(</span><span class="n">scpnt</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We must hold this lock until scsi_done has been called.</span>
<span class="cm">	 * Otherwise we may call scsi_done after abort regarding this</span>
<span class="cm">	 * command has completed.</span>
<span class="cm">	 * Note: scsi_done must not block!</span>
<span class="cm">	 */</span>
	<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">abort_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_fsf_set_data_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmnd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data_dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">scsi_cmnd</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_NORMAL</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">scsi_cmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DMA_NONE</span>:
			<span class="o">*</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">FSF_DATADIR_CMND</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_FROM_DEVICE</span>:
			<span class="o">*</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">FSF_DATADIR_READ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_TO_DEVICE</span>:
			<span class="o">*</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">FSF_DATADIR_WRITE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_BIDIRECTIONAL</span>:
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCSI_PROT_READ_STRIP</span>:
		<span class="o">*</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">FSF_DATADIR_DIF_READ_STRIP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_WRITE_INSERT</span>:
		<span class="o">*</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">FSF_DATADIR_DIF_WRITE_INSERT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_READ_PASS</span>:
		<span class="o">*</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">FSF_DATADIR_DIF_READ_CONVERT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_WRITE_PASS</span>:
		<span class="o">*</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">FSF_DATADIR_DIF_WRITE_CONVERT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_fcp_cmnd - initiate an FCP command (for a SCSI command)</span>
<span class="cm"> * @scsi_cmnd: scsi command to be sent</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_fsf_fcp_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmnd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcp_cmnd</span> <span class="o">*</span><span class="n">fcp_cmnd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sbtype</span> <span class="o">=</span> <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">scsi_cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_bottom_io</span> <span class="o">*</span><span class="n">io</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span>
		       <span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_free</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_full</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_cmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">sbtype</span> <span class="o">=</span> <span class="n">SBAL_SFLAGS0_TYPE_WRITE</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_FCP_CMND</span><span class="p">,</span>
				  <span class="n">sbtype</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">scsi_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_cmnd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>

	<span class="n">io</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">io</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_CLEANUP</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">scsi_cmnd</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_fcp_cmnd_handler</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">lun_handle</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">lun_handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">port_handle</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">service_class</span> <span class="o">=</span> <span class="n">FSF_CLASS_3</span><span class="p">;</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">fcp_cmnd_length</span> <span class="o">=</span> <span class="n">FCP_CMND_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">scsi_cmnd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SCSI_PROT_NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">data_block_length</span> <span class="o">=</span> <span class="n">scsi_cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">ref_tag_value</span> <span class="o">=</span> <span class="n">scsi_get_lba</span><span class="p">(</span><span class="n">scsi_cmnd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_fsf_set_data_dir</span><span class="p">(</span><span class="n">scsi_cmnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">data_direction</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed_scsi_cmnd</span><span class="p">;</span>

	<span class="n">fcp_cmnd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcp_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">;</span>
	<span class="n">zfcp_fc_scsi_to_fcp</span><span class="p">(</span><span class="n">fcp_cmnd</span><span class="p">,</span> <span class="n">scsi_cmnd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_prot_sg_count</span><span class="p">(</span><span class="n">scsi_cmnd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">zfcp_qdio_set_data_div</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span>
				       <span class="n">scsi_prot_sg_count</span><span class="p">(</span><span class="n">scsi_cmnd</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_qdio_sbals_from_sg</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span>
						 <span class="n">scsi_prot_sglist</span><span class="p">(</span><span class="n">scsi_cmnd</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failed_scsi_cmnd</span><span class="p">;</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">prot_data_length</span> <span class="o">=</span> <span class="n">zfcp_qdio_real_bytes</span><span class="p">(</span>
						<span class="n">scsi_prot_sglist</span><span class="p">(</span><span class="n">scsi_cmnd</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_qdio_sbals_from_sg</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span>
					 <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">scsi_cmnd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">retval</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed_scsi_cmnd</span><span class="p">;</span>

	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_adapter_multi_buffer_active</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">zfcp_qdio_set_scount</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">retval</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed_scsi_cmnd</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">failed_scsi_cmnd:</span>
	<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">scsi_cmnd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_fcp_task_mgmt_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcp_resp_with_ext</span> <span class="o">*</span><span class="n">fcp_rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcp_resp_rsp_info</span> <span class="o">*</span><span class="n">rsp_info</span><span class="p">;</span>

	<span class="n">zfcp_fsf_fcp_handler_common</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">fcp_rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcp_resp_with_ext</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">fcp_rsp</span><span class="p">;</span>
	<span class="n">rsp_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcp_resp_rsp_info</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fcp_rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rsp_info</span><span class="o">-&gt;</span><span class="n">rsp_code</span> <span class="o">!=</span> <span class="n">FCP_TMF_CMPL</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_ERROR</span><span class="p">))</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_TMFUNCFAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_fcp_task_mgmt - send SCSI task management command</span>
<span class="cm"> * @scmnd: SCSI command to send the task management command for</span>
<span class="cm"> * @tm_flags: unsigned byte for task management flags</span>
<span class="cm"> * Returns: on success pointer to struct fsf_req, NULL otherwise</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="nf">zfcp_fsf_fcp_task_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmnd</span><span class="p">,</span>
					    <span class="n">u8</span> <span class="n">tm_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcp_cmnd</span> <span class="o">*</span><span class="n">fcp_cmnd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">scmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span>
		       <span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">FSF_QTCB_FCP_CMND</span><span class="p">,</span>
				  <span class="n">SBAL_SFLAGS0_TYPE_WRITE</span><span class="p">,</span>
				  <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">scsi_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">scmnd</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_fcp_task_mgmt_handler</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">lun_handle</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">lun_handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">port_handle</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">FSF_DATADIR_CMND</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">service_class</span> <span class="o">=</span> <span class="n">FSF_CLASS_3</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">fcp_cmnd_length</span> <span class="o">=</span> <span class="n">FCP_CMND_LEN</span><span class="p">;</span>

	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">fcp_cmnd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcp_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">fcp_cmnd</span><span class="p">;</span>
	<span class="n">zfcp_fc_scsi_to_fcp</span><span class="p">(</span><span class="n">fcp_cmnd</span><span class="p">,</span> <span class="n">scmnd</span><span class="p">,</span> <span class="n">tm_flags</span><span class="p">);</span>

	<span class="n">zfcp_fsf_start_timer</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ZFCP_SCSI_ER_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_fsf_control_file_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_control_file - control file upload/download</span>
<span class="cm"> * @adapter: pointer to struct zfcp_adapter</span>
<span class="cm"> * @fsf_cfdc: pointer to struct zfcp_fsf_cfdc</span>
<span class="cm"> * Returns: on success pointer to struct zfcp_fsf_req, NULL otherwise</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="nf">zfcp_fsf_control_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">zfcp_fsf_cfdc</span> <span class="o">*</span><span class="n">fsf_cfdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_bottom_support</span> <span class="o">*</span><span class="n">bottom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">direction</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_features</span> <span class="o">&amp;</span> <span class="n">FSF_FEATURE_CFDC</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fsf_cfdc</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSF_QTCB_DOWNLOAD_CONTROL_FILE</span>:
		<span class="n">direction</span> <span class="o">=</span> <span class="n">SBAL_SFLAGS0_TYPE_WRITE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FSF_QTCB_UPLOAD_CONTROL_FILE</span>:
		<span class="n">direction</span> <span class="o">=</span> <span class="n">SBAL_SFLAGS0_TYPE_READ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_sbal_get</span><span class="p">(</span><span class="n">qdio</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_create</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="n">fsf_cfdc</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">zfcp_fsf_control_file_handler</span><span class="p">;</span>

	<span class="n">bottom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qtcb</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">support</span><span class="p">;</span>
	<span class="n">bottom</span><span class="o">-&gt;</span><span class="n">operation_subtype</span> <span class="o">=</span> <span class="n">FSF_CFDC_OPERATION_SUBTYPE</span><span class="p">;</span>
	<span class="n">bottom</span><span class="o">-&gt;</span><span class="n">option</span> <span class="o">=</span> <span class="n">fsf_cfdc</span><span class="o">-&gt;</span><span class="n">option</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_qdio_sbals_from_sg</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">,</span> <span class="n">fsf_cfdc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">zfcp_qdio_real_bytes</span><span class="p">(</span><span class="n">fsf_cfdc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ZFCP_CFDC_MAX_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">zfcp_fsf_req_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">zfcp_qdio_set_sbale_last</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_adapter_multi_buffer_active</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">zfcp_qdio_set_scount</span><span class="p">(</span><span class="n">qdio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">);</span>

	<span class="n">zfcp_fsf_start_timer</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ZFCP_FSF_REQUEST_TIMEOUT</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_req_send</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_fsf_reqid_check - validate req_id contained in SBAL returned by QDIO</span>
<span class="cm"> * @adapter: pointer to struct zfcp_adapter</span>
<span class="cm"> * @sbal_idx: response queue index of SBAL to be processed</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_fsf_reqid_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sbal_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">*</span><span class="n">sbal</span> <span class="o">=</span> <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">res_q</span><span class="p">[</span><span class="n">sbal_idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qdio_buffer_element</span> <span class="o">*</span><span class="n">sbale</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">fsf_req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">QDIO_MAX_ELEMENTS_PER_BUFFER</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">sbale</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbal</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">req_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sbale</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">fsf_req</span> <span class="o">=</span> <span class="n">zfcp_reqlist_find_rm</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">req_list</span><span class="p">,</span> <span class="n">req_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsf_req</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Unknown request means that we have potentially memory</span>
<span class="cm">			 * corruption and must stop the machine immediately.</span>
<span class="cm">			 */</span>
			<span class="n">zfcp_qdio_siosl</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;error: unknown req_id (%lx) on adapter %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">req_id</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">fsf_req</span><span class="o">-&gt;</span><span class="n">qdio_req</span><span class="p">.</span><span class="n">sbal_response</span> <span class="o">=</span> <span class="n">sbal_idx</span><span class="p">;</span>
		<span class="n">zfcp_fsf_req_complete</span><span class="p">(</span><span class="n">fsf_req</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">sbale</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">SBAL_EFLAGS_LAST_ENTRY</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="nf">zfcp_fsf_get_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">qdio_buffer</span> <span class="o">*</span><span class="n">sbal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qdio_buffer_element</span> <span class="o">*</span><span class="n">sbale</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbal</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">req_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sbale</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">zfcp_reqlist_find</span><span class="p">(</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">req_list</span><span class="p">,</span> <span class="n">req_id</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
