<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › scsi › zfcp_unit.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>zfcp_unit.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * zfcp device driver</span>
<span class="cm"> *</span>
<span class="cm"> * Tracking of manually configured LUNs and helper functions to</span>
<span class="cm"> * register the LUNs with the SCSI midlayer.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright IBM Corporation 2010</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;zfcp_def.h&quot;</span>
<span class="cp">#include &quot;zfcp_ext.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_unit_scsi_scan - Register LUN with SCSI midlayer</span>
<span class="cm"> * @unit: The zfcp LUN/unit to register</span>
<span class="cm"> *</span>
<span class="cm"> * When the SCSI midlayer is not allowed to automatically scan and</span>
<span class="cm"> * attach SCSI devices, zfcp has to register the single devices with</span>
<span class="cm"> * the SCSI midlayer.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_unit_scsi_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">unit</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">;</span>

	<span class="n">lun</span> <span class="o">=</span> <span class="n">scsilun_to_int</span><span class="p">((</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">fcp_lun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span> <span class="o">&amp;&amp;</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">==</span> <span class="n">FC_PORTSTATE_ONLINE</span><span class="p">)</span>
		<span class="n">scsi_scan_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">scsi_target_id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_unit_scsi_scan_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="n">unit</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zfcp_unit</span><span class="p">,</span>
					      <span class="n">scsi_work</span><span class="p">);</span>

	<span class="n">zfcp_unit_scsi_scan</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_unit_queue_scsi_scan - Register configured units on port</span>
<span class="cm"> * @port: The zfcp_port where to register units</span>
<span class="cm"> *</span>
<span class="cm"> * After opening a port, all units configured on this port have to be</span>
<span class="cm"> * registered with the SCSI midlayer. This function should be called</span>
<span class="cm"> * after calling fc_remote_port_add, so that the fc_rport is already</span>
<span class="cm"> * ONLINE and the call to scsi_scan_target runs the same way as the</span>
<span class="cm"> * call in the FC transport class.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_unit_queue_scsi_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="n">unit</span><span class="p">;</span>

	<span class="n">read_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">unit_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">unit_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_queue_work</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">scsi_work</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">unit_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="nf">_zfcp_unit_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u64</span> <span class="n">fcp_lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="n">unit</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">unit_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">fcp_lun</span> <span class="o">==</span> <span class="n">fcp_lun</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">unit</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_unit_find - Find and return zfcp_unit with specified FCP LUN</span>
<span class="cm"> * @port: zfcp_port where to look for the unit</span>
<span class="cm"> * @fcp_lun: 64 Bit FCP LUN used to identify the zfcp_unit</span>
<span class="cm"> *</span>
<span class="cm"> * If zfcp_unit is found, a reference is acquired that has to be</span>
<span class="cm"> * released later.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: Pointer to the zfcp_unit, or NULL if there is no zfcp_unit</span>
<span class="cm"> *          with the specified FCP LUN.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="nf">zfcp_unit_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u64</span> <span class="n">fcp_lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="n">unit</span><span class="p">;</span>

	<span class="n">read_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">unit_list_lock</span><span class="p">);</span>
	<span class="n">unit</span> <span class="o">=</span> <span class="n">_zfcp_unit_find</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">fcp_lun</span><span class="p">);</span>
	<span class="n">read_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">unit_list_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">unit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_unit_release - Drop reference to zfcp_port and free memory of zfcp_unit.</span>
<span class="cm"> * @dev: pointer to device in zfcp_unit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_unit_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="n">unit</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zfcp_unit</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_unit_enqueue - enqueue unit to unit list of a port.</span>
<span class="cm"> * @port: pointer to port where unit is added</span>
<span class="cm"> * @fcp_lun: FCP LUN of unit to be enqueued</span>
<span class="cm"> * Returns: 0 success</span>
<span class="cm"> *</span>
<span class="cm"> * Sets up some unit internal structures and creates sysfs entry.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_unit_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u64</span> <span class="n">fcp_lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="n">unit</span><span class="p">;</span>

	<span class="n">unit</span> <span class="o">=</span> <span class="n">zfcp_unit_find</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">fcp_lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">unit</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_unit</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unit</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">unit</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">unit</span><span class="o">-&gt;</span><span class="n">fcp_lun</span> <span class="o">=</span> <span class="n">fcp_lun</span><span class="p">;</span>
	<span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">zfcp_unit_release</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">scsi_work</span><span class="p">,</span> <span class="n">zfcp_unit_scsi_scan_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;0x%016llx&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fcp_lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zfcp_sysfs_unit_attrs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">unit_list_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">unit_list</span><span class="p">);</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">unit_list_lock</span><span class="p">);</span>

	<span class="n">zfcp_unit_scsi_scan</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_unit_sdev - Return SCSI device for zfcp_unit</span>
<span class="cm"> * @unit: The zfcp_unit where to get the SCSI device for</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: scsi_device pointer on success, NULL if there is no SCSI</span>
<span class="cm"> *          device for this zfcp_unit</span>
<span class="cm"> *</span>
<span class="cm"> * On success, the caller also holds a reference to the SCSI device</span>
<span class="cm"> * that must be released with scsi_device_put.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="nf">zfcp_unit_sdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">;</span>

	<span class="n">lun</span> <span class="o">=</span> <span class="n">scsilun_to_int</span><span class="p">((</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">fcp_lun</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">unit</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">shost</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">scsi_device_lookup</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">starget_id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_unit_sdev_status - Return zfcp LUN status for SCSI device</span>
<span class="cm"> * @unit: The unit to lookup the SCSI device for</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the zfcp LUN status field of the SCSI device if the SCSI device</span>
<span class="cm"> * for the zfcp_unit exists, 0 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">zfcp_unit_sdev_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span><span class="p">;</span>

	<span class="n">sdev</span> <span class="o">=</span> <span class="n">zfcp_unit_sdev</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_unit_remove - Remove entry from list of configured units</span>
<span class="cm"> * @port: The port where to remove the unit from the configuration</span>
<span class="cm"> * @fcp_lun: The 64 bit LUN of the unit to remove</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: -EINVAL if a unit with the specified LUN does not exist,</span>
<span class="cm"> *          0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_unit_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u64</span> <span class="n">fcp_lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="n">unit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">unit_list_lock</span><span class="p">);</span>
	<span class="n">unit</span> <span class="o">=</span> <span class="n">_zfcp_unit_find</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">fcp_lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">unit_list_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unit</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sdev</span> <span class="o">=</span> <span class="n">zfcp_unit_sdev</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_remove_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">zfcp_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zfcp_sysfs_unit_attrs</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
