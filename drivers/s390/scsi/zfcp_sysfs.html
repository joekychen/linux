<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › scsi › zfcp_sysfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>zfcp_sysfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * zfcp device driver</span>
<span class="cm"> *</span>
<span class="cm"> * sysfs attributes.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright IBM Corporation 2008, 2010</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;zfcp&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;zfcp_ext.h&quot;</span>

<span class="cp">#define ZFCP_DEV_ATTR(_feat, _name, _mode, _show, _store) \</span>
<span class="cp">struct device_attribute dev_attr_##_feat##_##_name = __ATTR(_name, _mode,\</span>
<span class="cp">							    _show, _store)</span>
<span class="cp">#define ZFCP_DEFINE_ATTR(_feat_def, _feat, _name, _format, _value)	       \</span>
<span class="cp">static ssize_t zfcp_sysfs_##_feat##_##_name##_show(struct device *dev,	       \</span>
<span class="cp">						   struct device_attribute *at,\</span>
<span class="cp">						   char *buf)		       \</span>
<span class="cp">{									       \</span>
<span class="cp">	struct _feat_def *_feat = container_of(dev, struct _feat_def, dev);    \</span>
<span class="cp">									       \</span>
<span class="cp">	return sprintf(buf, _format, _value);				       \</span>
<span class="cp">}									       \</span>
<span class="cp">static ZFCP_DEV_ATTR(_feat, _name, S_IRUGO,				       \</span>
<span class="cp">		     zfcp_sysfs_##_feat##_##_name##_show, NULL);</span>

<span class="cp">#define ZFCP_DEFINE_A_ATTR(_name, _format, _value)			     \</span>
<span class="cp">static ssize_t zfcp_sysfs_adapter_##_name##_show(struct device *dev,	     \</span>
<span class="cp">						 struct device_attribute *at,\</span>
<span class="cp">						 char *buf)		     \</span>
<span class="cp">{									     \</span>
<span class="cp">	struct ccw_device *cdev = to_ccwdev(dev);			     \</span>
<span class="cp">	struct zfcp_adapter *adapter = zfcp_ccw_adapter_by_cdev(cdev);	     \</span>
<span class="cp">	int i;								     \</span>
<span class="cp">									     \</span>
<span class="cp">	if (!adapter)							     \</span>
<span class="cp">		return -ENODEV;						     \</span>
<span class="cp">									     \</span>
<span class="cp">	i = sprintf(buf, _format, _value);				     \</span>
<span class="cp">	zfcp_ccw_adapter_put(adapter);					     \</span>
<span class="cp">	return i;							     \</span>
<span class="cp">}									     \</span>
<span class="cp">static ZFCP_DEV_ATTR(adapter, _name, S_IRUGO,				     \</span>
<span class="cp">		     zfcp_sysfs_adapter_##_name##_show, NULL);</span>

<span class="n">ZFCP_DEFINE_A_ATTR</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
<span class="n">ZFCP_DEFINE_A_ATTR</span><span class="p">(</span><span class="n">peer_wwnn</span><span class="p">,</span> <span class="s">&quot;0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_wwnn</span><span class="p">);</span>
<span class="n">ZFCP_DEFINE_A_ATTR</span><span class="p">(</span><span class="n">peer_wwpn</span><span class="p">,</span> <span class="s">&quot;0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_wwpn</span><span class="p">);</span>
<span class="n">ZFCP_DEFINE_A_ATTR</span><span class="p">(</span><span class="n">peer_d_id</span><span class="p">,</span> <span class="s">&quot;0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_d_id</span><span class="p">);</span>
<span class="n">ZFCP_DEFINE_A_ATTR</span><span class="p">(</span><span class="n">card_version</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hydra_version</span><span class="p">);</span>
<span class="n">ZFCP_DEFINE_A_ATTR</span><span class="p">(</span><span class="n">lic_version</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fsf_lic_version</span><span class="p">);</span>
<span class="n">ZFCP_DEFINE_A_ATTR</span><span class="p">(</span><span class="n">hardware_version</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hardware_version</span><span class="p">);</span>
<span class="n">ZFCP_DEFINE_A_ATTR</span><span class="p">(</span><span class="n">in_recovery</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span>
					 <span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">ZFCP_DEFINE_ATTR</span><span class="p">(</span><span class="n">zfcp_port</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
<span class="n">ZFCP_DEFINE_ATTR</span><span class="p">(</span><span class="n">zfcp_port</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">in_recovery</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span>
		  <span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">ZFCP_DEFINE_ATTR</span><span class="p">(</span><span class="n">zfcp_port</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">access_denied</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span>
		  <span class="n">ZFCP_STATUS_COMMON_ACCESS_DENIED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">ZFCP_DEFINE_ATTR</span><span class="p">(</span><span class="n">zfcp_unit</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">zfcp_unit_sdev_status</span><span class="p">(</span><span class="n">unit</span><span class="p">));</span>
<span class="n">ZFCP_DEFINE_ATTR</span><span class="p">(</span><span class="n">zfcp_unit</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">in_recovery</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">zfcp_unit_sdev_status</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="o">&amp;</span>
		  <span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">ZFCP_DEFINE_ATTR</span><span class="p">(</span><span class="n">zfcp_unit</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">access_denied</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">zfcp_unit_sdev_status</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="o">&amp;</span>
		  <span class="n">ZFCP_STATUS_COMMON_ACCESS_DENIED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">ZFCP_DEFINE_ATTR</span><span class="p">(</span><span class="n">zfcp_unit</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">access_shared</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">zfcp_unit_sdev_status</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="o">&amp;</span>
		  <span class="n">ZFCP_STATUS_LUN_SHARED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">ZFCP_DEFINE_ATTR</span><span class="p">(</span><span class="n">zfcp_unit</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">access_readonly</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">zfcp_unit_sdev_status</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="o">&amp;</span>
		  <span class="n">ZFCP_STATUS_LUN_READONLY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_port_failed_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zfcp_port</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_port_failed_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zfcp_port</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">||</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">zfcp_erp_set_port_status</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">);</span>
	<span class="n">zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span> <span class="s">&quot;sypfai2&quot;</span><span class="p">);</span>
	<span class="n">zfcp_erp_wait</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">ZFCP_DEV_ATTR</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		     <span class="n">zfcp_sysfs_port_failed_show</span><span class="p">,</span>
		     <span class="n">zfcp_sysfs_port_failed_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_unit_failed_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="n">unit</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zfcp_unit</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sdev</span> <span class="o">=</span> <span class="n">zfcp_unit_sdev</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">failed</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">failed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_unit_failed_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_unit</span> <span class="o">*</span><span class="n">unit</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zfcp_unit</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">||</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sdev</span> <span class="o">=</span> <span class="n">zfcp_unit_sdev</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_erp_set_lun_status</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">);</span>
		<span class="n">zfcp_erp_lun_reopen</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span>
				    <span class="s">&quot;syufai2&quot;</span><span class="p">);</span>
		<span class="n">zfcp_erp_wait</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">zfcp_unit_scsi_scan</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">ZFCP_DEV_ATTR</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		     <span class="n">zfcp_sysfs_unit_failed_show</span><span class="p">,</span>
		     <span class="n">zfcp_sysfs_unit_failed_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_adapter_failed_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">zfcp_ccw_adapter_by_cdev</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">zfcp_ccw_adapter_put</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_adapter_failed_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">zfcp_ccw_adapter_by_cdev</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">||</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zfcp_erp_set_adapter_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">);</span>
	<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span>
				<span class="s">&quot;syafai2&quot;</span><span class="p">);</span>
	<span class="n">zfcp_erp_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">zfcp_ccw_adapter_put</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span> <span class="o">?</span> <span class="n">retval</span> <span class="o">:</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">ZFCP_DEV_ATTR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		     <span class="n">zfcp_sysfs_adapter_failed_show</span><span class="p">,</span>
		     <span class="n">zfcp_sysfs_adapter_failed_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_port_rescan_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">zfcp_ccw_adapter_by_cdev</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* sync the user-space- with the kernel-invocation of scan_work */</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">);</span>
	<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">);</span>
	<span class="n">zfcp_ccw_adapter_put</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">ZFCP_DEV_ATTR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">port_rescan</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		     <span class="n">zfcp_sysfs_port_rescan_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_port_remove_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">to_ccwdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">zfcp_ccw_adapter_by_cdev</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">wwpn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">wwpn</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">zfcp_get_port_by_wwpn</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">wwpn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list_lock</span><span class="p">);</span>

	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">zfcp_erp_port_shutdown</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;syprs_1&quot;</span><span class="p">);</span>
	<span class="n">zfcp_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zfcp_sysfs_port_attrs</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">zfcp_ccw_adapter_put</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span> <span class="o">?</span> <span class="n">retval</span> <span class="o">:</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">ZFCP_DEV_ATTR</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">port_remove</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		     <span class="n">zfcp_sysfs_port_remove_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">zfcp_adapter_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_adapter_failed</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_adapter_in_recovery</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_adapter_port_remove</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_adapter_port_rescan</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_adapter_peer_wwnn</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_adapter_peer_wwpn</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_adapter_peer_d_id</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_adapter_card_version</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_adapter_lic_version</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_adapter_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_adapter_hardware_version</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">zfcp_sysfs_adapter_attrs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">zfcp_adapter_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_unit_add_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zfcp_port</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">fcp_lun</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fcp_lun</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_unit_add</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">fcp_lun</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">unit_add</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">zfcp_sysfs_unit_add_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_unit_remove_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zfcp_port</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">fcp_lun</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fcp_lun</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_unit_remove</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">fcp_lun</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">unit_remove</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">zfcp_sysfs_unit_remove_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">zfcp_port_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_unit_add</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_unit_remove</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_port_failed</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_port_in_recovery</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_port_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_port_access_denied</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_sysfs_port_attrs - sysfs attributes for all other ports</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">zfcp_sysfs_port_attrs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">zfcp_port_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">zfcp_unit_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_unit_failed</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_unit_in_recovery</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_unit_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_unit_access_denied</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_unit_access_shared</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_unit_access_readonly</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">zfcp_sysfs_unit_attrs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">zfcp_unit_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define ZFCP_DEFINE_LATENCY_ATTR(_name) 				\</span>
<span class="cp">static ssize_t								\</span>
<span class="cp">zfcp_sysfs_unit_##_name##_latency_show(struct device *dev,		\</span>
<span class="cp">				       struct device_attribute *attr,	\</span>
<span class="cp">				       char *buf) {			\</span>
<span class="cp">	struct scsi_device *sdev = to_scsi_device(dev);			\</span>
<span class="cp">	struct zfcp_scsi_dev *zfcp_sdev = sdev_to_zfcp(sdev);		\</span>
<span class="cp">	struct zfcp_latencies *lat = &amp;zfcp_sdev-&gt;latencies;		\</span>
<span class="cp">	struct zfcp_adapter *adapter = zfcp_sdev-&gt;port-&gt;adapter;	\</span>
<span class="cp">	unsigned long long fsum, fmin, fmax, csum, cmin, cmax, cc;	\</span>
<span class="cp">									\</span>
<span class="cp">	spin_lock_bh(&amp;lat-&gt;lock);					\</span>
<span class="cp">	fsum = lat-&gt;_name.fabric.sum * adapter-&gt;timer_ticks;		\</span>
<span class="cp">	fmin = lat-&gt;_name.fabric.min * adapter-&gt;timer_ticks;		\</span>
<span class="cp">	fmax = lat-&gt;_name.fabric.max * adapter-&gt;timer_ticks;		\</span>
<span class="cp">	csum = lat-&gt;_name.channel.sum * adapter-&gt;timer_ticks;		\</span>
<span class="cp">	cmin = lat-&gt;_name.channel.min * adapter-&gt;timer_ticks;		\</span>
<span class="cp">	cmax = lat-&gt;_name.channel.max * adapter-&gt;timer_ticks;		\</span>
<span class="cp">	cc  = lat-&gt;_name.counter;					\</span>
<span class="cp">	spin_unlock_bh(&amp;lat-&gt;lock);					\</span>
<span class="cp">									\</span>
<span class="cp">	do_div(fsum, 1000);						\</span>
<span class="cp">	do_div(fmin, 1000);						\</span>
<span class="cp">	do_div(fmax, 1000);						\</span>
<span class="cp">	do_div(csum, 1000);						\</span>
<span class="cp">	do_div(cmin, 1000);						\</span>
<span class="cp">	do_div(cmax, 1000);						\</span>
<span class="cp">									\</span>
<span class="cp">	return sprintf(buf, &quot;%llu %llu %llu %llu %llu %llu %llu\n&quot;,	\</span>
<span class="cp">		       fmin, fmax, fsum, cmin, cmax, csum, cc); 	\</span>
<span class="cp">}									\</span>
<span class="cp">static ssize_t								\</span>
<span class="cp">zfcp_sysfs_unit_##_name##_latency_store(struct device *dev,		\</span>
<span class="cp">					struct device_attribute *attr,	\</span>
<span class="cp">					const char *buf, size_t count)	\</span>
<span class="cp">{									\</span>
<span class="cp">	struct scsi_device *sdev = to_scsi_device(dev);			\</span>
<span class="cp">	struct zfcp_scsi_dev *zfcp_sdev = sdev_to_zfcp(sdev);		\</span>
<span class="cp">	struct zfcp_latencies *lat = &amp;zfcp_sdev-&gt;latencies;		\</span>
<span class="cp">	unsigned long flags;						\</span>
<span class="cp">									\</span>
<span class="cp">	spin_lock_irqsave(&amp;lat-&gt;lock, flags);				\</span>
<span class="cp">	lat-&gt;_name.fabric.sum = 0;					\</span>
<span class="cp">	lat-&gt;_name.fabric.min = 0xFFFFFFFF;				\</span>
<span class="cp">	lat-&gt;_name.fabric.max = 0;					\</span>
<span class="cp">	lat-&gt;_name.channel.sum = 0;					\</span>
<span class="cp">	lat-&gt;_name.channel.min = 0xFFFFFFFF;				\</span>
<span class="cp">	lat-&gt;_name.channel.max = 0;					\</span>
<span class="cp">	lat-&gt;_name.counter = 0;						\</span>
<span class="cp">	spin_unlock_irqrestore(&amp;lat-&gt;lock, flags);			\</span>
<span class="cp">									\</span>
<span class="cp">	return (ssize_t) count;						\</span>
<span class="cp">}									\</span>
<span class="cp">static DEVICE_ATTR(_name##_latency, S_IWUSR | S_IRUGO,			\</span>
<span class="cp">		   zfcp_sysfs_unit_##_name##_latency_show,		\</span>
<span class="cp">		   zfcp_sysfs_unit_##_name##_latency_store);</span>

<span class="n">ZFCP_DEFINE_LATENCY_ATTR</span><span class="p">(</span><span class="n">read</span><span class="p">);</span>
<span class="n">ZFCP_DEFINE_LATENCY_ATTR</span><span class="p">(</span><span class="n">write</span><span class="p">);</span>
<span class="n">ZFCP_DEFINE_LATENCY_ATTR</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="cp">#define ZFCP_DEFINE_SCSI_ATTR(_name, _format, _value)			\</span>
<span class="cp">static ssize_t zfcp_sysfs_scsi_##_name##_show(struct device *dev,	\</span>
<span class="cp">					      struct device_attribute *attr,\</span>
<span class="cp">					      char *buf)                 \</span>
<span class="cp">{                                                                        \</span>
<span class="cp">	struct scsi_device *sdev = to_scsi_device(dev);			 \</span>
<span class="cp">	struct zfcp_scsi_dev *zfcp_sdev = sdev_to_zfcp(sdev);		 \</span>
<span class="cp">	struct zfcp_port *port = zfcp_sdev-&gt;port;			 \</span>
<span class="cp">									 \</span>
<span class="cp">	return sprintf(buf, _format, _value);                            \</span>
<span class="cp">}                                                                        \</span>
<span class="cp">static DEVICE_ATTR(_name, S_IRUGO, zfcp_sysfs_scsi_##_name##_show, NULL);</span>

<span class="n">ZFCP_DEFINE_SCSI_ATTR</span><span class="p">(</span><span class="n">hba_id</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
<span class="n">ZFCP_DEFINE_SCSI_ATTR</span><span class="p">(</span><span class="n">wwpn</span><span class="p">,</span> <span class="s">&quot;0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_scsi_fcp_lun_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zfcp_scsi_dev_lun</span><span class="p">(</span><span class="n">sdev</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">fcp_lun</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">zfcp_sysfs_scsi_fcp_lun_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">zfcp_sysfs_sdev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_fcp_lun</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wwpn</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hba_id</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_read_latency</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_write_latency</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_cmd_latency</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_adapter_util_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">scsi_host</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_bottom_port</span> <span class="o">*</span><span class="n">qtcb_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_features</span> <span class="o">&amp;</span> <span class="n">FSF_FEATURE_MEASUREMENT_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">qtcb_port</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsf_qtcb_bottom_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qtcb_port</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_exchange_port_data_sync</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">,</span> <span class="n">qtcb_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u %u %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qtcb_port</span><span class="o">-&gt;</span><span class="n">cp_util</span><span class="p">,</span>
				 <span class="n">qtcb_port</span><span class="o">-&gt;</span><span class="n">cb_util</span><span class="p">,</span> <span class="n">qtcb_port</span><span class="o">-&gt;</span><span class="n">a_util</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">qtcb_port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">utilization</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">zfcp_sysfs_adapter_util_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_sysfs_adapter_ex_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fsf_statistics_info</span> <span class="o">*</span><span class="n">stat_inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">scsi_host</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fsf_qtcb_bottom_config</span> <span class="o">*</span><span class="n">qtcb_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_features</span> <span class="o">&amp;</span> <span class="n">FSF_FEATURE_MEASUREMENT_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">qtcb_config</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsf_qtcb_bottom_config</span><span class="p">),</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qtcb_config</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_exchange_config_data_sync</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">,</span> <span class="n">qtcb_config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="o">*</span><span class="n">stat_inf</span> <span class="o">=</span> <span class="n">qtcb_config</span><span class="o">-&gt;</span><span class="n">stat_info</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">qtcb_config</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ZFCP_SHOST_ATTR(_name, _format, _arg...)			\</span>
<span class="cp">static ssize_t zfcp_sysfs_adapter_##_name##_show(struct device *dev,	\</span>
<span class="cp">						 struct device_attribute *attr,\</span>
<span class="cp">						 char *buf)		\</span>
<span class="cp">{									\</span>
<span class="cp">	struct fsf_statistics_info stat_info;				\</span>
<span class="cp">	int retval;							\</span>
<span class="cp">									\</span>
<span class="cp">	retval = zfcp_sysfs_adapter_ex_config(dev, &amp;stat_info);		\</span>
<span class="cp">	if (retval)							\</span>
<span class="cp">		return retval;						\</span>
<span class="cp">									\</span>
<span class="cp">	return sprintf(buf, _format, ## _arg);				\</span>
<span class="cp">}									\</span>
<span class="cp">static DEVICE_ATTR(_name, S_IRUGO, zfcp_sysfs_adapter_##_name##_show, NULL);</span>

<span class="n">ZFCP_SHOST_ATTR</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="s">&quot;%llu %llu %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">stat_info</span><span class="p">.</span><span class="n">input_req</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">stat_info</span><span class="p">.</span><span class="n">output_req</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">stat_info</span><span class="p">.</span><span class="n">control_req</span><span class="p">);</span>

<span class="n">ZFCP_SHOST_ATTR</span><span class="p">(</span><span class="n">megabytes</span><span class="p">,</span> <span class="s">&quot;%llu %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">stat_info</span><span class="p">.</span><span class="n">input_mb</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">stat_info</span><span class="p">.</span><span class="n">output_mb</span><span class="p">);</span>

<span class="n">ZFCP_SHOST_ATTR</span><span class="p">(</span><span class="n">seconds_active</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">stat_info</span><span class="p">.</span><span class="n">seconds_act</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">zfcp_sysfs_adapter_q_full_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">scsi_host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_qdio</span> <span class="o">*</span><span class="n">qdio</span> <span class="o">=</span>
		<span class="p">((</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">util</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">stat_lock</span><span class="p">);</span>
	<span class="n">util</span> <span class="o">=</span> <span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_util</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">stat_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdio</span><span class="o">-&gt;</span><span class="n">req_q_full</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">util</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">queue_full</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">zfcp_sysfs_adapter_q_full_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">zfcp_sysfs_shost_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_utilization</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_requests</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_megabytes</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_seconds_active</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_queue_full</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
