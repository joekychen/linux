<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › scsi › zfcp_erp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>zfcp_erp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * zfcp device driver</span>
<span class="cm"> *</span>
<span class="cm"> * Error Recovery Procedures (ERP).</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright IBM Corporation 2002, 2010</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;zfcp&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &quot;zfcp_ext.h&quot;</span>
<span class="cp">#include &quot;zfcp_reqlist.h&quot;</span>

<span class="cp">#define ZFCP_MAX_ERPS                   3</span>

<span class="k">enum</span> <span class="n">zfcp_erp_act_flags</span> <span class="p">{</span>
	<span class="n">ZFCP_STATUS_ERP_TIMEDOUT</span>	<span class="o">=</span> <span class="mh">0x10000000</span><span class="p">,</span>
	<span class="n">ZFCP_STATUS_ERP_CLOSE_ONLY</span>	<span class="o">=</span> <span class="mh">0x01000000</span><span class="p">,</span>
	<span class="n">ZFCP_STATUS_ERP_DISMISSING</span>	<span class="o">=</span> <span class="mh">0x00100000</span><span class="p">,</span>
	<span class="n">ZFCP_STATUS_ERP_DISMISSED</span>	<span class="o">=</span> <span class="mh">0x00200000</span><span class="p">,</span>
	<span class="n">ZFCP_STATUS_ERP_LOWMEM</span>		<span class="o">=</span> <span class="mh">0x00400000</span><span class="p">,</span>
	<span class="n">ZFCP_STATUS_ERP_NO_REF</span>		<span class="o">=</span> <span class="mh">0x00800000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">zfcp_erp_steps</span> <span class="p">{</span>
	<span class="n">ZFCP_ERP_STEP_UNINITIALIZED</span>	<span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_STEP_FSF_XCONFIG</span>	<span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_STEP_PHYS_PORT_CLOSING</span>	<span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_STEP_PORT_CLOSING</span>	<span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_STEP_PORT_OPENING</span>	<span class="o">=</span> <span class="mh">0x0800</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_STEP_LUN_CLOSING</span>	<span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_STEP_LUN_OPENING</span>	<span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">zfcp_erp_act_type</span> <span class="p">{</span>
	<span class="n">ZFCP_ERP_ACTION_REOPEN_LUN</span>         <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span>	   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_ACTION_REOPEN_PORT_FORCED</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span>     <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">zfcp_erp_act_state</span> <span class="p">{</span>
	<span class="n">ZFCP_ERP_ACTION_RUNNING</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_ACTION_READY</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">zfcp_erp_act_result</span> <span class="p">{</span>
	<span class="n">ZFCP_ERP_SUCCEEDED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_FAILED</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_CONTINUES</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_EXIT</span>      <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_DISMISSED</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">ZFCP_ERP_NOMEM</span>     <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_adapter_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">zfcp_erp_clear_adapter_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				       <span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span> <span class="o">|</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_action_exists</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">curr_act</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">curr_act</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_running_head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">==</span> <span class="n">curr_act</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_ACTION_RUNNING</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_action_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_head</span><span class="p">);</span>
	<span class="n">zfcp_dbf_rec_run</span><span class="p">(</span><span class="s">&quot;erardy1&quot;</span><span class="p">,</span> <span class="n">act</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_wq</span><span class="p">);</span>
	<span class="n">zfcp_dbf_rec_run</span><span class="p">(</span><span class="s">&quot;erardy2&quot;</span><span class="p">,</span> <span class="n">act</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_action_dismiss</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">act</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_ERP_DISMISSED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_erp_action_exists</span><span class="p">(</span><span class="n">act</span><span class="p">)</span> <span class="o">==</span> <span class="n">ZFCP_ERP_ACTION_RUNNING</span><span class="p">)</span>
		<span class="n">zfcp_erp_action_ready</span><span class="p">(</span><span class="n">act</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_action_dismiss_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">)</span>
		<span class="n">zfcp_erp_action_dismiss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_action_dismiss_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">)</span>
		<span class="n">zfcp_erp_action_dismiss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span>
				<span class="n">zfcp_erp_action_dismiss_lun</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_action_dismiss_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">)</span>
		<span class="n">zfcp_erp_action_dismiss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		    <span class="n">zfcp_erp_action_dismiss_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_required_act</span><span class="p">(</span><span class="kt">int</span> <span class="n">want</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">need</span> <span class="o">=</span> <span class="n">want</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l_status</span><span class="p">,</span> <span class="n">p_status</span><span class="p">,</span> <span class="n">a_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">want</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_LUN</span>:
		<span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="n">l_status</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p_status</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">)</span> <span class="o">||</span>
		      <span class="n">p_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span><span class="p">))</span>
			<span class="n">need</span> <span class="o">=</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT_FORCED</span>:
		<span class="n">p_status</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">))</span>
			<span class="n">need</span> <span class="o">=</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span>:
		<span class="n">p_status</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">a_status</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">)</span> <span class="o">||</span>
		      <span class="n">a_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_NOESC</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">need</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span><span class="p">))</span>
			<span class="n">need</span> <span class="o">=</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span>:
		<span class="n">a_status</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">a_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* shutdown requested for closed adapter */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">need</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="nf">zfcp_erp_setup_act</span><span class="p">(</span><span class="kt">int</span> <span class="n">need</span><span class="p">,</span> <span class="n">u32</span> <span class="n">act_status</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">need</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_LUN</span>:
		<span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">act_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_NO_REF</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_device_get</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">erp_action</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">erp_action</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span><span class="p">));</span>
		<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">sdev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">))</span>
			<span class="n">act_status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_ERP_CLOSE_ONLY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span>:
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT_FORCED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">zfcp_erp_action_dismiss_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">erp_action</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">erp_action</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span><span class="p">));</span>
		<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">))</span>
			<span class="n">act_status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_ERP_CLOSE_ONLY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span>:
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
		<span class="n">zfcp_erp_action_dismiss_adapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">erp_action</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">erp_action</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">))</span>
			<span class="n">act_status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_ERP_CLOSE_ONLY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">need</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">act_status</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">erp_action</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_action_enqueue</span><span class="p">(</span><span class="kt">int</span> <span class="n">want</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">act_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">need</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_thread</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">need</span> <span class="o">=</span> <span class="n">zfcp_erp_required_act</span><span class="p">(</span><span class="n">want</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">need</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">act</span> <span class="o">=</span> <span class="n">zfcp_erp_setup_act</span><span class="p">(</span><span class="n">need</span><span class="p">,</span> <span class="n">act_status</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">act</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_ADAPTER_ERP_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="o">++</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_total_count</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_head</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_wq</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">zfcp_dbf_rec_trig</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">need</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">clear_mask</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">zfcp_erp_adapter_block</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">clear_mask</span><span class="p">);</span>
	<span class="n">zfcp_scsi_schedule_rports_block</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* ensure propagation of failed status to new devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_erp_set_adapter_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					    <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">zfcp_erp_action_enqueue</span><span class="p">(</span><span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span><span class="p">,</span>
				       <span class="n">adapter</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_adapter_reopen - Reopen adapter.</span>
<span class="cm"> * @adapter: Adapter to reopen.</span>
<span class="cm"> * @clear: Status flags to clear.</span>
<span class="cm"> * @id: Id for debug trace event.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">zfcp_erp_adapter_block</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>
	<span class="n">zfcp_scsi_schedule_rports_block</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span>
		<span class="n">zfcp_erp_set_adapter_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					    <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">zfcp_erp_action_enqueue</span><span class="p">(</span><span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_adapter_shutdown - Shutdown adapter.</span>
<span class="cm"> * @adapter: Adapter to shut down.</span>
<span class="cm"> * @clear: Status flags to clear.</span>
<span class="cm"> * @id: Id for debug trace event.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_adapter_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span> <span class="o">|</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">;</span>
	<span class="n">zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">clear</span> <span class="o">|</span> <span class="n">flags</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_port_shutdown - Shutdown port</span>
<span class="cm"> * @port: Port to shut down.</span>
<span class="cm"> * @clear: Status flags to clear.</span>
<span class="cm"> * @id: Id for debug trace event.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_port_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span> <span class="o">|</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">;</span>
	<span class="n">zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">clear</span> <span class="o">|</span> <span class="n">flags</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_port_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">zfcp_erp_clear_port_status</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
				    <span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span> <span class="o">|</span> <span class="n">clear</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_zfcp_erp_port_forced_reopen</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">zfcp_erp_port_block</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>
	<span class="n">zfcp_scsi_schedule_rport_block</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">zfcp_erp_action_enqueue</span><span class="p">(</span><span class="n">ZFCP_ERP_ACTION_REOPEN_PORT_FORCED</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_port_forced_reopen - Forced close of port and open again</span>
<span class="cm"> * @port: Port to force close and to reopen.</span>
<span class="cm"> * @clear: Status flags to clear.</span>
<span class="cm"> * @id: Id for debug trace event.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_port_forced_reopen</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">_zfcp_erp_port_forced_reopen</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">clear</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_zfcp_erp_port_reopen</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">zfcp_erp_port_block</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>
	<span class="n">zfcp_scsi_schedule_rport_block</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ensure propagation of failed status to new devices */</span>
		<span class="n">zfcp_erp_set_port_status</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">zfcp_erp_action_enqueue</span><span class="p">(</span><span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span><span class="p">,</span>
				       <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_port_reopen - trigger remote port recovery</span>
<span class="cm"> * @port: port to recover</span>
<span class="cm"> * @clear_mask: flags in port status to be cleared</span>
<span class="cm"> * @id: Id for debug trace event.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if recovery has been triggered, &lt; 0 if not.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_erp_port_reopen</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">_zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">clear</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_lun_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">zfcp_erp_clear_lun_status</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
				  <span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span> <span class="o">|</span> <span class="n">clear_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_zfcp_erp_lun_reopen</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">act_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">zfcp_erp_lun_block</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">zfcp_erp_action_enqueue</span><span class="p">(</span><span class="n">ZFCP_ERP_ACTION_REOPEN_LUN</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span>
				<span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">act_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_lun_reopen - initiate reopen of a LUN</span>
<span class="cm"> * @sdev: SCSI device / LUN to be reopened</span>
<span class="cm"> * @clear_mask: specifies flags in LUN status to be cleared</span>
<span class="cm"> * @id: Id for debug trace event.</span>
<span class="cm"> *</span>
<span class="cm"> * Return: 0 on success, &lt; 0 on error</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_lun_reopen</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">_zfcp_erp_lun_reopen</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">clear</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_lun_shutdown - Shutdown LUN</span>
<span class="cm"> * @sdev: SCSI device / LUN to shut down.</span>
<span class="cm"> * @clear: Status flags to clear.</span>
<span class="cm"> * @id: Id for debug trace event.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_lun_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span> <span class="o">|</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">;</span>
	<span class="n">zfcp_erp_lun_reopen</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">clear</span> <span class="o">|</span> <span class="n">flags</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_lun_shutdown_wait - Shutdown LUN and wait for erp completion</span>
<span class="cm"> * @sdev: SCSI device / LUN to shut down.</span>
<span class="cm"> * @id: Id for debug trace event.</span>
<span class="cm"> *</span>
<span class="cm"> * Do not acquire a reference for the LUN when creating the ERP</span>
<span class="cm"> * action. It is safe, because this function waits for the ERP to</span>
<span class="cm"> * complete first. This allows to shutdown the LUN, even when the SCSI</span>
<span class="cm"> * device is in the state SDEV_DEL when scsi_device_get will fail.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_lun_shutdown_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clear</span> <span class="o">=</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span> <span class="o">|</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">_zfcp_erp_lun_reopen</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">clear</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">ZFCP_STATUS_ERP_NO_REF</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">zfcp_erp_wait</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">status_change_set</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">,</span> <span class="n">atomic_t</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">^</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_adapter_unblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_change_set</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="n">zfcp_dbf_rec_run</span><span class="p">(</span><span class="s">&quot;eraubl1&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_port_unblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_change_set</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="n">zfcp_dbf_rec_run</span><span class="p">(</span><span class="s">&quot;erpubl1&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_lun_unblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_change_set</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="n">zfcp_dbf_rec_run</span><span class="p">(</span><span class="s">&quot;erlubl1&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_UNBLOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_action_to_running</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_running_head</span><span class="p">);</span>
	<span class="n">zfcp_dbf_rec_run</span><span class="p">(</span><span class="s">&quot;erator1&quot;</span><span class="p">,</span> <span class="n">erp_action</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_strategy_check_fsfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_fsf_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">req_list</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">_zfcp_reqlist_find</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">req_list</span><span class="p">,</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">erp_action</span> <span class="o">==</span> <span class="n">act</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ZFCP_STATUS_ERP_DISMISSED</span> <span class="o">|</span>
				   <span class="n">ZFCP_STATUS_ERP_TIMEDOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_FSFREQ_DISMISSED</span><span class="p">;</span>
			<span class="n">zfcp_dbf_rec_run</span><span class="p">(</span><span class="s">&quot;erscf_1&quot;</span><span class="p">,</span> <span class="n">act</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">erp_action</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_TIMEDOUT</span><span class="p">)</span>
			<span class="n">zfcp_dbf_rec_run</span><span class="p">(</span><span class="s">&quot;erscf_2&quot;</span><span class="p">,</span> <span class="n">act</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_FSFREQ_DISMISSED</span><span class="p">)</span>
			<span class="n">act</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">act</span><span class="o">-&gt;</span><span class="n">fsf_req_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">req_list</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_notify - Trigger ERP action.</span>
<span class="cm"> * @erp_action: ERP action to continue.</span>
<span class="cm"> * @set_mask: ERP action status flags to set.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">set_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_erp_action_exists</span><span class="p">(</span><span class="n">erp_action</span><span class="p">)</span> <span class="o">==</span> <span class="n">ZFCP_ERP_ACTION_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">set_mask</span><span class="p">;</span>
		<span class="n">zfcp_erp_action_ready</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_timeout_handler - Trigger ERP action from timed out ERP request</span>
<span class="cm"> * @data: ERP action (from timer data)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_timeout_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">zfcp_erp_notify</span><span class="p">(</span><span class="n">act</span><span class="p">,</span> <span class="n">ZFCP_STATUS_ERP_TIMEDOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_memwait_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">zfcp_erp_notify</span><span class="p">((</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_strategy_memwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">zfcp_erp_memwait_handler</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">erp_action</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_zfcp_erp_port_reopen_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">_zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">clear</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_zfcp_erp_lun_reopen_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span>
			<span class="n">_zfcp_erp_lun_reopen</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">clear</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_strategy_followup_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span>:
		<span class="n">_zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ersff_1&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT_FORCED</span>:
		<span class="n">_zfcp_erp_port_forced_reopen</span><span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ersff_2&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span>:
		<span class="n">_zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ersff_3&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_LUN</span>:
		<span class="n">_zfcp_erp_lun_reopen</span><span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ersff_4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_strategy_followup_success</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span>:
		<span class="n">_zfcp_erp_port_reopen_all</span><span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ersfs_1&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT_FORCED</span>:
		<span class="n">_zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ersfs_2&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span>:
		<span class="n">_zfcp_erp_lun_reopen_all</span><span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ersfs_3&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">read_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_head</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_running_head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_ADAPTER_ERP_PENDING</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_done_wqh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_enqueue_ptp_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">zfcp_port_enqueue</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_wwpn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_d_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="cm">/* error or port already attached */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">_zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ereptp1&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_adapter_strat_fsf_xconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_ADAPTER_XCONFIG_OK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">retries</span><span class="p">;</span> <span class="n">retries</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_ADAPTER_HOST_CON_INIT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">);</span>
		<span class="n">zfcp_erp_action_to_running</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
		<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_fsf_exchange_config_data</span><span class="p">(</span><span class="n">erp_action</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_ADAPTER_HOST_CON_INIT</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wait_event</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_wq</span><span class="p">,</span>
			   <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_head</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_TIMEDOUT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="n">ZFCP_STATUS_ADAPTER_HOST_CON_INIT</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ssleep</span><span class="p">(</span><span class="n">sleep</span><span class="p">);</span>
		<span class="n">sleep</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_ADAPTER_HOST_CON_INIT</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ADAPTER_XCONFIG_OK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_PORTTYPE_PTP</span><span class="p">)</span>
		<span class="n">zfcp_erp_enqueue_ptp_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ZFCP_ERP_SUCCEEDED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_adapter_strategy_open_fsf_xport</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">);</span>
	<span class="n">zfcp_erp_action_to_running</span><span class="p">(</span><span class="n">act</span><span class="p">);</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">zfcp_fsf_exchange_port_data</span><span class="p">(</span><span class="n">act</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_SUCCEEDED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>

	<span class="n">zfcp_dbf_rec_run</span><span class="p">(</span><span class="s">&quot;erasox1&quot;</span><span class="p">,</span> <span class="n">act</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_wq</span><span class="p">,</span>
		   <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_head</span><span class="p">));</span>
	<span class="n">zfcp_dbf_rec_run</span><span class="p">(</span><span class="s">&quot;erasox2&quot;</span><span class="p">,</span> <span class="n">act</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_TIMEDOUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ZFCP_ERP_SUCCEEDED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_adapter_strategy_open_fsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_erp_adapter_strat_fsf_xconf</span><span class="p">(</span><span class="n">act</span><span class="p">)</span> <span class="o">==</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_erp_adapter_strategy_open_fsf_xport</span><span class="p">(</span><span class="n">act</span><span class="p">)</span> <span class="o">==</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mempool_resize</span><span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">sr_data</span><span class="p">,</span>
			   <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stat_read_buf_num</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mempool_resize</span><span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">.</span><span class="n">status_read_req</span><span class="p">,</span>
			   <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stat_read_buf_num</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stat_miss</span><span class="p">,</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stat_read_buf_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_status_read_refill</span><span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ZFCP_ERP_SUCCEEDED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_adapter_strategy_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="cm">/* close queues to ensure that buffers are not accessed by adapter */</span>
	<span class="n">zfcp_qdio_close</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">);</span>
	<span class="n">zfcp_fsf_req_dismiss_all</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fsf_req_seq_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zfcp_fc_wka_ports_force_offline</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">gs</span><span class="p">);</span>
	<span class="cm">/* all ports and LUNs are closed */</span>
	<span class="n">zfcp_erp_clear_adapter_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">);</span>

	<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_ADAPTER_XCONFIG_OK</span> <span class="o">|</span>
			  <span class="n">ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_adapter_strategy_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_qdio_open</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">qdio</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_ADAPTER_XCONFIG_OK</span> <span class="o">|</span>
				  <span class="n">ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_erp_adapter_strategy_open_fsf</span><span class="p">(</span><span class="n">act</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">zfcp_erp_adapter_strategy_close</span><span class="p">(</span><span class="n">act</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ZFCP_ERP_SUCCEEDED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_adapter_strategy</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_erp_adapter_strategy_close</span><span class="p">(</span><span class="n">act</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_CLOSE_ONLY</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_erp_adapter_strategy_open</span><span class="p">(</span><span class="n">act</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ZFCP_ERP_SUCCEEDED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_port_forced_strategy_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_close_physical_port</span><span class="p">(</span><span class="n">act</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_NOMEM</span><span class="p">;</span>
	<span class="n">act</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="n">ZFCP_ERP_STEP_PHYS_PORT_CLOSING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ZFCP_ERP_CONTINUES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_port_strategy_clearstati</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_ACCESS_DENIED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_port_forced_strategy</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_STEP_UNINITIALIZED</span>:
		<span class="n">zfcp_erp_port_strategy_clearstati</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_PORT_PHYS_OPEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">zfcp_erp_port_forced_strategy_close</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_STEP_PHYS_PORT_CLOSING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_PORT_PHYS_OPEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_SUCCEEDED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_port_strategy_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_close_port</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_NOMEM</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="n">ZFCP_ERP_STEP_PORT_CLOSING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ZFCP_ERP_CONTINUES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_port_strategy_open_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_open_port</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_NOMEM</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="n">ZFCP_ERP_STEP_PORT_OPENING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ZFCP_ERP_CONTINUES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_open_ptp_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">wwpn</span> <span class="o">!=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_wwpn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_erp_set_port_status</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">d_id</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">peer_d_id</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">zfcp_erp_port_strategy_open_port</span><span class="p">(</span><span class="n">act</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_port_strategy_open_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p_status</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_STEP_UNINITIALIZED</span>:
	<span class="k">case</span> <span class="n">ZFCP_ERP_STEP_PHYS_PORT_CLOSING</span>:
	<span class="k">case</span> <span class="n">ZFCP_ERP_STEP_PORT_CLOSING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_PORTTYPE_PTP</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">zfcp_erp_open_ptp_port</span><span class="p">(</span><span class="n">act</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zfcp_fc_trigger_did_lookup</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">zfcp_erp_port_strategy_open_port</span><span class="p">(</span><span class="n">act</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_STEP_PORT_OPENING</span>:
		<span class="cm">/* D_ID might have changed during open */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">zfcp_fc_trigger_did_lookup</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_SUCCEEDED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">d_id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">p_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_NOESC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">d_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fall through otherwise */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_port_strategy</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p_status</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_NOESC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">p_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">close_init_done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_STEP_UNINITIALIZED</span>:
		<span class="n">zfcp_erp_port_strategy_clearstati</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">zfcp_erp_port_strategy_close</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_STEP_PORT_CLOSING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">close_init_done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_CLOSE_ONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">zfcp_erp_port_strategy_open_common</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_lun_strategy_clearstati</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_ACCESS_DENIED</span> <span class="o">|</span>
			  <span class="n">ZFCP_STATUS_LUN_SHARED</span> <span class="o">|</span> <span class="n">ZFCP_STATUS_LUN_READONLY</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_lun_strategy_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_close_lun</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_NOMEM</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="n">ZFCP_ERP_STEP_LUN_CLOSING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ZFCP_ERP_CONTINUES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_lun_strategy_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_fsf_open_lun</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ZFCP_ERP_NOMEM</span><span class="p">;</span>
	<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="n">ZFCP_ERP_STEP_LUN_OPENING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span>  <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ZFCP_ERP_CONTINUES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_lun_strategy</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_STEP_UNINITIALIZED</span>:
		<span class="n">zfcp_erp_lun_strategy_clearstati</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">zfcp_erp_lun_strategy_close</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
		<span class="cm">/* already closed, fall through */</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_STEP_LUN_CLOSING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_CLOSE_ONLY</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">zfcp_erp_lun_strategy_open</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_STEP_LUN_OPENING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_OPEN</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_SUCCEEDED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_strategy_check_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_SUCCEEDED</span> :
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">zfcp_erp_lun_unblock</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_FAILED</span> :
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ZFCP_MAX_ERPS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;ERP failed for LUN 0x%016Lx on &quot;</span>
				<span class="s">&quot;port 0x%016Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">zfcp_scsi_dev_lun</span><span class="p">(</span><span class="n">sdev</span><span class="p">),</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">);</span>
			<span class="n">zfcp_erp_set_lun_status</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
						<span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_erp_lun_block</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_strategy_check_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_SUCCEEDED</span> :
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">zfcp_erp_port_unblock</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_FAILED</span> :
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_NOESC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zfcp_erp_port_block</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ZFCP_MAX_ERPS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;ERP failed for remote port 0x%016Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">);</span>
			<span class="n">zfcp_erp_set_port_status</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
					 <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_erp_port_block</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_strategy_check_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_SUCCEEDED</span> :
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">zfcp_erp_adapter_unblock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_FAILED</span> :
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ZFCP_MAX_ERPS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;ERP cannot recover an error &quot;</span>
				<span class="s">&quot;on the FCP device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">zfcp_erp_set_adapter_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					    <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_erp_adapter_block</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_strategy_check_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_LUN</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">zfcp_erp_strategy_check_lun</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT_FORCED</span>:
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">zfcp_erp_strategy_check_port</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">zfcp_erp_strategy_check_adapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_strat_change_det</span><span class="p">(</span><span class="n">atomic_t</span> <span class="o">*</span><span class="n">target_status</span><span class="p">,</span> <span class="n">u32</span> <span class="n">erp_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="n">target_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">erp_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_CLOSE_ONLY</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* take it online */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_RUNNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">erp_status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_CLOSE_ONLY</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* take it offline */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_strategy_statechange</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">action</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">erp_status</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_erp_strat_change_det</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">erp_status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">_zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
						 <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span>
						 <span class="s">&quot;ersscg1&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT_FORCED</span>:
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_erp_strat_change_det</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">erp_status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">_zfcp_erp_port_reopen</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
					      <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span>
					      <span class="s">&quot;ersscg2&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_LUN</span>:
		<span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_erp_strat_change_det</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">erp_status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">_zfcp_erp_lun_reopen</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
					     <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">,</span>
					     <span class="s">&quot;ersscg3&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_action_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_total_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_LOWMEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_low_mem_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ZFCP_STATUS_ERP_LOWMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">zfcp_dbf_rec_run</span><span class="p">(</span><span class="s">&quot;eractd1&quot;</span><span class="p">,</span> <span class="n">erp_action</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_LUN</span>:
		<span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">);</span>
		<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT_FORCED</span>:
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span>:
		<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span>:
		<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">ZFCP_STATUS_COMMON_ERP_INUSE</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zfcp_erp_action_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">act</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_LUN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_NO_REF</span><span class="p">))</span>
			<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">ZFCP_ERP_SUCCEEDED</span><span class="p">)</span>
			<span class="n">zfcp_scsi_schedule_rport_register</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT_FORCED</span>:
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">ZFCP_ERP_SUCCEEDED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">register_service_level</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">service_level</span><span class="p">);</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">);</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">work_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ns_up_work</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">unregister_service_level</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">service_level</span><span class="p">);</span>

		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="n">zfcp_adapter_release</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_strategy_do_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_ADAPTER</span>:
		<span class="k">return</span> <span class="n">zfcp_erp_adapter_strategy</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT_FORCED</span>:
		<span class="k">return</span> <span class="n">zfcp_erp_port_forced_strategy</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_PORT</span>:
		<span class="k">return</span> <span class="n">zfcp_erp_port_strategy</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_ACTION_REOPEN_LUN</span>:
		<span class="k">return</span> <span class="n">zfcp_erp_lun_strategy</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_strategy</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">erp_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">zfcp_erp_strategy_check_fsfreq</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_DISMISSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zfcp_erp_action_dequeue</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ZFCP_ERP_DISMISSED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_TIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">check_target</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zfcp_erp_action_to_running</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>

	<span class="cm">/* no lock to allow for blocking operations */</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_erp_strategy_do_action</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_DISMISSED</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ZFCP_ERP_CONTINUES</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZFCP_ERP_NOMEM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_LOWMEM</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_low_mem_count</span><span class="p">;</span>
			<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ZFCP_STATUS_ERP_LOWMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_total_count</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_low_mem_count</span><span class="p">)</span>
			<span class="n">_zfcp_erp_adapter_reopen</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;erstgy1&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">zfcp_erp_strategy_memwait</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ZFCP_ERP_CONTINUES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ZFCP_ERP_CONTINUES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_ERP_LOWMEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">--</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_low_mem_count</span><span class="p">;</span>
			<span class="n">erp_action</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ZFCP_STATUS_ERP_LOWMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">check_target:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_erp_strategy_check_target</span><span class="p">(</span><span class="n">erp_action</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="n">zfcp_erp_action_dequeue</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">zfcp_erp_strategy_statechange</span><span class="p">(</span><span class="n">erp_action</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">ZFCP_ERP_EXIT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">ZFCP_ERP_SUCCEEDED</span><span class="p">)</span>
		<span class="n">zfcp_erp_strategy_followup_success</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">ZFCP_ERP_FAILED</span><span class="p">)</span>
		<span class="n">zfcp_erp_strategy_followup_failed</span><span class="p">(</span><span class="n">erp_action</span><span class="p">);</span>

 <span class="nl">unlock:</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">ZFCP_ERP_CONTINUES</span><span class="p">)</span>
		<span class="n">zfcp_erp_action_cleanup</span><span class="p">(</span><span class="n">erp_action</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>

	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="n">zfcp_adapter_release</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zfcp_erp_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zfcp_erp_action</span> <span class="o">*</span><span class="n">act</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_wq</span><span class="p">,</span>
			   <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_head</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">kthread_should_stop</span><span class="p">());</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_head</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">act</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zfcp_erp_action</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

			<span class="cm">/* there is more to come after dismission, no notify */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">zfcp_erp_strategy</span><span class="p">(</span><span class="n">act</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ZFCP_ERP_DISMISSED</span><span class="p">)</span>
				<span class="n">zfcp_erp_wakeup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_thread_setup - Start ERP thread for adapter</span>
<span class="cm"> * @adapter: Adapter to start the ERP thread for</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or error code from kernel_thread()</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">zfcp_erp_thread_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>

	<span class="kr">thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">zfcp_erp_thread</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="s">&quot;zfcperp%s&quot;</span><span class="p">,</span>
			     <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="kr">thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ccw_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Creating an ERP thread for the FCP device failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_thread</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_thread_kill - Stop ERP thread.</span>
<span class="cm"> * @adapter: Adapter where the ERP thread should be stopped.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller of this routine ensures that the specified adapter has</span>
<span class="cm"> * been shut down and that this operation has been completed. Thus,</span>
<span class="cm"> * there are no pending erp_actions which would need to be handled</span>
<span class="cm"> * here.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_thread_kill</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_thread</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_ready_head</span><span class="p">));</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_running_head</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_wait - wait for completion of error recovery on an adapter</span>
<span class="cm"> * @adapter: adapter for which to wait for completion of its error recovery</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_done_wqh</span><span class="p">,</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">ZFCP_STATUS_ADAPTER_ERP_PENDING</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_set_adapter_status - set adapter status bits</span>
<span class="cm"> * @adapter: adapter to change the status</span>
<span class="cm"> * @mask: status bits to change</span>
<span class="cm"> *</span>
<span class="cm"> * Changes in common status bits are propagated to attached ports and LUNs.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_set_adapter_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">common_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">ZFCP_COMMON_FLAGS</span><span class="p">;</span>

	<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">read_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">common_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">)</span>
		<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">common_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_clear_adapter_status - clear adapter status bits</span>
<span class="cm"> * @adapter: adapter to change the status</span>
<span class="cm"> * @mask: status bits to change</span>
<span class="cm"> *</span>
<span class="cm"> * Changes in common status bits are propagated to attached ports and LUNs.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_clear_adapter_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">common_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">ZFCP_COMMON_FLAGS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clear_counter</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">;</span>

	<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear_counter</span><span class="p">)</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">read_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">common_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clear_counter</span><span class="p">)</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">common_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clear_counter</span><span class="p">)</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_set_port_status - set port status bits</span>
<span class="cm"> * @port: port to change the status</span>
<span class="cm"> * @mask: status bits to change</span>
<span class="cm"> *</span>
<span class="cm"> * Changes in common status bits are propagated to attached LUNs.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_set_port_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">common_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">ZFCP_COMMON_FLAGS</span><span class="p">;</span>

	<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span>
			<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">common_mask</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_clear_port_status - clear port status bits</span>
<span class="cm"> * @port: adapter to change the status</span>
<span class="cm"> * @mask: status bits to change</span>
<span class="cm"> *</span>
<span class="cm"> * Changes in common status bits are propagated to attached LUNs.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_clear_port_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">zfcp_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">common_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">ZFCP_COMMON_FLAGS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clear_counter</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">;</span>

	<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear_counter</span><span class="p">)</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">common_mask</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clear_counter</span><span class="p">)</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_set_lun_status - set lun status bits</span>
<span class="cm"> * @sdev: SCSI device / lun to set the status bits</span>
<span class="cm"> * @mask: status bits to change</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_set_lun_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="n">atomic_set_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zfcp_erp_clear_lun_status - clear lun status bits</span>
<span class="cm"> * @sdev: SCSi device / lun to clear the status bits</span>
<span class="cm"> * @mask: status bits to change</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zfcp_erp_clear_lun_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zfcp_scsi_dev</span> <span class="o">*</span><span class="n">zfcp_sdev</span> <span class="o">=</span> <span class="n">sdev_to_zfcp</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">ZFCP_STATUS_COMMON_ERP_FAILED</span><span class="p">)</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zfcp_sdev</span><span class="o">-&gt;</span><span class="n">erp_counter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
